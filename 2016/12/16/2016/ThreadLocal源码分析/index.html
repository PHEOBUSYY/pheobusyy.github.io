<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> ThreadLocal源码分析 · pheobusyy</title><meta name="description" content="ThreadLocal源码分析 - yanyi"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://pheobusyy.github.io/atom.xml" title="pheobusyy"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/sunchongsheng" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/pinggod" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">ThreadLocal源码分析</h1><div class="post-info">Dec 16, 2016</div><div class="post-content"><h2 id="ThreadLocal源码分析"><a href="#ThreadLocal源码分析" class="headerlink" title="ThreadLocal源码分析"></a>ThreadLocal源码分析</h2><p>  根据命名可以理解为”线程独有的”变量,也就是说这些变量是与所属线程相对应的,每个线程都有该变量独有的一份拷贝,相互之间是透明的.ThreadLocal实例的典型运用应该是private static的成员变量,比如去获取userId或者Transaction ID.</p>
<p>  ThreadLocal是一种线程安全的区别于锁机制的实现方式,通过线程隔离来完成线程数据之间不互相干扰.</p>
<p>  ThreadLocal使用非常简单,只有4个常用方法,分别是:</p>
<p>  <em>get()</em> :用来获取当前线程中的变量值<br>  <em>set(T value)</em> :用来给当前线程中的变量赋值<br>  <em>remove</em> :用来移除当前线程中的变量值<br>  <em>initialValue()</em> :用来在第一次get没有值得时候做初始化操作,一般是通过复写该方法来完成初始化的</p>
<p>  下面是一个demo代码,用来给每个调用它的线程产生一个唯一ID:<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadId</span> </span>&#123;</div><div class="line">    <span class="comment">// Atomic integer containing the next thread ID to be assigned</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicInteger nextId = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Thread local variable containing each thread's ID</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Integer&gt; threadId =</div><div class="line">        <span class="keyword">new</span> ThreadLocal&lt;Integer&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> Integer <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> nextId.getAndIncrement();</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="comment">// Returns the current thread's unique ID, assigning it if necessary</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> threadId.get();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><p>  既然不同的线程所包含的变量值不一样,那么内部肯定是有一种类似map的数据结构在做一一对应关系.<br>  构造函数就是一个普通构造函数,我们从 <em>set()</em> 方法开始:</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> T <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">      Thread t = Thread.currentThread();</div><div class="line">      ThreadLocalMap map = getMap(t);</div><div class="line">      <span class="keyword">if</span> (map != <span class="keyword">null</span>) &#123;</div><div class="line">          ThreadLocalMap.Entry e = map.getEntry(<span class="keyword">this</span>);</div><div class="line">          <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123;</div><div class="line">              <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">              T result = (T)e.value;</div><div class="line">              <span class="keyword">return</span> result;</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> setInitialValue();</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>  首先是获取当前的线程对象,然后调用 <em>getMap</em> 方法返回一个 <em>ThreadLocalMap</em> 对象,再看 <em>getMap</em> 方法:</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function">ThreadLocalMap <span class="title">getMap</span><span class="params">(Thread t)</span> </span>&#123;</div><div class="line">     <span class="keyword">return</span> t.threadLocals;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>  说明 <em>ThreadLocalMap</em> 来自于每个线程对象中.不过定义是在ThreadLocal中定义的,从明明商可以看到这个对象就是我们前面猜测的一种具有map性质的数据结构.<br>  其中key就是this也就是当前的ThreadLocal对象本身,value就是我们给ThreadLocal的赋值对象了.如果没有找到 <em>ThreadLocalMap</em> 对象,进入 <em>setInitialValue</em> 方法<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">  * Variant of set() to establish initialValue. Used instead</div><div class="line">  * of set() in case user has overridden the set() method.</div><div class="line">  *</div><div class="line">  * <span class="doctag">@return</span> the initial value</div><div class="line">  */</div><div class="line"> <span class="function"><span class="keyword">private</span> T <span class="title">setInitialValue</span><span class="params">()</span> </span>&#123;</div><div class="line">     T value = initialValue();</div><div class="line">     Thread t = Thread.currentThread();</div><div class="line">     ThreadLocalMap map = getMap(t);</div><div class="line">     <span class="keyword">if</span> (map != <span class="keyword">null</span>)</div><div class="line">         map.set(<span class="keyword">this</span>, value);</div><div class="line">     <span class="keyword">else</span></div><div class="line">         createMap(t, value);</div><div class="line">     <span class="keyword">return</span> value;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>  在这里就会调用前面说过的4个常用方法之一的 <em>initialValue</em> 方法,用来做初始化赋值.同样,如果map存在就直接赋值,否者进入 <em>createMap</em> 方法</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Create the map associated with a ThreadLocal. Overridden in</div><div class="line"> * InheritableThreadLocal.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> t the current thread</div><div class="line"> * <span class="doctag">@param</span> firstValue value for the initial entry of the map</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">createMap</span><span class="params">(Thread t, T firstValue)</span> </span>&#123;</div><div class="line">    t.threadLocals = <span class="keyword">new</span> ThreadLocalMap(<span class="keyword">this</span>, firstValue);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  非常简单,给Thread的对象的ThreadLocalMap对象赋值,同时把变量值也赋给ThreadLocalMap.<br>  再看 <em>set</em> 方法,也很简单清晰:<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">  * Sets the current thread's copy of this thread-local variable</div><div class="line">  * to the specified value.  Most subclasses will have no need to</div><div class="line">  * override this method, relying solely on the &#123;<span class="doctag">@link</span> #initialValue&#125;</div><div class="line">  * method to set the values of thread-locals.</div><div class="line">  *</div><div class="line">  * <span class="doctag">@param</span> value the value to be stored in the current thread's copy of</div><div class="line">  *        this thread-local.</div><div class="line">  */</div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(T value)</span> </span>&#123;</div><div class="line">     Thread t = Thread.currentThread();</div><div class="line">     ThreadLocalMap map = getMap(t);</div><div class="line">     <span class="keyword">if</span> (map != <span class="keyword">null</span>)</div><div class="line">         map.set(<span class="keyword">this</span>, value);</div><div class="line">     <span class="keyword">else</span></div><div class="line">         createMap(t, value);</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>  4个方法分分钟就讲完了,是不是非常简单,剩余核心其实就是 <em>ThreadLocalMap</em> 的实现方式了,在其内部实现了map类型的数据结构,先来看map中的Entry对象:</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">      * The entries in this hash map extend WeakReference, using</div><div class="line">      * its main ref field as the key (which is always a</div><div class="line">      * ThreadLocal object).  Note that null keys (i.e. entry.get()</div><div class="line">      * == null) mean that the key is no longer referenced, so the</div><div class="line">      * entry can be expunged from table.  Such entries are referred to</div><div class="line">      * as "stale entries" in the code that follows.</div><div class="line">      */</div><div class="line">     <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span> <span class="keyword">extends</span> <span class="title">WeakReference</span>&lt;<span class="title">ThreadLocal</span>&lt;?&gt;&gt; </span>&#123;</div><div class="line">         <span class="comment">/** The value associated with this ThreadLocal. */</span></div><div class="line">         Object value;</div><div class="line"></div><div class="line">         Entry(ThreadLocal&lt;?&gt; k, Object v) &#123;</div><div class="line">             <span class="keyword">super</span>(k);</div><div class="line">             value = v;</div><div class="line">         &#125;</div><div class="line">     &#125;</div></pre></td></tr></table></figure>
<p>  可以看到key是 通过弱引用包含的ThreadLocal对象,value就是我们给ThreadLocal的赋值.<br>  下面来看map中的set实现:<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">       * Set the value associated with key.</div><div class="line">       *</div><div class="line">       * <span class="doctag">@param</span> key the thread local object</div><div class="line">       * <span class="doctag">@param</span> value the value to be set</div><div class="line">       */</div><div class="line">      <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(ThreadLocal&lt;?&gt; key, Object value)</span> </span>&#123;</div><div class="line"></div><div class="line">          <span class="comment">// We don't use a fast path as with get() because it is at</span></div><div class="line">          <span class="comment">// least as common to use set() to create new entries as</span></div><div class="line">          <span class="comment">// it is to replace existing ones, in which case, a fast</span></div><div class="line">          <span class="comment">// path would fail more often than not.</span></div><div class="line"></div><div class="line">          Entry[] tab = table;</div><div class="line">          <span class="keyword">int</span> len = tab.length;</div><div class="line">          <span class="keyword">int</span> i = key.threadLocalHashCode &amp; (len-<span class="number">1</span>);</div><div class="line"></div><div class="line">          <span class="keyword">for</span> (Entry e = tab[i];</div><div class="line">               e != <span class="keyword">null</span>;</div><div class="line">               e = tab[i = nextIndex(i, len)]) &#123;</div><div class="line">              ThreadLocal&lt;?&gt; k = e.get();</div><div class="line"></div><div class="line">              <span class="keyword">if</span> (k == key) &#123;</div><div class="line">                  e.value = value;</div><div class="line">                  <span class="keyword">return</span>;</div><div class="line">              &#125;</div><div class="line"></div><div class="line">              <span class="keyword">if</span> (k == <span class="keyword">null</span>) &#123;</div><div class="line">                  replaceStaleEntry(key, value, i);</div><div class="line">                  <span class="keyword">return</span>;</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          tab[i] = <span class="keyword">new</span> Entry(key, value);</div><div class="line">          <span class="keyword">int</span> sz = ++size;</div><div class="line">          <span class="keyword">if</span> (!cleanSomeSlots(i, sz) &amp;&amp; sz &gt;= threshold)</div><div class="line">              rehash();</div><div class="line">      &#125;</div></pre></td></tr></table></figure></p>
<p>  遍历所有的Entry数组,如果找到key值一样的直接覆盖,如果发现一个key为空的情况,把那个位置的对象更新一下,否者如果刚开始Entry数组对象为空的时候,直接赋值数组的指定位置.这个位置是通过上面的对应hash算法生成的.<br>  map内部的清空无用的值的算法太复杂了,就不介绍了,重点是明白ThreadLocal的原理就可以了.</p>
</div></article></div></main><footer><div class="paginator"><a href="/2016/12/20/2016/Java多线程知识/" class="prev">PREV</a><a href="/2016/12/09/2016/java基础知识/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2017 <a href="http://pheobusyy.github.io">yanyi</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>