<!doctype html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="pheobusyy" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta property="og:type" content="website">
<meta property="og:title" content="pheobusyy">
<meta property="og:url" content="http://pheobusyy.github.io/index.html">
<meta property="og:site_name" content="pheobusyy">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="pheobusyy">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://pheobusyy.github.io/"/>





  <title> pheobusyy </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="">

  














  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">pheobusyy</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Startseite
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archiv
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://pheobusyy.github.io/2017/03/06/2017/读书笔记/如何高效学习-读书笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanyi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pheobusyy">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/06/2017/读书笔记/如何高效学习-读书笔记/" itemprop="url">
                  <如何高效学习>读书笔记
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-03-06T21:14:00+08:00">
                2017-03-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>  书中提出了整体性学习的概念,就是通过把信息分类然后运用类比,内在化,记忆技巧等方式来学习各种知识的方法.<br>  里面的最重要的三个概念,分别是 <em>结构</em> <em>模型</em> <em>高速公路</em> .</p>
<ul>
<li>结构 类比城市,是一类知识的总称,比如整个java或者整个编程体系知识都可以比作一个城市.</li>
<li>模型 类比城市快速索引,是一类概念的高端抽象统称</li>
<li><p>高速公路 类比知识之间的关联,通过不同领域的领域的知识互相关联来增加记忆和运用的效率</p>
<p>把信息又分为5类,分别对应 <em>随意信息</em>, <em>抽象信息</em> , <em>具体信息</em> ,<em>观点信息</em> , <em>过程信息</em> .</p>
<p>整体性学习的顺序,分别是 <em>获取阶段</em> <em>理解阶段</em> <em>拓展阶段</em> <em>纠错阶段</em> <em>应用阶段</em> <em>测试阶段</em> .</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/03/06/2017/读书笔记/如何高效学习-读书笔记/#more" rel="contents">
              Weiterlesen &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://pheobusyy.github.io/2017/03/02/2017/读书笔记/2017-03-02-如何阅读一本书/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanyi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pheobusyy">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/02/2017/读书笔记/2017-03-02-如何阅读一本书/" itemprop="url">
                  <如何阅读一本书>
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-03-02T15:18:00+08:00">
                2017-03-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>书中把阅读分为4个层次,基础阅读,检视阅读,分析阅读,主题阅读.不同书要根据不同的阅读层次来阅读.依次讲解了每个层次对应的阅读方式.</p>
<p>其中最重要的要点就是主动阅读也就是带着问题去阅读.基础阅读就是普通的阅读方式,只要认字就可以的阅读,适用于小学.检视阅读主要对应速度和略读,快速的读完一本书,并对书中要说的重点和基础框架有个整体的认知.分析阅读是从内到外的阅读.从词,句,段落中找出作者的主旨.最后是主题阅读通过对一些列书的阅读对某一个主题来形成整体认知.</p>
<p>下面是书中的一些摘要:</p>
<blockquote>
<p>阅读的目标:为获得咨询而读,以及为了求得理解而读.<br>阅读艺术定义:这是一个凭借头脑运作,除了玩味读物中的一些字句之外,不假任何外助,以一己之力提升自我的过程.<br>如果第一层次的阅读所问的问题是:”这个句子在说什么?”那么在这个层次要问的典型问题就是:”这本书在谈什么?”这是个表象的问题.还有些类似的问题是:”这本书的架构如何?”后是:”这本书包含哪些部分?”</p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://pheobusyy.github.io/2017/02/21/2017/android binder与aidl/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanyi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pheobusyy">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/21/2017/android binder与aidl/" itemprop="url">
                  android binder与AIDL
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-02-21T15:59:00+08:00">
                2017-02-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="android-binder与AIDL"><a href="#android-binder与AIDL" class="headerlink" title="android binder与AIDL"></a>android binder与AIDL</h2><p>  最近重新研究了一下Activity启动流程,里面主要提到了ActivityManagerService这个类来管理Activity的生命周期,而如何和这个类通讯成为了理解Activity启动流程的关键,而实现与ActivityManagerService通讯的基础就是今天要讲到的Binder知识.</p>
<p>  我们知道你通过Luncher点击app图标来启动响应的app的时候,实际上就是相当于在Luncher这个app中取启动另一个app,也就是两个app的通讯,并且这两个app分属于不同的 <em>线程</em> ,在android两个不同线程的通讯有个统一的说法叫做 <em>IPC(inter-process connection)</em> .我们可以想象一下如果你要让两个陌生人之间互相认识,是不是需要一个中间人,那么在这里的进程就好比两个陌生人,而中间人就是我们这里的IPC,binder机制是IPC的一种实现方式.</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/02/21/2017/android binder与aidl/#more" rel="contents">
              Weiterlesen &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://pheobusyy.github.io/2017/02/17/2017/Android LruMemoryCache源码分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanyi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pheobusyy">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/17/2017/Android LruMemoryCache源码分析/" itemprop="url">
                  Android LruMemoryCache源码分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-02-17T14:45:00+08:00">
                2017-02-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="Android-LruMemoryCache源码分析"><a href="#Android-LruMemoryCache源码分析" class="headerlink" title="Android LruMemoryCache源码分析"></a>Android LruMemoryCache源码分析</h2><p>  在分析Univeral Image Loader的时候看到里面的缓存实现很不错.其中的内存缓存使用的是它自己写的 <em>LruMemoryCache</em> ,文件缓存使用的是 <em>DiskLruCache</em> ,其中的 <em>DiskLruCache</em> 的源码已经分析完了,下面简单讲下 <em>LruMemoryCache</em> 的实现.<br>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/02/17/2017/Android LruMemoryCache源码分析/#more" rel="contents">
              Weiterlesen &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://pheobusyy.github.io/2017/02/17/2017/android DiskLruCache源码分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanyi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pheobusyy">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/17/2017/android DiskLruCache源码分析/" itemprop="url">
                  android DiskLruCache源码分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-02-17T10:02:00+08:00">
                2017-02-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="adroid-DiskLruCache源码分析"><a href="#adroid-DiskLruCache源码分析" class="headerlink" title="adroid DiskLruCache源码分析"></a>adroid DiskLruCache源码分析</h2><p>  在学习Universal image loader源码的时候,看到了它在用到本地文件缓存的时候使用的是 <em>DiskLruCache</em> ,所有抽时间来分析下 <em>DiskLruCache</em> 的源码,来看下为什么它支持类似于 <em>LruCache</em> 功能,内部是怎么实现的.顺便再查看源码过程中了解下它的大概用法.</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/02/17/2017/android DiskLruCache源码分析/#more" rel="contents">
              Weiterlesen &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://pheobusyy.github.io/2017/02/15/2017/读书笔记/读书笔记书写技巧/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanyi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pheobusyy">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/15/2017/读书笔记/读书笔记书写技巧/" itemprop="url">
                  读书笔记书写技巧
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-02-15T21:07:00+08:00">
                2017-02-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="读书笔记书写技巧"><a href="#读书笔记书写技巧" class="headerlink" title="读书笔记书写技巧"></a>读书笔记书写技巧</h2><p>这里记录一下在书写读书笔记的时候一些技巧,不一定对,不过可以尝试一下效果.</p>
<ol>
<li>不要直接照搬书上的原文,除非是特别棒的名言金句,而是要自己通过记忆回想复述内容,这样才能可以加深记忆,避免记占有错觉.</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://pheobusyy.github.io/2017/02/15/2017/android loader相关/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanyi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pheobusyy">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/15/2017/android loader相关/" itemprop="url">
                  android loader相关
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-02-15T14:16:00+08:00">
                2017-02-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="android-loader相关"><a href="#android-loader相关" class="headerlink" title="android loader相关"></a>android loader相关</h3><p>今天第一次学习使用loader,由于不想要使用CursorLoader,所以自己实现了一个asyncTaskLoader,结果发现不起作用,根本没有调用callBack的 <em>onLoadFinished</em> 方法.这不科学啊,看这官方示例写的呀.</p>
<p>后来发现忽略了一个关键点,就是在自定义loader的 <em>onStartLoading</em> 方法中,有下面几句话:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStartLoading</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mApps != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// If we currently have a result available, deliver it</span></div><div class="line">            <span class="comment">// immediately.</span></div><div class="line">            deliverResult(mApps);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Start watching for changes in the app data.</span></div><div class="line">        <span class="keyword">if</span> (mPackageObserver == <span class="keyword">null</span>) &#123;</div><div class="line">            mPackageObserver = <span class="keyword">new</span> PackageIntentReceiver(<span class="keyword">this</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Has something interesting in the configuration changed since we</span></div><div class="line">        <span class="comment">// last built the app list?</span></div><div class="line">        <span class="keyword">boolean</span> configChange = mLastConfig.applyNewConfig(getContext().getResources());</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (takeContentChanged() || mApps == <span class="keyword">null</span> || configChange) &#123;</div><div class="line">            <span class="comment">// If the data has changed since the last time it was loaded</span></div><div class="line">            <span class="comment">// or is not currently available, start a load.</span></div><div class="line">            forceLoad();</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>逻辑也很简单,就是说如果有数据了,直接通过 <em>deliverResult</em> 返回数据,如果没有,强制调用 <em>forceLoad</em> .<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deliverResult</span><span class="params">(D data)</span> </span>&#123;</div><div class="line">      <span class="keyword">if</span> (mListener != <span class="keyword">null</span>) &#123;</div><div class="line">          mListener.onLoadComplete(<span class="keyword">this</span>, data);</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>在 <em>deliverResult</em> 中调用了callback的 <em>onLoadFinished</em> 方法.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forceLoad</span><span class="params">()</span> </span>&#123;</div><div class="line">      onForceLoad();</div><div class="line">  &#125;</div><div class="line">  <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onForceLoad</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onForceLoad();</div><div class="line">        cancelLoad();</div><div class="line">        mTask = <span class="keyword">new</span> LoadTask();</div><div class="line">        <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">"Preparing load: mTask="</span> + mTask);</div><div class="line">        executePendingTask();</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>forceLoad方法会调用内部AsyncTask发起请求,内部调用 <em>loadInBackground</em> 完成耗时任务.</p>
<p>那为什么 <em>CursorLoader</em> 不需要复写这一堆东西了,是因为在其内部已经帮我们写好了.<br>下面是 <em>CursorLoader</em> 的 <em>onStartLoading</em> 方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStartLoading</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (mCursor != <span class="keyword">null</span>) &#123;</div><div class="line">           deliverResult(mCursor);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (takeContentChanged() || mCursor == <span class="keyword">null</span>) &#123;</div><div class="line">           forceLoad();</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>对这个方法的处理使我们在第一次使用loader的时候要注意的哦,否者你会发现调用了initloader之后没有反应.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://pheobusyy.github.io/2017/02/15/2017/android view滑动相关/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanyi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pheobusyy">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/15/2017/android view滑动相关/" itemprop="url">
                  android view滑动相关
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-02-15T13:50:00+08:00">
                2017-02-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="android-view滑动相关"><a href="#android-view滑动相关" class="headerlink" title="android view滑动相关"></a>android view滑动相关</h2><p>  在学习ViewDragHelper的过程中,用到了scroller来回弹到制定的位置,同时也很好奇scroller和computeScroll方法的关联,还有就是关于view坐标系一些api的学习等等,这些概念在这里说明一下.<br>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/02/15/2017/android view滑动相关/#more" rel="contents">
              Weiterlesen &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://pheobusyy.github.io/2017/02/09/2017/ViewDragHelper源码分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanyi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pheobusyy">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/09/2017/ViewDragHelper源码分析/" itemprop="url">
                  ViewDragHelper源码分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-02-09T16:25:00+08:00">
                2017-02-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="ViewDragHelper源码分析"><a href="#ViewDragHelper源码分析" class="headerlink" title="ViewDragHelper源码分析"></a>ViewDragHelper源码分析</h2><p>在学习第三方的一个开源库的时候,发现了系统居然已为viewGroup控制的子view的手势移动提供了相关的组件,就是今天要介绍的 <em>ViewDragHelper</em> ,看了一下发现功能非常的强大,基本满足了我们平时的使用要求,首先我们先讲解一下它的用法,然后再从源码层面来分析一下它的实现思路.</p>
<h3 id="ViewDragHelper的用法"><a href="#ViewDragHelper的用法" class="headerlink" title="ViewDragHelper的用法"></a>ViewDragHelper的用法</h3><p>先通过一个简单的demo来看一下ViewDragHelper的用法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestDragLayout</span> <span class="keyword">extends</span> <span class="title">LinearLayout</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> ViewDragHelper mViewDragHelper;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> View mDragView;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TestDragLayout</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(context, <span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TestDragLayout</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(context, attrs, <span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TestDragLayout</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr);</div><div class="line">        init();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        mViewDragHelper = ViewDragHelper.create(<span class="keyword">this</span>, <span class="number">1f</span>, <span class="keyword">new</span> ViewDragCallBack());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewDragCallBack</span> <span class="keyword">extends</span> <span class="title">ViewDragHelper</span>.<span class="title">Callback</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryCaptureView</span><span class="params">(View child, <span class="keyword">int</span> pointerId)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> mDragView.getId() == child.getId();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * 处理水平方向上的拖动</div><div class="line">         *</div><div class="line">         * <span class="doctag">@param</span> child 拖动的View</div><div class="line">         * <span class="doctag">@param</span> left  移动到x轴的距离</div><div class="line">         * <span class="doctag">@param</span> dx    建议的移动的x距离</div><div class="line">         */</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">clampViewPositionHorizontal</span><span class="params">(View child, <span class="keyword">int</span> left, <span class="keyword">int</span> dx)</span> </span>&#123;</div><div class="line">            <span class="comment">//两个if主要是让view在ViewGroup中</span></div><div class="line">            <span class="keyword">if</span> (left &lt; getPaddingLeft()) &#123;</div><div class="line">                <span class="keyword">return</span> getPaddingLeft();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (left &gt; getWidth() - child.getMeasuredWidth()) &#123;</div><div class="line">                <span class="keyword">return</span> getWidth() - child.getMeasuredWidth();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> left;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">clampViewPositionVertical</span><span class="params">(View child, <span class="keyword">int</span> top, <span class="keyword">int</span> dy)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (top &lt; getPaddingTop()) &#123;</div><div class="line">                <span class="keyword">return</span> getPaddingTop();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (top &gt; getHeight() - child.getMeasuredHeight()) &#123;</div><div class="line">                <span class="keyword">return</span> getHeight() - child.getMeasuredHeight();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> top;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onInterceptTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mViewDragHelper.shouldInterceptTouchEvent(ev);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</div><div class="line">        mViewDragHelper.processTouchEvent(event);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onFinishInflate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onFinishInflate();</div><div class="line">        mDragView = findViewById(R.id.dragview);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们先继承一个LinearLayout,然后在构造函数中调用 <em>init</em> 方法,在里面创建 <em>ViewDragHelper</em> 实例.然后在LinearLayout里面放入一个view,这个view就是我们要拖动的mDragView.运行程序,可以看到在布局中的view是可以在里面随便拖动的,同时也不会被拖出边界外面.是不是很简单呢?下面来分析一下使用方法:</p>
<p>使用ViewDragHelper需要三个步骤:</p>
<ol>
<li>创建ViewDragHelper实例</li>
<li>触摸相关的方法调用,主要包括 <em>shouldInterceptTouchEvent(MotionEvent ev)</em> <em>processTouchEvent(MotionEvent ev)</em> 这两个方法</li>
<li>ViewDragHelper.Callback实例的编写,用来完成各种事件的回调</li>
</ol>
<p>(一) 创建ViewDragHelper实例<br>  ViewDragHelper提供了两个创建方法,分别对应:<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ViewDragHelper <span class="title">create</span><span class="params">(ViewGroup forParent, Callback cb)</span> </span>&#123;</div><div class="line">     <span class="keyword">return</span> <span class="keyword">new</span> ViewDragHelper(forParent.getContext(), forParent, cb);</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ViewDragHelper <span class="title">create</span><span class="params">(ViewGroup forParent, <span class="keyword">float</span> sensitivity, Callback cb)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> ViewDragHelper helper = create(forParent, cb);</div><div class="line">    helper.mTouchSlop = (<span class="keyword">int</span>) (helper.mTouchSlop * (<span class="number">1</span> / sensitivity));</div><div class="line">    <span class="keyword">return</span> helper;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  两个方法的区别在于第二个方法提供了一个 <em>sensitivity</em> 参数,这个参数用来表示拖动触发的灵敏度,越大便是越灵敏.因为这里 <em>helper.mTouchSlop</em> 是通过 <em>ViewConfiguration</em> 来获得当前设备的最小的触发距离的,距离越小表示越灵敏.<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="title">ViewDragHelper</span><span class="params">(Context context, ViewGroup forParent, Callback cb)</span> </span>&#123;</div><div class="line">     <span class="keyword">if</span> (forParent == <span class="keyword">null</span>) &#123;</div><div class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Parent view may not be null"</span>);</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">if</span> (cb == <span class="keyword">null</span>) &#123;</div><div class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Callback may not be null"</span>);</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     mParentView = forParent;</div><div class="line">     mCallback = cb;</div><div class="line"></div><div class="line">     <span class="keyword">final</span> ViewConfiguration vc = ViewConfiguration.get(context);</div><div class="line">     <span class="keyword">final</span> <span class="keyword">float</span> density = context.getResources().getDisplayMetrics().density;</div><div class="line">     mEdgeSize = (<span class="keyword">int</span>) (EDGE_SIZE * density + <span class="number">0.5f</span>);</div><div class="line"></div><div class="line">     mTouchSlop = vc.getScaledTouchSlop();</div><div class="line">     mMaxVelocity = vc.getScaledMaximumFlingVelocity();</div><div class="line">     mMinVelocity = vc.getScaledMinimumFlingVelocity();</div><div class="line">     mScroller = ScrollerCompat.create(context, sInterpolator);</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>(二) 触摸相关方法调用<br>  可以看到在继承的LinearLayout中,我们复写了两个触摸事件相关的方法:<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onInterceptTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</div><div class="line">     <span class="keyword">return</span> mViewDragHelper.shouldInterceptTouchEvent(ev);</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</div><div class="line">    mViewDragHelper.processTouchEvent(event);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  首先触摸事件会触发 <em>onInterceptTouchEvent</em> 如果该方法返回true,则表明当前的viewGroup要拦截该触摸事件,那么触摸事件就不会传递给下层的子类view.而是交由自己的 <em>onTouchEvent</em> 方法来处理. 而如果 <em>onInterceptTouchEvent</em> 方法返回false,则事件会传递给子类的 <em>onTouchEvent</em> 方法,如果子类view的 <em>onTouchEvent</em> 什么都没做返回false的话,事件会再次回到viewGroup的 <em>onTouchEvent</em> 方法来处理,反之事件被成功消化,不会回到上层的viewGroup了.这是android触摸事件的传递流程.还有一个 <em>dispatchTouchEvent</em> 方法来决定是否要分发触摸事件,事件的传递会先进入这个方法,然后在这个方法中通过判断 <em>onInterceptTouchEvent</em> 来决定是否要分发事件.</p>
<p>  回头来看这里的用到的触摸回调方法,先是在 <em>onInterceptTouchEvent</em> 方法,通过 <em>mViewDragHelper.shouldInterceptTouchEvent(ev)</em> 来决定是否分发事件给子view,如果这里返回true,就会进入 <em>onTouchEvent</em> 在里面调用 <em>mViewDragHelper.processTouchEvent(event)</em> 这个方法就是用来移动view的核心方法了.</p>
<p>  我们先来看 <em>shouldInterceptTouchEvent</em> 方法:<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldInterceptTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</div><div class="line">      <span class="keyword">final</span> <span class="keyword">int</span> action = MotionEventCompat.getActionMasked(ev);</div><div class="line">      <span class="keyword">final</span> <span class="keyword">int</span> actionIndex = MotionEventCompat.getActionIndex(ev);</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (action == MotionEvent.ACTION_DOWN) &#123;</div><div class="line">          <span class="comment">// Reset things for a new event stream, just in case we didn't get</span></div><div class="line">          <span class="comment">// the whole previous stream.</span></div><div class="line">          cancel();</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (mVelocityTracker == <span class="keyword">null</span>) &#123;</div><div class="line">          mVelocityTracker = VelocityTracker.obtain();</div><div class="line">      &#125;</div><div class="line">      mVelocityTracker.addMovement(ev);</div><div class="line"></div><div class="line">      <span class="keyword">switch</span> (action) &#123;</div><div class="line">          <span class="keyword">case</span> MotionEvent.ACTION_DOWN: &#123;</div><div class="line">              <span class="keyword">final</span> <span class="keyword">float</span> x = ev.getX();</div><div class="line">              <span class="keyword">final</span> <span class="keyword">float</span> y = ev.getY();</div><div class="line">              <span class="keyword">final</span> <span class="keyword">int</span> pointerId = ev.getPointerId(<span class="number">0</span>);</div><div class="line">              saveInitialMotion(x, y, pointerId);</div><div class="line"></div><div class="line">              <span class="keyword">final</span> View toCapture = findTopChildUnder((<span class="keyword">int</span>) x, (<span class="keyword">int</span>) y);</div><div class="line"></div><div class="line">              <span class="comment">// Catch a settling view if possible.</span></div><div class="line">              <span class="keyword">if</span> (toCapture == mCapturedView &amp;&amp; mDragState == STATE_SETTLING) &#123;</div><div class="line">                  tryCaptureViewForDrag(toCapture, pointerId);</div><div class="line">              &#125;</div><div class="line"></div><div class="line">              <span class="keyword">final</span> <span class="keyword">int</span> edgesTouched = mInitialEdgesTouched[pointerId];</div><div class="line">              <span class="keyword">if</span> ((edgesTouched &amp; mTrackingEdges) != <span class="number">0</span>) &#123;</div><div class="line">                  mCallback.onEdgeTouched(edgesTouched &amp; mTrackingEdges, pointerId);</div><div class="line">              &#125;</div><div class="line">              <span class="keyword">break</span>;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="keyword">case</span> MotionEventCompat.ACTION_POINTER_DOWN: &#123;</div><div class="line">              <span class="keyword">final</span> <span class="keyword">int</span> pointerId = ev.getPointerId(actionIndex);</div><div class="line">              <span class="keyword">final</span> <span class="keyword">float</span> x = ev.getX(actionIndex);</div><div class="line">              <span class="keyword">final</span> <span class="keyword">float</span> y = ev.getY(actionIndex);</div><div class="line"></div><div class="line">              saveInitialMotion(x, y, pointerId);</div><div class="line"></div><div class="line">              <span class="comment">// A ViewDragHelper can only manipulate one view at a time.</span></div><div class="line">              <span class="keyword">if</span> (mDragState == STATE_IDLE) &#123;</div><div class="line">                  <span class="keyword">final</span> <span class="keyword">int</span> edgesTouched = mInitialEdgesTouched[pointerId];</div><div class="line">                  <span class="keyword">if</span> ((edgesTouched &amp; mTrackingEdges) != <span class="number">0</span>) &#123;</div><div class="line">                      mCallback.onEdgeTouched(edgesTouched &amp; mTrackingEdges, pointerId);</div><div class="line">                  &#125;</div><div class="line">              &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mDragState == STATE_SETTLING) &#123;</div><div class="line">                  <span class="comment">// Catch a settling view if possible.</span></div><div class="line">                  <span class="keyword">final</span> View toCapture = findTopChildUnder((<span class="keyword">int</span>) x, (<span class="keyword">int</span>) y);</div><div class="line">                  <span class="keyword">if</span> (toCapture == mCapturedView) &#123;</div><div class="line">                      tryCaptureViewForDrag(toCapture, pointerId);</div><div class="line">                  &#125;</div><div class="line">              &#125;</div><div class="line">              <span class="keyword">break</span>;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="keyword">case</span> MotionEvent.ACTION_MOVE: &#123;</div><div class="line">              <span class="keyword">if</span> (mInitialMotionX == <span class="keyword">null</span> || mInitialMotionY == <span class="keyword">null</span>) <span class="keyword">break</span>;</div><div class="line"></div><div class="line">              <span class="comment">// First to cross a touch slop over a draggable view wins. Also report edge drags.</span></div><div class="line">              <span class="keyword">final</span> <span class="keyword">int</span> pointerCount = ev.getPointerCount();</div><div class="line">              <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pointerCount; i++) &#123;</div><div class="line">                  <span class="keyword">final</span> <span class="keyword">int</span> pointerId = ev.getPointerId(i);</div><div class="line"></div><div class="line">                  <span class="comment">// If pointer is invalid then skip the ACTION_MOVE.</span></div><div class="line">                  <span class="keyword">if</span> (!isValidPointerForActionMove(pointerId)) <span class="keyword">continue</span>;</div><div class="line"></div><div class="line">                  <span class="keyword">final</span> <span class="keyword">float</span> x = ev.getX(i);</div><div class="line">                  <span class="keyword">final</span> <span class="keyword">float</span> y = ev.getY(i);</div><div class="line">                  <span class="keyword">final</span> <span class="keyword">float</span> dx = x - mInitialMotionX[pointerId];</div><div class="line">                  <span class="keyword">final</span> <span class="keyword">float</span> dy = y - mInitialMotionY[pointerId];</div><div class="line"></div><div class="line">                  <span class="keyword">final</span> View toCapture = findTopChildUnder((<span class="keyword">int</span>) x, (<span class="keyword">int</span>) y);</div><div class="line">                  <span class="keyword">final</span> <span class="keyword">boolean</span> pastSlop = toCapture != <span class="keyword">null</span> &amp;&amp; checkTouchSlop(toCapture, dx, dy);</div><div class="line">                  <span class="keyword">if</span> (pastSlop) &#123;</div><div class="line">                      <span class="comment">// check the callback's</span></div><div class="line">                      <span class="comment">// getView[Horizontal|Vertical]DragRange methods to know</span></div><div class="line">                      <span class="comment">// if you can move at all along an axis, then see if it</span></div><div class="line">                      <span class="comment">// would clamp to the same value. If you can't move at</span></div><div class="line">                      <span class="comment">// all in every dimension with a nonzero range, bail.</span></div><div class="line">                      <span class="keyword">final</span> <span class="keyword">int</span> oldLeft = toCapture.getLeft();</div><div class="line">                      <span class="keyword">final</span> <span class="keyword">int</span> targetLeft = oldLeft + (<span class="keyword">int</span>) dx;</div><div class="line">                      <span class="keyword">final</span> <span class="keyword">int</span> newLeft = mCallback.clampViewPositionHorizontal(toCapture,</div><div class="line">                              targetLeft, (<span class="keyword">int</span>) dx);</div><div class="line">                      <span class="keyword">final</span> <span class="keyword">int</span> oldTop = toCapture.getTop();</div><div class="line">                      <span class="keyword">final</span> <span class="keyword">int</span> targetTop = oldTop + (<span class="keyword">int</span>) dy;</div><div class="line">                      <span class="keyword">final</span> <span class="keyword">int</span> newTop = mCallback.clampViewPositionVertical(toCapture, targetTop,</div><div class="line">                              (<span class="keyword">int</span>) dy);</div><div class="line">                      <span class="keyword">final</span> <span class="keyword">int</span> horizontalDragRange = mCallback.getViewHorizontalDragRange(</div><div class="line">                              toCapture);</div><div class="line">                      <span class="keyword">final</span> <span class="keyword">int</span> verticalDragRange = mCallback.getViewVerticalDragRange(toCapture);</div><div class="line">                      <span class="keyword">if</span> ((horizontalDragRange == <span class="number">0</span> || horizontalDragRange &gt; <span class="number">0</span></div><div class="line">                              &amp;&amp; newLeft == oldLeft) &amp;&amp; (verticalDragRange == <span class="number">0</span></div><div class="line">                              || verticalDragRange &gt; <span class="number">0</span> &amp;&amp; newTop == oldTop)) &#123;</div><div class="line">                          <span class="keyword">break</span>;</div><div class="line">                      &#125;</div><div class="line">                  &#125;</div><div class="line">                  reportNewEdgeDrags(dx, dy, pointerId);</div><div class="line">                  <span class="keyword">if</span> (mDragState == STATE_DRAGGING) &#123;</div><div class="line">                      <span class="comment">// Callback might have started an edge drag</span></div><div class="line">                      <span class="keyword">break</span>;</div><div class="line">                  &#125;</div><div class="line"></div><div class="line">                  <span class="keyword">if</span> (pastSlop &amp;&amp; tryCaptureViewForDrag(toCapture, pointerId)) &#123;</div><div class="line">                      <span class="keyword">break</span>;</div><div class="line">                  &#125;</div><div class="line">              &#125;</div><div class="line">              saveLastMotion(ev);</div><div class="line">              <span class="keyword">break</span>;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="keyword">case</span> MotionEventCompat.ACTION_POINTER_UP: &#123;</div><div class="line">              <span class="keyword">final</span> <span class="keyword">int</span> pointerId = ev.getPointerId(actionIndex);</div><div class="line">              clearMotionHistory(pointerId);</div><div class="line">              <span class="keyword">break</span>;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="keyword">case</span> MotionEvent.ACTION_UP:</div><div class="line">          <span class="keyword">case</span> MotionEvent.ACTION_CANCEL: &#123;</div><div class="line">              cancel();</div><div class="line">              <span class="keyword">break</span>;</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">return</span> mDragState == STATE_DRAGGING;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>  可以看到里面还是对触摸事件的那几种基本的类型分别做处理,我们知道事件的触发类型对应: ACTION_DOWN –&gt; ACTION_MOVE –&gt; ACTION_MOVE –&gt; ACTION_UP .同时这里加入了对多点触摸的处理.在上面的 ACTION_DOWN 的判断中,如果当前通过 <em>findTopChildUnder</em> 捕获的view就是之前的移动的view,并且处于释放状态,就重新捕获该view并调整状态.这种情况对应快速拖动之后松开后view会自己滑动一些距离的情况.第一次拖动的时候不会触发.</p>
<p>  下面进入 ACTION_MOVE ,在这里看到顺序获取多个触摸点,如果有没有越界,如果没有问题的话就会 调用 <em>tryCaptureViewForDrag</em> 来捕获要滑动的view,并求改其状态.<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">tryCaptureViewForDrag</span><span class="params">(View toCapture, <span class="keyword">int</span> pointerId)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (toCapture == mCapturedView &amp;&amp; mActivePointerId == pointerId) &#123;</div><div class="line">           <span class="comment">// Already done!</span></div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (toCapture != <span class="keyword">null</span> &amp;&amp; mCallback.tryCaptureView(toCapture, pointerId)) &#123;</div><div class="line">           mActivePointerId = pointerId;</div><div class="line">           captureChildView(toCapture, pointerId);</div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>  该方法又会调用 <em>captureChildView</em> 方法:<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">captureChildView</span><span class="params">(View childView, <span class="keyword">int</span> activePointerId)</span> </span>&#123;</div><div class="line">     <span class="keyword">if</span> (childView.getParent() != mParentView) &#123;</div><div class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"captureChildView: parameter must be a descendant "</span></div><div class="line">                 + <span class="string">"of the ViewDragHelper's tracked parent view ("</span> + mParentView + <span class="string">")"</span>);</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     mCapturedView = childView;</div><div class="line">     mActivePointerId = activePointerId;</div><div class="line">     mCallback.onViewCaptured(childView, activePointerId);</div><div class="line">     setDragState(STATE_DRAGGING);</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>  在这个方法中最后修改view的状态为 <em>STATE_DRAGGING</em> .回到上面的 <em>shouldInterceptTouchEvent</em> 看最后一行的返回条件判断 <em>return mDragState == STATE_DRAGGING;</em> 正好对应这里的修改状态.也就是说当我们手势移动的时候,这里就会认为我们在移动触摸点下面的view,并返回true,方法调用就会进入下面要将的 <em>processTouchEvent</em> 方法了.</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</div><div class="line">      <span class="keyword">final</span> <span class="keyword">int</span> action = MotionEventCompat.getActionMasked(ev);</div><div class="line">      <span class="keyword">final</span> <span class="keyword">int</span> actionIndex = MotionEventCompat.getActionIndex(ev);</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (action == MotionEvent.ACTION_DOWN) &#123;</div><div class="line">          <span class="comment">// Reset things for a new event stream, just in case we didn't get</span></div><div class="line">          <span class="comment">// the whole previous stream.</span></div><div class="line">          cancel();</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (mVelocityTracker == <span class="keyword">null</span>) &#123;</div><div class="line">          mVelocityTracker = VelocityTracker.obtain();</div><div class="line">      &#125;</div><div class="line">      mVelocityTracker.addMovement(ev);</div><div class="line"></div><div class="line">      <span class="keyword">switch</span> (action) &#123;</div><div class="line">          <span class="keyword">case</span> MotionEvent.ACTION_DOWN: &#123;</div><div class="line">              <span class="keyword">final</span> <span class="keyword">float</span> x = ev.getX();</div><div class="line">              <span class="keyword">final</span> <span class="keyword">float</span> y = ev.getY();</div><div class="line">              <span class="keyword">final</span> <span class="keyword">int</span> pointerId = ev.getPointerId(<span class="number">0</span>);</div><div class="line">              <span class="keyword">final</span> View toCapture = findTopChildUnder((<span class="keyword">int</span>) x, (<span class="keyword">int</span>) y);</div><div class="line"></div><div class="line">              saveInitialMotion(x, y, pointerId);</div><div class="line"></div><div class="line">              <span class="comment">// Since the parent is already directly processing this touch event,</span></div><div class="line">              <span class="comment">// there is no reason to delay for a slop before dragging.</span></div><div class="line">              <span class="comment">// Start immediately if possible.</span></div><div class="line">              tryCaptureViewForDrag(toCapture, pointerId);</div><div class="line"></div><div class="line">              <span class="keyword">final</span> <span class="keyword">int</span> edgesTouched = mInitialEdgesTouched[pointerId];</div><div class="line">              <span class="keyword">if</span> ((edgesTouched &amp; mTrackingEdges) != <span class="number">0</span>) &#123;</div><div class="line">                  mCallback.onEdgeTouched(edgesTouched &amp; mTrackingEdges, pointerId);</div><div class="line">              &#125;</div><div class="line">              <span class="keyword">break</span>;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="keyword">case</span> MotionEventCompat.ACTION_POINTER_DOWN: &#123;</div><div class="line">              <span class="keyword">final</span> <span class="keyword">int</span> pointerId = ev.getPointerId(actionIndex);</div><div class="line">              <span class="keyword">final</span> <span class="keyword">float</span> x = ev.getX(actionIndex);</div><div class="line">              <span class="keyword">final</span> <span class="keyword">float</span> y = ev.getY(actionIndex);</div><div class="line"></div><div class="line">              saveInitialMotion(x, y, pointerId);</div><div class="line"></div><div class="line">              <span class="comment">// A ViewDragHelper can only manipulate one view at a time.</span></div><div class="line">              <span class="keyword">if</span> (mDragState == STATE_IDLE) &#123;</div><div class="line">                  <span class="comment">// If we're idle we can do anything! Treat it like a normal down event.</span></div><div class="line"></div><div class="line">                  <span class="keyword">final</span> View toCapture = findTopChildUnder((<span class="keyword">int</span>) x, (<span class="keyword">int</span>) y);</div><div class="line">                  tryCaptureViewForDrag(toCapture, pointerId);</div><div class="line"></div><div class="line">                  <span class="keyword">final</span> <span class="keyword">int</span> edgesTouched = mInitialEdgesTouched[pointerId];</div><div class="line">                  <span class="keyword">if</span> ((edgesTouched &amp; mTrackingEdges) != <span class="number">0</span>) &#123;</div><div class="line">                      mCallback.onEdgeTouched(edgesTouched &amp; mTrackingEdges, pointerId);</div><div class="line">                  &#125;</div><div class="line">              &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isCapturedViewUnder((<span class="keyword">int</span>) x, (<span class="keyword">int</span>) y)) &#123;</div><div class="line">                  <span class="comment">// We're still tracking a captured view. If the same view is under this</span></div><div class="line">                  <span class="comment">// point, we'll swap to controlling it with this pointer instead.</span></div><div class="line">                  <span class="comment">// (This will still work if we're "catching" a settling view.)</span></div><div class="line"></div><div class="line">                  tryCaptureViewForDrag(mCapturedView, pointerId);</div><div class="line">              &#125;</div><div class="line">              <span class="keyword">break</span>;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="keyword">case</span> MotionEvent.ACTION_MOVE: &#123;</div><div class="line">              <span class="keyword">if</span> (mDragState == STATE_DRAGGING) &#123;</div><div class="line">                  <span class="comment">// If pointer is invalid then skip the ACTION_MOVE.</span></div><div class="line">                  <span class="keyword">if</span> (!isValidPointerForActionMove(mActivePointerId)) <span class="keyword">break</span>;</div><div class="line"></div><div class="line">                  <span class="keyword">final</span> <span class="keyword">int</span> index = ev.findPointerIndex(mActivePointerId);</div><div class="line">                  <span class="keyword">final</span> <span class="keyword">float</span> x = ev.getX(index);</div><div class="line">                  <span class="keyword">final</span> <span class="keyword">float</span> y = ev.getY(index);</div><div class="line">                  <span class="keyword">final</span> <span class="keyword">int</span> idx = (<span class="keyword">int</span>) (x - mLastMotionX[mActivePointerId]);</div><div class="line">                  <span class="keyword">final</span> <span class="keyword">int</span> idy = (<span class="keyword">int</span>) (y - mLastMotionY[mActivePointerId]);</div><div class="line"></div><div class="line">                  dragTo(mCapturedView.getLeft() + idx, mCapturedView.getTop() + idy, idx, idy);</div><div class="line"></div><div class="line">                  saveLastMotion(ev);</div><div class="line">              &#125; <span class="keyword">else</span> &#123;</div><div class="line">                  <span class="comment">// Check to see if any pointer is now over a draggable view.</span></div><div class="line">                  <span class="keyword">final</span> <span class="keyword">int</span> pointerCount = ev.getPointerCount();</div><div class="line">                  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pointerCount; i++) &#123;</div><div class="line">                      <span class="keyword">final</span> <span class="keyword">int</span> pointerId = ev.getPointerId(i);</div><div class="line"></div><div class="line">                      <span class="comment">// If pointer is invalid then skip the ACTION_MOVE.</span></div><div class="line">                      <span class="keyword">if</span> (!isValidPointerForActionMove(pointerId)) <span class="keyword">continue</span>;</div><div class="line"></div><div class="line">                      <span class="keyword">final</span> <span class="keyword">float</span> x = ev.getX(i);</div><div class="line">                      <span class="keyword">final</span> <span class="keyword">float</span> y = ev.getY(i);</div><div class="line">                      <span class="keyword">final</span> <span class="keyword">float</span> dx = x - mInitialMotionX[pointerId];</div><div class="line">                      <span class="keyword">final</span> <span class="keyword">float</span> dy = y - mInitialMotionY[pointerId];</div><div class="line"></div><div class="line">                      reportNewEdgeDrags(dx, dy, pointerId);</div><div class="line">                      <span class="keyword">if</span> (mDragState == STATE_DRAGGING) &#123;</div><div class="line">                          <span class="comment">// Callback might have started an edge drag.</span></div><div class="line">                          <span class="keyword">break</span>;</div><div class="line">                      &#125;</div><div class="line"></div><div class="line">                      <span class="keyword">final</span> View toCapture = findTopChildUnder((<span class="keyword">int</span>) x, (<span class="keyword">int</span>) y);</div><div class="line">                      <span class="keyword">if</span> (checkTouchSlop(toCapture, dx, dy)</div><div class="line">                              &amp;&amp; tryCaptureViewForDrag(toCapture, pointerId)) &#123;</div><div class="line">                          <span class="keyword">break</span>;</div><div class="line">                      &#125;</div><div class="line">                  &#125;</div><div class="line">                  saveLastMotion(ev);</div><div class="line">              &#125;</div><div class="line">              <span class="keyword">break</span>;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="keyword">case</span> MotionEventCompat.ACTION_POINTER_UP: &#123;</div><div class="line">              <span class="keyword">final</span> <span class="keyword">int</span> pointerId = ev.getPointerId(actionIndex);</div><div class="line">              <span class="keyword">if</span> (mDragState == STATE_DRAGGING &amp;&amp; pointerId == mActivePointerId) &#123;</div><div class="line">                  <span class="comment">// Try to find another pointer that's still holding on to the captured view.</span></div><div class="line">                  <span class="keyword">int</span> newActivePointer = INVALID_POINTER;</div><div class="line">                  <span class="keyword">final</span> <span class="keyword">int</span> pointerCount = ev.getPointerCount();</div><div class="line">                  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pointerCount; i++) &#123;</div><div class="line">                      <span class="keyword">final</span> <span class="keyword">int</span> id = ev.getPointerId(i);</div><div class="line">                      <span class="keyword">if</span> (id == mActivePointerId) &#123;</div><div class="line">                          <span class="comment">// This one's going away, skip.</span></div><div class="line">                          <span class="keyword">continue</span>;</div><div class="line">                      &#125;</div><div class="line"></div><div class="line">                      <span class="keyword">final</span> <span class="keyword">float</span> x = ev.getX(i);</div><div class="line">                      <span class="keyword">final</span> <span class="keyword">float</span> y = ev.getY(i);</div><div class="line">                      <span class="keyword">if</span> (findTopChildUnder((<span class="keyword">int</span>) x, (<span class="keyword">int</span>) y) == mCapturedView</div><div class="line">                              &amp;&amp; tryCaptureViewForDrag(mCapturedView, id)) &#123;</div><div class="line">                          newActivePointer = mActivePointerId;</div><div class="line">                          <span class="keyword">break</span>;</div><div class="line">                      &#125;</div><div class="line">                  &#125;</div><div class="line"></div><div class="line">                  <span class="keyword">if</span> (newActivePointer == INVALID_POINTER) &#123;</div><div class="line">                      <span class="comment">// We didn't find another pointer still touching the view, release it.</span></div><div class="line">                      releaseViewForPointerUp();</div><div class="line">                  &#125;</div><div class="line">              &#125;</div><div class="line">              clearMotionHistory(pointerId);</div><div class="line">              <span class="keyword">break</span>;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="keyword">case</span> MotionEvent.ACTION_UP: &#123;</div><div class="line">              <span class="keyword">if</span> (mDragState == STATE_DRAGGING) &#123;</div><div class="line">                  releaseViewForPointerUp();</div><div class="line">              &#125;</div><div class="line">              cancel();</div><div class="line">              <span class="keyword">break</span>;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="keyword">case</span> MotionEvent.ACTION_CANCEL: &#123;</div><div class="line">              <span class="keyword">if</span> (mDragState == STATE_DRAGGING) &#123;</div><div class="line">                  dispatchViewReleased(<span class="number">0</span>, <span class="number">0</span>);</div><div class="line">              &#125;</div><div class="line">              cancel();</div><div class="line">              <span class="keyword">break</span>;</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>  这个方法中也是对触摸事件情况的处理,其中的down和up和上面的 <em>shouldInterceptTouchEvent</em> 类似,重点就在 ACTION_MOVE 中,可以发现重点就在 <em>dragTo</em> 方法中:<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dragTo</span><span class="params">(<span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> dx, <span class="keyword">int</span> dy)</span> </span>&#123;</div><div class="line">     <span class="keyword">int</span> clampedX = left;</div><div class="line">     <span class="keyword">int</span> clampedY = top;</div><div class="line">     <span class="keyword">final</span> <span class="keyword">int</span> oldLeft = mCapturedView.getLeft();</div><div class="line">     <span class="keyword">final</span> <span class="keyword">int</span> oldTop = mCapturedView.getTop();</div><div class="line">     <span class="keyword">if</span> (dx != <span class="number">0</span>) &#123;</div><div class="line">         clampedX = mCallback.clampViewPositionHorizontal(mCapturedView, left, dx);</div><div class="line">         ViewCompat.offsetLeftAndRight(mCapturedView, clampedX - oldLeft);</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">if</span> (dy != <span class="number">0</span>) &#123;</div><div class="line">         clampedY = mCallback.clampViewPositionVertical(mCapturedView, top, dy);</div><div class="line">         ViewCompat.offsetTopAndBottom(mCapturedView, clampedY - oldTop);</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="keyword">if</span> (dx != <span class="number">0</span> || dy != <span class="number">0</span>) &#123;</div><div class="line">         <span class="keyword">final</span> <span class="keyword">int</span> clampedDx = clampedX - oldLeft;</div><div class="line">         <span class="keyword">final</span> <span class="keyword">int</span> clampedDy = clampedY - oldTop;</div><div class="line">         mCallback.onViewPositionChanged(mCapturedView, clampedX, clampedY,</div><div class="line">                 clampedDx, clampedDy);</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>  可以看到,在这里完成了view的位置移动处理.通过 <em>mCallback</em> 中的各个方法来获取移动范围,并且有个 <em>mCallback.onViewPositionChanged</em> 位置移动的回调. 下面讲一下 <em>callback</em> 的用法.</p>
<p>(三) ViewDragHelper.Callback的用法<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Callback</span> </span>&#123;</div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Called when the drag state changes. See the &lt;code&gt;STATE_*&lt;/code&gt; constants</div><div class="line">       * for more information.</div><div class="line">       * 当view的拖拽状态改变时触发,对应下面写的三种情况中一种</div><div class="line">       * <span class="doctag">@param</span> state The new drag state</div><div class="line">       *</div><div class="line">       * <span class="doctag">@see</span> #STATE_IDLE 当前没有被拖拽</div><div class="line">       * <span class="doctag">@see</span> #STATE_DRAGGING 正在别拖拽</div><div class="line">       * <span class="doctag">@see</span> #STATE_SETTLING 被拖拽后需要安置到一个位置中的状态</div><div class="line">       */</div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewDragStateChanged</span><span class="params">(<span class="keyword">int</span> state)</span> </span>&#123;&#125;</div><div class="line"></div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Called when the captured view's position changes as the result of a drag or settle.</div><div class="line">       * 当view在拖拽时位置发生变化时触发,对应上面的 dragTo 方法</div><div class="line">       * <span class="doctag">@param</span> changedView View whose position changed</div><div class="line">       * <span class="doctag">@param</span> left New X coordinate of the left edge of the view</div><div class="line">       * <span class="doctag">@param</span> top New Y coordinate of the top edge of the view</div><div class="line">       * <span class="doctag">@param</span> dx Change in X position from the last call</div><div class="line">       * <span class="doctag">@param</span> dy Change in Y position from the last call</div><div class="line">       */</div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewPositionChanged</span><span class="params">(View changedView, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> dx, <span class="keyword">int</span> dy)</span> </span>&#123;&#125;</div><div class="line"></div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Called when a child view is captured for dragging or settling. The ID of the pointer</div><div class="line">       * currently dragging the captured view is supplied. If activePointerId is</div><div class="line">       * identified as &#123;<span class="doctag">@link</span> #INVALID_POINTER&#125; the capture is programmatic instead of</div><div class="line">       * pointer-initiated.</div><div class="line">       * 当一个view被捕获时触发</div><div class="line">       * <span class="doctag">@param</span> capturedChild Child view that was captured</div><div class="line">       * <span class="doctag">@param</span> activePointerId Pointer id tracking the child capture</div><div class="line">       */</div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewCaptured</span><span class="params">(View capturedChild, <span class="keyword">int</span> activePointerId)</span> </span>&#123;&#125;</div><div class="line"></div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Called when the child view is no longer being actively dragged.</div><div class="line">       * The fling velocity is also supplied, if relevant. The velocity values may</div><div class="line">       * be clamped to system minimums or maximums.</div><div class="line">       * 当拖拽动作释放时触发</div><div class="line">       * &lt;p&gt;Calling code may decide to fling or otherwise release the view to let it</div><div class="line">       * settle into place. It should do so using &#123;<span class="doctag">@link</span> #settleCapturedViewAt(int, int)&#125;</div><div class="line">       * or &#123;<span class="doctag">@link</span> #flingCapturedView(int, int, int, int)&#125;. If the Callback invokes</div><div class="line">       * one of these methods, the ViewDragHelper will enter &#123;<span class="doctag">@link</span> #STATE_SETTLING&#125;</div><div class="line">       * and the view capture will not fully end until it comes to a complete stop.</div><div class="line">       * If neither of these methods is invoked before &lt;code&gt;onViewReleased&lt;/code&gt; returns,</div><div class="line">       * the view will stop in place and the ViewDragHelper will return to</div><div class="line">       * &#123;<span class="doctag">@link</span> #STATE_IDLE&#125;.&lt;/p&gt;</div><div class="line">       *</div><div class="line">       * <span class="doctag">@param</span> releasedChild The captured child view now being released</div><div class="line">       * <span class="doctag">@param</span> xvel X velocity of the pointer as it left the screen in pixels per second.</div><div class="line">       * <span class="doctag">@param</span> yvel Y velocity of the pointer as it left the screen in pixels per second.</div><div class="line">       */</div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewReleased</span><span class="params">(View releasedChild, <span class="keyword">float</span> xvel, <span class="keyword">float</span> yvel)</span> </span>&#123;&#125;</div><div class="line"></div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Called when one of the subscribed edges in the parent view has been touched</div><div class="line">       * by the user while no child view is currently captured.</div><div class="line">       * 当触发了viewGroup的边缘时触发</div><div class="line">       * <span class="doctag">@param</span> edgeFlags A combination of edge flags describing the edge(s) currently touched</div><div class="line">       * <span class="doctag">@param</span> pointerId ID of the pointer touching the described edge(s)</div><div class="line">       * <span class="doctag">@see</span> #EDGE_LEFT</div><div class="line">       * <span class="doctag">@see</span> #EDGE_TOP</div><div class="line">       * <span class="doctag">@see</span> #EDGE_RIGHT</div><div class="line">       * <span class="doctag">@see</span> #EDGE_BOTTOM</div><div class="line">       */</div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEdgeTouched</span><span class="params">(<span class="keyword">int</span> edgeFlags, <span class="keyword">int</span> pointerId)</span> </span>&#123;&#125;</div><div class="line"></div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Called when the given edge may become locked. This can happen if an edge drag</div><div class="line">       * was preliminarily rejected before beginning, but after &#123;<span class="doctag">@link</span> #onEdgeTouched(int, int)&#125;</div><div class="line">       * was called. This method should return true to lock this edge or false to leave it</div><div class="line">       * unlocked. The default behavior is to leave edges unlocked.</div><div class="line">       * 是否锁定边缘的触摸</div><div class="line">       * <span class="doctag">@param</span> edgeFlags A combination of edge flags describing the edge(s) locked</div><div class="line">       * <span class="doctag">@return</span> true to lock the edge, false to leave it unlocked</div><div class="line">       */</div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onEdgeLock</span><span class="params">(<span class="keyword">int</span> edgeFlags)</span> </span>&#123;</div><div class="line">          <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Called when the user has started a deliberate drag away from one</div><div class="line">       * of the subscribed edges in the parent view while no child view is currently captured.</div><div class="line">       * 边缘触摸开始时触发</div><div class="line">       * <span class="doctag">@param</span> edgeFlags A combination of edge flags describing the edge(s) dragged</div><div class="line">       * <span class="doctag">@param</span> pointerId ID of the pointer touching the described edge(s)</div><div class="line">       * <span class="doctag">@see</span> #EDGE_LEFT</div><div class="line">       * <span class="doctag">@see</span> #EDGE_TOP</div><div class="line">       * <span class="doctag">@see</span> #EDGE_RIGHT</div><div class="line">       * <span class="doctag">@see</span> #EDGE_BOTTOM</div><div class="line">       */</div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEdgeDragStarted</span><span class="params">(<span class="keyword">int</span> edgeFlags, <span class="keyword">int</span> pointerId)</span> </span>&#123;&#125;</div><div class="line"></div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Called to determine the Z-order of child views.</div><div class="line">       * 在寻找当前的触摸点下的view时会调用这个方法,比如两个子view叠加在一起之后,如果你想获得下面的那个时,可以改写这个方法.</div><div class="line">       * <span class="doctag">@param</span> index the ordered position to query for</div><div class="line">       * <span class="doctag">@return</span> index of the view that should be ordered at position &lt;code&gt;index&lt;/code&gt;</div><div class="line">       */</div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrderedChildIndex</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</div><div class="line">          <span class="keyword">return</span> index;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Return the magnitude of a draggable child view's horizontal range of motion in pixels.</div><div class="line">       * This method should return 0 for views that cannot move horizontally.</div><div class="line">       * 获取被拖拽view的水平移动范围</div><div class="line">       * <span class="doctag">@param</span> child Child view to check</div><div class="line">       * <span class="doctag">@return</span> range of horizontal motion in pixels</div><div class="line">       */</div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getViewHorizontalDragRange</span><span class="params">(View child)</span> </span>&#123;</div><div class="line">          <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Return the magnitude of a draggable child view's vertical range of motion in pixels.</div><div class="line">       * This method should return 0 for views that cannot move vertically.</div><div class="line">       * 获取被拖拽view的垂直移动范围</div><div class="line">       * <span class="doctag">@param</span> child Child view to check</div><div class="line">       * <span class="doctag">@return</span> range of vertical motion in pixels</div><div class="line">       */</div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getViewVerticalDragRange</span><span class="params">(View child)</span> </span>&#123;</div><div class="line">          <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Called when the user's input indicates that they want to capture the given child view</div><div class="line">       * with the pointer indicated by pointerId. The callback should return true if the user</div><div class="line">       * is permitted to drag the given view with the indicated pointer.</div><div class="line">       *</div><div class="line">       * &lt;p&gt;ViewDragHelper may call this method multiple times for the same view even if</div><div class="line">       * the view is already captured; this indicates that a new pointer is trying to take</div><div class="line">       * control of the view.&lt;/p&gt;</div><div class="line">       * 尝试捕获当前触摸的view</div><div class="line">       * &lt;p&gt;If this method returns true, a call to &#123;<span class="doctag">@link</span> #onViewCaptured(android.view.View, int)&#125;</div><div class="line">       * will follow if the capture is successful.&lt;/p&gt;</div><div class="line">       *</div><div class="line">       * <span class="doctag">@param</span> child Child the user is attempting to capture</div><div class="line">       * <span class="doctag">@param</span> pointerId ID of the pointer attempting the capture</div><div class="line">       * <span class="doctag">@return</span> true if capture should be allowed, false otherwise</div><div class="line">       */</div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">tryCaptureView</span><span class="params">(View child, <span class="keyword">int</span> pointerId)</span></span>;</div><div class="line"></div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Restrict the motion of the dragged child view along the horizontal axis.</div><div class="line">       * The default implementation does not allow horizontal motion; the extending</div><div class="line">       * class must override this method and provide the desired clamping.</div><div class="line">       * 限制水平方向的移动范围</div><div class="line">       *</div><div class="line">       * <span class="doctag">@param</span> child Child view being dragged</div><div class="line">       * <span class="doctag">@param</span> left Attempted motion along the X axis</div><div class="line">       * <span class="doctag">@param</span> dx Proposed change in position for left</div><div class="line">       * <span class="doctag">@return</span> The new clamped position for left</div><div class="line">       */</div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">clampViewPositionHorizontal</span><span class="params">(View child, <span class="keyword">int</span> left, <span class="keyword">int</span> dx)</span> </span>&#123;</div><div class="line">          <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Restrict the motion of the dragged child view along the vertical axis.</div><div class="line">       * The default implementation does not allow vertical motion; the extending</div><div class="line">       * class must override this method and provide the desired clamping.</div><div class="line">       * 限制垂直方向的移动范围</div><div class="line">       *</div><div class="line">       * <span class="doctag">@param</span> child Child view being dragged</div><div class="line">       * <span class="doctag">@param</span> top Attempted motion along the Y axis</div><div class="line">       * <span class="doctag">@param</span> dy Proposed change in position for top</div><div class="line">       * <span class="doctag">@return</span> The new clamped position for top</div><div class="line">       */</div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">clampViewPositionVertical</span><span class="params">(View child, <span class="keyword">int</span> top, <span class="keyword">int</span> dy)</span> </span>&#123;</div><div class="line">          <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>  ViewDragHelper的内部流程实现就讲完了,有些细节这里就不展开了,感兴趣的同学可以读一下源码.在额外补充ViewDragHelper的常用方法 <em>settleCapturedViewAt</em> :<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">settleCapturedViewAt</span><span class="params">(<span class="keyword">int</span> finalLeft, <span class="keyword">int</span> finalTop)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (!mReleaseInProgress) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot settleCapturedViewAt outside of a call to "</span></div><div class="line">                   + <span class="string">"Callback#onViewReleased"</span>);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">return</span> forceSettleCapturedViewAt(finalLeft, finalTop,</div><div class="line">               (<span class="keyword">int</span>) VelocityTrackerCompat.getXVelocity(mVelocityTracker, mActivePointerId),</div><div class="line">               (<span class="keyword">int</span>) VelocityTrackerCompat.getYVelocity(mVelocityTracker, mActivePointerId));</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>  这个方法,用来直接把拖动的view放在指定的位置上.<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">forceSettleCapturedViewAt</span><span class="params">(<span class="keyword">int</span> finalLeft, <span class="keyword">int</span> finalTop, <span class="keyword">int</span> xvel, <span class="keyword">int</span> yvel)</span> </span>&#123;</div><div class="line">     <span class="keyword">final</span> <span class="keyword">int</span> startLeft = mCapturedView.getLeft();</div><div class="line">     <span class="keyword">final</span> <span class="keyword">int</span> startTop = mCapturedView.getTop();</div><div class="line">     <span class="keyword">final</span> <span class="keyword">int</span> dx = finalLeft - startLeft;</div><div class="line">     <span class="keyword">final</span> <span class="keyword">int</span> dy = finalTop - startTop;</div><div class="line"></div><div class="line">     <span class="keyword">if</span> (dx == <span class="number">0</span> &amp;&amp; dy == <span class="number">0</span>) &#123;</div><div class="line">         <span class="comment">// Nothing to do. Send callbacks, be done.</span></div><div class="line">         mScroller.abortAnimation();</div><div class="line">         setDragState(STATE_IDLE);</div><div class="line">         <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="keyword">final</span> <span class="keyword">int</span> duration = computeSettleDuration(mCapturedView, dx, dy, xvel, yvel);</div><div class="line">     mScroller.startScroll(startLeft, startTop, dx, dy, duration);</div><div class="line"></div><div class="line">     setDragState(STATE_SETTLING);</div><div class="line">     <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>  可以看到这里通过Scroller来完成view的平滑移动的.这个方法 <em>settleCapturedViewAt</em> 在拖动view释放之后让view进入指定位置的时候会非常有用.<br>  注意:一定要在viewGroup调用如下方法来完成view的平滑移动,在调用 <em>settleCapturedViewAt</em> 方法的时候.<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">computeScroll</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.computeScroll();</div><div class="line">    <span class="keyword">if</span> (mDragHelper.continueSettling(<span class="keyword">true</span>)) &#123;</div><div class="line">        ViewCompat.postInvalidateOnAnimation(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://pheobusyy.github.io/2017/01/24/2017/读书笔记/启示录-打造用户喜爱的产品/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanyi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pheobusyy">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/24/2017/读书笔记/启示录-打造用户喜爱的产品/" itemprop="url">
                  启示录-打造用户喜爱的产品
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-24T14:03:00+08:00">
                2017-01-24
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="启示录-打造用户喜爱的产品-读书笔记"><a href="#启示录-打造用户喜爱的产品-读书笔记" class="headerlink" title="启示录-打造用户喜爱的产品 读书笔记"></a>启示录-打造用户喜爱的产品 读书笔记</h2><p>我的日常工作明确分为三个部分: 人员,流程,产品</p>
<ul>
<li>人员是指负责定义和开发产品的团队成员的角色和职责</li>
<li>流程是指探索,开发富有创意的产品时,反复应用的步骤和成功的实践经验</li>
<li>产品是指富有创意的产品具有的鲜明特性</li>
</ul>
<h3 id="人员"><a href="#人员" class="headerlink" title="人员"></a>人员</h3><p>产品经理的主要职责分为两项: 评估产品机会;定义要开发的产品</p>
<p>现代软件的产品团队组成:</p>
<ul>
<li>产品经理</li>
<li>用户体验设计师</li>
<li>项目管理人员</li>
<li>开发团队</li>
<li>运维团队</li>
<li>产品营销人员</li>
</ul>
<p>必须清晰的界定产品经理和产品营销人员的职责.产品经理负责详细定义待开发的产品,让真实的用户测试产品.产品营销人员负责向外界宣传和推广产品,负责产品发布,为拓展市场销售渠道,组织重点营销活动(如在线营销),促进产品销售提供支持.</p>
<p>产品管理通常使用了 <em>并行开发</em> 和 <em>火车模型发布模式</em></p>
<p>优秀产品经理身上的7个特点:</p>
<ol>
<li>工作紧迫感</li>
<li>善于捕捉问题</li>
<li>思路清晰</li>
<li>用数据说话</li>
<li>果断</li>
<li>判断力</li>
<li>态度</li>
</ol>
<p>用户体验设计包含的方面:</p>
<ul>
<li>用户研究</li>
<li>交互设计</li>
<li>视觉设计</li>
<li>原型制作</li>
</ul>
<p>如果产品没有市场价值,那么无论开发团队多么优秀也无济于事.很多优秀的产品是程序员抓住用户需求,自己创业研发出来的.放宽眼界不仅仅有利于开发人员自己的职业发展,也有利于产品,顾客和公司.</p>
<p>关于留出时间调整代码的参考建议:</p>
<ol>
<li>针对开发团队确定的产品修改目标制定切实可行的计划和时间表</li>
<li>只要有可能,最好把重写目标分成几大块,实现递增修改,让用户感受到产品的改进,哪怕会因此把九个月的工作时间延长到两年,也一定要采用这种方式.</li>
<li>由于开发用户可见功能的资源有限,必须谨慎悬着正确的产品特性,确保产品定义的正确性</li>
</ol>
<p>产品经理应该有的特质:</p>
<ol>
<li>对产品的热情</li>
<li>用户立场</li>
<li>智力</li>
<li>职业操守</li>
<li>正直</li>
<li>信心</li>
<li>态度</li>
<li>技能</li>
<li>运用技术的能力</li>
<li>注意力</li>
<li>时间管理</li>
<li>沟通技能</li>
<li>商业技能</li>
</ol>
<p>产品总监的关键职责有两个方面.第一,组建优秀的产品经理团队.第二,规划公司的全局产品战略.</p>
<p><em>永远不要告诉别人怎么做,告诉他们做什么,他们自然会发挥天赋,给你惊喜. -巴顿</em></p>
<p>一定问明白客户”要做什么?” 而不是 “怎么做?”</p>
<p>管理上司的十条经验</p>
<ol>
<li>为项目波动做好准备</li>
<li>注意沟通的方式和频率</li>
<li>会前沟通</li>
<li>多用建议,少提问题</li>
<li>向上司借力</li>
<li>充分准备</li>
<li>缩短邮件篇幅</li>
<li>多用数据和事实说话</li>
<li>内部宣传</li>
<li>做让领导省心的员工</li>
</ol>
<h3 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h3><p>  为了评估产品机会,我要求产品经理回答如下是个问题:</p>
<ol>
<li>产品要解决什么问题? (产品价值)</li>
<li>为谁解决这个问题? (目标市场)</li>
<li>成功的机会有多大? (市场规模)</li>
<li>怎样判断产品成功与否? (度量指标)</li>
<li>有哪些同类产品? (竞品格局)</li>
<li>为什么我们最适合做这个产品? (竞争优势)</li>
<li>时机合适吗? (市场时机)</li>
<li>如何把产品推向市场? (营销组合策略)</li>
<li>成功的必要条件是什么? (解决方案要满足的条件)</li>
<li><p>根据以上问题,给出评估结论. (继续或放弃)</p>
<p>产品探索:采用流水线方式并行开发产品.也就是说,一点1.0产品进入项目执行阶段,就开始定义2.0版本的产品.</p>
</li>
</ol>
<h4 id="产品原则-确定什么最重要"><a href="#产品原则-确定什么最重要" class="headerlink" title="产品原则:确定什么最重要"></a>产品原则:确定什么最重要</h4><p>  每次加入新团队,我要做的第一件事就是制定产品原则.制定产品原则意味着决定什么重要,什么不重要,哪些原则是根本的,战略性的,哪些是临时的,战术性的.</p>
<p>  制定产品原则时容易出现两类错误.第一类是原则过于空泛,失去了指导作用.第二类是把设计原则误当成产品原则,比如,为用户提供清晰的导航路径(方便用户完成下一步操作)属于常见的设计原则,不是产品原则.</p>
<p>  在作产品决策之前,应该先确定决策要解决什么问题,让大家在一下几个要点上达成共识:</p>
<ol>
<li>究竟要解决什么问题</li>
<li>要为哪类人物角色解决这个问题</li>
<li>产品要达到什么目标</li>
<li>每项目标的优先级是什么</li>
</ol>
<h4 id="市场调研的工具和方法"><a href="#市场调研的工具和方法" class="headerlink" title="市场调研的工具和方法"></a>市场调研的工具和方法</h4><ul>
<li>用户调查</li>
<li>产品使用分析</li>
<li>数据挖掘</li>
<li>拜访用户</li>
<li>人物角色</li>
<li>可用性测试</li>
<li>同类产品分析</li>
</ul>
<p>合理的利用市场调研工具和方法可以回答一下几个关键问题:</p>
<ol>
<li>谁是目标用户?</li>
<li>用户会怎样使用产品?</li>
<li>用户能想明白怎样使用产品吗?障碍在哪里?</li>
<li>用户为什么选用你的产品?</li>
<li>用户喜欢产品的哪些特点?</li>
<li>用户希望如何改进产品,增加哪些功能?</li>
</ol>
<p>成功的产品基于以下两点认识:深入理解用户需求,以及明白什么样的解决方案在现阶段是可行的.</p>
<p>基本产品:定义最满足基本要求(价值,可用性,可行性)的产品.</p>
<p>设计产品时一定要考虑哪些功能是最重要的,争取设计出只满足基本要求的,不可删减的产品.</p>
<h4 id="改进现有产品"><a href="#改进现有产品" class="headerlink" title="改进现有产品"></a>改进现有产品</h4><p>能提高指标的功能才是你关注的重点.你应该找准方向,分析关键指标,有正对性的改进产品.</p>
<h4 id="快速响应阶段"><a href="#快速响应阶段" class="headerlink" title="快速响应阶段"></a>快速响应阶段</h4><p>关键不在于是否会出现问题,而在于能 <em>多快</em> 解决问题.</p>
<h4 id="在大公司施展拳脚"><a href="#在大公司施展拳脚" class="headerlink" title="在大公司施展拳脚"></a>在大公司施展拳脚</h4><ol>
<li>了解公司制定决策的方式</li>
<li>建立人脉网络</li>
<li>臭鼬工程</li>
<li>自己顶上</li>
<li>有选择的据理力争</li>
<li>会前沟通,形成默契</li>
<li>合理分配时间</li>
<li>分享信息</li>
<li>向上司借力</li>
<li>传播你的产品理念</li>
</ol>
<h3 id="产品"><a href="#产品" class="headerlink" title="产品"></a>产品</h3><h4 id="新技术层出不穷"><a href="#新技术层出不穷" class="headerlink" title="新技术层出不穷"></a>新技术层出不穷</h4><p>成功的产品往往不是新鲜事物,只是新瓶装老酒,之所以成功,是因为这个”新瓶”做的更好,更方便,更便宜,改变了消费者对”老酒”的印象.</p>
<p>现在成熟的市场上抢占一席之地,精明的公司至少要手握2两件”法宝”:</p>
<ol>
<li>对目标市场的了如指掌,对现有产品的缺陷洞若观火.</li>
<li>跟踪最新的技术趋势</li>
</ol>
<h4 id="情感接纳曲线"><a href="#情感接纳曲线" class="headerlink" title="情感接纳曲线"></a>情感接纳曲线</h4><p>根据消费者的情感特征,把他们分为技术爱好者,非理性消费者,理性消费者,超理性消费者和观望者.</p>
<p>非理性消费者最值得产品经理注意.</p>
<p>如果你带着新生的感觉去发掘每天折磨着大众的感情-孤独,恐惧,挫折,不满,你离发现新产品的日子就不远了.</p>
<h4 id="最佳实践经验"><a href="#最佳实践经验" class="headerlink" title="最佳实践经验"></a>最佳实践经验</h4><p>大大要点:</p>
<ol>
<li>产品管理的职责</li>
<li>用户体验</li>
<li>机会评估</li>
<li>特约用户</li>
<li>产品原则</li>
<li>任务角色</li>
<li>探索(定义)产品</li>
<li>使用原型</li>
<li>用户参与原型测试</li>
<li>根据数据改进产品</li>
</ol>
<h4 id="产品经理的反省清单"><a href="#产品经理的反省清单" class="headerlink" title="产品经理的反省清单"></a>产品经理的反省清单</h4><p>十大问题:</p>
<ol>
<li>产品能吸引目标消费者的关注吗?</li>
<li>产品的设计是否人性化,是否易于操作?</li>
<li>产品能在竞争中取胜吗?即使是面对未来风云变化的市场,依旧有取胜的把握吗?</li>
<li>我了解目标用户吗?产品(不是理性的产品,而是开发出来的产品)是否能得到他们的认可?</li>
<li>产品是否有别于市场上的其他产品?我能在两分钟内向公司高管清楚的阐明这些差别吗?能在一分钟内向客户解释清楚吗?能在半分钟内向经验丰富的行业分析师解释清楚吗?</li>
<li>产品能正产运行吗?</li>
<li>产品是否完整?用户对产品的印象如何?销售业绩如何?销售任务能否顺利完成?</li>
<li>产品的特设首付与目标用户的需求一致?产品特色是否鲜明?</li>
<li>产品值钱吗?值多少钱?为什么值这么多钱?用户会选择更便宜的产品吗?</li>
<li>我了解其他团队成员对产品的看法吗?他们觉得产品好在哪里?他们的看法是否与我的观点一致?</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://pheobusyy.github.io/2017/01/23/2017/androidSwipeLayout源码分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanyi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pheobusyy">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/23/2017/androidSwipeLayout源码分析/" itemprop="url">
                  androidSwipeLayout源码分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-23T15:19:00+08:00">
                2017-01-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="android-SwipeLayout源码分析"><a href="#android-SwipeLayout源码分析" class="headerlink" title="android SwipeLayout源码分析"></a>android SwipeLayout源码分析</h2><p>swipeLayout是代码家写的一个支持手势滑动的开源库,初看的时候感觉特别惊艳,用户体验也非常的棒,特别好奇是怎么实现的,故抽时间研究了下.<br>通过分析代码结构得出swipeLayout主要分为三大部分:</p>
<ol>
<li>内部view初始设置</li>
<li>内部ViewDragHelper的callback实现</li>
<li>冲突解决与注意事项</li>
</ol>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/01/23/2017/androidSwipeLayout源码分析/#more" rel="contents">
              Weiterlesen &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://pheobusyy.github.io/2017/01/23/2017/android自定义gradle插件/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanyi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pheobusyy">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/23/2017/android自定义gradle插件/" itemprop="url">
                  android自定义gradle插件
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-23T13:31:00+08:00">
                2017-01-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="android自定义gradle插件"><a href="#android自定义gradle插件" class="headerlink" title="android自定义gradle插件"></a>android自定义gradle插件</h2><p>  在android学习过程中,理解gradle的编译过程是非常重要的,我们可以通过自定义gradle插件来达到在编译打包的过程中人工参与其中的一部分工作,这样可以满足我们的各种需求,比如在编译之前要对所有的class做统一处理,比如打包完成之后要输出到指定的目录,这些都可以通过自定义的gradle插件来完成.</p>
<p>  下面讲解下如何在android studio中实现自定义的gradle插件</p>
<h2 id="在当前工程的gradle文件中实现插件"><a href="#在当前工程的gradle文件中实现插件" class="headerlink" title="在当前工程的gradle文件中实现插件"></a>在当前工程的gradle文件中实现插件</h2><p>  gradle插件理论上就是通过groovy语法实现的类,内部可以制定一些流程task来完成相应的工作.最简单的肯定是在当前工程的 <em>build.gradle</em> 文件中直接实现插件内容.因为实际上 <em>build.gralde</em> 就是一个groovy文件.</p>
<p>  在我们的android主工程目录中输入一下代码:</p>
  <figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"> <span class="class"><span class="keyword">class</span> <span class="title">GreetingPlugin</span> <span class="keyword">implements</span> <span class="title">Plugin</span>&lt;<span class="title">Project</span>&gt; &#123;</span></div><div class="line"></div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="keyword">void</span> apply(Project project) &#123;</div><div class="line">       project.extensions.create(<span class="string">"greeting"</span>, GreetingPluginExtension)</div><div class="line">       project.task(<span class="string">'hello'</span>) &#123;</div><div class="line">           doLast &#123;</div><div class="line">               println <span class="string">"$&#123;project.greeting.message&#125; from $&#123;project.greeting.greeter&#125;"</span></div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">GreetingPluginExtension</span> &#123;</span></div><div class="line">   String message = <span class="string">'Hello from GreetingPlugin'</span></div><div class="line">   String greeter</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> 这里首先是实现一个plugin接口,这个接口是所有的自定义插件的必须实现的.完成里面的 <em>apply</em> 方法,这里用到了一个 <em>extensions</em> 的概念,这个 <em>extensions</em> 是用来给工程project设置一些额外属性的对象.比如我们在android的 <em>build.gradle</em> 文件中经常看到的<br> <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">android&#123;</div><div class="line">  ....</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p> 这个 <em>android{}</em> 内部就是给工程中设置的一些参数.在咱们这里的设置的是 <em>extensions</em> 叫 <em>GreetingPluginExtension</em> ,内部定义了两个参数 <em>message</em> 和 <em>greeter</em> 这里前一个参数有默认值,后一个没有,其实groovy和java的语法基本上一样的,只不过groovy是动态的java.</p>
<p>接着看plugin中的 <em>apply</em> 方法,非常的简单就是定义一个名叫 <em>hello</em> 的 <em>task</em> ,然后在里面打印一下  <em>GreetingPluginExtension</em> 中的两个参数.那在 <em>build.gradle</em> 中如何设置对应的参数呢?看下面的代码:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">greeting &#123;</div><div class="line">    message  &apos;Hi from gradle&apos;</div><div class="line">    greeter  &apos;Gradle&apos;</div><div class="line">&#125;</div><div class="line">```  </div><div class="line">就是这么简单直白.定义完成之后,我们直接在主目录下终端运行一下命令:</div></pre></td></tr></table></figure></p>
<p>./gradlew -q hello<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">可以看到在终端中输出:</div></pre></td></tr></table></figure></p>
<p>Hi from gradle from Gradle<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">是不是非常的简单呢.在当前工程中定义的插件只能自己用,如果要给别人用的话就需要通过一个单独的工程来生成插件了.</div><div class="line"></div><div class="line">### 在单独工程中创建自定义gradle插件</div><div class="line"></div><div class="line">首先在当前的工程中随便创建一个android module ,然后src/main目录下所有文件夹全部删除掉.然后先创建一个groovy文件夹,里面用来存放我们的插件groovy代码,一个是 *GreetingPluginExtension* ,一个是 *MyGradlePlugin* 内部代码分别对应上面的两个class.</div><div class="line"></div><div class="line">然后再创建一个 *resources* 文件夹,里面放入一个 *META-INFO* 文件夹,然后继续在 *META-INFO* 文件夹下创建 *gradle-pulgins* ,在 *gradle-pulgins* 下创建文件</div><div class="line">*com.justyan.gradle.properties* 文件,文件内容为:</div></pre></td></tr></table></figure></p>
<p>implementation-class = com.justyan.gradleplugin.MyGradlePlugin<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">这里的 *com.justyan.gradle.properties* 文件的 *com.justyan.gradle* 就是你以后要给其他工程引用的的 gradle ID.比如这样:</div></pre></td></tr></table></figure></p>
<p>apply plugin: ‘com.justyan.gradle’<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">这个名称你可以随便起,只要在引用的时候引用对了就ok.文件中内容的目的是指定了插件的类路径,这里就是groovy文件下的那两个groovy文件.</div><div class="line"></div><div class="line">最后的文件目录应该是这样的:</div><div class="line">![插件工程的目录结构](images/2017/01/android自定义gradle插件的目录结构.png)</div><div class="line"></div><div class="line">这里的 *META-INFO* 和 *gradle-pulgins* 是android studio给合并显示了,实际上是一个层级关系.</div><div class="line"></div><div class="line">这样插件代码就完成了,剩下的就是如果打包发布的问题了.</div><div class="line"></div><div class="line">在创建的插件的module工程中的 *build.gradle* 文件中输入一下内容:</div></pre></td></tr></table></figure></p>
<p>apply plugin: ‘groovy’<br>apply plugin: ‘maven’</p>
<p>version = ‘1.0.0’<br>group = ‘com.justyan’<br>archivesBaseName = ‘mygradleplugin’<br>repositories {<br>    mavenCentral()<br>}</p>
<p>dependencies {<br>    compile gradleApi()<br>    compile localGroovy()<br>}<br>// 一定要记得使用交叉编译选项，因为我们可能用很高的JDK版本编译，为了让安装了低版本的同学能用上我们写的插件，必须设定source和target<br>compileGroovy {<br>    sourceCompatibility = 1.7<br>    targetCompatibility = 1.7<br>    options.encoding = “UTF-8”<br>}<br>uploadArchives {<br>    repositories {<br>        mavenDeployer {<br>            repository(url: “file:////Users/justyan/Downloads/repo”)<br>        }<br>    }<br>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">version用来表示maven生成的jar包版本号,group表示属于哪个组织, *archivesBaseName* 表示生成的java的名称.最后在 *uploadArchives* 中指定了生成的maven目录在哪里.这个目录你可以随意指定,只要后续引用的时候前后一致就可以.</div><div class="line"></div><div class="line">完成这个之后,我们调用这个工程的 *uploadArchives* task:</div></pre></td></tr></table></figure>
<p>./gradlew -q uploadArchives<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">然后就会在上面的指定目录下生成对应的maven文件了.</div><div class="line"></div><div class="line">最后,来看下如何在其他工程中引用.</div><div class="line"></div><div class="line">在要引用的工程的顶层目录的 *build.gralde* 文件中输入:</div></pre></td></tr></table></figure></p>
<p>buildscript {<br>    repositories {<br>        jcenter()<br>        maven {<br>            url uri(‘file:////Users/justyan/Downloads/repo’)<br>        }<br>    }<br>    dependencies {<br>        classpath ‘com.android.tools.build:gradle:2.2.2’<br>        classpath group: ‘com.justyan’, name: ‘mygradleplugin’,<br>                version: ‘1.0.0’<br>        // NOTE: Do not place your application dependencies here; they belong<br>        // in the individual module build.gradle files<br>    }<br>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">首先指定maven文件目录,和上面的对应,然后在 *dependencies* 中输入组名,插件名,版本号.这样对插件的引用就完成了.最后在要使用的工程中的 *build.gralde* 文件中顶部输入:</div></pre></td></tr></table></figure>
<p>apply plugin: ‘com.justyan.gradle’<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">然后用android studio同步一下gradle就可以了.这个时候在旁边的gradle project中是可以看到 *hello* 这个task的,表明插件加载成功.</div><div class="line">![task列表](images/2017/01/gradle project中的新增的task.png)</div><div class="line"></div><div class="line">最后如果我们要使用这个task和上面的方法一样,在终端中输入:</div></pre></td></tr></table></figure></p>
<p>./gradlew -q hello<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">可以看到在终端中输出:</div></pre></td></tr></table></figure></p>
<p>Hi from gradle from Gradle<br>```<br>这样自定义插件就全部搞定了,后续可以根据需求来自己实现插件中的内容了.</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a href="https://docs.gradle.org/current/userguide/custom_plugins.html" title="cutom_plugin" target="_blank" rel="external">cutom_plugin</a></p>
<p><a href="https://gold.xitu.io/entry/577bc26e165abd005530ead8" title="在 Android Studio 中自定义 Gradle 插件" target="_blank" rel="external">在 Android Studio 中自定义 Gradle 插件</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://pheobusyy.github.io/2017/01/23/2017/读书笔记/富爸爸 穷爸爸读书笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanyi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pheobusyy">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/23/2017/读书笔记/富爸爸 穷爸爸读书笔记/" itemprop="url">
                  富爸爸 穷爸爸 读书笔记
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-23T08:47:00+08:00">
                2017-01-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="富爸爸-穷爸爸-读书笔记"><a href="#富爸爸-穷爸爸-读书笔记" class="headerlink" title="富爸爸 穷爸爸 读书笔记"></a>富爸爸 穷爸爸 读书笔记</h2><p> 我一个爸爸总是习惯对说”我可付不起”,而另一个爸爸则禁止我们说这样的话,他坚持让我们说:”我怎样才能付得起?” 这两句话,一句是陈述句,一句是疑问句.一句让你放弃,而另一句则促使你去想办法.我那个在不久之后就富起来的爸爸解释,当你下意识的说出”我付不起”的时候,你的大脑就会停止思考,而如果你自问”我怎么才能付得起”,则会让你的大脑动起来.</p>
<p> 富爸爸说:”我的大脑越用越活,大脑越活,我挣点钱就越多”.他认为,下意识的说”我可付不起”意味着精神上的懒惰.</p>
<p> 在遇到钱的问题时,一个爸爸习惯于逃避,另一个爸爸则总是想办法解决问题.长此以往,其结果就是,一个爸爸的理财能力越来越弱,而另一个爸爸的理财能力越来越强.这种结果类似于一个经常去健身房锻炼的人与一个总坐在沙发上看电视的人在体质上的不同变化.适当的体育锻炼可以增加获得健康的机会,同时,适当的脑力训练可以增加获得财富的机会.懒惰必定会让你的体质变弱,财富减少.</p>
<p> 我得说生活才是最好的老师.大多数的时候,生活不会和你说什么,只会推着你转,每一次推,它都像是在说: “喂,醒一醒,我要让你学点东西.”<br>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/01/23/2017/读书笔记/富爸爸 穷爸爸读书笔记/#more" rel="contents">
              Weiterlesen &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://pheobusyy.github.io/2017/01/19/2017/java反射相关知识/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanyi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pheobusyy">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/19/2017/java反射相关知识/" itemprop="url">
                  java反射相关知识
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-19T15:16:00+08:00">
                2017-01-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="java反射相关知识"><a href="#java反射相关知识" class="headerlink" title="java反射相关知识"></a>java反射相关知识</h2><h3 id="Class-getDeclaringClass-和-Class-getEnclosingClass的区别"><a href="#Class-getDeclaringClass-和-Class-getEnclosingClass的区别" class="headerlink" title="Class.getDeclaringClass 和 Class.getEnclosingClass的区别"></a>Class.getDeclaringClass 和 Class.getEnclosingClass的区别</h3><p>getDeclaringClass表示这个内的声明类是那个,常用于获取在当前中声明的内部类<br>getEnclosingClass表示获取当前类的外部调用类,也可以用于在内部类中获取外部类.<br>二者的区别在于匿名内部类,如果这个类不是在当前类中声明,那么getDeclaringClass返回null,而getEnclosingClass返回外层类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestClassReflection</span></span>&#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchFieldException </span>&#123;</div><div class="line">         <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">             <span class="meta">@Override</span></div><div class="line">             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                 Class&lt;? extends Runnable&gt; aClass = <span class="keyword">this</span>.getClass();</div><div class="line">                 Class&lt;?&gt; declaringClass2 = aClass.getDeclaringClass();</div><div class="line">                 Class&lt;?&gt; enclosingClass1 = aClass.getEnclosingClass();</div><div class="line">                 System.out.println(<span class="string">"declaringClass2 = "</span>+declaringClass2);</div><div class="line">                 System.out.println(<span class="string">"enclosingClass1 = "</span>+enclosingClass1);</div><div class="line">             &#125;</div><div class="line">         &#125;).start();</div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">declaringClass2 = null</div><div class="line">enclosingClass1 = class com.justyan.reflection.TestClassReflection</div></pre></td></tr></table></figure>
<h3 id="打印出继承关系"><a href="#打印出继承关系" class="headerlink" title="打印出继承关系"></a>打印出继承关系</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printAncestor</span><span class="params">(Class aclass, ArrayList&lt;Class&gt; list)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (aclass != <span class="keyword">null</span>) &#123;</div><div class="line">           Class superclass = aclass.getSuperclass();</div><div class="line">           <span class="keyword">if</span> (superclass != <span class="keyword">null</span>) &#123;</div><div class="line">               list.add(superclass);</div><div class="line">               printAncestor(superclass, list);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>最后把所有的父类都在list中.</p>
<h3 id="Class-getGenericInterfaces方法和Class-getInterfaces方法的区别"><a href="#Class-getGenericInterfaces方法和Class-getInterfaces方法的区别" class="headerlink" title="Class.getGenericInterfaces方法和Class.getInterfaces方法的区别"></a>Class.getGenericInterfaces方法和Class.getInterfaces方法的区别</h3><p>getGenericInterfaces返回所有的实现接口,包含接口的泛型<br>getInterfaces返回所有的接口class对象,不包含泛型信息</p>
<h3 id="Class-getTypeParameters-方法"><a href="#Class-getTypeParameters-方法" class="headerlink" title="Class.getTypeParameters 方法"></a>Class.getTypeParameters 方法</h3><p>getTypeParameters返回类的泛型信息</p>
<h3 id="Class-getDeclaredMethods-和-Class-getMethods-区别"><a href="#Class-getDeclaredMethods-和-Class-getMethods-区别" class="headerlink" title="Class.getDeclaredMethods 和 Class.getMethods 区别"></a>Class.getDeclaredMethods 和 Class.getMethods 区别</h3><p>这类前面加了 <em>Declared</em> 的方法,只是获取当前类的成员,不包含父类的相关成员<br>而getMethods会获取所有的方法</p>
<h3 id="Class-getFields和Class-getDeclaredFields"><a href="#Class-getFields和Class-getDeclaredFields" class="headerlink" title="Class.getFields和Class.getDeclaredFields"></a>Class.getFields和Class.getDeclaredFields</h3><p>getFields获取当前类所有的 <em>public</em> 属性<br>getDeclaredFields返回当前类所有的属性<br>下面的话摘自官方教程</p>
<blockquote>
<p>Tip: The Class.getField() and Class.getFields() methods return the public member field(s) of the class, enum, or interface represented by &gt;the Class object. To retrieve all fields declared (but not inherited) in the Class, use the Class.getDeclaredFields() method.</p>
</blockquote>
<h3 id="反射中获取method参数的相关属性"><a href="#反射中获取method参数的相关属性" class="headerlink" title="反射中获取method参数的相关属性"></a>反射中获取method参数的相关属性</h3><p>method.getParameters用来获取该方法的所有参数.返回一个 <em>Parameter[]</em> 数组.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printParam</span><span class="params">(Method declaredMethod)</span> </span>&#123;</div><div class="line">    Parameter[] parameters = declaredMethod.getParameters();</div><div class="line">    <span class="keyword">for</span> (Parameter parameter : parameters) &#123;</div><div class="line">        System.out.println(parameter.getType());</div><div class="line">        System.out.println(parameter.getName());</div><div class="line">        System.out.println(parameter.getModifiers());</div><div class="line">        System.out.println(parameter.isImplicit());</div><div class="line">        System.out.println(parameter.isNamePresent());</div><div class="line">        System.out.println(parameter.isSynthetic());</div><div class="line">    &#125;</div><div class="line">    System.out.println(<span class="string">"-------------------------"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>分别来解释下这几个方法的用法:</p>
<ol>
<li><em>getType</em> 获取参数类型,比如int,java.lang.String等</li>
<li><em>getName</em> 获取参数名称,这里有个问题要注意,默认情况下获取到的参数都是 <em>arg0</em> ,<em>arg1</em> 等这样的系统生成的参数名称,是获取不到原始的命名的,这样做的目的是为了节约class文件的空间.如果想要获取到原始参数名称,需要在编译的 <em>javac</em> 后面加上 <em>-parameters</em> 参数.</li>
<li><p><em>getModifiers</em> 是一个int值,是把下面要3种情况相加得出的.<br><img src="/images/2017/01/method的modifiers属性说明.png" alt="modifiers属性说明"></p>
</li>
<li><p><em>isImplicit</em> 和 <em>isSynthetic</em> 下面重点来讲一下</p>
</li>
<li><em>isNamePresent</em> 对应上面的 <em>getName</em> 的情况,如果是从显示的原始的class中参数命名就是true,如果是编译器生成的 <em>arg0</em> 这种方式就是 false.</li>
</ol>
<h4 id="isImplicit-和-isSynthetic"><a href="#isImplicit-和-isSynthetic" class="headerlink" title="isImplicit 和 isSynthetic"></a><em>isImplicit</em> 和 <em>isSynthetic</em></h4><p>先来看 <em>isImplicit</em> 通过字面理解就是 <em>含蓄的,隐式的</em> ,也就是说这个方法并没有在代码中直接声明,确实是存在的.对应的正常情景就是内部类对外部类的引用.我们都知道 <em>非静态</em> 内部类是对外部类有一个引用的.那么编译器在编译的时候生成的内部类的构造方法中是会有一个外部类的对象引用的.就想下面这样:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodParameterExamples</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InnerClass</span> </span>&#123; &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodParameterExamples</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InnerClass</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> MethodParameterExamples parent;</div><div class="line">        InnerClass(<span class="keyword">final</span> MethodParameterExamples <span class="keyword">this</span>$<span class="number">0</span>) &#123;</div><div class="line">            parent = <span class="keyword">this</span>$<span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>innerClass的默认构造函数其实是对外部的MethodParameterExamples有一个引用的,那么innerClass这个默认的构造方法的 <em>isImplicit</em> 属性就是true.</p>
<p>再来看,如果一个方法既不是显式的也不是隐式的而是通过编译器生成的,那么这个 <em>isSynthetic</em> 属性就为true.经典的用在枚举类型中<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodParameterExamples</span> </span>&#123;</div><div class="line">    <span class="keyword">enum</span> Colors &#123;</div><div class="line">        RED, WHITE;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果答应这里Colors类对象的话,会发现其内部是这样的:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Colors</span> <span class="keyword">extends</span> <span class="title">java</span>.<span class="title">lang</span>.<span class="title">Enum</span>&lt;<span class="title">Colors</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> Colors RED = <span class="keyword">new</span> Colors(<span class="string">"RED"</span>, <span class="number">0</span>);</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> Colors BLUE = <span class="keyword">new</span> Colors(<span class="string">"WHITE"</span>, <span class="number">1</span>);</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> values = <span class="keyword">new</span> Colors[]&#123; RED, BLUE &#125;;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Colors</span><span class="params">(String name, <span class="keyword">int</span> ordinal)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(name, ordinal);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Colors[] values()&#123;</div><div class="line">        <span class="keyword">return</span> values;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Colors <span class="title">valueOf</span><span class="params">(String name)</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> (Colors)java.lang.Enum.valueOf(Colors.class, name);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里面的构造函数 <em>Colors(String name , ind ordinal)</em> 是隐式声明的,其中的参数是编译器给生成的,那么参数的 <em>isSynthetic</em> 属性就是true.其中的 <em>valueOf</em> 方法中的参数是 <em>isImplicit</em> 的.<br><a href="https://docs.oracle.com/javase/tutorial/reflect/member/methodparameterreflection.html" target="_blank" rel="external">implicit and synthetic</a></p>
<h3 id="Method-isVarArgs"><a href="#Method-isVarArgs" class="headerlink" title="Method.isVarArgs()"></a>Method.isVarArgs()</h3><p> Method.isVarArgs() 表明方法的参数是不是隐式数组这种格式,比如main方法中的 <em>String… args</em></p>
<h3 id="Method的isSynthetic和isBridge"><a href="#Method的isSynthetic和isBridge" class="headerlink" title="Method的isSynthetic和isBridge"></a>Method的isSynthetic和isBridge</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestMethodModifiers</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        Method[] methods = Integer.class.getMethods();</div><div class="line">        <span class="keyword">for</span> (Method method : methods) &#123;</div><div class="line">            <span class="keyword">if</span> (method.getName().equals(<span class="string">"compareTo"</span>)) &#123;</div><div class="line">                System.out.println(method.toGenericString());</div><div class="line">                System.out.println(method.isSynthetic());</div><div class="line">                System.out.println(method.isBridge());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">public int java.lang.Integer.compareTo(java.lang.Integer)</div><div class="line">false</div><div class="line">false</div><div class="line">public int java.lang.Integer.compareTo(java.lang.Object)</div><div class="line">true</div><div class="line">true</div></pre></td></tr></table></figure>
<p>编译器会帮助生成一个 <em>compareTo(Object object)</em> 的中间方法,这个方法就是一个中间方法,用来解决 <em>泛型擦除?</em> 这里我也不是很明白.</p>
<h3 id="method反射调用注意事项"><a href="#method反射调用注意事项" class="headerlink" title="method反射调用注意事项"></a>method反射调用注意事项</h3><ol>
<li><p>如果要反射的方法需要传入的参数是一个数组,就像这样的:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">(String... arr)</span> </span>&#123;</div><div class="line">       System.out.println(<span class="string">"Iam test!!!!------"</span> +arr);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>如果你直接这样调用是不行的:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">String[] mainArgs = <span class="keyword">new</span> String[]&#123;<span class="string">"a"</span>, <span class="string">"b"</span>&#125;;</div><div class="line">method.invoke(TestMethodBean2.class.newInstance(), mainArgs);</div></pre></td></tr></table></figure>
<p>虽然你传入的确实是一个数组,但是invoke方法会认为你要调用的方法是参数个数为数组容量的方法,也就是说这里认为你想调用的是包含两个参数的test方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">(String a,String b)</span> </span>&#123;</div><div class="line">       System.out.println(<span class="string">"Iam test!!!!------"</span> +arr);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>如果要正确调用,应该把数组对象转换为Object对象,这样就可以了:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">String[] mainArgs = <span class="keyword">new</span> String[]&#123;<span class="string">"a"</span>, <span class="string">"b"</span>&#125;;</div><div class="line">method.invoke(TestMethodBean2.class.newInstance(), (Object) mainArgs);</div></pre></td></tr></table></figure>
</li>
<li><p>如果要反射一个带有泛型的方法,就像这样:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestMethodBean2</span>&lt;<span class="title">T</span>&gt;</span>&#123;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">(T t)</span> </span>&#123;</div><div class="line">    System.out.println(<span class="string">"it is generic"</span>);</div><div class="line"> &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> TestMethodBean2&lt;Integer&gt;().getClass().getDeclaredMethod(<span class="string">"test"</span>,Integer.class);</div></pre></td></tr></table></figure>
<p>是不行的,会找不到这个方法,因为泛型在编译之后是会被擦除的,这个时候应该找的是最顶上的对象object才可以</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> TestMethodBean2&lt;Integer&gt;().getClass().getDeclaredMethod(<span class="string">"test"</span>,Object.class);</div></pre></td></tr></table></figure>
</li>
<li><p>对private方法的反射调用<br>要在获取到方法对象之后设置 <em>method.setAccessible(true);</em> 就可以了</p>
</li>
<li><p>如果要反射的方法没有参数,那么调用invoke方法的时候一定要注意</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">  public class MethodTrouble &#123;</div><div class="line">    public static void main(String[] args) throws NoSuchMethodException, InvocationTargetException, IllegalAccessException &#123;</div><div class="line">        MethodTroubleBean bean = new MethodTroubleBean();</div><div class="line">        Method test = bean.getClass().getDeclaredMethod("test");</div><div class="line">        test.invoke(bean);  //success</div><div class="line">        test.invoke(bean, null); //success ,但是有警告</div><div class="line">        test.invoke(bean, new Object[0]); //success</div><div class="line">        Object o = new Object[0];</div><div class="line">        test.invoke(bean, o);  //wrong IllegalArgumentException</div><div class="line">        Object n = null;</div><div class="line">        test.invoke(bean, n);  //wrong IllegalArgumentException</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">class MethodTroubleBean &#123;</div><div class="line">    void test() &#123;</div><div class="line">        System.out.println("test");</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">```  </div><div class="line">一定要注意对参数的传入.</div><div class="line"></div><div class="line">### Class.newInstance 和Construction.newInstance的区别</div><div class="line">Class.newInstance只能调用默认的构造函数(没有参数的那个),而且必须是可见的</div><div class="line">Construction.newInstance可以调用所有的构造函数,不管是否是可见的,也不管有多少个参数</div><div class="line">推荐使用后面这个</div><div class="line"></div><div class="line">### 反射创建数组</div><div class="line">```java</div><div class="line">Object o = Array.newInstance(int.class, 3);</div><div class="line">        Array.set(o,0,1);</div><div class="line">        Array.set(o,1,2);</div><div class="line">        Array.set(o,2,3);</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a href="https://docs.oracle.com/javase/tutorial/reflect/TOC.html" title="java reflect tutorial" target="_blank" rel="external">java reflect tutorial</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://pheobusyy.github.io/2017/01/19/2017/android asyncTask源码分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanyi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pheobusyy">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/19/2017/android asyncTask源码分析/" itemprop="url">
                  android asyncTask源码分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-19T09:25:00+08:00">
                2017-01-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="android-AsyncTask源码分析-android7-0"><a href="#android-AsyncTask源码分析-android7-0" class="headerlink" title="android AsyncTask源码分析(android7.0)"></a>android AsyncTask源码分析(android7.0)</h2><p>  说道AsyncTask相信大家并不陌生,每当涉及到异步线程的的任务处理的时候,我们第一时间就会想到AsyncTask或者Handler.这里AsyncTask主要是android给我们封装了一层异步任务处理流程,方便使用,所以平时大家在UI中执行异步线程的时候会优先使用AsyncTask,今天就通过源码讲解一下AsyncTask的实现原理和注意事项.</p>
<h3 id="AsyncTask的用法"><a href="#AsyncTask的用法" class="headerlink" title="AsyncTask的用法"></a>AsyncTask的用法</h3><p>` <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">`	class MainAsyncTask extends AsyncTask&lt;Object,Object,Object&gt;&#123;`</div><div class="line">	 </div><div class="line">	       @Override</div><div class="line">	       protected void onPreExecute() &#123;</div><div class="line">	           super.onPreExecute();</div><div class="line">	       &#125;</div><div class="line">	 </div><div class="line">	       @Override</div><div class="line">	       protected void onPostExecute(Object o) &#123;</div><div class="line">	           super.onPostExecute(o);</div><div class="line">	       &#125;</div><div class="line">	 </div><div class="line">	       @Override</div><div class="line">	       protected Object doInBackground(Object... params) &#123;</div><div class="line">	           return null;</div><div class="line">	       &#125;</div><div class="line">	   &#125;</div><div class="line">` `</div></pre></td></tr></table></figure></p>
<p>`上面这个自定义AsyncTask就是我们平时的用法,可以看到主要用到3个方法,其中 <em>onPreExecute</em> 和 <em>onPostExecute</em> 分别表示任务开始前后的准备和收尾工作,注意这里这两个方法是在UI主线程中执行的.后面的 <em>doInBackground</em> 是任务的执行的代码,耗时的任务执行代码放在这里.注意这个方法是在异步线程中执行的.</p>
<p>当我们要使用AsyncTask的时候,通常是直接创建AsyncTask对象,然后调用execute方法,这样AsyncTask会先调用 <em>onPreExecute</em> 方法,然后开始执行 <em>doInBackground</em> 方法啊,最后任务完成之后回调 <em>onPostExecute</em> 方法.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> MainAsyncTask().execute();</div></pre></td></tr></table></figure></p>
<h3 id="AsyncTask源码"><a href="#AsyncTask源码" class="headerlink" title="AsyncTask源码"></a>AsyncTask源码</h3><p>先说结论,AsyncTask的内部实际上维护了一个线程池来调配异步任务(FutureTask)的执行,当异步任务执行完成之后就把结果交给内部的 <em>Handler</em> 来回调到UI主线程中.<br>就这么简单,我们要注意的细节有这么几点:</p>
<ol>
<li>内部线程池的结构类型</li>
<li>3个常用回调方法的调用时机</li>
<li>任务完成之后为什么不能再次调用这个AsyncTask对象重复执行.</li>
</ol>
<p>我们先从常用的 <em>execute</em> 方法入手:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@MainThread</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> AsyncTask&lt;Params, Progress, Result&gt; <span class="title">execute</span><span class="params">(Params... params)</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> executeOnExecutor(sDefaultExecutor, params);</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>这里execute内部又会调用 <em>executeOnExecutor</em> 方法,这里的 <em>sDefaultExecutor</em> 后面再做解释,只要明白其就是一个线程池就可以:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@MainThread</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> AsyncTask&lt;Params, Progress, Result&gt; <span class="title">executeOnExecutor</span><span class="params">(Executor exec,</span></span></div><div class="line">           Params... params) &#123;</div><div class="line">       <span class="keyword">if</span> (mStatus != Status.PENDING) &#123;</div><div class="line">           <span class="keyword">switch</span> (mStatus) &#123;</div><div class="line">               <span class="keyword">case</span> RUNNING:</div><div class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot execute task:"</span></div><div class="line">                           + <span class="string">" the task is already running."</span>);</div><div class="line">               <span class="keyword">case</span> FINISHED:</div><div class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot execute task:"</span></div><div class="line">                           + <span class="string">" the task has already been executed "</span></div><div class="line">                           + <span class="string">"(a task can be executed only once)"</span>);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       mStatus = Status.RUNNING;</div><div class="line"></div><div class="line">       onPreExecute();</div><div class="line"></div><div class="line">       mWorker.mParams = params;</div><div class="line">       exec.execute(mFuture);</div><div class="line"></div><div class="line">       <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>可以看到,这个代码非常非常的简单,就是判断一下 AsyncTask 对象的状态,如果不是 <em>PENDING</em> 状态就抛出异常.如果是 <em>PENDING</em> 状态就设置为 <em>RUNNING</em> 状态,同时调用 <em>onPreExecute</em> 方法,最后交给线程池的 <em>execute</em> 方法.是不是很清晰.同时在这里发现了我们的第一个回调方法 <em>onPreExecute</em> ,注意这里通过方法上面的注解我们发现是运行在主线程中的.</p>
<p>这里传入线程池的是一个 <em>FutureTask</em> 对象 <em>mFuture</em> ,里面包含了一个 <em>mWorker</em> 对象.下面来看传给线程池的 <em>mWorker</em> 对象的实现. <em>mWorker</em> 对象是一个 <em>WorkerRunable</em> 对象<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">WorkerRunnable</span>&lt;<span class="title">Params</span>, <span class="title">Result</span>&gt; <span class="keyword">implements</span> <span class="title">Callable</span>&lt;<span class="title">Result</span>&gt; </span>&#123;</div><div class="line">      Params[] mParams;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>可以看到 <em>WorkerRunnable</em> 对象就是一个 <em>Callable</em> 对象, <em>Callable</em> 和 <em>Runnable</em> 的区别就是有没有返回值的区别.这里AsyncTask线程池中使用的 <em>Callable</em> .<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">AsyncTask</span><span class="params">()</span> </span>&#123;</div><div class="line">       mWorker = <span class="keyword">new</span> WorkerRunnable&lt;Params, Result&gt;() &#123;</div><div class="line">           <span class="function"><span class="keyword">public</span> Result <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">               mTaskInvoked.set(<span class="keyword">true</span>);</div><div class="line">               Result result = <span class="keyword">null</span>;</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</div><div class="line">                   <span class="comment">//noinspection unchecked</span></div><div class="line">                   result = doInBackground(mParams);</div><div class="line">                   Binder.flushPendingCommands();</div><div class="line">               &#125; <span class="keyword">catch</span> (Throwable tr) &#123;</div><div class="line">                   mCancelled.set(<span class="keyword">true</span>);</div><div class="line">                   <span class="keyword">throw</span> tr;</div><div class="line">               &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                   postResult(result);</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">return</span> result;</div><div class="line">           &#125;</div><div class="line">       &#125;;</div><div class="line"></div><div class="line">       mFuture = <span class="keyword">new</span> FutureTask&lt;Result&gt;(mWorker) &#123;</div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">done</span><span class="params">()</span> </span>&#123;</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   postResultIfNotInvoked(get());</div><div class="line">               &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                   android.util.Log.w(LOG_TAG, e);</div><div class="line">               &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</div><div class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"An error occurred while executing doInBackground()"</span>,</div><div class="line">                           e.getCause());</div><div class="line">               &#125; <span class="keyword">catch</span> (CancellationException e) &#123;</div><div class="line">                   postResultIfNotInvoked(<span class="keyword">null</span>);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>在AsyncTask的构造函数中,完成了 <em>mWorker</em> 对象的初始化.然后把 <em>mWorker</em> 对象传给了 <em>mFuture</em> 对象. 如果对 <em>FutureTask</em> 不是很理解的同学可以去搜索一下相关的资料,非常简单. <em>FutureTask</em> 只是把要运行的对象和其返回值做了一个封装,方便线程池的回调使用.</p>
<p>在 <em>mWorker</em> 的call方法中,我们发现了第二个回调方法 <em>doInBackground</em> ,这个方法用来执行异步任务的,这里是在异步线程中执行的.<br>当任务执行完成之后,会调用 <em>postResult(result);</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Result <span class="title">postResult</span><span class="params">(Result result)</span> </span>&#123;</div><div class="line">       <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">       Message message = getHandler().obtainMessage(MESSAGE_POST_RESULT,</div><div class="line">               <span class="keyword">new</span> AsyncTaskResult&lt;Result&gt;(<span class="keyword">this</span>, result));</div><div class="line">       message.sendToTarget();</div><div class="line">       <span class="keyword">return</span> result;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>这里可看到Handler的常规使用.来看Handler的实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">InternalHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="title">InternalHandler</span><span class="params">()</span> </span>&#123;</div><div class="line">           <span class="keyword">super</span>(Looper.getMainLooper());</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"unchecked"</span>, <span class="string">"RawUseOfParameterizedType"</span>&#125;)</div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">           AsyncTaskResult&lt;?&gt; result = (AsyncTaskResult&lt;?&gt;) msg.obj;</div><div class="line">           <span class="keyword">switch</span> (msg.what) &#123;</div><div class="line">               <span class="keyword">case</span> MESSAGE_POST_RESULT:</div><div class="line">                   <span class="comment">// There is only one result</span></div><div class="line">                   result.mTask.finish(result.mData[<span class="number">0</span>]);</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">               <span class="keyword">case</span> MESSAGE_POST_PROGRESS:</div><div class="line">                   result.mTask.onProgressUpdate(result.mData);</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>这里Handler里面有两个回调,先说 <em>MESSAGE_POST_RESULT</em> ,这里回到了asyncTask的 <em>finish</em> 方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">finish</span><span class="params">(Result result)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (isCancelled()) &#123;</div><div class="line">            onCancelled(result);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            onPostExecute(result);</div><div class="line">        &#125;</div><div class="line">        mStatus = Status.FINISHED;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p><em>finish</em> 方法,有两个点要说明:首先你在外面调用 <em>cancel</em> 停止AsyncTask的时候,AsyncTask内部并没有停止,而是会继续执行,直到最后在finish中才做的的状态判断,只是忽略掉了返回结果而已.so,如果cancel了AsyncTask,那么是不会回调 <em>onPostExecute</em> 的,同时任务也不是立刻就停止的.如果想要任务马上停止,只能是在 <em>doInBackground</em> 方法中来对AsyncTask的状态做判断,如果状态变化了,里面return,这样可以保证任务立刻停止.<br>还有一个点要注意的是,前面有个问题:为什么AsyncTask执行完成之后不能继续调用execute方法呢.是因为在 <em>finish</em> 方法中,把这个AsyncTask对象的状态设置为 <em>FINISHED</em> ,在execute方法中第一步中就判断如果状态不是 <em>PENDING</em> 就会抛出异常.关键点在这里,所有我们如果还要二次执行任务的话,只能是重新创建一个新的AsyncTask对象了.</p>
<p>回到刚才Handler中,可以看到还有另一个异步回调情况 <em>MESSAGE_POST_PROGRESS</em> 这个是用来干什么的呢?通过字面理解我么可以发现是用来更新进度说明的.在代码中,找到了这个方法 <em>publishProgress</em> .<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">    * This method can be invoked from &#123;<span class="doctag">@link</span> #doInBackground&#125; to</div><div class="line">    * publish updates on the UI thread while the background computation is</div><div class="line">    * still running. Each call to this method will trigger the execution of</div><div class="line">    * &#123;<span class="doctag">@link</span> #onProgressUpdate&#125; on the UI thread.</div><div class="line">    *</div><div class="line">    * &#123;<span class="doctag">@link</span> #onProgressUpdate&#125; will not be called if the task has been</div><div class="line">    * canceled.</div><div class="line">    *</div><div class="line">    * <span class="doctag">@param</span> values The progress values to update the UI with.</div><div class="line">    *</div><div class="line">    * <span class="doctag">@see</span> #onProgressUpdate</div><div class="line">    * <span class="doctag">@see</span> #doInBackground</div><div class="line">    */</div><div class="line"><span class="meta">@WorkerThread</span></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">publishProgress</span><span class="params">(Progress... values)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (!isCancelled()) &#123;</div><div class="line">           getHandler().obtainMessage(MESSAGE_POST_PROGRESS,</div><div class="line">                   <span class="keyword">new</span> AsyncTaskResult&lt;Progress&gt;(<span class="keyword">this</span>, values)).sendToTarget();</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>仔细看方法上面的注释,这个方法可以在 <em>doInBackground</em> 中调用,来更新进度说明.最后这个方法会在主线程中回调 <em>onProgressUpdate</em> .<br>也就是说如果我们复写 <em>onProgressUpdate</em> 方法,我们可以在UI主线程中获取到进度更新提示.</p>
<p>上面提出的3个问题中后两个问题我们已经解释了,3个方法的回调时机非常清晰,同时AsyncTask由于最后finish状态原因是无法再次执行的.<br>最后说说AsyncTask中线程池的实现,这个点由于在不同的android版本的变化会有很多的差异,这里的源码使用是最新的7.0源码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * An &#123;<span class="doctag">@link</span> Executor&#125; that executes tasks one at a time in serial</div><div class="line">   * order.  This serialization is global to a particular process.</div><div class="line">   */</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Executor SERIAL_EXECUTOR = <span class="keyword">new</span> SerialExecutor();</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> Executor sDefaultExecutor = SERIAL_EXECUTOR;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SerialExecutor</span> <span class="keyword">implements</span> <span class="title">Executor</span> </span>&#123;</div><div class="line">       <span class="keyword">final</span> ArrayDeque&lt;Runnable&gt; mTasks = <span class="keyword">new</span> ArrayDeque&lt;Runnable&gt;();</div><div class="line">       Runnable mActive;</div><div class="line"></div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> Runnable r)</span> </span>&#123;</div><div class="line">           mTasks.offer(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">               <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                   <span class="keyword">try</span> &#123;</div><div class="line">                       r.run();</div><div class="line">                   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                       scheduleNext();</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125;);</div><div class="line">           <span class="keyword">if</span> (mActive == <span class="keyword">null</span>) &#123;</div><div class="line">               scheduleNext();</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">scheduleNext</span><span class="params">()</span> </span>&#123;</div><div class="line">           <span class="keyword">if</span> ((mActive = mTasks.poll()) != <span class="keyword">null</span>) &#123;</div><div class="line">               THREAD_POOL_EXECUTOR.execute(mActive);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>这里创建了一种叫做 <em>SerialExecutor</em> 的线程池,通过字面理解可以知道是一种串行的线程池,也就是说线程是挨个来交给 <em>THREAD_POOL_EXECUTOR</em> .这里的的 <em>SerialExecutor</em> 用到了 <em>ArrayDeque</em> 这种双向队列数据结构.只允许在结尾插入,在头部取出.可以看下其中的 <em>offer</em> 和 <em>poll</em> 方法.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">offer</span><span class="params">(E e)</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> offerLast(e);</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> E <span class="title">poll</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> pollFirst();</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>首先offer新的任务到 <em>SerialExecutor</em> 中时,判断 <em>mActive</em> 是否存在,如果不存在就去从 <em>ArrayDeque</em> 中取一个出来执行,每当其中一个任务执行完成后,最终会调用 <em>scheduleNext</em> 方法,这样就保证队列中的任务顺序执行了.</p>
<p>最后 <em>SerialExecutor</em> 是把代码交给 <em>THREAD_POOL_EXECUTOR</em> 线程池了,再来看它的实现方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CORE_POOL_SIZE = Math.max(<span class="number">2</span>, Math.min(CPU_COUNT - <span class="number">1</span>, <span class="number">4</span>));</div><div class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAXIMUM_POOL_SIZE = CPU_COUNT * <span class="number">2</span> + <span class="number">1</span>;</div><div class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> KEEP_ALIVE_SECONDS = <span class="number">30</span>;</div><div class="line"></div><div class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadFactory sThreadFactory = <span class="keyword">new</span> ThreadFactory() &#123;</div><div class="line">       <span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger mCount = <span class="keyword">new</span> AtomicInteger(<span class="number">1</span>);</div><div class="line"></div><div class="line">       <span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span> </span>&#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">new</span> Thread(r, <span class="string">"AsyncTask #"</span> + mCount.getAndIncrement());</div><div class="line">       &#125;</div><div class="line">   &#125;;</div><div class="line"></div><div class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; sPoolWorkQueue =</div><div class="line">           <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;(<span class="number">128</span>);</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line">    * An &#123;<span class="doctag">@link</span> Executor&#125; that can be used to execute tasks in parallel.</div><div class="line">    */</div><div class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Executor THREAD_POOL_EXECUTOR;</div><div class="line"></div><div class="line">   <span class="keyword">static</span> &#123;</div><div class="line">       ThreadPoolExecutor threadPoolExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</div><div class="line">               CORE_POOL_SIZE, MAXIMUM_POOL_SIZE, KEEP_ALIVE_SECONDS, TimeUnit.SECONDS,</div><div class="line">               sPoolWorkQueue, sThreadFactory);</div><div class="line">       threadPoolExecutor.allowCoreThreadTimeOut(<span class="keyword">true</span>);</div><div class="line">       THREAD_POOL_EXECUTOR = threadPoolExecutor;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>这里的 <em>THREAD_POOL_EXECUTOR</em> 就是一个线程池的常用实现,这里就不展开了.<br>这里需要说明的是这个 <em>THREAD_POOL_EXECUTOR</em> 存在的意义,通过上面代码我们可以看到asyncTask的任务是顺序执行的,也就是说你有再多的任务也是一个一个的执行的.<br>那这样可能对需求会有影响,所以在 <em>executeOnExecutor</em> 方法中可以看到,我们是可以传入其他的线程池的,这样就可以同时执行很多任务了,而 <em>THREAD_POOL_EXECUTOR</em> 就相当于一个预置的多任务线程池,如果有这种需求,你可以直接把 <em>THREAD_POOL_EXECUTOR</em> 传给 <em>executeOnExecutor</em> 方法,这样就可以让任务同步执行了.</p>
<p>在android2.3之前,AsyncTask使用就是 <em>THREAD_POOL_EXECUTOR</em> 这种线程池模式,不过由于它最对支持128个任务容量,如果超过容量之后就会报错,同时在创建任务的过程中可能会导致ANR,所以从3.0之后就改成现在这种的串行执行的线程池方式了.这个点是要注意的.</p>
<p>如果有大量的异步任务需要执行的,不推荐使用的AsyncTask,毕竟它本身不适合重要大任务量的处理,这个时候应该自己是实现线程池来完成相关的需求.</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a href="http://blog.csdn.net/lmj623565791/article/details/38614699" title="Android AsyncTask 源码解析" target="_blank" rel="external"> Android AsyncTask 源码解析</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://pheobusyy.github.io/2017/01/16/2017/android ButterKnife源码解析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanyi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pheobusyy">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/16/2017/android ButterKnife源码解析/" itemprop="url">
                  android ButterKnife源码解析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-16T08:56:00+08:00">
                2017-01-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="android-ButterKnife源码解析"><a href="#android-ButterKnife源码解析" class="headerlink" title="android ButterKnife源码解析"></a>android ButterKnife源码解析</h2><h3 id="ButterKnife基本原理"><a href="#ButterKnife基本原理" class="headerlink" title="ButterKnife基本原理"></a>ButterKnife基本原理</h3><p>通过初次查看代码结构,发现原理大致和EventBus相同,通过定义不同的注解,然后通过注解分析器来生成新的源文件代码,在里面完成view的初始化和事件绑定,最后通过 <em>ButterKnife.bind</em> 方法来反射调用生成的新的源文件的中的初始化方法,来完成view的初始化和时间绑定.</p>
<p>可以这样理解,实际上以前是把findViewById等语句放在一个方法里面了,而这个方法在onCreate里面调用.现在是onCreate里面调用了 <em>ButterKnif.bind</em> 方法,里面还是findViewById那一套,只不过是通过注解分析器提前生成了源代码,里面是findViewById那些相关的声明语句.</p>
<p>注意,通过注解预编译这种方式可以达到在编译阶段来完成view的初始化和事件绑定,相对于反射是基本上没有性能消耗,所以是值得提倡的一种的技术方式.包括之前研究的Router也是通过这种方式来达到模块之间的相互调用的功能的.</p>
<h3 id="ButterKnife源代码分析"><a href="#ButterKnife源代码分析" class="headerlink" title="ButterKnife源代码分析"></a>ButterKnife源代码分析</h3><h4 id="ButterKnife的Bind方法调用"><a href="#ButterKnife的Bind方法调用" class="headerlink" title="ButterKnife的Bind方法调用"></a>ButterKnife的Bind方法调用</h4><p>先从ButterKnife的入口来分析,比如在Activity中我们调用 <em>ButterKnife.bind(this)</em> 方法,来看其内部实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@NonNull</span> <span class="meta">@UiThread</span></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Unbinder <span class="title">bind</span><span class="params">(@NonNull Activity target)</span> </span>&#123;</div><div class="line">   View sourceView = target.getWindow().getDecorView();</div><div class="line">   <span class="keyword">return</span> createBinding(target, sourceView);</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>这里获取到的是顶层DecorView,target是activity对象本身,然后交给 <em>createBinding</em> 方法.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Unbinder <span class="title">createBinding</span><span class="params">(@NonNull Object target, @NonNull View source)</span> </span>&#123;</div><div class="line">   Class&lt;?&gt; targetClass = target.getClass();</div><div class="line">   <span class="keyword">if</span> (debug) Log.d(TAG, <span class="string">"Looking up binding for "</span> + targetClass.getName());</div><div class="line">   Constructor&lt;? extends Unbinder&gt; constructor = findBindingConstructorForClass(targetClass);</div><div class="line"></div><div class="line">   <span class="keyword">if</span> (constructor == <span class="keyword">null</span>) &#123;</div><div class="line">     <span class="keyword">return</span> Unbinder.EMPTY;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">//noinspection TryWithIdenticalCatches Resolves to API 19+ only type.</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">     <span class="keyword">return</span> constructor.newInstance(target, source);</div><div class="line">   &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</div><div class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unable to invoke "</span> + constructor, e);</div><div class="line">   &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</div><div class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unable to invoke "</span> + constructor, e);</div><div class="line">   &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</div><div class="line">     Throwable cause = e.getCause();</div><div class="line">     <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> RuntimeException) &#123;</div><div class="line">       <span class="keyword">throw</span> (RuntimeException) cause;</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> Error) &#123;</div><div class="line">       <span class="keyword">throw</span> (Error) cause;</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unable to create binding instance."</span>, cause);</div><div class="line">   &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>这里可以看到 根据类名称来通过 <em>findBindingConstructorForClass</em> 查找该类具有两个参数的构造函数.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Nullable</span> <span class="meta">@CheckResult</span> <span class="meta">@UiThread</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> Constructor&lt;? extends Unbinder&gt; findBindingConstructorForClass(Class&lt;?&gt; cls) &#123;</div><div class="line">    Constructor&lt;? extends Unbinder&gt; bindingCtor = BINDINGS.get(cls);</div><div class="line">    <span class="keyword">if</span> (bindingCtor != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">if</span> (debug) Log.d(TAG, <span class="string">"HIT: Cached in binding map."</span>);</div><div class="line">      <span class="keyword">return</span> bindingCtor;</div><div class="line">    &#125;</div><div class="line">    String clsName = cls.getName();</div><div class="line">    <span class="keyword">if</span> (clsName.startsWith(<span class="string">"android."</span>) || clsName.startsWith(<span class="string">"java."</span>)) &#123;</div><div class="line">      <span class="keyword">if</span> (debug) Log.d(TAG, <span class="string">"MISS: Reached framework class. Abandoning search."</span>);</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      Class&lt;?&gt; bindingClass = Class.forName(clsName + <span class="string">"_ViewBinding"</span>);</div><div class="line">      <span class="comment">//noinspection unchecked</span></div><div class="line">      bindingCtor = (Constructor&lt;? extends Unbinder&gt;) bindingClass.getConstructor(cls, View.class);</div><div class="line">      <span class="keyword">if</span> (debug) Log.d(TAG, <span class="string">"HIT: Loaded binding class and constructor."</span>);</div><div class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">      <span class="keyword">if</span> (debug) Log.d(TAG, <span class="string">"Not found. Trying superclass "</span> + cls.getSuperclass().getName());</div><div class="line">      bindingCtor = findBindingConstructorForClass(cls.getSuperclass());</div><div class="line">    &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unable to find binding constructor for "</span> + clsName, e);</div><div class="line">    &#125;</div><div class="line">    BINDINGS.put(cls, bindingCtor);</div><div class="line">    <span class="keyword">return</span> bindingCtor;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@VisibleForTesting</span></div><div class="line"> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, Constructor&lt;? extends Unbinder&gt;&gt; BINDINGS = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</div></pre></td></tr></table></figure>
<p>这里 BINDINGS 是一个LinkedHashMap,存放的是类对象和它的构造函数对应关系.相当于一个缓存的作用,注意这里找的class对象是获取activity的类名称再加上 <em>_ViewBinding</em> 后缀.当使用ButterKnife编译完成之后,我们可以在我们工程中的build目录中找到 这些中间类.比如 你的activity名称叫做 “MainActivity”,那么生成的<br>中间类就叫做 “MainActivity_ViewBinding”.可以查看下里面的代码.就像这样:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleActivity_ViewBinding</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">SimpleActivity</span>&gt; <span class="keyword">implements</span> <span class="title">Unbinder</span> </span>&#123;</div><div class="line">  <span class="keyword">protected</span> T target;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> View view2130968578;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> View view2130968579;</div><div class="line"></div><div class="line">  <span class="meta">@UiThread</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">SimpleActivity_ViewBinding</span><span class="params">(<span class="keyword">final</span> T target, View source)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.target = target;</div><div class="line"></div><div class="line">    View view;</div><div class="line">    target.title = Utils.findRequiredViewAsType(source, R.id.title, <span class="string">"field 'title'"</span>, TextView.class);</div><div class="line">    target.subtitle = Utils.findRequiredViewAsType(source, R.id.subtitle, <span class="string">"field 'subtitle'"</span>, TextView.class);</div><div class="line">    view = Utils.findRequiredView(source, R.id.hello, <span class="string">"field 'hello', method 'sayHello', and method 'sayGetOffMe'"</span>);</div><div class="line">    target.hello = Utils.castView(view, R.id.hello, <span class="string">"field 'hello'"</span>, Button.class);</div><div class="line">    view2130968578 = view;</div><div class="line">    view.setOnClickListener(<span class="keyword">new</span> DebouncingOnClickListener() &#123;</div><div class="line">      <span class="meta">@Override</span></div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doClick</span><span class="params">(View p0)</span> </span>&#123;</div><div class="line">        target.sayHello();</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">    view.setOnLongClickListener(<span class="keyword">new</span> View.OnLongClickListener() &#123;</div><div class="line">      <span class="meta">@Override</span></div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onLongClick</span><span class="params">(View p0)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> target.sayGetOffMe();</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">    view = Utils.findRequiredView(source, R.id.list_of_things, <span class="string">"field 'listOfThings' and method 'onItemClick'"</span>);</div><div class="line">    target.listOfThings = Utils.castView(view, R.id.list_of_things, <span class="string">"field 'listOfThings'"</span>, ListView.class);</div><div class="line">    view2130968579 = view;</div><div class="line">    ((AdapterView&lt;?&gt;) view).setOnItemClickListener(<span class="keyword">new</span> AdapterView.OnItemClickListener() &#123;</div><div class="line">      <span class="meta">@Override</span></div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemClick</span><span class="params">(AdapterView&lt;?&gt; p0, View p1, <span class="keyword">int</span> p2, <span class="keyword">long</span> p3)</span> </span>&#123;</div><div class="line">        target.onItemClick(p2);</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">    target.footer = Utils.findRequiredViewAsType(source, R.id.footer, <span class="string">"field 'footer'"</span>, TextView.class);</div><div class="line">    target.headerViews = Utils.listOf(</div><div class="line">        Utils.findRequiredView(source, R.id.title, <span class="string">"field 'headerViews'"</span>),</div><div class="line">        Utils.findRequiredView(source, R.id.subtitle, <span class="string">"field 'headerViews'"</span>),</div><div class="line">        Utils.findRequiredView(source, R.id.hello, <span class="string">"field 'headerViews'"</span>));</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="meta">@CallSuper</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unbind</span><span class="params">()</span> </span>&#123;</div><div class="line">    T target = <span class="keyword">this</span>.target;</div><div class="line">    <span class="keyword">if</span> (target == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Bindings already cleared."</span>);</div><div class="line"></div><div class="line">    target.title = <span class="keyword">null</span>;</div><div class="line">    target.subtitle = <span class="keyword">null</span>;</div><div class="line">    target.hello = <span class="keyword">null</span>;</div><div class="line">    target.listOfThings = <span class="keyword">null</span>;</div><div class="line">    target.footer = <span class="keyword">null</span>;</div><div class="line">    target.headerViews = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    view2130968578.setOnClickListener(<span class="keyword">null</span>);</div><div class="line">    view2130968578.setOnLongClickListener(<span class="keyword">null</span>);</div><div class="line">    view2130968578 = <span class="keyword">null</span>;</div><div class="line">    ((AdapterView&lt;?&gt;) view2130968579).setOnItemClickListener(<span class="keyword">null</span>);</div><div class="line">    view2130968579 = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="keyword">this</span>.target = <span class="keyword">null</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个java类是通过注解解析器完成通过代码来生成的.可以看到里面就是一些view的初始化和事件绑定.唯一要注意的一点是,这里的中间类都是实现了unBinder接口,实现了unBind方法,里面是对view和各种事件的回收.主要是用在 <em>fragment</em> 中的使用的,看下ButterKnife的说明会看到,在 fragment使用完成之后必须调用 <em>ViewBinder.unBinder</em> 方法来完成view的回收.<br>下面的代码来着ButterKnife的说明:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">BINDING RESET</div><div class="line"></div><div class="line">Fragments have a different view lifecycle than activities. When binding a fragment in onCreateView, set the views to <span class="keyword">null</span> in onDestroyView. Butter Knife returns an Unbinder instance when you call bind to <span class="keyword">do</span> <span class="keyword">this</span> <span class="keyword">for</span> you. Call its unbind method in the appropriate lifecycle callback.</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FancyFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> </span>&#123;</div><div class="line">  <span class="meta">@BindView</span>(R.id.button1) Button button1;</div><div class="line">  <span class="meta">@BindView</span>(R.id.button2) Button button2;</div><div class="line">  <span class="keyword">private</span> Unbinder unbinder;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">    View view = inflater.inflate(R.layout.fancy_fragment, container, <span class="keyword">false</span>);</div><div class="line">    unbinder = ButterKnife.bind(<span class="keyword">this</span>, view);</div><div class="line">    <span class="comment">// TODO Use fields...</span></div><div class="line">    <span class="keyword">return</span> view;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroyView</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onDestroyView();</div><div class="line">    unbinder.unbind();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="注解分析器AnnotationProcessor的逻辑分析"><a href="#注解分析器AnnotationProcessor的逻辑分析" class="headerlink" title="注解分析器AnnotationProcessor的逻辑分析"></a>注解分析器AnnotationProcessor的逻辑分析</h4><p>核心点就在 <em>ButterKnifeProcessor</em> 里面.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getSupportedAnnotationTypes</span><span class="params">()</span> </span>&#123;</div><div class="line">    Set&lt;String&gt; types = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</div><div class="line">    <span class="keyword">for</span> (Class&lt;? extends Annotation&gt; annotation : getSupportedAnnotations()) &#123;</div><div class="line">      types.add(annotation.getCanonicalName());</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> types;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> Set&lt;Class&lt;? extends Annotation&gt;&gt; getSupportedAnnotations() &#123;</div><div class="line">    Set&lt;Class&lt;? extends Annotation&gt;&gt; annotations = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</div><div class="line"></div><div class="line">    annotations.add(BindArray.class);</div><div class="line">    annotations.add(BindBitmap.class);</div><div class="line">    annotations.add(BindBool.class);</div><div class="line">    annotations.add(BindColor.class);</div><div class="line">    annotations.add(BindDimen.class);</div><div class="line">    annotations.add(BindDrawable.class);</div><div class="line">    annotations.add(BindFloat.class);</div><div class="line">    annotations.add(BindInt.class);</div><div class="line">    annotations.add(BindString.class);</div><div class="line">    annotations.add(BindView.class);</div><div class="line">    annotations.add(BindViews.class);</div><div class="line">    annotations.addAll(LISTENERS);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> annotations;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;Class&lt;? extends Annotation&gt;&gt; LISTENERS = Arrays.asList(<span class="comment">//</span></div><div class="line">       OnCheckedChanged.class, <span class="comment">//</span></div><div class="line">       OnClick.class, <span class="comment">//</span></div><div class="line">       OnEditorAction.class, <span class="comment">//</span></div><div class="line">       OnFocusChange.class, <span class="comment">//</span></div><div class="line">       OnItemClick.class, <span class="comment">//</span></div><div class="line">       OnItemLongClick.class, <span class="comment">//</span></div><div class="line">       OnItemSelected.class, <span class="comment">//</span></div><div class="line">       OnLongClick.class, <span class="comment">//</span></div><div class="line">       OnPageChange.class, <span class="comment">//</span></div><div class="line">       OnTextChanged.class, <span class="comment">//</span></div><div class="line">       OnTouch.class <span class="comment">//</span></div><div class="line">   );</div></pre></td></tr></table></figure></p>
<p>可以通过 <em>getSupportedAnnotationTypes</em> 方法看到都支持哪些注解的处理.<br>重点的处理方法就在 <em>process</em> 方法中:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; elements, RoundEnvironment env)</span> </span>&#123;</div><div class="line">   Map&lt;TypeElement, BindingSet&gt; bindingMap = findAndParseTargets(env);</div><div class="line"></div><div class="line">   <span class="keyword">for</span> (Map.Entry&lt;TypeElement, BindingSet&gt; entry : bindingMap.entrySet()) &#123;</div><div class="line">     TypeElement typeElement = entry.getKey();</div><div class="line">     BindingSet binding = entry.getValue();</div><div class="line"></div><div class="line">     JavaFile javaFile = binding.brewJava(sdk);</div><div class="line">     <span class="keyword">try</span> &#123;</div><div class="line">       javaFile.writeTo(filer);</div><div class="line">     &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">       error(typeElement, <span class="string">"Unable to write binding for type %s: %s"</span>, typeElement, e.getMessage());</div><div class="line">     &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>可以看到第一行就是通过遍历扫描来找到对应类的所有 <em>ButterKnife</em> 注解,然后一次性来生成每个类的新的源文件类.</p>
<p>下面来看 <em>findAndParseTargets</em> 方法.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Map&lt;TypeElement, BindingSet&gt; <span class="title">findAndParseTargets</span><span class="params">(RoundEnvironment env)</span> </span>&#123;</div><div class="line">    Map&lt;TypeElement, BindingSet.Builder&gt; builderMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</div><div class="line">    Set&lt;TypeElement&gt; erasedTargetNames = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</div><div class="line"></div><div class="line">    scanForRClasses(env);</div><div class="line"></div><div class="line">    <span class="comment">// Process each @BindArray element.</span></div><div class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindArray.class)) &#123;</div><div class="line">      <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        parseResourceArray(element, builderMap, erasedTargetNames);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logParsingError(element, BindArray.class, e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Process each @BindBitmap element.</span></div><div class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindBitmap.class)) &#123;</div><div class="line">      <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        parseResourceBitmap(element, builderMap, erasedTargetNames);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logParsingError(element, BindBitmap.class, e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Process each @BindBool element.</span></div><div class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindBool.class)) &#123;</div><div class="line">      <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        parseResourceBool(element, builderMap, erasedTargetNames);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logParsingError(element, BindBool.class, e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Process each @BindColor element.</span></div><div class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindColor.class)) &#123;</div><div class="line">      <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        parseResourceColor(element, builderMap, erasedTargetNames);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logParsingError(element, BindColor.class, e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Process each @BindDimen element.</span></div><div class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindDimen.class)) &#123;</div><div class="line">      <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        parseResourceDimen(element, builderMap, erasedTargetNames);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logParsingError(element, BindDimen.class, e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Process each @BindDrawable element.</span></div><div class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindDrawable.class)) &#123;</div><div class="line">      <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        parseResourceDrawable(element, builderMap, erasedTargetNames);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logParsingError(element, BindDrawable.class, e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Process each @BindFloat element.</span></div><div class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindFloat.class)) &#123;</div><div class="line">      <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        parseResourceFloat(element, builderMap, erasedTargetNames);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logParsingError(element, BindFloat.class, e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Process each @BindInt element.</span></div><div class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindInt.class)) &#123;</div><div class="line">      <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        parseResourceInt(element, builderMap, erasedTargetNames);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logParsingError(element, BindInt.class, e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Process each @BindString element.</span></div><div class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindString.class)) &#123;</div><div class="line">      <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        parseResourceString(element, builderMap, erasedTargetNames);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logParsingError(element, BindString.class, e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Process each @BindView element.</span></div><div class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindView.class)) &#123;</div><div class="line">      <span class="comment">// we don't SuperficialValidation.validateElement(element)</span></div><div class="line">      <span class="comment">// so that an unresolved View type can be generated by later processing rounds</span></div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        parseBindView(element, builderMap, erasedTargetNames);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logParsingError(element, BindView.class, e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Process each @BindViews element.</span></div><div class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindViews.class)) &#123;</div><div class="line">      <span class="comment">// we don't SuperficialValidation.validateElement(element)</span></div><div class="line">      <span class="comment">// so that an unresolved View type can be generated by later processing rounds</span></div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        parseBindViews(element, builderMap, erasedTargetNames);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logParsingError(element, BindViews.class, e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Process each annotation that corresponds to a listener.</span></div><div class="line">    <span class="keyword">for</span> (Class&lt;? extends Annotation&gt; listener : LISTENERS) &#123;</div><div class="line">      findAndParseListener(env, listener, builderMap, erasedTargetNames);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Associate superclass binders with their subclass binders. This is a queue-based tree walk</span></div><div class="line">    <span class="comment">// which starts at the roots (superclasses) and walks to the leafs (subclasses).</span></div><div class="line">    Deque&lt;Map.Entry&lt;TypeElement, BindingSet.Builder&gt;&gt; entries =</div><div class="line">        <span class="keyword">new</span> ArrayDeque&lt;&gt;(builderMap.entrySet());</div><div class="line">    Map&lt;TypeElement, BindingSet&gt; bindingMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</div><div class="line">    <span class="keyword">while</span> (!entries.isEmpty()) &#123;</div><div class="line">      Map.Entry&lt;TypeElement, BindingSet.Builder&gt; entry = entries.removeFirst();</div><div class="line"></div><div class="line">      TypeElement type = entry.getKey();</div><div class="line">      BindingSet.Builder builder = entry.getValue();</div><div class="line"></div><div class="line">      TypeElement parentType = findParentType(type, erasedTargetNames);</div><div class="line">      <span class="keyword">if</span> (parentType == <span class="keyword">null</span>) &#123;</div><div class="line">        bindingMap.put(type, builder.build());</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        BindingSet parentBinding = bindingMap.get(parentType);</div><div class="line">        <span class="keyword">if</span> (parentBinding != <span class="keyword">null</span>) &#123;</div><div class="line">          builder.setParent(parentBinding);</div><div class="line">          bindingMap.put(type, builder.build());</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          <span class="comment">// Has a superclass binding but we haven't built it yet. Re-enqueue for later.</span></div><div class="line">          entries.addLast(entry);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> bindingMap;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>这个 <em>findAndParseTargets</em> 方法看着很长,实际上分成了3部分,顶部是用来生成id和view的对应关系,中间是各种注解的处理后放入builderMap中,第三部分是遍历builderMap来生成BindingMap的.<br>先看如何生成ID的对应关系:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">scanForRClasses(env);</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scanForRClasses</span><span class="params">(RoundEnvironment env)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (trees == <span class="keyword">null</span>) <span class="keyword">return</span>;</div><div class="line"></div><div class="line">   RClassScanner scanner = <span class="keyword">new</span> RClassScanner();</div><div class="line"></div><div class="line">   <span class="keyword">for</span> (Class&lt;? extends Annotation&gt; annotation : getSupportedAnnotations()) &#123;</div><div class="line">     <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(annotation)) &#123;</div><div class="line">       JCTree tree = (JCTree) trees.getTree(element, getMirror(element, annotation));</div><div class="line">       <span class="keyword">if</span> (tree != <span class="keyword">null</span>) &#123; <span class="comment">// tree can be null if the references are compiled types and not source</span></div><div class="line">         tree.accept(scanner);</div><div class="line">       &#125;</div><div class="line">     &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">for</span> (String rClass : scanner.getRClasses()) &#123;</div><div class="line">     parseRClass(rClass);</div><div class="line">   &#125;</div><div class="line"> &#125;</div><div class="line"></div><div class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseRClass</span><span class="params">(String rClass)</span> </span>&#123;</div><div class="line">   Element element;</div><div class="line"></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">     element = elementUtils.getTypeElement(rClass);</div><div class="line">   &#125; <span class="keyword">catch</span> (MirroredTypeException mte) &#123;</div><div class="line">     element = typeUtils.asElement(mte.getTypeMirror());</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   JCTree tree = (JCTree) trees.getTree(element);</div><div class="line">   <span class="keyword">if</span> (tree != <span class="keyword">null</span>) &#123; <span class="comment">// tree can be null if the references are compiled types and not source</span></div><div class="line">     IdScanner idScanner =</div><div class="line">         <span class="keyword">new</span> IdScanner(symbols, elementUtils.getPackageOf(element).getQualifiedName().toString());</div><div class="line">     tree.accept(idScanner);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">     parseCompiledR((TypeElement) element);</div><div class="line">   &#125;</div><div class="line"> &#125;</div><div class="line"></div><div class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseCompiledR</span><span class="params">(TypeElement rClass)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (Element element : rClass.getEnclosedElements()) &#123;</div><div class="line">     String innerClassName = element.getSimpleName().toString();</div><div class="line">     <span class="keyword">if</span> (SUPPORTED_TYPES.contains(innerClassName)) &#123;</div><div class="line">       <span class="keyword">for</span> (Element enclosedElement : element.getEnclosedElements()) &#123;</div><div class="line">         <span class="keyword">if</span> (enclosedElement <span class="keyword">instanceof</span> VariableElement) &#123;</div><div class="line">           VariableElement variableElement = (VariableElement) enclosedElement;</div><div class="line">           Object value = variableElement.getConstantValue();</div><div class="line"></div><div class="line">           <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Integer) &#123;</div><div class="line">             <span class="keyword">int</span> id = (Integer) value;</div><div class="line">             ClassName rClassName =</div><div class="line">                 ClassName.get(elementUtils.getPackageOf(variableElement).toString(), <span class="string">"R"</span>,</div><div class="line">                     innerClassName);</div><div class="line">             String resourceName = variableElement.getSimpleName().toString();</div><div class="line">             symbols.put(id, <span class="keyword">new</span> Id(id, rClassName, resourceName));</div><div class="line">           &#125;</div><div class="line">         &#125;</div><div class="line">       &#125;</div><div class="line">     &#125;</div><div class="line">   &#125;</div><div class="line"> &#125;</div><div class="line"></div><div class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">RClassScanner</span> <span class="keyword">extends</span> <span class="title">TreeScanner</span> </span>&#123;</div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; rClasses = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</div><div class="line"></div><div class="line">   <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitSelect</span><span class="params">(JCTree.JCFieldAccess jcFieldAccess)</span> </span>&#123;</div><div class="line">     Symbol symbol = jcFieldAccess.sym;</div><div class="line">     <span class="keyword">if</span> (symbol != <span class="keyword">null</span></div><div class="line">         &amp;&amp; symbol.getEnclosingElement() != <span class="keyword">null</span></div><div class="line">         &amp;&amp; symbol.getEnclosingElement().getEnclosingElement() != <span class="keyword">null</span></div><div class="line">         &amp;&amp; symbol.getEnclosingElement().getEnclosingElement().enclClass() != <span class="keyword">null</span>) &#123;</div><div class="line">       rClasses.add(symbol.getEnclosingElement().getEnclosingElement().enclClass().className());</div><div class="line">     &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="function">Set&lt;String&gt; <span class="title">getRClasses</span><span class="params">()</span> </span>&#123;</div><div class="line">     <span class="keyword">return</span> rClasses;</div><div class="line">   &#125;</div><div class="line"> &#125;</div><div class="line"></div><div class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">IdScanner</span> <span class="keyword">extends</span> <span class="title">TreeScanner</span> </span>&#123;</div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Integer, Id&gt; ids;</div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> String packageName;</div><div class="line"></div><div class="line">   IdScanner(Map&lt;Integer, Id&gt; ids, String packageName) &#123;</div><div class="line">     <span class="keyword">this</span>.ids = ids;</div><div class="line">     <span class="keyword">this</span>.packageName = packageName;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitClassDef</span><span class="params">(JCTree.JCClassDecl jcClassDecl)</span> </span>&#123;</div><div class="line">     <span class="keyword">for</span> (JCTree tree : jcClassDecl.defs) &#123;</div><div class="line">       <span class="keyword">if</span> (tree <span class="keyword">instanceof</span> ClassTree) &#123;</div><div class="line">         ClassTree classTree = (ClassTree) tree;</div><div class="line">         String className = classTree.getSimpleName().toString();</div><div class="line">         <span class="keyword">if</span> (SUPPORTED_TYPES.contains(className)) &#123;</div><div class="line">           ClassName rClassName = ClassName.get(packageName, <span class="string">"R"</span>, className);</div><div class="line">           VarScanner scanner = <span class="keyword">new</span> VarScanner(ids, rClassName);</div><div class="line">           ((JCTree) classTree).accept(scanner);</div><div class="line">         &#125;</div><div class="line">       &#125;</div><div class="line">     &#125;</div><div class="line">   &#125;</div><div class="line"> &#125;</div><div class="line"></div><div class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">VarScanner</span> <span class="keyword">extends</span> <span class="title">TreeScanner</span> </span>&#123;</div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Integer, Id&gt; ids;</div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> ClassName className;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="title">VarScanner</span><span class="params">(Map&lt;Integer, Id&gt; ids, ClassName className)</span> </span>&#123;</div><div class="line">     <span class="keyword">this</span>.ids = ids;</div><div class="line">     <span class="keyword">this</span>.className = className;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitVarDef</span><span class="params">(JCTree.JCVariableDecl jcVariableDecl)</span> </span>&#123;</div><div class="line">     <span class="keyword">if</span> (<span class="string">"int"</span>.equals(jcVariableDecl.getType().toString())) &#123;</div><div class="line">       <span class="keyword">int</span> id = Integer.valueOf(jcVariableDecl.getInitializer().toString());</div><div class="line">       String resourceName = jcVariableDecl.getName().toString();</div><div class="line">       ids.put(id, <span class="keyword">new</span> Id(id, className, resourceName));</div><div class="line">     &#125;</div><div class="line">   &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>这里,如何关于如何生成这个对应关系的里面用到一些api我不是很了解,网上的资料也很少,后续等到研究明白了再补充吧,只是通过字面理解应该是通过遍历java的语法分析树找到R文件中对应的filed的ID,组合成一个 <em>Id</em> .<br>中间的部分就是用来做生成builderMap的,我们挑其中的一个方法来看,大部分的方法都是类似的.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseBindView</span><span class="params">(Element element, Map&lt;TypeElement, BindingSet.Builder&gt; builderMap,</span></span></div><div class="line">                              Set&lt;TypeElement&gt; erasedTargetNames) &#123;</div><div class="line">       TypeElement enclosingElement = (TypeElement) element.getEnclosingElement();</div><div class="line"></div><div class="line">       <span class="comment">// Start by verifying common generated code restrictions.</span></div><div class="line">       <span class="keyword">boolean</span> hasError = isInaccessibleViaGeneratedCode(BindView.class, <span class="string">"fields"</span>, element)</div><div class="line">               || isBindingInWrongPackage(BindView.class, element);</div><div class="line"></div><div class="line">       <span class="comment">// Verify that the target type extends from View.</span></div><div class="line">       TypeMirror elementType = element.asType();</div><div class="line">       <span class="keyword">if</span> (elementType.getKind() == TypeKind.TYPEVAR) &#123;</div><div class="line">           TypeVariable typeVariable = (TypeVariable) elementType;</div><div class="line">           elementType = typeVariable.getUpperBound();</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (!isSubtypeOfType(elementType, VIEW_TYPE) &amp;&amp; !isInterface(elementType)) &#123;</div><div class="line">           <span class="keyword">if</span> (elementType.getKind() == TypeKind.ERROR) &#123;</div><div class="line">               note(element, <span class="string">"@%s field with unresolved type (%s) "</span></div><div class="line">                               + <span class="string">"must elsewhere be generated as a View or interface. (%s.%s)"</span>,</div><div class="line">                       BindView.class.getSimpleName(), elementType, enclosingElement.getQualifiedName(),</div><div class="line">                       element.getSimpleName());</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               error(element, <span class="string">"@%s fields must extend from View or be an interface. (%s.%s)"</span>,</div><div class="line">                       BindView.class.getSimpleName(), enclosingElement.getQualifiedName(),</div><div class="line">                       element.getSimpleName());</div><div class="line">               hasError = <span class="keyword">true</span>;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (hasError) &#123;</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// Assemble information on the field.</span></div><div class="line">       <span class="keyword">int</span> id = element.getAnnotation(BindView.class).value();</div><div class="line"></div><div class="line">       BindingSet.Builder builder = builderMap.get(enclosingElement);</div><div class="line">       <span class="keyword">if</span> (builder != <span class="keyword">null</span>) &#123;</div><div class="line">           String existingBindingName = builder.findExistingBindingName(getId(id));</div><div class="line">           <span class="keyword">if</span> (existingBindingName != <span class="keyword">null</span>) &#123;</div><div class="line">               error(element, <span class="string">"Attempt to use @%s for an already bound ID %d on '%s'. (%s.%s)"</span>,</div><div class="line">                       BindView.class.getSimpleName(), id, existingBindingName,</div><div class="line">                       enclosingElement.getQualifiedName(), element.getSimpleName());</div><div class="line">               <span class="keyword">return</span>;</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           builder = getOrCreateBindingBuilder(builderMap, enclosingElement);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       String name = element.getSimpleName().toString();</div><div class="line">       TypeName type = TypeName.get(elementType);</div><div class="line">       <span class="keyword">boolean</span> required = isFieldRequired(element);</div><div class="line"></div><div class="line">       builder.addField(getId(id), <span class="keyword">new</span> FieldViewBinding(name, type, required));</div><div class="line"></div><div class="line">       <span class="comment">// Add the type-erased version to the valid binding targets set.</span></div><div class="line">       erasedTargetNames.add(enclosingElement);</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>这个方法前半部分用来做ID校验,防止有重复的Id定义出现错误.<br>后半部分生成一个 <em>BindingSet.Builder</em> 对象,这个对象就是用来后续通过 <em>javapoet</em> 来生成制定的java源文件的.builderMap的key是声明注解的类,通常是我们的Activity或者viewHolder.<br>然后把 <em>FieldViewBinding</em> 放入builder中,其中 filed的key就是view本身的ID.</p>
<p><em>findAndParseTargets</em> 的最后一部分是用来生成bindingMap的,key是声明类,value是BindingSet对象.<br>通过中间生成的 <em>builderMap</em> 来完成.主要是用来子类和父类如果同时声明的时把两者合并成一个BindingSet对象.</p>
<p><em>BindingSet</em> 对象就是用来交给javaPoet来生成中间源文件的对象.</p>
<p>生成了BindingMap之后回到顶层的 <em>process</em> 方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (Map.Entry&lt;TypeElement, BindingSet&gt; entry : bindingMap.entrySet()) &#123;</div><div class="line">            TypeElement typeElement = entry.getKey();</div><div class="line">            BindingSet binding = entry.getValue();</div><div class="line"></div><div class="line">            JavaFile javaFile = binding.brewJava(sdk);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                javaFile.writeTo(filer);</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                error(typeElement, <span class="string">"Unable to write binding for type %s: %s"</span>, typeElement, e.getMessage());</div><div class="line">            &#125;</div><div class="line">        &#125;</div></pre></td></tr></table></figure></p>
<p>可以看到这里调用的是 <em>bindingSet</em> 对象的 <em>brewJava</em> 方法来完成java源文件的写入的:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function">JavaFile <span class="title">brewJava</span><span class="params">(<span class="keyword">int</span> sdk)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> JavaFile.builder(bindingClassName.packageName(), createType(sdk))</div><div class="line">      .addFileComment(<span class="string">"Generated code from Butter Knife. Do not modify!"</span>)</div><div class="line">      .build();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后调用 <em>createType</em> 方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> TypeSpec <span class="title">createType</span><span class="params">(<span class="keyword">int</span> sdk)</span> </span>&#123;</div><div class="line">    TypeSpec.Builder result = TypeSpec.classBuilder(bindingClassName.simpleName())</div><div class="line">        .addModifiers(PUBLIC);</div><div class="line">    <span class="keyword">if</span> (isFinal) &#123;</div><div class="line">      result.addModifiers(FINAL);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (parentBinding != <span class="keyword">null</span>) &#123;</div><div class="line">      result.superclass(parentBinding.bindingClassName);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      result.addSuperinterface(UNBINDER);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (hasTargetField()) &#123;</div><div class="line">      result.addField(targetTypeName, <span class="string">"target"</span>, PRIVATE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!constructorNeedsView()) &#123;</div><div class="line">      <span class="comment">// Add a delegating constructor with a target type + view signature for reflective use.</span></div><div class="line">      result.addMethod(createBindingViewDelegateConstructor(targetTypeName));</div><div class="line">    &#125;</div><div class="line">    result.addMethod(createBindingConstructor(targetTypeName, sdk));</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (hasViewBindings() || parentBinding == <span class="keyword">null</span>) &#123;</div><div class="line">      result.addMethod(createBindingUnbindMethod(result, targetTypeName));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> result.build();</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p><em>createType</em> 分为三部分,一部分是createBindingViewDelegateConstructor,一部分是createBindingConstructor,还有一部分是createBindingUnbindMethod<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> MethodSpec <span class="title">createBindingViewDelegateConstructor</span><span class="params">(TypeName targetType)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> MethodSpec.constructorBuilder()</div><div class="line">      .addJavadoc(<span class="string">"@deprecated Use &#123;@link #$T($T, $T)&#125; for direct creation.\n    "</span></div><div class="line">              + <span class="string">"Only present for runtime invocation through &#123;@code ButterKnife.bind()&#125;.\n"</span>,</div><div class="line">          bindingClassName, targetType, CONTEXT)</div><div class="line">      .addAnnotation(Deprecated.class)</div><div class="line">      .addAnnotation(UI_THREAD)</div><div class="line">      .addModifiers(PUBLIC)</div><div class="line">      .addParameter(targetType, <span class="string">"target"</span>)</div><div class="line">      .addParameter(VIEW, <span class="string">"source"</span>)</div><div class="line">      .addStatement((<span class="string">"this(target, source.getContext())"</span>))</div><div class="line">      .build();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个构造函数的作用暂时没有弄明白,看说明好像是用来在运行的时候反射用的.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> MethodSpec <span class="title">createBindingConstructor</span><span class="params">(TypeName targetType, <span class="keyword">int</span> sdk)</span> </span>&#123;</div><div class="line">    MethodSpec.Builder constructor = MethodSpec.constructorBuilder()</div><div class="line">        .addAnnotation(UI_THREAD)</div><div class="line">        .addModifiers(PUBLIC);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (hasMethodBindings()) &#123;</div><div class="line">      constructor.addParameter(targetType, <span class="string">"target"</span>, FINAL);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      constructor.addParameter(targetType, <span class="string">"target"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (constructorNeedsView()) &#123;</div><div class="line">      constructor.addParameter(VIEW, <span class="string">"source"</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      constructor.addParameter(CONTEXT, <span class="string">"context"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (hasUnqualifiedResourceBindings()) &#123;</div><div class="line">      <span class="comment">// Aapt can change IDs out from underneath us, just suppress since all will work at runtime.</span></div><div class="line">      constructor.addAnnotation(AnnotationSpec.builder(SuppressWarnings.class)</div><div class="line">          .addMember(<span class="string">"value"</span>, <span class="string">"$S"</span>, <span class="string">"ResourceType"</span>)</div><div class="line">          .build());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (hasOnTouchMethodBindings()) &#123;</div><div class="line">      constructor.addAnnotation(AnnotationSpec.builder(SUPPRESS_LINT)</div><div class="line">          .addMember(<span class="string">"value"</span>, <span class="string">"$S"</span>, <span class="string">"ClickableViewAccessibility"</span>)</div><div class="line">          .build());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (parentBinding != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">if</span> (parentBinding.constructorNeedsView()) &#123;</div><div class="line">        constructor.addStatement(<span class="string">"super(target, source)"</span>);</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (constructorNeedsView()) &#123;</div><div class="line">        constructor.addStatement(<span class="string">"super(target, source.getContext())"</span>);</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        constructor.addStatement(<span class="string">"super(target, context)"</span>);</div><div class="line">      &#125;</div><div class="line">      constructor.addCode(<span class="string">"\n"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (hasTargetField()) &#123;</div><div class="line">      constructor.addStatement(<span class="string">"this.target = target"</span>);</div><div class="line">      constructor.addCode(<span class="string">"\n"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (hasViewBindings()) &#123;</div><div class="line">      <span class="keyword">if</span> (hasViewLocal()) &#123;</div><div class="line">        <span class="comment">// Local variable in which all views will be temporarily stored.</span></div><div class="line">        constructor.addStatement(<span class="string">"$T view"</span>, VIEW);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">for</span> (ViewBinding binding : viewBindings) &#123;</div><div class="line">        addViewBinding(constructor, binding);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">for</span> (FieldCollectionViewBinding binding : collectionBindings) &#123;</div><div class="line">        constructor.addStatement(<span class="string">"$L"</span>, binding.render());</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (!resourceBindings.isEmpty()) &#123;</div><div class="line">        constructor.addCode(<span class="string">"\n"</span>);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!resourceBindings.isEmpty()) &#123;</div><div class="line">      <span class="keyword">if</span> (constructorNeedsView()) &#123;</div><div class="line">        constructor.addStatement(<span class="string">"$T context = source.getContext()"</span>, CONTEXT);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (hasResourceBindingsNeedingResource(sdk)) &#123;</div><div class="line">        constructor.addStatement(<span class="string">"$T res = context.getResources()"</span>, RESOURCES);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">for</span> (ResourceBinding binding : resourceBindings) &#123;</div><div class="line">        constructor.addStatement(<span class="string">"$L"</span>, binding.render(sdk));</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> constructor.build();</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>这个方法来生成中间类的构造函数,里面定义了view的findViewById和绑定事件,生成的结果在前面已经列出了,就是 <em>javaPoet</em> 的API调用,非常容易理解.</p>
<p>最后是生成filed和unbind方法的 <em>createBindingUnbindMethod</em>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> MethodSpec <span class="title">createBindingUnbindMethod</span><span class="params">(TypeSpec.Builder bindingClass,</span></span></div><div class="line">    TypeName targetType) &#123;</div><div class="line">  MethodSpec.Builder result = MethodSpec.methodBuilder(<span class="string">"unbind"</span>)</div><div class="line">      .addAnnotation(Override.class)</div><div class="line">      .addModifiers(PUBLIC);</div><div class="line">  <span class="keyword">if</span> (!isFinal &amp;&amp; parentBinding == <span class="keyword">null</span>) &#123;</div><div class="line">    result.addAnnotation(CALL_SUPER);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (hasTargetField()) &#123;</div><div class="line">    <span class="keyword">if</span> (hasFieldBindings()) &#123;</div><div class="line">      result.addStatement(<span class="string">"$T target = this.target"</span>, targetType);</div><div class="line">    &#125;</div><div class="line">    result.addStatement(<span class="string">"if (target == null) throw new $T($S)"</span>, IllegalStateException.class,</div><div class="line">        <span class="string">"Bindings already cleared."</span>);</div><div class="line">    result.addStatement(<span class="string">"$N = null"</span>, hasFieldBindings() ? <span class="string">"this.target"</span> : <span class="string">"target"</span>);</div><div class="line">    result.addCode(<span class="string">"\n"</span>);</div><div class="line">    <span class="keyword">for</span> (ViewBinding binding : viewBindings) &#123;</div><div class="line">      <span class="keyword">if</span> (binding.getFieldBinding() != <span class="keyword">null</span>) &#123;</div><div class="line">        result.addStatement(<span class="string">"target.$L = null"</span>, binding.getFieldBinding().getName());</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (FieldCollectionViewBinding binding : collectionBindings) &#123;</div><div class="line">      result.addStatement(<span class="string">"target.$L = null"</span>, binding.name);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (hasMethodBindings()) &#123;</div><div class="line">    result.addCode(<span class="string">"\n"</span>);</div><div class="line">    <span class="keyword">for</span> (ViewBinding binding : viewBindings) &#123;</div><div class="line">      addFieldAndUnbindStatement(bindingClass, result, binding);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (parentBinding != <span class="keyword">null</span>) &#123;</div><div class="line">    result.addCode(<span class="string">"\n"</span>);</div><div class="line">    result.addStatement(<span class="string">"super.unbind()"</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> result.build();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里unBind方法不做过多的解释,主要是来看<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (ViewBinding binding : viewBindings) &#123;</div><div class="line">  addFieldAndUnbindStatement(bindingClass, result, binding);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addFieldAndUnbindStatement</span><span class="params">(TypeSpec.Builder result, MethodSpec.Builder unbindMethod,</span></span></div><div class="line">    ViewBinding bindings) &#123;</div><div class="line">  <span class="comment">// Only add fields to the binding if there are method bindings.</span></div><div class="line">  Map&lt;ListenerClass, Map&lt;ListenerMethod, Set&lt;MethodViewBinding&gt;&gt;&gt; classMethodBindings =</div><div class="line">      bindings.getMethodBindings();</div><div class="line">  <span class="keyword">if</span> (classMethodBindings.isEmpty()) &#123;</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  String fieldName = bindings.isBoundToRoot() ? <span class="string">"viewSource"</span> : <span class="string">"view"</span> + bindings.getId().value;</div><div class="line">  result.addField(VIEW, fieldName, PRIVATE);</div><div class="line"></div><div class="line">  <span class="comment">// We only need to emit the null check if there are zero required bindings.</span></div><div class="line">  <span class="keyword">boolean</span> needsNullChecked = bindings.getRequiredBindings().isEmpty();</div><div class="line">  <span class="keyword">if</span> (needsNullChecked) &#123;</div><div class="line">    unbindMethod.beginControlFlow(<span class="string">"if ($N != null)"</span>, fieldName);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">for</span> (ListenerClass listenerClass : classMethodBindings.keySet()) &#123;</div><div class="line">    <span class="comment">// We need to keep a reference to the listener</span></div><div class="line">    <span class="comment">// in case we need to unbind it via a remove method.</span></div><div class="line">    <span class="keyword">boolean</span> requiresRemoval = !<span class="string">""</span>.equals(listenerClass.remover());</div><div class="line">    String listenerField = <span class="string">"null"</span>;</div><div class="line">    <span class="keyword">if</span> (requiresRemoval) &#123;</div><div class="line">      TypeName listenerClassName = bestGuess(listenerClass.type());</div><div class="line">      listenerField = fieldName + ((ClassName) listenerClassName).simpleName();</div><div class="line">      result.addField(listenerClassName, listenerField, PRIVATE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!VIEW_TYPE.equals(listenerClass.targetType())) &#123;</div><div class="line">      unbindMethod.addStatement(<span class="string">"(($T) $N).$N($N)"</span>, bestGuess(listenerClass.targetType()),</div><div class="line">          fieldName, removerOrSetter(listenerClass, requiresRemoval), listenerField);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      unbindMethod.addStatement(<span class="string">"$N.$N($N)"</span>, fieldName,</div><div class="line">          removerOrSetter(listenerClass, requiresRemoval), listenerField);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (requiresRemoval) &#123;</div><div class="line">      unbindMethod.addStatement(<span class="string">"$N = null"</span>, listenerField);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  unbindMethod.addStatement(<span class="string">"$N = null"</span>, fieldName);</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (needsNullChecked) &#123;</div><div class="line">    unbindMethod.endControlFlow();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个方法用来生成中间类的filed,也就是view和事件的声明.之前在前面找了半天如何生成filed的方法一直没有找到,后来这这里才发现的.<br>声明的view名称是View+ID这种格式.</p>
<p>到这里大概的流程就讲完了,可能还是有些细节没有讲到,不过没有关系,只要明白了大概的运行方式就可以了.可以看到作者的思路非常的新颖就是通过中间类来完成一些初始化工作,这个给我们后续的android的编程中提供了一套可借鉴的思路.</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a href="http://jakewharton.github.io/butterknife/" title="butterKnife document" target="_blank" rel="external">butterKnife document</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://pheobusyy.github.io/2017/01/15/2017/读书笔记/2017-01-15-出奇制胜-在快速变化的世界如何加速成功/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanyi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pheobusyy">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/15/2017/读书笔记/2017-01-15-出奇制胜-在快速变化的世界如何加速成功/" itemprop="url">
                  出奇制胜-在快速变化的世界如何加速成功
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-15T10:47:00+08:00">
                2017-01-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="出奇制胜-在快速变化的世界如何加速成功"><a href="#出奇制胜-在快速变化的世界如何加速成功" class="headerlink" title="出奇制胜-在快速变化的世界如何加速成功"></a>出奇制胜-在快速变化的世界如何加速成功</h2><h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h3><p>缩短行程，善于借力，一飞冲天</p>
<p>借力是超级成功人士运用自己的已知资源获得最大回报的秘诀所在。</p>
<p>好运和才华是成功的两大要素，但像任何配方一样，他们都可以通过精心的设计为其他因素所代替。然而我发现，一个不可替代的要素就是“肯干”。</p>
<p>最佳的成功之路-无论你如何定义它-一定每天都在变化。</p>
<h3 id="换梯术"><a href="#换梯术" class="headerlink" title="换梯术"></a>换梯术</h3><p>串注：累加性质的系列投注，每次赌博获胜的奖金都作为下一次赌注的投注额。</p>
<p>越快越好，积小胜为大胜</p>
<p>横向交易：更大或更好</p>
<h3 id="师傅领进门"><a href="#师傅领进门" class="headerlink" title="师傅领进门"></a>师傅领进门</h3><p>与师傅或者导师培养出良好的人际关系，成为毕生的挚友</p>
<h3 id="快速反馈"><a href="#快速反馈" class="headerlink" title="快速反馈"></a>快速反馈</h3><p>奥斯卡.王尔德说过：“经验是每个人给自己的错误起的名字”。</p>
<p>“分析自己的败因时，个人往往从外界找理由，单挑那些他们直接控制不了的因素说事儿，比如运气，其结果是，他们以后在同一任务上继续努力的动力收到了削弱。”</p>
<p>“即使一个人失败的经验可能包含有价值的只是，但如果以后不对这一经验进行反思，学习的潜力仍将无从发挥。”</p>
<p>专家，反而普通推崇消极反馈而不是积极反馈。消极反馈能够刺激人们进行最大限度的改进，这是因为批评通常比赞美更具有可操作性。</p>
<p>关于消极反馈比较难办的部分是如何保护自己不受预知失败的打击，把我们的经验转化为客观的实验。而当我们这样做时，反馈的作用就会变得更加强大。</p>
<p>第二城市设法做到三件事，以加快其演员的成长：</p>
<ol>
<li>提供快速反馈</li>
<li>使反馈对事不对人</li>
<li>降低代价和压力</li>
</ol>
<h3 id="利用平台"><a href="#利用平台" class="headerlink" title="利用平台"></a>利用平台</h3><p>DHH的“选择性偷懒”：“我的计划是，假设别人得A花的时间为100%，如果我用5%的时间就能得C-，那就很牛了。这样当然够及格了，对吧,然后我就把剩下的95%的时间用来去做我一些真正愿意干的事”</p>
<p>平台的形式可以是工具，也可以是技术，可以使游戏，轮胎，计算器，更可以是职业赛车联盟或高标准学校提供的环境。无论是哪种形式，平台都发挥了功效增倍的作用，而且能够在人们使用平台的过程中传授给他只是。</p>
<h3 id="抓住浪潮"><a href="#抓住浪潮" class="headerlink" title="抓住浪潮"></a>抓住浪潮</h3><p>所谓运气，就是“在正确的时间出现在正确的地方”。但是，有些人-以及公司-却像冲浪运动员一样，善于让自己在正确的时间出现在正确的地方。他们寻找机会，而不是等待机会。</p>
<p>无论是哪个行业，情况都是一样的。行业先驱者沉浸在早期的技术和实践中不能自拔，最后被尾随而来的企业后发制人，完成超越。上船容易下船难，一旦成为第一波的弄潮儿，再想全身而退，代价就太大了。</p>
<p>去海边观察，然后下水体验。</p>
<h3 id="超级联系人"><a href="#超级联系人" class="headerlink" title="超级联系人"></a>超级联系人</h3><p>“超连（superconnecting)”的思路，即直接切入具有广泛传播能力的中枢，然后通过它事先大规模的联系。</p>
<h3 id="创造动能"><a href="#创造动能" class="headerlink" title="创造动能"></a>创造动能</h3><p>要想成功驭势而行，就要善于积累潜在的能量，只有这样，才能让不期而遇的机遇功效成倍放大。</p>
<p>成功会在你最意想不到的时候降临到你身上，而你要做的就是让这股势头一直保持下去。</p>
<h3 id="大道至简"><a href="#大道至简" class="headerlink" title="大道至简"></a>大道至简</h3><p>大道至简往往成为从优秀走向卓越的关键。</p>
<p>颠覆性创新产品的主要特点是节约成本（时间或金钱)。但每一种颠覆性产品成功背后的关键因素这是简化。</p>
<p>进行大量微不足道的选择，会让一个人的自我控制能力消耗殆尽。</p>
<h3 id="10被思维"><a href="#10被思维" class="headerlink" title="10被思维"></a>10被思维</h3><p>“尝试做一样新东西或者是更好的东西，做法最终不外乎那么两种情况。一种是小幅变动，不会吓人一跳的版本改进。改变生产模式，如果你愿意的话。从程度上来说，你往往得到的就是10%的改进。但如果想要获得真正的巨大革新，一般来说<br>你就得重新开始，尝试另一种方式或很多种方式。你必须打破一些基本的假设，当然，你不可能未卜先知，只能去摸索，去试。显然，这个时候就得打破常规，违背常理。<br>”</p>
<p>当我们去争取挂在低枝上的果实时，实际上是不太可能把潜力发挥到极致的。部分原因是，在树的底部，竞争比树的顶部更激烈。而大量的竞争不只会降低获胜的概率，而且还会导致表现欠佳。</p>
<p>N效应：在竞争中，仅仅知道会有更多的竞争对说参加，就会降低我们的表现。</p>
<p>人性的本质使我们出乎意料的愿意支持伟大的理想，巨大的改变。这意味着梦想家会赢得更多的客户，更多的投资，以及更多的口碑。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://pheobusyy.github.io/2017/01/13/2017/java class基础知识/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanyi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pheobusyy">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/13/2017/java class基础知识/" itemprop="url">
                  java class基础知识
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-13T15:16:00+08:00">
                2017-01-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="java-Class对象基础知识"><a href="#java-Class对象基础知识" class="headerlink" title="java Class对象基础知识"></a>java Class对象基础知识</h2><p>这里要说的说Class对象指的是在java源文件完成编译之后生成的.class字节码文件,然后通过JVM的classLoader来把字节码文件载入到虚拟机中生成对应的class对象.也就是平时我们通过 A.class 或者 Class.forName(“className”)等方式生成的Class对象.</p>
<h3 id="类加载器ClassLoader"><a href="#类加载器ClassLoader" class="headerlink" title="类加载器ClassLoader"></a>类加载器ClassLoader</h3><p>java默认提供了三个ClassLoader,分别是:</p>
<ol>
<li>BootStrap ClassLoader 是java类加载层次中最顶层的类加载器,负责加载jdk中的核心类库.</li>
<li>Extension ClassLoader 成为扩展类加载器,负责加载java的扩展类库,默认加载JAVA_HOME/jre/lib/ext/目录下的所有jar.</li>
<li>App ClassLoader 称为系统类加载器,负责加载应用程序classPath目录下的所有jar和class文件.</li>
</ol>
<p>除了java提供的三个默认的ClassLoader之外,用户还可以创建自定义的ClassLoader,只要继承自java.lang.ClassLoader就可以了.也包括java提供的另外两个ClassLoader(Extension和App classLoader),但是Bootstrap ClassLoader不继承自ClassLoader,因为它不是一个普通的java类,底层由C++编写,已经嵌入到JVM内核中,当JVM启动后,Bootstrap Loader也随之启动,负责加载完核心类库后,并构造Extension 和App ClassLoader.</p>
<h4 id="类加载器加载类原理"><a href="#类加载器加载类原理" class="headerlink" title="类加载器加载类原理"></a>类加载器加载类原理</h4><p>这里使用了一种叫 <em>双亲委派</em> 的模式来搜索类,每个classLoader对象都有一个父类classLoader对象的引用,每当要加载类的时候,会去父类去找,如果没有找到就去父类的父类去找,一直到顶层的classLoader.如果没有找到,就尝试从顶层开始加载类,如果失败就依次往回返,如果一直都没成功加载,就叫交回到当前的classLoader,直接返回一个 <em>classNotFound</em> 异常.</p>
<p>这里来看下jdk8的ClassLoader源码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="keyword">boolean</span> resolve)</div><div class="line">      <span class="keyword">throws</span> ClassNotFoundException</div><div class="line">  &#123;</div><div class="line">      <span class="keyword">synchronized</span> (getClassLoadingLock(name)) &#123;</div><div class="line">          <span class="comment">// First, check if the class has already been loaded</span></div><div class="line">          Class&lt;?&gt; c = findLoadedClass(name);</div><div class="line">          <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</div><div class="line">              <span class="keyword">long</span> t0 = System.nanoTime();</div><div class="line">              <span class="keyword">try</span> &#123;</div><div class="line">                  <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</div><div class="line">                      c = parent.loadClass(name, <span class="keyword">false</span>);</div><div class="line">                  &#125; <span class="keyword">else</span> &#123;</div><div class="line">                      c = findBootstrapClassOrNull(name);</div><div class="line">                  &#125;</div><div class="line">              &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">                  <span class="comment">// ClassNotFoundException thrown if class not found</span></div><div class="line">                  <span class="comment">// from the non-null parent class loader</span></div><div class="line">              &#125;</div><div class="line"></div><div class="line">              <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</div><div class="line">                  <span class="comment">// If still not found, then invoke findClass in order</span></div><div class="line">                  <span class="comment">// to find the class.</span></div><div class="line">                  <span class="keyword">long</span> t1 = System.nanoTime();</div><div class="line">                  c = findClass(name);</div><div class="line"></div><div class="line">                  <span class="comment">// this is the defining class loader; record the stats</span></div><div class="line">                  sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);</div><div class="line">                  sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);</div><div class="line">                  sun.misc.PerfCounter.getFindClasses().increment();</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">if</span> (resolve) &#123;</div><div class="line">              resolveClass(c);</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">return</span> c;</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>代码非常的清晰,就是从下到上的去找,然后再从上到下的加载.<br><img src="images/2017/01/java classloader加载流程.gif" alt="java classLoader加载顺序"></p>
<h4 id="为什么要使用双亲委派这种模式"><a href="#为什么要使用双亲委派这种模式" class="headerlink" title="为什么要使用双亲委派这种模式?"></a>为什么要使用双亲委派这种模式?</h4><ol>
<li>为了解决重复加载,当父类已经加载过了,子类就没有必要再去加载了.</li>
<li>为了安全性,比如如果我们自己定义了和系统中一样的基础类,这两个类就会引起安全隐患.如果通过双亲委派,就会优先加载系统的原生类.放在核心代码被 “污染”</li>
</ol>
<h4 id="JVM搜索的时候-如何判断两个class对象是否相同"><a href="#JVM搜索的时候-如何判断两个class对象是否相同" class="headerlink" title="JVM搜索的时候,如何判断两个class对象是否相同"></a>JVM搜索的时候,如何判断两个class对象是否相同</h4><p>JVM在判定两个Class是否相同时,不仅要判断两个类名是否相同,而且要判断是否由同一个类加载器加载出来的.只有两者同时满足,JVM才认为这两个Class是相同的.</p>
<h3 id="class对象加载注意点"><a href="#class对象加载注意点" class="headerlink" title="class对象加载注意点"></a>class对象加载注意点</h3><p>所有的类都是在对其第一次使用的时候,动态加载到JVM中的.当程序创建第一个对象的静态成员的引用时,就会加载这个类.<br>这个证明构造器也是类的静态方法,即使在构造器之前并没有static关键字.因此,使用new操作符创建类的新对象也会被当做对类的静态成员的引用.</p>
<h3 id="new-A-getClass-方法"><a href="#new-A-getClass-方法" class="headerlink" title="new A().getClass()方法"></a>new A().getClass()方法</h3><p>Class classA = new A().getClass();<br>class对象提供了一些非常实用的方法,比如getSimpleName用来返回不包含包名的类名称.而getName和getCanonicalName则会返回全限定的类名称<br>还可以通过 newInstance()方法来直接产生类的实例对象,前提是该类有默认的构造函数.<br>最后还有一些是 getInterfaces(),getSupperclass()等等,这里就不展开了.</p>
<h4 id="A-class-字面量"><a href="#A-class-字面量" class="headerlink" title="A.class 字面量"></a>A.class 字面量</h4><p>这里的字面量指的是通过类名加class后缀之后获得了class对象.这个对象有很多特殊的情况需要特别说明一下.</p>
<p>当通过使用 “.class”来创建Class对象的引用时,不会自动 <em>初始化</em> 该Class对象.<br>这里的 <em>初始化</em> 是什么意思呢?并不是说这个Class对象是空的,而生成的Class对象并没有调用Class内部的静态方法或者静态代码块.<br>为了使用类而做的准备工作实际上包含了三个步骤:</p>
<ol>
<li>加载. 这是由前面讲的类加载器执行的.该步骤讲查找字节码(通常在ClassPath所指定的路径下查找,但这并非必须),并从这些字节码中创建一个class对象.</li>
<li>链接. 在链接阶段将验证类中的字节码,为静态域分配存储空间,并且如果必需的话,将解析这个类创建的对其他类的所有引用.</li>
<li>初始化. 如果该类具有超类,则对其初始化,执行静态初始化器和静态代码块.</li>
</ol>
<p>初始化被延迟到了对静态方法 (构造器隐式地是静态的) 或者非常数静态域进行首次引用才执行.<br>下面通过几个例子来说明:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestClass</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException </span>&#123;</div><div class="line">        System.out.println(TestInitable.num);</div><div class="line">        System.out.println(TestInitable2.name);</div><div class="line">        System.out.println(TestInitable2.num);</div><div class="line">        System.out.println(Class.forName(<span class="string">"com.justyan.TestInitable3"</span>));</div><div class="line">        System.out.println(TestInitable4.bean);</div><div class="line">        System.out.println(TestInitable5.num);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestInitable</span></span>&#123;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> num = <span class="number">100</span>;</div><div class="line">    <span class="keyword">static</span>&#123;</div><div class="line">        System.out.println(<span class="string">"TestInitable is init!!!!"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestInitable2</span></span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String name = <span class="string">"YY"</span>;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">int</span> num = <span class="number">20</span>;</div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        System.out.println(<span class="string">"TestInitable2 is init!!!!!"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestInitable3</span></span>&#123;</div><div class="line">    <span class="keyword">static</span>&#123;</div><div class="line">        System.out.println(<span class="string">"TestInitable3 is init!!!!"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestInitable4</span></span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> TestBean bean = <span class="keyword">new</span> TestBean();</div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        System.out.println(<span class="string">"TestInitable4 is init!!!!!"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestInitable5</span> <span class="keyword">extends</span> <span class="title">TestInitable</span></span>&#123;</div><div class="line">    <span class="keyword">static</span>&#123;</div><div class="line">        System.out.println(<span class="string">"TestInitable5 is init!!!!"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestBean</span> </span>&#123;</div><div class="line">    String name;</div><div class="line">    <span class="keyword">static</span>&#123;</div><div class="line">        System.out.println(<span class="string">"TestBean is init!!!!"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个demo就是通过调用一些类的静态属性,来查看有没有打印类内部的静态代码块,表明这个类对象有没有初始化.<br>先看第一个:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">System.out.println(TestInitable.num);</div></pre></td></tr></table></figure></p>
<p>由于TestInitable的num属性是 static final的,属于 “编译期常量” ,那么这个值是不需要TestInitable来初始化获取的,所以这个时候 TestInitable对象并不会初始化.内部静态代码块也不会执行,也就不会打印出里面的那条初始化信息.<br>这里只会打印<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">100</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">System.out.println(TestInitable2.name);</div><div class="line">System.out.println(TestInitable2.num);</div></pre></td></tr></table></figure>
<p>第一行和上面的情况一样, <em>name</em> 也是属于 “编译器常量”,所以第一行的时候,TestInitable2是不会初始化,但是第二行的时候由于 <em>num</em> 不是final的,所以不属于 “编译期常量”,那么这个时候就会先执行静态代码块,然后才打印num的值<br>这里会打印:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">YY</div><div class="line">TestInitable2 is init!!!!!</div><div class="line">20</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">System.out.println(Class.forName(<span class="string">"com.justyan.TestInitable3"</span>));</div></pre></td></tr></table></figure>
<p>如果通过 <em>Class.forName</em> 反射调用的话会直接初始化该类<br>这里会打印初始化信息:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">TestInitable3 is init!!!!!</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">System.out.println(TestInitable4.bean);</div></pre></td></tr></table></figure>
<p>这里由于用到了TestBean对象,故先去加载TestBean对象,执行TestBean的内部静态代码块,然后才是 TestInitable4的初始化<br>这里会答应:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">TestBean is init!!!!</div><div class="line">TestInitable4 is init!!!!!</div><div class="line">com.justyan.TestBean@610455d6</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">System.out.println(TestInitable5.num);</div></pre></td></tr></table></figure>
<p>这里TestInitable5继承自TestInitable,所以可以获取到里面的num属性.但是不会初始化 TestInitable5,因为那个属性不属于它.<br>这里只会打印<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">100</div></pre></td></tr></table></figure></p>
<p>这里的这种情况比较特殊,需要注意一下.实际上只要调用的父类的静态属性,这里 TestInitable5都不会初始化.</p>
<p>一定要理解 <em>编译期常量</em> 指的是static final的基础类型,不能是对象,如果是对象就不属于 <em>编译期常量</em> ,这个时候对该变量的调用都会导致类的初始化.<br>如果一个static域不是final的,那么对它访问时,总会要求在它被读取之前,要先进行链接(为这个域分配空间) 和初始化 (初始化该空间),就像对前面的TestBean的调用一样.</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><java编程思想> 第14章 类型信息</java编程思想></p>
<p><a href="http://blog.csdn.net/xyang81/article/details/7292380" title="深入分析Java ClassLoader原理" target="_blank" rel="external">深入分析Java ClassLoader原理</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://pheobusyy.github.io/2017/01/12/2017/android 开源库NumberProgressBar源码分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanyi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pheobusyy">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/12/2017/android 开源库NumberProgressBar源码分析/" itemprop="url">
                  android 开源库NumberProgressBar源码分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-12T15:12:00+08:00">
                2017-01-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="android-开源库NumberProgressBar源码分析"><a href="#android-开源库NumberProgressBar源码分析" class="headerlink" title="android 开源库NumberProgressBar源码分析"></a>android 开源库NumberProgressBar源码分析</h2><p>  这个view是一个简单的自定义view来实现一个横向进度的效果,左边显示完成的进度条,右边显示未完成的进度条,中间是当前的当前的进度说明.实现的思路非常的简单,就是分别画这个view的3部分,完成+文字+未完成的.<br>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/01/12/2017/android 开源库NumberProgressBar源码分析/#more" rel="contents">
              Weiterlesen &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://pheobusyy.github.io/2017/01/11/2017/android 开源Logger库/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanyi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pheobusyy">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/11/2017/android 开源Logger库/" itemprop="url">
                  android 开源Logger库
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-11T09:05:00+08:00">
                2017-01-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="android-开源Logger库"><a href="#android-开源Logger库" class="headerlink" title="android 开源Logger库"></a>android 开源Logger库</h2><h3 id="需要明白的问题"><a href="#需要明白的问题" class="headerlink" title="需要明白的问题"></a>需要明白的问题</h3><ol>
<li><p>如何打印当前线程的名称的<br>直接Thread.currentThread.getName调用的</p>
</li>
<li><p>如何打印调用方法的名称和行数的<br>通过StackTraceElement来获取到引用的数组</p>
</li>
<li><p>StackTraceElement的概念<br>StackTraceElement是java1.5新增的用来输出方法调用栈信息的对象,通过它我们可以打印出当前线程中方法的调用栈,从里面可以可以获取到方法名称,行数,类名称等我们想要的信息</p>
</li>
<li><p>如何增加分割线的和边框的<br>为了把打印日志用方框圈起来,这里把整个日志分成了两部分,顶部叫header+剩下的我们真正需要的信息.<br>header又包含了当前顶部分割线,线程名称,方法调用栈信息<br>最后再把底部分割线加上,正好组合成一个方框,这个方框是没有右边的,因为分割线都是顶满整行的</p>
</li>
<li><p>如何保证打印日志没有超过最大字符个数限制<br>由于原生api的单次打印最大字符限制是4M,所以判断如果要打印的字符串超过4M就把字符串拆开成多段来分别打印</p>
</li>
<li><p>如何处理JSON数据<br>JSONObject原生api居然提供了一个带缩进的toString方法….<br>同时Arrays居然也提供了一个deepToString的方法…..</p>
</li>
<li><p>如何处理XML<br>通过java提供的Transformer API来打印XML</p>
</li>
</ol>
<h3 id="主要代码分析"><a href="#主要代码分析" class="headerlink" title="主要代码分析"></a>主要代码分析</h3><p>其他的方法都非常简单,核心方法就是下面这个log方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">log</span><span class="params">(<span class="keyword">int</span> priority, String tag, String message, Throwable throwable)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (settings.getLogLevel() == LogLevel.NONE) &#123;</div><div class="line">     <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (throwable != <span class="keyword">null</span> &amp;&amp; message != <span class="keyword">null</span>) &#123;</div><div class="line">     message += <span class="string">" : "</span> + Helper.getStackTraceString(throwable);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (throwable != <span class="keyword">null</span> &amp;&amp; message == <span class="keyword">null</span>) &#123;</div><div class="line">     message = Helper.getStackTraceString(throwable);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (message == <span class="keyword">null</span>) &#123;</div><div class="line">     message = <span class="string">"No message/exception is set"</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">int</span> methodCount = getMethodCount();</div><div class="line">   <span class="keyword">if</span> (Helper.isEmpty(message)) &#123;</div><div class="line">     message = <span class="string">"Empty/NULL log message"</span>;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   logTopBorder(priority, tag);</div><div class="line">   logHeaderContent(priority, tag, methodCount);</div><div class="line"></div><div class="line">   <span class="comment">//get bytes of message with system's default charset (which is UTF-8 for Android)</span></div><div class="line">   <span class="keyword">byte</span>[] bytes = message.getBytes();</div><div class="line">   <span class="keyword">int</span> length = bytes.length;</div><div class="line">   <span class="keyword">if</span> (length &lt;= CHUNK_SIZE) &#123;</div><div class="line">     <span class="keyword">if</span> (methodCount &gt; <span class="number">0</span>) &#123;</div><div class="line">       logDivider(priority, tag);</div><div class="line">     &#125;</div><div class="line">     logContent(priority, tag, message);</div><div class="line">     logBottomBorder(priority, tag);</div><div class="line">     <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (methodCount &gt; <span class="number">0</span>) &#123;</div><div class="line">     logDivider(priority, tag);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i += CHUNK_SIZE) &#123;</div><div class="line">     <span class="keyword">int</span> count = Math.min(length - i, CHUNK_SIZE);</div><div class="line">     <span class="comment">//create a new String with system's default charset (which is UTF-8 for Android)</span></div><div class="line">     logContent(priority, tag, <span class="keyword">new</span> String(bytes, i, count));</div><div class="line">   &#125;</div><div class="line">   logBottomBorder(priority, tag);</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>注意,这里加锁来保证数据顺序的正确性<br>通过 <em>logHeaderContent(priority, tag, methodCount);</em> 来打印线程信息和方法调用栈信息.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">logHeaderContent</span><span class="params">(<span class="keyword">int</span> logType, String tag, <span class="keyword">int</span> methodCount)</span> </span>&#123;</div><div class="line">   StackTraceElement[] trace = Thread.currentThread().getStackTrace();</div><div class="line">   <span class="keyword">if</span> (settings.isShowThreadInfo()) &#123;</div><div class="line">     logChunk(logType, tag, HORIZONTAL_DOUBLE_LINE + <span class="string">" Thread: "</span> + Thread.currentThread().getName());</div><div class="line">     logDivider(logType, tag);</div><div class="line">   &#125;</div><div class="line">   String level = <span class="string">""</span>;</div><div class="line"></div><div class="line">   <span class="keyword">int</span> stackOffset = getStackOffset(trace) + settings.getMethodOffset();</div><div class="line"></div><div class="line">   <span class="comment">//corresponding method count with the current stack may exceeds the stack trace. Trims the count</span></div><div class="line">   <span class="keyword">if</span> (methodCount + stackOffset &gt; trace.length) &#123;</div><div class="line">     methodCount = trace.length - stackOffset - <span class="number">1</span>;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = methodCount; i &gt; <span class="number">0</span>; i--) &#123;</div><div class="line">     <span class="keyword">int</span> stackIndex = i + stackOffset;</div><div class="line">     <span class="keyword">if</span> (stackIndex &gt;= trace.length) &#123;</div><div class="line">       <span class="keyword">continue</span>;</div><div class="line">     &#125;</div><div class="line">     StringBuilder builder = <span class="keyword">new</span> StringBuilder();</div><div class="line">     builder.append(<span class="string">"║ "</span>)</div><div class="line">         .append(level)</div><div class="line">         .append(getSimpleClassName(trace[stackIndex].getClassName()))</div><div class="line">         .append(<span class="string">"."</span>)</div><div class="line">         .append(trace[stackIndex].getMethodName())</div><div class="line">         .append(<span class="string">" "</span>)</div><div class="line">         .append(<span class="string">" ("</span>)</div><div class="line">         .append(trace[stackIndex].getFileName())</div><div class="line">         .append(<span class="string">":"</span>)</div><div class="line">         .append(trace[stackIndex].getLineNumber())</div><div class="line">         .append(<span class="string">")"</span>);</div><div class="line">     level += <span class="string">"   "</span>;</div><div class="line">     logChunk(logType, tag, builder.toString());</div><div class="line">   &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>获取到调用栈信息,从第三个开始获取,因为前两个都是系统的调用信息,忽略不计,从第三个开始真正的方法调用的.再加上设置里面要求打印的方法个数,组成了要打印的方法的最终个数.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getStackOffset</span><span class="params">(StackTraceElement[] trace)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = MIN_STACK_OFFSET; i &lt; trace.length; i++) &#123;</div><div class="line">     StackTraceElement e = trace[i];</div><div class="line">     String name = e.getClassName();</div><div class="line">     <span class="keyword">if</span> (!name.equals(LoggerPrinter.class.getName()) &amp;&amp; !name.equals(Logger.class.getName())) &#123;</div><div class="line">       <span class="keyword">return</span> --i;</div><div class="line">     &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>剩下的打印主要信息的时候做个容量判断,如果没超过原声API的最大字符串限制直接打印,如果超了就拆成几段分别打印.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">byte</span>[] bytes = message.getBytes();</div><div class="line">   <span class="keyword">int</span> length = bytes.length;</div><div class="line">   <span class="keyword">if</span> (length &lt;= CHUNK_SIZE) &#123;</div><div class="line">     <span class="keyword">if</span> (methodCount &gt; <span class="number">0</span>) &#123;</div><div class="line">       logDivider(priority, tag);</div><div class="line">     &#125;</div><div class="line">     logContent(priority, tag, message);</div><div class="line">     logBottomBorder(priority, tag);</div><div class="line">     <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (methodCount &gt; <span class="number">0</span>) &#123;</div><div class="line">     logDivider(priority, tag);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i += CHUNK_SIZE) &#123;</div><div class="line">     <span class="keyword">int</span> count = Math.min(length - i, CHUNK_SIZE);</div><div class="line">     <span class="comment">//create a new String with system's default charset (which is UTF-8 for Android)</span></div><div class="line">     logContent(priority, tag, <span class="keyword">new</span> String(bytes, i, count));</div><div class="line">   &#125;</div><div class="line">   logBottomBorder(priority, tag)</div></pre></td></tr></table></figure></p>
<p>非常的简单.</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a href="https://github.com/orhanobut/logger" title="logger github" target="_blank" rel="external">logger github</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>


          
          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="yanyi" />
          <p class="site-author-name" itemprop="name">yanyi</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">62</span>
                <span class="site-state-item-name">Artikel</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">Tags</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yanyi</span>
</div>


<div class="powered-by">
  Erstellt mit  <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    
    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  





  



  
  

  

  

  

  


  

</body>
</html>
