<!doctype html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="pheobusyy" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta property="og:type" content="website">
<meta property="og:title" content="pheobusyy">
<meta property="og:url" content="http://pheobusyy.github.io/page/2/index.html">
<meta property="og:site_name" content="pheobusyy">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="pheobusyy">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://pheobusyy.github.io/page/2/"/>





  <title> pheobusyy </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="">

  














  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">pheobusyy</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Startseite
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archiv
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://pheobusyy.github.io/2017/01/09/2017/读书笔记/另外8小时/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanyi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pheobusyy">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/09/2017/读书笔记/另外8小时/" itemprop="url">
                  另外8小时
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-09T20:27:00+08:00">
                2017-01-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="另外8小时-作者-罗伯特-帕利亚里尼-出版社-南海出版社"><a href="#另外8小时-作者-罗伯特-帕利亚里尼-出版社-南海出版社" class="headerlink" title="另外8小时 作者:罗伯特.帕利亚里尼 出版社:南海出版社"></a>另外8小时 作者:罗伯特.帕利亚里尼 出版社:南海出版社</h2><p>  书中主要讲了如何通过工作和睡觉之外的8小时创造价值或者实现人生目标.</p>
<h3 id="如何找回剩下的8小时"><a href="#如何找回剩下的8小时" class="headerlink" title="如何找回剩下的8小时"></a>如何找回剩下的8小时</h3><p>以下有六大策略,可以帮助你尽可能的拿回这剩下的8小时:</p>
<h4 id="掌握你的时间"><a href="#掌握你的时间" class="headerlink" title="掌握你的时间"></a>掌握你的时间</h4><p>通过详细的时间记录来找到时间分配比例,然后把无用的删减,把重要的加重.</p>
<ol>
<li>列出大项</li>
<li>找出活动项目</li>
<li>列出花在每一项活动上面的时间</li>
<li>递延,消除,减少或保持</li>
</ol>
<h4 id="学着说不"><a href="#学着说不" class="headerlink" title="学着说不"></a>学着说不</h4><ol>
<li>避开 (学会拒绝别人,尽快结束无用的对话)</li>
<li>平衡 (保证从一项任务的时间增加,就要有另一项任务的时间减少)</li>
</ol>
<h4 id="从8小时里面变出9小时"><a href="#从8小时里面变出9小时" class="headerlink" title="从8小时里面变出9小时"></a>从8小时里面变出9小时</h4><p>没有钱也没有时间</p>
<ol>
<li>无摩擦互惠 (自己本来要做的顺便也帮着别人做了,之后要求对方也这样帮助自己)</li>
<li>专业分工 (做各自喜欢或者擅长的来与别人交换自己不喜欢或者不擅长的)</li>
</ol>
<p>有钱但没有时间</p>
<ol>
<li>写出攻击目标</li>
<li>最不想做的事</li>
<li>报价</li>
<li>设定预算</li>
<li>实际动手</li>
</ol>
<h4 id="排列组合"><a href="#排列组合" class="headerlink" title="排列组合"></a>排列组合</h4><p>诀窍在于结合脑力工作和体力工作,选择去做两种不会争夺同样资源的任务.</p>
<ol>
<li>列出无用时间</li>
<li>列出你想多做的有益活动</li>
<li>判定特定活动需要用到的是脑力还是体力</li>
<li>建立链接</li>
</ol>
<h4 id="注入正面因素"><a href="#注入正面因素" class="headerlink" title="注入正面因素"></a>注入正面因素</h4><p>火花指的是正面思考或者正向的做事态度,可以在你的人生中创造出极大的改变,带来不同的结果.</p>
<ol>
<li>选用一种火花</li>
<li>选择在无用时间点火</li>
<li>建立链接</li>
</ol>
<h4 id="善用科技"><a href="#善用科技" class="headerlink" title="善用科技"></a>善用科技</h4><p>(利用各种app,网站来帮助你提高效率,获取信息等等.)</p>
<h3 id="阅读的目的"><a href="#阅读的目的" class="headerlink" title="阅读的目的"></a>阅读的目的</h3><p>除了为自己高兴而阅读,阅读的另一个目的是为了学习.学习不是被动的:若要从投资在阅读的时间上获得最大报酬,你可以从以下秘诀入手.</p>
<ol>
<li>不要浪费时间去读不正确的东西(先略读一遍,了解以下书中的内容,如果看到感兴趣的地方就重点读一下,否则如果啥都没发现就没有读的必要了)</li>
<li>绝对不要在手边没有笔及纸时阅读.在你开始读每一章时,先问问自己从中能学到什么.阅读时,你要记笔记,划重点,在书空白处写下心得,并不断的自问要怎样把所学应用在生活中.</li>
</ol>
<h3 id="100万的问题"><a href="#100万的问题" class="headerlink" title="100万的问题"></a>100万的问题</h3><p>每天不断地问问自己,如果生死就在此一役,要怎样在365天内赚到100万美元? 如果答案仍然相同,你就应该慎重的考虑去完成这件事</p>
<h3 id="这要怎么改善"><a href="#这要怎么改善" class="headerlink" title="这要怎么改善"></a>这要怎么改善</h3><p>你可以挑选心里想到的任务产品或服务,然后在一分钟内尽量想出任何可改善的地方.</p>
<h3 id="学习"><a href="#学习" class="headerlink" title="学习"></a>学习</h3><p>把每一次接触到的机会当做学习经验,”有时候你赢了,有时候你学到了.”</p>
<h3 id="创8者法则"><a href="#创8者法则" class="headerlink" title="创8者法则"></a>创8者法则</h3><ol>
<li>保有全职工作</li>
<li>核子大爆发 (高杠杆率高回报)</li>
<li>了解你的最高最优用途 (自己做擅长最容易成功的领域)</li>
<li>限制风险</li>
<li>常挥棒 (多试错)</li>
<li>市场 (营销)</li>
<li>货币化 (盈利)</li>
<li>拥有 (所有权)</li>
</ol>
<h3 id="创8者的10大渠道"><a href="#创8者的10大渠道" class="headerlink" title="创8者的10大渠道"></a>创8者的10大渠道</h3><p>想法</p>
<ol>
<li>经营博客</li>
<li>发明</li>
<li>出书,写剧本,创作音乐</li>
</ol>
<p>产品</p>
<ol>
<li>开办公司</li>
<li>经销,策略联盟,授权</li>
<li>善用风尚或噱头</li>
</ol>
<p>时间</p>
<ol>
<li>以服务交换公司股票</li>
<li>推进事业发展或大跃进</li>
<li>成为自由职业者</li>
<li>把闲暇爱好变成收入</li>
</ol>
<h4 id="经营博客的规则"><a href="#经营博客的规则" class="headerlink" title="经营博客的规则"></a>经营博客的规则</h4><ol>
<li>创作有价值的内容</li>
<li>有特色</li>
<li>找出普遍的市场</li>
<li>要有主见</li>
<li>要表现个人的那一面</li>
<li>打造品牌</li>
<li>全力营销你的博客</li>
<li>建立多重收入来源</li>
</ol>
<h3 id="“拥有人生”是什么意思"><a href="#“拥有人生”是什么意思" class="headerlink" title="“拥有人生”是什么意思"></a>“拥有人生”是什么意思</h3><h4 id="少一点"><a href="#少一点" class="headerlink" title="少一点"></a>少一点</h4><ul>
<li>后悔 (我本可以)</li>
</ul>
<ol>
<li>克服你身上背负的后悔</li>
<li>通过防范遗憾发生来战胜未来的遗憾</li>
</ol>
<ul>
<li>恐惧</li>
<li>懒散</li>
<li>生命水蛭</li>
</ul>
<h4 id="多一点"><a href="#多一点" class="headerlink" title="多一点"></a>多一点</h4><ul>
<li>成长</li>
<li>经验</li>
<li>改变</li>
<li>向前看</li>
<li>错误</li>
<li>恐惧</li>
<li>闲暇爱好</li>
<li>感恩</li>
<li>人生目标</li>
<li>方向</li>
<li>人际关系</li>
<li>贡献</li>
<li>学习</li>
<li>行动</li>
</ul>
<h3 id="找到你的人生脉动"><a href="#找到你的人生脉动" class="headerlink" title="找到你的人生脉动"></a>找到你的人生脉动</h3><p>遵循下面6个步骤,你会知道如何运用这剩下的8个小时去实现你的理想:</p>
<ol>
<li>拥抱差距 (定位)</li>
<li>写下座右铭 (信念,人生观,价值观)</li>
<li>判定优先次序 (高收益,低半衰)</li>
<li>设定目标 (SMART)</li>
<li>预期挫折 (WOOP)</li>
<li>养成习惯 (习惯)</li>
</ol>
<h4 id="预期挫折"><a href="#预期挫折" class="headerlink" title="预期挫折"></a>预期挫折</h4><p>下面是一些常见的放弃理由:</p>
<ol>
<li>没有时间</li>
<li>失去动力</li>
<li>分心</li>
<li>害怕失败</li>
</ol>
<h3 id="不要做而言-马上起而行-动起来"><a href="#不要做而言-马上起而行-动起来" class="headerlink" title="不要做而言,马上起而行(动起来)"></a>不要做而言,马上起而行(动起来)</h3><p>以下是培养习惯的9个步骤:</p>
<ol>
<li>写出日程表中的固定事项</li>
<li>改掉你的”早叹” (一日之计在于晨)</li>
<li>找出你一天的可用时间</li>
<li>写出其他固定事项</li>
<li>找到开放的时间</li>
<li>排入你的目标</li>
<li>写出任务</li>
<li>组合多重任务</li>
<li>增强精力</li>
</ol>
<h4 id="改掉你的”早叹”"><a href="#改掉你的”早叹”" class="headerlink" title="改掉你的”早叹”"></a>改掉你的”早叹”</h4><p>每天最初的30分钟拥有强大的力量,能帮助你好好掌握眼前的一天.你每天早上的行为和态度会影响你的感受和当天的所作所为.你要做以下几件简单的事,以比较美妙的基调展开一天的生活:</p>
<ol>
<li>毁掉让你越来越衰弱的”克星石”</li>
<li>善用前五秒</li>
<li>让血液奔腾</li>
<li>力量日志(感恩,新事业点子,未来,灵性,一年赚100美元)</li>
<li>早餐</li>
</ol>
<h4 id="排入你的目标"><a href="#排入你的目标" class="headerlink" title="排入你的目标"></a>排入你的目标</h4><p>当你把目标写入目标行动计划书中时,要注意一下这些因素:</p>
<ol>
<li>精力 (合适的时间做合适的事)</li>
<li>流程 (把适合的活动安排在一起,劳逸结合)</li>
</ol>
<h4 id="增强精力"><a href="#增强精力" class="headerlink" title="增强精力"></a>增强精力</h4><ol>
<li>努力缩短差距</li>
<li>成就</li>
<li>运动</li>
<li>营养</li>
<li>榨出”兴奋”</li>
<li>音乐</li>
<li>电视节目</li>
<li>太阳</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://pheobusyy.github.io/2017/01/09/2017/android 自定义URI Router/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanyi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pheobusyy">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/09/2017/android 自定义URI Router/" itemprop="url">
                  android 自定义URI Router
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-09T10:25:00+08:00">
                2017-01-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="android-自定义URI-Router"><a href="#android-自定义URI-Router" class="headerlink" title="android 自定义URI Router"></a>android 自定义URI Router</h2><h3 id="关于自定义Router学习之前的预备知识"><a href="#关于自定义Router学习之前的预备知识" class="headerlink" title="关于自定义Router学习之前的预备知识"></a>关于自定义Router学习之前的预备知识</h3><ol>
<li>为什么要使用google的auto-service这个包<br>如何才能获取一个接口的所有实现类?通过反射来遍历所有的类,然后判断该类是否是实现指定的接口,不过这样效率不太高,毕竟得对所有的类进行遍历;还有一种方法就是就是把实现了该接口的类的全路径名称放入一个配置文件中,这样在使用的时候,从配置文件中获取实现类就可以了.有点反着来的意思.那这里配置文件放在哪里呢?放在了jar包里面的META-INF这个文件夹中,这个文件夹中放的是jar包的一些签名和说明文件,通用的定义是把实现接口类的描述文件放在 META-INF/service/接口名称/中.注意,前面的这种方式是需要人工来完成的,每当你调整了实现接口的数量的话,就需要手动更新一下 META-INF文件,但是 auto-service可以自动完成这些工作,这个就是它的作用.<br><img src="images/2017/01/auto-service生成的配置文件.png" alt="auto-service生成的配置文件"></li>
</ol>
<ol>
<li><p>为什么要使用squareup:javapoet这个包<br>用来通过封装的API来生成java源文件,非常的方便,这里还没有深入的学习</p>
</li>
<li><p>java的METE-INF的作用是说明?</p>
<p>jar包中的签名,配置文件,清单文件,还有接口实现类的列表文件</p>
</li>
<li><p>java的serviceLoader类作用</p>
<p>可以从 METE-INF 中取出指定接口的实现类名称列表,方便直接调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line"></div><div class="line">     ServiceLoader&lt;ITest&gt; serviceLoader = ServiceLoader.load(ITest.class);</div><div class="line">     <span class="keyword">for</span> (ITest iTest : serviceLoader) &#123;</div><div class="line">         iTest.test();</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>自定义的注解是怎么起作用的<br>实现步骤如下:</p>
<ol>
<li><p>顶部工程的gradle中配置:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">    classpath <span class="string">'com.android.tools.build:gradle:2.2.2'</span></div><div class="line">    ....</div><div class="line">    <span class="comment">//引入apt插件</span></div><div class="line">    classpath <span class="string">'com.neenbedankt.gradle.plugins:android-apt:1.8'</span></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>主工程的gradle中配置:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">apply plugin: <span class="string">'com.neenbedankt.android-apt'</span></div><div class="line">.....</div><div class="line"><span class="function">compile <span class="title">project</span> <span class="params">(<span class="string">':annotationprocessor'</span>)</span></span></div><div class="line">apt <span class="title">project</span> <span class="params">(<span class="string">':annotationprocessor'</span>)</span></div></pre></td></tr></table></figure>
</li>
</ol>
<p>这里的 <em>annotationprocessor</em> 用来包含自定义的processor的java子工程</p>
<ol>
<li>用来包含自定义processor的java工程中的gradle中配置:<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">  dependencies &#123;</div><div class="line">    <span class="function">compile <span class="title">fileTree</span><span class="params">(dir: <span class="string">'libs'</span>, include: [<span class="string">'*.jar'</span>])</span></span></div><div class="line">    compile <span class="title">project</span><span class="params">(<span class="string">':annotation'</span>)</span></div><div class="line">    compile 'com.google.auto.service:auto-service:1.0-rc2'</div><div class="line">    compile 'com.squareup:javapoet:1.7.0'</div><div class="line">&#125;</div><div class="line"></div><div class="line">sourceCompatibility = <span class="string">"1.7"</span></div><div class="line">targetCompatibility = <span class="string">"1.7"</span></div></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ol>
<p>这里的 <em>javapoet</em> 根据需求添加,默认可以不适用.<br><em>annotation</em> 工程中存放的是自定义的 <em>annotation</em> 类文件</p>
<ol>
<li>最后就是java代码的书写了,首先是一个自定义的java注解类<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Target</span>(ElementType.TYPE)</div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.CLASS)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> YYAnnotation &#123;</div><div class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>然后是自定义的解析processor<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@AutoService</span>(Processor.class)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">YYAnnotationProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Filer filer;</div><div class="line">    <span class="keyword">private</span> Messager messager;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ProcessingEnvironment processingEnvironment)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.init(processingEnvironment);</div><div class="line">        filer = processingEnvironment.getFiler();</div><div class="line">        messager = processingEnvironment.getMessager();</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> SourceVersion <span class="title">getSupportedSourceVersion</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> SourceVersion.latestSupported();</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getSupportedAnnotationTypes</span><span class="params">()</span> </span>&#123;</div><div class="line">        Set&lt;String&gt; set = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line">        <span class="comment">//这里是你要处理注解的集合</span></div><div class="line">        set.add(YYAnnotation.class.getCanonicalName());</div><div class="line">        <span class="keyword">return</span> set;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Set&lt;? extends Element&gt; mainAppElement = roundEnv.getElementsAnnotatedWith(YYAnnotation.class);</div><div class="line">            <span class="keyword">if</span> (!mainAppElement.isEmpty()) &#123;</div><div class="line">                <span class="comment">//这里实现自己的需求</span></div><div class="line">                process(mainAppElement);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            messager.printMessage(Diagnostic.Kind.ERROR, e.getMessage());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(Set&lt;? extends Element&gt; elementsAnnotatedWith)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">      TypeElement typeElement = (TypeElement) elementsAnnotatedWith.iterator().next();</div><div class="line">      <span class="comment">//这里的Config.FILE_NAME是你要生成的java源文件的名称</span></div><div class="line">      JavaFileObject javaFileObject = filer.createSourceFile(Config.FILE_NAME, typeElement);</div><div class="line">      <span class="comment">//通过printWriter来生成java源文件</span></div><div class="line">      PrintWriter writer = <span class="keyword">new</span> PrintWriter(javaFileObject.openWriter());</div><div class="line">      <span class="comment">//这里的Config.PACKAGE_NAME你要生成的java源文件的包名</span></div><div class="line">      writer.println(<span class="string">"package "</span> + Config.PACKAGE_NAME + <span class="string">";"</span>);</div><div class="line">      writer.println(<span class="string">"public class TestProcessor &#123;"</span>);</div><div class="line">      writer.println(<span class="string">"public static void test () &#123;"</span>);</div><div class="line"></div><div class="line">      YYAnnotation componentsAnnotation = typeElement.getAnnotation(YYAnnotation.class);</div><div class="line">      String components = componentsAnnotation.value();</div><div class="line">      writer.println(<span class="string">"System.out.println(\""</span>+components+<span class="string">"\");"</span>);</div><div class="line"></div><div class="line">      writer.println(<span class="string">"&#125;"</span>);</div><div class="line">      writer.println(<span class="string">"&#125;"</span>);</div><div class="line"></div><div class="line">      writer.flush();</div><div class="line">      writer.close();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>是不是非常的神奇,你可以再编译之前做一些事情,比如生成一个java文件,或者对一些java源文件做处理等等,给了我们很大的灵活性,在这里我们是通过apt生成了可以打印信息的java类,非常的简单,后期可以根据需求调整成更加复杂的逻辑.</p>
<ol>
<li>如何某个接口的所有实现类或者某个父类的所有子类<br>反射遍历所有的java类文件,找到实现该接口的类名称.</li>
</ol>
<h3 id="别人写的Router框架解析"><a href="#别人写的Router框架解析" class="headerlink" title="别人写的Router框架解析"></a>别人写的Router框架解析</h3><p>首先要明白,Router的真正的作用是用在模块之间的解耦上,我们都知道android可以分为主工程+多个library,多个library可以作为单独module的体现,这里Router的作用就是可以让多个library互相之间调用各自的页面,service或者广播,而不用互相知道对方的具体类名称等信息,达到了内部解耦的功能.<br>先看工程目录结构:<br><img src="/images/2017/01/router工程目录结构.png" alt="router工程目录结构"></p>
<p>这里主要的功能实现就在 annotation,router,routerhelper中实现的.其他的两个shoplib和bbslib代表了两个独立模块.主工程app,uitlslib和reslib内部定义了一些工具类,这里不过多的介绍了.</p>
<h4 id="annotation工程"><a href="#annotation工程" class="headerlink" title="annotation工程"></a>annotation工程</h4><p>首先来看annotation,这个工程主要放置的是关于Router定义的各种注解.是一个纯java工程.<br><img src="/images/2017/01/annotation项目类定义.png" alt=""></p>
<p>其中, <em>AutoRouter</em> , <em>StaticRouter</em> 是router注解的两种模式,分别对应自动根据绑定的class类型来给URI添加对应的前缀,比如如果绑定的是activity则前缀为 <em>activity://</em> ,而后者则是完全按照注解的value值来作为绑定的URI.这个后续在代码中就明白怎么用了.<br><em>Components</em> 对应所有模块的注解,主要用在application中声明都有那几个需要Router的模块.<br><em>Component</em> 对应每个独立的模块<br>下面来看代码定义,非常的简单,就是普通的java注解声明:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Target</span>(ElementType.TYPE)</div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.CLASS)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> AutoRouter &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Target</span>(ElementType.TYPE)</div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.CLASS)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> StaticRouter &#123;</div><div class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Target</span>(ElementType.TYPE)</div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.CLASS)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Component &#123;</div><div class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.CLASS)</div><div class="line"><span class="meta">@Target</span>(ElementType.TYPE)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Components &#123;</div><div class="line">    String[] value();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="routerhelper工程"><a href="#routerhelper工程" class="headerlink" title="routerhelper工程"></a>routerhelper工程</h4><p>上面再 <em>annotation</em> 项目中完成了注解的定义,那势必会有一个 <em>processor</em> 来完成注解的解析和逻辑处理,这里如果对注解的处理流程不是很熟悉的话可以看下相关的java注解处理的资源.这里就不重点介绍了.直接进入 <em>RouterHelper</em> 这个解析注解类中.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@AutoService</span>(Processor.class)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RouterProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Filer mFiler;</div><div class="line">    <span class="keyword">private</span> Messager mMessager;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; mStaticRouterMap = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">    <span class="keyword">private</span> List&lt;String&gt; mAutoRouterList = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ProcessingEnvironment processingEnvironment)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.init(processingEnvironment);</div><div class="line">        mFiler = processingEnvironment.getFiler();</div><div class="line">        mMessager = processingEnvironment.getMessager();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> SourceVersion <span class="title">getSupportedSourceVersion</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> SourceVersion.latestSupported();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getSupportedAnnotationTypes</span><span class="params">()</span> </span>&#123;</div><div class="line">        Set&lt;String&gt; set = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line">        set.add(AutoRouter.class.getCanonicalName());</div><div class="line">        set.add(StaticRouter.class.getCanonicalName());</div><div class="line">        set.add(Component.class.getCanonicalName());</div><div class="line">        set.add(Components.class.getCanonicalName());</div><div class="line">        <span class="keyword">return</span> set;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; set, RoundEnvironment roundEnvironment)</span> </span>&#123;</div><div class="line">        mStaticRouterMap.clear();</div><div class="line">        mAutoRouterList.clear();</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Set&lt;? extends Element&gt; mainAppElement = roundEnvironment.getElementsAnnotatedWith(Components.class);</div><div class="line">            <span class="keyword">if</span> (!mainAppElement.isEmpty()) &#123;</div><div class="line">                processInstaller(mainAppElement);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">            processComponent(roundEnvironment);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            mMessager.printMessage(Diagnostic.Kind.ERROR, e.getMessage());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processInstaller</span><span class="params">(Set&lt;? extends Element&gt; mainAppElement)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        TypeElement typeElement = (TypeElement) mainAppElement.iterator().next();</div><div class="line">        JavaFileObject javaFileObject = mFiler.createSourceFile(Config.ROUTER_MANAGER, typeElement);</div><div class="line">        PrintWriter writer = <span class="keyword">new</span> PrintWriter(javaFileObject.openWriter());</div><div class="line"></div><div class="line">        writer.println(<span class="string">"package "</span> + Config.PACKAGE_NAME + <span class="string">";"</span>);</div><div class="line">        writer.println(<span class="string">"public class "</span> + Config.ROUTER_MANAGER + <span class="string">" &#123;"</span>);</div><div class="line">        writer.println(<span class="string">"public static void "</span> + Config.ROUTER_MANAGER_METHOD + <span class="string">"() &#123;"</span>);</div><div class="line"></div><div class="line">        Components componentsAnnotation = typeElement.getAnnotation(Components.class);</div><div class="line">        String[] components = componentsAnnotation.value();</div><div class="line">        <span class="keyword">for</span> (String item : components) &#123;</div><div class="line">            writer.println(Config.FILE_PREFIX + item + <span class="string">".router();"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        writer.println(<span class="string">"&#125;"</span>);</div><div class="line">        writer.println(<span class="string">"&#125;"</span>);</div><div class="line"></div><div class="line">        writer.flush();</div><div class="line">        writer.close();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processComponent</span><span class="params">(RoundEnvironment roundEnvironment)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        Set&lt;? extends Element&gt; compElements = roundEnvironment.getElementsAnnotatedWith(Component.class);</div><div class="line">        <span class="keyword">if</span> (compElements.isEmpty()) &#123; <span class="keyword">return</span>;&#125;</div><div class="line"></div><div class="line">        Element item = compElements.iterator().next();</div><div class="line">        String componentName = item.getAnnotation(Component.class).value();</div><div class="line"></div><div class="line">        Set&lt;? extends Element&gt; routerElements = roundEnvironment.getElementsAnnotatedWith(StaticRouter.class);</div><div class="line">        <span class="keyword">for</span> (Element e : routerElements) &#123;</div><div class="line">            <span class="keyword">if</span> (! (e <span class="keyword">instanceof</span> TypeElement)) &#123; <span class="keyword">continue</span>;&#125;</div><div class="line">            TypeElement typeElement = (TypeElement) e;</div><div class="line">            String pattern = typeElement.getAnnotation(StaticRouter.class).value();</div><div class="line">            mStaticRouterMap.put(pattern, typeElement.getQualifiedName().toString());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Set&lt;? extends Element&gt; autoRouterElements = roundEnvironment.getElementsAnnotatedWith(AutoRouter.class);</div><div class="line">        <span class="keyword">for</span> (Element e : autoRouterElements) &#123;</div><div class="line">            <span class="keyword">if</span> (!(e <span class="keyword">instanceof</span> TypeElement)) &#123; <span class="keyword">continue</span>;&#125;</div><div class="line">            TypeElement typeElement = (TypeElement) e;</div><div class="line">            mAutoRouterList.add(typeElement.getQualifiedName().toString());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        writeComponentFile(componentName);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeComponentFile</span><span class="params">(String componentName)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        String className = Config.FILE_PREFIX + componentName;</div><div class="line">        JavaFileObject javaFileObject = mFiler.createSourceFile(className);</div><div class="line"><span class="comment">//        javaFileObject.delete();</span></div><div class="line"></div><div class="line">        PrintWriter printWriter = <span class="keyword">new</span> PrintWriter(javaFileObject.openWriter());</div><div class="line"></div><div class="line">        printWriter.println(<span class="string">"package "</span> + Config.PACKAGE_NAME + <span class="string">";"</span>);</div><div class="line"></div><div class="line">        printWriter.println(<span class="string">"import android.app.Activity;"</span>);</div><div class="line">        printWriter.println(<span class="string">"import android.app.Service;"</span>);</div><div class="line">        printWriter.println(<span class="string">"import android.content.BroadcastReceiver;"</span>);</div><div class="line"></div><div class="line">        printWriter.println(<span class="string">"public class "</span> + className + <span class="string">" &#123;"</span>);</div><div class="line">        printWriter.println(<span class="string">"public static void router() &#123;"</span>);</div><div class="line"></div><div class="line">        <span class="comment">// // Router.router(ActivityRule.ACTIVITY_SCHEME + "shop.main", ShopActivity.class);</span></div><div class="line">        <span class="keyword">for</span>(Map.Entry&lt;String, String&gt; entry : mStaticRouterMap.entrySet()) &#123;</div><div class="line">            printWriter.println(<span class="string">"org.loader.router.Router.router(\""</span> + entry.getKey()</div><div class="line">                    +<span class="string">"\", "</span>+entry.getValue()+<span class="string">".class);"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (String klass : mAutoRouterList) &#123;</div><div class="line">            printWriter.println(<span class="string">"if (Activity.class.isAssignableFrom("</span> + klass + <span class="string">".class)) &#123;"</span>);</div><div class="line">            printWriter.println(<span class="string">"org.loader.router.Router.router(org.loader.router.rule.ActivityRule.ACTIVITY_SCHEME + \""</span></div><div class="line">                    +klass+<span class="string">"\", "</span> + klass + <span class="string">".class);"</span>);</div><div class="line">            printWriter.println(<span class="string">"&#125;"</span>);</div><div class="line"></div><div class="line">            printWriter.println(<span class="string">"else if (Service.class.isAssignableFrom("</span> + klass + <span class="string">".class)) &#123;"</span>);</div><div class="line">            printWriter.println(<span class="string">"org.loader.router.Router.router(org.loader.router.rule.ServiceRule.SERVICE_SCHEME + \""</span></div><div class="line">                    +klass+<span class="string">"\", "</span> + klass + <span class="string">".class);"</span>);</div><div class="line">            printWriter.println(<span class="string">"&#125;"</span>);</div><div class="line"></div><div class="line">            printWriter.println(<span class="string">"else if (BroadcastReceiver.class.isAssignableFrom("</span> + klass + <span class="string">".class)) &#123;"</span>);</div><div class="line">            printWriter.println(<span class="string">"org.loader.router.Router.router(org.loader.router.rule.ReceiverRule.RECEIVER_SCHEME + \""</span></div><div class="line">                    +klass+<span class="string">"\", "</span>+klass+<span class="string">".class);"</span>);</div><div class="line">            printWriter.println(<span class="string">"&#125;"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        printWriter.println(<span class="string">"&#125;"</span>);</div><div class="line">        printWriter.println(<span class="string">"&#125;"</span>);</div><div class="line">        printWriter.flush();</div><div class="line">        printWriter.close();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>首先在顶部声明了 <em>AutoService</em> 对应本文最上面提到的它的作用用来更新METE-INF中接口的列表文件的.这样可以快速找到工程都有哪些 <em>processor</em> .</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getSupportedAnnotationTypes</span><span class="params">()</span> </span>&#123;</div><div class="line">    Set&lt;String&gt; set = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line">    set.add(AutoRouter.class.getCanonicalName());</div><div class="line">    set.add(StaticRouter.class.getCanonicalName());</div><div class="line">    set.add(Component.class.getCanonicalName());</div><div class="line">    set.add(Components.class.getCanonicalName());</div><div class="line">    <span class="keyword">return</span> set;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>用来声明这个processor可以支持处理哪些注解.是一个set集合<br>mFiler可以用来生成一些自定义的源文件,class或其他文件.<br>mMessager 可以把错误信息打印出来<br>重点解析注解的逻辑就在 <em>process</em> 方法中.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Set&lt;? extends Element&gt; mainAppElement = roundEnvironment.getElementsAnnotatedWith(Components.class);</div><div class="line"><span class="keyword">if</span> (!mainAppElement.isEmpty()) &#123;</div><div class="line">    processInstaller(mainAppElement);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>来看第一个关键点,先是找到所有声明 <em>Components</em> 的类对象,这里注意由于 <em>Components</em> 声明的是 <em>ElementType.TYPE</em> 表明只能在类顶部定义,那么这里找到的element都是TypeElement表示类元素.<br>前面说到 <em>Components</em> 的作用是用来表示都有哪些模块需要Router的.比如这里在Application顶部声明了:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@Components</span>(&#123;<span class="string">"shop"</span>, <span class="string">"bbs"</span>&#125;)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">MultiDexApplication</span> </span>&#123;</div><div class="line">  ....</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>说明了有两个工程工程需要Router功能,对应上面说的 shop和bbs两个模块.<br>回到 <em>process</em> 方法中,找到了 <em>Components</em> 的声明类并且不为空的话就进入 <em>processInstaller</em> 方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processInstaller</span><span class="params">(Set&lt;? extends Element&gt; mainAppElement)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">       TypeElement typeElement = (TypeElement) mainAppElement.iterator().next();</div><div class="line">       JavaFileObject javaFileObject = mFiler.createSourceFile(Config.ROUTER_MANAGER, typeElement);</div><div class="line">       PrintWriter writer = <span class="keyword">new</span> PrintWriter(javaFileObject.openWriter());</div><div class="line"></div><div class="line">       writer.println(<span class="string">"package "</span> + Config.PACKAGE_NAME + <span class="string">";"</span>);</div><div class="line">       writer.println(<span class="string">"public class "</span> + Config.ROUTER_MANAGER + <span class="string">" &#123;"</span>);</div><div class="line">       writer.println(<span class="string">"public static void "</span> + Config.ROUTER_MANAGER_METHOD + <span class="string">"() &#123;"</span>);</div><div class="line"></div><div class="line">       Components componentsAnnotation = typeElement.getAnnotation(Components.class);</div><div class="line">       String[] components = componentsAnnotation.value();</div><div class="line">       <span class="keyword">for</span> (String item : components) &#123;</div><div class="line">           writer.println(Config.FILE_PREFIX + item + <span class="string">".router();"</span>);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       writer.println(<span class="string">"&#125;"</span>);</div><div class="line">       writer.println(<span class="string">"&#125;"</span>);</div><div class="line"></div><div class="line">       writer.flush();</div><div class="line">       writer.close();</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>可以看到这里,通过mFiler对象创建了新的java源文件,位于 <em>Config.PACKAGE_NAME</em> 中的叫做 <em>Config.ROUTER_MANAGER</em> 的java文件,其内部定义了一个 <em>Config.ROUTER_MANAGER_METHOD</em> 方法,我们可以在编译完成后,在我们的工程中对应的目录中找到这个生成的源文件.<br><img src="/images/2017/01/processor生成的java源码.png" alt="processor生成的java源码"></p>
<p>看到这里就发现我们居然可以自己生成java源文件,简直是打开了新世界的大门啊,用java来写java源文件,这本身就有种递归的感觉在里边,通过想象,我们可以做很多事情了,这个后续我们可以研究一下更多的用法.<br>生成的java类中的方法调用了每个模块的Router类的Router方法.可以看到这个Router是红色的,但是搜索一下发现,这个类居然也是生成的.那我们可以发现这个类肯定是通过 <em>processor</em> 方法中剩下那句代码来完成, 进入 <em>processComponent(roundEnvironment);</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processComponent</span><span class="params">(RoundEnvironment roundEnvironment)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">       Set&lt;? extends Element&gt; compElements = roundEnvironment.getElementsAnnotatedWith(Component.class);</div><div class="line">       <span class="keyword">if</span> (compElements.isEmpty()) &#123; <span class="keyword">return</span>;&#125;</div><div class="line"></div><div class="line">       Element item = compElements.iterator().next();</div><div class="line">       String componentName = item.getAnnotation(Component.class).value();</div><div class="line"></div><div class="line">       Set&lt;? extends Element&gt; routerElements = roundEnvironment.getElementsAnnotatedWith(StaticRouter.class);</div><div class="line">       <span class="keyword">for</span> (Element e : routerElements) &#123;</div><div class="line">           <span class="keyword">if</span> (! (e <span class="keyword">instanceof</span> TypeElement)) &#123; <span class="keyword">continue</span>;&#125;</div><div class="line">           TypeElement typeElement = (TypeElement) e;</div><div class="line">           String pattern = typeElement.getAnnotation(StaticRouter.class).value();</div><div class="line">           mStaticRouterMap.put(pattern, typeElement.getQualifiedName().toString());</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       Set&lt;? extends Element&gt; autoRouterElements = roundEnvironment.getElementsAnnotatedWith(AutoRouter.class);</div><div class="line">       <span class="keyword">for</span> (Element e : autoRouterElements) &#123;</div><div class="line">           <span class="keyword">if</span> (!(e <span class="keyword">instanceof</span> TypeElement)) &#123; <span class="keyword">continue</span>;&#125;</div><div class="line">           TypeElement typeElement = (TypeElement) e;</div><div class="line">           mAutoRouterList.add(typeElement.getQualifiedName().toString());</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       writeComponentFile(componentName);</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>可以看到,这里也很好理解,把所有的router声明类和URI放入集合中.通过后面的 <em>writeComponentFile</em> 方法来完成每个工程自己的router类生成.<br>之前读到这里这里的时候有个问题一直不明白:就是很明显关于 <em>Component</em> 注解应该有两个啊,但是这里却只是通过iterator的next方法获取注解集合中的一个然就去生成router类,那不就少了另外一个 <em>Component</em> 吗?,也就是说一个shop,一个bbs,都是注册了 <em>Component</em> 注解的,但是这里确只是从集合中取了一个,那后面那个就没人管了,岂不是少了一个.后来想明白了:<br>每个工程都是单独的调用 <em>processor</em> 来完成注解解析的,也就是说 shop工程中会调用一次这个 <em>processor</em> ,bbs工程中也会调用一次这个 <em>processor</em> ,这样关于 <em>component</em> 注解的处理就会执行两次,同时为每个模块各自生成一个 Router类.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeComponentFile</span><span class="params">(String componentName)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">      String className = Config.FILE_PREFIX + componentName;</div><div class="line">      JavaFileObject javaFileObject = mFiler.createSourceFile(className);</div><div class="line"><span class="comment">//        javaFileObject.delete();</span></div><div class="line"></div><div class="line">      PrintWriter printWriter = <span class="keyword">new</span> PrintWriter(javaFileObject.openWriter());</div><div class="line"></div><div class="line">      printWriter.println(<span class="string">"package "</span> + Config.PACKAGE_NAME + <span class="string">";"</span>);</div><div class="line"></div><div class="line">      printWriter.println(<span class="string">"import android.app.Activity;"</span>);</div><div class="line">      printWriter.println(<span class="string">"import android.app.Service;"</span>);</div><div class="line">      printWriter.println(<span class="string">"import android.content.BroadcastReceiver;"</span>);</div><div class="line"></div><div class="line">      printWriter.println(<span class="string">"public class "</span> + className + <span class="string">" &#123;"</span>);</div><div class="line">      printWriter.println(<span class="string">"public static void router() &#123;"</span>);</div><div class="line"></div><div class="line">      <span class="comment">// // Router.router(ActivityRule.ACTIVITY_SCHEME + "shop.main", ShopActivity.class);</span></div><div class="line">      <span class="keyword">for</span>(Map.Entry&lt;String, String&gt; entry : mStaticRouterMap.entrySet()) &#123;</div><div class="line">          printWriter.println(<span class="string">"org.loader.router.Router.router(\""</span> + entry.getKey()</div><div class="line">                  +<span class="string">"\", "</span>+entry.getValue()+<span class="string">".class);"</span>);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">for</span> (String klass : mAutoRouterList) &#123;</div><div class="line">          printWriter.println(<span class="string">"if (Activity.class.isAssignableFrom("</span> + klass + <span class="string">".class)) &#123;"</span>);</div><div class="line">          printWriter.println(<span class="string">"org.loader.router.Router.router(org.loader.router.rule.ActivityRule.ACTIVITY_SCHEME + \""</span></div><div class="line">                  +klass+<span class="string">"\", "</span> + klass + <span class="string">".class);"</span>);</div><div class="line">          printWriter.println(<span class="string">"&#125;"</span>);</div><div class="line"></div><div class="line">          printWriter.println(<span class="string">"else if (Service.class.isAssignableFrom("</span> + klass + <span class="string">".class)) &#123;"</span>);</div><div class="line">          printWriter.println(<span class="string">"org.loader.router.Router.router(org.loader.router.rule.ServiceRule.SERVICE_SCHEME + \""</span></div><div class="line">                  +klass+<span class="string">"\", "</span> + klass + <span class="string">".class);"</span>);</div><div class="line">          printWriter.println(<span class="string">"&#125;"</span>);</div><div class="line"></div><div class="line">          printWriter.println(<span class="string">"else if (BroadcastReceiver.class.isAssignableFrom("</span> + klass + <span class="string">".class)) &#123;"</span>);</div><div class="line">          printWriter.println(<span class="string">"org.loader.router.Router.router(org.loader.router.rule.ReceiverRule.RECEIVER_SCHEME + \""</span></div><div class="line">                  +klass+<span class="string">"\", "</span>+klass+<span class="string">".class);"</span>);</div><div class="line">          printWriter.println(<span class="string">"&#125;"</span>);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      printWriter.println(<span class="string">"&#125;"</span>);</div><div class="line">      printWriter.println(<span class="string">"&#125;"</span>);</div><div class="line">      printWriter.flush();</div><div class="line">      printWriter.close();</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>这个 <em>writeComponentFile</em> 方法就是用来完成Router注册的,可以看到很直白的java代码,把java代码作为输入交给pritWriter来写入指定的文件中.<br>来看下两个生成的Router类的代码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.loader.router;</div><div class="line"><span class="keyword">import</span> android.app.Activity;</div><div class="line"><span class="keyword">import</span> android.app.Service;</div><div class="line"><span class="keyword">import</span> android.content.BroadcastReceiver;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Router_bbs</span> </span>&#123;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">router</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="keyword">if</span> (Activity.class.isAssignableFrom(org.loader.bbslib.BBSActivity.class)) &#123;</div><div class="line">org.loader.router.Router.router(org.loader.router.rule.ActivityRule.ACTIVITY_SCHEME + <span class="string">"org.loader.bbslib.BBSActivity"</span>, org.loader.bbslib.BBSActivity.class);</div><div class="line">&#125;</div><div class="line"><span class="keyword">else</span> <span class="keyword">if</span> (Service.class.isAssignableFrom(org.loader.bbslib.BBSActivity.class)) &#123;</div><div class="line">org.loader.router.Router.router(org.loader.router.rule.ServiceRule.SERVICE_SCHEME + <span class="string">"org.loader.bbslib.BBSActivity"</span>, org.loader.bbslib.BBSActivity.class);</div><div class="line">&#125;</div><div class="line"><span class="keyword">else</span> <span class="keyword">if</span> (BroadcastReceiver.class.isAssignableFrom(org.loader.bbslib.BBSActivity.class)) &#123;</div><div class="line">org.loader.router.Router.router(org.loader.router.rule.ReceiverRule.RECEIVER_SCHEME + <span class="string">"org.loader.bbslib.BBSActivity"</span>, org.loader.bbslib.BBSActivity.class);</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.loader.router;</div><div class="line"><span class="keyword">import</span> android.app.Activity;</div><div class="line"><span class="keyword">import</span> android.app.Service;</div><div class="line"><span class="keyword">import</span> android.content.BroadcastReceiver;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Router_shop</span> </span>&#123;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">router</span><span class="params">()</span> </span>&#123;</div><div class="line">org.loader.router.Router.router(<span class="string">"activity://shop.main"</span>, org.loader.shoplib.ShopActivity.class);</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到这两个通过代码生成源文件最后都是进入了Router类的router方法.<br>到这里关于注解的解析就完成,下面开始进入的Router的核心实现.</p>
<h3 id="router工程"><a href="#router工程" class="headerlink" title="router工程"></a>router工程</h3><p>到这里,才算真正开始Router核心实现,要知道两个模块互相调用对方的元素,而又不直接调用,势必会有一个中间的东西来完成Router功能,首先是每个模块把自己的对外开放的元素注册到中间人,然后在需要调用别的模块的元素的时候,通过URI从中间人中来匹配找到对方的元素.这就是一个完成的Router流程.<br>很明显,需要一个map结构,key是URI,value是对应的class对象或者className.<br>上面每个模块的Router类都是最终调用的这个工程的Router类的router方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Router</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 添加自定义路由规则</div><div class="line">     * <span class="doctag">@param</span> scheme 路由scheme</div><div class="line">     * <span class="doctag">@param</span> rule 路由规则</div><div class="line">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> RouterInternal&#125; Router真实调用类</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RouterInternal <span class="title">addRule</span><span class="params">(String scheme, Rule rule)</span> </span>&#123;</div><div class="line">        RouterInternal router = RouterInternal.get();</div><div class="line">        router.addRule(scheme, rule);</div><div class="line">        <span class="keyword">return</span> router;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 添加路由</div><div class="line">     * <span class="doctag">@param</span> pattern 路由uri</div><div class="line">     * <span class="doctag">@param</span> klass 路由class</div><div class="line">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> RouterInternal&#125; Router真实调用类</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">RouterInternal <span class="title">router</span><span class="params">(String pattern, Class&lt;T&gt; klass)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> RouterInternal.get().router(pattern, klass);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 路由调用</div><div class="line">     * <span class="doctag">@param</span> ctx Context</div><div class="line">     * <span class="doctag">@param</span> pattern 路由uri</div><div class="line">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> V&#125; 返回对应的返回值</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;V&gt; <span class="function">V <span class="title">invoke</span><span class="params">(Context ctx, String pattern)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> RouterInternal.get().invoke(ctx, pattern);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 是否存在该路由</div><div class="line">     * <span class="doctag">@param</span> pattern</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">resolveRouter</span><span class="params">(String pattern)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> RouterInternal.get().resolveRouter(pattern);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个router方法就是用来注册URI的.<br>可以看到所有的逻辑都是在 <em>RouterInternal</em> 中实现的.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RouterInternal</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> RouterInternal sInstance;</div><div class="line"></div><div class="line">    <span class="comment">/** scheme-&gt;路由规则 */</span></div><div class="line">    <span class="keyword">private</span> HashMap&lt;String, Rule&gt; mRules;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">RouterInternal</span><span class="params">()</span> </span>&#123;</div><div class="line">        mRules = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">        initDefaultRouter();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 添加默认的Activity，Service，Receiver路由</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initDefaultRouter</span><span class="params">()</span> </span>&#123;</div><div class="line">        addRule(ActivityRule.ACTIVITY_SCHEME, <span class="keyword">new</span> ActivityRule());</div><div class="line">        addRule(ServiceRule.SERVICE_SCHEME, <span class="keyword">new</span> ServiceRule());</div><div class="line">        addRule(ReceiverRule.RECEIVER_SCHEME, <span class="keyword">new</span> ReceiverRule());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/*package */</span> <span class="function"><span class="keyword">static</span> RouterInternal <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (sInstance == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">synchronized</span> (RouterInternal.class) &#123;</div><div class="line">                <span class="keyword">if</span> (sInstance == <span class="keyword">null</span>) &#123;</div><div class="line">                    sInstance = <span class="keyword">new</span> RouterInternal();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> sInstance;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 添加自定义路由规则</div><div class="line">     * <span class="doctag">@param</span> scheme 路由scheme</div><div class="line">     * <span class="doctag">@param</span> rule 路由规则</div><div class="line">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> RouterInternal&#125; Router真实调用类</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> RouterInternal <span class="title">addRule</span><span class="params">(String scheme, Rule rule)</span> </span>&#123;</div><div class="line">        mRules.put(scheme, rule);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> &lt;T, V&gt; <span class="function">Rule&lt;T, V&gt; <span class="title">getRule</span><span class="params">(String pattern)</span> </span>&#123;</div><div class="line">        HashMap&lt;String, Rule&gt; rules = mRules;</div><div class="line">        Set&lt;String&gt; keySet = rules.keySet();</div><div class="line">        Rule&lt;T, V&gt; rule = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">for</span> (String scheme : keySet) &#123;</div><div class="line">            <span class="keyword">if</span> (pattern.startsWith(scheme)) &#123;</div><div class="line">                rule = rules.get(scheme);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> rule;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 添加路由</div><div class="line">     * <span class="doctag">@param</span> pattern 路由uri</div><div class="line">     * <span class="doctag">@param</span> klass 路由class</div><div class="line">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> RouterInternal&#125; Router真实调用类</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> &lt;T&gt; <span class="function">RouterInternal <span class="title">router</span><span class="params">(String pattern, Class&lt;T&gt; klass)</span> </span>&#123;</div><div class="line">        Rule&lt;T, ?&gt; rule = getRule(pattern);</div><div class="line">        <span class="keyword">if</span> (rule == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NotRouteException(<span class="string">"unknown"</span>, pattern);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        rule.router(pattern, klass);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 路由调用</div><div class="line">     * <span class="doctag">@param</span> ctx Context</div><div class="line">     * <span class="doctag">@param</span> pattern 路由uri</div><div class="line">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> V&#125; 返回对应的返回值</div><div class="line">     */</div><div class="line">    <span class="comment">/*package*/</span> <span class="keyword">final</span> &lt;V&gt; <span class="function">V <span class="title">invoke</span><span class="params">(Context ctx, String pattern)</span> </span>&#123;</div><div class="line">        Rule&lt;?, V&gt; rule = getRule(pattern);</div><div class="line">        <span class="keyword">if</span> (rule == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NotRouteException(<span class="string">"unknown"</span>, pattern);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> rule.invoke(ctx, pattern);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 是否存在该路由</div><div class="line">     * <span class="doctag">@param</span> pattern</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">resolveRouter</span><span class="params">(String pattern)</span> </span>&#123;</div><div class="line">        Rule&lt;?, ?&gt; rule = getRule(pattern);</div><div class="line">        <span class="keyword">return</span> rule != <span class="keyword">null</span> &amp;&amp; rule.resolveRule(pattern);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里 <em>RouterInternal</em> 对象通过一个两层map结构来完成路由功能,第一层就是pattern—&gt;rule对象,第二次是rule对象内部的pattern—–&gt;class对象.这样有什么好处呢?可以看到通过 <em>initDefaultRouter</em> 预置了3个默认的rule对象在 <em>RouterInternal</em> 内部的map中,分别对应activity,service和广播.然后每次先通过pattern来找到这3个内置rule中的一个,然后才把pattern和class对象放入rule对象中.<br>这样的好处是便于管理,所有的activity都放入一个rule对象的,所有的service都放入同一个rule中,结构非常的清晰,同时也节约了内存.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Rule</span>&lt;<span class="title">T</span>, <span class="title">V</span>&gt; </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 添加路由</div><div class="line">     * <span class="doctag">@param</span> pattern 路由uri</div><div class="line">     * <span class="doctag">@param</span> klass 路由class</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">router</span><span class="params">(String pattern, Class&lt;T&gt; klass)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 路由调用</div><div class="line">     * <span class="doctag">@param</span> ctx Context</div><div class="line">     * <span class="doctag">@param</span> pattern 路由uri</div><div class="line">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> V&#125; 返回对应的返回值</div><div class="line">     */</div><div class="line">    <span class="function">V <span class="title">invoke</span><span class="params">(Context ctx, String pattern)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 查看是否存在pattern对应的路由</div><div class="line">     * <span class="doctag">@param</span> pattern</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">resolveRule</span><span class="params">(String pattern)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>rule是一个map结构的对象,用来URI匹配的细分,具体实现在 <em>BaseInternRule</em> 中<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseIntentRule</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Rule</span>&lt;<span class="title">T</span>, <span class="title">Intent</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> HashMap&lt;String, Class&lt;T&gt;&gt; mIntentRules;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseIntentRule</span><span class="params">()</span> </span>&#123;</div><div class="line">        mIntentRules = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * &#123;<span class="doctag">@inheritDoc</span>&#125;</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">router</span><span class="params">(String pattern, Class&lt;T&gt; klass)</span> </span>&#123;</div><div class="line">        mIntentRules.put(pattern, klass);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * &#123;<span class="doctag">@inheritDoc</span>&#125;</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Intent <span class="title">invoke</span><span class="params">(Context ctx, String pattern)</span> </span>&#123;</div><div class="line">        Class&lt;T&gt; klass = mIntentRules.get(pattern);</div><div class="line">        <span class="keyword">if</span> (klass == <span class="keyword">null</span>) &#123; throwException(pattern);&#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Intent(ctx, klass);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">resolveRule</span><span class="params">(String pattern)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mIntentRules.get(pattern) != <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 当找不到路由规则时抛出异常</div><div class="line">     * <span class="doctag">@param</span> pattern 路由pattern</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">throwException</span><span class="params">(String pattern)</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到这里就是一个简单的map结构<br>剩下的 <em>ActivityRule</em> ,<em>ReceiverRule</em> ,<em>ServiceRule</em> 都是继承自 <em>BaseIntentRule</em> 中,内部定义了各自的前缀.</p>
<p>到这里router的核心逻辑就完成了,下面来看怎么用的</p>
<h3 id="app工程的router调用"><a href="#app工程的router调用" class="headerlink" title="app工程的router调用"></a>app工程的router调用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@Components</span>(&#123;<span class="string">"shop"</span>, <span class="string">"bbs"</span>&#125;)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">MultiDexApplication</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate();</div><div class="line">        setupRouter();</div><div class="line">        Logger.dump(<span class="string">"TAG"</span>, <span class="string">"application: "</span> + getClass().getName());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setupRouter</span><span class="params">()</span> </span>&#123;</div><div class="line">        RouterHelper.install();</div><div class="line"></div><div class="line"><span class="comment">//        Router.router(ActivityRule.ACTIVITY_SCHEME + "shop.main", ShopActivity.class);</span></div><div class="line"><span class="comment">//        Router.router(ActivityRule.ACTIVITY_SCHEME + "bbs.main", BBSActivity.class);</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在工程的总入口application对象中完成了模块的注册,同是调用了 <em>RouterHelper.install();</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RouterHelper</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">install</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Class&lt;?&gt; klass = Class.forName(Config.PACKAGE_NAME + <span class="string">"."</span> + Config.ROUTER_MANAGER);</div><div class="line">            Method method = klass.getDeclaredMethod(Config.ROUTER_MANAGER_METHOD);</div><div class="line">            method.invoke(<span class="keyword">null</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里就是通过反射来找到上面那个 <em>processor</em> 生成的java源文件,调用里面的唯一方法.完成router的注册的.</p>
<p>再看两个子模块是怎么互相调用对方的</p>
<h3 id="shop工程"><a href="#shop工程" class="headerlink" title="shop工程"></a>shop工程</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span>(<span class="string">"shop"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Shop</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@StaticRouter</span>(ActivityRule.ACTIVITY_SCHEME + <span class="string">"shop.main"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShopActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        TextView tv = <span class="keyword">new</span> TextView(<span class="keyword">this</span>);</div><div class="line">        tv.setTextSize(<span class="number">50</span>);</div><div class="line">        tv.setText(<span class="string">"SHOP!!!"</span>);</div><div class="line">        setContentView(tv);</div><div class="line"></div><div class="line">        Logger.dump(<span class="string">"TAG"</span>, <span class="string">"Hei! I am shop!!!"</span>);</div><div class="line">        UseContext.use(Application.get());</div><div class="line"></div><div class="line">        tv.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">                Toast.makeText(ShopActivity.<span class="keyword">this</span>, getResources().getString(R.string.click_notice), Toast.LENGTH_SHORT).show();</div><div class="line">                <span class="keyword">if</span> (Router.resolveRouter(ActivityRule.ACTIVITY_SCHEME + <span class="string">"org.loader.bbslib.BBSActivity"</span>)) &#123;</div><div class="line">                    Intent it = org.loader.router.Router.invoke(ShopActivity.<span class="keyword">this</span>, ActivityRule.ACTIVITY_SCHEME + <span class="string">"org.loader.bbslib.BBSActivity"</span>);</div><div class="line">                    startActivity(it);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到这里通过Shop对象完成模块的注册,最后在textView的跳转是调用 <em>Router的invoke</em> 方法来找到bbs的制定页面.<br>这里的注册用是 <em>StaticRouter</em> 所以要写完整的URI路径.</p>
<h3 id="bbs工程"><a href="#bbs工程" class="headerlink" title="bbs工程"></a>bbs工程</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span>(<span class="string">"bbs"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BBS</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@AutoRouter</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BBSActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        TextView tv = <span class="keyword">new</span> TextView(<span class="keyword">this</span>);</div><div class="line">        tv.setTextSize(<span class="number">50</span>);</div><div class="line">        tv.setText(<span class="string">"BBS!!!"</span>);</div><div class="line">        setContentView(tv);</div><div class="line"></div><div class="line">        Logger.dump(<span class="string">"TAG"</span>, <span class="string">"Hei! I am bbs!!!"</span>);</div><div class="line">        UseContext.use(Application.get());</div><div class="line"></div><div class="line">        tv.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">                Toast.makeText(BBSActivity.<span class="keyword">this</span>, getResources().getString(R.string.click_notice), Toast.LENGTH_SHORT).show();</div><div class="line">                <span class="keyword">if</span> (Router.resolveRouter(ActivityRule.ACTIVITY_SCHEME + <span class="string">"shop.main"</span>)) &#123;</div><div class="line">                    Intent it = Router.invoke(BBSActivity.<span class="keyword">this</span>, ActivityRule.ACTIVITY_SCHEME + <span class="string">"shop.main"</span>);</div><div class="line">                    startActivity(it);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里的注册用的 <em>AutoRouter</em> 所以不需要写URI,自动生成的URI是 类型+类的全路径</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>可以看到 Router结构实际上就是通过一个URI找到对方的制定类.结构非常简单.之所以用了多点的时间主要是用来消化注解的相关处理逻辑,用着方便,但是要理解还是要话点时间的.<br>不过这种通过注解来生成中间类,最终达到解耦目的的思路非常值得尝试.开阔了视野.</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a href="https://github.com/qibin0506/Module2Module" title="Module2Module" target="_blank" rel="external">Module2Module</a></p>
<p><a href="http://blog.csdn.net/qibin0506/article/details/53373412" title="Android路由实现" target="_blank" rel="external">Android路由实现</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://pheobusyy.github.io/2017/01/04/2017/java线程池源码分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanyi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pheobusyy">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/04/2017/java线程池源码分析/" itemprop="url">
                  java线程池源码分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-04T08:27:00+08:00">
                2017-01-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="java线程池源码分析"><a href="#java线程池源码分析" class="headerlink" title="java线程池源码分析"></a>java线程池源码分析</h2><h3 id="Executor接口"><a href="#Executor接口" class="headerlink" title="Executor接口"></a>Executor接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Executor</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable command)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>线程池的基础接口</p>
<h3 id="ExecutorService接口方法"><a href="#ExecutorService接口方法" class="headerlink" title="ExecutorService接口方法"></a>ExecutorService接口方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ExecutorService</span> <span class="keyword">extends</span> <span class="title">Executor</span> </span>&#123;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function">List&lt;Runnable&gt; <span class="title">shutdownNow</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isShutdown</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isTerminated</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">awaitTermination</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span></span></div><div class="line">        <span class="keyword">throws</span> InterruptedException;</div><div class="line"></div><div class="line"></div><div class="line">    &lt;T&gt; <span class="function">Future&lt;T&gt; <span class="title">submit</span><span class="params">(Callable&lt;T&gt; task)</span></span>;</div><div class="line"></div><div class="line"></div><div class="line">    &lt;T&gt; <span class="function">Future&lt;T&gt; <span class="title">submit</span><span class="params">(Runnable task, T result)</span></span>;</div><div class="line"></div><div class="line"></div><div class="line">    Future&lt;?&gt; submit(Runnable task);</div><div class="line"></div><div class="line"></div><div class="line">    &lt;T&gt; List&lt;Future&lt;T&gt;&gt; invokeAll(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks)</div><div class="line">        <span class="keyword">throws</span> InterruptedException;</div><div class="line"></div><div class="line">    &lt;T&gt; List&lt;Future&lt;T&gt;&gt; invokeAll(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks,</div><div class="line">                                  <span class="keyword">long</span> timeout, TimeUnit unit)</div><div class="line">        <span class="keyword">throws</span> InterruptedException;</div><div class="line"></div><div class="line">    &lt;T&gt; <span class="function">T <span class="title">invokeAny</span><span class="params">(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks)</span></span></div><div class="line">        <span class="keyword">throws</span> InterruptedException, ExecutionException;</div><div class="line"></div><div class="line"></div><div class="line">    &lt;T&gt; <span class="function">T <span class="title">invokeAny</span><span class="params">(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks,</span></span></div><div class="line">                    <span class="keyword">long</span> timeout, TimeUnit unit)</div><div class="line">        <span class="keyword">throws</span> InterruptedException, ExecutionException, TimeoutException;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>线程池相关操作的定义接口</p>
<h3 id="RunnableFuture-接口"><a href="#RunnableFuture-接口" class="headerlink" title="RunnableFuture 接口"></a>RunnableFuture 接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RunnableFuture</span>&lt;<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">Runnable</span>, <span class="title">Future</span>&lt;<span class="title">V</span>&gt; </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Sets this Future to the result of its computation</div><div class="line">     * unless it has been cancelled.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过适配器把两个不相关的对象组合在一起了.</p>
<h3 id="Future-和-FutureTask"><a href="#Future-和-FutureTask" class="headerlink" title="Future 和 FutureTask"></a>Future 和 FutureTask</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Future</span>&lt;<span class="title">V</span>&gt; </span>&#123;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">cancel</span><span class="params">(<span class="keyword">boolean</span> mayInterruptIfRunning)</span></span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isCancelled</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isDone</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function">V <span class="title">get</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException</span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function">V <span class="title">get</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span></span></div><div class="line">        <span class="keyword">throws</span> InterruptedException, ExecutionException, TimeoutException;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>FutureTask是实现返回值的关键类,里面的核心方法就是 <em>get</em> 方法,下面来看一下具体实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException </span>&#123;</div><div class="line">       <span class="keyword">int</span> s = state;</div><div class="line">       <span class="keyword">if</span> (s &lt;= COMPLETING)</div><div class="line">           s = awaitDone(<span class="keyword">false</span>, <span class="number">0L</span>);</div><div class="line">       <span class="keyword">return</span> report(s);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line">    * <span class="doctag">@throws</span> CancellationException &#123;<span class="doctag">@inheritDoc</span>&#125;</div><div class="line">    */</div><div class="line">   <span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span></span></div><div class="line">       <span class="keyword">throws</span> InterruptedException, ExecutionException, TimeoutException &#123;</div><div class="line">       <span class="keyword">if</span> (unit == <span class="keyword">null</span>)</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">       <span class="keyword">int</span> s = state;</div><div class="line">       <span class="keyword">if</span> (s &lt;= COMPLETING &amp;&amp;</div><div class="line">           (s = awaitDone(<span class="keyword">true</span>, unit.toNanos(timeout))) &lt;= COMPLETING)</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> TimeoutException();</div><div class="line">       <span class="keyword">return</span> report(s);</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>很明显的就是通过state的状态来判断是否需要返回结果,还没有完成就进入 <em>awaitDone</em> ,目的是为了在结果没有返回的时候阻塞等待.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">awaitDone</span><span class="params">(<span class="keyword">boolean</span> timed, <span class="keyword">long</span> nanos)</span></span></div><div class="line">       <span class="keyword">throws</span> InterruptedException &#123;</div><div class="line">       <span class="comment">// The code below is very delicate, to achieve these goals:</span></div><div class="line">       <span class="comment">// - call nanoTime exactly once for each call to park</span></div><div class="line">       <span class="comment">// - if nanos &lt;= 0, return promptly without allocation or nanoTime</span></div><div class="line">       <span class="comment">// - if nanos == Long.MIN_VALUE, don't underflow</span></div><div class="line">       <span class="comment">// - if nanos == Long.MAX_VALUE, and nanoTime is non-monotonic</span></div><div class="line">       <span class="comment">//   and we suffer a spurious wakeup, we will do no worse than</span></div><div class="line">       <span class="comment">//   to park-spin for a while</span></div><div class="line">       <span class="keyword">long</span> startTime = <span class="number">0L</span>;    <span class="comment">// Special value 0L means not yet parked</span></div><div class="line">       WaitNode q = <span class="keyword">null</span>;</div><div class="line">       <span class="keyword">boolean</span> queued = <span class="keyword">false</span>;</div><div class="line">       <span class="keyword">for</span> (;;) &#123;</div><div class="line">           <span class="keyword">int</span> s = state;</div><div class="line">           <span class="keyword">if</span> (s &gt; COMPLETING) &#123;</div><div class="line">               <span class="keyword">if</span> (q != <span class="keyword">null</span>)</div><div class="line">                   q.thread = <span class="keyword">null</span>;</div><div class="line">               <span class="keyword">return</span> s;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (s == COMPLETING)</div><div class="line">               <span class="comment">// We may have already promised (via isDone) that we are done</span></div><div class="line">               <span class="comment">// so never return empty-handed or throw InterruptedException</span></div><div class="line">               Thread.yield();</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (Thread.interrupted()) &#123;</div><div class="line">               removeWaiter(q);</div><div class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (q == <span class="keyword">null</span>) &#123;</div><div class="line">               <span class="keyword">if</span> (timed &amp;&amp; nanos &lt;= <span class="number">0L</span>)</div><div class="line">                   <span class="keyword">return</span> s;</div><div class="line">               q = <span class="keyword">new</span> WaitNode();</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (!queued)</div><div class="line">               queued = U.compareAndSwapObject(<span class="keyword">this</span>, WAITERS,</div><div class="line">                                               q.next = waiters, q);</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (timed) &#123;</div><div class="line">               <span class="keyword">final</span> <span class="keyword">long</span> parkNanos;</div><div class="line">               <span class="keyword">if</span> (startTime == <span class="number">0L</span>) &#123; <span class="comment">// first time</span></div><div class="line">                   startTime = System.nanoTime();</div><div class="line">                   <span class="keyword">if</span> (startTime == <span class="number">0L</span>)</div><div class="line">                       startTime = <span class="number">1L</span>;</div><div class="line">                   parkNanos = nanos;</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   <span class="keyword">long</span> elapsed = System.nanoTime() - startTime;</div><div class="line">                   <span class="keyword">if</span> (elapsed &gt;= nanos) &#123;</div><div class="line">                       removeWaiter(q);</div><div class="line">                       <span class="keyword">return</span> state;</div><div class="line">                   &#125;</div><div class="line">                   parkNanos = nanos - elapsed;</div><div class="line">               &#125;</div><div class="line">               <span class="comment">// nanoTime may be slow; recheck before parking</span></div><div class="line">               <span class="keyword">if</span> (state &lt; COMPLETING)</div><div class="line">                   LockSupport.parkNanos(<span class="keyword">this</span>, parkNanos);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span></div><div class="line">               LockSupport.park(<span class="keyword">this</span>);</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>具体的细节就不说了,最终就是如果状态是运行中的话就阻塞线程等待,直到那边run方法执行完成之后,修改线程状态:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">if</span> (state != NEW ||</div><div class="line">          !U.compareAndSwapObject(<span class="keyword">this</span>, RUNNER, <span class="keyword">null</span>, Thread.currentThread()))</div><div class="line">          <span class="keyword">return</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">          Callable&lt;V&gt; c = callable;</div><div class="line">          <span class="keyword">if</span> (c != <span class="keyword">null</span> &amp;&amp; state == NEW) &#123;</div><div class="line">              V result;</div><div class="line">              <span class="keyword">boolean</span> ran;</div><div class="line">              <span class="keyword">try</span> &#123;</div><div class="line">                  result = c.call();</div><div class="line">                  ran = <span class="keyword">true</span>;</div><div class="line">              &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</div><div class="line">                  result = <span class="keyword">null</span>;</div><div class="line">                  ran = <span class="keyword">false</span>;</div><div class="line">                  setException(ex);</div><div class="line">              &#125;</div><div class="line">              <span class="keyword">if</span> (ran)</div><div class="line">                  set(result);</div><div class="line">          &#125;</div><div class="line">      &#125; <span class="keyword">finally</span> &#123;</div><div class="line">          <span class="comment">// runner must be non-null until state is settled to</span></div><div class="line">          <span class="comment">// prevent concurrent calls to run()</span></div><div class="line">          runner = <span class="keyword">null</span>;</div><div class="line">          <span class="comment">// state must be re-read after nulling runner to prevent</span></div><div class="line">          <span class="comment">// leaked interrupts</span></div><div class="line">          <span class="keyword">int</span> s = state;</div><div class="line">          <span class="keyword">if</span> (s &gt;= INTERRUPTING)</div><div class="line">              handlePossibleCancellationInterrupt(s);</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>执行完成之后进入set(result):<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(V v)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, STATE, NEW, COMPLETING)) &#123;</div><div class="line">           outcome = v;</div><div class="line">           U.putOrderedInt(<span class="keyword">this</span>, STATE, NORMAL); <span class="comment">// final state</span></div><div class="line">           finishCompletion();</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">finishCompletion</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="comment">// assert state &gt; COMPLETING;</span></div><div class="line">      <span class="keyword">for</span> (WaitNode q; (q = waiters) != <span class="keyword">null</span>;) &#123;</div><div class="line">          <span class="keyword">if</span> (U.compareAndSwapObject(<span class="keyword">this</span>, WAITERS, q, <span class="keyword">null</span>)) &#123;</div><div class="line">              <span class="keyword">for</span> (;;) &#123;</div><div class="line">                  Thread t = q.thread;</div><div class="line">                  <span class="keyword">if</span> (t != <span class="keyword">null</span>) &#123;</div><div class="line">                      q.thread = <span class="keyword">null</span>;</div><div class="line">                      LockSupport.unpark(t);</div><div class="line">                  &#125;</div><div class="line">                  WaitNode next = q.next;</div><div class="line">                  <span class="keyword">if</span> (next == <span class="keyword">null</span>)</div><div class="line">                      <span class="keyword">break</span>;</div><div class="line">                  q.next = <span class="keyword">null</span>; <span class="comment">// unlink to help gc</span></div><div class="line">                  q = next;</div><div class="line">              &#125;</div><div class="line">              <span class="keyword">break</span>;</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      done();</div><div class="line"></div><div class="line">      callable = <span class="keyword">null</span>;        <span class="comment">// to reduce footprint</span></div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>在这里唤醒线程,通知get方法,已经完成处理了,可以获取返回值了.</p>
<h3 id="ThreadPoolExecutor"><a href="#ThreadPoolExecutor" class="headerlink" title="ThreadPoolExecutor"></a>ThreadPoolExecutor</h3><p>ThreadPoolExecutor中的一个难点是在如何通过一个int值来代表两个作用,一个是线程池状态,一个是线程池运行任务的个数.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger ctl = <span class="keyword">new</span> AtomicInteger(ctlOf(RUNNING, <span class="number">0</span>));</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COUNT_BITS = Integer.SIZE - <span class="number">3</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CAPACITY   = (<span class="number">1</span> &lt;&lt; COUNT_BITS) - <span class="number">1</span>;</div><div class="line"></div><div class="line"><span class="comment">// runState is stored in the high-order bits</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RUNNING    = -<span class="number">1</span> &lt;&lt; COUNT_BITS;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SHUTDOWN   =  <span class="number">0</span> &lt;&lt; COUNT_BITS;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STOP       =  <span class="number">1</span> &lt;&lt; COUNT_BITS;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TIDYING    =  <span class="number">2</span> &lt;&lt; COUNT_BITS;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TERMINATED =  <span class="number">3</span> &lt;&lt; COUNT_BITS;</div><div class="line"></div><div class="line"><span class="comment">// Packing and unpacking ctl</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">runStateOf</span><span class="params">(<span class="keyword">int</span> c)</span>     </span>&#123; <span class="keyword">return</span> c &amp; ~CAPACITY; &#125;</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">workerCountOf</span><span class="params">(<span class="keyword">int</span> c)</span>  </span>&#123; <span class="keyword">return</span> c &amp; CAPACITY; &#125;</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">ctlOf</span><span class="params">(<span class="keyword">int</span> rs, <span class="keyword">int</span> wc)</span> </span>&#123; <span class="keyword">return</span> rs | wc; &#125;</div></pre></td></tr></table></figure></p>
<p>把一个int值的高位3为作为线程池的状态,后面的29位作为线程池的任务个数.<br>这里的 <em>COUNT_BITS</em> 是29,那么 <em>CAPACITY</em> 就是 00011111111111111111111111111111 ,这样 <em>~CAPACITY</em> 为 11100000000000000000000000000000,这样通过与操作就可以分别处理两个属性了.非常的巧妙.</p>
<p>然后要明白两个重要的属性 <em>corePoolSize</em> 和 <em>maximumPoolSize</em> . corePoolSize是用来表示当前允许运行的最小任务个数,也叫核心任务数.maximumPoolSize是指线程池运行运行的最大任务数.</p>
<p>正常情况下,如果没有满足 corePoolSize 的话就创建新的 <em>worker</em> 然后执行,如果超过了 corePoolSize 的话一般是进入阻塞队列中等待.如果连阻塞队列都满了的话,尝试在创建新的线程来执行任务,前提是运行的任务数不能超过最大的任务数,也就是 maximumPoolSize .这就是两个size的作用.4中不同的线程池类型的区别主要就在这两个参数上面.<br>举个例子,比如现在总共有12个任务, corePoolSize 为2,阻塞队列容量为5,最大线程数 maximumPoolSize为10,那首先会优先满足corePoolSize ,1号,2号运行,然后剩下的5个也就是,3,4,5,6,7进入阻塞队列,然后8,9,10号创建新线程来执行填满最大线程数,还剩下的11,12就不予执行了.</p>
<p>上面的这个流程就是线程池的核心流程原理,下面来看具体的代码实现:<br>ThreadPoolExecutor调用任务有两个方法一个是submit,一个是execute,二者的唯一区别就是submit有返回值,但是内部都是调用了execute方法.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">Future&lt;T&gt; <span class="title">submit</span><span class="params">(Runnable task, T result)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (task == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">       RunnableFuture&lt;T&gt; ftask = newTaskFor(task, result);</div><div class="line">       execute(ftask);</div><div class="line">       <span class="keyword">return</span> ftask;</div><div class="line">   &#125;</div><div class="line"></div><div class="line"></div><div class="line">   <span class="keyword">public</span> &lt;T&gt; <span class="function">Future&lt;T&gt; <span class="title">submit</span><span class="params">(Callable&lt;T&gt; task)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (task == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">       RunnableFuture&lt;T&gt; ftask = newTaskFor(task);</div><div class="line">       execute(ftask);</div><div class="line">       <span class="keyword">return</span> ftask;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>这里传入的就是FutureTask对象啦,FutureTask的细节前面已经说过了,先看 <em>execute</em> 方法的实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable command)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (command == <span class="keyword">null</span>)</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">        <span class="comment">/*</span></div><div class="line">         * Proceed in 3 steps:</div><div class="line">         *</div><div class="line">         * 1. If fewer than corePoolSize threads are running, try to</div><div class="line">         * start a new thread with the given command as its first</div><div class="line">         * task.  The call to addWorker atomically checks runState and</div><div class="line">         * workerCount, and so prevents false alarms that would add</div><div class="line">         * threads when it shouldn't, by returning false.</div><div class="line">         *</div><div class="line">         * 如果要执行的任务数量小于corePoolSize,直接通过调用addWorker方法来执行任务.</div><div class="line">         *</div><div class="line">         * 2. If a task can be successfully queued, then we still need</div><div class="line">         * to double-check whether we should have added a thread</div><div class="line">         * (because existing ones died since last checking) or that</div><div class="line">         * the pool shut down since entry into this method. So we</div><div class="line">         * recheck state and if necessary roll back the enqueuing if</div><div class="line">         * stopped, or start a new thread if there are none.</div><div class="line">         *</div><div class="line">         * 如果线程池处于运行状态并且任务成功的进入阻塞队列,二次检查线程池的状态,如果状态变为非运行的时候,尝试回退任务</div><div class="line">         * 如果运行中的任务个数为0,运行一个空的任务到addWorker</div><div class="line">         *</div><div class="line">         * 3. If we cannot queue task, then we try to add a new</div><div class="line">         * thread.  If it fails, we know we are shut down or saturated</div><div class="line">         * and so reject the task.</div><div class="line">         * 如果不能入列,那尝试直接通过addWorker运行任务,如果失败说明线程池已经停止了或者已经满了,拒绝任务</div><div class="line">         */</div><div class="line">        <span class="keyword">int</span> c = ctl.get();</div><div class="line">        <span class="keyword">if</span> (workerCountOf(c) &lt; corePoolSize) &#123;</div><div class="line">            <span class="keyword">if</span> (addWorker(command, <span class="keyword">true</span>))</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            c = ctl.get();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123;</div><div class="line">            <span class="keyword">int</span> recheck = ctl.get();</div><div class="line">            <span class="keyword">if</span> (! isRunning(recheck) &amp;&amp; remove(command))</div><div class="line">                reject(command);</div><div class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (workerCountOf(recheck) == <span class="number">0</span>)</div><div class="line">                addWorker(<span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!addWorker(command, <span class="keyword">false</span>))</div><div class="line">            reject(command);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>这里就对应上面的三种情况,核心任务数没满直接addWorker,如果满了就放入阻塞队列中,如果阻塞队列也满了尝试直接运行,那如何运行任务就进入addWorker方法了.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">addWorker</span><span class="params">(Runnable firstTask, <span class="keyword">boolean</span> core)</span> </span>&#123;</div><div class="line">      <span class="comment">/**</span></div><div class="line">      * 通过一个循环标示来控制一个两层的死循环</div><div class="line">      * 首先是判断线程池的状态,如果是停止或以上的状态直接返回false</div><div class="line">      * 另外就是前面的 *execute* 方法的传入的 *addWorker(null, false);* 这种情况下说明阻塞队列还有任务没有执行完成,所以要继续把阻塞队列里面的任务执行完才可以,这种情况就会进入底下的第二个循环里面.</div><div class="line">      * 第二个循环直接更改运行的线程数,如果成功就跳出循环,如果超出最大限制就返回false</div><div class="line">      * 如果发现线程池的状态变化了就重新更新一下</div><div class="line">      */</div><div class="line">       retry:</div><div class="line">       <span class="keyword">for</span> (;;) &#123;</div><div class="line">           <span class="keyword">int</span> c = ctl.get();</div><div class="line">           <span class="keyword">int</span> rs = runStateOf(c);</div><div class="line"></div><div class="line">           <span class="comment">// Check if queue empty only if necessary.</span></div><div class="line">           <span class="keyword">if</span> (rs &gt;= SHUTDOWN &amp;&amp;</div><div class="line">               ! (rs == SHUTDOWN &amp;&amp;</div><div class="line">                  firstTask == <span class="keyword">null</span> &amp;&amp;</div><div class="line">                  ! workQueue.isEmpty()))</div><div class="line">               <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"></div><div class="line">           <span class="keyword">for</span> (;;) &#123;</div><div class="line">               <span class="keyword">int</span> wc = workerCountOf(c);</div><div class="line">               <span class="keyword">if</span> (wc &gt;= CAPACITY ||</div><div class="line">                   wc &gt;= (core ? corePoolSize : maximumPoolSize))</div><div class="line">                   <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">               <span class="keyword">if</span> (compareAndIncrementWorkerCount(c))</div><div class="line">                   <span class="keyword">break</span> retry;</div><div class="line">               c = ctl.get();  <span class="comment">// Re-read ctl</span></div><div class="line">               <span class="keyword">if</span> (runStateOf(c) != rs)</div><div class="line">                   <span class="keyword">continue</span> retry;</div><div class="line">               <span class="comment">// else CAS failed due to workerCount change; retry inner loop</span></div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">        <span class="comment">/**</span></div><div class="line">        * 如果进入这里说明任务可以执行了</div><div class="line">        */</div><div class="line">       <span class="keyword">boolean</span> workerStarted = <span class="keyword">false</span>;</div><div class="line">       <span class="keyword">boolean</span> workerAdded = <span class="keyword">false</span>;</div><div class="line">       Worker w = <span class="keyword">null</span>;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">          <span class="comment">//包装一个worker对象</span></div><div class="line">           w = <span class="keyword">new</span> Worker(firstTask);</div><div class="line">           <span class="comment">//这里的Thread是通过线程池构造函数的ThreadFactory来创建出来的,这里的线程就是worker对象用来执行任务的线程对象,这个对象会陪伴着worker从生到死,不断的执行任务,如果阻塞队列中没有任务的时候,它会阻塞挂起,除非设置了keepAliveTime参数.</span></div><div class="line">           <span class="keyword">final</span> Thread t = w.thread;</div><div class="line">           <span class="keyword">if</span> (t != <span class="keyword">null</span>) &#123;</div><div class="line">               <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</div><div class="line">               mainLock.lock();</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   <span class="comment">// Recheck while holding lock.</span></div><div class="line">                   <span class="comment">// Back out on ThreadFactory failure or if</span></div><div class="line">                   <span class="comment">// shut down before lock acquired.</span></div><div class="line">                   <span class="keyword">int</span> rs = runStateOf(ctl.get());</div><div class="line">                    <span class="comment">//运行态或者停止之后但是阻塞队列还有任务没有完成,设置workerAdded true</span></div><div class="line">                   <span class="keyword">if</span> (rs &lt; SHUTDOWN ||</div><div class="line">                       (rs == SHUTDOWN &amp;&amp; firstTask == <span class="keyword">null</span>)) &#123;</div><div class="line">                       <span class="keyword">if</span> (t.isAlive()) <span class="comment">// precheck that t is startable</span></div><div class="line">                           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalThreadStateException();</div><div class="line">                       workers.add(w);</div><div class="line">                       <span class="keyword">int</span> s = workers.size();</div><div class="line">                       <span class="comment">//设置当前最大的运行任务数</span></div><div class="line">                       <span class="keyword">if</span> (s &gt; largestPoolSize)</div><div class="line">                           largestPoolSize = s;</div><div class="line">                       workerAdded = <span class="keyword">true</span>;</div><div class="line">                   &#125;</div><div class="line">               &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                   mainLock.unlock();</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">if</span> (workerAdded) &#123;</div><div class="line">                 <span class="comment">//这里调用worker线程的start方法,最后进入了 *runWorker* 方法</span></div><div class="line">                   t.start();</div><div class="line">                   workerStarted = <span class="keyword">true</span>;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">finally</span> &#123;</div><div class="line">           <span class="keyword">if</span> (! workerStarted)</div><div class="line">               addWorkerFailed(w);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> workerStarted;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>当调用worker的中线程的start方法实际上进入了runWorker方法中,先看下work对象的实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Worker</span></span></div><div class="line">      <span class="keyword">extends</span> <span class="title">AbstractQueuedSynchronizer</span></div><div class="line">      <span class="keyword">implements</span> <span class="title">Runnable</span></div><div class="line">  &#123;</div><div class="line">      <span class="comment">/**</span></div><div class="line">       * This class will never be serialized, but we provide a</div><div class="line">       * serialVersionUID to suppress a javac warning.</div><div class="line">       */</div><div class="line">      <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">6138294804551838833L</span>;</div><div class="line"></div><div class="line">      <span class="comment">/** Thread this worker is running in.  Null if factory fails. */</span></div><div class="line">      <span class="keyword">final</span> Thread thread;</div><div class="line">      <span class="comment">/** Initial task to run.  Possibly null. */</span></div><div class="line">      Runnable firstTask;</div><div class="line">      <span class="comment">/** Per-thread task counter */</span></div><div class="line">      <span class="keyword">volatile</span> <span class="keyword">long</span> completedTasks;</div><div class="line"></div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Creates with given first task and thread from ThreadFactory.</div><div class="line">       * <span class="doctag">@param</span> firstTask the first task (null if none)</div><div class="line">       */</div><div class="line">      Worker(Runnable firstTask) &#123;</div><div class="line">          setState(-<span class="number">1</span>); <span class="comment">// inhibit interrupts until runWorker</span></div><div class="line">          <span class="keyword">this</span>.firstTask = firstTask;</div><div class="line">          <span class="keyword">this</span>.thread = getThreadFactory().newThread(<span class="keyword">this</span>);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">/** Delegates main run loop to outer runWorker. */</span></div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">          runWorker(<span class="keyword">this</span>);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// Lock methods</span></div><div class="line">      <span class="comment">//</span></div><div class="line">      <span class="comment">// The value 0 represents the unlocked state.</span></div><div class="line">      <span class="comment">// The value 1 represents the locked state.</span></div><div class="line"></div><div class="line">      <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isHeldExclusively</span><span class="params">()</span> </span>&#123;</div><div class="line">          <span class="keyword">return</span> getState() != <span class="number">0</span>;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> unused)</span> </span>&#123;</div><div class="line">          <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>)) &#123;</div><div class="line">              setExclusiveOwnerThread(Thread.currentThread());</div><div class="line">              <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">tryRelease</span><span class="params">(<span class="keyword">int</span> unused)</span> </span>&#123;</div><div class="line">          setExclusiveOwnerThread(<span class="keyword">null</span>);</div><div class="line">          setState(<span class="number">0</span>);</div><div class="line">          <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span>        </span>&#123; acquire(<span class="number">1</span>); &#125;</div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">()</span>  </span>&#123; <span class="keyword">return</span> tryAcquire(<span class="number">1</span>); &#125;</div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span>      </span>&#123; release(<span class="number">1</span>); &#125;</div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isLocked</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> isHeldExclusively(); &#125;</div><div class="line"></div><div class="line">      <span class="function"><span class="keyword">void</span> <span class="title">interruptIfStarted</span><span class="params">()</span> </span>&#123;</div><div class="line">          Thread t;</div><div class="line">          <span class="keyword">if</span> (getState() &gt;= <span class="number">0</span> &amp;&amp; (t = thread) != <span class="keyword">null</span> &amp;&amp; !t.isInterrupted()) &#123;</div><div class="line">              <span class="keyword">try</span> &#123;</div><div class="line">                  t.interrupt();</div><div class="line">              &#125; <span class="keyword">catch</span> (SecurityException ignore) &#123;</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>worker是一个AQS的简单实现,其中要注意的就是它的构造函数,首先通过setState(-1)来把对象锁定,防止中断操作,然后就是thread对象,这里是通过ThreadFactory的newThread来创建出来的新线程,这个线程用来调用传入线程池的任务,相当于任务的载体.这个Thread对象就是worker用来执行任务的环境了,它会和worker一起丛生到死.</p>
<p>线程池是是如何减少了线程的创建的呢?<br>比如我有100个任务,那你直接调用100个任务的start方法相当于创建了100个线程对不对.而交给线程池却不会傻傻的创建100个线程对象,它会创建你设置的 <em>corePoolSize</em> 个worker对象,在worker对象的Thread中来执行任务代码,也就是说每个worker对象不仅仅只是运行一个任务就完了,它会不断的运行任务,从阻塞队列中不断的去取任务,直到没有任务给它处理为止.这个时候它会阻塞,一直等着阻塞队列有数据进来.</p>
<p>注意这里说的worker对象不止执行一个任务是理解线程池的关键.通过这样才能减少线程的创建和消耗,重点要理解worker是怎么处理任务的.下面我们来看runWorker方法的实现:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">runWorker</span><span class="params">(Worker w)</span> </span>&#123;</div><div class="line">        Thread wt = Thread.currentThread();</div><div class="line">        Runnable task = w.firstTask;</div><div class="line">        w.firstTask = <span class="keyword">null</span>;</div><div class="line">        w.unlock(); <span class="comment">// allow interrupts</span></div><div class="line">        <span class="keyword">boolean</span> completedAbruptly = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          <span class="comment">//这里getTask是从阻塞队列中取没有运行的任务,一直到阻塞队列中没有数据为止</span></div><div class="line">            <span class="keyword">while</span> (task != <span class="keyword">null</span> || (task = getTask()) != <span class="keyword">null</span>) &#123;</div><div class="line">                w.lock();</div><div class="line">                <span class="comment">// If pool is stopping, ensure thread is interrupted;</span></div><div class="line">                <span class="comment">// if not, ensure thread is not interrupted.  This</span></div><div class="line">                <span class="comment">// requires a recheck in second case to deal with</span></div><div class="line">            <span class="comment">// shutdownNow race while clearing interrupt</span></div><div class="line">                <span class="keyword">if</span> ((runStateAtLeast(ctl.get(), STOP) ||</div><div class="line">                     (Thread.interrupted() &amp;&amp;</div><div class="line">                      runStateAtLeast(ctl.get(), STOP))) &amp;&amp;</div><div class="line">                    !wt.isInterrupted())</div><div class="line">                    wt.interrupt();</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                  <span class="comment">//这个方法是个钩子函数</span></div><div class="line">                    beforeExecute(wt, task);</div><div class="line">                    Throwable thrown = <span class="keyword">null</span>;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                      <span class="comment">//运行任务</span></div><div class="line">                        task.run();</div><div class="line">                    &#125; <span class="keyword">catch</span> (RuntimeException x) &#123;</div><div class="line">                        thrown = x; <span class="keyword">throw</span> x;</div><div class="line">                    &#125; <span class="keyword">catch</span> (Error x) &#123;</div><div class="line">                        thrown = x; <span class="keyword">throw</span> x;</div><div class="line">                    &#125; <span class="keyword">catch</span> (Throwable x) &#123;</div><div class="line">                        thrown = x; <span class="keyword">throw</span> <span class="keyword">new</span> Error(x);</div><div class="line">                    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                        afterExecute(task, thrown);</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                    task = <span class="keyword">null</span>;</div><div class="line">                    w.completedTasks++;</div><div class="line">                    w.unlock();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            completedAbruptly = <span class="keyword">false</span>;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            processWorkerExit(w, completedAbruptly);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>这里就是调用任务的核心所在了,之所以有这么代码判断是为了处理线程池状态的变化的,比如正在运行任务的过程中,线程池调用了shutDown方法或者shutDownNow方法的时候,要协调这些任务的运行状态.<br>方法中while的判断,如果worker中的task为空的时候,就对应上面addWorker的时候线程池已经停止了,但是在阻塞队列中还是有任务,就得把阻塞队列中的任务取出来处理.这里就调用的是 <em>getTask</em> 方法,从阻塞队列中取任务.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Runnable <span class="title">getTask</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">boolean</span> timedOut = <span class="keyword">false</span>; <span class="comment">// Did the last poll() time out?</span></div><div class="line"></div><div class="line">        <span class="keyword">for</span> (;;) &#123;</div><div class="line">            <span class="keyword">int</span> c = ctl.get();</div><div class="line">            <span class="keyword">int</span> rs = runStateOf(c);</div><div class="line"></div><div class="line">            <span class="comment">// Check if queue empty only if necessary.</span></div><div class="line">            <span class="keyword">if</span> (rs &gt;= SHUTDOWN &amp;&amp; (rs &gt;= STOP || workQueue.isEmpty())) &#123;</div><div class="line">                decrementWorkerCount();</div><div class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">int</span> wc = workerCountOf(c);</div><div class="line"></div><div class="line">            <span class="comment">// Are workers subject to culling?</span></div><div class="line">            <span class="keyword">boolean</span> timed = allowCoreThreadTimeOut || wc &gt; corePoolSize;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> ((wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut))</div><div class="line">                &amp;&amp; (wc &gt; <span class="number">1</span> || workQueue.isEmpty())) &#123;</div><div class="line">                <span class="keyword">if</span> (compareAndDecrementWorkerCount(c))</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">              <span class="comment">//从阻塞队列中获取一个任务</span></div><div class="line">                Runnable r = timed ?</div><div class="line">                    workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :</div><div class="line">                    workQueue.take();</div><div class="line">                <span class="keyword">if</span> (r != <span class="keyword">null</span>)</div><div class="line">                    <span class="keyword">return</span> r;</div><div class="line">                timedOut = <span class="keyword">true</span>;</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException retry) &#123;</div><div class="line">                timedOut = <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>这样就保证了只要worker活着它就会不断的从阻塞队列取数据并执行,这种阻塞了等待着执行任务的worker成为IdleWorker,也是在后面会被回收的worker对象.在每次执行完成任务之后来判断一下是不是需要回收闲置的worker对象.关键点就在这里的 <em>workQueue.poll</em> 和 <em>workQueue.take</em> ,poll支持超时,如果在指定的 <em>keepAliveTime</em> 的时间内,阻塞队列中还是没有数据,那么就返回null,如果是 <em>take</em> 的话,就会阻塞,等待有新的数据进入阻塞队列中.这个关键点是实现后面要讲的 <em>newCachedThreadPool</em> 关键所在.也就是在keepAliveTime的时间内,还是没有新的任务,那么这个worker对象就会被回收.<br>最后,如果是设置了keepAliveTime的话,超时没有取到数据,就会设置timedOut为true,再次进入上面的 <em>timed &amp;&amp; timedOut</em> 就会满足条件了,然后返回null,回到上面的runWoker的while循环并跳出,交给下面的 <em>processWorkerExit</em> 方法.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processWorkerExit</span><span class="params">(Worker w, <span class="keyword">boolean</span> completedAbruptly)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (completedAbruptly) <span class="comment">// If abrupt, then workerCount wasn't adjusted</span></div><div class="line">            decrementWorkerCount();</div><div class="line"></div><div class="line">        <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</div><div class="line">        mainLock.lock();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            completedTaskCount += w.completedTasks;</div><div class="line">            workers.remove(w);</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            mainLock.unlock();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        tryTerminate();</div><div class="line"></div><div class="line">        <span class="keyword">int</span> c = ctl.get();</div><div class="line">        <span class="keyword">if</span> (runStateLessThan(c, STOP)) &#123;</div><div class="line">            <span class="keyword">if</span> (!completedAbruptly) &#123;</div><div class="line">                <span class="keyword">int</span> min = allowCoreThreadTimeOut ? <span class="number">0</span> : corePoolSize;</div><div class="line">                <span class="keyword">if</span> (min == <span class="number">0</span> &amp;&amp; ! workQueue.isEmpty())</div><div class="line">                    min = <span class="number">1</span>;</div><div class="line">                <span class="keyword">if</span> (workerCountOf(c) &gt;= min)</div><div class="line">                    <span class="keyword">return</span>; <span class="comment">// replacement not needed</span></div><div class="line">            &#125;</div><div class="line">            addWorker(<span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>这里通过重入锁锁定之后修改workers集合的数据,把运行完成的worker移除.如果线程池还没到stop的状态,继续调用addWorker执行阻塞队列中的任务.同时还尝试结束线程池,再来看其中的 <em>tryTerminate</em> 方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">tryTerminate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (;;) &#123;</div><div class="line">            <span class="keyword">int</span> c = ctl.get();</div><div class="line">            <span class="keyword">if</span> (isRunning(c) ||</div><div class="line">                runStateAtLeast(c, TIDYING) ||</div><div class="line">                (runStateOf(c) == SHUTDOWN &amp;&amp; ! workQueue.isEmpty()))</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            <span class="keyword">if</span> (workerCountOf(c) != <span class="number">0</span>) &#123; <span class="comment">// Eligible to terminate</span></div><div class="line">                interruptIdleWorkers(ONLY_ONE);</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</div><div class="line">            mainLock.lock();</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">if</span> (ctl.compareAndSet(c, ctlOf(TIDYING, <span class="number">0</span>))) &#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                      <span class="comment">//空方法,没有实现</span></div><div class="line">                        terminated();</div><div class="line">                    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                        ctl.set(ctlOf(TERMINATED, <span class="number">0</span>));</div><div class="line">                        termination.signalAll();</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">return</span>;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                mainLock.unlock();</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// else retry on failed CAS</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>如果现在状态是shutDown,但是阻塞队列中还是有任务就退出,不中止线程池.如果核心线程还是有在运行的时候,调用 <em>interruptIdleWorkers</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">interruptIdleWorkers</span><span class="params">(<span class="keyword">boolean</span> onlyOne)</span> </span>&#123;</div><div class="line">      <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</div><div class="line">      mainLock.lock();</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">          <span class="keyword">for</span> (Worker w : workers) &#123;</div><div class="line">              Thread t = w.thread;</div><div class="line">              <span class="keyword">if</span> (!t.isInterrupted() &amp;&amp; w.tryLock()) &#123;</div><div class="line">                  <span class="keyword">try</span> &#123;</div><div class="line">                      t.interrupt();</div><div class="line">                  &#125; <span class="keyword">catch</span> (SecurityException ignore) &#123;</div><div class="line">                  &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                      w.unlock();</div><div class="line">                  &#125;</div><div class="line">              &#125;</div><div class="line">              <span class="keyword">if</span> (onlyOne)</div><div class="line">                  <span class="keyword">break</span>;</div><div class="line">          &#125;</div><div class="line">      &#125; <span class="keyword">finally</span> &#123;</div><div class="line">          mainLock.unlock();</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>如果是空闲线程,也就是没有任务在运行,所以可以获得锁,就把worker所在的线程中断.</p>
<p>到这里,就会引出两个中断方法的差异,shutDown和showDownNow的区别是:shutDown是中断之后,后续的加入的任务就无法直接运行了,已经在运行和阻塞队列中的还是会继续执行,而shutDownNow是直接中断全部的任务,不管是否在队列中,也不管是否在运行;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</div><div class="line">        mainLock.lock();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            checkShutdownAccess();</div><div class="line">            advanceRunState(SHUTDOWN);</div><div class="line">            interruptIdleWorkers();</div><div class="line">            onShutdown(); <span class="comment">// hook for ScheduledThreadPoolExecutor</span></div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            mainLock.unlock();</div><div class="line">        &#125;</div><div class="line">        tryTerminate();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>可以看到这里调用的是 <em>interruptIdleWorkers</em> 方法.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> List&lt;Runnable&gt; <span class="title">shutdownNow</span><span class="params">()</span> </span>&#123;</div><div class="line">       List&lt;Runnable&gt; tasks;</div><div class="line">       <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</div><div class="line">       mainLock.lock();</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           checkShutdownAccess();</div><div class="line">           advanceRunState(STOP);</div><div class="line">           interruptWorkers();</div><div class="line">           tasks = drainQueue();</div><div class="line">       &#125; <span class="keyword">finally</span> &#123;</div><div class="line">           mainLock.unlock();</div><div class="line">       &#125;</div><div class="line">       tryTerminate();</div><div class="line">       <span class="keyword">return</span> tasks;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">interruptWorkers</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</div><div class="line">       mainLock.lock();</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="keyword">for</span> (Worker w : workers)</div><div class="line">               w.interruptIfStarted();</div><div class="line">       &#125; <span class="keyword">finally</span> &#123;</div><div class="line">           mainLock.unlock();</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>然后回到worker的内部interruptIfStarted:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">interruptIfStarted</span><span class="params">()</span> </span>&#123;</div><div class="line">           Thread t;</div><div class="line">           <span class="keyword">if</span> (getState() &gt;= <span class="number">0</span> &amp;&amp; (t = thread) != <span class="keyword">null</span> &amp;&amp; !t.isInterrupted()) &#123;</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   t.interrupt();</div><div class="line">               &#125; <span class="keyword">catch</span> (SecurityException ignore) &#123;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div></pre></td></tr></table></figure></p>
<p>可以看到这里调用的 <em>interruptWorkers</em> 方法.这就是两个shutdown方法的区别所在.一个是中断空闲任务,一个是中断所有任务.</p>
<h3 id="newFixedThreadPool-newSingleThreadExecutor-newCachedThreadPool-newScheduledThreadPool-四种类型的区别"><a href="#newFixedThreadPool-newSingleThreadExecutor-newCachedThreadPool-newScheduledThreadPool-四种类型的区别" class="headerlink" title="newFixedThreadPool,newSingleThreadExecutor,newCachedThreadPool,newScheduledThreadPool 四种类型的区别"></a>newFixedThreadPool,newSingleThreadExecutor,newCachedThreadPool,newScheduledThreadPool 四种类型的区别</h3><p>这4种常用的线程池的创建都交给Executors来完成的,实际上就是创建了不同的ThreadPoolExecutor.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newFixedThreadPool</span><span class="params">(<span class="keyword">int</span> nThreads)</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> ThreadPoolExecutor(nThreads, nThreads,</div><div class="line">                                    <span class="number">0L</span>, TimeUnit.MILLISECONDS,</div><div class="line">                                    <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;());</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>可以看到核心任务数和最大任务数是一样的,那就是说线程池支持最多有 <em>nThreads</em> 个worker在运行,剩下的任务全部放入阻塞中,等待前面的任务完成后才取出来继续执行.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newSingleThreadExecutor</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> FinalizableDelegatedExecutorService</div><div class="line">           (<span class="keyword">new</span> ThreadPoolExecutor(<span class="number">1</span>, <span class="number">1</span>,</div><div class="line">                                   <span class="number">0L</span>, TimeUnit.MILLISECONDS,</div><div class="line">                                   <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;()));</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>可以看到核心线程和最大线程数都是1,也就是说同一时间只能有一个任务执行,后续的任务挨个按顺序执行.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newCachedThreadPool</span><span class="params">(ThreadFactory threadFactory)</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">0</span>, Integer.MAX_VALUE,</div><div class="line">                                    <span class="number">60L</span>, TimeUnit.SECONDS,</div><div class="line">                                    <span class="keyword">new</span> SynchronousQueue&lt;Runnable&gt;(),</div><div class="line">                                    threadFactory);</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>可以重复使用线程的线程池,直接把所有任务同时创建worker来运行,不管有多少个,同时由于设置了超时keepAliveTime,到了制定的时候就会回收空闲的worker对象,达到回收资源的目的.注意这里只是回收 <em>空闲</em> 的worker,正在运行的worker是不会回收的.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ScheduledExecutorService <span class="title">newScheduledThreadPool</span><span class="params">(</span></span></div><div class="line">            <span class="keyword">int</span> corePoolSize, ThreadFactory threadFactory) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ScheduledThreadPoolExecutor(corePoolSize, threadFactory);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>支持指定时间的任务的线程池,这里内部通过一个 <em>DelayedWorkQueue</em> 来完成定时操作,就不多做解释了.</p>
<h3 id="Callable和Runnable"><a href="#Callable和Runnable" class="headerlink" title="Callable和Runnable"></a>Callable和Runnable</h3><p>Callable是具有返回值的Runnable,这是两个区别.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Callable</span>&lt;<span class="title">V</span>&gt; </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Computes a result, or throws an exception if unable to do so.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> computed result</div><div class="line">     * <span class="doctag">@throws</span> Exception if unable to compute a result</div><div class="line">     */</div><div class="line">    <span class="function">V <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Starts executing the active part of the class' code. This method is</div><div class="line">     * called when a thread is started that has been created with a class which</div><div class="line">     * implements &#123;<span class="doctag">@code</span> Runnable&#125;.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>线程池的实现难点都在于 ThreadPoolExecutor 中,主要是对其中worker工作方式的理解,还有线程的运行和任务的运行的区别.这是关键,底层还是通过CAS来自旋判断线程的运行状态等属性变化,可以看到CAS是java多线程的核心基础.<br>刚开始完全不理解worker的实现,后来耐着性子看了好几遍别人的博客总于弄明白个大概,不得不说线程池的实现非常的巧妙.首先是一个int表示两个属性,然后是worker的实现思路来减少线程的创建消耗,对线程的理解更进一步.</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a href="http://fangjian0423.github.io/2016/03/22/java-threadpool-analysis/" title="Java线程池ThreadPoolExecutor源码分析" target="_blank" rel="external">Java线程池ThreadPoolExecutor源码分析</a></p>
<p><a href="http://zhanjindong.com/2015/03/30/java-concurrent-package-ThreadPoolExecutor" title="Java并发包源码学习之线程池（一）ThreadPoolExecutor源码分析" target="_blank" rel="external">Java并发包源码学习之线程池（一）ThreadPoolExecutor源码分析</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://pheobusyy.github.io/2017/01/03/2017/android Handler,Looper,MessageQueue源码分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanyi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pheobusyy">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/03/2017/android Handler,Looper,MessageQueue源码分析/" itemprop="url">
                  android Handler,Looper,MessageQueue源码分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-03T14:09:00+08:00">
                2017-01-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="android-Handler-Looper-MessageQueue源码分析"><a href="#android-Handler-Looper-MessageQueue源码分析" class="headerlink" title="android Handler,Looper,MessageQueue源码分析"></a>android Handler,Looper,MessageQueue源码分析</h2><p>  Handler是一个在android开发过程中经常用到的类,同时在面试的时候也会经常问道其中的实现原理,那今天就重点讲解一下Handler的用法和实现原理.</p>
<blockquote>
<p>一个Handler可以使你发送并处理一个消息或者线程通过关联一个 <em>MessageQueue</em> .每一个handler的实例都唯一关联一个线程和 <em>MessageQueue</em> .当你创建一个Handler它就和当前线程和线程的 <em>MessageQueue</em> 绑定在一起了.它会发送消息或者线程到对应 <em>MessageQueue</em> ,并且在从 <em>MessageQueue</em> 取出的时候执行它们.<br>Handler主要有两个作用:一个是可以在未来的某个时间点执行消息或者线程 ;另一个是在你当前拥有的另一个线程中排队执行一些任务.<br>发送消息一般可以使用 post(Runnable),postAtTime(Runnable,long),postDelay(Runnable,long),sendEmptyMessage(int),sendMessage(Message),sendMessageAtTime(Message,long) 和 sendMessageDelay(Message,long).这几个方法.post开头的方法可以在消息队列入队的时候调用.而sendMessage开头的方法允许把一个带有bundle对象的消息对象入队,并在未来交给 <em>handleMessage(Message)</em> 去处理.</p>
</blockquote>
<p>  上面这个是我照着官方文档翻译的,水平有限,说白了就是Handler可以把消息对象或者线程放入消息队列中,等到出列的时候调用.<br>  比如当子线程中发送网络请求之后回调可以通过给主线程的handler发送一个message,这样可以把网络请求的回调结果返回到主线程中处理.</p>
<p>  下面开始分析Handler的源码:</p>
<h3 id="Handler源码分析"><a href="#Handler源码分析" class="headerlink" title="Handler源码分析"></a>Handler源码分析</h3><p>  我们先从Handler的使用入口来看,也就是那一堆post和sendMessage开头的方法入手,可以看到所有的传递事件的方法最终都是调用了 <em>sendMessageAtTime</em> :</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">sendMessageAtTime</span><span class="params">(Message msg, <span class="keyword">long</span> uptimeMillis)</span> </span>&#123;</div><div class="line">      MessageQueue queue = mQueue;</div><div class="line">      <span class="keyword">if</span> (queue == <span class="keyword">null</span>) &#123;</div><div class="line">          RuntimeException e = <span class="keyword">new</span> RuntimeException(</div><div class="line">                  <span class="keyword">this</span> + <span class="string">" sendMessageAtTime() called with no mQueue"</span>);</div><div class="line">          Log.w(<span class="string">"Looper"</span>, e.getMessage(), e);</div><div class="line">          <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> enqueueMessage(queue, msg, uptimeMillis);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>  post方法开头的只是多做了一部处理,把Runnable对象作为message的回调使用了,然后也是调用了 <em>sendMessageAtTime</em> :<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Message <span class="title">getPostMessage</span><span class="params">(Runnable r)</span> </span>&#123;</div><div class="line">    Message m = Message.obtain();</div><div class="line">    m.callback = r;</div><div class="line">    <span class="keyword">return</span> m;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>  可以看到在 <em>sendMessageAtTime</em> 的方法刚开始的时候显示判断消息队列 <em>MessageQueue</em> 是否为空,如果为空的直接返回false不予执行.那这个消息队列是从哪里来的的呢?这个时候回到Handler的构造方法:<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Handler</span><span class="params">()</span> </span>&#123;</div><div class="line">     <span class="keyword">this</span>(<span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line"> &#125;</div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="title">Handler</span><span class="params">(Callback callback)</span> </span>&#123;</div><div class="line">     <span class="keyword">this</span>(callback, <span class="keyword">false</span>);</div><div class="line"> &#125;</div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="title">Handler</span><span class="params">(Looper looper)</span> </span>&#123;</div><div class="line">     <span class="keyword">this</span>(looper, <span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line"> &#125;</div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="title">Handler</span><span class="params">(Looper looper, Callback callback)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>(looper, callback, <span class="keyword">false</span>);</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">*.......</div><div class="line">*<span class="doctag">@hide</span></div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Handler</span><span class="params">(<span class="keyword">boolean</span> async)</span> </span>&#123;</div><div class="line">      <span class="keyword">this</span>(<span class="keyword">null</span>, async);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Handler</span><span class="params">(Callback callback, <span class="keyword">boolean</span> async)</span> </span>&#123;</div><div class="line">     <span class="keyword">if</span> (FIND_POTENTIAL_LEAKS) &#123;</div><div class="line">         <span class="keyword">final</span> Class&lt;? extends Handler&gt; klass = getClass();</div><div class="line">         <span class="keyword">if</span> ((klass.isAnonymousClass() || klass.isMemberClass() || klass.isLocalClass()) &amp;&amp;</div><div class="line">                 (klass.getModifiers() &amp; Modifier.STATIC) == <span class="number">0</span>) &#123;</div><div class="line">             Log.w(TAG, <span class="string">"The following Handler class should be static or leaks might occur: "</span> +</div><div class="line">                 klass.getCanonicalName());</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     mLooper = Looper.myLooper();</div><div class="line">     <span class="keyword">if</span> (mLooper == <span class="keyword">null</span>) &#123;</div><div class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</div><div class="line">             <span class="string">"Can't create handler inside thread that has not called Looper.prepare()"</span>);</div><div class="line">     &#125;</div><div class="line">     mQueue = mLooper.mQueue;</div><div class="line">     mCallback = callback;</div><div class="line">     mAsynchronous = async;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>  这里有个细节就是6个构造函数的其中一个是不对外开放的,就是那个加了 <em>@hide</em> 注解的构造函数.也就是这个构造函数只能在手机自己内部调用,和android的internal包戏下面的代码一样,都是不对外开发的.</p>
<p>  可以看到在构造方法顶部有一个tip提示,就是说如果这里handler不是静态的话可能导致内存泄漏,这种情况是很常见的,内部类持有外部类的引用,也就是当前handler持有外部的activity对象,当activity销毁的时候,如果handler中还是有任务没有完成的,activity是无法被内存回收的.这就会导致内存泄漏,解决方法就是把handler设置为static并且把activity的关联设置为弱引用(WeakReference).</p>
<p>  继续往下看,开始调用 Looper.myLooper() 如果Looper对象为空的话抛出异常,看来handler必须能够获取到looper对象,否者没法往下执行.到了后面我们就知道,looper的作用是用来不停的从消息队列中取出消息来交给Handler来执行的.所以没有looper的话handler获取不到消息就没有了意义.<br>  在往下就会发现handler里面的 MessageQueue用的就是looper里面的mQueue.后面我们在分析looper的实现.现在消息队列有了,我们回到上面的 <em>sendMessageAtTime</em> 方法中.可以看到该方法最终调用了 <em>enqueueMessage</em> 方法.<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">enqueueMessage</span><span class="params">(MessageQueue queue, Message msg, <span class="keyword">long</span> uptimeMillis)</span> </span>&#123;</div><div class="line">     msg.target = <span class="keyword">this</span>;</div><div class="line">     <span class="keyword">if</span> (mAsynchronous) &#123;</div><div class="line">         msg.setAsynchronous(<span class="keyword">true</span>);</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">return</span> queue.enqueueMessage(msg, uptimeMillis);</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>  非常简单,调用消息队列自己的 <em>enqueueMessage</em> 方法,这里如果handler设置为异步(mAsynchronous)的话,那发送的消息类型也是异步的.至于异步有啥作用,我们后面会提到.<br>  可以看到Handler的代码非常的见到,就是把消息放入消息队列中就完成任务了.那怎么从消息队列中取出消息来回调了,这个功能就交给下面要讲的looper实现了.</p>
<h3 id="Looper的实现"><a href="#Looper的实现" class="headerlink" title="Looper的实现"></a>Looper的实现</h3><p>  上面看Handler得源码发现,其内部的消息队列指向的是Looper的内部的消息队列,那可以断定这个消息队列是由looper来维护的,同时由于每个线程都有一个唯一的线程队列,这个是怎么实现呢,可以马上想到之前我们学习过的 <em>ThreadLocal</em> 每个线程都拥有自己唯一的变量对象.这里就是 <em>ThreadLocal</em> 的典型实现场景了.</p>
<p>  可以看到Looper的构造函数是私有的,外面只能通过调用 <em>myLooper</em> 方法来获取到当前线程中的Looper对象.<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="meta">@Nullable</span> <span class="function">Looper <span class="title">myLooper</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> sThreadLocal.get();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Looper&gt; sThreadLocal = <span class="keyword">new</span> ThreadLocal&lt;Looper&gt;();</div></pre></td></tr></table></figure>
<p>  刚才说了Handler在发送之前必须得能通过 <em>myLooper</em> 方法获取到looper对象.但是这里的sThreadLocal并没有实现 <em>initialValue</em> 方法,所以必须得外部调用一个方法来给ThreadLocal赋值,这里使用的是 <em>prepare</em> 方法.<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">()</span> </span>&#123;</div><div class="line">      prepare(<span class="keyword">true</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(<span class="keyword">boolean</span> quitAllowed)</span> </span>&#123;</div><div class="line">      <span class="keyword">if</span> (sThreadLocal.get() != <span class="keyword">null</span>) &#123;</div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Only one Looper may be created per thread"</span>);</div><div class="line">      &#125;</div><div class="line">      sThreadLocal.set(<span class="keyword">new</span> Looper(quitAllowed));</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>  通过 <em>prepare</em> 方法,就可以是当前线程中的looper对象不为空了,同时handler就可以来发送消息了.so,可以看到在创建Handler之前的必备步骤必须先得调用一下Looper.prepare()方法,这样才能正常运行.<br>  这个时候有人可能会说,为啥在activity的使用过程中,我们并没有显式的调用 <em>Looper.prepare()</em> 方法呢,其实是activity在创建的时候已经在底层帮我们调用过了,这样朱祥成中的looper对象就不为空,我们就可以随便创建新的Handler而不用担心looper为空了.</p>
<p>  looper为主线程的looper提供了直接调用方法:<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepareMainLooper</span><span class="params">()</span> </span>&#123;</div><div class="line">     prepare(<span class="keyword">false</span>);</div><div class="line">     <span class="keyword">synchronized</span> (Looper.class) &#123;</div><div class="line">         <span class="keyword">if</span> (sMainLooper != <span class="keyword">null</span>) &#123;</div><div class="line">             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The main Looper has already been prepared."</span>);</div><div class="line">         &#125;</div><div class="line">         sMainLooper = myLooper();</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>  这个方法就是用来给UI主线程来生成唯一的looper的.我们平时经常通 <em>Looper.myLooper() == Looper.getMainLooper()</em> 来判断当前是不是在UI主线程中就是这个道理.<br>  looper的初始化完成后,怎么才能让消息队列的消息出列呢.这里是通过调用 <em>loop</em> 方法来完成的<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loop</span><span class="params">()</span> </span>&#123;</div><div class="line">     <span class="keyword">final</span> Looper me = myLooper();</div><div class="line">     <span class="keyword">if</span> (me == <span class="keyword">null</span>) &#123;</div><div class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"No Looper; Looper.prepare() wasn't called on this thread."</span>);</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">final</span> MessageQueue queue = me.mQueue;</div><div class="line"></div><div class="line">     <span class="comment">// Make sure the identity of this thread is that of the local process,</span></div><div class="line">     <span class="comment">// and keep track of what that identity token actually is.</span></div><div class="line">     Binder.clearCallingIdentity();</div><div class="line">     <span class="keyword">final</span> <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</div><div class="line"></div><div class="line">     <span class="keyword">for</span> (;;) &#123;</div><div class="line">         Message msg = queue.next(); <span class="comment">// might block</span></div><div class="line">         <span class="keyword">if</span> (msg == <span class="keyword">null</span>) &#123;</div><div class="line">             <span class="comment">// No message indicates that the message queue is quitting.</span></div><div class="line">             <span class="keyword">return</span>;</div><div class="line">         &#125;</div><div class="line"></div><div class="line">         <span class="comment">// This must be in a local variable, in case a UI event sets the logger</span></div><div class="line">         Printer logging = me.mLogging;</div><div class="line">         <span class="keyword">if</span> (logging != <span class="keyword">null</span>) &#123;</div><div class="line">             logging.println(<span class="string">"&gt;&gt;&gt;&gt;&gt; Dispatching to "</span> + msg.target + <span class="string">" "</span> +</div><div class="line">                     msg.callback + <span class="string">": "</span> + msg.what);</div><div class="line">         &#125;</div><div class="line"></div><div class="line">         msg.target.dispatchMessage(msg);</div><div class="line"></div><div class="line">         <span class="keyword">if</span> (logging != <span class="keyword">null</span>) &#123;</div><div class="line">             logging.println(<span class="string">"&lt;&lt;&lt;&lt;&lt; Finished to "</span> + msg.target + <span class="string">" "</span> + msg.callback);</div><div class="line">         &#125;</div><div class="line"></div><div class="line">         <span class="comment">// Make sure that during the course of dispatching the</span></div><div class="line">         <span class="comment">// identity of the thread wasn't corrupted.</span></div><div class="line">         <span class="keyword">final</span> <span class="keyword">long</span> newIdent = Binder.clearCallingIdentity();</div><div class="line">         <span class="keyword">if</span> (ident != newIdent) &#123;</div><div class="line">             Log.wtf(TAG, <span class="string">"Thread identity changed from 0x"</span></div><div class="line">                     + Long.toHexString(ident) + <span class="string">" to 0x"</span></div><div class="line">                     + Long.toHexString(newIdent) + <span class="string">" while dispatching to "</span></div><div class="line">                     + msg.target.getClass().getName() + <span class="string">" "</span></div><div class="line">                     + msg.callback + <span class="string">" what="</span> + msg.what);</div><div class="line">         &#125;</div><div class="line"></div><div class="line">         msg.recycleUnchecked();</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>  这里去掉无用信息之后,实际上就是调用了消息队列的 <em>next</em> 方法,如果取到新的消息对象,就交给消息对象的target也就是handler来处理.同时也看到在注释写到消息队列的next方法可能会阻塞.回到了handler的 <em>dispatchMessage</em> 方法中了</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Handle system messages here.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (msg.callback != <span class="keyword">null</span>) &#123;</div><div class="line">        handleCallback(msg);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">if</span> (mCallback != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (mCallback.handleMessage(msg)) &#123;</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        handleMessage(msg);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handleCallback</span><span class="params">(Message message)</span> </span>&#123;</div><div class="line">       message.callback.run();</div><div class="line">   &#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* Subclasses must implement this to receive messages.</div><div class="line">*/</div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>  这里可以看到,如果是post的时候,调用callBack,如果是sendMessage的话直接调用handleMessage,这个方法是个空方法,是交给我们自己根据需求去实现的.</p>
<p>  这里其实一直有一个疑问,就是明明在线程中调用Handler的post方法,传入一个线程对象,为啥就说这玩意是在主线程中运行的呢?明明代码都在线程里面的,要运行也应该是在子线程中运行,为啥大家都说是在主线程中运行?<br>  今天才明白了,一直忽略了一个细节,就是上面的 <em>handleCallback</em> 的内部实现,细细看它里面内部调用的居然是callback的 <em>run</em> 方法,而不是咱们一直使用的 <em>start</em> 方法,二者唯一的区别就是start是新开一个线程来执行run方法中的代码,而run方法是直接在当前线程中执行run方法中的代码,这是二者的不同之处,so,这里其实是在主线程中直接执行了run方法中的代码,那个子线程根本就没有运行,相当于一个普通的对象.</p>
<p>  到这里looper的功能就讲完了,可以看到looper就是不断的从消息队列中取消息的作用.<br>  下面我们进入消息队列的具体实现,来重点看一下两个方法 <em>enqueueMessage</em> , <em>next</em>:</p>
<h3 id="MessageQueue的实现"><a href="#MessageQueue的实现" class="headerlink" title="MessageQueue的实现"></a>MessageQueue的实现</h3><p>  先来看 <em>enqueueMessage</em> 的实现:<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">enqueueMessage</span><span class="params">(Message msg, <span class="keyword">long</span> when)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (msg.target == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Message must have a target."</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (msg.isInUse()) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(msg + <span class="string">" This message is already in use."</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (mQuitting) &#123;</div><div class="line">            IllegalStateException e = <span class="keyword">new</span> IllegalStateException(</div><div class="line">                    msg.target + <span class="string">" sending message to a Handler on a dead thread"</span>);</div><div class="line">            Log.w(TAG, e.getMessage(), e);</div><div class="line">            msg.recycle();</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        msg.markInUse();</div><div class="line">        msg.when = when;</div><div class="line">        Message p = mMessages;</div><div class="line">        <span class="keyword">boolean</span> needWake;</div><div class="line">        <span class="keyword">if</span> (p == <span class="keyword">null</span> || when == <span class="number">0</span> || when &lt; p.when) &#123;</div><div class="line">            <span class="comment">// New head, wake up the event queue if blocked.</span></div><div class="line">            msg.next = p;</div><div class="line">            mMessages = msg;</div><div class="line">            needWake = mBlocked;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// Inserted within the middle of the queue.  Usually we don't have to wake</span></div><div class="line">            <span class="comment">// up the event queue unless there is a barrier at the head of the queue</span></div><div class="line">            <span class="comment">// and the message is the earliest asynchronous message in the queue.</span></div><div class="line">            needWake = mBlocked &amp;&amp; p.target == <span class="keyword">null</span> &amp;&amp; msg.isAsynchronous();</div><div class="line">            Message prev;</div><div class="line">            <span class="keyword">for</span> (;;) &#123;</div><div class="line">                prev = p;</div><div class="line">                p = p.next;</div><div class="line">                <span class="keyword">if</span> (p == <span class="keyword">null</span> || when &lt; p.when) &#123;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (needWake &amp;&amp; p.isAsynchronous()) &#123;</div><div class="line">                    needWake = <span class="keyword">false</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            msg.next = p; <span class="comment">// invariant: p == prev.next</span></div><div class="line">            prev.next = msg;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// We can assume mPtr != 0 because mQuitting is false.</span></div><div class="line">        <span class="keyword">if</span> (needWake) &#123;</div><div class="line">            nativeWake(mPtr);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>  可以很明显的看出消息队列实际上是一个单向链表的实现.这里的全局变量 <em>mMessages</em> 代表着初始的头结点,如果刚开始列表为空的话就把当前的入队的message作为头结点,如果不为空的话就遍历整个列表直到找到触发时间(when)小于当前的message的消息,把message插入他的后面.</p>
<p>  这里的needWake变量是用来处理如果是异步任务的时候来h唤醒队列用的,平时我们用不到,这里不深入讲了</p>
<p>  下面再来看下 <em>next</em> 方法是如何阻塞线程的:<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div></pre></td><td class="code"><pre><div class="line"><span class="function">Message <span class="title">next</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="comment">// Return here if the message loop has already quit and been disposed.</span></div><div class="line">      <span class="comment">// This can happen if the application tries to restart a looper after quit</span></div><div class="line">      <span class="comment">// which is not supported.</span></div><div class="line">      <span class="keyword">final</span> <span class="keyword">long</span> ptr = mPtr;</div><div class="line">      <span class="keyword">if</span> (ptr == <span class="number">0</span>) &#123;</div><div class="line">          <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">int</span> pendingIdleHandlerCount = -<span class="number">1</span>; <span class="comment">// -1 only during first iteration</span></div><div class="line">      <span class="keyword">int</span> nextPollTimeoutMillis = <span class="number">0</span>;</div><div class="line">      <span class="keyword">for</span> (;;) &#123;</div><div class="line">          <span class="keyword">if</span> (nextPollTimeoutMillis != <span class="number">0</span>) &#123;</div><div class="line">              Binder.flushPendingCommands();</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          nativePollOnce(ptr, nextPollTimeoutMillis);</div><div class="line"></div><div class="line">          <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">              <span class="comment">// Try to retrieve the next message.  Return if found.</span></div><div class="line">              <span class="keyword">final</span> <span class="keyword">long</span> now = SystemClock.uptimeMillis();</div><div class="line">              Message prevMsg = <span class="keyword">null</span>;</div><div class="line">              Message msg = mMessages;</div><div class="line">              <span class="keyword">if</span> (msg != <span class="keyword">null</span> &amp;&amp; msg.target == <span class="keyword">null</span>) &#123;</div><div class="line">                  <span class="comment">// Stalled by a barrier.  Find the next asynchronous message in the queue.</span></div><div class="line">                  <span class="keyword">do</span> &#123;</div><div class="line">                      prevMsg = msg;</div><div class="line">                      msg = msg.next;</div><div class="line">                  &#125; <span class="keyword">while</span> (msg != <span class="keyword">null</span> &amp;&amp; !msg.isAsynchronous());</div><div class="line">              &#125;</div><div class="line">              <span class="keyword">if</span> (msg != <span class="keyword">null</span>) &#123;</div><div class="line">                  <span class="keyword">if</span> (now &lt; msg.when) &#123;</div><div class="line">                      <span class="comment">// Next message is not ready.  Set a timeout to wake up when it is ready.</span></div><div class="line">                      nextPollTimeoutMillis = (<span class="keyword">int</span>) Math.min(msg.when - now, Integer.MAX_VALUE);</div><div class="line">                  &#125; <span class="keyword">else</span> &#123;</div><div class="line">                      <span class="comment">// Got a message.</span></div><div class="line">                      mBlocked = <span class="keyword">false</span>;</div><div class="line">                      <span class="keyword">if</span> (prevMsg != <span class="keyword">null</span>) &#123;</div><div class="line">                          prevMsg.next = msg.next;</div><div class="line">                      &#125; <span class="keyword">else</span> &#123;</div><div class="line">                          mMessages = msg.next;</div><div class="line">                      &#125;</div><div class="line">                      msg.next = <span class="keyword">null</span>;</div><div class="line">                      <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">"Returning message: "</span> + msg);</div><div class="line">                      msg.markInUse();</div><div class="line">                      <span class="keyword">return</span> msg;</div><div class="line">                  &#125;</div><div class="line">              &#125; <span class="keyword">else</span> &#123;</div><div class="line">                  <span class="comment">// No more messages.</span></div><div class="line">                  nextPollTimeoutMillis = -<span class="number">1</span>;</div><div class="line">              &#125;</div><div class="line"></div><div class="line">              <span class="comment">// Process the quit message now that all pending messages have been handled.</span></div><div class="line">              <span class="keyword">if</span> (mQuitting) &#123;</div><div class="line">                  dispose();</div><div class="line">                  <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">              &#125;</div><div class="line"></div><div class="line">              <span class="comment">// If first time idle, then get the number of idlers to run.</span></div><div class="line">              <span class="comment">// Idle handles only run if the queue is empty or if the first message</span></div><div class="line">              <span class="comment">// in the queue (possibly a barrier) is due to be handled in the future.</span></div><div class="line">              <span class="keyword">if</span> (pendingIdleHandlerCount &lt; <span class="number">0</span></div><div class="line">                      &amp;&amp; (mMessages == <span class="keyword">null</span> || now &lt; mMessages.when)) &#123;</div><div class="line">                  pendingIdleHandlerCount = mIdleHandlers.size();</div><div class="line">              &#125;</div><div class="line">              <span class="keyword">if</span> (pendingIdleHandlerCount &lt;= <span class="number">0</span>) &#123;</div><div class="line">                  <span class="comment">// No idle handlers to run.  Loop and wait some more.</span></div><div class="line">                  mBlocked = <span class="keyword">true</span>;</div><div class="line">                  <span class="keyword">continue</span>;</div><div class="line">              &#125;</div><div class="line"></div><div class="line">              <span class="keyword">if</span> (mPendingIdleHandlers == <span class="keyword">null</span>) &#123;</div><div class="line">                  mPendingIdleHandlers = <span class="keyword">new</span> IdleHandler[Math.max(pendingIdleHandlerCount, <span class="number">4</span>)];</div><div class="line">              &#125;</div><div class="line">              mPendingIdleHandlers = mIdleHandlers.toArray(mPendingIdleHandlers);</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="comment">// Run the idle handlers.</span></div><div class="line">          <span class="comment">// We only ever reach this code block during the first iteration.</span></div><div class="line">          <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pendingIdleHandlerCount; i++) &#123;</div><div class="line">              <span class="keyword">final</span> IdleHandler idler = mPendingIdleHandlers[i];</div><div class="line">              mPendingIdleHandlers[i] = <span class="keyword">null</span>; <span class="comment">// release the reference to the handler</span></div><div class="line"></div><div class="line">              <span class="keyword">boolean</span> keep = <span class="keyword">false</span>;</div><div class="line">              <span class="keyword">try</span> &#123;</div><div class="line">                  keep = idler.queueIdle();</div><div class="line">              &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                  Log.wtf(TAG, <span class="string">"IdleHandler threw exception"</span>, t);</div><div class="line">              &#125;</div><div class="line"></div><div class="line">              <span class="keyword">if</span> (!keep) &#123;</div><div class="line">                  <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">                      mIdleHandlers.remove(idler);</div><div class="line">                  &#125;</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="comment">// Reset the idle handler count to 0 so we do not run them again.</span></div><div class="line">          pendingIdleHandlerCount = <span class="number">0</span>;</div><div class="line"></div><div class="line">          <span class="comment">// While calling an idle handler, a new message could have been delivered</span></div><div class="line">          <span class="comment">// so go back and look again for a pending message without waiting.</span></div><div class="line">          nextPollTimeoutMillis = <span class="number">0</span>;</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>  可以看到这里已经来就弄出一个死循环来,就是这么的霸气,通过这个循环来不断从链表中获取头结点的message对象,for循环开始有一个 <em>nativePollOnce</em><br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nativePollOnce(ptr, nextPollTimeoutMillis);</div></pre></td></tr></table></figure></p>
<p>  这个方法是一个native方法,作用就是在指定的时间内唤醒ptr,也就是消息队列的内存地址.</p>
<p>  那这个参数 <em>nextPollTimeoutMillis</em> 就很是关键点了.如果头结点不为空的话,判断一下当前事件是不是小于message的when,如果小于说明还没有到消息出列的时候,把 <em>nextPollTimeoutMillis</em> 调整为二者的差值,等待下次的唤醒.如果时间正好,就把头结点返回,链表前移.<br>  有点像你定了6点闹钟上班,5点半醒了发现没到点就继续睡半小时的,等到了6点闹钟响了你就起床上班了.差不多就是这个意思.</p>
<p>  核心逻辑走完之后地下出现了一个 <em>IdleHandler</em> 数组,并调用了 <em>queueIdle</em> 这个东西的作用就是用来在消息队列空闲的时候执行一些额外的工作.比如GC说明的,你可以根据需要调用消息队列的 <em>addIdleHandler</em><br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addIdleHandler</span><span class="params">(@NonNull IdleHandler handler)</span> </span>&#123;</div><div class="line">     <span class="keyword">if</span> (handler == <span class="keyword">null</span>) &#123;</div><div class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"Can't add a null IdleHandler"</span>);</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">         mIdleHandlers.add(handler);</div><div class="line">     &#125;</div><div class="line"> &#125;</div><div class="line"></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeIdleHandler</span><span class="params">(@NonNull IdleHandler handler)</span> </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">            mIdleHandlers.remove(handler);</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>  最后的最后我们可以看到在 <em>next</em> 方法中判断如果message的target为空的时候的处理.那什么情况下message的target为空的,是在消息队列中的 <em>postSyncBarrier</em><br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">postSyncBarrier</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> postSyncBarrier(SystemClock.uptimeMillis());</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">postSyncBarrier</span><span class="params">(<span class="keyword">long</span> when)</span> </span>&#123;</div><div class="line">      <span class="comment">// Enqueue a new sync barrier token.</span></div><div class="line">      <span class="comment">// We don't need to wake the queue because the purpose of a barrier is to stall it.</span></div><div class="line">      <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">          <span class="keyword">final</span> <span class="keyword">int</span> token = mNextBarrierToken++;</div><div class="line">          <span class="keyword">final</span> Message msg = Message.obtain();</div><div class="line">          msg.markInUse();</div><div class="line">          msg.when = when;</div><div class="line">          msg.arg1 = token;</div><div class="line"></div><div class="line">          Message prev = <span class="keyword">null</span>;</div><div class="line">          Message p = mMessages;</div><div class="line">          <span class="keyword">if</span> (when != <span class="number">0</span>) &#123;</div><div class="line">              <span class="keyword">while</span> (p != <span class="keyword">null</span> &amp;&amp; p.when &lt;= when) &#123;</div><div class="line">                  prev = p;</div><div class="line">                  p = p.next;</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">if</span> (prev != <span class="keyword">null</span>) &#123; <span class="comment">// invariant: p == prev.next</span></div><div class="line">              msg.next = p;</div><div class="line">              prev.next = msg;</div><div class="line">          &#125; <span class="keyword">else</span> &#123;</div><div class="line">              msg.next = p;</div><div class="line">              mMessages = msg;</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">return</span> token;</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>  这个barrier的作用翻译过来叫栅栏,也就是用来阻隔消息继续发送的.如果你调用了 <em>postSyncBarrier</em> 那这个时间点之后的同步消息都不会执行了,除非了你把它移除掉,调用 <em>removeSyncBarrier</em> .这里不包括异步消息,异步消息还是可以继续执行的.我们平时调用的都是同步消息,异步消息应该是系统内部使用的.<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeSyncBarrier</span><span class="params">(<span class="keyword">int</span> token)</span> </span>&#123;</div><div class="line">     <span class="comment">// Remove a sync barrier token from the queue.</span></div><div class="line">     <span class="comment">// If the queue is no longer stalled by a barrier then wake it.</span></div><div class="line">     <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">         Message prev = <span class="keyword">null</span>;</div><div class="line">         Message p = mMessages;</div><div class="line">         <span class="keyword">while</span> (p != <span class="keyword">null</span> &amp;&amp; (p.target != <span class="keyword">null</span> || p.arg1 != token)) &#123;</div><div class="line">             prev = p;</div><div class="line">             p = p.next;</div><div class="line">         &#125;</div><div class="line">         <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</div><div class="line">             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The specified message queue synchronization "</span></div><div class="line">                     + <span class="string">" barrier token has not been posted or has already been removed."</span>);</div><div class="line">         &#125;</div><div class="line">         <span class="keyword">final</span> <span class="keyword">boolean</span> needWake;</div><div class="line">         <span class="keyword">if</span> (prev != <span class="keyword">null</span>) &#123;</div><div class="line">             prev.next = p.next;</div><div class="line">             needWake = <span class="keyword">false</span>;</div><div class="line">         &#125; <span class="keyword">else</span> &#123;</div><div class="line">             mMessages = p.next;</div><div class="line">             needWake = mMessages == <span class="keyword">null</span> || mMessages.target != <span class="keyword">null</span>;</div><div class="line">         &#125;</div><div class="line">         p.recycleUnchecked();</div><div class="line"></div><div class="line">         <span class="comment">// If the loop is quitting then it is already awake.</span></div><div class="line">         <span class="comment">// We can assume mPtr != 0 when mQuitting is false.</span></div><div class="line">         <span class="keyword">if</span> (needWake &amp;&amp; !mQuitting) &#123;</div><div class="line">             nativeWake(mPtr);</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>  消息队列的大概流程就讲完了,最后我们来看下Message对象的内部实现:</p>
<h3 id="Message源码"><a href="#Message源码" class="headerlink" title="Message源码"></a>Message源码</h3><p>  可以看到在Message中提供了一系列的obtain方法来用来初始赋值,这里有个简单对象池的实现,值得我们注意下:</p>
<p>  在上面的looper的loop方法中,当取出message之后并交给message的target执行完成后,后面有一句 <em>msg.recycleUnchecked();</em> 用来回收message对象<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">recycleUnchecked</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// Mark the message as in use while it remains in the recycled object pool.</span></div><div class="line">    <span class="comment">// Clear out all other details.</span></div><div class="line">    flags = FLAG_IN_USE;</div><div class="line">    what = <span class="number">0</span>;</div><div class="line">    arg1 = <span class="number">0</span>;</div><div class="line">    arg2 = <span class="number">0</span>;</div><div class="line">    obj = <span class="keyword">null</span>;</div><div class="line">    replyTo = <span class="keyword">null</span>;</div><div class="line">    sendingUid = -<span class="number">1</span>;</div><div class="line">    when = <span class="number">0</span>;</div><div class="line">    target = <span class="keyword">null</span>;</div><div class="line">    callback = <span class="keyword">null</span>;</div><div class="line">    data = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="keyword">synchronized</span> (sPoolSync) &#123;</div><div class="line">        <span class="keyword">if</span> (sPoolSize &lt; MAX_POOL_SIZE) &#123;</div><div class="line">            next = sPool;</div><div class="line">            sPool = <span class="keyword">this</span>;</div><div class="line">            sPoolSize++;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>  可以看到这里把用完的对象清空属性之后赋给了sPool,达到了回收的目的.<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Message <span class="title">obtain</span><span class="params">()</span> </span>&#123;</div><div class="line">     <span class="keyword">synchronized</span> (sPoolSync) &#123;</div><div class="line">         <span class="keyword">if</span> (sPool != <span class="keyword">null</span>) &#123;</div><div class="line">             Message m = sPool;</div><div class="line">             sPool = m.next;</div><div class="line">             m.next = <span class="keyword">null</span>;</div><div class="line">             m.flags = <span class="number">0</span>; <span class="comment">// clear in-use flag</span></div><div class="line">             sPoolSize--;</div><div class="line">             <span class="keyword">return</span> m;</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">return</span> <span class="keyword">new</span> Message();</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>  可以看到在obtain的时候优先从sPool中获取是否有么有使用的Message对象,如果有的话就直接使用了,没有的时候才创建新的Message对象.所以为了节约内存,最好还是使用obtain方法.</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>看了下Handler,Looper,MessageQueue的源码感觉难点是在 MessageQueue的内部 <em>next</em> 方法中,里面有一些底层native的东西,自己不是很了解,耽搁了点时间来消化.至于Handler和Looper上层实现还是比较简单的.那么,handler的讲解就到这里.</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a href="https://hjdzone.gitbooks.io/thinkandroid/content/ThreadMessage/Chapter_1_6.html" title="MessageQueue源码分析" target="_blank" rel="external">MessageQueue源码分析</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://pheobusyy.github.io/2017/01/01/2017/android universal image loader源码分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanyi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pheobusyy">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/01/2017/android universal image loader源码分析/" itemprop="url">
                  android universal image loader源码分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-01T10:21:00+08:00">
                2017-01-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="android-universal-image-loader-源码分析"><a href="#android-universal-image-loader-源码分析" class="headerlink" title="android universal image loader 源码分析"></a>android universal image loader 源码分析</h2><p>  UIL是在android中4大主流图片加载框架之一,它为图片加载提供了一套功能强大,灵活和高可定制性的解决方案,具有非常重要的学习意义,虽然该项目目前已经不维护了,但是很多程序依然在使用着,所以本期重点来学习UIL的内部实现,看看作者的实现思路和我们平时实现的图片加载有什么区别和共同点.</p>
<p>  说道图片加载我们常用的3级缓存,先从内存中找对应url的图片,如果没有找到就从手机存储中找,如果还没找到就从网络上去下载.这里的内存,磁盘,网络称为图片加载3级缓存.我么以前的实现也就是这么个大概流程,唯一需要注意的是从本地磁盘加载和从服务器下载是需要在子线程中工作,否者在主线程中耗时太长会阻塞主线程,导致ANR等等问题.</p>
<p>  UIL的实现流程也是这样的,唯一不用的是对三层的定义通过接口来完成灵活的定制,同时内部通过线程池来统一调度任务,还有一些对图片的Bitmap对象的二次处理等等,这些东西我们在下面都会讲到,总之非常值得学习.</p>
<p>  下面这张图是作者画的UIL的流程图,从图中可以看出和我们上面分析的流程类似<br><img src="images/2017/01/UIL_Flow.png" alt="  UIL流程图"></p>
<h3 id="UIL源码分析"><a href="#UIL源码分析" class="headerlink" title="UIL源码分析"></a>UIL源码分析</h3><h4 id="ImageLoader"><a href="#ImageLoader" class="headerlink" title="ImageLoader"></a>ImageLoader</h4><p>首先因为全局只有一个ImageLoader对象来管理加载,so,肯定是个单例:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> ImageLoader instance;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ImageLoader <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">synchronized</span> (ImageLoader.class) &#123;</div><div class="line">				<span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</div><div class="line">					instance = <span class="keyword">new</span> ImageLoader();</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> instance;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>然后把各种配置作为一个对象也就是下面提到的 <em>ImageLoaderConfiguration</em> 传给ImageLoader对象来完成配置,这里调用了init方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ImageLoaderConfiguration configuration)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (configuration == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(ERROR_INIT_CONFIG_WITH_NULL);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.configuration == <span class="keyword">null</span>) &#123;</div><div class="line">			L.d(LOG_INIT_CONFIG);</div><div class="line">			engine = <span class="keyword">new</span> ImageLoaderEngine(configuration);</div><div class="line">			<span class="keyword">this</span>.configuration = configuration;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			L.w(WARNING_RE_INIT_CONFIG);</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>注意这里,通过代码发现如果你要修改配置,直接二次调用init方法是无效的,应该先ImageLoader的destroy方法,然后再重新初始化</p>
<blockquote>
<p>Try to initialize ImageLoader which had already been initialized before. “ + “To re-init ImageLoader with new configuration call &gt;ImageLoader.destroy() at first.”;</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (configuration != <span class="keyword">null</span>) L.d(LOG_DESTROY);</div><div class="line">		stop();</div><div class="line">		configuration.diskCache.close();</div><div class="line">		engine = <span class="keyword">null</span>;</div><div class="line">		configuration = <span class="keyword">null</span>;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>可以看到这里在destroy的时候把config对象置空了.</p>
<h5 id="核心displayImage方法"><a href="#核心displayImage方法" class="headerlink" title="核心displayImage方法"></a>核心displayImage方法</h5><p>上面的init方法初始化了一个 <em>ImageLoaderEngine</em> 对象,并把config对象传入了,这里暂时先不讲该对象的实现,先从外部是如何调用ImageLoader显示图片的方法来看起,用的最多的就是 <em>displayImage</em> 这个对象.我们常用到的方法是这个:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">displayImage</span><span class="params">(String uri, ImageView imageView, DisplayImageOptions options)</span> </span>&#123;</div><div class="line">		displayImage(uri, <span class="keyword">new</span> ImageViewAware(imageView), options, <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>等一系列的重载方法,最终,这些方法会进入下面的这个 <em>displayImage</em> 方法中.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">displayImage</span><span class="params">(String uri, ImageAware imageAware, DisplayImageOptions options,</span></span></div><div class="line">			ImageSize targetSize, ImageLoadingListener listener, ImageLoadingProgressListener progressListener) &#123;</div><div class="line">		checkConfiguration();</div><div class="line">		<span class="keyword">if</span> (imageAware == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(ERROR_WRONG_ARGUMENTS);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (listener == <span class="keyword">null</span>) &#123;</div><div class="line">			listener = defaultListener;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (options == <span class="keyword">null</span>) &#123;</div><div class="line">			options = configuration.defaultDisplayImageOptions;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (TextUtils.isEmpty(uri)) &#123;</div><div class="line">			engine.cancelDisplayTaskFor(imageAware);</div><div class="line">			listener.onLoadingStarted(uri, imageAware.getWrappedView());</div><div class="line">			<span class="keyword">if</span> (options.shouldShowImageForEmptyUri()) &#123;</div><div class="line">				imageAware.setImageDrawable(options.getImageForEmptyUri(configuration.resources));</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				imageAware.setImageDrawable(<span class="keyword">null</span>);</div><div class="line">			&#125;</div><div class="line">			listener.onLoadingComplete(uri, imageAware.getWrappedView(), <span class="keyword">null</span>);</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (targetSize == <span class="keyword">null</span>) &#123;</div><div class="line">			targetSize = ImageSizeUtils.defineTargetSizeForView(imageAware, configuration.getMaxImageSize());</div><div class="line">		&#125;</div><div class="line">		String memoryCacheKey = MemoryCacheUtils.generateKey(uri, targetSize);</div><div class="line">		engine.prepareDisplayTaskFor(imageAware, memoryCacheKey);</div><div class="line"></div><div class="line">		listener.onLoadingStarted(uri, imageAware.getWrappedView());</div><div class="line"></div><div class="line">		Bitmap bmp = configuration.memoryCache.get(memoryCacheKey);</div><div class="line">		<span class="keyword">if</span> (bmp != <span class="keyword">null</span> &amp;&amp; !bmp.isRecycled()) &#123;</div><div class="line">			L.d(LOG_LOAD_IMAGE_FROM_MEMORY_CACHE, memoryCacheKey);</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (options.shouldPostProcess()) &#123;</div><div class="line">				ImageLoadingInfo imageLoadingInfo = <span class="keyword">new</span> ImageLoadingInfo(uri, imageAware, targetSize, memoryCacheKey,</div><div class="line">						options, listener, progressListener, engine.getLockForUri(uri));</div><div class="line">				ProcessAndDisplayImageTask displayTask = <span class="keyword">new</span> ProcessAndDisplayImageTask(engine, bmp, imageLoadingInfo,</div><div class="line">						defineHandler(options));</div><div class="line">				<span class="keyword">if</span> (options.isSyncLoading()) &#123;</div><div class="line">					displayTask.run();</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					engine.submit(displayTask);</div><div class="line">				&#125;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				options.getDisplayer().display(bmp, imageAware, LoadedFrom.MEMORY_CACHE);</div><div class="line">				listener.onLoadingComplete(uri, imageAware.getWrappedView(), bmp);</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">if</span> (options.shouldShowImageOnLoading()) &#123;</div><div class="line">				imageAware.setImageDrawable(options.getImageOnLoading(configuration.resources));</div><div class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (options.isResetViewBeforeLoading()) &#123;</div><div class="line">				imageAware.setImageDrawable(<span class="keyword">null</span>);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			ImageLoadingInfo imageLoadingInfo = <span class="keyword">new</span> ImageLoadingInfo(uri, imageAware, targetSize, memoryCacheKey,</div><div class="line">					options, listener, progressListener, engine.getLockForUri(uri));</div><div class="line">			LoadAndDisplayImageTask displayTask = <span class="keyword">new</span> LoadAndDisplayImageTask(engine, imageLoadingInfo,</div><div class="line">					defineHandler(options));</div><div class="line">			<span class="keyword">if</span> (options.isSyncLoading()) &#123;</div><div class="line">				displayTask.run();</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				engine.submit(displayTask);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>这个方法是ImageLoader的核心方法,所有的显示图片的逻辑都是在这里完成,包括我们上面提到的3级缓存的调用,都是在这里完成初始化然后交给 <em>ImageLoaderEngine</em> 来控制完成的.<br>我们把这个方法分为3个部分:参数检查和加载前listener回调准备,从内存中获取到了想要的Bitmap对象和最后没有从内存中获取到Bitmap的逻辑.</p>
<p>先看第一部分,参数检查和加载前listener回调准备<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">  checkConfiguration();</div><div class="line"><span class="keyword">if</span> (imageAware == <span class="keyword">null</span>) &#123;</div><div class="line">	<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(ERROR_WRONG_ARGUMENTS);</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span> (listener == <span class="keyword">null</span>) &#123;</div><div class="line">	listener = defaultListener;</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span> (options == <span class="keyword">null</span>) &#123;</div><div class="line">	options = configuration.defaultDisplayImageOptions;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (TextUtils.isEmpty(uri)) &#123;</div><div class="line">	engine.cancelDisplayTaskFor(imageAware);</div><div class="line">	listener.onLoadingStarted(uri, imageAware.getWrappedView());</div><div class="line">	<span class="keyword">if</span> (options.shouldShowImageForEmptyUri()) &#123;</div><div class="line">		imageAware.setImageDrawable(options.getImageForEmptyUri(configuration.resources));</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		imageAware.setImageDrawable(<span class="keyword">null</span>);</div><div class="line">	&#125;</div><div class="line">	listener.onLoadingComplete(uri, imageAware.getWrappedView(), <span class="keyword">null</span>);</div><div class="line">	<span class="keyword">return</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (targetSize == <span class="keyword">null</span>) &#123;</div><div class="line">	targetSize = ImageSizeUtils.defineTargetSizeForView(imageAware, configuration.getMaxImageSize());</div><div class="line">&#125;</div><div class="line">String memoryCacheKey = MemoryCacheUtils.generateKey(uri, targetSize);</div><div class="line">engine.prepareDisplayTaskFor(imageAware, memoryCacheKey);</div><div class="line"></div><div class="line">listener.onLoadingStarted(uri, imageAware.getWrappedView());</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkConfiguration</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (configuration == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(ERROR_NOT_INIT);</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>检查配置对象是否加载成功,如果没有的throw一个异常出去.<br>这里的 <em>imageAware</em> 对象实际上是对加载图片的view的一个包装,下面来看ImageAware的实现</p>
<h5 id="ImageAware对象"><a href="#ImageAware对象" class="headerlink" title="ImageAware对象"></a>ImageAware对象</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ImageAware</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">int</span> <span class="title">getWidth</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">	<span class="function">ViewScaleType <span class="title">getScaleType</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">	<span class="function">View <span class="title">getWrappedView</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">isCollected</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">setImageDrawable</span><span class="params">(Drawable drawable)</span></span>;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">setImageBitmap</span><span class="params">(Bitmap bitmap)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过代码我们发现 <em>ImageAware</em> 居然是一个接口,为什么要这样做呢,是因为不仅仅是ImageView可以加载图片,其他的view也是可以的,所以这里做了一层封装,只要是实现了ImageAware接口的view或者对象都是可以完成加载图片的操作的.</p>
<p>通过ImageAware所在的目录我们找到了下面的 <em>ImageViewAware</em> 对象,这个对象就是我们最常用的ImageView的包装对象了,来看它的实现.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewAware</span> <span class="keyword">implements</span> <span class="title">ImageAware</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String WARN_CANT_SET_DRAWABLE = <span class="string">"Can't set a drawable into view. You should call ImageLoader on UI thread for it."</span>;</div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String WARN_CANT_SET_BITMAP = <span class="string">"Can't set a bitmap into view. You should call ImageLoader on UI thread for it."</span>;</div><div class="line"></div><div class="line">	<span class="keyword">protected</span> Reference&lt;View&gt; viewRef;</div><div class="line">	<span class="keyword">protected</span> <span class="keyword">boolean</span> checkActualViewSize;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ViewAware</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>(view, <span class="keyword">true</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ViewAware</span><span class="params">(View view, <span class="keyword">boolean</span> checkActualViewSize)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (view == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"view must not be null"</span>);</div><div class="line"></div><div class="line">		<span class="keyword">this</span>.viewRef = <span class="keyword">new</span> WeakReference&lt;View&gt;(view);</div><div class="line">		<span class="keyword">this</span>.checkActualViewSize = checkActualViewSize;</div><div class="line">	&#125;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getWidth</span><span class="params">()</span> </span>&#123;</div><div class="line">		View view = viewRef.get();</div><div class="line">		<span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">final</span> ViewGroup.LayoutParams params = view.getLayoutParams();</div><div class="line">			<span class="keyword">int</span> width = <span class="number">0</span>;</div><div class="line">			<span class="keyword">if</span> (checkActualViewSize &amp;&amp; params != <span class="keyword">null</span> &amp;&amp; params.width != ViewGroup.LayoutParams.WRAP_CONTENT) &#123;</div><div class="line">				width = view.getWidth(); <span class="comment">// Get actual image width</span></div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (width &lt;= <span class="number">0</span> &amp;&amp; params != <span class="keyword">null</span>) width = params.width; <span class="comment">// Get layout width parameter</span></div><div class="line">			<span class="keyword">return</span> width;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getHeight</span><span class="params">()</span> </span>&#123;</div><div class="line">		View view = viewRef.get();</div><div class="line">		<span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">final</span> ViewGroup.LayoutParams params = view.getLayoutParams();</div><div class="line">			<span class="keyword">int</span> height = <span class="number">0</span>;</div><div class="line">			<span class="keyword">if</span> (checkActualViewSize &amp;&amp; params != <span class="keyword">null</span> &amp;&amp; params.height != ViewGroup.LayoutParams.WRAP_CONTENT) &#123;</div><div class="line">				height = view.getHeight(); <span class="comment">// Get actual image height</span></div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (height &lt;= <span class="number">0</span> &amp;&amp; params != <span class="keyword">null</span>) height = params.height; <span class="comment">// Get layout height parameter</span></div><div class="line">			<span class="keyword">return</span> height;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> ViewScaleType <span class="title">getScaleType</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> ViewScaleType.CROP;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> View <span class="title">getWrappedView</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> viewRef.get();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isCollected</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> viewRef.get() == <span class="keyword">null</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;</div><div class="line">		View view = viewRef.get();</div><div class="line">		<span class="keyword">return</span> view == <span class="keyword">null</span> ? <span class="keyword">super</span>.hashCode() : view.hashCode();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">setImageDrawable</span><span class="params">(Drawable drawable)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (Looper.myLooper() == Looper.getMainLooper()) &#123;</div><div class="line">			View view = viewRef.get();</div><div class="line">			<span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</div><div class="line">				setImageDrawableInto(drawable, view);</div><div class="line">				<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			L.w(WARN_CANT_SET_DRAWABLE);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">setImageBitmap</span><span class="params">(Bitmap bitmap)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (Looper.myLooper() == Looper.getMainLooper()) &#123;</div><div class="line">			View view = viewRef.get();</div><div class="line">			<span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</div><div class="line">				setImageBitmapInto(bitmap, view);</div><div class="line">				<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			L.w(WARN_CANT_SET_BITMAP);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Should set drawable into incoming view. Incoming view is guaranteed not null.&lt;br /&gt;</div><div class="line">	 * This method is called on UI thread.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">setImageDrawableInto</span><span class="params">(Drawable drawable, View view)</span></span>;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Should set Bitmap into incoming view. Incoming view is guaranteed not null.&lt; br /&gt;</div><div class="line">	 * This method is called on UI thread.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">setImageBitmapInto</span><span class="params">(Bitmap bitmap, View view)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>为什么要对View做包装呢,这里有下面几个作用:</p>
<p>首先是要显示的图片View可能在加载的过程中被回收了或者移除了,这个时候再往下加载就没有意义了,所以这里我们看到通过弱引用来把view对象包装起来了.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ViewAware</span><span class="params">(View view, <span class="keyword">boolean</span> checkActualViewSize)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (view == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"view must not be null"</span>);</div><div class="line"></div><div class="line">		<span class="keyword">this</span>.viewRef = <span class="keyword">new</span> WeakReference&lt;View&gt;(view);</div><div class="line">		<span class="keyword">this</span>.checkActualViewSize = checkActualViewSize;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>还有一个作用就是给view对象附一个唯一的ID,为什么要这么做,这里也要两个原因:一个是为了防止一个view重复的去请求图片,如果一个view在重复的请求图片的时候,ImageLoader会取消掉旧的请求并重新开始新的加载逻辑;二是为了解决异步加载图片错位的问题,我们都知道在android中的listView或者gridView是推荐使用缓存机制的,也就是说只是生成当前屏幕那么多的view对象,然后再滚动的时候来重复利用已经有的对象来节约内存,这就导致一个问题,比如刚开始去异步加载的view在图片加载回来的时候可能已经不是刚开始的那个view了,如果这个时候把图片附上就会产生图片不对应的问题.而这个ID的作用就在这里,通过比较刚开始和后来图片回来的view的唯一ID,如果一致的话就加载图片,不一致就什么都不做,这样就可以解决图片错位的问题了.<br>下面是具体的ImageView的包装对象的实现:</p>
<p>另外一个作用是判断当前是否是在主线程中,如果在主线程中就可以顺利的加载图片,否者不予执行.防止在子线程中更新UI报错.</p>
<p>最后的一个作用就是可以提前获取到view的宽度和高度,这样可以在加载图片的时候根据view的宽高来对图片进行缩放来节约内存空间.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageViewAware</span> <span class="keyword">extends</span> <span class="title">ViewAware</span> </span>&#123;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ImageViewAware</span><span class="params">(ImageView imageView)</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>(imageView);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ImageViewAware</span><span class="params">(ImageView imageView, <span class="keyword">boolean</span> checkActualViewSize)</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>(imageView, checkActualViewSize);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getWidth</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> width = <span class="keyword">super</span>.getWidth();</div><div class="line">		<span class="keyword">if</span> (width &lt;= <span class="number">0</span>) &#123;</div><div class="line">			ImageView imageView = (ImageView) viewRef.get();</div><div class="line">			<span class="keyword">if</span> (imageView != <span class="keyword">null</span>) &#123;</div><div class="line">				width = getImageViewFieldValue(imageView, <span class="string">"mMaxWidth"</span>); <span class="comment">// Check maxWidth parameter</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> width;</div><div class="line">	&#125;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getHeight</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> height = <span class="keyword">super</span>.getHeight();</div><div class="line">		<span class="keyword">if</span> (height &lt;= <span class="number">0</span>) &#123;</div><div class="line">			ImageView imageView = (ImageView) viewRef.get();</div><div class="line">			<span class="keyword">if</span> (imageView != <span class="keyword">null</span>) &#123;</div><div class="line">				height = getImageViewFieldValue(imageView, <span class="string">"mMaxHeight"</span>); <span class="comment">// Check maxHeight parameter</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> height;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> ViewScaleType <span class="title">getScaleType</span><span class="params">()</span> </span>&#123;</div><div class="line">		ImageView imageView = (ImageView) viewRef.get();</div><div class="line">		<span class="keyword">if</span> (imageView != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">return</span> ViewScaleType.fromImageView(imageView);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">super</span>.getScaleType();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> ImageView <span class="title">getWrappedView</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> (ImageView) <span class="keyword">super</span>.getWrappedView();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setImageDrawableInto</span><span class="params">(Drawable drawable, View view)</span> </span>&#123;</div><div class="line">		((ImageView) view).setImageDrawable(drawable);</div><div class="line">		<span class="keyword">if</span> (drawable <span class="keyword">instanceof</span> AnimationDrawable) &#123;</div><div class="line">			((AnimationDrawable)drawable).start();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setImageBitmapInto</span><span class="params">(Bitmap bitmap, View view)</span> </span>&#123;</div><div class="line">		((ImageView) view).setImageBitmap(bitmap);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getImageViewFieldValue</span><span class="params">(Object object, String fieldName)</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> value = <span class="number">0</span>;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			Field field = ImageView.class.getDeclaredField(fieldName);</div><div class="line">			field.setAccessible(<span class="keyword">true</span>);</div><div class="line">			<span class="keyword">int</span> fieldValue = (Integer) field.get(object);</div><div class="line">			<span class="keyword">if</span> (fieldValue &gt; <span class="number">0</span> &amp;&amp; fieldValue &lt; Integer.MAX_VALUE) &#123;</div><div class="line">				value = fieldValue;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">			L.e(e);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> value;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ImageViewAware就是ImageView的包装对象了,它可以获取到imageView的宽高和缩放类型,然后调用原声api来完成图片的加载到ImageView的操作.</p>
<h5 id="ImageSize对象"><a href="#ImageSize对象" class="headerlink" title="ImageSize对象"></a>ImageSize对象</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageSize</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TO_STRING_MAX_LENGHT = <span class="number">9</span>; <span class="comment">// "9999x9999".length()</span></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SEPARATOR = <span class="string">"x"</span>;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> width;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> height;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ImageSize</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.width = width;</div><div class="line">		<span class="keyword">this</span>.height = height;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ImageSize</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height, <span class="keyword">int</span> rotation)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (rotation % <span class="number">180</span> == <span class="number">0</span>) &#123;</div><div class="line">			<span class="keyword">this</span>.width = width;</div><div class="line">			<span class="keyword">this</span>.height = height;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">this</span>.width = height;</div><div class="line">			<span class="keyword">this</span>.height = width;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getWidth</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> width;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getHeight</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> height;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** Scales down dimensions in &lt;b&gt;sampleSize&lt;/b&gt; times. Returns new object. */</span></div><div class="line">	<span class="function"><span class="keyword">public</span> ImageSize <span class="title">scaleDown</span><span class="params">(<span class="keyword">int</span> sampleSize)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ImageSize(width / sampleSize, height / sampleSize);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** Scales dimensions according to incoming scale. Returns new object. */</span></div><div class="line">	<span class="function"><span class="keyword">public</span> ImageSize <span class="title">scale</span><span class="params">(<span class="keyword">float</span> scale)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ImageSize((<span class="keyword">int</span>) (width * scale), (<span class="keyword">int</span>) (height * scale));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> StringBuilder(TO_STRING_MAX_LENGHT).append(width).append(SEPARATOR).append(height).toString();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里的 <em>ImageSize</em> 对象是存储图片的宽高旋转信息的载体对象,为了方便后期对图片做处理的时候使用.这里如果取不到具体的宽高的时候使用config对象中配置的默认宽高:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ImageSize <span class="title">defineTargetSizeForView</span><span class="params">(ImageAware imageAware, ImageSize maxImageSize)</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> width = imageAware.getWidth();</div><div class="line">		<span class="keyword">if</span> (width &lt;= <span class="number">0</span>) width = maxImageSize.getWidth();</div><div class="line"></div><div class="line">		<span class="keyword">int</span> height = imageAware.getHeight();</div><div class="line">		<span class="keyword">if</span> (height &lt;= <span class="number">0</span>) height = maxImageSize.getHeight();</div><div class="line"></div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ImageSize(width, height);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>对url图片为空的处理可能会造成默认图片的显示和正常图片的显示不一样,因为url为空的时候没有走图片处理的流程,比如都要圆角图片,但是没有url的时候是无法实现的,因为没有Bitmap对象可以给它处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (TextUtils.isEmpty(uri)) &#123;</div><div class="line">			engine.cancelDisplayTaskFor(imageAware);</div><div class="line">			listener.onLoadingStarted(uri, imageAware.getWrappedView());</div><div class="line">			<span class="keyword">if</span> (options.shouldShowImageForEmptyUri()) &#123;</div><div class="line">				imageAware.setImageDrawable(options.getImageForEmptyUri(configuration.resources));</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				imageAware.setImageDrawable(<span class="keyword">null</span>);</div><div class="line">			&#125;</div><div class="line">			listener.onLoadingComplete(uri, imageAware.getWrappedView(), <span class="keyword">null</span>);</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div></pre></td></tr></table></figure>
<p>最后关于内存缓存的key值得生成:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">String memoryCacheKey = MemoryCacheUtils.generateKey(uri, targetSize);</div><div class="line">engine.prepareDisplayTaskFor(imageAware, memoryCacheKey);</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">generateKey</span><span class="params">(String imageUri, ImageSize targetSize)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> StringBuilder(imageUri).append(URI_AND_SIZE_SEPARATOR).append(targetSize.getWidth()).append(WIDTH_AND_HEIGHT_SEPARATOR).append(targetSize.getHeight()).toString();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里采用的是URL+”_“ + size信息的方式来作为缓存key的.</p>
<p>到这里, <em>displayImage</em> 的第一部分就完成了.下面进入那个来看剩下的两部分,也就是从内存中找到和没找到图片对象的处理.<br>先看如果在内存中找到了想要的图片对象的处理:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">Bitmap bmp = configuration.memoryCache.get(memoryCacheKey);</div><div class="line"><span class="keyword">if</span> (bmp != <span class="keyword">null</span> &amp;&amp; !bmp.isRecycled()) &#123;</div><div class="line">			L.d(LOG_LOAD_IMAGE_FROM_MEMORY_CACHE, memoryCacheKey);</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (options.shouldPostProcess()) &#123;</div><div class="line">				ImageLoadingInfo imageLoadingInfo = <span class="keyword">new</span> ImageLoadingInfo(uri, imageAware, targetSize, memoryCacheKey,</div><div class="line">						options, listener, progressListener, engine.getLockForUri(uri));</div><div class="line">				ProcessAndDisplayImageTask displayTask = <span class="keyword">new</span> ProcessAndDisplayImageTask(engine, bmp, imageLoadingInfo,</div><div class="line">						defineHandler(options));</div><div class="line">				<span class="keyword">if</span> (options.isSyncLoading()) &#123;</div><div class="line">					displayTask.run();</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					engine.submit(displayTask);</div><div class="line">				&#125;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				options.getDisplayer().display(bmp, imageAware, LoadedFrom.MEMORY_CACHE);</div><div class="line">				listener.onLoadingComplete(uri, imageAware.getWrappedView(), bmp);</div><div class="line">			&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>首先生成一个 <em>ImageLoadingInfo对象</em> 来保存图片加载过程中需要的信息,看下面的代码基本上所有的对象都包含了:</p>
<h5 id="ImageLoadingInfo对象"><a href="#ImageLoadingInfo对象" class="headerlink" title="ImageLoadingInfo对象"></a>ImageLoadingInfo对象</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageLoadingInfo</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> String uri;</div><div class="line">	<span class="keyword">final</span> String memoryCacheKey;</div><div class="line">	<span class="keyword">final</span> ImageAware imageAware;</div><div class="line">	<span class="keyword">final</span> ImageSize targetSize;</div><div class="line">	<span class="keyword">final</span> DisplayImageOptions options;</div><div class="line">	<span class="keyword">final</span> ImageLoadingListener listener;</div><div class="line">	<span class="keyword">final</span> ImageLoadingProgressListener progressListener;</div><div class="line">	<span class="keyword">final</span> ReentrantLock loadFromUriLock;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ImageLoadingInfo</span><span class="params">(String uri, ImageAware imageAware, ImageSize targetSize, String memoryCacheKey,</span></span></div><div class="line">			DisplayImageOptions options, ImageLoadingListener listener,</div><div class="line">			ImageLoadingProgressListener progressListener, ReentrantLock loadFromUriLock) &#123;</div><div class="line">		<span class="keyword">this</span>.uri = uri;</div><div class="line">		<span class="keyword">this</span>.imageAware = imageAware;</div><div class="line">		<span class="keyword">this</span>.targetSize = targetSize;</div><div class="line">		<span class="keyword">this</span>.options = options;</div><div class="line">		<span class="keyword">this</span>.listener = listener;</div><div class="line">		<span class="keyword">this</span>.progressListener = progressListener;</div><div class="line">		<span class="keyword">this</span>.loadFromUriLock = loadFromUriLock;</div><div class="line">		<span class="keyword">this</span>.memoryCacheKey = memoryCacheKey;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到如果需要对图片对象做处理的时候就把创建的 <em>ProcessAndDisplayImageTask</em> 这个对象交给 <em>ImageLoaderEngine</em> 来完成,如果是 <em>isSyncLoading</em> 的话就直接运行 <em>ProcessAndDisplayImageTask</em> 对象(实际上就是一个线程).<br>如果不需要处理,就直接显示交给BitmapDisplayer来显示图片:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BitmapDisplayer</span> </span>&#123;</div><div class="line">  <span class="comment">//This method is called on UI thread so it's strongly recommended not to do any heavy work in it.</span></div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">display</span><span class="params">(Bitmap bitmap, ImageAware imageAware, LoadedFrom loadedFrom)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>默认使用的这个:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleBitmapDisplayer</span> <span class="keyword">implements</span> <span class="title">BitmapDisplayer</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">display</span><span class="params">(Bitmap bitmap, ImageAware imageAware, LoadedFrom loadedFrom)</span> </span>&#123;</div><div class="line">		imageAware.setImageBitmap(bitmap);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>到这里,成功从内存中加载图片的逻辑就完成了,下面在看如果从内存中没有找到对应的图片对象的处理:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">if</span> (options.shouldShowImageOnLoading()) &#123;</div><div class="line">				imageAware.setImageDrawable(options.getImageOnLoading(configuration.resources));</div><div class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (options.isResetViewBeforeLoading()) &#123;</div><div class="line">				imageAware.setImageDrawable(<span class="keyword">null</span>);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			ImageLoadingInfo imageLoadingInfo = <span class="keyword">new</span> ImageLoadingInfo(uri, imageAware, targetSize, memoryCacheKey,</div><div class="line">					options, listener, progressListener, engine.getLockForUri(uri));</div><div class="line">			LoadAndDisplayImageTask displayTask = <span class="keyword">new</span> LoadAndDisplayImageTask(engine, imageLoadingInfo,</div><div class="line">					defineHandler(options));</div><div class="line">			<span class="keyword">if</span> (options.isSyncLoading()) &#123;</div><div class="line">				displayTask.run();</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				engine.submit(displayTask);</div><div class="line">			&#125;</div><div class="line">		&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到这里也是很清晰的,直接创建一个 <em>LoadAndDisplayImageTask</em> 对象交给engin来处理.如果是 <em>isSyncLoading</em> 的话就直接运行 <em>LoadAndDisplayImageTask</em> ,这个对象实际上也是要给线程对象,这个后面我们会讲到.</p>
<p>到这里displayImage的实现就讲完了,可以看到非常的简单,下面开始 <em>ImageLoderEngine</em> 的任务调度处理逻辑.</p>
<h4 id="ImageLoaderEngine"><a href="#ImageLoaderEngine" class="headerlink" title="ImageLoaderEngine"></a>ImageLoaderEngine</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImageLoaderEngine</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> ImageLoaderConfiguration configuration;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> Executor taskExecutor;</div><div class="line">	<span class="keyword">private</span> Executor taskExecutorForCachedImages;</div><div class="line">	<span class="keyword">private</span> Executor taskDistributor;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Integer, String&gt; cacheKeysForImageAwares = Collections</div><div class="line">			.synchronizedMap(<span class="keyword">new</span> HashMap&lt;Integer, String&gt;());</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, ReentrantLock&gt; uriLocks = <span class="keyword">new</span> WeakHashMap&lt;String, ReentrantLock&gt;();</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> AtomicBoolean paused = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> AtomicBoolean networkDenied = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> AtomicBoolean slowNetwork = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Object pauseLock = <span class="keyword">new</span> Object();</div><div class="line"></div><div class="line">	ImageLoaderEngine(ImageLoaderConfiguration configuration) &#123;</div><div class="line">		<span class="keyword">this</span>.configuration = configuration;</div><div class="line"></div><div class="line">		taskExecutor = configuration.taskExecutor;</div><div class="line">		taskExecutorForCachedImages = configuration.taskExecutorForCachedImages;</div><div class="line"></div><div class="line">		taskDistributor = DefaultConfigurationFactory.createTaskDistributor();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** Submits task to execution pool */</span></div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">submit</span><span class="params">(<span class="keyword">final</span> LoadAndDisplayImageTask task)</span> </span>&#123;</div><div class="line">		taskDistributor.execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">				File image = configuration.diskCache.get(task.getLoadingUri());</div><div class="line">				<span class="keyword">boolean</span> isImageCachedOnDisk = image != <span class="keyword">null</span> &amp;&amp; image.exists();</div><div class="line">				initExecutorsIfNeed();</div><div class="line">				<span class="keyword">if</span> (isImageCachedOnDisk) &#123;</div><div class="line">					taskExecutorForCachedImages.execute(task);</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					taskExecutor.execute(task);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** Submits task to execution pool */</span></div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">submit</span><span class="params">(ProcessAndDisplayImageTask task)</span> </span>&#123;</div><div class="line">		initExecutorsIfNeed();</div><div class="line">		taskExecutorForCachedImages.execute(task);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initExecutorsIfNeed</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (!configuration.customExecutor &amp;&amp; ((ExecutorService) taskExecutor).isShutdown()) &#123;</div><div class="line">			taskExecutor = createTaskExecutor();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (!configuration.customExecutorForCachedImages &amp;&amp; ((ExecutorService) taskExecutorForCachedImages)</div><div class="line">				.isShutdown()) &#123;</div><div class="line">			taskExecutorForCachedImages = createTaskExecutor();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> Executor <span class="title">createTaskExecutor</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> DefaultConfigurationFactory</div><div class="line">				.createExecutor(configuration.threadPoolSize, configuration.threadPriority,</div><div class="line">				configuration.tasksProcessingType);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Returns URI of image which is loading at this moment into passed &#123;<span class="doctag">@link</span> com.nostra13.universalimageloader.core.imageaware.ImageAware&#125;</div><div class="line">	 */</div><div class="line">	<span class="function">String <span class="title">getLoadingUriForView</span><span class="params">(ImageAware imageAware)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> cacheKeysForImageAwares.get(imageAware.getId());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Associates &lt;b&gt;memoryCacheKey&lt;/b&gt; with &lt;b&gt;imageAware&lt;/b&gt;. Then it helps to define image URI is loaded into View at</div><div class="line">	 * exact moment.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">prepareDisplayTaskFor</span><span class="params">(ImageAware imageAware, String memoryCacheKey)</span> </span>&#123;</div><div class="line">		cacheKeysForImageAwares.put(imageAware.getId(), memoryCacheKey);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Cancels the task of loading and displaying image for incoming &lt;b&gt;imageAware&lt;/b&gt;.</div><div class="line">	 *</div><div class="line">	 * <span class="doctag">@param</span> imageAware &#123;<span class="doctag">@link</span> com.nostra13.universalimageloader.core.imageaware.ImageAware&#125; for which display task</div><div class="line">	 *                   will be cancelled</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">cancelDisplayTaskFor</span><span class="params">(ImageAware imageAware)</span> </span>&#123;</div><div class="line">		cacheKeysForImageAwares.remove(imageAware.getId());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Denies or allows engine to download images from the network.&lt;br /&gt; &lt;br /&gt; If downloads are denied and if image</div><div class="line">	 * isn't cached then &#123;<span class="doctag">@link</span> ImageLoadingListener#onLoadingFailed(String, View, FailReason)&#125; callback will be fired</div><div class="line">	 * with &#123;<span class="doctag">@link</span> FailReason.FailType#NETWORK_DENIED&#125;</div><div class="line">	 *</div><div class="line">	 * <span class="doctag">@param</span> denyNetworkDownloads pass &lt;b&gt;true&lt;/b&gt; - to deny engine to download images from the network; &lt;b&gt;false&lt;/b&gt; -</div><div class="line">	 *                             to allow engine to download images from network.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">denyNetworkDownloads</span><span class="params">(<span class="keyword">boolean</span> denyNetworkDownloads)</span> </span>&#123;</div><div class="line">		networkDenied.set(denyNetworkDownloads);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Sets option whether ImageLoader will use &#123;<span class="doctag">@link</span> FlushedInputStream&#125; for network downloads to handle &lt;a</div><div class="line">	 * href="http://code.google.com/p/android/issues/detail?id=6066"&gt;this known problem&lt;/a&gt; or not.</div><div class="line">	 *</div><div class="line">	 * <span class="doctag">@param</span> handleSlowNetwork pass &lt;b&gt;true&lt;/b&gt; - to use &#123;<span class="doctag">@link</span> FlushedInputStream&#125; for network downloads; &lt;b&gt;false&lt;/b&gt;</div><div class="line">	 *                          - otherwise.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">handleSlowNetwork</span><span class="params">(<span class="keyword">boolean</span> handleSlowNetwork)</span> </span>&#123;</div><div class="line">		slowNetwork.set(handleSlowNetwork);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Pauses engine. All new "load&amp;display" tasks won't be executed until ImageLoader is &#123;<span class="doctag">@link</span> #resume() resumed&#125;.&lt;br</div><div class="line">	 * /&gt; Already running tasks are not paused.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">pause</span><span class="params">()</span> </span>&#123;</div><div class="line">		paused.set(<span class="keyword">true</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** Resumes engine work. Paused "load&amp;display" tasks will continue its work. */</span></div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">resume</span><span class="params">()</span> </span>&#123;</div><div class="line">		paused.set(<span class="keyword">false</span>);</div><div class="line">		<span class="keyword">synchronized</span> (pauseLock) &#123;</div><div class="line">			pauseLock.notifyAll();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Stops engine, cancels all running and scheduled display image tasks. Clears internal data.</div><div class="line">	 * &lt;br /&gt;</div><div class="line">	 * &lt;b&gt;<span class="doctag">NOTE:</span>&lt;/b&gt; This method doesn't shutdown</div><div class="line">	 * &#123;<span class="doctag">@linkplain</span> com.nostra13.universalimageloader.core.ImageLoaderConfiguration.Builder#taskExecutor(java.util.concurrent.Executor)</div><div class="line">	 * custom task executors&#125; if you set them.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (!configuration.customExecutor) &#123;</div><div class="line">			((ExecutorService) taskExecutor).shutdownNow();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (!configuration.customExecutorForCachedImages) &#123;</div><div class="line">			((ExecutorService) taskExecutorForCachedImages).shutdownNow();</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		cacheKeysForImageAwares.clear();</div><div class="line">		uriLocks.clear();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">fireCallback</span><span class="params">(Runnable r)</span> </span>&#123;</div><div class="line">		taskDistributor.execute(r);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function">ReentrantLock <span class="title">getLockForUri</span><span class="params">(String uri)</span> </span>&#123;</div><div class="line">		ReentrantLock lock = uriLocks.get(uri);</div><div class="line">		<span class="keyword">if</span> (lock == <span class="keyword">null</span>) &#123;</div><div class="line">			lock = <span class="keyword">new</span> ReentrantLock();</div><div class="line">			uriLocks.put(uri, lock);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> lock;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function">AtomicBoolean <span class="title">getPause</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> paused;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function">Object <span class="title">getPauseLock</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> pauseLock;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">isNetworkDenied</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> networkDenied.get();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">isSlowNetwork</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> slowNetwork.get();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到在 <em>ImageLoaderEngine</em> 对象中主要有3个线程池来做任务调度,核心的方法就是两个 <em>submit</em> 方法.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> Executor taskExecutor;</div><div class="line"><span class="keyword">private</span> Executor taskExecutorForCachedImages;</div><div class="line"><span class="keyword">private</span> Executor taskDistributor;</div></pre></td></tr></table></figure></p>
<p><em>taskDistributor</em> 用来统一管理所有的任务,根据任务类型把任务放入不同的线程池中,如果是内存中或者本地存储中加载图片的话交给 <em>taskExecutorForCachedImages</em> 否者就交给 <em>taskExecutor</em> 来处理.</p>
<p>两个submit方法用来把对应类型的task放入不同的线程池中来执行任务,非常的清晰.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** Submits task to execution pool */</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">submit</span><span class="params">(<span class="keyword">final</span> LoadAndDisplayImageTask task)</span> </span>&#123;</div><div class="line">  taskDistributor.execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">      File image = configuration.diskCache.get(task.getLoadingUri());</div><div class="line">      <span class="keyword">boolean</span> isImageCachedOnDisk = image != <span class="keyword">null</span> &amp;&amp; image.exists();</div><div class="line">      initExecutorsIfNeed();</div><div class="line">      <span class="keyword">if</span> (isImageCachedOnDisk) &#123;</div><div class="line">        taskExecutorForCachedImages.execute(task);</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        taskExecutor.execute(task);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/** Submits task to execution pool */</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">submit</span><span class="params">(ProcessAndDisplayImageTask task)</span> </span>&#123;</div><div class="line">  initExecutorsIfNeed();</div><div class="line">  taskExecutorForCachedImages.execute(task);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>关于Engine对象还有要注意的地方就是UIL对每个url提供了一个ReentrantLock锁,来解决对重复URL加载的线程同步问题.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function">ReentrantLock <span class="title">getLockForUri</span><span class="params">(String uri)</span> </span>&#123;</div><div class="line">		ReentrantLock lock = uriLocks.get(uri);</div><div class="line">		<span class="keyword">if</span> (lock == <span class="keyword">null</span>) &#123;</div><div class="line">			lock = <span class="keyword">new</span> ReentrantLock();</div><div class="line">			uriLocks.put(uri, lock);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> lock;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>这个锁在后面要讲到的两个Task中会用到,稍后我们再讲他们的具体实现.<br>Engine对象同时还提供了暂停,停止,开始等操作,通过线程安全的AtomicBoolean对象来控制任务调度状态,这里就不具体讲了,都是线程同步的简单实现.<br>下面开始讲两个具体的Task线程对象:</p>
<h4 id="ProcessAndDisplayImageTask"><a href="#ProcessAndDisplayImageTask" class="headerlink" title="ProcessAndDisplayImageTask"></a>ProcessAndDisplayImageTask</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ProcessAndDisplayImageTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOG_POSTPROCESS_IMAGE = <span class="string">"PostProcess image before displaying [%s]"</span>;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ImageLoaderEngine engine;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Bitmap bitmap;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ImageLoadingInfo imageLoadingInfo;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Handler handler;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ProcessAndDisplayImageTask</span><span class="params">(ImageLoaderEngine engine, Bitmap bitmap, ImageLoadingInfo imageLoadingInfo,</span></span></div><div class="line">			Handler handler) &#123;</div><div class="line">		<span class="keyword">this</span>.engine = engine;</div><div class="line">		<span class="keyword">this</span>.bitmap = bitmap;</div><div class="line">		<span class="keyword">this</span>.imageLoadingInfo = imageLoadingInfo;</div><div class="line">		<span class="keyword">this</span>.handler = handler;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">		L.d(LOG_POSTPROCESS_IMAGE, imageLoadingInfo.memoryCacheKey);</div><div class="line"></div><div class="line">		BitmapProcessor processor = imageLoadingInfo.options.getPostProcessor();</div><div class="line">		Bitmap processedBitmap = processor.process(bitmap);</div><div class="line">		DisplayBitmapTask displayBitmapTask = <span class="keyword">new</span> DisplayBitmapTask(processedBitmap, imageLoadingInfo, engine,</div><div class="line">				LoadedFrom.MEMORY_CACHE);</div><div class="line">		LoadAndDisplayImageTask.runTask(displayBitmapTask, imageLoadingInfo.options.isSyncLoading(), handler, engine);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到 <em>ProcessAndDisplayImageTask</em> 很简单,如果需要对图片做处理的话就交给 <em>BitmapProcessor</em> 把图片处理一下,然后把处理完的Bitmap对象封装成一个 <em>DisplayBitmapTask</em> 交给 <em>LoadAndDisplayImageTask</em> 的 <em>runTask</em> 方法来处理.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runTask</span><span class="params">(Runnable r, <span class="keyword">boolean</span> sync, Handler handler, ImageLoaderEngine engine)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (sync) &#123;</div><div class="line">			r.run();</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (handler == <span class="keyword">null</span>) &#123;</div><div class="line">			engine.fireCallback(r);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			handler.post(r);</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到通过具体的情况来完成回调处理.如果是同步的话直接运行该线程,如果handler为空的话交给总调度线程池 <em>taskDistributor</em> 来调用,否者通过handler来执行该线程.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DisplayBitmapTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOG_DISPLAY_IMAGE_IN_IMAGEAWARE = <span class="string">"Display image in ImageAware (loaded from %1$s) [%2$s]"</span>;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOG_TASK_CANCELLED_IMAGEAWARE_REUSED = <span class="string">"ImageAware is reused for another image. Task is cancelled. [%s]"</span>;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOG_TASK_CANCELLED_IMAGEAWARE_COLLECTED = <span class="string">"ImageAware was collected by GC. Task is cancelled. [%s]"</span>;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Bitmap bitmap;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String imageUri;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ImageAware imageAware;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String memoryCacheKey;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> BitmapDisplayer displayer;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ImageLoadingListener listener;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ImageLoaderEngine engine;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> LoadedFrom loadedFrom;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">DisplayBitmapTask</span><span class="params">(Bitmap bitmap, ImageLoadingInfo imageLoadingInfo, ImageLoaderEngine engine,</span></span></div><div class="line">			LoadedFrom loadedFrom) &#123;</div><div class="line">		<span class="keyword">this</span>.bitmap = bitmap;</div><div class="line">		imageUri = imageLoadingInfo.uri;</div><div class="line">		imageAware = imageLoadingInfo.imageAware;</div><div class="line">		memoryCacheKey = imageLoadingInfo.memoryCacheKey;</div><div class="line">		displayer = imageLoadingInfo.options.getDisplayer();</div><div class="line">		listener = imageLoadingInfo.listener;</div><div class="line">		<span class="keyword">this</span>.engine = engine;</div><div class="line">		<span class="keyword">this</span>.loadedFrom = loadedFrom;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (imageAware.isCollected()) &#123;</div><div class="line">			L.d(LOG_TASK_CANCELLED_IMAGEAWARE_COLLECTED, memoryCacheKey);</div><div class="line">			listener.onLoadingCancelled(imageUri, imageAware.getWrappedView());</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (isViewWasReused()) &#123;</div><div class="line">			L.d(LOG_TASK_CANCELLED_IMAGEAWARE_REUSED, memoryCacheKey);</div><div class="line">			listener.onLoadingCancelled(imageUri, imageAware.getWrappedView());</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			L.d(LOG_DISPLAY_IMAGE_IN_IMAGEAWARE, loadedFrom, memoryCacheKey);</div><div class="line">			displayer.display(bitmap, imageAware, loadedFrom);</div><div class="line">			engine.cancelDisplayTaskFor(imageAware);</div><div class="line">			listener.onLoadingComplete(imageUri, imageAware.getWrappedView(), bitmap);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** Checks whether memory cache key (image URI) for current ImageAware is actual */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isViewWasReused</span><span class="params">()</span> </span>&#123;</div><div class="line">		String currentCacheKey = engine.getLoadingUriForView(imageAware);</div><div class="line">		<span class="keyword">return</span> !memoryCacheKey.equals(currentCacheKey);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到 <em>DisplayBitmapTask</em> 的run方法的钱两个判断,正好对应前面讲到的关于view的回收或删除和重复利用view错位的问题的判断,如果两种情况对应上就任务本次任务被取消.否则直接通知 <em>displayer</em> 显示图片.这里不用担心是在子线程中更新UI,因为 <em>displayer</em> 内部的display方法是调用的 <em>ImageAware</em> 接口的实现类中 的setImageBitmap方法,在这个方法的具体实现中已经判断了是否是在主线程中了.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"> ViewAware对象的setImageView方法</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">setImageBitmap</span><span class="params">(Bitmap bitmap)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (Looper.myLooper() == Looper.getMainLooper()) &#123;</div><div class="line">		View view = viewRef.get();</div><div class="line">		<span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</div><div class="line">			setImageBitmapInto(bitmap, view);</div><div class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		L.w(WARN_CANT_SET_BITMAP);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="LoadAndDisplayImageTask"><a href="#LoadAndDisplayImageTask" class="headerlink" title="LoadAndDisplayImageTask"></a>LoadAndDisplayImageTask</h4><p>下面进入比较复杂的任务对象 <em>LoadAndDisplayImageTask</em> 中,改对象之所以复杂,主要是因为要判断硬盘中是否有需要的图片的对象,如果没有就去下载,然后保存图片,最后才把图片对象返回,代码较多,我们一步步的来分析</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LoadAndDisplayImageTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span>, <span class="title">IoUtils</span>.<span class="title">CopyListener</span> </span>&#123;</div><div class="line"></div><div class="line">  ....</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ImageLoaderEngine engine;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ImageLoadingInfo imageLoadingInfo;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Handler handler;</div><div class="line"></div><div class="line">	<span class="comment">// Helper references</span></div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ImageLoaderConfiguration configuration;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ImageDownloader downloader;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ImageDownloader networkDeniedDownloader;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ImageDownloader slowNetworkDownloader;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ImageDecoder decoder;</div><div class="line">	<span class="keyword">final</span> String uri;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String memoryCacheKey;</div><div class="line">	<span class="keyword">final</span> ImageAware imageAware;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ImageSize targetSize;</div><div class="line">	<span class="keyword">final</span> DisplayImageOptions options;</div><div class="line">	<span class="keyword">final</span> ImageLoadingListener listener;</div><div class="line">	<span class="keyword">final</span> ImageLoadingProgressListener progressListener;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> syncLoading;</div><div class="line"></div><div class="line">	<span class="comment">// State vars</span></div><div class="line">	<span class="keyword">private</span> LoadedFrom loadedFrom = LoadedFrom.NETWORK;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">LoadAndDisplayImageTask</span><span class="params">(ImageLoaderEngine engine, ImageLoadingInfo imageLoadingInfo, Handler handler)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.engine = engine;</div><div class="line">		<span class="keyword">this</span>.imageLoadingInfo = imageLoadingInfo;</div><div class="line">		<span class="keyword">this</span>.handler = handler;</div><div class="line"></div><div class="line">		configuration = engine.configuration;</div><div class="line">		downloader = configuration.downloader;</div><div class="line">		networkDeniedDownloader = configuration.networkDeniedDownloader;</div><div class="line">		slowNetworkDownloader = configuration.slowNetworkDownloader;</div><div class="line">		decoder = configuration.decoder;</div><div class="line">		uri = imageLoadingInfo.uri;</div><div class="line">		memoryCacheKey = imageLoadingInfo.memoryCacheKey;</div><div class="line">		imageAware = imageLoadingInfo.imageAware;</div><div class="line">		targetSize = imageLoadingInfo.targetSize;</div><div class="line">		options = imageLoadingInfo.options;</div><div class="line">		listener = imageLoadingInfo.listener;</div><div class="line">		progressListener = imageLoadingInfo.progressListener;</div><div class="line">		syncLoading = options.isSyncLoading();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (waitIfPaused()) <span class="keyword">return</span>;</div><div class="line">		<span class="keyword">if</span> (delayIfNeed()) <span class="keyword">return</span>;</div><div class="line"></div><div class="line">		ReentrantLock loadFromUriLock = imageLoadingInfo.loadFromUriLock;</div><div class="line">		L.d(LOG_START_DISPLAY_IMAGE_TASK, memoryCacheKey);</div><div class="line">		<span class="keyword">if</span> (loadFromUriLock.isLocked()) &#123;</div><div class="line">			L.d(LOG_WAITING_FOR_IMAGE_LOADED, memoryCacheKey);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		loadFromUriLock.lock();</div><div class="line">		Bitmap bmp;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			checkTaskNotActual();</div><div class="line"></div><div class="line">			bmp = configuration.memoryCache.get(memoryCacheKey);</div><div class="line">			<span class="keyword">if</span> (bmp == <span class="keyword">null</span> || bmp.isRecycled()) &#123;</div><div class="line">				bmp = tryLoadBitmap();</div><div class="line">				<span class="keyword">if</span> (bmp == <span class="keyword">null</span>) <span class="keyword">return</span>; <span class="comment">// listener callback already was fired</span></div><div class="line"></div><div class="line">				checkTaskNotActual();</div><div class="line">				checkTaskInterrupted();</div><div class="line"></div><div class="line">				<span class="keyword">if</span> (options.shouldPreProcess()) &#123;</div><div class="line">					L.d(LOG_PREPROCESS_IMAGE, memoryCacheKey);</div><div class="line">					bmp = options.getPreProcessor().process(bmp);</div><div class="line">					<span class="keyword">if</span> (bmp == <span class="keyword">null</span>) &#123;</div><div class="line">						L.e(ERROR_PRE_PROCESSOR_NULL, memoryCacheKey);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				<span class="keyword">if</span> (bmp != <span class="keyword">null</span> &amp;&amp; options.isCacheInMemory()) &#123;</div><div class="line">					L.d(LOG_CACHE_IMAGE_IN_MEMORY, memoryCacheKey);</div><div class="line">					configuration.memoryCache.put(memoryCacheKey, bmp);</div><div class="line">				&#125;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				loadedFrom = LoadedFrom.MEMORY_CACHE;</div><div class="line">				L.d(LOG_GET_IMAGE_FROM_MEMORY_CACHE_AFTER_WAITING, memoryCacheKey);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (bmp != <span class="keyword">null</span> &amp;&amp; options.shouldPostProcess()) &#123;</div><div class="line">				L.d(LOG_POSTPROCESS_IMAGE, memoryCacheKey);</div><div class="line">				bmp = options.getPostProcessor().process(bmp);</div><div class="line">				<span class="keyword">if</span> (bmp == <span class="keyword">null</span>) &#123;</div><div class="line">					L.e(ERROR_POST_PROCESSOR_NULL, memoryCacheKey);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			checkTaskNotActual();</div><div class="line">			checkTaskInterrupted();</div><div class="line">		&#125; <span class="keyword">catch</span> (TaskCancelledException e) &#123;</div><div class="line">			fireCancelEvent();</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125; <span class="keyword">finally</span> &#123;</div><div class="line">			loadFromUriLock.unlock();</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		DisplayBitmapTask displayBitmapTask = <span class="keyword">new</span> DisplayBitmapTask(bmp, imageLoadingInfo, engine, loadedFrom);</div><div class="line">		runTask(displayBitmapTask, syncLoading, handler, engine);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** <span class="doctag">@return</span> &lt;b&gt;true&lt;/b&gt; - if task should be interrupted; &lt;b&gt;false&lt;/b&gt; - otherwise */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">waitIfPaused</span><span class="params">()</span> </span>&#123;</div><div class="line">		AtomicBoolean pause = engine.getPause();</div><div class="line">		<span class="keyword">if</span> (pause.get()) &#123;</div><div class="line">			<span class="keyword">synchronized</span> (engine.getPauseLock()) &#123;</div><div class="line">				<span class="keyword">if</span> (pause.get()) &#123;</div><div class="line">					L.d(LOG_WAITING_FOR_RESUME, memoryCacheKey);</div><div class="line">					<span class="keyword">try</span> &#123;</div><div class="line">						engine.getPauseLock().wait();</div><div class="line">					&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">						L.e(LOG_TASK_INTERRUPTED, memoryCacheKey);</div><div class="line">						<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">					&#125;</div><div class="line">					L.d(LOG_RESUME_AFTER_PAUSE, memoryCacheKey);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> isTaskNotActual();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** <span class="doctag">@return</span> &lt;b&gt;true&lt;/b&gt; - if task should be interrupted; &lt;b&gt;false&lt;/b&gt; - otherwise */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">delayIfNeed</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (options.shouldDelayBeforeLoading()) &#123;</div><div class="line">			L.d(LOG_DELAY_BEFORE_LOADING, options.getDelayBeforeLoading(), memoryCacheKey);</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				Thread.sleep(options.getDelayBeforeLoading());</div><div class="line">			&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">				L.e(LOG_TASK_INTERRUPTED, memoryCacheKey);</div><div class="line">				<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> isTaskNotActual();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> Bitmap <span class="title">tryLoadBitmap</span><span class="params">()</span> <span class="keyword">throws</span> TaskCancelledException </span>&#123;</div><div class="line">		Bitmap bitmap = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			File imageFile = configuration.diskCache.get(uri);</div><div class="line">			<span class="keyword">if</span> (imageFile != <span class="keyword">null</span> &amp;&amp; imageFile.exists() &amp;&amp; imageFile.length() &gt; <span class="number">0</span>) &#123;</div><div class="line">				L.d(LOG_LOAD_IMAGE_FROM_DISK_CACHE, memoryCacheKey);</div><div class="line">				loadedFrom = LoadedFrom.DISC_CACHE;</div><div class="line"></div><div class="line">				checkTaskNotActual();</div><div class="line">				bitmap = decodeImage(Scheme.FILE.wrap(imageFile.getAbsolutePath()));</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (bitmap == <span class="keyword">null</span> || bitmap.getWidth() &lt;= <span class="number">0</span> || bitmap.getHeight() &lt;= <span class="number">0</span>) &#123;</div><div class="line">				L.d(LOG_LOAD_IMAGE_FROM_NETWORK, memoryCacheKey);</div><div class="line">				loadedFrom = LoadedFrom.NETWORK;</div><div class="line"></div><div class="line">				String imageUriForDecoding = uri;</div><div class="line">				<span class="keyword">if</span> (options.isCacheOnDisk() &amp;&amp; tryCacheImageOnDisk()) &#123;</div><div class="line">					imageFile = configuration.diskCache.get(uri);</div><div class="line">					<span class="keyword">if</span> (imageFile != <span class="keyword">null</span>) &#123;</div><div class="line">						imageUriForDecoding = Scheme.FILE.wrap(imageFile.getAbsolutePath());</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				checkTaskNotActual();</div><div class="line">				bitmap = decodeImage(imageUriForDecoding);</div><div class="line"></div><div class="line">				<span class="keyword">if</span> (bitmap == <span class="keyword">null</span> || bitmap.getWidth() &lt;= <span class="number">0</span> || bitmap.getHeight() &lt;= <span class="number">0</span>) &#123;</div><div class="line">					fireFailEvent(FailType.DECODING_ERROR, <span class="keyword">null</span>);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">catch</span> (IllegalStateException e) &#123;</div><div class="line">			fireFailEvent(FailType.NETWORK_DENIED, <span class="keyword">null</span>);</div><div class="line">		&#125; <span class="keyword">catch</span> (TaskCancelledException e) &#123;</div><div class="line">			<span class="keyword">throw</span> e;</div><div class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">			L.e(e);</div><div class="line">			fireFailEvent(FailType.IO_ERROR, e);</div><div class="line">		&#125; <span class="keyword">catch</span> (OutOfMemoryError e) &#123;</div><div class="line">			L.e(e);</div><div class="line">			fireFailEvent(FailType.OUT_OF_MEMORY, e);</div><div class="line">		&#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">			L.e(e);</div><div class="line">			fireFailEvent(FailType.UNKNOWN, e);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> bitmap;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> Bitmap <span class="title">decodeImage</span><span class="params">(String imageUri)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">		ViewScaleType viewScaleType = imageAware.getScaleType();</div><div class="line">		ImageDecodingInfo decodingInfo = <span class="keyword">new</span> ImageDecodingInfo(memoryCacheKey, imageUri, uri, targetSize, viewScaleType,</div><div class="line">				getDownloader(), options);</div><div class="line">		<span class="keyword">return</span> decoder.decode(decodingInfo);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** <span class="doctag">@return</span> &lt;b&gt;true&lt;/b&gt; - if image was downloaded successfully; &lt;b&gt;false&lt;/b&gt; - otherwise */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">tryCacheImageOnDisk</span><span class="params">()</span> <span class="keyword">throws</span> TaskCancelledException </span>&#123;</div><div class="line">		L.d(LOG_CACHE_IMAGE_ON_DISK, memoryCacheKey);</div><div class="line"></div><div class="line">		<span class="keyword">boolean</span> loaded;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			loaded = downloadImage();</div><div class="line">			<span class="keyword">if</span> (loaded) &#123;</div><div class="line">				<span class="keyword">int</span> width = configuration.maxImageWidthForDiskCache;</div><div class="line">				<span class="keyword">int</span> height = configuration.maxImageHeightForDiskCache;</div><div class="line">				<span class="keyword">if</span> (width &gt; <span class="number">0</span> || height &gt; <span class="number">0</span>) &#123;</div><div class="line">					L.d(LOG_RESIZE_CACHED_IMAGE_FILE, memoryCacheKey);</div><div class="line">					resizeAndSaveImage(width, height); <span class="comment">// TODO : process boolean result</span></div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">			L.e(e);</div><div class="line">			loaded = <span class="keyword">false</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> loaded;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">downloadImage</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">		InputStream is = getDownloader().getStream(uri, options.getExtraForDownloader());</div><div class="line">		<span class="keyword">if</span> (is == <span class="keyword">null</span>) &#123;</div><div class="line">			L.e(ERROR_NO_IMAGE_STREAM, memoryCacheKey);</div><div class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				<span class="keyword">return</span> configuration.diskCache.save(uri, is, <span class="keyword">this</span>);</div><div class="line">			&#125; <span class="keyword">finally</span> &#123;</div><div class="line">				IoUtils.closeSilently(is);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** Decodes image file into Bitmap, resize it and save it back */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">resizeAndSaveImage</span><span class="params">(<span class="keyword">int</span> maxWidth, <span class="keyword">int</span> maxHeight)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">		<span class="comment">// Decode image file, compress and re-save it</span></div><div class="line">		<span class="keyword">boolean</span> saved = <span class="keyword">false</span>;</div><div class="line">		File targetFile = configuration.diskCache.get(uri);</div><div class="line">		<span class="keyword">if</span> (targetFile != <span class="keyword">null</span> &amp;&amp; targetFile.exists()) &#123;</div><div class="line">			ImageSize targetImageSize = <span class="keyword">new</span> ImageSize(maxWidth, maxHeight);</div><div class="line">			DisplayImageOptions specialOptions = <span class="keyword">new</span> DisplayImageOptions.Builder().cloneFrom(options)</div><div class="line">					.imageScaleType(ImageScaleType.IN_SAMPLE_INT).build();</div><div class="line">			ImageDecodingInfo decodingInfo = <span class="keyword">new</span> ImageDecodingInfo(memoryCacheKey,</div><div class="line">					Scheme.FILE.wrap(targetFile.getAbsolutePath()), uri, targetImageSize, ViewScaleType.FIT_INSIDE,</div><div class="line">					getDownloader(), specialOptions);</div><div class="line">			Bitmap bmp = decoder.decode(decodingInfo);</div><div class="line">			<span class="keyword">if</span> (bmp != <span class="keyword">null</span> &amp;&amp; configuration.processorForDiskCache != <span class="keyword">null</span>) &#123;</div><div class="line">				L.d(LOG_PROCESS_IMAGE_BEFORE_CACHE_ON_DISK, memoryCacheKey);</div><div class="line">				bmp = configuration.processorForDiskCache.process(bmp);</div><div class="line">				<span class="keyword">if</span> (bmp == <span class="keyword">null</span>) &#123;</div><div class="line">					L.e(ERROR_PROCESSOR_FOR_DISK_CACHE_NULL, memoryCacheKey);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (bmp != <span class="keyword">null</span>) &#123;</div><div class="line">				saved = configuration.diskCache.save(uri, bmp);</div><div class="line">				bmp.recycle();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> saved;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onBytesCopied</span><span class="params">(<span class="keyword">int</span> current, <span class="keyword">int</span> total)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> syncLoading || fireProgressEvent(current, total);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** <span class="doctag">@return</span> &lt;b&gt;true&lt;/b&gt; - if loading should be continued; &lt;b&gt;false&lt;/b&gt; - if loading should be interrupted */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">fireProgressEvent</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> current, <span class="keyword">final</span> <span class="keyword">int</span> total)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (isTaskInterrupted() || isTaskNotActual()) <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">		<span class="keyword">if</span> (progressListener != <span class="keyword">null</span>) &#123;</div><div class="line">			Runnable r = <span class="keyword">new</span> Runnable() &#123;</div><div class="line">				<span class="meta">@Override</span></div><div class="line">				<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">					progressListener.onProgressUpdate(uri, imageAware.getWrappedView(), current, total);</div><div class="line">				&#125;</div><div class="line">			&#125;;</div><div class="line">			runTask(r, <span class="keyword">false</span>, handler, engine);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fireFailEvent</span><span class="params">(<span class="keyword">final</span> FailType failType, <span class="keyword">final</span> Throwable failCause)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (syncLoading || isTaskInterrupted() || isTaskNotActual()) <span class="keyword">return</span>;</div><div class="line">		Runnable r = <span class="keyword">new</span> Runnable() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">				<span class="keyword">if</span> (options.shouldShowImageOnFail()) &#123;</div><div class="line">					imageAware.setImageDrawable(options.getImageOnFail(configuration.resources));</div><div class="line">				&#125;</div><div class="line">				listener.onLoadingFailed(uri, imageAware.getWrappedView(), <span class="keyword">new</span> FailReason(failType, failCause));</div><div class="line">			&#125;</div><div class="line">		&#125;;</div><div class="line">		runTask(r, <span class="keyword">false</span>, handler, engine);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fireCancelEvent</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (syncLoading || isTaskInterrupted()) <span class="keyword">return</span>;</div><div class="line">		Runnable r = <span class="keyword">new</span> Runnable() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">				listener.onLoadingCancelled(uri, imageAware.getWrappedView());</div><div class="line">			&#125;</div><div class="line">		&#125;;</div><div class="line">		runTask(r, <span class="keyword">false</span>, handler, engine);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> ImageDownloader <span class="title">getDownloader</span><span class="params">()</span> </span>&#123;</div><div class="line">		ImageDownloader d;</div><div class="line">		<span class="keyword">if</span> (engine.isNetworkDenied()) &#123;</div><div class="line">			d = networkDeniedDownloader;</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (engine.isSlowNetwork()) &#123;</div><div class="line">			d = slowNetworkDownloader;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			d = downloader;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> d;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * <span class="doctag">@throws</span> TaskCancelledException if task is not actual (target ImageAware is collected by GC or the image URI of</div><div class="line">	 *                                this task doesn't match to image URI which is actual for current ImageAware at</div><div class="line">	 *                                this moment)</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkTaskNotActual</span><span class="params">()</span> <span class="keyword">throws</span> TaskCancelledException </span>&#123;</div><div class="line">		checkViewCollected();</div><div class="line">		checkViewReused();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * <span class="doctag">@return</span> &lt;b&gt;true&lt;/b&gt; - if task is not actual (target ImageAware is collected by GC or the image URI of this task</div><div class="line">	 * doesn't match to image URI which is actual for current ImageAware at this moment)); &lt;b&gt;false&lt;/b&gt; - otherwise</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isTaskNotActual</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> isViewCollected() || isViewReused();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** <span class="doctag">@throws</span> TaskCancelledException if target ImageAware is collected */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkViewCollected</span><span class="params">()</span> <span class="keyword">throws</span> TaskCancelledException </span>&#123;</div><div class="line">		<span class="keyword">if</span> (isViewCollected()) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> TaskCancelledException();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** <span class="doctag">@return</span> &lt;b&gt;true&lt;/b&gt; - if target ImageAware is collected by GC; &lt;b&gt;false&lt;/b&gt; - otherwise */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isViewCollected</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (imageAware.isCollected()) &#123;</div><div class="line">			L.d(LOG_TASK_CANCELLED_IMAGEAWARE_COLLECTED, memoryCacheKey);</div><div class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** <span class="doctag">@throws</span> TaskCancelledException if target ImageAware is collected by GC */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkViewReused</span><span class="params">()</span> <span class="keyword">throws</span> TaskCancelledException </span>&#123;</div><div class="line">		<span class="keyword">if</span> (isViewReused()) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> TaskCancelledException();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** <span class="doctag">@return</span> &lt;b&gt;true&lt;/b&gt; - if current ImageAware is reused for displaying another image; &lt;b&gt;false&lt;/b&gt; - otherwise */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isViewReused</span><span class="params">()</span> </span>&#123;</div><div class="line">		String currentCacheKey = engine.getLoadingUriForView(imageAware);</div><div class="line">		<span class="comment">// Check whether memory cache key (image URI) for current ImageAware is actual.</span></div><div class="line">		<span class="comment">// If ImageAware is reused for another task then current task should be cancelled.</span></div><div class="line">		<span class="keyword">boolean</span> imageAwareWasReused = !memoryCacheKey.equals(currentCacheKey);</div><div class="line">		<span class="keyword">if</span> (imageAwareWasReused) &#123;</div><div class="line">			L.d(LOG_TASK_CANCELLED_IMAGEAWARE_REUSED, memoryCacheKey);</div><div class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** <span class="doctag">@throws</span> TaskCancelledException if current task was interrupted */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkTaskInterrupted</span><span class="params">()</span> <span class="keyword">throws</span> TaskCancelledException </span>&#123;</div><div class="line">		<span class="keyword">if</span> (isTaskInterrupted()) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> TaskCancelledException();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** <span class="doctag">@return</span> &lt;b&gt;true&lt;/b&gt; - if current task was interrupted; &lt;b&gt;false&lt;/b&gt; - otherwise */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isTaskInterrupted</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (Thread.interrupted()) &#123;</div><div class="line">			L.d(LOG_TASK_INTERRUPTED, memoryCacheKey);</div><div class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function">String <span class="title">getLoadingUri</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> uri;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runTask</span><span class="params">(Runnable r, <span class="keyword">boolean</span> sync, Handler handler, ImageLoaderEngine engine)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (sync) &#123;</div><div class="line">			r.run();</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (handler == <span class="keyword">null</span>) &#123;</div><div class="line">			engine.fireCallback(r);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			handler.post(r);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>核心代码就是在run方法中,先看开始的两个判断 <em>waitIfPaused</em> 和 <em>delayIfNeed</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">waitIfPaused</span><span class="params">()</span> </span>&#123;</div><div class="line">		AtomicBoolean pause = engine.getPause();</div><div class="line">		<span class="keyword">if</span> (pause.get()) &#123;</div><div class="line">			<span class="keyword">synchronized</span> (engine.getPauseLock()) &#123;</div><div class="line">				<span class="keyword">if</span> (pause.get()) &#123;</div><div class="line">					L.d(LOG_WAITING_FOR_RESUME, memoryCacheKey);</div><div class="line">					<span class="keyword">try</span> &#123;</div><div class="line">						engine.getPauseLock().wait();</div><div class="line">					&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">						L.e(LOG_TASK_INTERRUPTED, memoryCacheKey);</div><div class="line">						<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">					&#125;</div><div class="line">					L.d(LOG_RESUME_AFTER_PAUSE, memoryCacheKey);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> isTaskNotActual();</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>如果engine对象处于暂停状态的时候,会让阻塞当前运行的线程,等待engine再次调用 <em>resume</em> 方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** <span class="doctag">@return</span> &lt;b&gt;true&lt;/b&gt; - if task should be interrupted; &lt;b&gt;false&lt;/b&gt; - otherwise */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">delayIfNeed</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (options.shouldDelayBeforeLoading()) &#123;</div><div class="line">			L.d(LOG_DELAY_BEFORE_LOADING, options.getDelayBeforeLoading(), memoryCacheKey);</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				Thread.sleep(options.getDelayBeforeLoading());</div><div class="line">			&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">				L.e(LOG_TASK_INTERRUPTED, memoryCacheKey);</div><div class="line">				<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> isTaskNotActual();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>如果在配置中设定了延迟显示的属性的话,休眠设置的时间然后继续执行.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">ReentrantLock loadFromUriLock = imageLoadingInfo.loadFromUriLock;</div><div class="line">		L.d(LOG_START_DISPLAY_IMAGE_TASK, memoryCacheKey);</div><div class="line">		<span class="keyword">if</span> (loadFromUriLock.isLocked()) &#123;</div><div class="line">			L.d(LOG_WAITING_FOR_IMAGE_LOADED, memoryCacheKey);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		loadFromUriLock.lock();</div></pre></td></tr></table></figure>
<p>对应前面url锁,一个url对应一个锁对象,这样同一时间内相同的URL只有一个任务在运行.<br>下面的 <em>checkTaskNotActual</em> 在前面讲过了,无非就是判断view的状态是否可用,这里不重复了</p>
<p>然后再次从内存中获取,这是因为加锁的原因,可能前面的线程已经把相同的url加载完成了,这里就先从内存中获取一下,防止重复下载.<br>如何没有找到bitmap对象就进入核心方法 <em>tryLoadBitmap</em> 中,这个方法就完成了上面的本地存储查找,如果没有的就从网上下载的逻辑,最后和上面一样,交给displayer来显示.下面重点讲下 <em>tryLoadBitmap</em> 这个方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Bitmap <span class="title">tryLoadBitmap</span><span class="params">()</span> <span class="keyword">throws</span> TaskCancelledException </span>&#123;</div><div class="line">		Bitmap bitmap = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			File imageFile = configuration.diskCache.get(uri);</div><div class="line">			<span class="keyword">if</span> (imageFile != <span class="keyword">null</span> &amp;&amp; imageFile.exists() &amp;&amp; imageFile.length() &gt; <span class="number">0</span>) &#123;</div><div class="line">				L.d(LOG_LOAD_IMAGE_FROM_DISK_CACHE, memoryCacheKey);</div><div class="line">				loadedFrom = LoadedFrom.DISC_CACHE;</div><div class="line"></div><div class="line">				checkTaskNotActual();</div><div class="line">				bitmap = decodeImage(Scheme.FILE.wrap(imageFile.getAbsolutePath()));</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (bitmap == <span class="keyword">null</span> || bitmap.getWidth() &lt;= <span class="number">0</span> || bitmap.getHeight() &lt;= <span class="number">0</span>) &#123;</div><div class="line">				L.d(LOG_LOAD_IMAGE_FROM_NETWORK, memoryCacheKey);</div><div class="line">				loadedFrom = LoadedFrom.NETWORK;</div><div class="line"></div><div class="line">				String imageUriForDecoding = uri;</div><div class="line">				<span class="keyword">if</span> (options.isCacheOnDisk() &amp;&amp; tryCacheImageOnDisk()) &#123;</div><div class="line">					imageFile = configuration.diskCache.get(uri);</div><div class="line">					<span class="keyword">if</span> (imageFile != <span class="keyword">null</span>) &#123;</div><div class="line">						imageUriForDecoding = Scheme.FILE.wrap(imageFile.getAbsolutePath());</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				checkTaskNotActual();</div><div class="line">				bitmap = decodeImage(imageUriForDecoding);</div><div class="line"></div><div class="line">				<span class="keyword">if</span> (bitmap == <span class="keyword">null</span> || bitmap.getWidth() &lt;= <span class="number">0</span> || bitmap.getHeight() &lt;= <span class="number">0</span>) &#123;</div><div class="line">					fireFailEvent(FailType.DECODING_ERROR, <span class="keyword">null</span>);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">catch</span> (IllegalStateException e) &#123;</div><div class="line">			fireFailEvent(FailType.NETWORK_DENIED, <span class="keyword">null</span>);</div><div class="line">		&#125; <span class="keyword">catch</span> (TaskCancelledException e) &#123;</div><div class="line">			<span class="keyword">throw</span> e;</div><div class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">			L.e(e);</div><div class="line">			fireFailEvent(FailType.IO_ERROR, e);</div><div class="line">		&#125; <span class="keyword">catch</span> (OutOfMemoryError e) &#123;</div><div class="line">			L.e(e);</div><div class="line">			fireFailEvent(FailType.OUT_OF_MEMORY, e);</div><div class="line">		&#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">			L.e(e);</div><div class="line">			fireFailEvent(FailType.UNKNOWN, e);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> bitmap;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>首先是从diskCache中查找有没有对应的图片对象,如果有的话交给 <em>decodeImage</em> 方法处理完图片之后直接返回,如果没有的话就进入下面的判断中<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">.....</div><div class="line"><span class="keyword">if</span> (options.isCacheOnDisk() &amp;&amp; tryCacheImageOnDisk()) &#123;</div><div class="line">					imageFile = configuration.diskCache.get(uri);</div><div class="line">					<span class="keyword">if</span> (imageFile != <span class="keyword">null</span>) &#123;</div><div class="line">						imageUriForDecoding = Scheme.FILE.wrap(imageFile.getAbsolutePath());</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">.....</div></pre></td></tr></table></figure></p>
<p>是否需要缓存到本地,如果需要的话进入 <em>tryCacheImageOnDisk</em> 这个方法用来从网络上下载图片<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">tryCacheImageOnDisk</span><span class="params">()</span> <span class="keyword">throws</span> TaskCancelledException </span>&#123;</div><div class="line">		L.d(LOG_CACHE_IMAGE_ON_DISK, memoryCacheKey);</div><div class="line"></div><div class="line">		<span class="keyword">boolean</span> loaded;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			loaded = downloadImage();</div><div class="line">			<span class="keyword">if</span> (loaded) &#123;</div><div class="line">				<span class="keyword">int</span> width = configuration.maxImageWidthForDiskCache;</div><div class="line">				<span class="keyword">int</span> height = configuration.maxImageHeightForDiskCache;</div><div class="line">				<span class="keyword">if</span> (width &gt; <span class="number">0</span> || height &gt; <span class="number">0</span>) &#123;</div><div class="line">					L.d(LOG_RESIZE_CACHED_IMAGE_FILE, memoryCacheKey);</div><div class="line">					resizeAndSaveImage(width, height); <span class="comment">// TODO : process boolean result</span></div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">			L.e(e);</div><div class="line">			loaded = <span class="keyword">false</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> loaded;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>进入 <em>downloadImage</em> 方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">downloadImage</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">  InputStream is = getDownloader().getStream(uri, options.getExtraForDownloader());</div><div class="line">  <span class="keyword">if</span> (is == <span class="keyword">null</span>) &#123;</div><div class="line">    L.e(ERROR_NO_IMAGE_STREAM, memoryCacheKey);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="keyword">return</span> configuration.diskCache.save(uri, is, <span class="keyword">this</span>);</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">      IoUtils.closeSilently(is);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到如果下载成功后,先把对象放入diskCache中,和最上面那个流程一样,下载先保存,然后从缓存中取.<br>这里 <em>getDownloader</em> 的对象是一个 <em>ImageDownloader</em> 接口对象,之所以要这样式因为UIL不仅仅可以处理http和https类型的图片,它也可以处理 “file:///“,”content://“,”assert://“,”drawable://“ 这些类型的URI,所以要根据不同的URI类型来找到不通的 <em>ImageDownloader</em> 加载图片.<br>最后当从内存中找到了对应的图片对象之后也是交给 <em>decode</em> 方法来处理图片. <em>decode</em> 主要是用来处理图片缩放的:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Bitmap <span class="title">decodeImage</span><span class="params">(String imageUri)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">  ViewScaleType viewScaleType = imageAware.getScaleType();</div><div class="line">  ImageDecodingInfo decodingInfo = <span class="keyword">new</span> ImageDecodingInfo(memoryCacheKey, imageUri, uri, targetSize, viewScaleType,</div><div class="line">      getDownloader(), options);</div><div class="line">  <span class="keyword">return</span> decoder.decode(decodingInfo);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里ImageDecodingInfo也是一个中间对象,用来把需要的参数都封装成一个对象传给Decoder对象<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ImageDecoder</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Decodes image to &#123;<span class="doctag">@link</span> Bitmap&#125; according target size and other parameters.</div><div class="line">	 *</div><div class="line">	 * <span class="doctag">@param</span> imageDecodingInfo</div><div class="line">	 * <span class="doctag">@return</span></div><div class="line">	 * <span class="doctag">@throws</span> IOException</div><div class="line">	 */</div><div class="line">	<span class="function">Bitmap <span class="title">decode</span><span class="params">(ImageDecodingInfo imageDecodingInfo)</span> <span class="keyword">throws</span> IOException</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseImageDecoder</span> <span class="keyword">implements</span> <span class="title">ImageDecoder</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOG_SUBSAMPLE_IMAGE = <span class="string">"Subsample original image (%1$s) to %2$s (scale = %3$d) [%4$s]"</span>;</div><div class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOG_SCALE_IMAGE = <span class="string">"Scale subsampled image (%1$s) to %2$s (scale = %3$.5f) [%4$s]"</span>;</div><div class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOG_ROTATE_IMAGE = <span class="string">"Rotate image on %1$d\u00B0 [%2$s]"</span>;</div><div class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOG_FLIP_IMAGE = <span class="string">"Flip image horizontally [%s]"</span>;</div><div class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> String ERROR_NO_IMAGE_STREAM = <span class="string">"No stream for image [%s]"</span>;</div><div class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> String ERROR_CANT_DECODE_IMAGE = <span class="string">"Image can't be decoded [%s]"</span>;</div><div class="line"></div><div class="line">	<span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> loggingEnabled;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">BaseImageDecoder</span><span class="params">(<span class="keyword">boolean</span> loggingEnabled)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.loggingEnabled = loggingEnabled;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Decodes image from URI into &#123;<span class="doctag">@link</span> Bitmap&#125;. Image is scaled close to incoming &#123;<span class="doctag">@linkplain</span> ImageSize target size&#125;</div><div class="line">	 * during decoding (depend on incoming parameters).</div><div class="line">	 *</div><div class="line">	 * <span class="doctag">@param</span> decodingInfo Needed data for decoding image</div><div class="line">	 * <span class="doctag">@return</span> Decoded bitmap</div><div class="line">	 * <span class="doctag">@throws</span> IOException                   if some I/O exception occurs during image reading</div><div class="line">	 * <span class="doctag">@throws</span> UnsupportedOperationException if image URI has unsupported scheme(protocol)</div><div class="line">	 */</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> Bitmap <span class="title">decode</span><span class="params">(ImageDecodingInfo decodingInfo)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">		Bitmap decodedBitmap;</div><div class="line">		ImageFileInfo imageInfo;</div><div class="line"></div><div class="line">		InputStream imageStream = getImageStream(decodingInfo);</div><div class="line">		<span class="keyword">if</span> (imageStream == <span class="keyword">null</span>) &#123;</div><div class="line">			L.e(ERROR_NO_IMAGE_STREAM, decodingInfo.getImageKey());</div><div class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			imageInfo = defineImageSizeAndRotation(imageStream, decodingInfo);</div><div class="line">			imageStream = resetStream(imageStream, decodingInfo);</div><div class="line">			Options decodingOptions = prepareDecodingOptions(imageInfo.imageSize, decodingInfo);</div><div class="line">			decodedBitmap = BitmapFactory.decodeStream(imageStream, <span class="keyword">null</span>, decodingOptions);</div><div class="line">		&#125; <span class="keyword">finally</span> &#123;</div><div class="line">			IoUtils.closeSilently(imageStream);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (decodedBitmap == <span class="keyword">null</span>) &#123;</div><div class="line">			L.e(ERROR_CANT_DECODE_IMAGE, decodingInfo.getImageKey());</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			decodedBitmap = considerExactScaleAndOrientatiton(decodedBitmap, decodingInfo, imageInfo.exif.rotation,</div><div class="line">					imageInfo.exif.flipHorizontal);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> decodedBitmap;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">protected</span> InputStream <span class="title">getImageStream</span><span class="params">(ImageDecodingInfo decodingInfo)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">		<span class="keyword">return</span> decodingInfo.getDownloader().getStream(decodingInfo.getImageUri(), decodingInfo.getExtraForDownloader());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">protected</span> ImageFileInfo <span class="title">defineImageSizeAndRotation</span><span class="params">(InputStream imageStream, ImageDecodingInfo decodingInfo)</span></span></div><div class="line">			<span class="keyword">throws</span> IOException &#123;</div><div class="line">		Options options = <span class="keyword">new</span> Options();</div><div class="line">		options.inJustDecodeBounds = <span class="keyword">true</span>;</div><div class="line">		BitmapFactory.decodeStream(imageStream, <span class="keyword">null</span>, options);</div><div class="line"></div><div class="line">		ExifInfo exif;</div><div class="line">		String imageUri = decodingInfo.getImageUri();</div><div class="line">		<span class="keyword">if</span> (decodingInfo.shouldConsiderExifParams() &amp;&amp; canDefineExifParams(imageUri, options.outMimeType)) &#123;</div><div class="line">			exif = defineExifOrientation(imageUri);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			exif = <span class="keyword">new</span> ExifInfo();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ImageFileInfo(<span class="keyword">new</span> ImageSize(options.outWidth, options.outHeight, exif.rotation), exif);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">canDefineExifParams</span><span class="params">(String imageUri, String mimeType)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">"image/jpeg"</span>.equalsIgnoreCase(mimeType) &amp;&amp; (Scheme.ofUri(imageUri) == Scheme.FILE);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">protected</span> ExifInfo <span class="title">defineExifOrientation</span><span class="params">(String imageUri)</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> rotation = <span class="number">0</span>;</div><div class="line">		<span class="keyword">boolean</span> flip = <span class="keyword">false</span>;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			ExifInterface exif = <span class="keyword">new</span> ExifInterface(Scheme.FILE.crop(imageUri));</div><div class="line">			<span class="keyword">int</span> exifOrientation = exif.getAttributeInt(ExifInterface.TAG_ORIENTATION, ExifInterface.ORIENTATION_NORMAL);</div><div class="line">			<span class="keyword">switch</span> (exifOrientation) &#123;</div><div class="line">				<span class="keyword">case</span> ExifInterface.ORIENTATION_FLIP_HORIZONTAL:</div><div class="line">					flip = <span class="keyword">true</span>;</div><div class="line">				<span class="keyword">case</span> ExifInterface.ORIENTATION_NORMAL:</div><div class="line">					rotation = <span class="number">0</span>;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				<span class="keyword">case</span> ExifInterface.ORIENTATION_TRANSVERSE:</div><div class="line">					flip = <span class="keyword">true</span>;</div><div class="line">				<span class="keyword">case</span> ExifInterface.ORIENTATION_ROTATE_90:</div><div class="line">					rotation = <span class="number">90</span>;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				<span class="keyword">case</span> ExifInterface.ORIENTATION_FLIP_VERTICAL:</div><div class="line">					flip = <span class="keyword">true</span>;</div><div class="line">				<span class="keyword">case</span> ExifInterface.ORIENTATION_ROTATE_180:</div><div class="line">					rotation = <span class="number">180</span>;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				<span class="keyword">case</span> ExifInterface.ORIENTATION_TRANSPOSE:</div><div class="line">					flip = <span class="keyword">true</span>;</div><div class="line">				<span class="keyword">case</span> ExifInterface.ORIENTATION_ROTATE_270:</div><div class="line">					rotation = <span class="number">270</span>;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">			L.w(<span class="string">"Can't read EXIF tags from file [%s]"</span>, imageUri);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ExifInfo(rotation, flip);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">protected</span> Options <span class="title">prepareDecodingOptions</span><span class="params">(ImageSize imageSize, ImageDecodingInfo decodingInfo)</span> </span>&#123;</div><div class="line">		ImageScaleType scaleType = decodingInfo.getImageScaleType();</div><div class="line">		<span class="keyword">int</span> scale;</div><div class="line">		<span class="keyword">if</span> (scaleType == ImageScaleType.NONE) &#123;</div><div class="line">			scale = <span class="number">1</span>;</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (scaleType == ImageScaleType.NONE_SAFE) &#123;</div><div class="line">			scale = ImageSizeUtils.computeMinImageSampleSize(imageSize);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			ImageSize targetSize = decodingInfo.getTargetSize();</div><div class="line">			<span class="keyword">boolean</span> powerOf2 = scaleType == ImageScaleType.IN_SAMPLE_POWER_OF_2;</div><div class="line">			scale = ImageSizeUtils.computeImageSampleSize(imageSize, targetSize, decodingInfo.getViewScaleType(), powerOf2);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (scale &gt; <span class="number">1</span> &amp;&amp; loggingEnabled) &#123;</div><div class="line">			L.d(LOG_SUBSAMPLE_IMAGE, imageSize, imageSize.scaleDown(scale), scale, decodingInfo.getImageKey());</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		Options decodingOptions = decodingInfo.getDecodingOptions();</div><div class="line">		decodingOptions.inSampleSize = scale;</div><div class="line">		<span class="keyword">return</span> decodingOptions;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">protected</span> InputStream <span class="title">resetStream</span><span class="params">(InputStream imageStream, ImageDecodingInfo decodingInfo)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">		<span class="keyword">if</span> (imageStream.markSupported()) &#123;</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				imageStream.reset();</div><div class="line">				<span class="keyword">return</span> imageStream;</div><div class="line">			&#125; <span class="keyword">catch</span> (IOException ignored) &#123;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		IoUtils.closeSilently(imageStream);</div><div class="line">		<span class="keyword">return</span> getImageStream(decodingInfo);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">protected</span> Bitmap <span class="title">considerExactScaleAndOrientatiton</span><span class="params">(Bitmap subsampledBitmap, ImageDecodingInfo decodingInfo,</span></span></div><div class="line">			<span class="keyword">int</span> rotation, <span class="keyword">boolean</span> flipHorizontal) &#123;</div><div class="line">		Matrix m = <span class="keyword">new</span> Matrix();</div><div class="line">		<span class="comment">// Scale to exact size if need</span></div><div class="line">		ImageScaleType scaleType = decodingInfo.getImageScaleType();</div><div class="line">		<span class="keyword">if</span> (scaleType == ImageScaleType.EXACTLY || scaleType == ImageScaleType.EXACTLY_STRETCHED) &#123;</div><div class="line">			ImageSize srcSize = <span class="keyword">new</span> ImageSize(subsampledBitmap.getWidth(), subsampledBitmap.getHeight(), rotation);</div><div class="line">			<span class="keyword">float</span> scale = ImageSizeUtils.computeImageScale(srcSize, decodingInfo.getTargetSize(), decodingInfo</div><div class="line">					.getViewScaleType(), scaleType == ImageScaleType.EXACTLY_STRETCHED);</div><div class="line">			<span class="keyword">if</span> (Float.compare(scale, <span class="number">1f</span>) != <span class="number">0</span>) &#123;</div><div class="line">				m.setScale(scale, scale);</div><div class="line"></div><div class="line">				<span class="keyword">if</span> (loggingEnabled) &#123;</div><div class="line">					L.d(LOG_SCALE_IMAGE, srcSize, srcSize.scale(scale), scale, decodingInfo.getImageKey());</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// Flip bitmap if need</span></div><div class="line">		<span class="keyword">if</span> (flipHorizontal) &#123;</div><div class="line">			m.postScale(-<span class="number">1</span>, <span class="number">1</span>);</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (loggingEnabled) L.d(LOG_FLIP_IMAGE, decodingInfo.getImageKey());</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// Rotate bitmap if need</span></div><div class="line">		<span class="keyword">if</span> (rotation != <span class="number">0</span>) &#123;</div><div class="line">			m.postRotate(rotation);</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (loggingEnabled) L.d(LOG_ROTATE_IMAGE, rotation, decodingInfo.getImageKey());</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		Bitmap finalBitmap = Bitmap.createBitmap(subsampledBitmap, <span class="number">0</span>, <span class="number">0</span>, subsampledBitmap.getWidth(), subsampledBitmap</div><div class="line">				.getHeight(), m, <span class="keyword">true</span>);</div><div class="line">		<span class="keyword">if</span> (finalBitmap != subsampledBitmap) &#123;</div><div class="line">			subsampledBitmap.recycle();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> finalBitmap;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ExifInfo</span> </span>&#123;</div><div class="line"></div><div class="line">		<span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> rotation;</div><div class="line">		<span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> flipHorizontal;</div><div class="line"></div><div class="line">		<span class="function"><span class="keyword">protected</span> <span class="title">ExifInfo</span><span class="params">()</span> </span>&#123;</div><div class="line">			<span class="keyword">this</span>.rotation = <span class="number">0</span>;</div><div class="line">			<span class="keyword">this</span>.flipHorizontal = <span class="keyword">false</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="function"><span class="keyword">protected</span> <span class="title">ExifInfo</span><span class="params">(<span class="keyword">int</span> rotation, <span class="keyword">boolean</span> flipHorizontal)</span> </span>&#123;</div><div class="line">			<span class="keyword">this</span>.rotation = rotation;</div><div class="line">			<span class="keyword">this</span>.flipHorizontal = flipHorizontal;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageFileInfo</span> </span>&#123;</div><div class="line"></div><div class="line">		<span class="keyword">public</span> <span class="keyword">final</span> ImageSize imageSize;</div><div class="line">		<span class="keyword">public</span> <span class="keyword">final</span> ExifInfo exif;</div><div class="line"></div><div class="line">		<span class="function"><span class="keyword">protected</span> <span class="title">ImageFileInfo</span><span class="params">(ImageSize imageSize, ExifInfo exif)</span> </span>&#123;</div><div class="line">			<span class="keyword">this</span>.imageSize = imageSize;</div><div class="line">			<span class="keyword">this</span>.exif = exif;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到decoder类对Bitmap根据需要做了缩放和旋转处理,如果必要的话.这里涉及到Bitmap操作的api,这里就不展开了,后续有时间我们介绍一下Bitmap的常用操作方法.<br>回到 <em>LoadAndDisplayImageTask</em> 的run方法,可以看到,这里在等到获取到Bitmap对象之后,可以调用getPreProcessor来对对象做二次处理,然后放入内存缓存中,最后也可以再对Bitmap做一次处理,如果设置了getPostProcessor的话,最后就交给 <em>DisplayBitmapTask</em> 去显示图片了,和上面的 <em>ProcessAndDisplayImageTask</em> 一样.</p>
<p>核心加载流程就讲完了,是不是很容易理解,其实也没有上面特别拿点的地方,只要明白加载的流程就很容易跟到代码了.最后简单介绍一下config对象的相关属性:</p>
<h4 id="ImageLoaderConfiguration"><a href="#ImageLoaderConfiguration" class="headerlink" title="ImageLoaderConfiguration"></a>ImageLoaderConfiguration</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageLoaderConfiguration</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> Resources resources;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> maxImageWidthForMemoryCache;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> maxImageHeightForMemoryCache;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> maxImageWidthForDiskCache;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> maxImageHeightForDiskCache;</div><div class="line">	<span class="keyword">final</span> BitmapProcessor processorForDiskCache;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> Executor taskExecutor;</div><div class="line">	<span class="keyword">final</span> Executor taskExecutorForCachedImages;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> customExecutor;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> customExecutorForCachedImages;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> threadPoolSize;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> threadPriority;</div><div class="line">	<span class="keyword">final</span> QueueProcessingType tasksProcessingType;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> MemoryCache memoryCache;</div><div class="line">	<span class="keyword">final</span> DiskCache diskCache;</div><div class="line">	<span class="keyword">final</span> ImageDownloader downloader;</div><div class="line">	<span class="keyword">final</span> ImageDecoder decoder;</div><div class="line">	<span class="keyword">final</span> DisplayImageOptions defaultDisplayImageOptions;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> ImageDownloader networkDeniedDownloader;</div><div class="line">	<span class="keyword">final</span> ImageDownloader slowNetworkDownloader;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="title">ImageLoaderConfiguration</span><span class="params">(<span class="keyword">final</span> Builder builder)</span> </span>&#123;</div><div class="line">		resources = builder.context.getResources();</div><div class="line">		maxImageWidthForMemoryCache = builder.maxImageWidthForMemoryCache;</div><div class="line">		maxImageHeightForMemoryCache = builder.maxImageHeightForMemoryCache;</div><div class="line">		maxImageWidthForDiskCache = builder.maxImageWidthForDiskCache;</div><div class="line">		maxImageHeightForDiskCache = builder.maxImageHeightForDiskCache;</div><div class="line">		processorForDiskCache = builder.processorForDiskCache;</div><div class="line">		taskExecutor = builder.taskExecutor;</div><div class="line">		taskExecutorForCachedImages = builder.taskExecutorForCachedImages;</div><div class="line">		threadPoolSize = builder.threadPoolSize;</div><div class="line">		threadPriority = builder.threadPriority;</div><div class="line">		tasksProcessingType = builder.tasksProcessingType;</div><div class="line">		diskCache = builder.diskCache;</div><div class="line">		memoryCache = builder.memoryCache;</div><div class="line">		defaultDisplayImageOptions = builder.defaultDisplayImageOptions;</div><div class="line">		downloader = builder.downloader;</div><div class="line">		decoder = builder.decoder;</div><div class="line"></div><div class="line">		customExecutor = builder.customExecutor;</div><div class="line">		customExecutorForCachedImages = builder.customExecutorForCachedImages;</div><div class="line"></div><div class="line">		networkDeniedDownloader = <span class="keyword">new</span> NetworkDeniedImageDownloader(downloader);</div><div class="line">		slowNetworkDownloader = <span class="keyword">new</span> SlowNetworkImageDownloader(downloader);</div><div class="line"></div><div class="line">		L.writeDebugLogs(builder.writeLogs);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ImageLoaderConfiguration <span class="title">createDefault</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> Builder(context).build();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function">ImageSize <span class="title">getMaxImageSize</span><span class="params">()</span> </span>&#123;</div><div class="line">		DisplayMetrics displayMetrics = resources.getDisplayMetrics();</div><div class="line"></div><div class="line">		<span class="keyword">int</span> width = maxImageWidthForMemoryCache;</div><div class="line">		<span class="keyword">if</span> (width &lt;= <span class="number">0</span>) &#123;</div><div class="line">			width = displayMetrics.widthPixels;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">int</span> height = maxImageHeightForMemoryCache;</div><div class="line">		<span class="keyword">if</span> (height &lt;= <span class="number">0</span>) &#123;</div><div class="line">			height = displayMetrics.heightPixels;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ImageSize(width, height);</div><div class="line">	&#125;</div><div class="line">  ....</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>config对象的属性起名很清晰,基本和字面翻译一致,可以看到很多地方都可以配置,比如线程池,decoder等对象,非常的灵活.方便根据需求去扩展.</p>
<p>最后的最后,来看下两个接口,分别对应图片二次处理和图片显示的</p>
<h4 id="processor-和-displayer"><a href="#processor-和-displayer" class="headerlink" title="processor 和 displayer"></a>processor 和 displayer</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BitmapProcessor</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function">Bitmap <span class="title">process</span><span class="params">(Bitmap bitmap)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BitmapDisplayer</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">display</span><span class="params">(Bitmap bitmap, ImageAware imageAware, LoadedFrom loadedFrom)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里可以根据需求去实现自己的process和displayer,UIL已经给提供了几种displayer了,比如 <em>CircleBitmapDisplayer</em> , <em>FadeInBitmapDisplayer</em> 等,位于core包目录下的display包下面,感兴趣的话可以自己看下实现.</p>
<h3 id="DefaultConfigurationFactory"><a href="#DefaultConfigurationFactory" class="headerlink" title="DefaultConfigurationFactory"></a>DefaultConfigurationFactory</h3><p>这个类用来生成默认的config和option对象的,都是一些简单的初始化操作,这里就不讲了,具体的请看代码实现.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultConfigurationFactory</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">/** Creates default implementation of task executor */</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Executor <span class="title">createExecutor</span><span class="params">(<span class="keyword">int</span> threadPoolSize, <span class="keyword">int</span> threadPriority,</span></span></div><div class="line">			QueueProcessingType tasksProcessingType) &#123;</div><div class="line">		<span class="keyword">boolean</span> lifo = tasksProcessingType == QueueProcessingType.LIFO;</div><div class="line">		BlockingQueue&lt;Runnable&gt; taskQueue =</div><div class="line">				lifo ? <span class="keyword">new</span> LIFOLinkedBlockingDeque&lt;Runnable&gt;() : <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;();</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ThreadPoolExecutor(threadPoolSize, threadPoolSize, <span class="number">0L</span>, TimeUnit.MILLISECONDS, taskQueue,</div><div class="line">				createThreadFactory(threadPriority, <span class="string">"uil-pool-"</span>));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** Creates default implementation of task distributor */</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Executor <span class="title">createTaskDistributor</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> Executors.newCachedThreadPool(createThreadFactory(Thread.NORM_PRIORITY, <span class="string">"uil-pool-d-"</span>));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** Creates &#123;<span class="doctag">@linkplain</span> HashCodeFileNameGenerator default implementation&#125; of FileNameGenerator */</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> FileNameGenerator <span class="title">createFileNameGenerator</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> HashCodeFileNameGenerator();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Creates default implementation of &#123;<span class="doctag">@link</span> DiskCache&#125; depends on incoming parameters</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DiskCache <span class="title">createDiskCache</span><span class="params">(Context context, FileNameGenerator diskCacheFileNameGenerator,</span></span></div><div class="line">			<span class="keyword">long</span> diskCacheSize, <span class="keyword">int</span> diskCacheFileCount) &#123;</div><div class="line">		File reserveCacheDir = createReserveDiskCacheDir(context);</div><div class="line">		<span class="keyword">if</span> (diskCacheSize &gt; <span class="number">0</span> || diskCacheFileCount &gt; <span class="number">0</span>) &#123;</div><div class="line">			File individualCacheDir = StorageUtils.getIndividualCacheDirectory(context);</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				<span class="keyword">return</span> <span class="keyword">new</span> LruDiskCache(individualCacheDir, reserveCacheDir, diskCacheFileNameGenerator, diskCacheSize,</div><div class="line">						diskCacheFileCount);</div><div class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">				L.e(e);</div><div class="line">				<span class="comment">// continue and create unlimited cache</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		File cacheDir = StorageUtils.getCacheDirectory(context);</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> UnlimitedDiskCache(cacheDir, reserveCacheDir, diskCacheFileNameGenerator);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** Creates reserve disk cache folder which will be used if primary disk cache folder becomes unavailable */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> File <span class="title">createReserveDiskCacheDir</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">		File cacheDir = StorageUtils.getCacheDirectory(context, <span class="keyword">false</span>);</div><div class="line">		File individualDir = <span class="keyword">new</span> File(cacheDir, <span class="string">"uil-images"</span>);</div><div class="line">		<span class="keyword">if</span> (individualDir.exists() || individualDir.mkdir()) &#123;</div><div class="line">			cacheDir = individualDir;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> cacheDir;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Creates default implementation of &#123;<span class="doctag">@link</span> MemoryCache&#125; - &#123;<span class="doctag">@link</span> LruMemoryCache&#125;&lt;br /&gt;</div><div class="line">	 * Default cache size = 1/8 of available app memory.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MemoryCache <span class="title">createMemoryCache</span><span class="params">(Context context, <span class="keyword">int</span> memoryCacheSize)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (memoryCacheSize == <span class="number">0</span>) &#123;</div><div class="line">			ActivityManager am = (ActivityManager) context.getSystemService(Context.ACTIVITY_SERVICE);</div><div class="line">			<span class="keyword">int</span> memoryClass = am.getMemoryClass();</div><div class="line">			<span class="keyword">if</span> (hasHoneycomb() &amp;&amp; isLargeHeap(context)) &#123;</div><div class="line">				memoryClass = getLargeMemoryClass(am);</div><div class="line">			&#125;</div><div class="line">			memoryCacheSize = <span class="number">1024</span> * <span class="number">1024</span> * memoryClass / <span class="number">8</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> LruMemoryCache(memoryCacheSize);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">hasHoneycomb</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.HONEYCOMB;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@TargetApi</span>(Build.VERSION_CODES.HONEYCOMB)</div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isLargeHeap</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> (context.getApplicationInfo().flags &amp; ApplicationInfo.FLAG_LARGE_HEAP) != <span class="number">0</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@TargetApi</span>(Build.VERSION_CODES.HONEYCOMB)</div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getLargeMemoryClass</span><span class="params">(ActivityManager am)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> am.getLargeMemoryClass();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** Creates default implementation of &#123;<span class="doctag">@link</span> ImageDownloader&#125; - &#123;<span class="doctag">@link</span> BaseImageDownloader&#125; */</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ImageDownloader <span class="title">createImageDownloader</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> BaseImageDownloader(context);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** Creates default implementation of &#123;<span class="doctag">@link</span> ImageDecoder&#125; - &#123;<span class="doctag">@link</span> BaseImageDecoder&#125; */</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ImageDecoder <span class="title">createImageDecoder</span><span class="params">(<span class="keyword">boolean</span> loggingEnabled)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> BaseImageDecoder(loggingEnabled);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** Creates default implementation of &#123;<span class="doctag">@link</span> BitmapDisplayer&#125; - &#123;<span class="doctag">@link</span> SimpleBitmapDisplayer&#125; */</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BitmapDisplayer <span class="title">createBitmapDisplayer</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> SimpleBitmapDisplayer();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** Creates default implementation of &#123;<span class="doctag">@linkplain</span> ThreadFactory thread factory&#125; for task executor */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ThreadFactory <span class="title">createThreadFactory</span><span class="params">(<span class="keyword">int</span> threadPriority, String threadNamePrefix)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> DefaultThreadFactory(threadPriority, threadNamePrefix);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultThreadFactory</span> <span class="keyword">implements</span> <span class="title">ThreadFactory</span> </span>&#123;</div><div class="line"></div><div class="line">		<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicInteger poolNumber = <span class="keyword">new</span> AtomicInteger(<span class="number">1</span>);</div><div class="line"></div><div class="line">		<span class="keyword">private</span> <span class="keyword">final</span> ThreadGroup group;</div><div class="line">		<span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger threadNumber = <span class="keyword">new</span> AtomicInteger(<span class="number">1</span>);</div><div class="line">		<span class="keyword">private</span> <span class="keyword">final</span> String namePrefix;</div><div class="line">		<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> threadPriority;</div><div class="line"></div><div class="line">		DefaultThreadFactory(<span class="keyword">int</span> threadPriority, String threadNamePrefix) &#123;</div><div class="line">			<span class="keyword">this</span>.threadPriority = threadPriority;</div><div class="line">			group = Thread.currentThread().getThreadGroup();</div><div class="line">			namePrefix = threadNamePrefix + poolNumber.getAndIncrement() + <span class="string">"-thread-"</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span> </span>&#123;</div><div class="line">			Thread t = <span class="keyword">new</span> Thread(group, r, namePrefix + threadNumber.getAndIncrement(), <span class="number">0</span>);</div><div class="line">			<span class="keyword">if</span> (t.isDaemon()) t.setDaemon(<span class="keyword">false</span>);</div><div class="line">			t.setPriority(threadPriority);</div><div class="line">			<span class="keyword">return</span> t;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>到这里,UIL的源码主流程就分析完成了,这是第二个研究的开源项目,第一个是EventBus,以前老是觉得UIL非常的复杂,现在回头看了其实很简单,内部的调用也很清晰,看来还是得勇敢迈出第一步,这样才能提高.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://pheobusyy.github.io/2016/12/31/2016/计划与总结/2017年度计划/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanyi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pheobusyy">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/31/2016/计划与总结/2017年度计划/" itemprop="url">
                  2017年度计划
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-31T15:30:00+08:00">
                2016-12-31
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#2017年度计划</p>
<p>  今天是2016的最后一天,刚刚写完了201年度总结,对这一整年的所作所为做一个整体的总结,感觉还是很有收获的.下面开始填写2017年度的计划,还是分成工作,生活等这几个方面来说吧,最后再统一写一个list来量化要完成的内容.</p>
<h3 id="工作和技术方面"><a href="#工作和技术方面" class="headerlink" title="工作和技术方面"></a>工作和技术方面</h3><p>  通过一整年的学习,完成IOS和python的学习,达到实战的水平,然后完成一个项目,从前到后的做,包括客户端和服务端,成为一个合格的前端”全栈工程师”.要不断提高自己的技术竞争力,永不out,升职加薪,走上人生巅峰!</p>
<p>  同时也希望可以在github上有所贡献,最起码可以贡献几个开源项目,挣几个star.</p>
<p>  还有书写技术博客,来提升自己的技术品牌,说不定以后可以出书呢.</p>
<h3 id="生活方面"><a href="#生活方面" class="headerlink" title="生活方面"></a>生活方面</h3><h4 id="生活习惯方面"><a href="#生活习惯方面" class="headerlink" title="生活习惯方面"></a>生活习惯方面</h4><p>  2016的写日记的习惯要不断的坚持,同时不断的完善自己的日记模板,现在的方式有点low,先是写在pager,然后通过evernote传到手机上,再通过手机来复制到day one上,希望今天可以把这个流程简化,主要是文字的迁移上.</p>
<p>  身体方面要不断坚持跑步和每天的哑铃练习,跑步可以平衡自己身体均衡,哑铃可以锻炼自己的力量,一个有氧一个无氧,刚好相互结合,争取把体重搜到150斤一下,现在是快到160了,相当于廋10斤,只要可以把这两项坚持下来,应该问题不大.</p>
<p>  在时间管理方面有所进步,详细记录每天的事件详细,通过这个来判定自己的行为和效率.向柳比歇夫学习</p>
<p>  另外要培养一项自己的爱好,比如学习一门乐器,或者运动方式,现在还没想好做啥,在过春节前要定下来</p>
<p>  要养车读书的习惯,并且产出读书笔记,每周都要读一本书,这样一年可以读50多本了,非常可观的数目</p>
<p>  在记忆力的锻炼方面,可以尝试一下</p>
<p>  书法方面也想突破一下,现在这个字简直不能看</p>
<p>  希望可以提高自己的篮球水平,不能每次都被别人打爆,要学会两只手运球过人</p>
<h3 id="生活态度方面"><a href="#生活态度方面" class="headerlink" title="生活态度方面"></a>生活态度方面</h3><p>  希望自己不管遇到什么事情,都要乘沉着应对,大脑一定要清醒<br>  学会感恩,每天都要有进步,要不断的思考<br>  珍惜和家人在一起的每一天<br>  常和父母长辈联系</p>
<h3 id="感情方面"><a href="#感情方面" class="headerlink" title="感情方面"></a>感情方面</h3><p>  希望和老婆相处的越来越融洽,不为小事闹矛盾,同时争取生个健康的小baby</p>
<h3 id="条目"><a href="#条目" class="headerlink" title="条目"></a>条目</h3><ol>
<li>IOS和python达到实战的水平</li>
<li>完成一个从前到后的项目,包括客户端和服务端</li>
<li>github上要有自己的开源项目,争取获得到越多的star越好</li>
<li>书写技术博客,提升自己的技术品牌</li>
<li>坚持每天写日记,同时完成自己写日记的流程</li>
<li>每周都要读一本书,一年至少要读50本书</li>
<li>抽时间练习一下书法,改变自己难看的字</li>
<li>做一些记忆力的训练,提高自己的记忆力</li>
<li>养成跑步和每天哑铃的习惯,最终体重要减到150公斤以下,标准的体重是144</li>
<li>养成记录时间的习惯,通过时间管理和平衡自己的行为</li>
<li>培养一项个人爱好,乐器或者运动</li>
<li>锻炼自己遇到事情的处理能力,不能慌张,要沉着冷静</li>
<li>学会感恩</li>
<li>常和父母长辈联系</li>
<li><p>珍惜和家人在一起的每一天</p>
<p>要根据具体的环境和时间来合理安排计划的执行,比如锻炼身体的跑步可以安排在4,5月份开始天气暖和了之后,每周读书这种的话可以随时进行,那春天的重点是在技术提升上,夏天是在身体锻炼上,秋天可能是爱好培养和其他习惯的培养上,到了冬天就做一些整理和调整性的工作.</p>
</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://pheobusyy.github.io/2016/12/31/2016/计划与总结/2016年度总结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanyi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pheobusyy">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/31/2016/计划与总结/2016年度总结/" itemprop="url">
                  2016年度总结
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-31T10:08:00+08:00">
                2016-12-31
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="2016年度总结"><a href="#2016年度总结" class="headerlink" title="2016年度总结"></a>2016年度总结</h2><p>  今天是16年的最后一天了,决定对今年一整年做一个总结,看看这一年都有哪些收获和感悟,得到了什么,还没有得到什么,需要后续继续努力得到什么.</p>
<h3 id="工作方面"><a href="#工作方面" class="headerlink" title="工作方面"></a>工作方面</h3><p>  先说环境,从天下互联离开之后辗转金和,最后再到现在的用有,相当于一个职业的重新归零吧,想想在天下互联这5年自己的收获,不能说没有但是效果不尽如人意,技术上的进步基本上是靠自己的零敲碎打的学来的,流程的规范和大公司也没法相提并论,包括各种软硬件配置也是相差的很远,最大的成就可能就是通过邱哥丈母娘然后认识了我亲爱的老婆吧,现在的用有感觉软硬件都还可以,有班车食堂,有各种娱乐设施,最最满意的可以打篮球锻炼身体,同时单位距离家里的路程还是可以接受的,每天开车上下班,40多分钟就可以到公司和回家,想想之前每天光是在公交车上花费的事件就要1个半小时,这还是不包括走路还要走好远的事件,每天有4个小时都浪费在路途上,想想自己居然坚持了两年多真心不容易;</p>
<p>  其次再说领导,潘哥作为一个领导的话严格来说是不称职的,同时思维的局限性也制约了他的眼界和想法.导致我们这些小弟没有学到怎么做管理如何才能发动手下的兄弟一个奋斗有个清晰的目标管理.这些统统没有.来到用友之后马哥作为自己的新领导感觉对手下人都非常的和善,只要工作上按时完成要求其他一概可以ok,没有像以前对潘哥那么的心里压力,老是感觉很纠结,特别容易郁闷.</p>
<p>  最后是心情,以前在天下的时候每天感觉很压抑,看不到希望,那个东西翻来覆去做了那么多年,到现在还是那个样子,不能说自己的问题吧但是更多的是战略和用人的问题.之前老是觉得不合理需求坑爹的肯定是产品或者潘哥提的,后来潘哥走了之后直面老板发现,好吧确实错怪潘哥了,老板的思维可能停留在自己以前的辉煌时刻吧,现在真心已经out了,无法跟上现在节奏,抓不到现在用户的痛点同时也没有个明确的定位,大而空的东西很难成功.用人上潘哥为了”省钱”根本就不会把牛人给找进来,威胁自己的地位,这不能不说是一个从上到下的悲剧,后来幡然悔悟可是已经错过了.看着每次老板忽悠着各种假大空,渐渐感觉得很恶心,决定换工作,当时在找工作的时候感觉自己的水平真的很差,有很多东西是在面试过程中逼着自己学的,后来慢慢的面试的准备过过程中发现java基础,设计模式这些东西的好处了,面试的时候也不在慌张,对自己有了点点信心.这里有个小插曲就是差一点点就进入宜信了,当时面试3轮都非常的成功,可能最后就是错在找了猎头的问题上.这叫有缘无分吧,在金和的那一个月也不是很开心,做的东西和环境很糟糕,身边的人的想法和做法比较官僚主义,也是无法忍受,最后来到了用有,整体我都非常满意,除了可能待遇上比外面差一点点,其他可以总结为事少钱多离家近.现状就是身边的人有点不太负责任,混日子的比较多,自己还是在坚持做点东西的,想把东西做好,同时积极主动的帮着解决一些问题.总之,这一年的工作还是比较满意的,希望能在用有多呆段日子吧.调养下身心.</p>
<h3 id="技术方面"><a href="#技术方面" class="headerlink" title="技术方面"></a>技术方面</h3><p>  2016年技术来说是有巨大进步的一年,回想之前的工作的种种遇到的问题,可能很多的症结就是在java基础和编程思想上,也从根本上明白了java基础的重要性,从更高层面上对编程有个整体的认识,这点我觉得是巨大的收获.这可能就是之前大家都在说的”道”与”术”的区别,也就是”战略”和”战术”的区别,只要明白了很多抽象的东西,那所有的编程语言都是一样的,唯一不一样的可能是实现的思想和具体的语法,这个是通过学习IOS的过程中发现的;最终编程的目的就是实现各种各样帮助别人的工具或者提供信息的资源.而为什么我们平时要写很多很多的代码,其实是为了”缓存”的具体实现,有了”缓存”就可以把各种东西分层,然后替换,一种整体模块化的思想.我觉得这点是最重要的.</p>
<p>  首先的收获就是算勉强学会了点点IOS,完成IOS的一个基础的学习,虽然距离实战还是有点距离的,但是起码对IOS整体有个初步的了解,确实比android简单,并且很多地方比安卓要求规范些,可能制约IOS入门最大的问题就剩Xcode了,嘿嘿</p>
<p>  还有就是写博客,各种博客,不仅仅是技术博客,还包括其他方面的博客,好记性不如烂笔头,通过文字来把生活中遇到的各种问题和解决方法写出来,是一次重新整理和消化的过程,同时也加深了记忆.现在的博客是一个刚刚的开始,期待明年可以有所突破吧,提高自己的文学编写能力和表达能力.</p>
<p>  另一个感悟就是最近阅读源码体会到的,如何才能快速的提高编程能力,我觉得主要有两个方面:一个是通过阅读别人的开源代码来看下别人是怎么实现一个东西的,同时里面有很多的api或者技巧可能自己根本就不知道或者不清楚怎么用,通过看比人的代码来达到一个学习的过程;另一个就是编程想要提高就要明确目的性,也就是你到底要做出个说明东西出来,要以目的来导向,实际所有的学习都应该是带着问题和目的去学习的,这样的效率是最高的.这个后面的收获感悟会重新说明一下.明白了这两点对提高编程思想至关重要,这样在后续的学习和工作工程中可以少走很多弯路.</p>
<p>  还有一个感悟就是在对待开源项目的使用方式,之前看到别人的都是原封不动的把对方代码拿来直接用了,把自己的代码和对方的代码都掺杂在一起了,后面如果要替换掉这个库发现代价非常的大,”拿来主义”是要讲究形式的,最好在调用的时候再加一层中间层来解耦,这样在后续代码调整的过程中,只要直接替换中间层代码就可以,上层的代码是不需要改变的.这点非常非常的重要.在调整架构的时候要时刻保持关注.</p>
<p>  最后一个感悟就是自动化对工作效率上的提升,不过这一点目前做的还不是很到位,比如一些重复性的工作应该写脚本自动化运行,比如通过VI的学习来加快编程的速度.还有通过写一个命令来完成常用操作,等等,这些重复性的工作最好是都交给自动化来处理,不能傻傻的”硬”写.</p>
<h3 id="生活方面"><a href="#生活方面" class="headerlink" title="生活方面"></a>生活方面</h3><p>  生活方面我准备分几个方面来讲,一个生活习惯方面,一个是生活态度方面.</p>
<h4 id="生活习惯方面"><a href="#生活习惯方面" class="headerlink" title="生活习惯方面"></a>生活习惯方面</h4><p>  2016年在习惯方面有个巨大的进步就是写日记,感谢day one这个神奇的app,事件的起因就是通过app限免安装了day one这个神奇的软件,软件做的非常棒,可能是因为挺贵的,所以就坚持了几天写日记,没想到居然坚持下来了,不得不说真是一个奇迹,要知道长这么大,今天的写日记可能是我坚持的最久的一个习惯了.看了day one上的记录,从今年的2月18号开始,一直到今天,坚持了277天,歇了278条记录,拍了575张照片,真的,这是从小到大我坚持最久的一个习惯活动.再次谢谢day one这个app,后续等有钱了就买一个mac上的付费版本.</p>
<p>  另外一个坚持的算比较久的就是哑铃了,从9月份开始的,中间断断续续的一直坚持到最近,每天晚上在快10点的时候来个几十下,慢慢的发现胳膊居然越来越力量了,看看小习惯大作用啊,不过最近挺了几天了,前段时间打球伤到腰了,导致练哑铃的时候腰部不适很舒服,看看今天晚上能不能重新开始,争取把右手力量也练出来.</p>
<p>  还有一个没坚持下来但是非常应该坚持的习惯就是跑步,在5月份的时候坚持了一段时间,后来中间不知道为啥就停了,11月的时候早上去跑过几次,不过后来由于雾霾和天气的问题就停了,冬天果然不是一个适合跑步的季节.看开春的时候能不能重新开始,明年争取像13年的时候通过跑步来完成身体和精神上的重塑.</p>
<p>  还有就是明白读书笔记的重要性,以前读书都是看一遍就完了,以后可能过段时间就不记得了,白看,后来明白了读书一定做读书笔记,把书里重要的或者写的很精辟的地方记下来,整理归档,这样才算真正的”读书”.也谢谢&lt;如何有效阅读一本书：超实用笔记读书法&gt;,虽然写的比较简单,但是对阅读的技巧提出的建议是非常实用的.</p>
<p>  最后就是在游戏方面,之前玩dota玩的比较多了,后来发现越来越费神,同时玩完之后有很大的内疚和空虚感,所以就把dota给删除了,同时游戏也玩的很少很少了.明白了游戏的局限性,在减压方面还是运动和休息来的效果明显.玩游戏会越玩越累.</p>
<h4 id="生活态度方面"><a href="#生活态度方面" class="headerlink" title="生活态度方面"></a>生活态度方面</h4><p>  在生活态度方面主要是有被两件事给影响到了:<br>  一个是去年做胆结石手术,感觉特别不值得,身体被工作给拖垮了,身心都受到了很大的影响,以前老是觉得自己很重要,没有自己啥都搞不定,单位没了我不行,后来发现自己真的没那么重要,同时自己在老板眼里也没有那么重要,为了工作把身体搞垮是真的不值当的.</p>
<p>  另外一个就是高中的好友”鸭子”在青岛由于工作压力过大去世了,一个活生生的例子出现在自己的身边,以前觉得过劳死这种事情离自己很远,光是在网上听说了没有很重视,现在就活生生的发生的自己的身边,”鸭子”刚在青岛买房结婚,家里就他一个孩子,还要还房贷,可能这些种种原因吧,把自己给拖垮了,人没了,说明东西都没有了意义.so,身体和陪伴家人最重要,好好珍惜和家人在一起的每一天,世道艰辛,我们唯一能做的就是乐观的活着,好好享受每一天.</p>
<p>  总结下来,就是好好享受生活,想吃啥吃点啥,想买啥买点啥,好好珍惜和家人在一起的日子,每天都要学会感恩,同时每天都要开开心心的.这样才是生活的真正态度.活在当下!</p>
<h3 id="感情方面"><a href="#感情方面" class="headerlink" title="感情方面"></a>感情方面</h3><p>  在感情方面,今年做的还算不错,和老婆的相处越来越融洽,吵架的次数越来越少,随之而来就是俩人越来越胖,在减肥的道路上越走越远了.这一年明白了和家人相处的重要性,所以对老婆也格外的关心和爱护,可以说大事小事全都她说了算,我也乐得费脑子去思考,虽然老是被她说自己彪,嘿嘿,不过我自己不觉得,我只是不够”灵活”而已啦.</p>
<p>  做的不太好的方面可能是给奶奶和家里打电话的次数不算多,没有好好关注一下他们的动态,奶奶换了房子也是后来才知道的,父母身体也是后知后觉,感觉亏欠他们很多,明年一定好好的报答他们这么多年的养育之恩.</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>  好的方面就是明白了身体的重要性,同时也知道思考的重要性,还有写作的重要性,这些都是可以提升自己的全面素质的东西.差的的方面可能就是在计划的制定和执行上,还是在计划的制定上比较杂乱,同时执行力上还是不够强,导致效率不是很高,希望这点在来年可以好好的改善.同时,通过不断的”自省”,我发现今天一年突然很有收获,时间也过得慢了很多,往年都是不知不觉就过完了,没啥感觉也没啥收获,今年算是一个左右成效的一年吧.我把它称为”开智元年”.期待2017年我可以收获更大的进步,同时在”开智”方面取得长足的进步.下面就是2017年的年度计划了哦.</p>
<p>  最后,祝愿我和我的家人在新的一年里身体健康,事事顺心.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://pheobusyy.github.io/2016/12/20/2016/Java多线程知识/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanyi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pheobusyy">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/20/2016/Java多线程知识/" itemprop="url">
                  Java多线程知识
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-20T15:45:00+08:00">
                2016-12-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ol>
<li>java的并行与并发</li>
<li>java线程安全的概念</li>
<li>java中CAS的概念</li>
<li>java中AtomicInteger相关类的实现原理</li>
<li>java乐观锁与悲观锁</li>
<li>java加锁 syncnized和reentrantlock</li>
<li>ReentrantLock的使用方法和原理</li>
<li>如何让多个线程顺序执行,迅雷面试题ABC三个线程顺序输出的问题</li>
<li>java的join方法</li>
<li>ReadWriteLock使用和实现原理</li>
<li>脏读,可重复读,幻读的概念</li>
<li>死锁相关概念</li>
<li>java信号量</li>
<li>java 多线程包下的常用类使用</li>
<li>生产者消费者</li>
</ol>
<h3 id="并发与并行"><a href="#并发与并行" class="headerlink" title="并发与并行"></a>并发与并行</h3><p>  并发性(concurrency) : 有称共行性,是指有能力处理多个同时性活动的能力,并发事件之间不一定要同一事件发生.<br>  并行(parallelism) : 是指同时发生的两个并发事件,具有并发的含义,而并发不一定并行.</p>
<p>  可见两者最大的区别是能否在同一时间进行.并行是并发的子集.</p>
<p><img src="/images/2016/12/并发与并行.jpg" alt="并发与并行图例"></p>
<h3 id="java线程安全的概念"><a href="#java线程安全的概念" class="headerlink" title="java线程安全的概念"></a>java线程安全的概念</h3><p>  java线程安全是相对多线程概念来提出的,线程安全是指一个方法或者类实例可以在不同的线程中同时使用而不会引起任何的问题.<br>  考虑一下下面的情况<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">int</span> myInt = <span class="number">0</span>;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">addOne</span><span class="params">()</span></span>&#123;</div><div class="line">  <span class="keyword">int</span> temp = myInt;</div><div class="line">  temp = temp + <span class="number">1</span>;</div><div class="line">  myInt = tmp;</div><div class="line">  <span class="keyword">return</span> temp;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>  现在有A和B两个线程将要同时执行addOne()方法,但是A先开始并且把myInt的值0赋给了temp,同时由于某些原因线程调度决定挂起A线程,同时执行B线程,B线程也是把myInt的值O赋值给了它自己的temp,并且方法完全执行结束,这个时候最终myInt=1 ,并且返回了1.现在又轮到了线程A,在A中的temp的值为0,执行加加一操作后,变为1,同时返回的值也为1.<br>  在上面的情况下,方法addOne执行了两边,但是由于该方法是非线程安全的导致没有返回预期的结果2,由于第二个线程先于第一个线程保存myInt的值,所以都是返回了1.</p>
<p>  创建线程安全的方法不算太繁琐,并且有一些技巧.在java中你可以声明一个方法为 <em>synchronized</em> ,这个关键字的含义是在同一时间只能有同一个线程来执行当前方法.其他线程需要等待.这会保证方法是线程安全的,但是假如在这个方法中有一堆事情要做的话会浪费很长的事件.另一种方式是 <em>对需要保证线程同步的方法中的部分</em> 来加锁或者信号量.只是锁住其中的一小部分(称为 <em>临界区</em> ).甚至在java中也提供了很多方法来保证非锁的线程安全,这些方法保证多线程可以在同一时间内竞争,并且导致该方法完成一套原子性的操作.原子性是指不能被中断并且在同一时间内只能在一个线程中执行. 后面我们会讲到的 <em>CAS</em> 就是这种方式的内部实现原理 .</p>
<h3 id="java中的CAS概念"><a href="#java中的CAS概念" class="headerlink" title="java中的CAS概念"></a>java中的CAS概念</h3><p>  CAS全称Compare And Swap ,即比较并交换,设计并发算法中常用到的一种技术,java.util.concurrent包完全建立在CAS的基础上.<br>  当前的处理器基本都支持CAS,只不过每家的实现不一样.<br>  <em>CAS有三个操作数,内存值V,旧的预期值A,要修改的值B,当且仅当预期的值A和内存值V相同时,将内存值修改为B并返回True,否者什么都不做返回False</em><br>  下面来看上面demo的CAS实现:<br>  首先myInt必须是 <em>valatile</em> 的了,这样才能保证多个线程之间的数据变化是可见的.(valatile的用法后面会提到)<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">int</span> valatile myInt = <span class="number">0</span>;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">get</span><span class="params">()</span></span>&#123;</div><div class="line">  <span class="keyword">return</span> myInt;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">addOneAndGet</span><span class="params">()</span></span>&#123;</div><div class="line">  <span class="keyword">for</span> (; ; ) &#123;</div><div class="line">    <span class="keyword">int</span> current = get();</div><div class="line">    <span class="keyword">int</span> next = current + <span class="number">1</span>;</div><div class="line">    <span class="keyword">if</span>(compareAndSet(current,next))&#123;</div><div class="line">      <span class="keyword">return</span> next;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>  这里通过方法 <em>compareAndSet</em> 来完成CAS的底层实现.也就是比较current和内存中的值,如果两个一样就放回true,退出死循环返回next,否者不断的从内存中获取和当前的current比较,知道匹配成功.这里通过一个死循环来达到不断更新current值得目的.<br>  再来回头想想上面的非线程安全情景,如果B处理完成后myInt变成1,这个时候A发现自己的myInt与内存中的不一致,就重新获取一下myInt的值,直到两者一致,然后完成加一操作,就达到了一种不用加锁也可以线程之间同步资源的目的.</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">compareAndSet</span><span class="params">(<span class="keyword">int</span> expect, <span class="keyword">int</span> update)</span> </span>&#123;   </div><div class="line">  <span class="keyword">return</span> unsafe.compareAndSwapInt(<span class="keyword">this</span>, valueOffset, expect, update);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>  这里unsafe是底层native的jni实现,借由C来调用CPU底层指令来实现的.</p>
<p>  上面的CAS实现其实也是java的同步包中 AtomicInteger的内部实现原理.</p>
<p>  可以看到CAS还是比较容易理解的,就是字面意思,对比然后赋值交换.下面说说CAS的缺点;</p>
<ol>
<li>ABA问题.因为CAS需要在操作的时候检查值有没有发生变化,如果没变化就更新,如果一个值原来是A,后来改成B,又变回到A,这个时候CAS检查发现值没有变化,实际上已经变化过了.这个就是ABA问题,通过在变量前面加上版本号的思路可以解决ABA问题,在变量前面加上版本号,每次变量更新的时候把版本号加1,那么A-B-A就会变成1A-2B-3A,这时就可以比较出第一个A和最后一个A是不一样的了.在java的current包中提供了AtomicStampedRefrence来解决ABA问题.</li>
<li>循环时间长开销大.自旋CAS如果长时间不成功,会给CPU带来很大的开销.如果JVM支持pause指令那么效率会有一定的提升.</li>
<li>只能保证一个共享变量的原子操作.很明显,上面的demo只是对一个变量做了原子加一操作.可以通过AtomicRefrence类来保证引用对象之间的原子性.</li>
</ol>
<h3 id="java中AtomicInteger的实现原理"><a href="#java中AtomicInteger的实现原理" class="headerlink" title="java中AtomicInteger的实现原理"></a>java中AtomicInteger的实现原理</h3><p>  AtomicInteger是一个完成的CAS实现,通过上面的CAS说明,可以发现最重要的就是比较内存值和当前值是否相等的逻辑.首先看如何获取内存值<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> &#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        valueOffset = unsafe.objectFieldOffset</div><div class="line">            (AtomicInteger.class.getDeclaredField(<span class="string">"value"</span>));</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123; <span class="keyword">throw</span> <span class="keyword">new</span> Error(ex); &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>  这个是通过底层native直接获取 <em>value</em> 在内存中的偏移量.注意这个是静态的,只是在初次使用的时候就获取完成.<br>  由于 <em>value</em> 是 <em>valitale</em> 的,所以value的变化在各个线程中是可见.这样就可以比较当前value和内存中value是否相等了.<br>  其他的细节在上面已经提到了,这里就不在重复了.</p>
<h3 id="java的乐观锁和悲观锁"><a href="#java的乐观锁和悲观锁" class="headerlink" title="java的乐观锁和悲观锁"></a>java的乐观锁和悲观锁</h3><p>  我们都知道,CPU是时分复用的,也就是把cpu的时间片,分配给不同的thread/process轮流执行,时间片与时间片之间,需要cpu切换,也就是会发生线程切换.切换涉及到清空寄存器,缓存数据.然后重新加载新的thread所需数据.当一个线程被挂起的时候,加入阻塞队列,在一定的事件或者条件下,在通过notifiy(),notifiyAll()唤醒回来.</p>
<p>  悲观锁<br>  是指对数据被外界修改持保守态度,因此,在整个数据处理过程中,讲数据处于锁定状态.<br>  在某个资源不可用的时候,就将CPU让出,把当前等待线程切换为阻塞状态.等到资源(比如一个共享数据)可用了,那么就将线程唤醒,让他进入runaable状态等待CPU调度.这就是典型的悲观锁的实现.独占锁是一种悲观锁,Syncnized就是一种独占锁,它假设最坏的情况,并且只有在确保其他线程不会赵成干扰的情况下执行,会导致其它所有需要锁的线程挂起,等待持有锁的线程释放所;</p>
<p>  但是由于在进程挂起和恢复执行过程中存在着很大的开销.当一个线程正在等待锁时,它不能做任何事,所以悲观锁有很大的缺点.举个例子,如果一个线程需要某个资源,但是这个资源占用的时间很短,当线程第一次抢占这个资源时,可能这个资源被占用,如果此时挂起这个线程,可能立刻就发现资源可用,然后又需要花费很长的时间重新抢占锁,时间代价就会非常的高.</p>
<p>  所以就有了乐观锁的概念.它的核心概念就是,每次不加锁而是假设没有冲突而去完成某项操作,如果因为冲突失败就重试,知道成功为止.在上面的例子中,某个线程可以不让出cpu,而是一直while循环,如果失败就重试,知道成功为止.所以,当数据争用不严重时,乐观锁效果更好.比如上面说的CAS就是一种乐观锁思想的应用.</p>
<h3 id="java加锁-synchronized和reentrantlock"><a href="#java加锁-synchronized和reentrantlock" class="headerlink" title="java加锁 synchronized和reentrantlock"></a>java加锁 synchronized和reentrantlock</h3><h4 id="synchronized"><a href="#synchronized" class="headerlink" title="synchronized"></a>synchronized</h4><p>  可以通过给方法或代码块增加 <em>synchronized</em> 关键字来加互斥锁.如果是加在当前的对象中的实例方法中那锁对象就是当前的对象也就是 <em>this</em> ,如果是加在静态方法中的,那当前锁对象就是 <em>class</em> 对象.如果是代码块中的话就是括号里面传入的对象.<br>  下面通过一个demo来说明 <em>synchronized</em> 的用法</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Sync</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</div><div class="line">            System.out.println(<span class="string">"test 开始"</span>);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                Thread.sleep(<span class="number">1000</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">            System.out.println(<span class="string">"test 结束"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  sync是一个普通的java类,内部的实例方法test增加了 <em>synchronized</em> 关键字来加锁,保证同一时间内只能有一个线程来调用test.<br>  然后是调用的线程MyThread<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> Sync sync;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">MyThread</span><span class="params">()</span> </span>&#123;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">MyThread</span><span class="params">(Sync sync)</span> </span>&#123;</div><div class="line">      <span class="keyword">this</span>.sync = sync;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.sync == <span class="keyword">null</span>) &#123;</div><div class="line">          sync = <span class="keyword">new</span> Sync();</div><div class="line">      &#125;</div><div class="line">      sync.test();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>  最后是测试类<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestSynchronized</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">     test();</div><div class="line">  &#125;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</div><div class="line">          <span class="keyword">new</span> MyThread().start();</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</div><div class="line">      Sync sync = <span class="keyword">new</span> Sync();</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</div><div class="line">          <span class="keyword">new</span> MyThread(sync).start();</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>  首先来看第一个test方法,通过创建3个MyThread来同时执行,那加的锁会成功吗?,看输出:</p>
<blockquote>
<p>test 开始<br>test 开始<br>test 开始<br>test 结束<br>test 结束<br>test 结束</p>
</blockquote>
<p>  很明显,锁没有起作用,3个线程同时执行的.</p>
<p>  在看调用第二个test方法,外部Sync对象创建后之后传入3个线程中,看输出:</p>
<blockquote>
<p>test 开始<br>test 结束<br>test 开始<br>test 结束<br>test 开始<br>test 结束</p>
</blockquote>
<p>  看来这种情况下是成功了.</p>
<p>  和上面的说明一致,方法锁锁定的是当前的实例对象,第一种情况下3个不同的实例对象,所以不行<br>  而第二个test是用的同一个实例对象,所以加锁成功.<br>  如果把Sync的test方法内部创建一个 Sync类锁的话,那两个test方法都会加锁成功<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Sync</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">synchronized</span> (Sync.class) &#123;</div><div class="line">          System.out.println(<span class="string">"test 开始"</span>);</div><div class="line">          <span class="keyword">try</span> &#123;</div><div class="line">              Thread.sleep(<span class="number">1000</span>);</div><div class="line">          &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">              e.printStackTrace();</div><div class="line">          &#125;</div><div class="line">          System.out.println(<span class="string">"test 结束"</span>);</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="reentrantLock详解"><a href="#reentrantLock详解" class="headerlink" title="reentrantLock详解"></a>reentrantLock详解</h4><p>首先 <em>reentrantLock</em> 是一种乐观锁,它比 <em>synchronized</em> 更加灵活,内部增加了很多机制,比如支持请求所超时,公平锁等功能.<br><em>reentrantLock</em> 的翻译是 “可重入的的锁”,可以对同一个线程申请多次锁,内部有一个计数器,每次调用 <em>lock</em> 方法的时候加一, <em>unlock</em> 的时候减一,知道计数器为0,最终释放锁.<br>普通的用法如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">X</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock();</div><div class="line">  <span class="comment">//...</span></div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">m</span><span class="params">()</span></span>&#123;</div><div class="line">    lock.lock(); <span class="comment">// block until condition holds</span></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="comment">//... method body</span></div><div class="line">    &#125;<span class="keyword">final</span>&#123;</div><div class="line">      lock.unlock();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>关于 <em>ReentrantLock</em> 的高级用法我们后面再讲,现在先看其内部实现,尝试讲解一下源码:<br><em>ReeentrantLock</em> 内部主要是通过一个Sync的抽象类来完成大部分的操作,这个Sync对象继承至 <em>AbstractQueuedSynchronizer</em> ,其中 <em>AbstractQueuedSynchronizer</em> 中实现了大部分的锁机制,只是抽象出了 <em>tryAcquire</em> 和 <em>tryReleas</em> 方法,交由子类实现.<br>而在 <em>ReeentrantLock</em> 中的 Sync对象有有两个实现类,分别是 <em>NonfairSync</em> 和 <em>FairSync</em> ,从命名上可以看出分别是不公平锁和公平锁的概念.<br>为啥会有公平不公共这种说法呢,还得从多线程的角度考虑:由于有锁的出现,导致同一时间只能有个线程可以执行,那其他的线程处在阻塞状态,如果锁释放了,那那些阻塞的线程将被唤醒,说明肯定是有个队列用来维护阻塞线程的.公平锁和非公平锁的区别就在于唤醒的时候是否需要按照队列的顺序来唤醒.公平锁的话是按照阻塞队列的顺序来获取锁,非公平锁的唤醒是先直接尝试取得锁,如果失败才会进入阻塞队列中按顺序获取锁.</p>
<p><em>ReentrantLock</em> 默认构造方法实现的是非公平锁.也就是 <em>NonfairSync</em> .</p>
<p>首先是从 <em>lock</em> 方法开始<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</div><div class="line">       sync.lock();</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>lock方法调用的Sync对象的lock方法,这里默认初始化的是 <em>NonfairSync</em>,进入其内部来看:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">NonfairSync</span> <span class="keyword">extends</span> <span class="title">Sync</span> </span>&#123;</div><div class="line">      <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">7316153563782823691L</span>;</div><div class="line"></div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Performs lock.  Try immediate barge, backing up to normal</div><div class="line">       * acquire on failure.</div><div class="line">       */</div><div class="line">      <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</div><div class="line">          <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))</div><div class="line">              setExclusiveOwnerThread(Thread.currentThread());</div><div class="line">          <span class="keyword">else</span></div><div class="line">              acquire(<span class="number">1</span>);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</div><div class="line">          <span class="keyword">return</span> nonfairTryAcquire(acquires);</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>这里lock的时候直接通过CAS来获得锁,如果成功就把当前线程设为独占线程,失败的话进入 <em>acquire</em> 方法.这个方法是在 <em>AbstractQueuedSynchronizer</em> 实现的通用方法.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp;</div><div class="line">           acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</div><div class="line">           selfInterrupt();</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>先看见if判断的第一个条件 <em>tryAcquire</em> ,就是上边的 <em>NonfairSync</em> 中的实现,最终进入了 <em>nonfairTryAcquire</em> 方法中.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">nonfairTryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</div><div class="line">           <span class="keyword">final</span> Thread current = Thread.currentThread();</div><div class="line">           <span class="keyword">int</span> c = getState();</div><div class="line">           <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</div><div class="line">               <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, acquires)) &#123;</div><div class="line">                   setExclusiveOwnerThread(current);</div><div class="line">                   <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</div><div class="line">               <span class="keyword">int</span> nextc = c + acquires;</div><div class="line">               <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>) <span class="comment">// overflow</span></div><div class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Maximum lock count exceeded"</span>);</div><div class="line">               setState(nextc);</div><div class="line">               <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">       &#125;</div></pre></td></tr></table></figure></p>
<p>这里的state就是前面说的计数器,通过state来说明当前锁的状态.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">    * The synchronization state.</div><div class="line">    */</div><div class="line">   <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> state;</div></pre></td></tr></table></figure></p>
<p>这里如果state为0,说明还没有线程获得了锁,那正好,我是第一个,立马通过CAS来把自己设为当前独占线程,同时state变为传入的 <em>acquires</em> ,第一次的时候为1,后续每次调用都会加一.<br>如果当前state不为0,但是独占线程是自己的话,把state加一,可重入体现在这里了.这里很明显最大可重入的值是最大的int值.<br>最后,如果都不符合返回false,进入上面 <em>acquire</em> 方法if判断的第二个条件 <em>acquireQueued(addWaiter(Node.EXCLUSIVE), arg)</em>.先看其中的 <em>addWaiter</em> 方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Creates and enqueues node for current thread and given mode.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> mode Node.EXCLUSIVE for exclusive, Node.SHARED for shared</div><div class="line">     * <span class="doctag">@return</span> the new node</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> Node <span class="title">addWaiter</span><span class="params">(Node mode)</span> </span>&#123;</div><div class="line">        Node node = <span class="keyword">new</span> Node(Thread.currentThread(), mode);</div><div class="line">        <span class="comment">// Try the fast path of enq; backup to full enq on failure</span></div><div class="line">        Node pred = tail;</div><div class="line">        <span class="keyword">if</span> (pred != <span class="keyword">null</span>) &#123;</div><div class="line">            node.prev = pred;</div><div class="line">            <span class="keyword">if</span> (compareAndSetTail(pred, node)) &#123;</div><div class="line">                pred.next = node;</div><div class="line">                <span class="keyword">return</span> node;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        enq(node);</div><div class="line">        <span class="keyword">return</span> node;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>如果锁已经被抢占了,后续线程将进入这里维护的 <em>双向队列</em> 中, <em>addWaiter</em> 方法就是把节点对象放入队列中的实现.<br>如果队列不为空的话,直接通过CAS把结尾节点更新为当前请求的节点对象,否者会进入一个队列初始化方法 <em>enq</em> 方法中.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">    * Inserts node into queue, initializing if necessary. See picture above.</div><div class="line">    * <span class="doctag">@param</span> node the node to insert</div><div class="line">    * <span class="doctag">@return</span> node's predecessor</div><div class="line">    */</div><div class="line">   <span class="function"><span class="keyword">private</span> Node <span class="title">enq</span><span class="params">(<span class="keyword">final</span> Node node)</span> </span>&#123;</div><div class="line">       <span class="keyword">for</span> (;;) &#123;</div><div class="line">           Node t = tail;</div><div class="line">           <span class="keyword">if</span> (t == <span class="keyword">null</span>) &#123; <span class="comment">// Must initialize</span></div><div class="line">               <span class="keyword">if</span> (compareAndSetHead(<span class="keyword">new</span> Node()))</div><div class="line">                   tail = head;</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               node.prev = t;</div><div class="line">               <span class="keyword">if</span> (compareAndSetTail(t, node)) &#123;</div><div class="line">                   t.next = node;</div><div class="line">                   <span class="keyword">return</span> t;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>如果尾部指针为空,说明队列没有初始化,把head和tail节点更新为一个创建的新的node对象<br>如果队列不为空,更新尾部节点,把当前请求的节点设为尾部节点.</p>
<p>回到 <em>acquireQueued(final Node node, int arg)</em> 方法中.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="keyword">int</span> arg)</span> </span>&#123;</div><div class="line">       <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="keyword">boolean</span> interrupted = <span class="keyword">false</span>;</div><div class="line">           <span class="keyword">for</span> (;;) &#123;</div><div class="line">               <span class="keyword">final</span> Node p = node.predecessor();</div><div class="line">               <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</div><div class="line">                   setHead(node);</div><div class="line">                   p.next = <span class="keyword">null</span>; <span class="comment">// help GC</span></div><div class="line">                   failed = <span class="keyword">false</span>;</div><div class="line">                   <span class="keyword">return</span> interrupted;</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</div><div class="line">                   parkAndCheckInterrupt())</div><div class="line">                   interrupted = <span class="keyword">true</span>;</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">finally</span> &#123;</div><div class="line">           <span class="keyword">if</span> (failed)</div><div class="line">               cancelAcquire(node);</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>首先是判断当前节点是不是头结点的后一个,同时再次申请锁,如果两个条件都满足就更新队列,把头结点置为当前的请求节点,然后返回false<br>如果不满足if条件就进入第二个判断,先看其第一个条件 <em>shouldParkAfterFailedAcquire(p, node)</em> :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">shouldParkAfterFailedAcquire</span><span class="params">(Node pred, Node node)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> ws = pred.waitStatus;</div><div class="line">        <span class="keyword">if</span> (ws == Node.SIGNAL)</div><div class="line">            <span class="comment">/*</span></div><div class="line">             * This node has already set status asking a release</div><div class="line">             * to signal it, so it can safely park.</div><div class="line">             */</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">if</span> (ws &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">/*</span></div><div class="line">             * Predecessor was cancelled. Skip over predecessors and</div><div class="line">             * indicate retry.</div><div class="line">             */</div><div class="line">            <span class="keyword">do</span> &#123;</div><div class="line">                node.prev = pred = pred.prev;</div><div class="line">            &#125; <span class="keyword">while</span> (pred.waitStatus &gt; <span class="number">0</span>);</div><div class="line">            pred.next = node;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">/*</span></div><div class="line">             * waitStatus must be 0 or PROPAGATE.  Indicate that we</div><div class="line">             * need a signal, but don't park yet.  Caller will need to</div><div class="line">             * retry to make sure it cannot acquire before parking.</div><div class="line">             */</div><div class="line">            compareAndSetWaitStatus(pred, ws, Node.SIGNAL);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>默认node对象的waitStatus是0,进入最后面的else分支,返回false,由于外面的调用方法 <em>acquireQueued</em> 里面是个死循环,所以马上又会回到这里,然后更新waitStatus的值为 Node.SIGNAL, 返回true.<br>在看第二个判断条件 <em>parkAndCheckInterrupt()</em> :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">   * Convenience method to park and then check if interrupted</div><div class="line">   *</div><div class="line">   * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if interrupted</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">parkAndCheckInterrupt</span><span class="params">()</span> </span>&#123;</div><div class="line">      LockSupport.park(<span class="keyword">this</span>);</div><div class="line">      <span class="keyword">return</span> Thread.interrupted();</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>这里,就进入了阻塞线程的核心代码了,通过 <em>LockSupport.park(this);</em> 来阻塞当前的线程.至于 <em>LockSupport</em> 的用法,以后有时间再解释,只要明白这个就是阻塞现场的实现就ok了.<br>非公平锁的lock实现就到这里,再来简单看下公平锁的lock的实现,其实只是 <em>tryAcquire</em> 方法的实现不一样.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">        * Fair version of tryAcquire.  Don't grant access unless</div><div class="line">        * recursive call or no waiters or is first.</div><div class="line">        */</div><div class="line">       <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</div><div class="line">           <span class="keyword">final</span> Thread current = Thread.currentThread();</div><div class="line">           <span class="keyword">int</span> c = getState();</div><div class="line">           <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</div><div class="line">               <span class="keyword">if</span> (!hasQueuedPredecessors() &amp;&amp;</div><div class="line">                   compareAndSetState(<span class="number">0</span>, acquires)) &#123;</div><div class="line">                   setExclusiveOwnerThread(current);</div><div class="line">                   <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</div><div class="line">               <span class="keyword">int</span> nextc = c + acquires;</div><div class="line">               <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>)</div><div class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Maximum lock count exceeded"</span>);</div><div class="line">               setState(nextc);</div><div class="line">               <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">       &#125;</div></pre></td></tr></table></figure>
<p>这里公平锁首先还是根据state来获取锁,只不过增加了一个条件 <em>hasQueuedPredecessors()</em>  ,也就是说判断队列前面还有没有正在等待的节点了<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">hasQueuedPredecessors</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="comment">// The correctness of this depends on head being initialized</span></div><div class="line">       <span class="comment">// before tail and on head.next being accurate if the current</span></div><div class="line">       <span class="comment">// thread is first in queue.</span></div><div class="line">       Node t = tail; <span class="comment">// Read fields in reverse initialization order</span></div><div class="line">       Node h = head;</div><div class="line">       Node s;</div><div class="line">       <span class="keyword">return</span> h != t &amp;&amp;</div><div class="line">           ((s = h.next) == <span class="keyword">null</span> || s.thread != Thread.currentThread());</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>这里就是上面提到的公平锁和非公平锁的请求实现方式的区别所在了.</p>
<p>lock流程就到了这里结束了,其实不算复杂.下面是unlock方法的实现:<br>unlock在公平锁和非公平锁中的实现是一样的<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">    * Releases in exclusive mode.  Implemented by unblocking one or</div><div class="line">    * more threads if &#123;<span class="doctag">@link</span> #tryRelease&#125; returns true.</div><div class="line">    * This method can be used to implement method &#123;<span class="doctag">@link</span> Lock#unlock&#125;.</div><div class="line">    *</div><div class="line">    * <span class="doctag">@param</span> arg the release argument.  This value is conveyed to</div><div class="line">    *        &#123;<span class="doctag">@link</span> #tryRelease&#125; but is otherwise uninterpreted and</div><div class="line">    *        can represent anything you like.</div><div class="line">    * <span class="doctag">@return</span> the value returned from &#123;<span class="doctag">@link</span> #tryRelease&#125;</div><div class="line">    */</div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">release</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (tryRelease(arg)) &#123;</div><div class="line">           Node h = head;</div><div class="line">           <span class="keyword">if</span> (h != <span class="keyword">null</span> &amp;&amp; h.waitStatus != <span class="number">0</span>)</div><div class="line">               unparkSuccessor(h);</div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>先来看 <em>tryRelease</em> 方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryRelease</span><span class="params">(<span class="keyword">int</span> releases)</span> </span>&#123;</div><div class="line">          <span class="keyword">int</span> c = getState() - releases;</div><div class="line">          <span class="keyword">if</span> (Thread.currentThread() != getExclusiveOwnerThread())</div><div class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</div><div class="line">          <span class="keyword">boolean</span> free = <span class="keyword">false</span>;</div><div class="line">          <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</div><div class="line">              free = <span class="keyword">true</span>;</div><div class="line">              setExclusiveOwnerThread(<span class="keyword">null</span>);</div><div class="line">          &#125;</div><div class="line">          setState(c);</div><div class="line">          <span class="keyword">return</span> free;</div><div class="line">      &#125;</div></pre></td></tr></table></figure></p>
<p>只有当前是独占线程,并且计数器state为0的时候,释放锁,把独占线程对象置为空,同时state清零.free返回true<br>上面进入if判断后,调用 <em>unparkSuccessor</em> 方法.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Wakes up node's successor, if one exists.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> node the node</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unparkSuccessor</span><span class="params">(Node node)</span> </span>&#123;</div><div class="line">    <span class="comment">/*</span></div><div class="line">     * If status is negative (i.e., possibly needing signal) try</div><div class="line">     * to clear in anticipation of signalling.  It is OK if this</div><div class="line">     * fails or if status is changed by waiting thread.</div><div class="line">     */</div><div class="line">    <span class="keyword">int</span> ws = node.waitStatus;</div><div class="line">    <span class="keyword">if</span> (ws &lt; <span class="number">0</span>)</div><div class="line">        compareAndSetWaitStatus(node, ws, <span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * Thread to unpark is held in successor, which is normally</div><div class="line">     * just the next node.  But if cancelled or apparently null,</div><div class="line">     * traverse backwards from tail to find the actual</div><div class="line">     * non-cancelled successor.</div><div class="line">     */</div><div class="line">    Node s = node.next;</div><div class="line">    <span class="keyword">if</span> (s == <span class="keyword">null</span> || s.waitStatus &gt; <span class="number">0</span>) &#123;</div><div class="line">        s = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">for</span> (Node t = tail; t != <span class="keyword">null</span> &amp;&amp; t != node; t = t.prev)</div><div class="line">            <span class="keyword">if</span> (t.waitStatus &lt;= <span class="number">0</span>)</div><div class="line">                s = t;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (s != <span class="keyword">null</span>)</div><div class="line">        LockSupport.unpark(s.thread);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里设置当前节点的waitStatus为0,同时获取node的下一个节点,并且唤醒该节点的线程.那么问题来了,唤醒后面节点的线程之后,如何保证队列的顺序呢,同时把已经执行完的的node移除呢.还记得上面 <em>acquireQueued</em> 的方法吗,内部有个死循环<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="keyword">int</span> arg)</span> </span>&#123;</div><div class="line">       <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="keyword">boolean</span> interrupted = <span class="keyword">false</span>;</div><div class="line">           <span class="keyword">for</span> (;;) &#123;</div><div class="line">               <span class="keyword">final</span> Node p = node.predecessor();</div><div class="line">               <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</div><div class="line">                   setHead(node);</div><div class="line">                   p.next = <span class="keyword">null</span>; <span class="comment">// help GC</span></div><div class="line">                   failed = <span class="keyword">false</span>;</div><div class="line">                   <span class="keyword">return</span> interrupted;</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</div><div class="line">                   parkAndCheckInterrupt())</div><div class="line">                   interrupted = <span class="keyword">true</span>;</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">finally</span> &#123;</div><div class="line">           <span class="keyword">if</span> (failed)</div><div class="line">               cancelAcquire(node);</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>这里p节点确实是head,进入里面第一个if判断,这个时候会把头结点更新,然后旧的头结点由于没有关联了会在后面被gc回收掉,这样就达到了动态维护阻塞队列的目的.</p>
<h4 id="ReentrantLock的用法"><a href="#ReentrantLock的用法" class="headerlink" title="ReentrantLock的用法"></a>ReentrantLock的用法</h4><p>除了普通的加锁方式之外, ReentrantLock还提供了 tryLock(),tryLock(int mill,TimeUtil util),lockInterruptibly()方法等,下面分别解释一下:<br><em>tryLock()</em> 判断能否获取获取到锁,如果当前锁是空置状态,直接返回true,否者返回false<br><em>tryLock(int mill,TimeUtil unit)</em> 类似上面的tryLock,只不过加入了时间控制,也就说说在指定的时间内能否获得到锁.<br><em>lockInterruptibly</em> 支持中断的获取锁,如果在获取锁的过程中线程被中断,会直接返回已给中断异常.它与普通lock方法的区别在于,如果是 <em>lock</em> 方法,会忽略中断请求,继续获取锁直到的成功,而 <em>lockInterruptibly</em> 方法会直接响应中断操作,返回一个中断异常交由上层处理.如果要求中断操作线程不能参与锁的竞争可以使用 <em>lockInterruptibly</em> ,否则使用 <em>lock</em> 方法.</p>
<p>除了上面说的这几个方法,平时常用的还有Condition方式,也就是更加灵活的唤醒阻塞方式,对应Object的wait,notify,notifiyAll等方法.<br>Condition 提供了 await,signal,signalAll等三个方法.可以用来灵活调整唤醒的次序,下面通过一个面试题来说明Condition的用法.</p>
<blockquote>
<p>如何让两个线程交替答应A和B十次,输出结果为ABABABABABABABABABAB</p>
</blockquote>
<p>思路:我们可以让保持一个index,每次答应之后加一,如果是偶数,唤醒A线程先答应A字符,然后在A中唤醒B线程,如果是奇数唤醒B线程答应A,然后在B中唤醒A线程.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestReentrantLockCondition3</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> Lock lock = <span class="keyword">new</span> ReentrantLock();</div><div class="line">    <span class="keyword">static</span> Condition condition = lock.newCondition();</div><div class="line"></div><div class="line">    <span class="keyword">int</span> index;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printFirst</span><span class="params">()</span> </span>&#123;</div><div class="line">        lock.lock();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">while</span> (index % <span class="number">2</span> != <span class="number">0</span>) &#123;</div><div class="line">                condition.await();</div><div class="line">            &#125;</div><div class="line">            System.out.print(<span class="string">"A"</span>);</div><div class="line">            index++;</div><div class="line">            condition.signal();</div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            lock.unlock();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printLast</span><span class="params">()</span> </span>&#123;</div><div class="line">        lock.lock();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">while</span> (index % <span class="number">2</span> != <span class="number">1</span>) &#123;</div><div class="line">                condition.await();</div><div class="line">            &#125;</div><div class="line">            System.out.print(<span class="string">"B"</span>);</div><div class="line">            index++;</div><div class="line">            condition.signal();</div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            lock.unlock();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> TestReentrantLockCondition3 condition3;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MyThread</span><span class="params">(TestReentrantLockCondition3 condition3)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.condition3 = condition3;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            condition3.printFirst();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyThread2</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> TestReentrantLockCondition3 condition3;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MyThread2</span><span class="params">(TestReentrantLockCondition3 condition3)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.condition3 = condition3;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            condition3.printLast();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        TestReentrantLockCondition3 condition3 = <span class="keyword">new</span> TestReentrantLockCondition3();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</div><div class="line">            <span class="keyword">new</span> MyThread(condition3).start();</div><div class="line">            <span class="keyword">new</span> MyThread2(condition3).start();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>核心就在上面的 <em>printFirst</em> 和 <em>printLast</em> 两个方法,在index为偶数的情况下A唤醒B阻塞,反之,然后通过不断的更新index来达到交替打印的逻辑.</p>
<h4 id="java-线程join方法"><a href="#java-线程join方法" class="headerlink" title="java 线程join方法"></a>java 线程join方法</h4><p>join方法的含义是等待对应的时长直到调用的线程执行完成.<br>也就是说,在调用的线程没有完成的时候,当前线程处于阻塞状态,不会继续往下执行,直到调用的join方法的线程完成或者超时.</p>
<p>来看源码:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public final void join() throws InterruptedException &#123;</div><div class="line">       join(0);</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">join</span><span class="params">(<span class="keyword">long</span> millis)</span></span></div><div class="line">   <span class="keyword">throws</span> InterruptedException &#123;</div><div class="line">       <span class="keyword">long</span> base = System.currentTimeMillis();</div><div class="line">       <span class="keyword">long</span> now = <span class="number">0</span>;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (millis &lt; <span class="number">0</span>) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"timeout value is negative"</span>);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (millis == <span class="number">0</span>) &#123;</div><div class="line">           <span class="keyword">while</span> (isAlive()) &#123;</div><div class="line">               wait(<span class="number">0</span>);</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="keyword">while</span> (isAlive()) &#123;</div><div class="line">               <span class="keyword">long</span> delay = millis - now;</div><div class="line">               <span class="keyword">if</span> (delay &lt;= <span class="number">0</span>) &#123;</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">               &#125;</div><div class="line">               wait(delay);</div><div class="line">               now = System.currentTimeMillis() - base;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>如果当前线程不是Alive的话,join方法无效,如果是alive的话等待.<br>下面通过一个demo来说明用法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestJoin</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TestThread</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            System.out.println(<span class="string">"I am TestThread !!!!"</span>);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                Thread.sleep(<span class="number">2000</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">            System.out.println(<span class="string">"TestThread done"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TestThread2</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            System.out.println(<span class="string">"I am TestThread2 !!!!"</span>);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                Thread.sleep(<span class="number">2000</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">            System.out.println(<span class="string">"TestThread2 done"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        Thread thread1 = <span class="keyword">new</span> TestThread();</div><div class="line">        Thread thread2 = <span class="keyword">new</span> TestThread2();</div><div class="line">        thread1.start();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            thread1.join();</div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        thread2.start();</div><div class="line"></div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>输出:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">I am TestThread !!!!</div><div class="line">TestThread done</div><div class="line">I am TestThread2 !!!!</div><div class="line">TestThread2 done</div></pre></td></tr></table></figure></p>
<h4 id="ReentrantReadWriteLock用法和原理"><a href="#ReentrantReadWriteLock用法和原理" class="headerlink" title="ReentrantReadWriteLock用法和原理"></a>ReentrantReadWriteLock用法和原理</h4><p>首先 <em>ReentrantReadWriteLock</em> 和 <em>ReentrantLock</em> 的唯一关联就是都是 <em>AbstractQueuedSynchronizer</em> 的实现,其他就没有任何联系了,不要认为二者是继承关系.<br><em>ReentrantReadWriteLock</em> 主要是内部分别包含该一个读锁和写锁,主要是用的大量读少量写的时候保证性能时使用,毕竟如果直接 <em>ReentrantLock</em> 的话就是读写都加锁,性能上会有写影响.在 <em>ReentrantReadWriteLock</em> 中写锁基本类似于 <em>ReentrantLock</em> 是一种独占锁,也就是说同一时间只能有一个线程来写.而 <em>ReentrantReadWriteLock</em> 中的读锁是一种共享锁,可以有多个线程来同时读取数据.<br>读写锁的目的说白了就是为了保证数据一致性,在大量读取少量修改的时候,为了节约性能,就通过加读写锁的方式来解决独占锁的长时间的占用问题.从而达到数据一致的目的.</p>
<p>读与写的机制:<br>“读-读” 不互斥<br>“读-写” 互斥<br>“写-写” 互斥</p>
<p>即在任何时候必须保证:<br>只有一个线程在写入<br>线程正在读取的时候,写入操作等待<br>线程正在写入的时候,其他线程的写入操作和读取操作都要等待;</p>
<p>锁降级:写线程可以在写入锁后可以获取读取锁,然后释放写入锁,这样就从写入锁变成了读取锁,从而实现了锁降级的特性</p>
<p>下面是读写锁的一个使用场景实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReadWriteLock lock = <span class="keyword">new</span> ReentrantReadWriteLock();<span class="comment">//读写锁  </span></div><div class="line"><span class="comment">// 读取缓存：  </span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">read</span><span class="params">(String key)</span> </span>&#123;  </div><div class="line">        lock.readLock().lock();  </div><div class="line">        Object obj = <span class="keyword">null</span>;  </div><div class="line">        <span class="keyword">try</span> &#123;  </div><div class="line">            obj = cache.get(key);  </div><div class="line">            <span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;  </div><div class="line">                lock.readLock().unlock();  </div><div class="line">                <span class="comment">// 在这里的时候，其他的线程有可能获取到锁  </span></div><div class="line">                lock.writeLock().lock();  </div><div class="line">                <span class="keyword">try</span> &#123;  </div><div class="line">                    <span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;  </div><div class="line">                        obj = <span class="string">"查找数据库"</span>; <span class="comment">// 实际动作是查找数据库  </span></div><div class="line">                        <span class="comment">// 把数据更新到缓存中：  </span></div><div class="line">                        cache.put(key, obj);  </div><div class="line">                    &#125;  </div><div class="line">                &#125; <span class="keyword">finally</span> &#123;  </div><div class="line">                    <span class="comment">// 当前线程在获取到写锁的过程中，可以获取到读锁，这叫锁的重入，然后导致了写锁的降级，称为降级锁。  </span></div><div class="line">                    <span class="comment">// 利用重入可以将写锁降级，但只能在当前线程保持的所有写入锁都已经释放后，才允许重入 reader使用  </span></div><div class="line">                    <span class="comment">// 它们。所以在重入的过程中，其他的线程不会有获取到锁的机会（这样做的好处）。试想，先释放写锁，在  </span></div><div class="line">                    <span class="comment">// 上读锁，这样做有什么弊端？--如果这样做，那么在释放写锁后，在得到读锁前，有可能被其他线程打断。  </span></div><div class="line">                    <span class="comment">// 重入————&gt;降级锁的步骤：先获取写入锁，然后获取读取锁，最后释放写入锁（重点）  </span></div><div class="line">                    lock.readLock().lock();   </div><div class="line">                    lock.writeLock().unlock();  </div><div class="line">                &#125;  </div><div class="line">            &#125;  </div><div class="line">        &#125; <span class="keyword">finally</span> &#123;  </div><div class="line">            lock.readLock().unlock();  </div><div class="line">        &#125;  </div><div class="line">        <span class="keyword">return</span> obj;  </div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>读写锁的写锁和上面的降到的ReentrantLock的实现类似这里就不展开了,重点讲下读锁也就是共享锁的实现,共享锁其实严格来说不能算作锁,其内部只是维护了一个计算器.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</div><div class="line">           sync.acquireShared(<span class="number">1</span>);</div><div class="line">       &#125;</div></pre></td></tr></table></figure></p>
<p>这里的 <em>acquireShared</em> 属于AQS中的实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquireShared</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (tryAcquireShared(arg) &lt; <span class="number">0</span>)</div><div class="line">           doAcquireShared(arg);</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">tryAcquireShared</span><span class="params">(<span class="keyword">int</span> unused)</span> </span>&#123;</div><div class="line">          <span class="comment">/*</span></div><div class="line">           * Walkthrough:</div><div class="line">           * 1. If write lock held by another thread, fail.</div><div class="line">           * 2. Otherwise, this thread is eligible for</div><div class="line">           *    lock wrt state, so ask if it should block</div><div class="line">           *    because of queue policy. If not, try</div><div class="line">           *    to grant by CASing state and updating count.</div><div class="line">           *    Note that step does not check for reentrant</div><div class="line">           *    acquires, which is postponed to full version</div><div class="line">           *    to avoid having to check hold count in</div><div class="line">           *    the more typical non-reentrant case.</div><div class="line">           * 3. If step 2 fails either because thread</div><div class="line">           *    apparently not eligible or CAS fails or count</div><div class="line">           *    saturated, chain to version with full retry loop.</div><div class="line">           */</div><div class="line">          Thread current = Thread.currentThread();</div><div class="line">          <span class="keyword">int</span> c = getState();</div><div class="line">          <span class="keyword">if</span> (exclusiveCount(c) != <span class="number">0</span> &amp;&amp;</div><div class="line">              getExclusiveOwnerThread() != current)</div><div class="line">              <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">          <span class="keyword">int</span> r = sharedCount(c);</div><div class="line">          <span class="keyword">if</span> (!readerShouldBlock() &amp;&amp;</div><div class="line">              r &lt; MAX_COUNT &amp;&amp;</div><div class="line">              compareAndSetState(c, c + SHARED_UNIT)) &#123;</div><div class="line">              <span class="keyword">if</span> (r == <span class="number">0</span>) &#123;</div><div class="line">                  firstReader = current;</div><div class="line">                  firstReaderHoldCount = <span class="number">1</span>;</div><div class="line">              &#125; <span class="keyword">else</span> <span class="keyword">if</span> (firstReader == current) &#123;</div><div class="line">                  firstReaderHoldCount++;</div><div class="line">              &#125; <span class="keyword">else</span> &#123;</div><div class="line">                  HoldCounter rh = cachedHoldCounter;</div><div class="line">                  <span class="keyword">if</span> (rh == <span class="keyword">null</span> || rh.tid != getThreadId(current))</div><div class="line">                      cachedHoldCounter = rh = readHolds.get();</div><div class="line">                  <span class="keyword">else</span> <span class="keyword">if</span> (rh.count == <span class="number">0</span>)</div><div class="line">                      readHolds.set(rh);</div><div class="line">                  rh.count++;</div><div class="line">              &#125;</div><div class="line">              <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">return</span> fullTryAcquireShared(current);</div><div class="line">      &#125;</div></pre></td></tr></table></figure>
<p>可以看到首先是判断当前有没有写锁占用着并且占用的线程不是当前线程,直接返回失败<br><em>readerShouldBlock</em> 是一个抽象方法,在公平锁和非公平锁中实现方式不一样<br>这是公平锁的<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">readerShouldBlock</span><span class="params">()</span> </span>&#123;</div><div class="line">           <span class="keyword">return</span> hasQueuedPredecessors();</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">hasQueuedPredecessors</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="comment">// The correctness of this depends on head being initialized</span></div><div class="line">       <span class="comment">// before tail and on head.next being accurate if the current</span></div><div class="line">       <span class="comment">// thread is first in queue.</span></div><div class="line">       Node t = tail; <span class="comment">// Read fields in reverse initialization order</span></div><div class="line">       Node h = head;</div><div class="line">       Node s;</div><div class="line">       <span class="keyword">return</span> h != t &amp;&amp;</div><div class="line">           ((s = h.next) == <span class="keyword">null</span> || s.thread != Thread.currentThread());</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>这是非公平锁的<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">readerShouldBlock</span><span class="params">()</span> </span>&#123;</div><div class="line">           <span class="comment">/* As a heuristic to avoid indefinite writer starvation,</span></div><div class="line">            * block if the thread that momentarily appears to be head</div><div class="line">            * of queue, if one exists, is a waiting writer.  This is</div><div class="line">            * only a probabilistic effect since a new reader will not</div><div class="line">            * block if there is a waiting writer behind other enabled</div><div class="line">            * readers that have not yet drained from the queue.</div><div class="line">            */</div><div class="line"><span class="keyword">return</span> apparentlyFirstQueuedIsExclusive();</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">apparentlyFirstQueuedIsExclusive</span><span class="params">()</span> </span>&#123;</div><div class="line">     Node h, s;</div><div class="line">     <span class="keyword">return</span> (h = head) != <span class="keyword">null</span> &amp;&amp;</div><div class="line">         (s = h.next)  != <span class="keyword">null</span> &amp;&amp;</div><div class="line">         !s.isShared()         &amp;&amp;</div><div class="line">         s.thread != <span class="keyword">null</span>;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p> ,第二个条件是r得小于最大的读锁限制,最大的读锁的限制是65535.因为读写锁是把state的高16位存放读锁数量,后16位存放写锁数量.然后通过CAS来更新计数器.<br>HoldCounter是这样一个对象,内部包含该了线程ID和线程中的读锁计数,然后通过ThreadLocal <em>readHolds</em> 来对应不同的线程.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">HoldCounter</span> </span>&#123;</div><div class="line">          <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">          <span class="comment">// Use id, not reference, to avoid garbage retention</span></div><div class="line">          <span class="keyword">final</span> <span class="keyword">long</span> tid = getThreadId(Thread.currentThread());</div><div class="line">      &#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalHoldCounter</span></span></div><div class="line">         <span class="keyword">extends</span> <span class="title">ThreadLocal</span>&lt;<span class="title">HoldCounter</span>&gt; &#123;</div><div class="line">         <span class="function"><span class="keyword">public</span> HoldCounter <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</div><div class="line">             <span class="keyword">return</span> <span class="keyword">new</span> HoldCounter();</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line">       <span class="keyword">private</span> <span class="keyword">transient</span> ThreadLocalHoldCounter readHolds;</div></pre></td></tr></table></figure>
<p>如果上面的判断条件成功放回1,否者进入下面的 <em>fullTryAcquireShared</em> ;<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">fullTryAcquireShared</span><span class="params">(Thread current)</span> </span>&#123;</div><div class="line">          <span class="comment">/*</span></div><div class="line">           * This code is in part redundant with that in</div><div class="line">           * tryAcquireShared but is simpler overall by not</div><div class="line">           * complicating tryAcquireShared with interactions between</div><div class="line">           * retries and lazily reading hold counts.</div><div class="line">           */</div><div class="line">          HoldCounter rh = <span class="keyword">null</span>;</div><div class="line">          <span class="keyword">for</span> (;;) &#123;</div><div class="line">              <span class="keyword">int</span> c = getState();</div><div class="line">              <span class="keyword">if</span> (exclusiveCount(c) != <span class="number">0</span>) &#123;</div><div class="line">                  <span class="keyword">if</span> (getExclusiveOwnerThread() != current)</div><div class="line">                      <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">                  <span class="comment">// else we hold the exclusive lock; blocking here</span></div><div class="line">                  <span class="comment">// would cause deadlock.</span></div><div class="line">              &#125; <span class="keyword">else</span> <span class="keyword">if</span> (readerShouldBlock()) &#123;</div><div class="line">                  <span class="comment">// Make sure we're not acquiring read lock reentrantly</span></div><div class="line">                  <span class="keyword">if</span> (firstReader == current) &#123;</div><div class="line">                      <span class="comment">// assert firstReaderHoldCount &gt; 0;</span></div><div class="line">                  &#125; <span class="keyword">else</span> &#123;</div><div class="line">                      <span class="keyword">if</span> (rh == <span class="keyword">null</span>) &#123;</div><div class="line">                          rh = cachedHoldCounter;</div><div class="line">                          <span class="keyword">if</span> (rh == <span class="keyword">null</span> || rh.tid != getThreadId(current)) &#123;</div><div class="line">                              rh = readHolds.get();</div><div class="line">                              <span class="keyword">if</span> (rh.count == <span class="number">0</span>)</div><div class="line">                                  readHolds.remove();</div><div class="line">                          &#125;</div><div class="line">                      &#125;</div><div class="line">                      <span class="keyword">if</span> (rh.count == <span class="number">0</span>)</div><div class="line">                          <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">                  &#125;</div><div class="line">              &#125;</div><div class="line">              <span class="keyword">if</span> (sharedCount(c) == MAX_COUNT)</div><div class="line">                  <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Maximum lock count exceeded"</span>);</div><div class="line">              <span class="keyword">if</span> (compareAndSetState(c, c + SHARED_UNIT)) &#123;</div><div class="line">                  <span class="keyword">if</span> (sharedCount(c) == <span class="number">0</span>) &#123;</div><div class="line">                      firstReader = current;</div><div class="line">                      firstReaderHoldCount = <span class="number">1</span>;</div><div class="line">                  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (firstReader == current) &#123;</div><div class="line">                      firstReaderHoldCount++;</div><div class="line">                  &#125; <span class="keyword">else</span> &#123;</div><div class="line">                      <span class="keyword">if</span> (rh == <span class="keyword">null</span>)</div><div class="line">                          rh = cachedHoldCounter;</div><div class="line">                      <span class="keyword">if</span> (rh == <span class="keyword">null</span> || rh.tid != getThreadId(current))</div><div class="line">                          rh = readHolds.get();</div><div class="line">                      <span class="keyword">else</span> <span class="keyword">if</span> (rh.count == <span class="number">0</span>)</div><div class="line">                          readHolds.set(rh);</div><div class="line">                      rh.count++;</div><div class="line">                      cachedHoldCounter = rh; <span class="comment">// cache for release</span></div><div class="line">                  &#125;</div><div class="line">                  <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line">      &#125;</div></pre></td></tr></table></figure></p>
<p>这里通过自旋的方式来不断的获取读锁的状态,并通过CAS来更新.<br>最后是释放锁:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryReleaseShared</span><span class="params">(<span class="keyword">int</span> unused)</span> </span>&#123;</div><div class="line">           Thread current = Thread.currentThread();</div><div class="line">           <span class="keyword">if</span> (firstReader == current) &#123;</div><div class="line">               <span class="comment">// assert firstReaderHoldCount &gt; 0;</span></div><div class="line">               <span class="keyword">if</span> (firstReaderHoldCount == <span class="number">1</span>)</div><div class="line">                   firstReader = <span class="keyword">null</span>;</div><div class="line">               <span class="keyword">else</span></div><div class="line">                   firstReaderHoldCount--;</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               HoldCounter rh = cachedHoldCounter;</div><div class="line">               <span class="keyword">if</span> (rh == <span class="keyword">null</span> || rh.tid != getThreadId(current))</div><div class="line">                   rh = readHolds.get();</div><div class="line">               <span class="keyword">int</span> count = rh.count;</div><div class="line">               <span class="keyword">if</span> (count &lt;= <span class="number">1</span>) &#123;</div><div class="line">                   readHolds.remove();</div><div class="line">                   <span class="keyword">if</span> (count &lt;= <span class="number">0</span>)</div><div class="line">                       <span class="keyword">throw</span> unmatchedUnlockException();</div><div class="line">               &#125;</div><div class="line">               --rh.count;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">for</span> (;;) &#123;</div><div class="line">               <span class="keyword">int</span> c = getState();</div><div class="line">               <span class="keyword">int</span> nextc = c - SHARED_UNIT;</div><div class="line">               <span class="keyword">if</span> (compareAndSetState(c, nextc))</div><div class="line">                   <span class="comment">// Releasing the read lock has no effect on readers,</span></div><div class="line">                   <span class="comment">// but it may allow waiting writers to proceed if</span></div><div class="line">                   <span class="comment">// both read and write locks are now free.</span></div><div class="line">                   <span class="keyword">return</span> nextc == <span class="number">0</span>;</div><div class="line">           &#125;</div><div class="line">       &#125;</div></pre></td></tr></table></figure></p>
<h4 id="脏读-幻读-不可重复读"><a href="#脏读-幻读-不可重复读" class="headerlink" title="脏读,幻读,不可重复读"></a>脏读,幻读,不可重复读</h4><p>脏读:是指当一个事物正在访问数据,对数据进行了修改,而这种事物还没有提交到数据库,这时另一个事物访问了该数据,然后使用了就得数据<br>不可重复读:是指在一个事物,多次访问同一事物,两次结果不一致.比如在一个事物中先读取了一条数据,这时另一个数据对这条数据进行了修改并提交,这时前面的事物如果再次读取同一数据,发现两次的事物不一致,这就是不可重复读<br>幻读:是指事物对数据进行两次查询,第二次的查询结果包含第一次查询中没有的数据后者少了第一次查询中出现的数据.这是因为在两次查询过程中另外一个事物进行了插入操作</p>
<h4 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h4><p>死锁问题是多线程特有的问题,在死锁时,线程间相互等待资源,而又不释放自身资源,导致无穷尽的等待,其结果时系统任务永远无法执行完成.<br>一般来说,要出现死锁必须满足下面几个条件:</p>
<ol>
<li>互斥条件:一个资源一次只能被一个线程使用</li>
<li>请求与保持条件:一个线程因请求资源而阻塞时,对已获得资源保持不妨</li>
<li>不剥夺条件:线程已获得的资源,在未使用完之前,不强行剥夺</li>
<li>循环等待条件:若干线程之间形成了一种头尾相连的等待循环关系</li>
</ol>
<p>如果要打破死锁,只要打破4个必要条件中一个或多个就可以了.<br>如何避免死锁:</p>
<ol>
<li>让程序每次至多获取一个锁.当然,在多线程环境下,这种情况通常不现实</li>
<li>设计时考虑清楚锁的顺序,尽量减少嵌套的加锁数量</li>
<li>既然死锁的是两个线程无线等待对方持有的所,那只要设置一个等待时间上限就可以了,可以使用Lock类中tryLock方法来尝试获得所,在超时之后返回获取失败</li>
</ol>
<h4 id="java信号量Semaphore"><a href="#java信号量Semaphore" class="headerlink" title="java信号量Semaphore"></a>java信号量Semaphore</h4><p>java信号量有点像”许可证集合”,比如银行排队有3个窗口(permit),但是有10个人排队,那这里窗口就相当于许可证,每当一个窗口处理完成后,释放(realse)出一个许可证,排队的人进入一个窗口,知道所有排队的人完成业务处理.<br>下面通过一个demo来说明用法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestSemaphore</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        Semaphore semaphore = <span class="keyword">new</span> Semaphore(<span class="number">5</span>);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) &#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> NO = i;</div><div class="line">            <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        semaphore.acquire();</div><div class="line">                        System.out.println(<span class="string">"Access No ="</span> + NO);</div><div class="line">                        Thread.sleep((<span class="keyword">long</span>)(Math.random()*<span class="number">1000</span>));</div><div class="line">                        semaphore.release();</div><div class="line">                        System.out.println(<span class="string">"Semaphore availiable ="</span> + semaphore.availablePermits());</div><div class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                        e.printStackTrace();</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                &#125;</div><div class="line">            &#125;).start();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>输出<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">Access No =1</div><div class="line">Access No =2</div><div class="line">Access No =0</div><div class="line">Access No =3</div><div class="line">Access No =4</div><div class="line">Semaphore availiable =1</div><div class="line">Access No =5</div><div class="line">Semaphore availiable =1</div><div class="line">Access No =6</div><div class="line">Semaphore availiable =1</div><div class="line">Access No =7</div><div class="line">Semaphore availiable =1</div><div class="line">Access No =8</div><div class="line">Semaphore availiable =1</div><div class="line">Access No =9</div><div class="line">Semaphore availiable =1</div><div class="line">Access No =10</div><div class="line">Semaphore availiable =1</div><div class="line">Access No =11</div><div class="line">Semaphore availiable =1</div><div class="line">Access No =12</div><div class="line">Semaphore availiable =1</div><div class="line">Access No =13</div><div class="line">Semaphore availiable =1</div><div class="line">Access No =14</div><div class="line">Semaphore availiable =1</div><div class="line">Access No =15</div><div class="line">Semaphore availiable =1</div><div class="line">Access No =16</div><div class="line">Semaphore availiable =1</div><div class="line">Access No =17</div><div class="line">Semaphore availiable =1</div><div class="line">Access No =18</div><div class="line">Semaphore availiable =1</div><div class="line">Access No =19</div><div class="line">Semaphore availiable =1</div><div class="line">Semaphore availiable =2</div><div class="line">Semaphore availiable =3</div><div class="line">Semaphore availiable =4</div><div class="line">Semaphore availiable =5</div></pre></td></tr></table></figure></p>
<p>用法非常简单,有点类似线程池的实现</p>
<h4 id="java-多线程包下的常用类使用"><a href="#java-多线程包下的常用类使用" class="headerlink" title="java 多线程包下的常用类使用"></a>java 多线程包下的常用类使用</h4><h5 id="CountDownLatch"><a href="#CountDownLatch" class="headerlink" title="CountDownLatch"></a>CountDownLatch</h5><p>CountDownLatch是指在其内部计数器不为0的情况下,运行把制定的线程阻塞并等待,直到内部计数器为0后,才唤醒阻塞的线程<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestCountdownLatch</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Thread1</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</div><div class="line">        <span class="keyword">private</span> CountDownLatch latch;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Thread1</span><span class="params">(CountDownLatch latch)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.latch = latch;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                Thread.sleep(<span class="number">2000</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">            latch.countDown();</div><div class="line">            System.out.println(<span class="string">"latch down  "</span>+latch.getCount());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        CountDownLatch latch = <span class="keyword">new</span> CountDownLatch(<span class="number">3</span>);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</div><div class="line">            Thread1 thread1 = <span class="keyword">new</span> Thread1(latch);</div><div class="line">            thread1.start();</div><div class="line">            thread1.join();</div><div class="line">        &#125;</div><div class="line">        latch.await();</div><div class="line">        System.out.println(<span class="string">"done!!!!"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>输出:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">latch down  2</div><div class="line">latch down  1</div><div class="line">latch down  0</div><div class="line">done!!!!</div></pre></td></tr></table></figure></p>
<h5 id="BlockingQueue阻塞队列"><a href="#BlockingQueue阻塞队列" class="headerlink" title="BlockingQueue阻塞队列"></a>BlockingQueue阻塞队列</h5><p>阻塞队列是一个支持两种附加超值的队列.这两个附加操作是: 在队列为空的时候,获取元素的线程会一直等待队列变为非空.当队列满时,存储元素的线程会等待队列可用.一个典型的生产者消费者的应用场景.<br>阻塞队列提供了下面四种处理方式:</p>
<table>
<thead>
<tr>
<th>方法\处理方法</th>
<th>抛出异常</th>
<th>返回特殊值</th>
<th>一直阻塞</th>
<th>超时退出</th>
</tr>
</thead>
<tbody>
<tr>
<td>  插入方法</td>
<td>add(e)</td>
<td>offer(e)</td>
<td>put(e)</td>
<td>offer(e,time,unit)</td>
</tr>
<tr>
<td>  移除方法</td>
<td>remove</td>
<td>poll()</td>
<td>take()</td>
<td>poll(time,unit)</td>
</tr>
<tr>
<td>  检查方法</td>
<td>element()</td>
<td>peek()</td>
<td>不可用</td>
<td>不可用</td>
</tr>
</tbody>
</table>
<h4 id="生产者消费者队列"><a href="#生产者消费者队列" class="headerlink" title="生产者消费者队列"></a>生产者消费者队列</h4><p>生产者消费者队列有两种常用的实现,一种是通过对象本身的wait和notify来实现,另一种是通过阻塞队列来实现<br>先看第一种方式:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Channel</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> Queue&lt;Good&gt; goodList = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> Good <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (goodList.size() == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> goodList.remove();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(Good good)</span> </span>&#123;</div><div class="line">        goodList.add(good);</div><div class="line">        notify();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Good</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Good</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.name = name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.name = name;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Channel表示仓库的含义,good表示里面放入的物品,在put的时候唤醒<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line">    <span class="keyword">private</span> Channel channel;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Consumer</span><span class="params">(String name, Channel channel)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.name = name;</div><div class="line">        <span class="keyword">this</span>.channel = channel;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">            Good good = channel.get();</div><div class="line">            <span class="keyword">if</span> (good != <span class="keyword">null</span>) &#123;</div><div class="line">                System.out.println(name + <span class="string">"获得商品: "</span> + good.getName());</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">synchronized</span> (channel) &#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        System.out.println(name + <span class="string">" 进入等待 "</span>);</div><div class="line">                        channel.wait();</div><div class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                        e.printStackTrace();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>消费者不断的从仓库中获取,如果发现没有了,阻塞进入等待<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">int</span> goodNumber = <span class="number">0</span>;</div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line">    <span class="keyword">private</span> Channel channel;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Producer</span><span class="params">(String name, Channel channel)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.name = name;</div><div class="line">        <span class="keyword">this</span>.channel = channel;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">            <span class="keyword">int</span> sleep = <span class="keyword">new</span> Random().nextInt(<span class="number">2000</span>);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                Thread.sleep(sleep);</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">            Good good = <span class="keyword">new</span> Good(<span class="string">"商品-编号"</span> + (++goodNumber));</div><div class="line">            System.out.println(name + <span class="string">"生成商品:"</span> + good.getName());</div><div class="line">            channel.put(good);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>生产者不断的放入物品到仓库中<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Tester</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        Channel channel = <span class="keyword">new</span> Channel();</div><div class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Producer(<span class="string">"生成者1"</span>, channel)).start();</div><div class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Producer(<span class="string">"生成者2"</span>, channel)).start();</div><div class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Producer(<span class="string">"生成者3"</span>, channel)).start();</div><div class="line"></div><div class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Consumer(<span class="string">"消费者1"</span>,channel)).start();</div><div class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Consumer(<span class="string">"消费者2"</span>,channel)).start();</div><div class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Consumer(<span class="string">"消费者3"</span>,channel)).start();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>输出:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">消费者1 进入等待</div><div class="line">消费者3 进入等待</div><div class="line">消费者2 进入等待</div><div class="line">生成者2生成商品:商品-编号1</div><div class="line">消费者1获得商品: 商品-编号1</div><div class="line">消费者1 进入等待</div><div class="line">生成者3生成商品:商品-编号2</div><div class="line">消费者3获得商品: 商品-编号2</div><div class="line">消费者3 进入等待</div><div class="line">生成者1生成商品:商品-编号3</div><div class="line">消费者2获得商品: 商品-编号3</div><div class="line">消费者2 进入等待</div><div class="line">生成者3生成商品:商品-编号4</div><div class="line">消费者1获得商品: 商品-编号4</div><div class="line">消费者1 进入等待</div><div class="line">生成者3生成商品:商品-编号5</div><div class="line">消费者3获得商品: 商品-编号5</div><div class="line">消费者3 进入等待</div><div class="line">生成者2生成商品:商品-编号6</div><div class="line">消费者2获得商品: 商品-编号6</div><div class="line">消费者2 进入等待</div><div class="line">生成者3生成商品:商品-编号7</div><div class="line">消费者1获得商品: 商品-编号7</div><div class="line">消费者1 进入等待</div><div class="line">生成者2生成商品:商品-编号8</div><div class="line">消费者3获得商品: 商品-编号8</div><div class="line">消费者3 进入等待</div><div class="line">生成者1生成商品:商品-编号9</div><div class="line">消费者2获得商品: 商品-编号9</div><div class="line">消费者2 进入等待</div><div class="line">生成者3生成商品:商品-编号10</div><div class="line">消费者1获得商品: 商品-编号10</div><div class="line">消费者1 进入等待</div><div class="line">生成者1生成商品:商品-编号11</div><div class="line">消费者3获得商品: 商品-编号11</div><div class="line">消费者3 进入等待</div><div class="line">生成者1生成商品:商品-编号12</div><div class="line">消费者2获得商品: 商品-编号12</div><div class="line">消费者2 进入等待</div><div class="line">生成者2生成商品:商品-编号13</div><div class="line">消费者1获得商品: 商品-编号13</div><div class="line">消费者1 进入等待</div><div class="line">生成者3生成商品:商品-编号14</div><div class="line">消费者3获得商品: 商品-编号14</div><div class="line">消费者3 进入等待</div><div class="line">生成者2生成商品:商品-编号15</div><div class="line">消费者2获得商品: 商品-编号15</div><div class="line">消费者2 进入等待</div><div class="line">生成者1生成商品:商品-编号16</div><div class="line">消费者1获得商品: 商品-编号16</div><div class="line">消费者1 进入等待</div><div class="line">生成者3生成商品:商品-编号17</div><div class="line">消费者3获得商品: 商品-编号17</div><div class="line">消费者3 进入等待</div><div class="line">生成者1生成商品:商品-编号18</div><div class="line">消费者2获得商品: 商品-编号18</div><div class="line">消费者2 进入等待</div><div class="line">生成者2生成商品:商品-编号19</div><div class="line">消费者1获得商品: 商品-编号19</div><div class="line">消费者1 进入等待</div><div class="line">生成者3生成商品:商品-编号20</div></pre></td></tr></table></figure>
<p>第二种方式,通过阻塞队列来实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestBlockingQueue</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</div><div class="line">        <span class="keyword">private</span> BlockingQueue&lt;Integer&gt; blockingQueue;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Consumer</span><span class="params">(BlockingQueue&lt;Integer&gt; blockingQueue)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.blockingQueue = blockingQueue;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                   <span class="keyword">int</span> i = blockingQueue.take();</div><div class="line">                    System.out.println(<span class="string">"get "</span>+i);</div><div class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</div><div class="line">        <span class="keyword">private</span> BlockingQueue&lt;Integer&gt; blockingQueue;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Producer</span><span class="params">(BlockingQueue&lt;Integer&gt; blockingQueue)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.blockingQueue = blockingQueue;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</div><div class="line">                    System.out.println(<span class="string">"put "</span> + i);</div><div class="line">                    blockingQueue.put(i);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        BlockingQueue&lt;Integer&gt; queue = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;();</div><div class="line">        <span class="keyword">new</span> Consumer(queue).start();</div><div class="line">        <span class="keyword">new</span> Producer(queue).start();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://pheobusyy.github.io/2016/12/16/2016/ThreadLocal源码分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanyi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pheobusyy">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/16/2016/ThreadLocal源码分析/" itemprop="url">
                  ThreadLocal源码分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-16T09:44:00+08:00">
                2016-12-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="ThreadLocal源码分析"><a href="#ThreadLocal源码分析" class="headerlink" title="ThreadLocal源码分析"></a>ThreadLocal源码分析</h2><p>  根据命名可以理解为”线程独有的”变量,也就是说这些变量是与所属线程相对应的,每个线程都有该变量独有的一份拷贝,相互之间是透明的.ThreadLocal实例的典型运用应该是private static的成员变量,比如去获取userId或者Transaction ID.</p>
<p>  ThreadLocal是一种线程安全的区别于锁机制的实现方式,通过线程隔离来完成线程数据之间不互相干扰.</p>
<p>  ThreadLocal使用非常简单,只有4个常用方法,分别是:</p>
<p>  <em>get()</em> :用来获取当前线程中的变量值<br>  <em>set(T value)</em> :用来给当前线程中的变量赋值<br>  <em>remove</em> :用来移除当前线程中的变量值<br>  <em>initialValue()</em> :用来在第一次get没有值得时候做初始化操作,一般是通过复写该方法来完成初始化的</p>
<p>  下面是一个demo代码,用来给每个调用它的线程产生一个唯一ID:<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadId</span> </span>&#123;</div><div class="line">    <span class="comment">// Atomic integer containing the next thread ID to be assigned</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicInteger nextId = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Thread local variable containing each thread's ID</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Integer&gt; threadId =</div><div class="line">        <span class="keyword">new</span> ThreadLocal&lt;Integer&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> Integer <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> nextId.getAndIncrement();</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="comment">// Returns the current thread's unique ID, assigning it if necessary</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> threadId.get();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><p>  既然不同的线程所包含的变量值不一样,那么内部肯定是有一种类似map的数据结构在做一一对应关系.<br>  构造函数就是一个普通构造函数,我们从 <em>set()</em> 方法开始:</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> T <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">      Thread t = Thread.currentThread();</div><div class="line">      ThreadLocalMap map = getMap(t);</div><div class="line">      <span class="keyword">if</span> (map != <span class="keyword">null</span>) &#123;</div><div class="line">          ThreadLocalMap.Entry e = map.getEntry(<span class="keyword">this</span>);</div><div class="line">          <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123;</div><div class="line">              <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">              T result = (T)e.value;</div><div class="line">              <span class="keyword">return</span> result;</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> setInitialValue();</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>  首先是获取当前的线程对象,然后调用 <em>getMap</em> 方法返回一个 <em>ThreadLocalMap</em> 对象,再看 <em>getMap</em> 方法:</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function">ThreadLocalMap <span class="title">getMap</span><span class="params">(Thread t)</span> </span>&#123;</div><div class="line">     <span class="keyword">return</span> t.threadLocals;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>  说明 <em>ThreadLocalMap</em> 来自于每个线程对象中.不过定义是在ThreadLocal中定义的,从明明商可以看到这个对象就是我们前面猜测的一种具有map性质的数据结构.<br>  其中key就是this也就是当前的ThreadLocal对象本身,value就是我们给ThreadLocal的赋值对象了.如果没有找到 <em>ThreadLocalMap</em> 对象,进入 <em>setInitialValue</em> 方法<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">  * Variant of set() to establish initialValue. Used instead</div><div class="line">  * of set() in case user has overridden the set() method.</div><div class="line">  *</div><div class="line">  * <span class="doctag">@return</span> the initial value</div><div class="line">  */</div><div class="line"> <span class="function"><span class="keyword">private</span> T <span class="title">setInitialValue</span><span class="params">()</span> </span>&#123;</div><div class="line">     T value = initialValue();</div><div class="line">     Thread t = Thread.currentThread();</div><div class="line">     ThreadLocalMap map = getMap(t);</div><div class="line">     <span class="keyword">if</span> (map != <span class="keyword">null</span>)</div><div class="line">         map.set(<span class="keyword">this</span>, value);</div><div class="line">     <span class="keyword">else</span></div><div class="line">         createMap(t, value);</div><div class="line">     <span class="keyword">return</span> value;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>  在这里就会调用前面说过的4个常用方法之一的 <em>initialValue</em> 方法,用来做初始化赋值.同样,如果map存在就直接赋值,否者进入 <em>createMap</em> 方法</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Create the map associated with a ThreadLocal. Overridden in</div><div class="line"> * InheritableThreadLocal.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> t the current thread</div><div class="line"> * <span class="doctag">@param</span> firstValue value for the initial entry of the map</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">createMap</span><span class="params">(Thread t, T firstValue)</span> </span>&#123;</div><div class="line">    t.threadLocals = <span class="keyword">new</span> ThreadLocalMap(<span class="keyword">this</span>, firstValue);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  非常简单,给Thread的对象的ThreadLocalMap对象赋值,同时把变量值也赋给ThreadLocalMap.<br>  再看 <em>set</em> 方法,也很简单清晰:<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">  * Sets the current thread's copy of this thread-local variable</div><div class="line">  * to the specified value.  Most subclasses will have no need to</div><div class="line">  * override this method, relying solely on the &#123;<span class="doctag">@link</span> #initialValue&#125;</div><div class="line">  * method to set the values of thread-locals.</div><div class="line">  *</div><div class="line">  * <span class="doctag">@param</span> value the value to be stored in the current thread's copy of</div><div class="line">  *        this thread-local.</div><div class="line">  */</div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(T value)</span> </span>&#123;</div><div class="line">     Thread t = Thread.currentThread();</div><div class="line">     ThreadLocalMap map = getMap(t);</div><div class="line">     <span class="keyword">if</span> (map != <span class="keyword">null</span>)</div><div class="line">         map.set(<span class="keyword">this</span>, value);</div><div class="line">     <span class="keyword">else</span></div><div class="line">         createMap(t, value);</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>  4个方法分分钟就讲完了,是不是非常简单,剩余核心其实就是 <em>ThreadLocalMap</em> 的实现方式了,在其内部实现了map类型的数据结构,先来看map中的Entry对象:</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">      * The entries in this hash map extend WeakReference, using</div><div class="line">      * its main ref field as the key (which is always a</div><div class="line">      * ThreadLocal object).  Note that null keys (i.e. entry.get()</div><div class="line">      * == null) mean that the key is no longer referenced, so the</div><div class="line">      * entry can be expunged from table.  Such entries are referred to</div><div class="line">      * as "stale entries" in the code that follows.</div><div class="line">      */</div><div class="line">     <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span> <span class="keyword">extends</span> <span class="title">WeakReference</span>&lt;<span class="title">ThreadLocal</span>&lt;?&gt;&gt; </span>&#123;</div><div class="line">         <span class="comment">/** The value associated with this ThreadLocal. */</span></div><div class="line">         Object value;</div><div class="line"></div><div class="line">         Entry(ThreadLocal&lt;?&gt; k, Object v) &#123;</div><div class="line">             <span class="keyword">super</span>(k);</div><div class="line">             value = v;</div><div class="line">         &#125;</div><div class="line">     &#125;</div></pre></td></tr></table></figure>
<p>  可以看到key是 通过弱引用包含的ThreadLocal对象,value就是我们给ThreadLocal的赋值.<br>  下面来看map中的set实现:<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">       * Set the value associated with key.</div><div class="line">       *</div><div class="line">       * <span class="doctag">@param</span> key the thread local object</div><div class="line">       * <span class="doctag">@param</span> value the value to be set</div><div class="line">       */</div><div class="line">      <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(ThreadLocal&lt;?&gt; key, Object value)</span> </span>&#123;</div><div class="line"></div><div class="line">          <span class="comment">// We don't use a fast path as with get() because it is at</span></div><div class="line">          <span class="comment">// least as common to use set() to create new entries as</span></div><div class="line">          <span class="comment">// it is to replace existing ones, in which case, a fast</span></div><div class="line">          <span class="comment">// path would fail more often than not.</span></div><div class="line"></div><div class="line">          Entry[] tab = table;</div><div class="line">          <span class="keyword">int</span> len = tab.length;</div><div class="line">          <span class="keyword">int</span> i = key.threadLocalHashCode &amp; (len-<span class="number">1</span>);</div><div class="line"></div><div class="line">          <span class="keyword">for</span> (Entry e = tab[i];</div><div class="line">               e != <span class="keyword">null</span>;</div><div class="line">               e = tab[i = nextIndex(i, len)]) &#123;</div><div class="line">              ThreadLocal&lt;?&gt; k = e.get();</div><div class="line"></div><div class="line">              <span class="keyword">if</span> (k == key) &#123;</div><div class="line">                  e.value = value;</div><div class="line">                  <span class="keyword">return</span>;</div><div class="line">              &#125;</div><div class="line"></div><div class="line">              <span class="keyword">if</span> (k == <span class="keyword">null</span>) &#123;</div><div class="line">                  replaceStaleEntry(key, value, i);</div><div class="line">                  <span class="keyword">return</span>;</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          tab[i] = <span class="keyword">new</span> Entry(key, value);</div><div class="line">          <span class="keyword">int</span> sz = ++size;</div><div class="line">          <span class="keyword">if</span> (!cleanSomeSlots(i, sz) &amp;&amp; sz &gt;= threshold)</div><div class="line">              rehash();</div><div class="line">      &#125;</div></pre></td></tr></table></figure></p>
<p>  遍历所有的Entry数组,如果找到key值一样的直接覆盖,如果发现一个key为空的情况,把那个位置的对象更新一下,否者如果刚开始Entry数组对象为空的时候,直接赋值数组的指定位置.这个位置是通过上面的对应hash算法生成的.<br>  map内部的清空无用的值的算法太复杂了,就不介绍了,重点是明白ThreadLocal的原理就可以了.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://pheobusyy.github.io/2016/12/09/2016/java基础知识/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanyi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pheobusyy">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/09/2016/java基础知识/" itemprop="url">
                  java基础知识
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-09T14:50:00+08:00">
                2016-12-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="map的put方法的返回值"><a href="#map的put方法的返回值" class="headerlink" title="map的put方法的返回值"></a>map的put方法的返回值</h2><p>  今天在看EventBus源码的时候发现一行代码 ,是放一个map中put数据,关键是map的put方法居然有返回值,今天才是刚刚发现这个神奇的常识,后来通过写个demo验证一下返回值情况<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Map&lt;String, String&gt; map = <span class="keyword">new</span> TreeMap&lt;&gt;();</div><div class="line">        String a = map.put(<span class="string">"a"</span>, <span class="string">"123"</span>);</div><div class="line">        System.out.println(<span class="string">"a = "</span> + a);</div><div class="line"></div><div class="line">        String a1 = map.put(<span class="string">"a"</span>, <span class="string">"123"</span>);</div><div class="line">        System.out.println(<span class="string">"a1 = "</span> + a1);</div><div class="line"></div><div class="line">        String a2 = map.put(<span class="string">"a"</span>, <span class="string">"789"</span>);</div><div class="line">        System.out.println(<span class="string">"a2 = "</span> + a2);</div><div class="line"></div><div class="line">        String b = map.put(<span class="string">"b"</span>, <span class="string">"456"</span>);</div><div class="line">        System.out.println(<span class="string">"b = "</span>+ b);</div><div class="line"></div><div class="line">```  </div><div class="line"></div><div class="line">返回值为:</div><div class="line"></div><div class="line">```java</div><div class="line">a = <span class="keyword">null</span></div><div class="line">a1 = <span class="number">123</span></div><div class="line">a2 = <span class="number">123</span></div><div class="line">b = <span class="keyword">null</span></div></pre></td></tr></table></figure></p>
<p>可见,如果是map中没有的数据,返回空,如果已经存在的数据,返回对应的value,如果是覆盖数据的话会返回之前存储的value</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Implements Map.put and related methods</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> hash hash for key</div><div class="line">     * <span class="doctag">@param</span> key the key</div><div class="line">     * <span class="doctag">@param</span> value the value to put</div><div class="line">     * <span class="doctag">@param</span> onlyIfAbsent if true, don't change existing value</div><div class="line">     * <span class="doctag">@param</span> evict if false, the table is in creation mode.</div><div class="line">     * <span class="doctag">@return</span> previous value, or null if none</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">boolean</span> onlyIfAbsent,</span></span></div><div class="line">                   <span class="keyword">boolean</span> evict) &#123;</div><div class="line">        Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="keyword">int</span> n, i;</div><div class="line">        <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</div><div class="line">            n = (tab = resize()).length;</div><div class="line">        <span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="keyword">null</span>)</div><div class="line">            tab[i] = newNode(hash, key, value, <span class="keyword">null</span>);</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            Node&lt;K,V&gt; e; K k;</div><div class="line">            <span class="keyword">if</span> (p.hash == hash &amp;&amp;</div><div class="line">                ((k = p.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</div><div class="line">                e = p;</div><div class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)</div><div class="line">                e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class="keyword">this</span>, tab, hash, key, value);</div><div class="line">            <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> binCount = <span class="number">0</span>; ; ++binCount) &#123;</div><div class="line">                    <span class="keyword">if</span> ((e = p.next) == <span class="keyword">null</span>) &#123;</div><div class="line">                        p.next = newNode(hash, key, value, <span class="keyword">null</span>);</div><div class="line">                        <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>) <span class="comment">// -1 for 1st</span></div><div class="line">                            treeifyBin(tab, hash);</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">if</span> (e.hash == hash &amp;&amp;</div><div class="line">                        ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    p = e;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123; <span class="comment">// existing mapping for key</span></div><div class="line">                V oldValue = e.value;</div><div class="line">                <span class="keyword">if</span> (!onlyIfAbsent || oldValue == <span class="keyword">null</span>)</div><div class="line">                    e.value = value;</div><div class="line">                afterNodeAccess(e);</div><div class="line">                <span class="keyword">return</span> oldValue;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        ++modCount;</div><div class="line">        <span class="keyword">if</span> (++size &gt; threshold)</div><div class="line">            resize();</div><div class="line">        afterNodeInsertion(evict);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="java-isAssignableFrom-Class-lt-gt-code-方法的使用"><a href="#java-isAssignableFrom-Class-lt-gt-code-方法的使用" class="headerlink" title="java isAssignableFrom(Class&lt;?&gt; code)方法的使用"></a>java isAssignableFrom(Class&lt;?&gt; code)方法的使用</h2><p>下面是该方法的个人翻译:</p>
<blockquote>
<p>决定当前的class对象是否是传入对象的父类,父接口,或者相同的类对象<br>特别是这个用来判断传入的class对象是否可以转换为当前class对象或者更宽的关联转换</p>
</blockquote>
<p>可见,该方法正好和 <em>instance of</em> 方法相反,用来判断当前class是不是param class的父类或本身.而 <em>instance of</em> 是判断一个对象是不是另一个类的实现<br>还有一个方法是class里面的 <em>isInstance(Object obj)</em> ,用来判断当前的obj是不是当前class的实现, <em>instance of</em> 和 <em>isInstance</em> 功能一样</p>
<h2 id="A-class和new-A-getClass的区别"><a href="#A-class和new-A-getClass的区别" class="headerlink" title="A.class和new A().getClass的区别"></a>A.class和new A().getClass的区别</h2><p>两个方法都是返回class实例变量,正常情况下是一样的,除了多态的时候</p>
<blockquote>
<p>a.getClass返回的是运行时类型,如果A a = new B(),那么a.getClass返回的是B class<br>A.class返回的是A class静态对象 ,一般用作反射时候使用<br>A.class是在编译的时候就确定了,而a.getClass()却是在运行的时候确定的</p>
</blockquote>
<h2 id="java中的transient关键字"><a href="#java中的transient关键字" class="headerlink" title="java中的transient关键字"></a>java中的transient关键字</h2><p>transient英文的意思是”瞬态的,短暂的”,反义词是”permament”,永久的.<br>在java中,如果一个变量的前面添加了 <em>transient</em> 关键字,表明在当前对象的序列号中中,该变量将不被序列化.<br>关于 <em>transient</em> 的使用有下面三点:</p>
<ol>
<li>一旦变量被 <em>transient</em> 修饰,变量将不再是对象持久化的一部分,该变量内容在序列化后无法获得访问</li>
<li><em>transient</em> 关键字只能修饰变量,而不能修饰类和方法.注意,本地变量是不能被 <em>transient</em> 关键字修饰的.变量如果是用户自定义变量,则改类需要实现Serialiazble接口.</li>
<li>被 <em>transient</em> 关键字修饰的变量不再能被序列化,一个静态变量不管是否被 <em>transient</em> 修饰,均不能被序列化.  </li>
</ol>
<h2 id="java中如何快速的跳出多重循环"><a href="#java中如何快速的跳出多重循环" class="headerlink" title="java中如何快速的跳出多重循环"></a>java中如何快速的跳出多重循环</h2><p>一种是通过外面设置一个flag,通过判断flag来结束每一层的循环,还有一种是通过循环标签来快速完成:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loop</span><span class="params">()</span></span>&#123;</div><div class="line">    OK:</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span> ; i &lt; <span class="number">100</span> ; i++ ) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span> ;j &lt;=i ;j++ ) &#123;</div><div class="line">            <span class="keyword">if</span> (i == <span class="number">10</span>) &#123;</div><div class="line">              <span class="comment">//在这里会退出所有的循环</span></div><div class="line">              <span class="keyword">break</span> OK;</div><div class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(i == <span class="number">2</span>)&#123;</div><div class="line">              <span class="comment">//只会退出当前一次的内层循环</span></div><div class="line">              <span class="keyword">continue</span> OK;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="java中Thread-的run和start方法的区别"><a href="#java中Thread-的run和start方法的区别" class="headerlink" title="java中Thread 的run和start方法的区别"></a>java中Thread 的run和start方法的区别</h2><p>run是在当前线程中直接调用run方法中的代码,这个时候线程对象就是一个普通的对象,线程没有运行.<br>start方法新开一个线程来执行run方法中的代码.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">      checkNotStarted();</div><div class="line"></div><div class="line">      hasBeenStarted = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">      nativeCreate(<span class="keyword">this</span>, stackSize, daemon);</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (target != <span class="keyword">null</span>) &#123;</div><div class="line">        target.run();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://pheobusyy.github.io/2016/12/09/2016/EventBus源码解析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanyi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pheobusyy">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/09/2016/EventBus源码解析/" itemprop="url">
                  EventBus源码解析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-09T14:05:00+08:00">
                2016-12-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="EventBus3-0源码解析"><a href="#EventBus3-0源码解析" class="headerlink" title="EventBus3.0源码解析"></a>EventBus3.0源码解析</h2><p>  使用方法是在工程的任何一个地方都可以通过EventBus对象来post一个Event对象给EventBus，然后在需要处理Event对象的类中register该类来响应处理，那么程序的入口就从EventBus的register方法入手了。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(Object subscriber)</span> </span>&#123;</div><div class="line">        Class&lt;?&gt; subscriberClass = subscriber.getClass();</div><div class="line">        List&lt;SubscriberMethod&gt; subscriberMethods = subscriberMethodFinder.findSubscriberMethods(subscriberClass);</div><div class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">            <span class="keyword">for</span> (SubscriberMethod subscriberMethod : subscriberMethods) &#123;</div><div class="line">                subscribe(subscriber, subscriberMethod);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>可以看到register方法中的核心方法在 <em>subscriberMethodFinder.findSubscriberMethods</em> 来返回所有注册的方法对象<br>那么下一步就进入 <em>subscriberMethodFinder</em> 来查看这个 <em>findSubscriberMethods</em> 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function">List&lt;SubscriberMethod&gt; <span class="title">findSubscriberMethods</span><span class="params">(Class&lt;?&gt; subscriberClass)</span> </span>&#123;</div><div class="line">       List&lt;SubscriberMethod&gt; subscriberMethods = METHOD_CACHE.get(subscriberClass);</div><div class="line">       <span class="keyword">if</span> (subscriberMethods != <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">return</span> subscriberMethods;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (ignoreGeneratedIndex) &#123;</div><div class="line">           subscriberMethods = findUsingReflection(subscriberClass);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           subscriberMethods = findUsingInfo(subscriberClass);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (subscriberMethods.isEmpty()) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"Subscriber "</span> + subscriberClass</div><div class="line">                   + <span class="string">" and its super classes have no public methods with the @Subscribe annotation"</span>);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           METHOD_CACHE.put(subscriberClass, subscriberMethods);</div><div class="line">           <span class="keyword">return</span> subscriberMethods;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>可以看到 <em>findSubscriberMethods</em> 方法中,关键点就在 <em>findUsingReflection</em> 和 <em>findUsingInfo</em> 这两个方法中.由于 <em>findUsingReflection</em> 的代码比较少,所以先从这个方法开始.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> List&lt;SubscriberMethod&gt; <span class="title">findUsingReflection</span><span class="params">(Class&lt;?&gt; subscriberClass)</span> </span>&#123;</div><div class="line">       FindState findState = prepareFindState();</div><div class="line">       findState.initForSubscriber(subscriberClass);</div><div class="line">       <span class="keyword">while</span> (findState.clazz != <span class="keyword">null</span>) &#123;</div><div class="line">           findUsingReflectionInSingleClass(findState);</div><div class="line">           findState.moveToSuperclass();</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> getMethodsAndRelease(findState);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>这里用来存放匹配结果的中间对象叫做 <em>FindState</em> ,稍后具体来说 <em>FindState</em> 的内部实现,现在先看一个生成 <em>FindState</em> 对象的方法 <em>prepareFindState</em></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> FindState <span class="title">prepareFindState</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span> (FIND_STATE_POOL) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; POOL_SIZE; i++) &#123;</div><div class="line">                FindState state = FIND_STATE_POOL[i];</div><div class="line">                <span class="keyword">if</span> (state != <span class="keyword">null</span>) &#123;</div><div class="line">                    FIND_STATE_POOL[i] = <span class="keyword">null</span>;</div><div class="line">                    <span class="keyword">return</span> state;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FindState();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> List&lt;SubscriberMethod&gt; <span class="title">getMethodsAndRelease</span><span class="params">(FindState findState)</span> </span>&#123;</div><div class="line">        List&lt;SubscriberMethod&gt; subscriberMethods = <span class="keyword">new</span> ArrayList&lt;&gt;(findState.subscriberMethods);</div><div class="line">        findState.recycle();</div><div class="line">        <span class="keyword">synchronized</span> (FIND_STATE_POOL) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; POOL_SIZE; i++) &#123;</div><div class="line">                <span class="keyword">if</span> (FIND_STATE_POOL[i] == <span class="keyword">null</span>) &#123;</div><div class="line">                    FIND_STATE_POOL[i] = findState;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> subscriberMethods;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>这里 <em>FIND_STATE_POOL</em> 是一个对象池,最大容量4个,可以想象,如果每次都生成一个 <em>findState</em> 的方法的话,会生成很多很多的中间对象,对性能造成影响,所以通过一个对象池来解决大量中间计算对象的问题,首先如果在对象池中找到有对象就直接使用,同时把对象池中的对象置空,最后回收的时候把用完了的对象放入对象池中,达到了循环引用的目的.感觉这个设计非常巧妙.</p>
<p>下一步我们来到 <em>findUsingReflection</em> 方法中的 <em>findUsingReflectionInSingleClass</em> 方法中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">findUsingReflectionInSingleClass</span><span class="params">(FindState findState)</span> </span>&#123;</div><div class="line">        Method[] methods;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// This is faster than getMethods, especially when subscribers are fat classes like Activities</span></div><div class="line">            methods = findState.clazz.getDeclaredMethods();</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable th) &#123;</div><div class="line">            <span class="comment">// Workaround for java.lang.NoClassDefFoundError, see https://github.com/greenrobot/EventBus/issues/149</span></div><div class="line">            methods = findState.clazz.getMethods();</div><div class="line">            findState.skipSuperClasses = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (Method method : methods) &#123;</div><div class="line">            <span class="keyword">int</span> modifiers = method.getModifiers();</div><div class="line">            <span class="keyword">if</span> ((modifiers &amp; Modifier.PUBLIC) != <span class="number">0</span> &amp;&amp; (modifiers &amp; MODIFIERS_IGNORE) == <span class="number">0</span>) &#123;</div><div class="line">                Class&lt;?&gt;[] parameterTypes = method.getParameterTypes();</div><div class="line">                <span class="keyword">if</span> (parameterTypes.length == <span class="number">1</span>) &#123;</div><div class="line">                    Subscribe subscribeAnnotation = method.getAnnotation(Subscribe.class);</div><div class="line">                    <span class="keyword">if</span> (subscribeAnnotation != <span class="keyword">null</span>) &#123;</div><div class="line">                        Class&lt;?&gt; eventType = parameterTypes[<span class="number">0</span>];</div><div class="line">                        <span class="keyword">if</span> (findState.checkAdd(method, eventType)) &#123;</div><div class="line">                            ThreadMode threadMode = subscribeAnnotation.threadMode();</div><div class="line">                            findState.subscriberMethods.add(<span class="keyword">new</span> SubscriberMethod(method, eventType, threadMode,</div><div class="line">                                    subscribeAnnotation.priority(), subscribeAnnotation.sticky()));</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strictMethodVerification &amp;&amp; method.isAnnotationPresent(Subscribe.class)) &#123;</div><div class="line">                    String methodName = method.getDeclaringClass().getName() + <span class="string">"."</span> + method.getName();</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"@Subscribe method "</span> + methodName +</div><div class="line">                            <span class="string">"must have exactly 1 parameter but has "</span> + parameterTypes.length);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strictMethodVerification &amp;&amp; method.isAnnotationPresent(Subscribe.class)) &#123;</div><div class="line">                String methodName = method.getDeclaringClass().getName() + <span class="string">"."</span> + method.getName();</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(methodName +</div><div class="line">                        <span class="string">" is a illegal @Subscribe method: must be public, non-static, and non-abstract"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>核心代码在for循环中的第一个if中,其他的是严格模式下返回异常信息.<br>首先取到注册类中的所有的声明方法,然后遍历找到其中是public的并且不是静态,抽象,中间编译器生成的方法,下面是这需要忽略类型的并集</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MODIFIERS_IGNORE = Modifier.ABSTRACT | Modifier.STATIC | BRIDGE | SYNTHETIC;</div></pre></td></tr></table></figure>
<p>看代码,明确要求注册方法必须只能有一个参数,同时注解必须是Subscribe对象类型,然后获取第一个param的类型,交由 <em>findState.checkAdd(method,eventType)</em> 方法去判断是否需要添加到事件绑定中.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">checkAdd</span><span class="params">(Method method, Class&lt;?&gt; eventType)</span> </span>&#123;</div><div class="line">            <span class="comment">// 2 level check: 1st level with event type only (fast), 2nd level with complete signature when required.</span></div><div class="line">            <span class="comment">// Usually a subscriber doesn't have methods listening to the same event type.</span></div><div class="line">            Object existing = anyMethodByEventType.put(eventType, method);</div><div class="line">            <span class="keyword">if</span> (existing == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">if</span> (existing <span class="keyword">instanceof</span> Method) &#123;</div><div class="line">                    <span class="keyword">if</span> (!checkAddWithMethodSignature((Method) existing, eventType)) &#123;</div><div class="line">                        <span class="comment">// Paranoia check</span></div><div class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();</div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">// Put any non-Method object to "consume" the existing Method</span></div><div class="line">                    anyMethodByEventType.put(eventType, <span class="keyword">this</span>);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span> checkAddWithMethodSignature(method, eventType);</div><div class="line">            &#125;</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p>通过该方法的注释可以看到,有两层快速判断:第一层是通过eventType来判断,这种比较快,第二层是通过完成的签名来判断;通常情况下一个事件接受类不应该有多个方法对同一种类型的事件进行监听;<br>首先把eventType作为key,method对象作为value放入anyMethodByEventType这个map中,如果返回null说明之前是没有的放过的同样类型的eventType的,如果返回不为Null,说明anyMethodByEventType中已经有了同样的eventType事件监听,就需要更进一步的判断,交给下面的 <em>checkAddWithMethodSignature</em> 方法来处理.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">checkAddWithMethodSignature</span><span class="params">(Method method, Class&lt;?&gt; eventType)</span> </span>&#123;</div><div class="line">           methodKeyBuilder.setLength(<span class="number">0</span>);</div><div class="line">           methodKeyBuilder.append(method.getName());</div><div class="line">           methodKeyBuilder.append(<span class="string">'&gt;'</span>).append(eventType.getName());</div><div class="line"></div><div class="line">           String methodKey = methodKeyBuilder.toString();</div><div class="line">           Class&lt;?&gt; methodClass = method.getDeclaringClass();</div><div class="line">           Class&lt;?&gt; methodClassOld = subscriberClassByMethodKey.put(methodKey, methodClass);</div><div class="line">           <span class="keyword">if</span> (methodClassOld == <span class="keyword">null</span> || methodClassOld.isAssignableFrom(methodClass)) &#123;</div><div class="line">               <span class="comment">// Only add if not already found in a sub class</span></div><div class="line">               <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               <span class="comment">// Revert the put, old class is further down the class hierarchy</span></div><div class="line">               subscriberClassByMethodKey.put(methodKey, methodClassOld);</div><div class="line">               <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">           &#125;</div><div class="line">       &#125;</div></pre></td></tr></table></figure>
<p>首先是把方法名+接收参数类型名作为key存入map中,如果之前没有放入过,那么直接把返回true,交给上面的checkAdd返回true,说明事件绑定成功<br>如果已经放入过了,说明有两个同样名称的方法并且监听的居然是同一种eventType,获取方法的声明类class对象,和之前放入的声明class对象做isAssignableFrom判断,如果isAssignableFrom为true,说明已经放入的class是新放入的class本身类或者父类,返回true,可以添加,否则返回false,不可以添加,交给 <em>checkState</em> 方法throw一个异常.为什么会出现这种情况呢?个人思考了下应该是首先子类已经注册了一个subscribe方法对某一eventType做监听,同事父类里面有个同名方法对同样的eventType做监听,那么就会出现到底该绑定哪个方法的问题,这个时候优先绑定子类中同名方法,也就是离继承结构更远的方法,越靠近实现优先放入.</p>
<p>当当前类所有的绑定都完成之后, 通过 <em>findState.moveToSuperclass();</em> 让findState对象的class属性指向当前类的父类继续完成上面的操作,直到没有父类为止.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">moveToSuperclass</span><span class="params">()</span> </span>&#123;</div><div class="line">           <span class="keyword">if</span> (skipSuperClasses) &#123;</div><div class="line">               clazz = <span class="keyword">null</span>;</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               clazz = clazz.getSuperclass();</div><div class="line">               String clazzName = clazz.getName();</div><div class="line">               <span class="comment">/** Skip system classes, this just degrades performance. */</span></div><div class="line">               <span class="keyword">if</span> (clazzName.startsWith(<span class="string">"java."</span>) || clazzName.startsWith(<span class="string">"javax."</span>) || clazzName.startsWith(<span class="string">"android."</span>)) &#123;</div><div class="line">                   clazz = <span class="keyword">null</span>;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div></pre></td></tr></table></figure>
<p>这里忽略掉了java和android的公共类,节省性能,系统的类是没有必要继续遍历的.<br>当当前类包括其自定义父类全部都遍历完成后,调用 <em>getMethodsAndRelease(findState)</em> 生成绑定方法的集合</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> List&lt;SubscriberMethod&gt; <span class="title">getMethodsAndRelease</span><span class="params">(FindState findState)</span> </span>&#123;</div><div class="line">        List&lt;SubscriberMethod&gt; subscriberMethods = <span class="keyword">new</span> ArrayList&lt;&gt;(findState.subscriberMethods);</div><div class="line">        findState.recycle();</div><div class="line">        <span class="keyword">synchronized</span> (FIND_STATE_POOL) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; POOL_SIZE; i++) &#123;</div><div class="line">                <span class="keyword">if</span> (FIND_STATE_POOL[i] == <span class="keyword">null</span>) &#123;</div><div class="line">                    FIND_STATE_POOL[i] = findState;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> subscriberMethods;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>上面的流程是 <em>findUsingReflection</em> 方法的主要实现流程,还记得有两个绑定事件的方法吗?还有一个是 <em>findUsingInfo</em> 通过一个变量开关来开启 <em>ignoreGeneratedIndex</em> ,刚开始么有看懂是啥意思,上网查了下资料发现这个功能是3.0新加的,个人理解有点像 <em>预编译</em> 在编译的时候通过 apt中新增一个AnnotationProcessor来把代码中声明了subscribe的方法提前生成一个index集合,这样可以快速的完成事件的绑定,加快运行速度.</p>
<p>java的annotation如果声明为source的target的时候,可以通过继承一个AbstractProcessor来处理自定义annotation.<br>具体的实现方式这里先不展开了,感兴趣的话可以上网去看下官方说明<a href="http://greenrobot.org/eventbus/documentation/subscriber-index/" title="subscriber-index" target="_blank" rel="external">subscriber-index</a></p>
<p>完成了事件绑定之后,就进入EventBus的核心方法 <em>subscribe</em> 了,通过它来完成一个观察者模式,在post的时候找到事件绑定的方法然后调用它,这样就完成了一个事件从绑定到响应的主流程.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div></pre></td><td class="code"><pre><div class="line">private void subscribe(Object subscriber, SubscriberMethod subscriberMethod) &#123;</div><div class="line">        Class&lt;?&gt; eventType = subscriberMethod.eventType;</div><div class="line">        Subscription newSubscription = new Subscription(subscriber, subscriberMethod);</div><div class="line">        CopyOnWriteArrayList&lt;Subscription&gt; subscriptions = subscriptionsByEventType.get(eventType);</div><div class="line">        if (subscriptions == null) &#123;</div><div class="line">            subscriptions = new CopyOnWriteArrayList&lt;&gt;();</div><div class="line">            subscriptionsByEventType.put(eventType, subscriptions);</div><div class="line">        &#125; else &#123;</div><div class="line">            if (subscriptions.contains(newSubscription)) &#123;</div><div class="line">                throw new EventBusException("Subscriber " + subscriber.getClass() + " already registered to event "</div><div class="line">                        + eventType);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        int size = subscriptions.size();</div><div class="line">        for (int i = 0; i &lt;= size; i++) &#123;</div><div class="line">            if (i == size || subscriberMethod.priority &gt; subscriptions.get(i).subscriberMethod.priority) &#123;</div><div class="line">                subscriptions.add(i, newSubscription);</div><div class="line">                break;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        List&lt;Class&lt;?&gt;&gt; subscribedEvents = typesBySubscriber.get(subscriber);</div><div class="line">        if (subscribedEvents == null) &#123;</div><div class="line">            subscribedEvents = new ArrayList&lt;&gt;();</div><div class="line">            typesBySubscriber.put(subscriber, subscribedEvents);</div><div class="line">        &#125;</div><div class="line">        subscribedEvents.add(eventType);</div><div class="line"></div><div class="line">        if (subscriberMethod.sticky) &#123;</div><div class="line">            if (eventInheritance) &#123;</div><div class="line">                // Existing sticky events of all subclasses of eventType have to be considered.</div><div class="line">                // Note: Iterating over all events may be inefficient with lots of sticky events,</div><div class="line">                // thus data structure should be changed to allow a more efficient lookup</div><div class="line">                // (e.g. an additional map storing sub classes of super classes: Class -&gt; List&lt;Class&gt;).</div><div class="line">                Set&lt;Map.Entry&lt;Class&lt;?&gt;, Object&gt;&gt; entries = stickyEvents.entrySet();</div><div class="line">                for (Map.Entry&lt;Class&lt;?&gt;, Object&gt; entry : entries) &#123;</div><div class="line">                    Class&lt;?&gt; candidateEventType = entry.getKey();</div><div class="line">                    if (eventType.isAssignableFrom(candidateEventType)) &#123;</div><div class="line">                        Object stickyEvent = entry.getValue();</div><div class="line">                        checkPostStickyEventToSubscription(newSubscription, stickyEvent);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125; else &#123;</div><div class="line">                Object stickyEvent = stickyEvents.get(eventType);</div><div class="line">                checkPostStickyEventToSubscription(newSubscription, stickyEvent);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">```  </div><div class="line"></div><div class="line">### subscribe方法</div><div class="line">  当通过register方法获得了绑定事件的集合之后,就需要把注册类和绑定事件结合在一起,这样在post方法调用之后,可以快速的找到哪些类的哪些方法可以响应这次post事件,然后通过method对象的反射方法invoke(Object obj,Object... args)来调用绑定事件的方法.其中第二个参数就是post方法传入的eventType对象,第一个参数是register传入的绑定对象.一般是class对象.</div><div class="line"></div><div class="line">  ```java</div><div class="line">  // Must be called in synchronized block</div><div class="line">   private void subscribe(Object subscriber, SubscriberMethod subscriberMethod) &#123;</div><div class="line">       Class&lt;?&gt; eventType = subscriberMethod.eventType;</div><div class="line">       Subscription newSubscription = new Subscription(subscriber, subscriberMethod);</div><div class="line">       CopyOnWriteArrayList&lt;Subscription&gt; subscriptions = subscriptionsByEventType.get(eventType);</div><div class="line">       if (subscriptions == null) &#123;</div><div class="line">           subscriptions = new CopyOnWriteArrayList&lt;&gt;();</div><div class="line">           subscriptionsByEventType.put(eventType, subscriptions);</div><div class="line">       &#125; else &#123;</div><div class="line">           if (subscriptions.contains(newSubscription)) &#123;</div><div class="line">               throw new EventBusException("Subscriber " + subscriber.getClass() + " already registered to event "</div><div class="line">                       + eventType);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       int size = subscriptions.size();</div><div class="line">       for (int i = 0; i &lt;= size; i++) &#123;</div><div class="line">           if (i == size || subscriberMethod.priority &gt; subscriptions.get(i).subscriberMethod.priority) &#123;</div><div class="line">               subscriptions.add(i, newSubscription);</div><div class="line">               break;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       List&lt;Class&lt;?&gt;&gt; subscribedEvents = typesBySubscriber.get(subscriber);</div><div class="line">       if (subscribedEvents == null) &#123;</div><div class="line">           subscribedEvents = new ArrayList&lt;&gt;();</div><div class="line">           typesBySubscriber.put(subscriber, subscribedEvents);</div><div class="line">       &#125;</div><div class="line">       subscribedEvents.add(eventType);</div><div class="line"></div><div class="line">       if (subscriberMethod.sticky) &#123;</div><div class="line">           if (eventInheritance) &#123;</div><div class="line">               // Existing sticky events of all subclasses of eventType have to be considered.</div><div class="line">               // Note: Iterating over all events may be inefficient with lots of sticky events,</div><div class="line">               // thus data structure should be changed to allow a more efficient lookup</div><div class="line">               // (e.g. an additional map storing sub classes of super classes: Class -&gt; List&lt;Class&gt;).</div><div class="line">               Set&lt;Map.Entry&lt;Class&lt;?&gt;, Object&gt;&gt; entries = stickyEvents.entrySet();</div><div class="line">               for (Map.Entry&lt;Class&lt;?&gt;, Object&gt; entry : entries) &#123;</div><div class="line">                   Class&lt;?&gt; candidateEventType = entry.getKey();</div><div class="line">                   if (eventType.isAssignableFrom(candidateEventType)) &#123;</div><div class="line">                       Object stickyEvent = entry.getValue();</div><div class="line">                       checkPostStickyEventToSubscription(newSubscription, stickyEvent);</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125; else &#123;</div><div class="line">               Object stickyEvent = stickyEvents.get(eventType);</div><div class="line">               checkPostStickyEventToSubscription(newSubscription, stickyEvent);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">  ```  </div><div class="line"></div><div class="line">  抛开该方法最底下的sticky判断那块,代码其实很简单,主要是为两个map完成赋值操作.</div><div class="line">  两个map分别是:</div><div class="line"></div><div class="line">  ```java</div><div class="line">  private final Map&lt;Class&lt;?&gt;, CopyOnWriteArrayList&lt;Subscription&gt;&gt; subscriptionsByEventType;</div></pre></td></tr></table></figure>
<p>  key是eventType,value是所有的绑定该事件的方法对象,可以理解就是触发post的时候,可以通过这个map快速的找到都有哪些方法绑定了该事件,然后通过遍历调用他们</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Object, List&lt;Class&lt;?&gt;&gt;&gt; typesBySubscriber;</div></pre></td></tr></table></figure>
<p>  这个map的key是register传入的对象,value是这个对象内部所有的绑定方法,这个map主要是用来unRegister的时候可以把该对象中所有的绑定方法全部移除,节省时间,提升效率</p>
<p>  当完成两个map的赋值工作之后,时间绑定对应关系就确定了,那么剩下逻辑就是看post方法的相关处理了.</p>
<h3 id="post方法"><a href="#post方法" class="headerlink" title="post方法"></a>post方法</h3>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** Posts the given event to the event bus. */</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">post</span><span class="params">(Object event)</span> </span>&#123;</div><div class="line">    PostingThreadState postingState = currentPostingThreadState.get();</div><div class="line">    List&lt;Object&gt; eventQueue = postingState.eventQueue;</div><div class="line">    eventQueue.add(event);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!postingState.isPosting) &#123;</div><div class="line">        postingState.isMainThread = Looper.getMainLooper() == Looper.myLooper();</div><div class="line">        postingState.isPosting = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">if</span> (postingState.canceled) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"Internal error. Abort state was not reset"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">while</span> (!eventQueue.isEmpty()) &#123;</div><div class="line">                postSingleEvent(eventQueue.remove(<span class="number">0</span>), postingState);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            postingState.isPosting = <span class="keyword">false</span>;</div><div class="line">            postingState.isMainThread = <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里的 <em>currentPostingThreadState</em>用到了ThreadLocal这种概念,ThreadLocal是指每个线程都有自己的独有变量,线程之间不互相干扰,是线程同步的另一种解决方法.ThreadLocal在第一次获取数据的时候如果没有的话就会调用它自己的initialValue方法,现在是返回一个 <em>PostingThreadState</em> 对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** For ThreadLocal, much faster to set (and get multiple values). */</span></div><div class="line">   <span class="keyword">final</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PostingThreadState</span> </span>&#123;</div><div class="line">       <span class="keyword">final</span> List&lt;Object&gt; eventQueue = <span class="keyword">new</span> ArrayList&lt;Object&gt;();</div><div class="line">       <span class="keyword">boolean</span> isPosting;</div><div class="line">       <span class="keyword">boolean</span> isMainThread;</div><div class="line">       Subscription subscription;</div><div class="line">       Object event;</div><div class="line">       <span class="keyword">boolean</span> canceled;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>其中的 <em>eventQueue</em> 相当于一个事件处理队列,isPosting用来做单条发送的间隔开关,就是每次消化一个事件,isMainThread用来表示是否在主线程发布,对应EventBus的ThreadMode4种模式的处理,后续会讲到.下面进入 <em>postSingleEvent</em> 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postSingleEvent</span><span class="params">(Object event, PostingThreadState postingState)</span> <span class="keyword">throws</span> Error </span>&#123;</div><div class="line">    Class&lt;?&gt; eventClass = event.getClass();</div><div class="line">    <span class="keyword">boolean</span> subscriptionFound = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">if</span> (eventInheritance) &#123;</div><div class="line">        List&lt;Class&lt;?&gt;&gt; eventTypes = lookupAllEventTypes(eventClass);</div><div class="line">        <span class="keyword">int</span> countTypes = eventTypes.size();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> h = <span class="number">0</span>; h &lt; countTypes; h++) &#123;</div><div class="line">            Class&lt;?&gt; clazz = eventTypes.get(h);</div><div class="line">            subscriptionFound |= postSingleEventForEventType(event, postingState, clazz);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        subscriptionFound = postSingleEventForEventType(event, postingState, eventClass);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (!subscriptionFound) &#123;</div><div class="line">        <span class="keyword">if</span> (logNoSubscriberMessages) &#123;</div><div class="line">            Log.d(TAG, <span class="string">"No subscribers registered for event "</span> + eventClass);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (sendNoSubscriberEvent &amp;&amp; eventClass != NoSubscriberEvent.class &amp;&amp;</div><div class="line">                eventClass != SubscriberExceptionEvent.class) &#123;</div><div class="line">            post(<span class="keyword">new</span> NoSubscriberEvent(<span class="keyword">this</span>, event));</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>下面来解释一下 <em>eventInheritance</em> 这个开关,通过字面理解是 “事件继承” ,通过查阅文档说明,解释如下</p>
<blockquote>
<p>默认情况下,EventBus认为绑定事件Event Class是具有继承性的,也就是说绑定了Event Class的父类方法在post Event class的时候也会触发.<br>关闭这项功能,可以加快事件传递的速度.如果关闭的话,大概事件post速度大概会提高20%,如果是复杂的Event继承关系的话,速度会提升大于20%</p>
</blockquote>
<p>默认是开启 <em>事件继承</em> 功能的,所以我们进入 <em>lookupAllEventTypes</em> 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** Looks up all Class objects including super classes and interfaces. Should also work for interfaces. */</span></div><div class="line">   <span class="keyword">private</span> <span class="keyword">static</span> List&lt;Class&lt;?&gt;&gt; lookupAllEventTypes(Class&lt;?&gt; eventClass) &#123;</div><div class="line">       <span class="keyword">synchronized</span> (eventTypesCache) &#123;</div><div class="line">           List&lt;Class&lt;?&gt;&gt; eventTypes = eventTypesCache.get(eventClass);</div><div class="line">           <span class="keyword">if</span> (eventTypes == <span class="keyword">null</span>) &#123;</div><div class="line">               eventTypes = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">               Class&lt;?&gt; clazz = eventClass;</div><div class="line">               <span class="keyword">while</span> (clazz != <span class="keyword">null</span>) &#123;</div><div class="line">                   eventTypes.add(clazz);</div><div class="line">                   addInterfaces(eventTypes, clazz.getInterfaces());</div><div class="line">                   clazz = clazz.getSuperclass();</div><div class="line">               &#125;</div><div class="line">               eventTypesCache.put(eventClass, eventTypes);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">return</span> eventTypes;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** Recurses through super interfaces. */</span></div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addInterfaces</span><span class="params">(List&lt;Class&lt;?&gt;&gt; eventTypes, Class&lt;?&gt;[] interfaces)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (Class&lt;?&gt; interfaceClass : interfaces) &#123;</div><div class="line">            <span class="keyword">if</span> (!eventTypes.contains(interfaceClass)) &#123;</div><div class="line">                eventTypes.add(interfaceClass);</div><div class="line">                addInterfaces(eventTypes, interfaceClass.getInterfaces());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>通过代码很容易理解,获取当前post的Event class的所有父类和接口类,然后放入 <em>eventTypes</em> 集合中,分别发送一次,这样当你post一个事件的时候,相当于该事件对象的所有父类和接口类都post了一次.<br>直观一点举例,比如一个叫CommonEvent的类,父类是BaseEvent,接口是IEvent,那么当你post CommonEvent的时候,所有接受BaseEvent 和IEvent的绑定方法也会触发.</p>
<p>这里为了加快速度,把类的关系链存入了一个集合作为缓存使用.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">postSingleEventForEventType</span><span class="params">(Object event, PostingThreadState postingState, Class&lt;?&gt; eventClass)</span> </span>&#123;</div><div class="line">        CopyOnWriteArrayList&lt;Subscription&gt; subscriptions;</div><div class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">            subscriptions = subscriptionsByEventType.get(eventClass);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (subscriptions != <span class="keyword">null</span> &amp;&amp; !subscriptions.isEmpty()) &#123;</div><div class="line">            <span class="keyword">for</span> (Subscription subscription : subscriptions) &#123;</div><div class="line">                postingState.event = event;</div><div class="line">                postingState.subscription = subscription;</div><div class="line">                <span class="keyword">boolean</span> aborted = <span class="keyword">false</span>;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    postToSubscription(subscription, event, postingState.isMainThread);</div><div class="line">                    aborted = postingState.canceled;</div><div class="line">                &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                    postingState.event = <span class="keyword">null</span>;</div><div class="line">                    postingState.subscription = <span class="keyword">null</span>;</div><div class="line">                    postingState.canceled = <span class="keyword">false</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (aborted) &#123;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div></pre></td></tr></table></figure>
<p>下面马上进入post之后的回调处理,首先通过Event找到所有绑定该事件的方法集合,这里返回的是一个 <em>CopyOnWriteArrayList<subscription></subscription></em> ,然后遍历之,逐条调用绑定方法.进入 <em>postToSubscription</em> ,根据ThreadMode来做不同的回调处理.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postToSubscription</span><span class="params">(Subscription subscription, Object event, <span class="keyword">boolean</span> isMainThread)</span> </span>&#123;</div><div class="line">        <span class="keyword">switch</span> (subscription.subscriberMethod.threadMode) &#123;</div><div class="line">            <span class="keyword">case</span> POSTING:</div><div class="line">                invokeSubscriber(subscription, event);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> MAIN:</div><div class="line">                <span class="keyword">if</span> (isMainThread) &#123;</div><div class="line">                    invokeSubscriber(subscription, event);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    mainThreadPoster.enqueue(subscription, event);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> BACKGROUND:</div><div class="line">                <span class="keyword">if</span> (isMainThread) &#123;</div><div class="line">                    backgroundPoster.enqueue(subscription, event);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    invokeSubscriber(subscription, event);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> ASYNC:</div><div class="line">                asyncPoster.enqueue(subscription, event);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unknown thread mode: "</span> + subscription.subscriberMethod.threadMode);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p><em>postToSubscription</em> 这个方法就是回调的核心逻辑所在,通过threadMode的不同来对应不同的处理关系.<br>先翻译一下关于ThreadMode的文档说明:</p>
<ol>
<li><p>ThreadMode: POSTING<br>接收者会在与post方法的同一个线程中同步执行,这种方式的开销最小,主要是避免了线程切换,这种模式推荐使用在可以快速完成的简单任务并且不需要阻塞主线程.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Called in the same thread (default)</span></div><div class="line"><span class="comment">// ThreadMode is optional here</span></div><div class="line"><span class="meta">@Subscribe</span>(threadMode = ThreadMode.POSTING)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(MessageEvent event)</span> </span>&#123;</div><div class="line">    log(event.message);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>ThreadMode: MAIN<br>接收者会在android的主线程中被调用,如果post的事件是在主线程中,那么这时调用方法会直接被调用和上面的Posting一样,这种模式推荐处理很快并且不会阻塞主线程的逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Called in Android UI's main thread</span></div><div class="line"><span class="meta">@Subscribe</span>(threadMode = ThreadMode.MAIN)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(MessageEvent event)</span> </span>&#123;</div><div class="line">textField.setText(event.message);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>ThreadMode: BACKGROUND<br>接收者会在一个后台线程中别调用,如果post事件不是在主线程中,那么调用事件就会直接在post的线程中执行,如果是在主线程中post的话,EventBus会启用一个后台线程来处理所有这类event事件,事件回调应该迅速并且不会阻塞后台线程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">  <span class="comment">// Called in the background thread</span></div><div class="line">  <span class="meta">@Subscribe</span>(threadMode = ThreadMode.BACKGROUND)</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(MessageEvent event)</span></span>&#123;</div><div class="line">      saveToDisk(event.message);</div><div class="line">  &#125;</div><div class="line">  ```  </div><div class="line"><span class="number">4</span>. ThreadMode: ASYNC</div><div class="line">  事件回调会在一个单独的子线程中完成,这种情况下事件回调的线程是独立于主线程和post所在的线程的,是一个单独的线程,事件的post是不会等待回调方法的执行完成与否的,这种模式应该用于事件回调需要执行一段事件,比如网络请求等,要避免触发类似大量的长时间运行的异步线程.EventBus使用一个线程池来管理和回收这种线程.</div><div class="line">  ```java</div><div class="line">  <span class="comment">// Called in a separate thread</span></div><div class="line">  <span class="meta">@Subscribe</span>(threadMode = ThreadMode.ASYNC)</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(MessageEvent event)</span></span>&#123;</div><div class="line">      backend.send(event.message);</div><div class="line">  &#125;</div><div class="line">  ```  </div><div class="line">[官方ThreadMode说明][<span class="number">88</span>ce7be7]</div><div class="line"></div><div class="line">  [<span class="number">88</span>ce7be7]: http:<span class="comment">//greenrobot.org/eventbus/documentation/delivery-threads-threadmode/ "官方ThreadMode说明"</span></div><div class="line"></div><div class="line">  看完了官方说明之后,我们再来看代码具体实现,这个时候就已经很清晰了</div><div class="line"></div><div class="line">  ```<span class="function">java</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postToSubscription</span><span class="params">(Subscription subscription, Object event, <span class="keyword">boolean</span> isMainThread)</span> &#123;</div><div class="line">       <span class="keyword">switch</span> (subscription.subscriberMethod.threadMode) &#123;</div><div class="line">           <span class="keyword">case</span> POSTING:</div><div class="line">               invokeSubscriber(subscription, event);</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="keyword">case</span> MAIN:</div><div class="line">               <span class="keyword">if</span> (isMainThread) &#123;</div><div class="line">                   invokeSubscriber(subscription, event);</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   mainThreadPoster.enqueue(subscription, event);</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="keyword">case</span> BACKGROUND:</div><div class="line">               <span class="keyword">if</span> (isMainThread) &#123;</div><div class="line">                   backgroundPoster.enqueue(subscription, event);</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   invokeSubscriber(subscription, event);</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="keyword">case</span> ASYNC:</div><div class="line">               asyncPoster.enqueue(subscription, event);</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="keyword">default</span>:</div><div class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unknown thread mode: "</span> + subscription.subscriberMethod.threadMode);</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>switch对应4中不同的ThreadMode,默认的模式使用的是POSTING,就是post在哪个线程那么回调就在哪个线程中.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">invokeSubscriber</span><span class="params">(Subscription subscription, Object event)</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        subscription.subscriberMethod.method.invoke(subscription.subscriber, event);</div><div class="line">    &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</div><div class="line">        handleSubscriberException(subscription, event, e.getCause());</div><div class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unexpected exception"</span>, e);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><em>invokeSubscriber</em> 方法就是通过反射来回调绑定方法,结果非常简单.</p>
<p>如果是 <em>MAIN</em> 模式下,判断是否在主线程,如果在主线程直接调用,如果在子线程中,通过 <em>mainThreadPoster</em> 来回到主线程中.</p>
<p>来看 <em>mainThreadPoster</em> 的内部实现,实际上就是一个在主线程中的Handler.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mainThreadPoster = <span class="keyword">new</span> HandlerPoster(<span class="keyword">this</span>, Looper.getMainLooper(), <span class="number">10</span>);</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">HandlerPoster</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> PendingPostQueue queue;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> maxMillisInsideHandleMessage;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> EventBus eventBus;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> handlerActive;</div><div class="line"></div><div class="line">  HandlerPoster(EventBus eventBus, Looper looper, <span class="keyword">int</span> maxMillisInsideHandleMessage) &#123;</div><div class="line">      <span class="keyword">super</span>(looper);</div><div class="line">      <span class="keyword">this</span>.eventBus = eventBus;</div><div class="line">      <span class="keyword">this</span>.maxMillisInsideHandleMessage = maxMillisInsideHandleMessage;</div><div class="line">      queue = <span class="keyword">new</span> PendingPostQueue();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(Subscription subscription, Object event)</span> </span>&#123;</div><div class="line">      PendingPost pendingPost = PendingPost.obtainPendingPost(subscription, event);</div><div class="line">      <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">          queue.enqueue(pendingPost);</div><div class="line">          <span class="keyword">if</span> (!handlerActive) &#123;</div><div class="line">              handlerActive = <span class="keyword">true</span>;</div><div class="line">              <span class="keyword">if</span> (!sendMessage(obtainMessage())) &#123;</div><div class="line">                  <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"Could not send handler message"</span>);</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">      <span class="keyword">boolean</span> rescheduled = <span class="keyword">false</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">          <span class="keyword">long</span> started = SystemClock.uptimeMillis();</div><div class="line">          <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">              PendingPost pendingPost = queue.poll();</div><div class="line">              <span class="keyword">if</span> (pendingPost == <span class="keyword">null</span>) &#123;</div><div class="line">                  <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">                      <span class="comment">// Check again, this time in synchronized</span></div><div class="line">                      pendingPost = queue.poll();</div><div class="line">                      <span class="keyword">if</span> (pendingPost == <span class="keyword">null</span>) &#123;</div><div class="line">                          handlerActive = <span class="keyword">false</span>;</div><div class="line">                          <span class="keyword">return</span>;</div><div class="line">                      &#125;</div><div class="line">                  &#125;</div><div class="line">              &#125;</div><div class="line">              eventBus.invokeSubscriber(pendingPost);</div><div class="line">              <span class="keyword">long</span> timeInMethod = SystemClock.uptimeMillis() - started;</div><div class="line">              <span class="keyword">if</span> (timeInMethod &gt;= maxMillisInsideHandleMessage) &#123;</div><div class="line">                  <span class="keyword">if</span> (!sendMessage(obtainMessage())) &#123;</div><div class="line">                      <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"Could not send handler message"</span>);</div><div class="line">                  &#125;</div><div class="line">                  rescheduled = <span class="keyword">true</span>;</div><div class="line">                  <span class="keyword">return</span>;</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line">      &#125; <span class="keyword">finally</span> &#123;</div><div class="line">          handlerActive = rescheduled;</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>handler内部的handleMessage是一个死循环,每次通过enqueue方法来吧回调事件放入队列中,第一次的情况下发现handlerActive为否,说明没有启动,通过放一个空的message给handleMessage方法来启动死循环,如果已经启动了,handleMessage内部在不断的poll队列中的事件,依次执行回调方法,直到里面没有事件为止.同时在最底下还有个时间差判断,如果执行了十秒还没有执行完成的话,断开循环抛出异常,算是一个复位操作(个人理解)</p>
<p>再看ThreadMode的backGround模式,如果在主线程中,那么就交给backgroundPoster处理,如果在子线程中就直接处理了.来看backgroundPoster的逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">BackgroundPoster</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> PendingPostQueue queue;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> EventBus eventBus;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> executorRunning;</div><div class="line"></div><div class="line">  BackgroundPoster(EventBus eventBus) &#123;</div><div class="line">      <span class="keyword">this</span>.eventBus = eventBus;</div><div class="line">      queue = <span class="keyword">new</span> PendingPostQueue();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(Subscription subscription, Object event)</span> </span>&#123;</div><div class="line">      PendingPost pendingPost = PendingPost.obtainPendingPost(subscription, event);</div><div class="line">      <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">          queue.enqueue(pendingPost);</div><div class="line">          <span class="keyword">if</span> (!executorRunning) &#123;</div><div class="line">              executorRunning = <span class="keyword">true</span>;</div><div class="line">              eventBus.getExecutorService().execute(<span class="keyword">this</span>);</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">          <span class="keyword">try</span> &#123;</div><div class="line">              <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">                  PendingPost pendingPost = queue.poll(<span class="number">1000</span>);</div><div class="line">                  <span class="keyword">if</span> (pendingPost == <span class="keyword">null</span>) &#123;</div><div class="line">                      <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">                          <span class="comment">// Check again, this time in synchronized</span></div><div class="line">                          pendingPost = queue.poll();</div><div class="line">                          <span class="keyword">if</span> (pendingPost == <span class="keyword">null</span>) &#123;</div><div class="line">                              executorRunning = <span class="keyword">false</span>;</div><div class="line">                              <span class="keyword">return</span>;</div><div class="line">                          &#125;</div><div class="line">                      &#125;</div><div class="line">                  &#125;</div><div class="line">                  eventBus.invokeSubscriber(pendingPost);</div><div class="line">              &#125;</div><div class="line">          &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">              Log.w(<span class="string">"Event"</span>, Thread.currentThread().getName() + <span class="string">" was interruppted"</span>, e);</div><div class="line">          &#125;</div><div class="line">      &#125; <span class="keyword">finally</span> &#123;</div><div class="line">          executorRunning = <span class="keyword">false</span>;</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><em>BackgroundPoster</em> 就是一个简单的线程,当触发之后把自己交给EventBus的线程词来调用,自己的run方法内部维护一个死循环,不断从队列里面poll事件,直到没有为止,和上面的mainThreadPoster的做法类似.</p>
<p>最后是ThreadMode的ASYNC模式,直接交给 <em>asyncPoster</em> 来处理了,可以猜想应该也是一个线程只不过是每次触发都是一个新的线程,放入线程池中.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AsyncPoster</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> PendingPostQueue queue;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> EventBus eventBus;</div><div class="line"></div><div class="line">  AsyncPoster(EventBus eventBus) &#123;</div><div class="line">      <span class="keyword">this</span>.eventBus = eventBus;</div><div class="line">      queue = <span class="keyword">new</span> PendingPostQueue();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(Subscription subscription, Object event)</span> </span>&#123;</div><div class="line">      PendingPost pendingPost = PendingPost.obtainPendingPost(subscription, event);</div><div class="line">      queue.enqueue(pendingPost);</div><div class="line">      eventBus.getExecutorService().execute(<span class="keyword">this</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">      PendingPost pendingPost = queue.poll();</div><div class="line">      <span class="keyword">if</span>(pendingPost == <span class="keyword">null</span>) &#123;</div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No pending post available"</span>);</div><div class="line">      &#125;</div><div class="line">      eventBus.invokeSubscriber(pendingPost);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>代码非常简单,每次 <em>enqueue</em> 把自己交给线程池去调用.</p>
<p>最后就是注销绑定事件的unregister方法,也很简单,通过map的对应关系,把所有相关的事件移除就可以了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** Unregisters the given subscriber from all event classes. */</span></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">unregister</span><span class="params">(Object subscriber)</span> </span>&#123;</div><div class="line">     List&lt;Class&lt;?&gt;&gt; subscribedTypes = typesBySubscriber.get(subscriber);</div><div class="line">     <span class="keyword">if</span> (subscribedTypes != <span class="keyword">null</span>) &#123;</div><div class="line">         <span class="keyword">for</span> (Class&lt;?&gt; eventType : subscribedTypes) &#123;</div><div class="line">             unsubscribeByEventType(subscriber, eventType);</div><div class="line">         &#125;</div><div class="line">         typesBySubscriber.remove(subscriber);</div><div class="line">     &#125; <span class="keyword">else</span> &#123;</div><div class="line">         Log.w(TAG, <span class="string">"Subscriber to unregister was not registered before: "</span> + subscriber.getClass());</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>还剩余sticky事件的处理,下面重点讲一下<br>sticky事件讲的是当前事件在post的时候还没有相应的绑定事件,当register相应的event的时候就会触发,那么可以想象在register的时候肯定回去存放sticky时间短额地方去查找有没有对应的事件,然后post一下去回调响应.</p>
<p>首先看postSticky方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">   * Posts the given event to the event bus and holds on to the event (because it is sticky). The most recent sticky</div><div class="line">   * event of an event's type is kept in memory for future access by subscribers using &#123;<span class="doctag">@link</span> Subscribe#sticky()&#125;.</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postSticky</span><span class="params">(Object event)</span> </span>&#123;</div><div class="line">      <span class="keyword">synchronized</span> (stickyEvents) &#123;</div><div class="line">          stickyEvents.put(event.getClass(), event);</div><div class="line">      &#125;</div><div class="line">      <span class="comment">// Should be posted after it is putted, in case the subscriber wants to remove immediately</span></div><div class="line">      post(event);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>先放入 <em>stickEvents</em> 容器,尝试post一下<br>然后在register的subscribe方法中,遍历stickEvents容器,如果找到了对应的event就post一下.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Must be called in synchronized block</span></div><div class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(Object subscriber, SubscriberMethod subscriberMethod)</span> </span>&#123;</div><div class="line"></div><div class="line">    ...</div><div class="line"></div><div class="line">     <span class="keyword">if</span> (subscriberMethod.sticky) &#123;</div><div class="line">         <span class="keyword">if</span> (eventInheritance) &#123;</div><div class="line">             <span class="comment">// Existing sticky events of all subclasses of eventType have to be considered.</span></div><div class="line">             <span class="comment">// Note: Iterating over all events may be inefficient with lots of sticky events,</span></div><div class="line">             <span class="comment">// thus data structure should be changed to allow a more efficient lookup</span></div><div class="line">             <span class="comment">// (e.g. an additional map storing sub classes of super classes: Class -&gt; List&lt;Class&gt;).</span></div><div class="line">             Set&lt;Map.Entry&lt;Class&lt;?&gt;, Object&gt;&gt; entries = stickyEvents.entrySet();</div><div class="line">             <span class="keyword">for</span> (Map.Entry&lt;Class&lt;?&gt;, Object&gt; entry : entries) &#123;</div><div class="line">                 Class&lt;?&gt; candidateEventType = entry.getKey();</div><div class="line">                 <span class="keyword">if</span> (eventType.isAssignableFrom(candidateEventType)) &#123;</div><div class="line">                     Object stickyEvent = entry.getValue();</div><div class="line">                     checkPostStickyEventToSubscription(newSubscription, stickyEvent);</div><div class="line">                 &#125;</div><div class="line">             &#125;</div><div class="line">         &#125; <span class="keyword">else</span> &#123;</div><div class="line">             Object stickyEvent = stickyEvents.get(eventType);</div><div class="line">             checkPostStickyEventToSubscription(newSubscription, stickyEvent);</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>然后看checkPostStickyEventToSubscription方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkPostStickyEventToSubscription</span><span class="params">(Subscription newSubscription, Object stickyEvent)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (stickyEvent != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// If the subscriber is trying to abort the event, it will fail (event is not tracked in posting state)</span></div><div class="line">        <span class="comment">// --&gt; Strange corner case, which we don't take care of here.</span></div><div class="line">        postToSubscription(newSubscription, stickyEvent, Looper.getMainLooper() == Looper.myLooper());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果找到了对应的sticky事件就post到回调方法,非常清晰.</p>
<h3 id="内部集合PendingPostQueue分析"><a href="#内部集合PendingPostQueue分析" class="headerlink" title="内部集合PendingPostQueue分析"></a>内部集合PendingPostQueue分析</h3><p>这里 <em>PendingPostQueue</em> 是一个双端链表的简单实现,链表的好处在于插入和删除的效率要比数组更高,遍历是慢于数组的,这里运用场景就是不断的从里面取最后一个event事件,那么用链表是非常合适的.</p>
<p>##总结<br>EventBus这个库,通过读源码学到了很多东西,其内部构成就是一个简单观察者模式的实现,但是需要明白java的反射原理,多线程处理,以及各种线程同步的知识,受益匪浅.<br>内部代码量也不是很多,核心代码仅仅不到千行却实现了这么小巧方便的代码库,非常高端.</p>
</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://pheobusyy.github.io/2016/11/28/2016/android instant run原理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanyi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pheobusyy">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/28/2016/android instant run原理/" itemprop="url">
                  android Instant Run原理
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-11-28T20:10:00+08:00">
                2016-11-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>  起因：在android6.0的手机上，app第一次安装的时候启动特别的慢，会黑屏很长时间，开始是以为在application中干的事情太多了，可能还有写耗时的操作影响了启动时长，在最底层的application的onCreate方法加了一句log，然后重新安装，发现log居然很久之后才打印出来，那么排除了是application里面的操作影响，后来上网搜索了一下，说是Instant Run造成的，故特意查找了些资料，研究了其内部原理</p>
<h3 id="Instant-Run-官方说明"><a href="#Instant-Run-官方说明" class="headerlink" title="Instant Run 官方说明"></a>Instant Run 官方说明</h3><blockquote>
<p> 使用Instant Run，您无需构建新的apk，就可以将更改<em>推送</em>至方法，将现有应用资源<em>推送</em>至正在运行的应用，所以几乎立刻就能看到代码的更改。</p>
</blockquote>
<p>这里说明了instant的两个特性，一个是不用生成新的apk几乎立刻就可以看到代码的更改，另一个说是<em>推送</em>至设备。后面会详细说明。</p>
<h3 id="传统的代码修改及编译部署流程"><a href="#传统的代码修改及编译部署流程" class="headerlink" title="传统的代码修改及编译部署流程"></a>传统的代码修改及编译部署流程</h3><p><img src="/images/2016/11/1.png" alt="andorid 部署流程"></p>
<p>构建整个apk-&gt;部署app-&gt;app重启-&gt;重启activity<br>而Instant Run会用更少的时间</p>
<h3 id="Instant-Run编译与部署流程"><a href="#Instant-Run编译与部署流程" class="headerlink" title="Instant Run编译与部署流程"></a>Instant Run编译与部署流程</h3><p><img src="images/2016/11/2.png" alt="Instant Run部署流程"><br>只构建修改的部分-&gt;部署修改的dev或资源-&gt;热部署，温部署，冷部署</p>
<table>
<thead>
<tr>
<th>代码更改</th>
<th>Instant Run行为</th>
</tr>
</thead>
<tbody>
<tr>
<td>更改现有方法的代码实现</td>
<td>通过热交换支持：这是最快的交换类型，使更改能够更快的显示。您的应用保持运行，下次调用存根方法时会使用具有新实现的存根方法</td>
</tr>
<tr>
<td>更改或移除现有资源</td>
<td>通过温交换支持：这种交换速度也非常快，但Instant Run在将更改的资源推送至您的应用时必须重新启动当前的行为。您的应用保持运行，只是会出现小的提示，这是正常情况</td>
</tr>
<tr>
<td>结构行代码更改，例如：添加移除或更改 注释，实例字段，静态字段，静态方法签名，实例方法签名，更改当前类从其继承的父类，更改实现的界面列表，更改类的静态初始值设定项，对使用动态资源ID的布局元素重新排序</td>
<td>通过冷交换支持，这种交换速度有点慢，因为尽管不需要新的apk，Instant Run在推送结构性代码更改的时候必须重启整个应用</td>
</tr>
<tr>
<td>更改应用manifast，更改应用引用的资源，更改andorid的widget</td>
<td>android studio会重新部署，生成新的apk，这是因为manifast等文件是安装在设备中的，无法通过更新的方式修改</td>
</tr>
</tbody>
</table>
<h3 id="Instant-Run原理"><a href="#Instant-Run原理" class="headerlink" title="Instant Run原理"></a>Instant Run原理</h3><p>  我们知道app的入口在application中，在manifast中的applcationID就是app的唯一标示，也是程序的入口，如果反编译通过运行Instant Run生成的apk会发现里面的构成是这样的</p>
<p><img src="images/2016/11/3.PNG" alt="  Instant Run apk构成"></p>
<p>着重看里面的两个dex和instant-run.zip文件。首先看一下两个dex的源码：<br><img src="images/2016/11/5.PNG" alt=""></p>
<p>可以看到里面就是简单的app的信息，包括application的class和包名<br>再看第二个dex</p>
<p><img src="/images/2016/11/6.PNG" alt=""></p>
<p>里面是一堆class文件，不过没有一个是我们的自己的，那可以猜出来我们自己的代码放在了instant-run.zip文件中，解压之后如下图</p>
<p><img src="/images/2016/11/7.PNG" alt=""></p>
<p>真正的代码在这里了。</p>
<p>同时反编译解码manifast之后，会发现我们的applcationId被替换成instant run的application BootstrapApplication，那么我们可以猜出instant-run代码作为一个宿主程序，将app作为资源加载起来，和插件话一个思路，那么instant run是怎么把代码运行起来的呢？</p>
<h3 id="对原始代码的处理"><a href="#对原始代码的处理" class="headerlink" title="对原始代码的处理"></a>对原始代码的处理</h3><p>  在第一次构建apk的时候，在每一个类中通过asm修改class文件注入一个$change成员变量，同时在每个方法的顶部增加如下代码<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">IncrementalChange localIncrementalChange = $change;</div><div class="line">      <span class="keyword">if</span> (localIncrementalChange != <span class="keyword">null</span>) &#123;</div><div class="line">          localIncrementalChange.access$dispatch(</div><div class="line">                  <span class="string">"onCreate.(Landroid/os/Bundle;)V"</span>, <span class="keyword">new</span> Object[] &#123; <span class="keyword">this</span>,</div><div class="line">                          ... &#125;);</div><div class="line">          <span class="keyword">return</span>;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>  每个方法的都有哦，可以理解如果发生变化，那么原始方法就会调用$change中对应的方法，来达到替换方法的目的<br>  后续运行的时候，dx补丁类，生成补丁dex，其中被修改类的补丁类是在类原名后面增加$override复制修改类的大部分代码，然后把原始类的$change赋值，这样就可以在调用原始类方法的时候调用补丁类中的对应方法了。</p>
<h3 id="application的启动"><a href="#application的启动" class="headerlink" title="application的启动"></a>application的启动</h3><p>  首先程序的入口是BootstrapApplication，通过它来加载classLoader，而classLoader负责加载dex文件，那么如何才能把我们补丁的dex加载到程序中呢？<br>  Instant run是通过在程序classLoader的树状结构中插入补丁dex来解决问题，如下图</p>
<p><img src="images/2016/11/classloader.png" alt="  "><br>这里有个概念叫双亲委派模式，是一个典型的应用场景，首先是子类如果要加载dex的时候会通过父类去查找，如果父类没有找到，就会去父类的父类去查找，如果一直没有找到就会在子类中加载，并缓存之，instant run就是给pathClassLoader中插入了一个中间父类loader叫IncrementalClassLoader,这样就解决了类加载的问题。</p>
<p>在BootstrapApplication中先初始化各种loader然后通过反射调用源程序的applcation方法，同时修改<br>1.替换ActivityThread的mInitialApplication为realApplication  </p>
<p>2.替换mAllApplications 中所有的Application为realApplication  </p>
<p>3.替换ActivityThread的mPackages,mResourcePackages中的mLoaderApk中的application为realApplication。  </p>
<p>这样就解决了类加载的问题。热插件的原理也是通过这个来实现</p>
<h3 id="如何修改资源"><a href="#如何修改资源" class="headerlink" title="如何修改资源"></a>如何修改资源</h3><p>如果resource.ap_文件有改变，那么新建一个AssetManager对象newAssetManager，然后用newAssetManager对象替换所有当前Resource、Resource.Theme的mAssets成员变量。 2.如果当前的已经有Activity启动了，还需要替换所有Activity中mAssets成员变量</p>
<h3 id="如何把更新载入程序"><a href="#如何把更新载入程序" class="headerlink" title="如何把更新载入程序"></a>如何把更新载入程序</h3><p>instant run会额外加载一个server，server在不断的监听来发现有补丁更新，通过socket传递给app，然后server来完成热更新，冷更新和温更新，最后重启</p>
<p>1.如果后缀为“.dex”,冷部署处理handleColdSwapPatch<br>2.如果后缀为“classes.dex.3”,热部署处理handleHotSwapPatch<br>3.其他情况,温部署，处理资源handleResourcePatch  </p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://pheobusyy.github.io/2016/11/16/2016/java和android中遇到的问题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanyi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pheobusyy">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/16/2016/java和android中遇到的问题/" itemprop="url">
                  java和android中遇到的问题
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-11-16T14:32:00+08:00">
                2016-11-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="java获取当前的方法名和类名"><a href="#java获取当前的方法名和类名" class="headerlink" title="java获取当前的方法名和类名"></a>java获取当前的方法名和类名</h2><p>原来真的可以，以前太想当然了，居然光是想着得整体反射才能获取到，没想到在方法内部就可以，遇到问题不能凭感觉，要求证之后再下结论，永远保持怀疑的态度</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Thread.currentThread().getStackTrace()[<span class="number">1</span>].getClassName();</div><div class="line">Thread.currentThread().getStackTrace()[<span class="number">1</span>].getMethodName();</div></pre></td></tr></table></figure>
<h2 id="gson-parse转换带有非法字符的字符串时报错"><a href="#gson-parse转换带有非法字符的字符串时报错" class="headerlink" title="gson parse转换带有非法字符的字符串时报错"></a>gson parse转换带有非法字符的字符串时报错</h2><p>   今天遇到一个问题，服务器返回的HashKey中是通过base64生成的字符串，里面有个“=”，这个时候通过gson parse的时候就会报MalformedJsonException异常<br>   ，后来通过gson的toJson方法来解决，也就是用gson再转一次，这样就会把里面的“=”转化为16进制的字符串了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">toJson</span><span class="params">(Map&lt;String, String&gt; paramMap)</span> </span>&#123;</div><div class="line">        <span class="comment">//所有的参数最终都要拼接成一个JsonObject对象，然后通过一个叫param的参数发送到服务器</span></div><div class="line">        JsonObject jsonObject = <span class="keyword">new</span> JsonObject();</div><div class="line">        <span class="keyword">if</span> (paramMap != <span class="keyword">null</span> &amp;&amp; !paramMap.isEmpty()) &#123;</div><div class="line">            <span class="keyword">for</span> (String key : paramMap.keySet()) &#123;</div><div class="line">                String value = paramMap.get(key);</div><div class="line">                <span class="keyword">if</span> (TextUtils.isEmpty(key) || TextUtils.isEmpty(value)) &#123;</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">//通过jsonParser可以解决java的\“转义的问题</span></div><div class="line">                <span class="comment">//如果文本中带空格的，请使用整个对象转json的方式</span></div><div class="line">                JsonParser parser = <span class="keyword">new</span> JsonParser();</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    JsonElement jsonElement = parser.parse(value);</div><div class="line">                    jsonObject.add(key, jsonElement);</div><div class="line">                &#125; <span class="keyword">catch</span> (JsonSyntaxException e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                    <span class="comment">//如果字符串不符合格式，gson会报MalformedJsonException异常，比如字符串中包含等号，&lt;,&gt;等特殊符号，不能直接转换</span></div><div class="line">                    <span class="comment">//目前在简报的服务器返回HashKey中发现有等号的清空下无法解析，故在这里增加了处理</span></div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        value = GsonUtils.ObjectToJson(value);</div><div class="line">                        JsonElement jsonElement = parser.parse(value);</div><div class="line">                        jsonObject.add(key, jsonElement);</div><div class="line">                    &#125; <span class="keyword">catch</span> (JsonSyntaxException e1) &#123;</div><div class="line">                        e1.printStackTrace();</div><div class="line">                        <span class="comment">//如果再次转换还是失败的话，使用JsonReader的宽容模式</span></div><div class="line">                        <span class="keyword">try</span> &#123;</div><div class="line">                            JsonReader jsonReader = <span class="keyword">new</span> JsonReader(<span class="keyword">new</span> StringReader(value));</div><div class="line">                            jsonReader.setLenient(<span class="keyword">true</span>);</div><div class="line">                            JsonElement jsonElement = parser.parse(jsonReader);</div><div class="line">                            jsonObject.add(key, jsonElement);</div><div class="line">                        &#125; <span class="keyword">catch</span> (Exception e2) &#123;</div><div class="line">                            e2.printStackTrace();</div><div class="line">                            NetLogger.log(<span class="string">"HttpUtil toJson meet error param ,the param is "</span> + value + <span class="string">",please check the value is correct!!!"</span>);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        NetLogger.log(<span class="string">"toJson ="</span> + jsonObject.toString());</div><div class="line">        <span class="keyword">return</span> jsonObject.toString();</div><div class="line">      &#125;</div></pre></td></tr></table></figure>
<h2 id="关于java中BigInteger的原理分析"><a href="#关于java中BigInteger的原理分析" class="headerlink" title="关于java中BigInteger的原理分析"></a>关于java中BigInteger的原理分析</h2><p>  通过内部的数组来分段存放数字集合，最后再拼成一个整体返回<br>  <a href="http://www.hollischuang.com/archives/176" title="BigInteger原理" target="_blank" rel="external">BigInteger原理</a></p>
<h2 id="为什么在android的api中有些方法明明是public的-但是在外部调用的时候就是编译错误-显示为不可以使用的状态"><a href="#为什么在android的api中有些方法明明是public的-但是在外部调用的时候就是编译错误-显示为不可以使用的状态" class="headerlink" title="为什么在android的api中有些方法明明是public的,但是在外部调用的时候就是编译错误,显示为不可以使用的状态?"></a>为什么在android的api中有些方法明明是public的,但是在外部调用的时候就是编译错误,显示为不可以使用的状态?</h2><p>  原因是在方法或者field的注释中有一个 <em>@hide</em> 的注解,这个注解的作用就是告诉javaDoc,凡是带了这个注解的方法或者field都会把javaDoc忽略,也就是说对外是看不到这个方法.但是在内部是可以使用的.有点像android的internal包,只能手机本身调用,外部是无法直接调用的.这样做的目的是比如有些方法还不是很稳定,就先把它标记为对外暂时不可用,等后期稳定了之后再打开.</p>
<p>  不过通过java的发射是可以调用这些带有 <em>@hide</em> 的方法和filed的.</p>
<p><a href="http://stackoverflow.com/questions/17035271/what-does-hide-mean-in-the-android-source-code" title="What does @hide mean in the Android source code?" target="_blank" rel="external">What does @hide mean in the Android source code?</a></p>
<h2 id="EventBus在子线程中post事件遇到的问题"><a href="#EventBus在子线程中post事件遇到的问题" class="headerlink" title="EventBus在子线程中post事件遇到的问题"></a>EventBus在子线程中post事件遇到的问题</h2><p>  之前遇到一个问题,就是EventBus在post事件的时候如果是在子线程中,同时回到事件更新UI了,就会导致网络请求的数据没有了,不知道为什么.今天看了源码明白了其中的缘由.<br>  源码,在EventBus中,当你没有指定事件回调的ThreadMode的话,回调事件就会在post所在线程中执行了,那如果你在子线程中post事件,在主线程中的回调事件没有修改ThreadMode话回调事件就会在子线程中运行,这个时候如果更新UI,就会报异常,但是由于EventBus把异常给catch到了,所以页面没有什么异常反应.看着就好像没啥变化一样.<br>  然后再说为啥请求就没有数据了呢,是因为有个同事把post事件放在网络请求的回调来发送的,但是网络请求的回调默认不是在主线程中处理的,所以就会导致post的事件是在子线程中发送的,然后就会报异常就是不能在子线程中更新UI.这个时候,activity的UI是就不会响应UI更新了.</p>
<h2 id="android的子线程中真的不能更新UI吗"><a href="#android的子线程中真的不能更新UI吗" class="headerlink" title="android的子线程中真的不能更新UI吗?"></a>android的子线程中真的不能更新UI吗?</h2><p>  如果在Activity的onCreate方法中直接new子线程然后在里面更新UI是不会报错的.原因是检查线程是否是子线程的方法在onCreate的时候还没有调用呢.<br><a href="http://www.cnblogs.com/xuyinhuan/p/5930287.html" title="Android中子线程真的不能更新UI吗？" target="_blank" rel="external">  Android中子线程真的不能更新UI吗？</a></p>
<h2 id="在生成android-AIDL的过程中老是提示失败"><a href="#在生成android-AIDL的过程中老是提示失败" class="headerlink" title="在生成android AIDL的过程中老是提示失败"></a>在生成android AIDL的过程中老是提示失败</h2><p>  通过网上的教程尝试通过AIDL传递复杂对象,比如一个序列化对象Book,然后把Book.java,Book.aidl,TestAidlInterface.aidl 这三个文件放在同一个包中,老是无法通过编译,没有生成响应的java文件.后来鼓捣了半天,发现把 Book.java 文件放在其他的java目录中就可以了.也就是说aidl文件放在专用的aidl包中,java类放在普通的java包中.猜测可能是新版的android studio做了调整.</p>
<h2 id="在android-5-0及以上的版本中直接通过intent调用startService-bindService-stopService等方法的时候报错-java-lang-IllegalArgumentException-Service-Intent-must-be-explicit-Intent-act-XXXXXXXX-flg-0x10000000"><a href="#在android-5-0及以上的版本中直接通过intent调用startService-bindService-stopService等方法的时候报错-java-lang-IllegalArgumentException-Service-Intent-must-be-explicit-Intent-act-XXXXXXXX-flg-0x10000000" class="headerlink" title="在android 5.0及以上的版本中直接通过intent调用startService,bindService,stopService等方法的时候报错 java.lang.IllegalArgumentException: Service Intent must be explicit: Intent { act=XXXXXXXX flg=0x10000000 }"></a>在android 5.0及以上的版本中直接通过intent调用startService,bindService,stopService等方法的时候报错 <em>java.lang.IllegalArgumentException: Service Intent must be explicit: Intent { act=XXXXXXXX flg=0x10000000 }</em></h2><p>  这是因为在5.0的android源码中增加了对intent的package的限制.下面来看bindService的直接调用方 <em>ContextImpl</em> 中的 <em>bindService</em> 方法:<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">bindService</span><span class="params">(Intent service, ServiceConnection conn,</span></span></div><div class="line">         <span class="keyword">int</span> flags) &#123;</div><div class="line">     warnIfCallingFromSystemProcess();</div><div class="line">     <span class="keyword">return</span> bindServiceCommon(service, conn, flags, mMainThread.getHandler(),</div><div class="line">             Process.myUserHandle());</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">bindServiceCommon</span><span class="params">(Intent service, ServiceConnection conn, <span class="keyword">int</span> flags, Handler</span></span></div><div class="line">           handler, UserHandle user) &#123;</div><div class="line">       IServiceConnection sd;</div><div class="line">       <span class="keyword">if</span> (conn == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"connection is null"</span>);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (mPackageInfo != <span class="keyword">null</span>) &#123;</div><div class="line">           sd = mPackageInfo.getServiceDispatcher(conn, getOuterContext(), handler, flags);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Not supported in system context"</span>);</div><div class="line">       &#125;</div><div class="line">       validateServiceIntent(service);</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           IBinder token = getActivityToken();</div><div class="line">           <span class="keyword">if</span> (token == <span class="keyword">null</span> &amp;&amp; (flags&amp;BIND_AUTO_CREATE) == <span class="number">0</span> &amp;&amp; mPackageInfo != <span class="keyword">null</span></div><div class="line">                   &amp;&amp; mPackageInfo.getApplicationInfo().targetSdkVersion</div><div class="line">                   &lt; android.os.Build.VERSION_CODES.ICE_CREAM_SANDWICH) &#123;</div><div class="line">               flags |= BIND_WAIVE_PRIORITY;</div><div class="line">           &#125;</div><div class="line">           service.prepareToLeaveProcess(<span class="keyword">this</span>);</div><div class="line">           <span class="keyword">int</span> res = ActivityManagerNative.getDefault().bindService(</div><div class="line">               mMainThread.getApplicationThread(), getActivityToken(), service,</div><div class="line">               service.resolveTypeIfNeeded(getContentResolver()),</div><div class="line">               sd, flags, getOpPackageName(), user.getIdentifier());</div><div class="line">           <span class="keyword">if</span> (res &lt; <span class="number">0</span>) &#123;</div><div class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(</div><div class="line">                       <span class="string">"Not allowed to bind to service "</span> + service);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">return</span> res != <span class="number">0</span>;</div><div class="line">       &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">           <span class="keyword">throw</span> e.rethrowFromSystemServer();</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>  注意上面方法中的 <em>validateServiceIntent</em> 方法,这个就是上面报错的原因所在了.<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">validateServiceIntent</span><span class="params">(Intent service)</span> </span>&#123;</div><div class="line">     <span class="keyword">if</span> (service.getComponent() == <span class="keyword">null</span> &amp;&amp; service.getPackage() == <span class="keyword">null</span>) &#123;</div><div class="line">         <span class="keyword">if</span> (getApplicationInfo().targetSdkVersion &gt;= Build.VERSION_CODES.LOLLIPOP) &#123;</div><div class="line">             IllegalArgumentException ex = <span class="keyword">new</span> IllegalArgumentException(</div><div class="line">                     <span class="string">"Service Intent must be explicit: "</span> + service);</div><div class="line">             <span class="keyword">throw</span> ex;</div><div class="line">         &#125; <span class="keyword">else</span> &#123;</div><div class="line">             Log.w(TAG, <span class="string">"Implicit intents with startService are not safe: "</span> + service</div><div class="line">                     + <span class="string">" "</span> + Debug.getCallers(<span class="number">2</span>, <span class="number">3</span>));</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>  可以看到,这里对intent内部的package属性做了判断,如果大于APIlevel21并且package为空的话就会抛出上面提到的异常.<br>  解决方法很简单,在intent初始化的时候设置一下package就可以了.<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Intent intent = <span class="keyword">new</span> Intent(action);</div><div class="line">intent.setPackage(getPackageName());</div><div class="line">bindService(intent);</div></pre></td></tr></table></figure></p>
<blockquote>
<p>注意:如果在使用AIDL时,这里传入的package应该是服务端对应的包名,也就是你想让谁来处理这个intent,这里的package就传谁的.<br>注意:这里getPackageName这个方法返回的是application的包名,也就是apk的包名,不要和java反射的获取包名方法混淆了,java的获取包名是通过class.getPackage().getName() 来获取的.</p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://pheobusyy.github.io/2016/11/09/2016/git 技巧/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanyi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pheobusyy">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/09/2016/git 技巧/" itemprop="url">
                  git 技巧
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-11-09T14:08:00+08:00">
                2016-11-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="如何把已经加入暂存区的文件移除"><a href="#如何把已经加入暂存区的文件移除" class="headerlink" title="如何把已经加入暂存区的文件移除"></a>如何把已经加入暂存区的文件移除</h2><p>git reset <file name=""><br>如果要移除暂存区全部文件使用<br>git reset</file></p>
<h2 id="如何把其它分支的提交合并到当前分支"><a href="#如何把其它分支的提交合并到当前分支" class="headerlink" title="如何把其它分支的提交合并到当前分支"></a>如何把其它分支的提交合并到当前分支</h2><p>git cherry_pick commitId 就可以了，然后push到远程分支</p>
<h3 id="基于某个tag来创建分支"><a href="#基于某个tag来创建分支" class="headerlink" title="基于某个tag来创建分支"></a>基于某个tag来创建分支</h3><p>git checkout -b 分支名称 tag名称 就可以了</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://pheobusyy.github.io/2016/11/05/2016/Programming Principles 翻译/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanyi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pheobusyy">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/05/2016/Programming Principles 翻译/" itemprop="url">
                  Programming Principles 翻译
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-11-05T18:11:00+08:00">
                2016-11-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="编程规则"><a href="#编程规则" class="headerlink" title="编程规则"></a>编程规则</h2><h3 id="通用的"><a href="#通用的" class="headerlink" title="通用的"></a>通用的</h3><h4 id="KISS-keep-It-Simple-Stupid"><a href="#KISS-keep-It-Simple-Stupid" class="headerlink" title="KISS(keep It Simple Stupid)"></a>KISS(keep It Simple Stupid)</h4><p>大部分保持简单的系统要比复杂的系统运行的更好</p>
<p>为什么呢？</p>
<ul>
<li>更少的代码消耗更少的时间，有更少的bug，并且更容易修改</li>
<li>大道至简（Simplicity is the ultimate sophistication）</li>
<li>最完美的不是没有什么可以增加的，而是没有什么是可以删减的，也就是最终的精简</li>
</ul>
<h4 id="YAGNI"><a href="#YAGNI" class="headerlink" title="YAGNI"></a>YAGNI</h4><p>YAGNI是“你不会需要他的：不要实现它除非你确实需要它”</p>
<p>为什么呢？</p>
<ul>
<li>任何在未来才可能用到的功能，意味着会浪费当前迭代的精力</li>
<li>它会导致代码臃肿（bloat），使软件更加的庞杂</li>
</ul>
<p>如何做？</p>
<ul>
<li>永远去实现你确实需要的事物，永远不要去实现你只是预见到未来才能用到的事物</li>
</ul>
<h4 id="仅仅做可以运行的最简单的事物"><a href="#仅仅做可以运行的最简单的事物" class="headerlink" title="仅仅做可以运行的最简单的事物"></a>仅仅做可以运行的最简单的事物</h4><p>为什么呢？<br>如果我们作用于问题的真正所在，就可以最大化的解决问题</p>
<p>如何做呢？<br>问问你自己“什么才是可以使它起作用的最简单的方式”</p>
<h4 id="关注隔离"><a href="#关注隔离" class="headerlink" title="关注隔离"></a>关注隔离</h4><p>关注隔离是一种把程序分离成清晰的层次的设计原则，致使每一层关注不同的位置。比如业务逻辑是一种关注方向，而UI又是另一个方向的关注<br>调整UI不应该影响业务逻辑，同理反之。</p>
<p>‘’’<br>引用自  Edsger W. Dijkstra（1974）：<br>  我所说的“关注隔离”是唯一的一种可以使思维想法有序的技术，虽然不一定完美，这是一种“使你聚焦于某些方面”：这并不是说忽略其它的方面，而只是说在正确的关注点上<br>  工作，其它方面都是不可见的。<br>‘’’<br>为什么呢？</p>
<ul>
<li>更容易的开发和维护系统应用</li>
<li>如果分层合理，那么每一个独立的层都可以被复用，开发和升级</li>
</ul>
<p>如何做？</p>
<ul>
<li>尽可能的分解系统为不同的独立模块</li>
</ul>
<h4 id="保证事物DRY（dont-repeat-yourself）"><a href="#保证事物DRY（dont-repeat-yourself）" class="headerlink" title="保证事物DRY（dont repeat yourself）"></a>保证事物DRY（dont repeat yourself）</h4><p>在程序中每一个元素都必须保证唯一性，无歧义，独一代表性</p>
<p>每个定义在源代码中应该只有一份实现。如果同样的功能实现出现在不同的地方，最好是把他们合并成一个公共的的抽象</p>
<p>为什么呢？</p>
<ul>
<li>重复（不管是有意无意）都会导致维护困难，未知的因素和逻辑混乱</li>
<li>单一元素的调整不应该引起不想关逻辑调整</li>
<li>通常逻辑相关的改动应该是可预测和均匀的，并且保持同步</li>
</ul>
<p>如何做？</p>
<ul>
<li>把业务逻辑，表达式，if表达式，数学运算等应该只出现在一个地方</li>
<li>在程序中找出某一功能点的单一明确的定义,然后通过该定义来生成可以用的实例</li>
<li>rule of three</li>
</ul>
<h4 id="为修改人员编写代码"><a href="#为修改人员编写代码" class="headerlink" title="为修改人员编写代码"></a>为修改人员编写代码</h4><p>为什么呢?</p>
<ul>
<li>对任何工程而言维护都是需要花费很多代价的</li>
</ul>
<p>如何做?</p>
<ul>
<li>做一个维护者</li>
<li>在编写代码的时候想想修改你代码的是一个有严重暴力倾向的精神病患者,并且他还知道你住在哪里</li>
<li>在编写代码和提交的时候想想菜鸟会非常乐意从你的代码中学习</li>
<li>不要使我思考</li>
<li>使用最小惊讶原则</li>
</ul>
<h4 id="避免过早优化"><a href="#避免过早优化" class="headerlink" title="避免过早优化"></a>避免过早优化</h4><p>摘自 Donald Knuth:</p>
<blockquote>
<p>程序员浪费大量的精力在思考或者担心程序中非紧急模块的效率,并且被认为包含消极冲突<br>我们应该忘记小小的效率提升,大约百分之97的概率:过早优化是万恶之源</p>
</blockquote>
<p>明白什么是”过早”,和不是”过早”是问题的核心</p>
<p>为什么呢?</p>
<ul>
<li>你预先不知道到底问题的瓶颈在哪里</li>
<li>优化过后,代码变得难以阅读和修改<br>如何做?</li>
<li>是它工作快而正确</li>
<li>不要优化知道你确实并且知道瓶颈所在</li>
</ul>
<h4 id="最小化耦合"><a href="#最小化耦合" class="headerlink" title="最小化耦合"></a>最小化耦合</h4><p>耦合是指功能和模块之间等层级相互依赖;低耦合是好的,换句话说,耦合是指单元B有可能会停止是由在单元A中有未知的改动而造成的.</p>
<p>为什么呢?</p>
<ul>
<li>对一个模块的某处修改一般会引起其他的模块的连锁反应</li>
<li>组装模块需要更多的精力和时间由于内部模块之间的依赖</li>
<li>模块会变得特别难以复用和测试由于依赖模块也必须被引入</li>
<li>开发人员可能会很恐惧修改代码因为他们也不确定会引起其他问题</li>
</ul>
<h3 id="迪米特法则"><a href="#迪米特法则" class="headerlink" title="迪米特法则"></a>迪米特法则</h3><p>不要和陌生人说话</p>
<p>为什么呢?</p>
<ul>
<li>这样经常会导致紧密的耦合</li>
<li>这样会暴露更多的实现细节</li>
</ul>
<p>如何做?<br>对象中的方法只应该调用的方法有:</p>
<ul>
<li>对象本身</li>
<li>方法中的参数</li>
<li>方法中创建的对象</li>
<li>对象中的成员变量和属性</li>
</ul>
<h3 id="组合优于继承"><a href="#组合优于继承" class="headerlink" title="组合优于继承"></a>组合优于继承</h3><p>为什么呢?</p>
<ul>
<li>类之间的耦合更少</li>
<li>使用继承,子类容易造成猜测,违背里氏替换原则</li>
</ul>
<p>如何做?</p>
<ul>
<li>测试能否符合里氏替换来决定使用继承</li>
<li>当二者关系是 “has a “ 或 “use a” 时使用组合,当二者关系是 “is a” 时使用继承</li>
</ul>
<h3 id="正交性"><a href="#正交性" class="headerlink" title="正交性"></a>正交性</h3><p>正交性的核心思想是两个无关的概念不应该在系统中相互关联</p>
<h3 id="健壮性原则"><a href="#健壮性原则" class="headerlink" title="健壮性原则"></a>健壮性原则</h3><p>对你所做的持有保守态度,对接受到别人的东西保持宽容态度.<br>合作服务以来与相互之间的接口,通常情况下接口会以进化到不确定的数据为结尾.一个幼稚的实现一般是拒绝合作如果收到一个不太严格的数据格式.而老练的接口通常情况下会忽略它无法识别的数据继续执行.</p>
<p>为什么呢?</p>
<ul>
<li>为了可以升级服务你需要确认提供者可以做出调整来支持各种需求特别是在对现有客户端引起最小调整的情况下.</li>
</ul>
<p>如何做呢?<br>发送给其他系统的代码应该转换为明确的格式,但是从别的地方接收到的数据应该代码应该同时也可以接受含义不太明确的数据</p>
<h3 id="高内聚"><a href="#高内聚" class="headerlink" title="高内聚"></a>高内聚</h3><p>模块的内聚指的是指他们的职责是一个有意义的集合.越高内聚越好.</p>
<p>如果不这样会怎么样?</p>
<ul>
<li>增加模块间的理解难度</li>
<li>增加修改难度,因为修改当前领域的逻辑会导致其他模块的变化.</li>
<li>影响组件模块的复用性</li>
</ul>
<p>如何做呢?<br>组件相关的功能应该共享一个单一职责</p>
<h3 id="LSP里氏替换原则"><a href="#LSP里氏替换原则" class="headerlink" title="LSP里氏替换原则"></a>LSP里氏替换原则</h3><p>LSP期望的对象行为是:<br>程序中的对象转换为子类对象之后是无需做任何调整的,也就是子类可以完美替换父类</p>
<h3 id="开闭原则"><a href="#开闭原则" class="headerlink" title="开闭原则"></a>开闭原则</h3><p>软件中的实例应该对修改关闭,对扩展开放.当然在不修改源代码的基础上的修改是可以的</p>
<p>为什么呢?<br>通过对现有代码的最小改动来保证可维护性和稳定性</p>
<p>如何做呢?</p>
<ul>
<li>书写可以扩展的实体(相反的是可以被修改的类)</li>
<li>只是扩展需要调整的地方,其他的地方隐藏<h3 id="单一职责原则"><a href="#单一职责原则" class="headerlink" title="单一职责原则"></a>单一职责原则</h3>一个只应该有一个修改的原因</li>
</ul>
<p>为什么呢?<br>修改只应该对于必要的类或者类</p>
<p>如何做?<br>遵守 Curly’s Law.</p>
<h3 id="隐藏实现细节"><a href="#隐藏实现细节" class="headerlink" title="隐藏实现细节"></a>隐藏实现细节</h3><p>软件应该隐藏接口的实现细节,不要暴露不必要的实现细节</p>
<p>为什么呢?<br>当实现细节调整后,实现接口的客户端不应该做调整</p>
<p>如何做?</p>
<ul>
<li>最小化类和成员的可访问性</li>
<li>不要在公共的地方暴露数据</li>
<li>不要在一个类接口中提供私有的实现</li>
<li>减少耦合来隐藏更多的实现细节<h3 id="Curly’s-Law"><a href="#Curly’s-Law" class="headerlink" title="Curly’s Law"></a>Curly’s Law</h3>Curly’s Law是一个关于代码选择单一,清晰的目标:只做一件事</li>
</ul>
<h3 id="封装变化"><a href="#封装变化" class="headerlink" title="封装变化"></a>封装变化</h3><p>一个良好的设计定义是对变化的封装于API之后,当发生预期的变化时,修改只是局限于当前.<br>为什么呢?</p>
<ul>
<li>修改发生的时候保证最小的修改范围</li>
</ul>
<p>如何做?</p>
<ul>
<li>把各种概念封装与API之后</li>
<li>尽可能的把各个概念放入自己的所属模块中</li>
</ul>
<h3 id="接口隔离原则"><a href="#接口隔离原则" class="headerlink" title="接口隔离原则"></a>接口隔离原则</h3><p>将臃肿的接口拆分成多个小的独立的接口.接口应该更多的依赖于调用它的代码而不是实现它的代码.<br>为什么呢?</p>
<ul>
<li>如果一个类实现了一个它不需要的接口,调用者需要知道这个实现方法是永远不会被调用的.<br>如何做呢?</li>
<li>避免臃肿接口,类不应该实现违背了单一职责原则的接口</li>
</ul>
<h3 id="童子军规则"><a href="#童子军规则" class="headerlink" title="童子军规则"></a>童子军规则</h3><p>在美国有一条童子军规适用于我们的职业:当你离开一个地方的时候,保证这个地方比你来的时候更干净.<br>为什么呢?</p>
<ul>
<li>当你对现存的代码做调整的时候,代码质量往往在下降,累计技术债务.遵守童子军军规可以使我们更加关注提交代码的质量,技术债务会被连续的重构减少,无论多么小.<br>如何做呢?</li>
<li>每次提交保证没有降低代码质量</li>
<li>每当发现一些不够清晰的代码的时候,应该抓住机会来把它整理的更加清晰</li>
</ul>
<h3 id="命令查询分离"><a href="#命令查询分离" class="headerlink" title="命令查询分离"></a>命令查询分离</h3><p>这条原则指的是每一个方法都应该作为一条命令去执行或查询并返回数据.问一个问题不应该修改答案<br>有了这个原则,程序员可以更有信心的编码.查询方法可以再任何地方以任何顺序使用,因为他们不会改变状态.使用命令,必须更加小心.<br>为什么呢?</p>
<ul>
<li>通过将方法清楚地分离成查询和命令,程序员可以在不知道每个方法的实现细节的情况下用额外的置信度进行编码</li>
</ul>
<p>如何做?</p>
<ul>
<li>把每一个方法当做一个查询或者命令</li>
<li>遵循命名定义,隐含的说明该方法是一个命令还是查询.</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://pheobusyy.github.io/2016/10/17/2016/Object-C 细节/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanyi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pheobusyy">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/17/2016/Object-C 细节/" itemprop="url">
                  Object-C 细节
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-10-17T14:24:00+08:00">
                2016-10-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="细节"><a href="#细节" class="headerlink" title="细节"></a>细节</h2><ul>
<li>NSMutableDictionary的allKey和allValue方法返回的都是不可变数组</li>
<li>可以通过NSMutableArray 的arrayToArray来转换数组为可变数组</li>
<li>可以通过NSString的stringByReplacingOccurrencesOfString方法来替换字符串</li>
</ul>
<h2 id="不通过系统自动创建xib的方式来新建xib的时候遇到的问题"><a href="#不通过系统自动创建xib的方式来新建xib的时候遇到的问题" class="headerlink" title="不通过系统自动创建xib的方式来新建xib的时候遇到的问题"></a>不通过系统自动创建xib的方式来新建xib的时候遇到的问题</h2><p>  当新建xib的时候，系统不会自动把controller和xib做关联，第一步就是把xib文件的class指定为对应的controller<br>  第二部就是把xib中的view和controller中的view关联，这样就不会报错了</p>
<p>  之前之所以报错，是应为xib中的view和controller的view没有绑定在一起导致的，而直接在创建controller的时候创建xib，系统会自动把两个view绑定在一起<br>  所以不会报错！<br>  <a href="http://stackoverflow.com/questions/4763519/loaded-nib-but-the-view-outlet-was-not-set-new-to-interfacebuilder" target="_blank" rel="external">http://stackoverflow.com/questions/4763519/loaded-nib-but-the-view-outlet-was-not-set-new-to-interfacebuilder</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://pheobusyy.github.io/2016/10/05/2016/linux相关知识/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanyi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pheobusyy">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/05/2016/linux相关知识/" itemprop="url">
                  linux相关知识
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-10-05T14:45:00+08:00">
                2016-10-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="linux硬链接-Hard-link-和符号链接-Symbolic-link-的作用和创建方式"><a href="#linux硬链接-Hard-link-和符号链接-Symbolic-link-的作用和创建方式" class="headerlink" title="linux硬链接(Hard link)和符号链接(Symbolic link)的作用和创建方式"></a>linux硬链接(Hard link)和符号链接(Symbolic link)的作用和创建方式</h3><p>  在linux文件系统中,保存在磁盘分区中的文件不管是什么类型都给它分配了一个编号,称为索引节点(Inode index).硬链接指的就是多个文件名指向了同一个索引节点,硬链接的作用就是允许一个文件有多个指向的有效路径名称,这样用户就可以通过硬链接来指向重要文件,当删除了其中一个节点并不会影响文件本身和其他的连接,保证文件的安全,只有当所有的连接全部都删除后,文件才会被真正删除.类似于文件”指针”.符号链接又叫软链接,有点类似于windows的快捷方式,他实际上是一个特殊的文件,文件实际上是一个文本文件,其中包含另一个文件的位置信息.</p>
<p>  创建一个空文件f1     touch f1<br>  创建一个硬链接f2     ln f1 f2<br>  创建一个软链接f3     ln -s f1 f3<br>  查看文件属性         ls -li<br>  可以看到f1,f2文件的索引节点相同,文件大小相同,而f1,f3文件索引和文件大小都不相同</p>
<p>  输入文本到f1         echo “I am f1 file” &gt;&gt; f1<br>  输出f1,f2,f3文本    cat f1<br>                     “I am f1 file”<br>                     cat f2<br>                     “I am f1 file”<br>                     cat f3<br>                     “I am f1 file”<br>  删除f1              rm f1<br>  输出f2,f3文本       cat f2<br>                     “I am f1 file”<br>                     cat f3<br>                     No such file or directory</p>
<h3 id="basename-和-dirname"><a href="#basename-和-dirname" class="headerlink" title="basename 和 dirname"></a>basename 和 dirname</h3><p>basename 命令可以获取到路径最后的文件名<br>dirname 命令可以获取到路径除了文件名的前面部分</p>
<p>比如:<br>basename /user/yy —&gt; yy<br>dirname /user/yy —&gt; /user                     </p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://pheobusyy.github.io/2016/06/15/2016/java design pattern/java design pattern - command pattern/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanyi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pheobusyy">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/06/15/2016/java design pattern/java design pattern - command pattern/" itemprop="url">
                  java design pattern - command pattern
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-15T21:13:00+08:00">
                2016-06-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <!-- TOC depthFrom:2 depthTo:6 withLinks:1 updateOnSave:1 orderedList:0 -->
<ul>
<li><a href="#场景">场景</a></li>
<li><a href="#命令模式">命令模式</a></li>
<li><a href="#参考资料">参考资料</a></li>
</ul>
<!-- /TOC -->
<h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>  在编程中，经常会遇到对一系列操作的封装，比如筛选的时候各种条件的处理，可以把每一种查询条件封装成统一的<br>  命令对象，最后装入一个集合中，完成筛选操作，这个显著的场景就可以使用命令模式来完成。各个操作彼此独立，而且<br>  遵循统一的接口，便于遍历和统一处理。</p>
<h2 id="命令模式"><a href="#命令模式" class="headerlink" title="命令模式"></a>命令模式</h2><p>  命令模式是一种结构模式，旨在对一系列操作做封装，统一调用。<br>  命令模式由4个角色组成：</p>
<ul>
<li>command 命令接口</li>
<li>concreteCommand 具体的命令，内部通过行为方法调用了receiver</li>
<li>receiver 具体的业务逻辑对象</li>
<li>invoker command的调用者</li>
</ul>
<p><img src="/images/2016/06/command_pattern_uml.gif" alt="command pattern"></p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2016/06/15/2016/java design pattern/java design pattern - command pattern/#more" rel="contents">
              Weiterlesen &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://pheobusyy.github.io/2016/06/14/2016/java design pattern/java design pattern - strategy pattern/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanyi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pheobusyy">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/06/14/2016/java design pattern/java design pattern - strategy pattern/" itemprop="url">
                  java design pattern - strategy pattern
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-14T21:37:00+08:00">
                2016-06-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <!-- TOC depthFrom:2 depthTo:6 withLinks:1 updateOnSave:1 orderedList:0 -->
<ul>
<li><a href="#场景">场景</a></li>
<li><a href="#策略模式">策略模式</a></li>
<li><a href="#参考资料">参考资料</a></li>
</ul>
<!-- /TOC -->
<h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>  编程中经常会遇到为达到目的有多种策略或者实现方式，这个时候可以使用策略模式来完成。<br>  比如商店打折有多种策略，又比如要实现一种目标可以有多种方法，这些都可以使用策略模式</p>
<h2 id="策略模式"><a href="#策略模式" class="headerlink" title="策略模式"></a>策略模式</h2><p>  策略模式是一种非常简单行为模式，旨在提供多种不同实现来满足程序要求，主要由3个角色组成：</p>
<ul>
<li>strategy 行为接口</li>
<li>ConcreteStrategy 不同实现策略</li>
<li>Context  上下文引用</li>
</ul>
<p><img src="/images/2016/06/Strategy_Pattern_uml.png" alt="strategy pattern"></p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2016/06/14/2016/java design pattern/java design pattern - strategy pattern/#more" rel="contents">
              Weiterlesen &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://pheobusyy.github.io/2016/06/14/2016/java design pattern/java design pattern - interpreter pattern/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanyi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pheobusyy">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/06/14/2016/java design pattern/java design pattern - interpreter pattern/" itemprop="url">
                  java design pattern - interpreter pattern
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-14T21:12:00+08:00">
                2016-06-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <!-- TOC depthFrom:2 depthTo:6 withLinks:1 updateOnSave:1 orderedList:0 -->
<ul>
<li><a href="#场景">场景</a></li>
<li><a href="#解释器模式">解释器模式</a></li>
<li><a href="#参考资料">参考资料</a></li>
</ul>
<!-- /TOC -->
<h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>  解释器模式在编程中很少用到，一般是用来自己定义一套简单的语法语句通过解释器解释执行，在这里简单的实现一下完事。</p>
<h2 id="解释器模式"><a href="#解释器模式" class="headerlink" title="解释器模式"></a>解释器模式</h2><p>  解释器模式是一种行为模式，用来通过解释器来解析简单语句并执行。<br>  比如可以通过解释器来模拟一个简单的四则运算。<br>  解释器模式主要由4个角色组成：</p>
<ul>
<li>abstractExpression 定义了通用的解释行为方法 inerpreter(context)</li>
<li>TerminalExpression 具体值参数，在四则运算中就是数字</li>
<li>NonTerminalExpression 操作符 ，对应四则运算的加减乘除</li>
<li>context 上下文对象，用来保存一些常用的值等中间信息</li>
</ul>
<p><img src="/images/2016/06/interpreter_pattern_uml.jpg" alt="interpreter pattern"></p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2016/06/14/2016/java design pattern/java design pattern - interpreter pattern/#more" rel="contents">
              Weiterlesen &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>


          
          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="yanyi" />
          <p class="site-author-name" itemprop="name">yanyi</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">62</span>
                <span class="site-state-item-name">Artikel</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">Tags</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yanyi</span>
</div>


<div class="powered-by">
  Erstellt mit  <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    
    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  





  



  
  

  

  

  

  


  

</body>
</html>
