<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="Hexo">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-2017/ViewDragHelper源码分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/02/09/2017/ViewDragHelper源码分析/" class="article-date">
  <time datetime="2017-02-09T08:25:00.000Z" itemprop="datePublished">2017-02-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/02/09/2017/ViewDragHelper源码分析/">ViewDragHelper源码分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="ViewDragHelper源码分析"><a href="#ViewDragHelper源码分析" class="headerlink" title="ViewDragHelper源码分析"></a>ViewDragHelper源码分析</h2><p>在学习第三方的一个开源库的时候,发现了系统居然已为viewGroup控制的子view的手势移动提供了相关的组件,就是今天要介绍的 <em>ViewDragHelper</em> ,看了一下发现功能非常的强大,基本满足了我们平时的使用要求,首先我们先讲解一下它的用法,然后再从源码层面来分析一下它的实现思路.</p>
<h3 id="ViewDragHelper的用法"><a href="#ViewDragHelper的用法" class="headerlink" title="ViewDragHelper的用法"></a>ViewDragHelper的用法</h3><p>先通过一个简单的demo来看一下ViewDragHelper的用法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestDragLayout</span> <span class="keyword">extends</span> <span class="title">LinearLayout</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> ViewDragHelper mViewDragHelper;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> View mDragView;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TestDragLayout</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(context, <span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TestDragLayout</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(context, attrs, <span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TestDragLayout</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr);</div><div class="line">        init();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        mViewDragHelper = ViewDragHelper.create(<span class="keyword">this</span>, <span class="number">1f</span>, <span class="keyword">new</span> ViewDragCallBack());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewDragCallBack</span> <span class="keyword">extends</span> <span class="title">ViewDragHelper</span>.<span class="title">Callback</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryCaptureView</span><span class="params">(View child, <span class="keyword">int</span> pointerId)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> mDragView.getId() == child.getId();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * 处理水平方向上的拖动</div><div class="line">         *</div><div class="line">         * <span class="doctag">@param</span> child 拖动的View</div><div class="line">         * <span class="doctag">@param</span> left  移动到x轴的距离</div><div class="line">         * <span class="doctag">@param</span> dx    建议的移动的x距离</div><div class="line">         */</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">clampViewPositionHorizontal</span><span class="params">(View child, <span class="keyword">int</span> left, <span class="keyword">int</span> dx)</span> </span>&#123;</div><div class="line">            <span class="comment">//两个if主要是让view在ViewGroup中</span></div><div class="line">            <span class="keyword">if</span> (left &lt; getPaddingLeft()) &#123;</div><div class="line">                <span class="keyword">return</span> getPaddingLeft();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (left &gt; getWidth() - child.getMeasuredWidth()) &#123;</div><div class="line">                <span class="keyword">return</span> getWidth() - child.getMeasuredWidth();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> left;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">clampViewPositionVertical</span><span class="params">(View child, <span class="keyword">int</span> top, <span class="keyword">int</span> dy)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (top &lt; getPaddingTop()) &#123;</div><div class="line">                <span class="keyword">return</span> getPaddingTop();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (top &gt; getHeight() - child.getMeasuredHeight()) &#123;</div><div class="line">                <span class="keyword">return</span> getHeight() - child.getMeasuredHeight();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> top;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onInterceptTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mViewDragHelper.shouldInterceptTouchEvent(ev);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</div><div class="line">        mViewDragHelper.processTouchEvent(event);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onFinishInflate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onFinishInflate();</div><div class="line">        mDragView = findViewById(R.id.dragview);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们先继承一个LinearLayout,然后在构造函数中调用 <em>init</em> 方法,在里面创建 <em>ViewDragHelper</em> 实例.然后在LinearLayout里面放入一个view,这个view就是我们要拖动的mDragView.运行程序,可以看到在布局中的view是可以在里面随便拖动的,同时也不会被拖出边界外面.是不是很简单呢?下面来分析一下使用方法:</p>
<p>使用ViewDragHelper需要三个步骤:</p>
<ol>
<li>创建ViewDragHelper实例</li>
<li>触摸相关的方法调用,主要包括 <em>shouldInterceptTouchEvent(MotionEvent ev)</em> <em>processTouchEvent(MotionEvent ev)</em> 这两个方法</li>
<li>ViewDragHelper.Callback实例的编写,用来完成各种事件的回调</li>
</ol>
<p>(一) 创建ViewDragHelper实例<br>  ViewDragHelper提供了两个创建方法,分别对应:<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ViewDragHelper <span class="title">create</span><span class="params">(ViewGroup forParent, Callback cb)</span> </span>&#123;</div><div class="line">     <span class="keyword">return</span> <span class="keyword">new</span> ViewDragHelper(forParent.getContext(), forParent, cb);</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ViewDragHelper <span class="title">create</span><span class="params">(ViewGroup forParent, <span class="keyword">float</span> sensitivity, Callback cb)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> ViewDragHelper helper = create(forParent, cb);</div><div class="line">    helper.mTouchSlop = (<span class="keyword">int</span>) (helper.mTouchSlop * (<span class="number">1</span> / sensitivity));</div><div class="line">    <span class="keyword">return</span> helper;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  两个方法的区别在于第二个方法提供了一个 <em>sensitivity</em> 参数,这个参数用来表示拖动触发的灵敏度,越大便是越灵敏.因为这里 <em>helper.mTouchSlop</em> 是通过 <em>ViewConfiguration</em> 来获得当前设备的最小的触发距离的,距离越小表示越灵敏.<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="title">ViewDragHelper</span><span class="params">(Context context, ViewGroup forParent, Callback cb)</span> </span>&#123;</div><div class="line">     <span class="keyword">if</span> (forParent == <span class="keyword">null</span>) &#123;</div><div class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Parent view may not be null"</span>);</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">if</span> (cb == <span class="keyword">null</span>) &#123;</div><div class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Callback may not be null"</span>);</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     mParentView = forParent;</div><div class="line">     mCallback = cb;</div><div class="line"></div><div class="line">     <span class="keyword">final</span> ViewConfiguration vc = ViewConfiguration.get(context);</div><div class="line">     <span class="keyword">final</span> <span class="keyword">float</span> density = context.getResources().getDisplayMetrics().density;</div><div class="line">     mEdgeSize = (<span class="keyword">int</span>) (EDGE_SIZE * density + <span class="number">0.5f</span>);</div><div class="line"></div><div class="line">     mTouchSlop = vc.getScaledTouchSlop();</div><div class="line">     mMaxVelocity = vc.getScaledMaximumFlingVelocity();</div><div class="line">     mMinVelocity = vc.getScaledMinimumFlingVelocity();</div><div class="line">     mScroller = ScrollerCompat.create(context, sInterpolator);</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>(二) 触摸相关方法调用<br>  可以看到在继承的LinearLayout中,我们复写了两个触摸事件相关的方法:<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onInterceptTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</div><div class="line">     <span class="keyword">return</span> mViewDragHelper.shouldInterceptTouchEvent(ev);</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</div><div class="line">    mViewDragHelper.processTouchEvent(event);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  首先触摸事件会触发 <em>onInterceptTouchEvent</em> 如果该方法返回true,则表明当前的viewGroup要拦截该触摸事件,那么触摸事件就不会传递给下层的子类view.而是交由自己的 <em>onTouchEvent</em> 方法来处理. 而如果 <em>onInterceptTouchEvent</em> 方法返回false,则事件会传递给子类的 <em>onTouchEvent</em> 方法,如果子类view的 <em>onTouchEvent</em> 什么都没做返回false的话,事件会再次回到viewGroup的 <em>onTouchEvent</em> 方法来处理,反之事件被成功消化,不会回到上层的viewGroup了.这是android触摸事件的传递流程.还有一个 <em>dispatchTouchEvent</em> 方法来决定是否要分发触摸事件,事件的传递会先进入这个方法,然后在这个方法中通过判断 <em>onInterceptTouchEvent</em> 来决定是否要分发事件.</p>
<p>  回头来看这里的用到的触摸回调方法,先是在 <em>onInterceptTouchEvent</em> 方法,通过 <em>mViewDragHelper.shouldInterceptTouchEvent(ev)</em> 来决定是否分发事件给子view,如果这里返回true,就会进入 <em>onTouchEvent</em> 在里面调用 <em>mViewDragHelper.processTouchEvent(event)</em> 这个方法就是用来移动view的核心方法了.</p>
<p>  我们先来看 <em>shouldInterceptTouchEvent</em> 方法:<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldInterceptTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</div><div class="line">      <span class="keyword">final</span> <span class="keyword">int</span> action = MotionEventCompat.getActionMasked(ev);</div><div class="line">      <span class="keyword">final</span> <span class="keyword">int</span> actionIndex = MotionEventCompat.getActionIndex(ev);</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (action == MotionEvent.ACTION_DOWN) &#123;</div><div class="line">          <span class="comment">// Reset things for a new event stream, just in case we didn't get</span></div><div class="line">          <span class="comment">// the whole previous stream.</span></div><div class="line">          cancel();</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (mVelocityTracker == <span class="keyword">null</span>) &#123;</div><div class="line">          mVelocityTracker = VelocityTracker.obtain();</div><div class="line">      &#125;</div><div class="line">      mVelocityTracker.addMovement(ev);</div><div class="line"></div><div class="line">      <span class="keyword">switch</span> (action) &#123;</div><div class="line">          <span class="keyword">case</span> MotionEvent.ACTION_DOWN: &#123;</div><div class="line">              <span class="keyword">final</span> <span class="keyword">float</span> x = ev.getX();</div><div class="line">              <span class="keyword">final</span> <span class="keyword">float</span> y = ev.getY();</div><div class="line">              <span class="keyword">final</span> <span class="keyword">int</span> pointerId = ev.getPointerId(<span class="number">0</span>);</div><div class="line">              saveInitialMotion(x, y, pointerId);</div><div class="line"></div><div class="line">              <span class="keyword">final</span> View toCapture = findTopChildUnder((<span class="keyword">int</span>) x, (<span class="keyword">int</span>) y);</div><div class="line"></div><div class="line">              <span class="comment">// Catch a settling view if possible.</span></div><div class="line">              <span class="keyword">if</span> (toCapture == mCapturedView &amp;&amp; mDragState == STATE_SETTLING) &#123;</div><div class="line">                  tryCaptureViewForDrag(toCapture, pointerId);</div><div class="line">              &#125;</div><div class="line"></div><div class="line">              <span class="keyword">final</span> <span class="keyword">int</span> edgesTouched = mInitialEdgesTouched[pointerId];</div><div class="line">              <span class="keyword">if</span> ((edgesTouched &amp; mTrackingEdges) != <span class="number">0</span>) &#123;</div><div class="line">                  mCallback.onEdgeTouched(edgesTouched &amp; mTrackingEdges, pointerId);</div><div class="line">              &#125;</div><div class="line">              <span class="keyword">break</span>;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="keyword">case</span> MotionEventCompat.ACTION_POINTER_DOWN: &#123;</div><div class="line">              <span class="keyword">final</span> <span class="keyword">int</span> pointerId = ev.getPointerId(actionIndex);</div><div class="line">              <span class="keyword">final</span> <span class="keyword">float</span> x = ev.getX(actionIndex);</div><div class="line">              <span class="keyword">final</span> <span class="keyword">float</span> y = ev.getY(actionIndex);</div><div class="line"></div><div class="line">              saveInitialMotion(x, y, pointerId);</div><div class="line"></div><div class="line">              <span class="comment">// A ViewDragHelper can only manipulate one view at a time.</span></div><div class="line">              <span class="keyword">if</span> (mDragState == STATE_IDLE) &#123;</div><div class="line">                  <span class="keyword">final</span> <span class="keyword">int</span> edgesTouched = mInitialEdgesTouched[pointerId];</div><div class="line">                  <span class="keyword">if</span> ((edgesTouched &amp; mTrackingEdges) != <span class="number">0</span>) &#123;</div><div class="line">                      mCallback.onEdgeTouched(edgesTouched &amp; mTrackingEdges, pointerId);</div><div class="line">                  &#125;</div><div class="line">              &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mDragState == STATE_SETTLING) &#123;</div><div class="line">                  <span class="comment">// Catch a settling view if possible.</span></div><div class="line">                  <span class="keyword">final</span> View toCapture = findTopChildUnder((<span class="keyword">int</span>) x, (<span class="keyword">int</span>) y);</div><div class="line">                  <span class="keyword">if</span> (toCapture == mCapturedView) &#123;</div><div class="line">                      tryCaptureViewForDrag(toCapture, pointerId);</div><div class="line">                  &#125;</div><div class="line">              &#125;</div><div class="line">              <span class="keyword">break</span>;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="keyword">case</span> MotionEvent.ACTION_MOVE: &#123;</div><div class="line">              <span class="keyword">if</span> (mInitialMotionX == <span class="keyword">null</span> || mInitialMotionY == <span class="keyword">null</span>) <span class="keyword">break</span>;</div><div class="line"></div><div class="line">              <span class="comment">// First to cross a touch slop over a draggable view wins. Also report edge drags.</span></div><div class="line">              <span class="keyword">final</span> <span class="keyword">int</span> pointerCount = ev.getPointerCount();</div><div class="line">              <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pointerCount; i++) &#123;</div><div class="line">                  <span class="keyword">final</span> <span class="keyword">int</span> pointerId = ev.getPointerId(i);</div><div class="line"></div><div class="line">                  <span class="comment">// If pointer is invalid then skip the ACTION_MOVE.</span></div><div class="line">                  <span class="keyword">if</span> (!isValidPointerForActionMove(pointerId)) <span class="keyword">continue</span>;</div><div class="line"></div><div class="line">                  <span class="keyword">final</span> <span class="keyword">float</span> x = ev.getX(i);</div><div class="line">                  <span class="keyword">final</span> <span class="keyword">float</span> y = ev.getY(i);</div><div class="line">                  <span class="keyword">final</span> <span class="keyword">float</span> dx = x - mInitialMotionX[pointerId];</div><div class="line">                  <span class="keyword">final</span> <span class="keyword">float</span> dy = y - mInitialMotionY[pointerId];</div><div class="line"></div><div class="line">                  <span class="keyword">final</span> View toCapture = findTopChildUnder((<span class="keyword">int</span>) x, (<span class="keyword">int</span>) y);</div><div class="line">                  <span class="keyword">final</span> <span class="keyword">boolean</span> pastSlop = toCapture != <span class="keyword">null</span> &amp;&amp; checkTouchSlop(toCapture, dx, dy);</div><div class="line">                  <span class="keyword">if</span> (pastSlop) &#123;</div><div class="line">                      <span class="comment">// check the callback's</span></div><div class="line">                      <span class="comment">// getView[Horizontal|Vertical]DragRange methods to know</span></div><div class="line">                      <span class="comment">// if you can move at all along an axis, then see if it</span></div><div class="line">                      <span class="comment">// would clamp to the same value. If you can't move at</span></div><div class="line">                      <span class="comment">// all in every dimension with a nonzero range, bail.</span></div><div class="line">                      <span class="keyword">final</span> <span class="keyword">int</span> oldLeft = toCapture.getLeft();</div><div class="line">                      <span class="keyword">final</span> <span class="keyword">int</span> targetLeft = oldLeft + (<span class="keyword">int</span>) dx;</div><div class="line">                      <span class="keyword">final</span> <span class="keyword">int</span> newLeft = mCallback.clampViewPositionHorizontal(toCapture,</div><div class="line">                              targetLeft, (<span class="keyword">int</span>) dx);</div><div class="line">                      <span class="keyword">final</span> <span class="keyword">int</span> oldTop = toCapture.getTop();</div><div class="line">                      <span class="keyword">final</span> <span class="keyword">int</span> targetTop = oldTop + (<span class="keyword">int</span>) dy;</div><div class="line">                      <span class="keyword">final</span> <span class="keyword">int</span> newTop = mCallback.clampViewPositionVertical(toCapture, targetTop,</div><div class="line">                              (<span class="keyword">int</span>) dy);</div><div class="line">                      <span class="keyword">final</span> <span class="keyword">int</span> horizontalDragRange = mCallback.getViewHorizontalDragRange(</div><div class="line">                              toCapture);</div><div class="line">                      <span class="keyword">final</span> <span class="keyword">int</span> verticalDragRange = mCallback.getViewVerticalDragRange(toCapture);</div><div class="line">                      <span class="keyword">if</span> ((horizontalDragRange == <span class="number">0</span> || horizontalDragRange &gt; <span class="number">0</span></div><div class="line">                              &amp;&amp; newLeft == oldLeft) &amp;&amp; (verticalDragRange == <span class="number">0</span></div><div class="line">                              || verticalDragRange &gt; <span class="number">0</span> &amp;&amp; newTop == oldTop)) &#123;</div><div class="line">                          <span class="keyword">break</span>;</div><div class="line">                      &#125;</div><div class="line">                  &#125;</div><div class="line">                  reportNewEdgeDrags(dx, dy, pointerId);</div><div class="line">                  <span class="keyword">if</span> (mDragState == STATE_DRAGGING) &#123;</div><div class="line">                      <span class="comment">// Callback might have started an edge drag</span></div><div class="line">                      <span class="keyword">break</span>;</div><div class="line">                  &#125;</div><div class="line"></div><div class="line">                  <span class="keyword">if</span> (pastSlop &amp;&amp; tryCaptureViewForDrag(toCapture, pointerId)) &#123;</div><div class="line">                      <span class="keyword">break</span>;</div><div class="line">                  &#125;</div><div class="line">              &#125;</div><div class="line">              saveLastMotion(ev);</div><div class="line">              <span class="keyword">break</span>;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="keyword">case</span> MotionEventCompat.ACTION_POINTER_UP: &#123;</div><div class="line">              <span class="keyword">final</span> <span class="keyword">int</span> pointerId = ev.getPointerId(actionIndex);</div><div class="line">              clearMotionHistory(pointerId);</div><div class="line">              <span class="keyword">break</span>;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="keyword">case</span> MotionEvent.ACTION_UP:</div><div class="line">          <span class="keyword">case</span> MotionEvent.ACTION_CANCEL: &#123;</div><div class="line">              cancel();</div><div class="line">              <span class="keyword">break</span>;</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">return</span> mDragState == STATE_DRAGGING;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>  可以看到里面还是对触摸事件的那几种基本的类型分别做处理,我们知道事件的触发类型对应: ACTION_DOWN –&gt; ACTION_MOVE –&gt; ACTION_MOVE –&gt; ACTION_UP .同时这里加入了对多点触摸的处理.在上面的 ACTION_DOWN 的判断中,如果当前通过 <em>findTopChildUnder</em> 捕获的view就是之前的移动的view,并且处于释放状态,就重新捕获该view并调整状态.这种情况对应快速拖动之后松开后view会自己滑动一些距离的情况.第一次拖动的时候不会触发.</p>
<p>  下面进入 ACTION_MOVE ,在这里看到顺序获取多个触摸点,如果有没有越界,如果没有问题的话就会 调用 <em>tryCaptureViewForDrag</em> 来捕获要滑动的view,并求改其状态.<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">tryCaptureViewForDrag</span><span class="params">(View toCapture, <span class="keyword">int</span> pointerId)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (toCapture == mCapturedView &amp;&amp; mActivePointerId == pointerId) &#123;</div><div class="line">           <span class="comment">// Already done!</span></div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (toCapture != <span class="keyword">null</span> &amp;&amp; mCallback.tryCaptureView(toCapture, pointerId)) &#123;</div><div class="line">           mActivePointerId = pointerId;</div><div class="line">           captureChildView(toCapture, pointerId);</div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>  该方法又会调用 <em>captureChildView</em> 方法:<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">captureChildView</span><span class="params">(View childView, <span class="keyword">int</span> activePointerId)</span> </span>&#123;</div><div class="line">     <span class="keyword">if</span> (childView.getParent() != mParentView) &#123;</div><div class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"captureChildView: parameter must be a descendant "</span></div><div class="line">                 + <span class="string">"of the ViewDragHelper's tracked parent view ("</span> + mParentView + <span class="string">")"</span>);</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     mCapturedView = childView;</div><div class="line">     mActivePointerId = activePointerId;</div><div class="line">     mCallback.onViewCaptured(childView, activePointerId);</div><div class="line">     setDragState(STATE_DRAGGING);</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>  在这个方法中最后修改view的状态为 <em>STATE_DRAGGING</em> .回到上面的 <em>shouldInterceptTouchEvent</em> 看最后一行的返回条件判断 <em>return mDragState == STATE_DRAGGING;</em> 正好对应这里的修改状态.也就是说当我们手势移动的时候,这里就会认为我们在移动触摸点下面的view,并返回true,方法调用就会进入下面要将的 <em>processTouchEvent</em> 方法了.</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</div><div class="line">      <span class="keyword">final</span> <span class="keyword">int</span> action = MotionEventCompat.getActionMasked(ev);</div><div class="line">      <span class="keyword">final</span> <span class="keyword">int</span> actionIndex = MotionEventCompat.getActionIndex(ev);</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (action == MotionEvent.ACTION_DOWN) &#123;</div><div class="line">          <span class="comment">// Reset things for a new event stream, just in case we didn't get</span></div><div class="line">          <span class="comment">// the whole previous stream.</span></div><div class="line">          cancel();</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (mVelocityTracker == <span class="keyword">null</span>) &#123;</div><div class="line">          mVelocityTracker = VelocityTracker.obtain();</div><div class="line">      &#125;</div><div class="line">      mVelocityTracker.addMovement(ev);</div><div class="line"></div><div class="line">      <span class="keyword">switch</span> (action) &#123;</div><div class="line">          <span class="keyword">case</span> MotionEvent.ACTION_DOWN: &#123;</div><div class="line">              <span class="keyword">final</span> <span class="keyword">float</span> x = ev.getX();</div><div class="line">              <span class="keyword">final</span> <span class="keyword">float</span> y = ev.getY();</div><div class="line">              <span class="keyword">final</span> <span class="keyword">int</span> pointerId = ev.getPointerId(<span class="number">0</span>);</div><div class="line">              <span class="keyword">final</span> View toCapture = findTopChildUnder((<span class="keyword">int</span>) x, (<span class="keyword">int</span>) y);</div><div class="line"></div><div class="line">              saveInitialMotion(x, y, pointerId);</div><div class="line"></div><div class="line">              <span class="comment">// Since the parent is already directly processing this touch event,</span></div><div class="line">              <span class="comment">// there is no reason to delay for a slop before dragging.</span></div><div class="line">              <span class="comment">// Start immediately if possible.</span></div><div class="line">              tryCaptureViewForDrag(toCapture, pointerId);</div><div class="line"></div><div class="line">              <span class="keyword">final</span> <span class="keyword">int</span> edgesTouched = mInitialEdgesTouched[pointerId];</div><div class="line">              <span class="keyword">if</span> ((edgesTouched &amp; mTrackingEdges) != <span class="number">0</span>) &#123;</div><div class="line">                  mCallback.onEdgeTouched(edgesTouched &amp; mTrackingEdges, pointerId);</div><div class="line">              &#125;</div><div class="line">              <span class="keyword">break</span>;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="keyword">case</span> MotionEventCompat.ACTION_POINTER_DOWN: &#123;</div><div class="line">              <span class="keyword">final</span> <span class="keyword">int</span> pointerId = ev.getPointerId(actionIndex);</div><div class="line">              <span class="keyword">final</span> <span class="keyword">float</span> x = ev.getX(actionIndex);</div><div class="line">              <span class="keyword">final</span> <span class="keyword">float</span> y = ev.getY(actionIndex);</div><div class="line"></div><div class="line">              saveInitialMotion(x, y, pointerId);</div><div class="line"></div><div class="line">              <span class="comment">// A ViewDragHelper can only manipulate one view at a time.</span></div><div class="line">              <span class="keyword">if</span> (mDragState == STATE_IDLE) &#123;</div><div class="line">                  <span class="comment">// If we're idle we can do anything! Treat it like a normal down event.</span></div><div class="line"></div><div class="line">                  <span class="keyword">final</span> View toCapture = findTopChildUnder((<span class="keyword">int</span>) x, (<span class="keyword">int</span>) y);</div><div class="line">                  tryCaptureViewForDrag(toCapture, pointerId);</div><div class="line"></div><div class="line">                  <span class="keyword">final</span> <span class="keyword">int</span> edgesTouched = mInitialEdgesTouched[pointerId];</div><div class="line">                  <span class="keyword">if</span> ((edgesTouched &amp; mTrackingEdges) != <span class="number">0</span>) &#123;</div><div class="line">                      mCallback.onEdgeTouched(edgesTouched &amp; mTrackingEdges, pointerId);</div><div class="line">                  &#125;</div><div class="line">              &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isCapturedViewUnder((<span class="keyword">int</span>) x, (<span class="keyword">int</span>) y)) &#123;</div><div class="line">                  <span class="comment">// We're still tracking a captured view. If the same view is under this</span></div><div class="line">                  <span class="comment">// point, we'll swap to controlling it with this pointer instead.</span></div><div class="line">                  <span class="comment">// (This will still work if we're "catching" a settling view.)</span></div><div class="line"></div><div class="line">                  tryCaptureViewForDrag(mCapturedView, pointerId);</div><div class="line">              &#125;</div><div class="line">              <span class="keyword">break</span>;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="keyword">case</span> MotionEvent.ACTION_MOVE: &#123;</div><div class="line">              <span class="keyword">if</span> (mDragState == STATE_DRAGGING) &#123;</div><div class="line">                  <span class="comment">// If pointer is invalid then skip the ACTION_MOVE.</span></div><div class="line">                  <span class="keyword">if</span> (!isValidPointerForActionMove(mActivePointerId)) <span class="keyword">break</span>;</div><div class="line"></div><div class="line">                  <span class="keyword">final</span> <span class="keyword">int</span> index = ev.findPointerIndex(mActivePointerId);</div><div class="line">                  <span class="keyword">final</span> <span class="keyword">float</span> x = ev.getX(index);</div><div class="line">                  <span class="keyword">final</span> <span class="keyword">float</span> y = ev.getY(index);</div><div class="line">                  <span class="keyword">final</span> <span class="keyword">int</span> idx = (<span class="keyword">int</span>) (x - mLastMotionX[mActivePointerId]);</div><div class="line">                  <span class="keyword">final</span> <span class="keyword">int</span> idy = (<span class="keyword">int</span>) (y - mLastMotionY[mActivePointerId]);</div><div class="line"></div><div class="line">                  dragTo(mCapturedView.getLeft() + idx, mCapturedView.getTop() + idy, idx, idy);</div><div class="line"></div><div class="line">                  saveLastMotion(ev);</div><div class="line">              &#125; <span class="keyword">else</span> &#123;</div><div class="line">                  <span class="comment">// Check to see if any pointer is now over a draggable view.</span></div><div class="line">                  <span class="keyword">final</span> <span class="keyword">int</span> pointerCount = ev.getPointerCount();</div><div class="line">                  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pointerCount; i++) &#123;</div><div class="line">                      <span class="keyword">final</span> <span class="keyword">int</span> pointerId = ev.getPointerId(i);</div><div class="line"></div><div class="line">                      <span class="comment">// If pointer is invalid then skip the ACTION_MOVE.</span></div><div class="line">                      <span class="keyword">if</span> (!isValidPointerForActionMove(pointerId)) <span class="keyword">continue</span>;</div><div class="line"></div><div class="line">                      <span class="keyword">final</span> <span class="keyword">float</span> x = ev.getX(i);</div><div class="line">                      <span class="keyword">final</span> <span class="keyword">float</span> y = ev.getY(i);</div><div class="line">                      <span class="keyword">final</span> <span class="keyword">float</span> dx = x - mInitialMotionX[pointerId];</div><div class="line">                      <span class="keyword">final</span> <span class="keyword">float</span> dy = y - mInitialMotionY[pointerId];</div><div class="line"></div><div class="line">                      reportNewEdgeDrags(dx, dy, pointerId);</div><div class="line">                      <span class="keyword">if</span> (mDragState == STATE_DRAGGING) &#123;</div><div class="line">                          <span class="comment">// Callback might have started an edge drag.</span></div><div class="line">                          <span class="keyword">break</span>;</div><div class="line">                      &#125;</div><div class="line"></div><div class="line">                      <span class="keyword">final</span> View toCapture = findTopChildUnder((<span class="keyword">int</span>) x, (<span class="keyword">int</span>) y);</div><div class="line">                      <span class="keyword">if</span> (checkTouchSlop(toCapture, dx, dy)</div><div class="line">                              &amp;&amp; tryCaptureViewForDrag(toCapture, pointerId)) &#123;</div><div class="line">                          <span class="keyword">break</span>;</div><div class="line">                      &#125;</div><div class="line">                  &#125;</div><div class="line">                  saveLastMotion(ev);</div><div class="line">              &#125;</div><div class="line">              <span class="keyword">break</span>;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="keyword">case</span> MotionEventCompat.ACTION_POINTER_UP: &#123;</div><div class="line">              <span class="keyword">final</span> <span class="keyword">int</span> pointerId = ev.getPointerId(actionIndex);</div><div class="line">              <span class="keyword">if</span> (mDragState == STATE_DRAGGING &amp;&amp; pointerId == mActivePointerId) &#123;</div><div class="line">                  <span class="comment">// Try to find another pointer that's still holding on to the captured view.</span></div><div class="line">                  <span class="keyword">int</span> newActivePointer = INVALID_POINTER;</div><div class="line">                  <span class="keyword">final</span> <span class="keyword">int</span> pointerCount = ev.getPointerCount();</div><div class="line">                  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pointerCount; i++) &#123;</div><div class="line">                      <span class="keyword">final</span> <span class="keyword">int</span> id = ev.getPointerId(i);</div><div class="line">                      <span class="keyword">if</span> (id == mActivePointerId) &#123;</div><div class="line">                          <span class="comment">// This one's going away, skip.</span></div><div class="line">                          <span class="keyword">continue</span>;</div><div class="line">                      &#125;</div><div class="line"></div><div class="line">                      <span class="keyword">final</span> <span class="keyword">float</span> x = ev.getX(i);</div><div class="line">                      <span class="keyword">final</span> <span class="keyword">float</span> y = ev.getY(i);</div><div class="line">                      <span class="keyword">if</span> (findTopChildUnder((<span class="keyword">int</span>) x, (<span class="keyword">int</span>) y) == mCapturedView</div><div class="line">                              &amp;&amp; tryCaptureViewForDrag(mCapturedView, id)) &#123;</div><div class="line">                          newActivePointer = mActivePointerId;</div><div class="line">                          <span class="keyword">break</span>;</div><div class="line">                      &#125;</div><div class="line">                  &#125;</div><div class="line"></div><div class="line">                  <span class="keyword">if</span> (newActivePointer == INVALID_POINTER) &#123;</div><div class="line">                      <span class="comment">// We didn't find another pointer still touching the view, release it.</span></div><div class="line">                      releaseViewForPointerUp();</div><div class="line">                  &#125;</div><div class="line">              &#125;</div><div class="line">              clearMotionHistory(pointerId);</div><div class="line">              <span class="keyword">break</span>;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="keyword">case</span> MotionEvent.ACTION_UP: &#123;</div><div class="line">              <span class="keyword">if</span> (mDragState == STATE_DRAGGING) &#123;</div><div class="line">                  releaseViewForPointerUp();</div><div class="line">              &#125;</div><div class="line">              cancel();</div><div class="line">              <span class="keyword">break</span>;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="keyword">case</span> MotionEvent.ACTION_CANCEL: &#123;</div><div class="line">              <span class="keyword">if</span> (mDragState == STATE_DRAGGING) &#123;</div><div class="line">                  dispatchViewReleased(<span class="number">0</span>, <span class="number">0</span>);</div><div class="line">              &#125;</div><div class="line">              cancel();</div><div class="line">              <span class="keyword">break</span>;</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>  这个方法中也是对触摸事件情况的处理,其中的down和up和上面的 <em>shouldInterceptTouchEvent</em> 类似,重点就在 ACTION_MOVE 中,可以发现重点就在 <em>dragTo</em> 方法中:<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dragTo</span><span class="params">(<span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> dx, <span class="keyword">int</span> dy)</span> </span>&#123;</div><div class="line">     <span class="keyword">int</span> clampedX = left;</div><div class="line">     <span class="keyword">int</span> clampedY = top;</div><div class="line">     <span class="keyword">final</span> <span class="keyword">int</span> oldLeft = mCapturedView.getLeft();</div><div class="line">     <span class="keyword">final</span> <span class="keyword">int</span> oldTop = mCapturedView.getTop();</div><div class="line">     <span class="keyword">if</span> (dx != <span class="number">0</span>) &#123;</div><div class="line">         clampedX = mCallback.clampViewPositionHorizontal(mCapturedView, left, dx);</div><div class="line">         ViewCompat.offsetLeftAndRight(mCapturedView, clampedX - oldLeft);</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">if</span> (dy != <span class="number">0</span>) &#123;</div><div class="line">         clampedY = mCallback.clampViewPositionVertical(mCapturedView, top, dy);</div><div class="line">         ViewCompat.offsetTopAndBottom(mCapturedView, clampedY - oldTop);</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="keyword">if</span> (dx != <span class="number">0</span> || dy != <span class="number">0</span>) &#123;</div><div class="line">         <span class="keyword">final</span> <span class="keyword">int</span> clampedDx = clampedX - oldLeft;</div><div class="line">         <span class="keyword">final</span> <span class="keyword">int</span> clampedDy = clampedY - oldTop;</div><div class="line">         mCallback.onViewPositionChanged(mCapturedView, clampedX, clampedY,</div><div class="line">                 clampedDx, clampedDy);</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>  可以看到,在这里完成了view的位置移动处理.通过 <em>mCallback</em> 中的各个方法来获取移动范围,并且有个 <em>mCallback.onViewPositionChanged</em> 位置移动的回调. 下面讲一下 <em>callback</em> 的用法.</p>
<p>(三) ViewDragHelper.Callback的用法<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Callback</span> </span>&#123;</div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Called when the drag state changes. See the &lt;code&gt;STATE_*&lt;/code&gt; constants</div><div class="line">       * for more information.</div><div class="line">       * 当view的拖拽状态改变时触发,对应下面写的三种情况中一种</div><div class="line">       * <span class="doctag">@param</span> state The new drag state</div><div class="line">       *</div><div class="line">       * <span class="doctag">@see</span> #STATE_IDLE 当前没有被拖拽</div><div class="line">       * <span class="doctag">@see</span> #STATE_DRAGGING 正在别拖拽</div><div class="line">       * <span class="doctag">@see</span> #STATE_SETTLING 被拖拽后需要安置到一个位置中的状态</div><div class="line">       */</div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewDragStateChanged</span><span class="params">(<span class="keyword">int</span> state)</span> </span>&#123;&#125;</div><div class="line"></div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Called when the captured view's position changes as the result of a drag or settle.</div><div class="line">       * 当view在拖拽时位置发生变化时触发,对应上面的 dragTo 方法</div><div class="line">       * <span class="doctag">@param</span> changedView View whose position changed</div><div class="line">       * <span class="doctag">@param</span> left New X coordinate of the left edge of the view</div><div class="line">       * <span class="doctag">@param</span> top New Y coordinate of the top edge of the view</div><div class="line">       * <span class="doctag">@param</span> dx Change in X position from the last call</div><div class="line">       * <span class="doctag">@param</span> dy Change in Y position from the last call</div><div class="line">       */</div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewPositionChanged</span><span class="params">(View changedView, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> dx, <span class="keyword">int</span> dy)</span> </span>&#123;&#125;</div><div class="line"></div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Called when a child view is captured for dragging or settling. The ID of the pointer</div><div class="line">       * currently dragging the captured view is supplied. If activePointerId is</div><div class="line">       * identified as &#123;<span class="doctag">@link</span> #INVALID_POINTER&#125; the capture is programmatic instead of</div><div class="line">       * pointer-initiated.</div><div class="line">       * 当一个view被捕获时触发</div><div class="line">       * <span class="doctag">@param</span> capturedChild Child view that was captured</div><div class="line">       * <span class="doctag">@param</span> activePointerId Pointer id tracking the child capture</div><div class="line">       */</div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewCaptured</span><span class="params">(View capturedChild, <span class="keyword">int</span> activePointerId)</span> </span>&#123;&#125;</div><div class="line"></div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Called when the child view is no longer being actively dragged.</div><div class="line">       * The fling velocity is also supplied, if relevant. The velocity values may</div><div class="line">       * be clamped to system minimums or maximums.</div><div class="line">       * 当拖拽动作释放时触发</div><div class="line">       * &lt;p&gt;Calling code may decide to fling or otherwise release the view to let it</div><div class="line">       * settle into place. It should do so using &#123;<span class="doctag">@link</span> #settleCapturedViewAt(int, int)&#125;</div><div class="line">       * or &#123;<span class="doctag">@link</span> #flingCapturedView(int, int, int, int)&#125;. If the Callback invokes</div><div class="line">       * one of these methods, the ViewDragHelper will enter &#123;<span class="doctag">@link</span> #STATE_SETTLING&#125;</div><div class="line">       * and the view capture will not fully end until it comes to a complete stop.</div><div class="line">       * If neither of these methods is invoked before &lt;code&gt;onViewReleased&lt;/code&gt; returns,</div><div class="line">       * the view will stop in place and the ViewDragHelper will return to</div><div class="line">       * &#123;<span class="doctag">@link</span> #STATE_IDLE&#125;.&lt;/p&gt;</div><div class="line">       *</div><div class="line">       * <span class="doctag">@param</span> releasedChild The captured child view now being released</div><div class="line">       * <span class="doctag">@param</span> xvel X velocity of the pointer as it left the screen in pixels per second.</div><div class="line">       * <span class="doctag">@param</span> yvel Y velocity of the pointer as it left the screen in pixels per second.</div><div class="line">       */</div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewReleased</span><span class="params">(View releasedChild, <span class="keyword">float</span> xvel, <span class="keyword">float</span> yvel)</span> </span>&#123;&#125;</div><div class="line"></div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Called when one of the subscribed edges in the parent view has been touched</div><div class="line">       * by the user while no child view is currently captured.</div><div class="line">       * 当触发了viewGroup的边缘时触发</div><div class="line">       * <span class="doctag">@param</span> edgeFlags A combination of edge flags describing the edge(s) currently touched</div><div class="line">       * <span class="doctag">@param</span> pointerId ID of the pointer touching the described edge(s)</div><div class="line">       * <span class="doctag">@see</span> #EDGE_LEFT</div><div class="line">       * <span class="doctag">@see</span> #EDGE_TOP</div><div class="line">       * <span class="doctag">@see</span> #EDGE_RIGHT</div><div class="line">       * <span class="doctag">@see</span> #EDGE_BOTTOM</div><div class="line">       */</div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEdgeTouched</span><span class="params">(<span class="keyword">int</span> edgeFlags, <span class="keyword">int</span> pointerId)</span> </span>&#123;&#125;</div><div class="line"></div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Called when the given edge may become locked. This can happen if an edge drag</div><div class="line">       * was preliminarily rejected before beginning, but after &#123;<span class="doctag">@link</span> #onEdgeTouched(int, int)&#125;</div><div class="line">       * was called. This method should return true to lock this edge or false to leave it</div><div class="line">       * unlocked. The default behavior is to leave edges unlocked.</div><div class="line">       * 是否锁定边缘的触摸</div><div class="line">       * <span class="doctag">@param</span> edgeFlags A combination of edge flags describing the edge(s) locked</div><div class="line">       * <span class="doctag">@return</span> true to lock the edge, false to leave it unlocked</div><div class="line">       */</div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onEdgeLock</span><span class="params">(<span class="keyword">int</span> edgeFlags)</span> </span>&#123;</div><div class="line">          <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Called when the user has started a deliberate drag away from one</div><div class="line">       * of the subscribed edges in the parent view while no child view is currently captured.</div><div class="line">       * 边缘触摸开始时触发</div><div class="line">       * <span class="doctag">@param</span> edgeFlags A combination of edge flags describing the edge(s) dragged</div><div class="line">       * <span class="doctag">@param</span> pointerId ID of the pointer touching the described edge(s)</div><div class="line">       * <span class="doctag">@see</span> #EDGE_LEFT</div><div class="line">       * <span class="doctag">@see</span> #EDGE_TOP</div><div class="line">       * <span class="doctag">@see</span> #EDGE_RIGHT</div><div class="line">       * <span class="doctag">@see</span> #EDGE_BOTTOM</div><div class="line">       */</div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEdgeDragStarted</span><span class="params">(<span class="keyword">int</span> edgeFlags, <span class="keyword">int</span> pointerId)</span> </span>&#123;&#125;</div><div class="line"></div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Called to determine the Z-order of child views.</div><div class="line">       * 在寻找当前的触摸点下的view时会调用这个方法,比如两个子view叠加在一起之后,如果你想获得下面的那个时,可以改写这个方法.</div><div class="line">       * <span class="doctag">@param</span> index the ordered position to query for</div><div class="line">       * <span class="doctag">@return</span> index of the view that should be ordered at position &lt;code&gt;index&lt;/code&gt;</div><div class="line">       */</div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrderedChildIndex</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</div><div class="line">          <span class="keyword">return</span> index;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Return the magnitude of a draggable child view's horizontal range of motion in pixels.</div><div class="line">       * This method should return 0 for views that cannot move horizontally.</div><div class="line">       * 获取被拖拽view的水平移动范围</div><div class="line">       * <span class="doctag">@param</span> child Child view to check</div><div class="line">       * <span class="doctag">@return</span> range of horizontal motion in pixels</div><div class="line">       */</div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getViewHorizontalDragRange</span><span class="params">(View child)</span> </span>&#123;</div><div class="line">          <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Return the magnitude of a draggable child view's vertical range of motion in pixels.</div><div class="line">       * This method should return 0 for views that cannot move vertically.</div><div class="line">       * 获取被拖拽view的垂直移动范围</div><div class="line">       * <span class="doctag">@param</span> child Child view to check</div><div class="line">       * <span class="doctag">@return</span> range of vertical motion in pixels</div><div class="line">       */</div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getViewVerticalDragRange</span><span class="params">(View child)</span> </span>&#123;</div><div class="line">          <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Called when the user's input indicates that they want to capture the given child view</div><div class="line">       * with the pointer indicated by pointerId. The callback should return true if the user</div><div class="line">       * is permitted to drag the given view with the indicated pointer.</div><div class="line">       *</div><div class="line">       * &lt;p&gt;ViewDragHelper may call this method multiple times for the same view even if</div><div class="line">       * the view is already captured; this indicates that a new pointer is trying to take</div><div class="line">       * control of the view.&lt;/p&gt;</div><div class="line">       * 尝试捕获当前触摸的view</div><div class="line">       * &lt;p&gt;If this method returns true, a call to &#123;<span class="doctag">@link</span> #onViewCaptured(android.view.View, int)&#125;</div><div class="line">       * will follow if the capture is successful.&lt;/p&gt;</div><div class="line">       *</div><div class="line">       * <span class="doctag">@param</span> child Child the user is attempting to capture</div><div class="line">       * <span class="doctag">@param</span> pointerId ID of the pointer attempting the capture</div><div class="line">       * <span class="doctag">@return</span> true if capture should be allowed, false otherwise</div><div class="line">       */</div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">tryCaptureView</span><span class="params">(View child, <span class="keyword">int</span> pointerId)</span></span>;</div><div class="line"></div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Restrict the motion of the dragged child view along the horizontal axis.</div><div class="line">       * The default implementation does not allow horizontal motion; the extending</div><div class="line">       * class must override this method and provide the desired clamping.</div><div class="line">       * 限制水平方向的移动范围</div><div class="line">       *</div><div class="line">       * <span class="doctag">@param</span> child Child view being dragged</div><div class="line">       * <span class="doctag">@param</span> left Attempted motion along the X axis</div><div class="line">       * <span class="doctag">@param</span> dx Proposed change in position for left</div><div class="line">       * <span class="doctag">@return</span> The new clamped position for left</div><div class="line">       */</div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">clampViewPositionHorizontal</span><span class="params">(View child, <span class="keyword">int</span> left, <span class="keyword">int</span> dx)</span> </span>&#123;</div><div class="line">          <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Restrict the motion of the dragged child view along the vertical axis.</div><div class="line">       * The default implementation does not allow vertical motion; the extending</div><div class="line">       * class must override this method and provide the desired clamping.</div><div class="line">       * 限制垂直方向的移动范围</div><div class="line">       *</div><div class="line">       * <span class="doctag">@param</span> child Child view being dragged</div><div class="line">       * <span class="doctag">@param</span> top Attempted motion along the Y axis</div><div class="line">       * <span class="doctag">@param</span> dy Proposed change in position for top</div><div class="line">       * <span class="doctag">@return</span> The new clamped position for top</div><div class="line">       */</div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">clampViewPositionVertical</span><span class="params">(View child, <span class="keyword">int</span> top, <span class="keyword">int</span> dy)</span> </span>&#123;</div><div class="line">          <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>  ViewDragHelper的内部流程实现就讲完了,有些细节这里就不展开了,感兴趣的同学可以读一下源码.在额外补充ViewDragHelper的常用方法 <em>settleCapturedViewAt</em> :<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">settleCapturedViewAt</span><span class="params">(<span class="keyword">int</span> finalLeft, <span class="keyword">int</span> finalTop)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (!mReleaseInProgress) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot settleCapturedViewAt outside of a call to "</span></div><div class="line">                   + <span class="string">"Callback#onViewReleased"</span>);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">return</span> forceSettleCapturedViewAt(finalLeft, finalTop,</div><div class="line">               (<span class="keyword">int</span>) VelocityTrackerCompat.getXVelocity(mVelocityTracker, mActivePointerId),</div><div class="line">               (<span class="keyword">int</span>) VelocityTrackerCompat.getYVelocity(mVelocityTracker, mActivePointerId));</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>  这个方法,用来直接把拖动的view放在指定的位置上.<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">forceSettleCapturedViewAt</span><span class="params">(<span class="keyword">int</span> finalLeft, <span class="keyword">int</span> finalTop, <span class="keyword">int</span> xvel, <span class="keyword">int</span> yvel)</span> </span>&#123;</div><div class="line">     <span class="keyword">final</span> <span class="keyword">int</span> startLeft = mCapturedView.getLeft();</div><div class="line">     <span class="keyword">final</span> <span class="keyword">int</span> startTop = mCapturedView.getTop();</div><div class="line">     <span class="keyword">final</span> <span class="keyword">int</span> dx = finalLeft - startLeft;</div><div class="line">     <span class="keyword">final</span> <span class="keyword">int</span> dy = finalTop - startTop;</div><div class="line"></div><div class="line">     <span class="keyword">if</span> (dx == <span class="number">0</span> &amp;&amp; dy == <span class="number">0</span>) &#123;</div><div class="line">         <span class="comment">// Nothing to do. Send callbacks, be done.</span></div><div class="line">         mScroller.abortAnimation();</div><div class="line">         setDragState(STATE_IDLE);</div><div class="line">         <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="keyword">final</span> <span class="keyword">int</span> duration = computeSettleDuration(mCapturedView, dx, dy, xvel, yvel);</div><div class="line">     mScroller.startScroll(startLeft, startTop, dx, dy, duration);</div><div class="line"></div><div class="line">     setDragState(STATE_SETTLING);</div><div class="line">     <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>  可以看到这里通过Scroller来完成view的平滑移动的.这个方法 <em>settleCapturedViewAt</em> 在拖动view释放之后让view进入指定位置的时候会非常有用.<br>  注意:一定要在viewGroup调用如下方法来完成view的平滑移动,在调用 <em>settleCapturedViewAt</em> 方法的时候.<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">computeScroll</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.computeScroll();</div><div class="line">    <span class="keyword">if</span> (mDragHelper.continueSettling(<span class="keyword">true</span>)) &#123;</div><div class="line">        ViewCompat.postInvalidateOnAnimation(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/02/09/2017/ViewDragHelper源码分析/" data-id="cizy53xqx001i3us6zq9uqsic" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2017/读书笔记/&lt;刻意练习&gt;读书笔记" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/02/06/2017/读书笔记/<刻意练习>读书笔记/" class="article-date">
  <time datetime="2017-02-06T08:09:00.000Z" itemprop="datePublished">2017-02-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/02/06/2017/读书笔记/<刻意练习>读书笔记/">&lt;刻意练习&gt;读书笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="lt-刻意练习-gt-读书笔记"><a href="#lt-刻意练习-gt-读书笔记" class="headerlink" title="&lt;刻意练习&gt;读书笔记"></a>&lt;刻意练习&gt;读书笔记</h2><p>刻意练习的难度要适中,能收到反馈,有足够的次数重复练习,学习者能纠正自己的错误.</p>
<ul>
<li>输入-解码-处理-编码-输出-反馈-输入</li>
</ul>
<p>人们的学习受到情景的制约或促进.你要学习的东西将实际运用在什么情景中,那么你就应该在什么样的情境中学习这些东西.</p>
<ul>
<li>要学有所用,不能脱离实际</li>
</ul>
<p>学习科学大量研究表明,成人的最佳学习方式并非独自学习,而是在情景中学习.</p>
<ul>
<li>要明白学习的目的是什么,带着要解决的问题学习</li>
</ul>
<h3 id="有目的的练习"><a href="#有目的的练习" class="headerlink" title="有目的的练习"></a>有目的的练习</h3><p>有目的练习的四个特点:</p>
<ol>
<li>有目的练习具有定义明确的特定目标</li>
<li>有目的的练习是专注的</li>
<li>有目的的练习包含反馈<br>不论你在努力做什么事情,都需要反馈来准确辨别你在哪些方面还有不足,以及怎么会存在这些不足</li>
<li>有目的的练习需要走出舒适区<br>对于任何类型的练习,这是一条基本的真理:如果你从不迫使你走出舒适区,便永远无法进步.</li>
</ol>
<ul>
<li>两个很重要的关键词,一个是 <em>反馈</em> 一个是 <em>舒适区</em> .前者用来衡量练习效果并加以校正,后者是保证练习效果持续进步的必要条件  </li>
</ul>
<h3 id="遇到瓶颈怎么办"><a href="#遇到瓶颈怎么办" class="headerlink" title="遇到瓶颈怎么办"></a>遇到瓶颈怎么办</h3><ol>
<li>试着做不同的事情,而非更难的事情<br>通常情况下,逾越障碍的方法并不是”试着做更难的事情”,而是”试着做不同的事情”.</li>
</ol>
<ul>
<li><p>遇到困难的时候要讲究不同的策略,不要一直正面突破</p>
<p>不管遇到什么障碍,越过它的最好办法是从不同的方向想办法,这也是这种方法需要导师或者教练的一个原因.有些人已经熟悉你可能遇到的障碍,于是可以为你提供克服障碍的方法.</p>
</li>
<li><p>师傅或者教练的重要性,毕竟经历过的人知道正确的或者失败处理方式.</p>
</li>
</ul>
<ol>
<li><p>并非达到极限,而是动机不足</p>
<p>要想有动机,需要两个因素:一个是报酬,一个是勇于自我挑战</p>
</li>
</ol>
<p>我们在这里简单地总结有目的的练习:走出你的舒适区,但要以专注的方式制定明确的目标,未达到那些目标制定一个计划,并且想出检测你进步的方法.哦,还要想办法保持你的动机.</p>
<ul>
<li>上面讲的就是练习的基本要求,带着目的或者问题,明白标准在哪里,给自己压力.不断的保持前进</li>
</ul>
<h3 id="为什么要走出舒适区"><a href="#为什么要走出舒适区" class="headerlink" title="为什么要走出舒适区"></a>为什么要走出舒适区</h3><p>这就是体育锻炼制造身体变化的一般模式.当身体的系统(比如某些肌肉,心血管系统或者其他系统)感受到压力,一直与原来的体内平衡无法继续保持下去时,身体便会开始响应那些变化,目的是重新建立体内平衡.</p>
<p>足够努力的锻炼,并且保持足够长的时间,那么,身体将以各种方式来改变,使得那种努力更容易.</p>
<p>要是改变不断进行下去,你必须不断的加码:跑的更远一些,更快一些,并且爬坡跑.</p>
<ul>
<li>肌肉在压力下不断的撕裂不断重塑,身体在不断适应锻炼的强度,这样才会变得更加健康.</li>
</ul>
<h3 id="大脑的适应能力"><a href="#大脑的适应能力" class="headerlink" title="大脑的适应能力"></a>大脑的适应能力</h3><p>三个重要细节:</p>
<ol>
<li>训练对大脑的影响(越早训练越容易改变)</li>
<li>通过超长时间的训练来发展大脑中的某些部位,可能得付出一些代价.(一方面的增强就会又另一方面的减弱)</li>
<li>由训练引起的认知和生理变化需要继续保持(如果停止训练,他们便开始消失)</li>
</ol>
<p>传统的方法并不是专门用于挑战体内平衡的.</p>
<p>对于刻意练习,我们的目标不仅仅是发觉自己的潜能,而是要构筑它,以便从前不可能做到的事情变得可能做到.这要求挑战体内平衡,也就是走出你的舒适区,并迫使你的大脑或身体来适应.一点你做到这一点,学习便不再只是执行某些遗传命运的方式;它变成一种控制你自己命运的方式,就是一种按照你选择的方法构筑潜力的方式.</p>
<h3 id="心理表征是是什么-非常重要"><a href="#心理表征是是什么-非常重要" class="headerlink" title="心理表征是是什么(非常重要)"></a>心理表征是是什么(非常重要)</h3><p>心理表征是一种与我们大脑正在思考的某个物体,某个观点,某些信息后者其他任何事物相对应的心里结构,或具体或抽象.</p>
<ul>
<li>我个人理解的心理表征是指对某个东西的内在影像,也就是一个东西在你大脑中是什么样子的.如果是不太熟悉的东西应该是大概轮廓,如果是熟悉的东西应该它的各种属性,使用方法等等相关的维度分析.如果是概念的话应该是语言描述或个人看法.</li>
</ul>
<p>刻意练习包括创建心理表征</p>
<ul>
<li>刻意练习包括创建事物在脑海中概念,也包括调整优化脑海中对东西的使用方式</li>
</ul>
<p>将杰出人物与其他人区分开来的因素,正式前者的心理表征的质量与数量</p>
<p>心理表征有助于解释信息,心理表征的一个重要好处在于,可以帮助我们处理信息:理解和解读它,把它保存在记忆之中,组织它,分析它,并用它来决策.</p>
<p>精心创建的心理表征的一个主要优势是:你可以立即吸收和考虑更多的信息.</p>
<p>在对杰出人物的研究之中,出色地组织信息是反复出现的主题.</p>
<p>刻意练习的主要目的是创建有效的心理表征,心理表征反过来再刻意练习中发挥着重要的作用.</p>
<p>他们检测并评估自己的技能水平,在必要时调整心理表征,使之更加有效.心理表征越有效,水平也越优异.</p>
<p>学生之间的差别,在很大程度上最有可能取决于他们能有多敏锐地察觉自己所犯的错误,也就是说,他们对音乐作品的心理表征有多么有效.</p>
<ul>
<li>与高手招式之间的差距</li>
</ul>
<p>磨砺了技能,可以改善心理表征;而更变心理表征,也有助于磨砺技能.</p>
<p>这类似于一遍盘爬楼梯,一遍搭建新的阶梯.你攀爬的每一步阶梯,都让你来到了需要搭建新阶梯的地方.然后,你搭建了新的阶梯,爬上去之后,你有得准备搭建下一步阶梯了.</p>
<h3 id="黄金标准"><a href="#黄金标准" class="headerlink" title="黄金标准"></a>黄金标准</h3><p>最杰出的人是那些在各种有目的的联系中花了最多时间的人</p>
<p>首先辨别出杰出人物,然后推测是什么使他们变得如此杰出,接着再提出训练方法,这些方法使你也能像他们那样表现卓越.</p>
<p>在任何一个有着悠久历史的行业或领域,要想成就一番事业,致力于变成业内的杰出人士,需要付出多年艰苦卓绝的努力.</p>
<h3 id="在工作中运用刻意练习原则"><a href="#在工作中运用刻意练习原则" class="headerlink" title="在工作中运用刻意练习原则"></a>在工作中运用刻意练习原则</h3><p>如果你没有进步,并不是你缺少天赋,而是因为你没有用正确的方法练习.</p>
<p>传统的方法一直是先找出关于正确方法的信息,然后让学生运用那些知识.刻意学习则只聚焦于绩效和表现,以及怎样提高绩效和表现.</p>
<h3 id="在生活中运用刻意练习原则"><a href="#在生活中运用刻意练习原则" class="headerlink" title="在生活中运用刻意练习原则"></a>在生活中运用刻意练习原则</h3><p>如果你在走神,或者你很放松,并且只是为了好玩,你可能不会进步.</p>
<p>学会以这种方式投入,即有意地提升和精进你的技能,是提高训练效果的最强大的方式.</p>
<p>制定明确的目标,把练习课程的时间缩的更短,是更加迅速地提升新的技能水平的最佳方式.</p>
<p>反复做一件事情,目的是找出你在哪些方面存在不足,并且聚焦于在那些方面取得进步,试着采用不同的方法来提高,知道你最终找到适合自己的方法.</p>
<p>专注(focus),反馈(feedback)以及纠正(fix).将技能分解成一些组成部分,一边反复的练习,并且有效的分析,确定你的不足之处,然后想出各种方法来解决它们.</p>
<h4 id="保持动机的两个组成部分"><a href="#保持动机的两个组成部分" class="headerlink" title="保持动机的两个组成部分"></a>保持动机的两个组成部分</h4><p>保持这种推行此类体制运行下去的动机,包括两个组成部分:继续前进的理解和停下脚步的理由.</p>
<p>你要保持动机,要么强化继续前进的理由,要么弱化停止脚步的理由.</p>
<ol>
<li><p>弱化停下脚步的理由<br>人们可以采用多种方式来弱化停下脚步的理由.其中最有效的一种是留出固定时间来练习,不收所有其他义务和分析的事情所干扰.<br>要找出那些可能干扰你练习的事情,并想办法将影响控制在最小.</p>
<p>杰出人物往往做两件有益的事情,他们看起来视乎与动机无关.第一件事一般的身体保养:保证充足的睡眠并保持健康.如果你疲倦了或生病了,就更难保持专注,更易分心走神.<br>第二件是讲练习课的时间限制在1小时左右.如果比那个时间长的多,你将无法保持高度的专注.</p>
</li>
<li><p>增强继续前行的倾向<br>一旦你已经练习了一段时间,并且可以看到结果了,这种技能本身就可以成为你动机的一部分.</p>
</li>
</ol>
<p>外部动机的一种最强烈的方式是社会动机.这可能以几种表现出来.最简单最有效的是其他人的认可和崇拜.</p>
<p>将对同一件事情感兴趣的所有人聚集起来,或者吸引他们加入一个现有的团体,并且将团体的同志情谊和共同的目标作为打到你自己目标的额外动力.</p>
<ol>
<li><p>精心设置目标</p>
<p>将漫长的旅程分解为一系列可控的目标,并且每次只关注他们中的一个,甚至可以在每次达到一个目标时,给自己小小的奖励.</p>
</li>
</ol>
<h3 id="成为杰出人物路线图"><a href="#成为杰出人物路线图" class="headerlink" title="成为杰出人物路线图"></a>成为杰出人物路线图</h3><p>第一阶段:产生兴趣<br>第二阶段:变得认真<br>第三阶段:全力投入<br>第四阶段:开拓创新</p>
<h3 id="怎样解释天生才华"><a href="#怎样解释天生才华" class="headerlink" title="怎样解释天生才华"></a>怎样解释天生才华</h3><p>从长远来看,占上风的是那些练习更加勤奋的人,而不是那些一开始在智商或者其他才华方面稍有优势的人.</p>
<h3 id="用刻意练习创造全新的世界"><a href="#用刻意练习创造全新的世界" class="headerlink" title="用刻意练习创造全新的世界"></a>用刻意练习创造全新的世界</h3><p>所谓”练习人”,是反映人在一生之中能够通过练习掌握自己的命运,使得人生充满各种可能.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/02/06/2017/读书笔记/<刻意练习>读书笔记/" data-id="cizy53xsn002i3us60ixgg4sk" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2017/读书笔记/&lt;小狗钱钱&gt;读书笔记" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/02/06/2017/读书笔记/<小狗钱钱>读书笔记/" class="article-date">
  <time datetime="2017-02-06T07:14:00.000Z" itemprop="datePublished">2017-02-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/02/06/2017/读书笔记/<小狗钱钱>读书笔记/">&lt;小狗钱钱&gt;读书笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="lt-小狗钱钱-gt-读书笔记"><a href="#lt-小狗钱钱-gt-读书笔记" class="headerlink" title="&lt;小狗钱钱&gt;读书笔记"></a>&lt;小狗钱钱&gt;读书笔记</h2><p>“并非困难使我们放弃,而是因为我们放弃,才显得如此困难.”</p>
<p>“天下难事,必作于易;天下大事,必作于细.” - 老子</p>
<p>“大多数人并不清楚自己想要什么,他们只知道,自己想得到更多的东西.你可以把自己的生活想象成一家很大的邮购公司.如果你给一家邮购公司写信说’请给我寄一些好东西来’,你肯定什么也得不到.我们的愿望也是一样的.我们必须确切知道自己内心渴望的是什么才行.”</p>
<ul>
<li>目标的明确性很重要,如果只是一个空洞的概念或愿景,是很难有动力去实现的,也无法明确的知道如何去实现,以及最终的实现的效果是什么样的.</li>
</ul>
<p>“不要试试看,而是去切实行动!如果你只是抱着试试看的心态,那么你只会以失败而告终,你会一事无成.’尝试’纯粹是一种借口,你还没有做,就已经给自己想好了退路.不能实验,你只有两个选择—做或者不做.”</p>
<ul>
<li>‘试试’是一种不自信的表现,是自我推脱的借口,意味着自己并没有准备好全力以赴.要么不做,要做就要尽全力.做人要活的洒脱大气</li>
</ul>
<p>“学习就是认识新观念和新想法的工程.假如人们始终以同一种思维方式来思考问题的话,那么始终只会得到同样的结果.因为我对你讲述的许多内容是你以前从未接触过的,所以我建议你,在你还没有做之前,不要轻易的下结论.没有想象力的人很难成就大事的.我们对一件事投入的精力越多,成功的可能性越大.可是大多数人把精力放在自己并不喜欢的事情上,而不去想象自己希望得到的东西.”</p>
<ul>
<li><p>大多数人甚至都不知道自己真正喜欢的是什么.没有尝试过,没有走出去舒适圈,你永远不知道外面的世界是什么样的.走出去意味着可能,原地踏步只会困死在原地.做一辈子平凡的人.回想自己之前不敢换工作,就是不敢迈出那一步而已,虽然到现在也不知道自己到底喜欢的是什么,但是最起码意识到了这个问题,并且在通过读书学习来慢慢的找到喜欢的东西,这就是最大的进步.</p>
</li>
<li><p>在没有做之前不要一概否定,不试试怎么知道行不行呢?</p>
</li>
<li><p>对一件事投入的精力越大,越有可能成功</p>
</li>
</ul>
<p>“有一只海鸥曾经对我说过’在你展翅飞翔之前,你就必须相信自己能够到达目的地.’你必须设想自己拥有了这些东西,这样你的一个小愿望才会变成一种强烈的渴望.你想象的越多,你的愿望就越强烈,那么你就会开始寻找机会来实现自己的梦想.吉娅,机会到处都是,但是只有在你寻找它的时候,你才能看见它.只有当你心中有了强烈的渴望,你才会去寻觅机会.而当你想象的时候,强烈的渴望就产生了.”</p>
<ul>
<li>要自信,相信自己可以得到自己想要的.对未来想象的越清晰,越有动力和激情去实现.</li>
</ul>
<p>“你的自信程度决定了你是否相信自己的能力,是否相信你自己.假如你根本不相信你能做到的话,那么你就根本不会动手去做,而加入你不开始去做,那么你就什么也得不到.”</p>
<ul>
<li>相信自己可以,就一定可以.自我的不断催眠,可以让自己更加的自信强大</li>
</ul>
<p>“你去准备一个本子,给它取名叫’成功日记’,然后把所有做成功的事情记录进去.你最好每天都做这件事,每次都写至少5条你的个人成功,任何小事都可以.开始的时候你觉得不太容易,可能会问自己,这件或那件事情是否真的可以算作成果.在这种情况下,你的回答应该是肯定的.过于自信比不够自信要好得多.”</p>
<ul>
<li>修改一下每日总结的模板,把下面的那个每天三件事改成成功日记.记录自己每天做成功的事情.</li>
</ul>
<p>“商人给了他两个重要的建议:第一,为别人解决一个难题,那么你就可以赚很多的钱;第二,把精力集中在你知道的,能做的和拥有的东西上.”</p>
<ul>
<li>致富的秘诀就在于帮别人解决问题,从自己拥有的技能思想或者身边的资源入手.利用信息不对等法则.</li>
</ul>
<p>“但是,我想提醒你两件重要的事情.第一,无论什么时候都不要把希望只寄托在一份工作上,它持续的时间不会像你设想的那么长,所以你要立即寻找另一份替代的工作.第二,你肯定会遇到一些困难,这些困难是你现在还难以预料的.”</p>
<ul>
<li>鸡蛋不要放在同一个篮子里,要有不同的求胜技能.增加适应风险的能力,墨菲定律,比如车子被剐蹭不可避免,要做好应对措施.</li>
</ul>
<p>“我要告诉你三件很重要的事情.首先,在遇到困难的时候,仍然要坚持自己的想法.一些正常的时候,每个人都能做到这一点.只有当真正困难出现时才能见分晓.只有少数人能坚定不移地贯彻自己的计划.那么非常成功的人,甚至有能力在他们最困难的时候作出最杰出的表现.第二点,在一切进展顺利的情况下,你也应该做这些事情.每天记录自己的成功.最后,当你决定做一件事情的时候,你必须在72小时之内完成,否则你很可能永远不会再做了.”</p>
<ul>
<li>“风生水起才知天高云淡,沧海横流方显英雄本色”</li>
<li>遭遇挫折时要坚持自己的想法,顺利更要坚持自己的想法.宠辱不惊</li>
<li>72小时完成</li>
</ul>
<p>“所有的消费贷款都是不明智的.聪明的做法只把以前积累起来的财富用于支出.”</p>
<ul>
<li><p>对应&lt;穷爸爸,富爸爸&gt;里面的资产和负债的区别.只有用利息购买的东西才是真正的支出.</p>
</li>
<li><p>在购买东西之前,认真的问问自己”这真的有必要吗?”</p>
</li>
</ul>
<p>“金钱能成为我们生活中非常强大的推理.金钱可以在一定程度上提高我们的生活水平-生活的许多方面都是以钱为基础的.有了钱,我们更容易的实现我们的目标和梦想-当然,包括好的目标和梦想,也包括坏的目标和梦想.”</p>
<ul>
<li>很多人都把金钱和梦想的关系给颠倒了.是先有钱再去实现梦想才对.而不是把梦想和钱挂钩.好比工作只是用来养家糊口的,事业才是真正实现梦想的途径.</li>
</ul>
<p>“我生命中出现了最美好的东西,是因为我做了原本不敢做的事.”<br>“最珍贵的礼物是我们争取来的.克服了丢面子的恐惧,世界就会向你敞开大门.”</p>
<ul>
<li>勇敢的迈出那一步,会收获很多惊喜</li>
</ul>
<p>“成功会使人骄傲.如果你骄傲自大,你就会停止学习.不学习,人就不会再进步.”</p>
<ul>
<li>永远要不断的学习,不断的进步.</li>
</ul>
<p>“恐惧总是出现在我们设想事情会如何不顺利的时候.我们的失败的可能性想的越多,就会越害怕.而当你看着自己的成功日记的时,你就会注意到那些成功的事情,自然而然也就会想到应该怎样去做.”<br>“当你朝着积极地目标去思考的时候,就不会心生畏惧.”</p>
<ul>
<li>我们唯一恐惧就是恐惧本身.回头想想大多数我们担心的事情都没有发生过.同时即使失败了后果也没有我们想到那么严重.</li>
</ul>
<p>“我们的咒语是:</p>
<ol>
<li>确定自己希望获得财务上的成功.</li>
<li>自信,有想法,做自己喜欢的事.</li>
<li>把钱分为日常开销,梦想目标和金鹅账户三部分.</li>
<li>进行明智的投资</li>
<li>享受生活.<br>“</li>
</ol>
<ul>
<li>对待财富的态度和处理方法就是上面说的5个方式.</li>
</ul>
<p>“不要为失去的东西而忧伤,而要对拥有它的时光心存感激.对我来说,这句话的意思是:从现在开始,我再也得不到钱钱的建议了,但我还是必须应对各种情况.”</p>
<ul>
<li>要学会感恩,感谢现在自己拥有的一切.</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/02/06/2017/读书笔记/<小狗钱钱>读书笔记/" data-id="cizy53xsp002k3us69uu0mrdo" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2017/读书笔记/启示录-打造用户喜爱的产品" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/24/2017/读书笔记/启示录-打造用户喜爱的产品/" class="article-date">
  <time datetime="2017-01-24T06:03:00.000Z" itemprop="datePublished">2017-01-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/24/2017/读书笔记/启示录-打造用户喜爱的产品/">启示录-打造用户喜爱的产品</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="启示录-打造用户喜爱的产品-读书笔记"><a href="#启示录-打造用户喜爱的产品-读书笔记" class="headerlink" title="启示录-打造用户喜爱的产品 读书笔记"></a>启示录-打造用户喜爱的产品 读书笔记</h2><p>我的日常工作明确分为三个部分: 人员,流程,产品</p>
<ul>
<li>人员是指负责定义和开发产品的团队成员的角色和职责</li>
<li>流程是指探索,开发富有创意的产品时,反复应用的步骤和成功的实践经验</li>
<li>产品是指富有创意的产品具有的鲜明特性</li>
</ul>
<h3 id="人员"><a href="#人员" class="headerlink" title="人员"></a>人员</h3><p>产品经理的主要职责分为两项: 评估产品机会;定义要开发的产品</p>
<p>现代软件的产品团队组成:</p>
<ul>
<li>产品经理</li>
<li>用户体验设计师</li>
<li>项目管理人员</li>
<li>开发团队</li>
<li>运维团队</li>
<li>产品营销人员</li>
</ul>
<p>必须清晰的界定产品经理和产品营销人员的职责.产品经理负责详细定义待开发的产品,让真实的用户测试产品.产品营销人员负责向外界宣传和推广产品,负责产品发布,为拓展市场销售渠道,组织重点营销活动(如在线营销),促进产品销售提供支持.</p>
<p>产品管理通常使用了 <em>并行开发</em> 和 <em>火车模型发布模式</em></p>
<p>优秀产品经理身上的7个特点:</p>
<ol>
<li>工作紧迫感</li>
<li>善于捕捉问题</li>
<li>思路清晰</li>
<li>用数据说话</li>
<li>果断</li>
<li>判断力</li>
<li>态度</li>
</ol>
<p>用户体验设计包含的方面:</p>
<ul>
<li>用户研究</li>
<li>交互设计</li>
<li>视觉设计</li>
<li>原型制作</li>
</ul>
<p>如果产品没有市场价值,那么无论开发团队多么优秀也无济于事.很多优秀的产品是程序员抓住用户需求,自己创业研发出来的.放宽眼界不仅仅有利于开发人员自己的职业发展,也有利于产品,顾客和公司.</p>
<p>关于留出时间调整代码的参考建议:</p>
<ol>
<li>针对开发团队确定的产品修改目标制定切实可行的计划和时间表</li>
<li>只要有可能,最好把重写目标分成几大块,实现递增修改,让用户感受到产品的改进,哪怕会因此把九个月的工作时间延长到两年,也一定要采用这种方式.</li>
<li>由于开发用户可见功能的资源有限,必须谨慎悬着正确的产品特性,确保产品定义的正确性</li>
</ol>
<p>产品经理应该有的特质:</p>
<ol>
<li>对产品的热情</li>
<li>用户立场</li>
<li>智力</li>
<li>职业操守</li>
<li>正直</li>
<li>信心</li>
<li>态度</li>
<li>技能</li>
<li>运用技术的能力</li>
<li>注意力</li>
<li>时间管理</li>
<li>沟通技能</li>
<li>商业技能</li>
</ol>
<p>产品总监的关键职责有两个方面.第一,组建优秀的产品经理团队.第二,规划公司的全局产品战略.</p>
<p><em>永远不要告诉别人怎么做,告诉他们做什么,他们自然会发挥天赋,给你惊喜. -巴顿</em></p>
<p>一定问明白客户”要做什么?” 而不是 “怎么做?”</p>
<p>管理上司的十条经验</p>
<ol>
<li>为项目波动做好准备</li>
<li>注意沟通的方式和频率</li>
<li>会前沟通</li>
<li>多用建议,少提问题</li>
<li>向上司借力</li>
<li>充分准备</li>
<li>缩短邮件篇幅</li>
<li>多用数据和事实说话</li>
<li>内部宣传</li>
<li>做让领导省心的员工</li>
</ol>
<h3 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h3><p>  为了评估产品机会,我要求产品经理回答如下是个问题:</p>
<ol>
<li>产品要解决什么问题? (产品价值)</li>
<li>为谁解决这个问题? (目标市场)</li>
<li>成功的机会有多大? (市场规模)</li>
<li>怎样判断产品成功与否? (度量指标)</li>
<li>有哪些同类产品? (竞品格局)</li>
<li>为什么我们最适合做这个产品? (竞争优势)</li>
<li>时机合适吗? (市场时机)</li>
<li>如何把产品推向市场? (营销组合策略)</li>
<li>成功的必要条件是什么? (解决方案要满足的条件)</li>
<li><p>根据以上问题,给出评估结论. (继续或放弃)</p>
<p>产品探索:采用流水线方式并行开发产品.也就是说,一点1.0产品进入项目执行阶段,就开始定义2.0版本的产品.</p>
</li>
</ol>
<h4 id="产品原则-确定什么最重要"><a href="#产品原则-确定什么最重要" class="headerlink" title="产品原则:确定什么最重要"></a>产品原则:确定什么最重要</h4><p>  每次加入新团队,我要做的第一件事就是制定产品原则.制定产品原则意味着决定什么重要,什么不重要,哪些原则是根本的,战略性的,哪些是临时的,战术性的.</p>
<p>  制定产品原则时容易出现两类错误.第一类是原则过于空泛,失去了指导作用.第二类是把设计原则误当成产品原则,比如,为用户提供清晰的导航路径(方便用户完成下一步操作)属于常见的设计原则,不是产品原则.</p>
<p>  在作产品决策之前,应该先确定决策要解决什么问题,让大家在一下几个要点上达成共识:</p>
<ol>
<li>究竟要解决什么问题</li>
<li>要为哪类人物角色解决这个问题</li>
<li>产品要达到什么目标</li>
<li>每项目标的优先级是什么</li>
</ol>
<h4 id="市场调研的工具和方法"><a href="#市场调研的工具和方法" class="headerlink" title="市场调研的工具和方法"></a>市场调研的工具和方法</h4><ul>
<li>用户调查</li>
<li>产品使用分析</li>
<li>数据挖掘</li>
<li>拜访用户</li>
<li>人物角色</li>
<li>可用性测试</li>
<li>同类产品分析</li>
</ul>
<p>合理的利用市场调研工具和方法可以回答一下几个关键问题:</p>
<ol>
<li>谁是目标用户?</li>
<li>用户会怎样使用产品?</li>
<li>用户能想明白怎样使用产品吗?障碍在哪里?</li>
<li>用户为什么选用你的产品?</li>
<li>用户喜欢产品的哪些特点?</li>
<li>用户希望如何改进产品,增加哪些功能?</li>
</ol>
<p>成功的产品基于以下两点认识:深入理解用户需求,以及明白什么样的解决方案在现阶段是可行的.</p>
<p>基本产品:定义最满足基本要求(价值,可用性,可行性)的产品.</p>
<p>设计产品时一定要考虑哪些功能是最重要的,争取设计出只满足基本要求的,不可删减的产品.</p>
<h4 id="改进现有产品"><a href="#改进现有产品" class="headerlink" title="改进现有产品"></a>改进现有产品</h4><p>能提高指标的功能才是你关注的重点.你应该找准方向,分析关键指标,有正对性的改进产品.</p>
<h4 id="快速响应阶段"><a href="#快速响应阶段" class="headerlink" title="快速响应阶段"></a>快速响应阶段</h4><p>关键不在于是否会出现问题,而在于能 <em>多快</em> 解决问题.</p>
<h4 id="在大公司施展拳脚"><a href="#在大公司施展拳脚" class="headerlink" title="在大公司施展拳脚"></a>在大公司施展拳脚</h4><ol>
<li>了解公司制定决策的方式</li>
<li>建立人脉网络</li>
<li>臭鼬工程</li>
<li>自己顶上</li>
<li>有选择的据理力争</li>
<li>会前沟通,形成默契</li>
<li>合理分配时间</li>
<li>分享信息</li>
<li>向上司借力</li>
<li>传播你的产品理念</li>
</ol>
<h3 id="产品"><a href="#产品" class="headerlink" title="产品"></a>产品</h3><h4 id="新技术层出不穷"><a href="#新技术层出不穷" class="headerlink" title="新技术层出不穷"></a>新技术层出不穷</h4><p>成功的产品往往不是新鲜事物,只是新瓶装老酒,之所以成功,是因为这个”新瓶”做的更好,更方便,更便宜,改变了消费者对”老酒”的印象.</p>
<p>现在成熟的市场上抢占一席之地,精明的公司至少要手握2两件”法宝”:</p>
<ol>
<li>对目标市场的了如指掌,对现有产品的缺陷洞若观火.</li>
<li>跟踪最新的技术趋势</li>
</ol>
<h4 id="情感接纳曲线"><a href="#情感接纳曲线" class="headerlink" title="情感接纳曲线"></a>情感接纳曲线</h4><p>根据消费者的情感特征,把他们分为技术爱好者,非理性消费者,理性消费者,超理性消费者和观望者.</p>
<p>非理性消费者最值得产品经理注意.</p>
<p>如果你带着新生的感觉去发掘每天折磨着大众的感情-孤独,恐惧,挫折,不满,你离发现新产品的日子就不远了.</p>
<h4 id="最佳实践经验"><a href="#最佳实践经验" class="headerlink" title="最佳实践经验"></a>最佳实践经验</h4><p>大大要点:</p>
<ol>
<li>产品管理的职责</li>
<li>用户体验</li>
<li>机会评估</li>
<li>特约用户</li>
<li>产品原则</li>
<li>任务角色</li>
<li>探索(定义)产品</li>
<li>使用原型</li>
<li>用户参与原型测试</li>
<li>根据数据改进产品</li>
</ol>
<h4 id="产品经理的反省清单"><a href="#产品经理的反省清单" class="headerlink" title="产品经理的反省清单"></a>产品经理的反省清单</h4><p>十大问题:</p>
<ol>
<li>产品能吸引目标消费者的关注吗?</li>
<li>产品的设计是否人性化,是否易于操作?</li>
<li>产品能在竞争中取胜吗?即使是面对未来风云变化的市场,依旧有取胜的把握吗?</li>
<li>我了解目标用户吗?产品(不是理性的产品,而是开发出来的产品)是否能得到他们的认可?</li>
<li>产品是否有别于市场上的其他产品?我能在两分钟内向公司高管清楚的阐明这些差别吗?能在一分钟内向客户解释清楚吗?能在半分钟内向经验丰富的行业分析师解释清楚吗?</li>
<li>产品能正产运行吗?</li>
<li>产品是否完整?用户对产品的印象如何?销售业绩如何?销售任务能否顺利完成?</li>
<li>产品的特设首付与目标用户的需求一致?产品特色是否鲜明?</li>
<li>产品值钱吗?值多少钱?为什么值这么多钱?用户会选择更便宜的产品吗?</li>
<li>我了解其他团队成员对产品的看法吗?他们觉得产品好在哪里?他们的看法是否与我的观点一致?</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/01/24/2017/读书笔记/启示录-打造用户喜爱的产品/" data-id="cizy53xst002n3us62ztf65i6" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2017/androidSwipeLayout源码分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/23/2017/androidSwipeLayout源码分析/" class="article-date">
  <time datetime="2017-01-23T07:19:00.000Z" itemprop="datePublished">2017-01-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/23/2017/androidSwipeLayout源码分析/">androidSwipeLayout源码分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="android-SwipeLayout源码分析"><a href="#android-SwipeLayout源码分析" class="headerlink" title="android SwipeLayout源码分析"></a>android SwipeLayout源码分析</h2><p>swipeLayout是代码家写的一个支持手势滑动的开源库,初看的时候感觉特别惊艳,用户体验也非常的棒,特别好奇是怎么实现的,故抽时间研究了下.<br>通过分析代码结构得出swipeLayout主要分为三大部分:</p>
<ol>
<li>内部view初始设置</li>
<li>内部ViewDragHelper的callback实现</li>
<li>冲突解决与注意事项</li>
</ol>
        
          <p class="article-more-link">
            <a href="/2017/01/23/2017/androidSwipeLayout源码分析/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/01/23/2017/androidSwipeLayout源码分析/" data-id="cizy53xrg001v3us6mcuu0rjd" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2017/android自定义gradle插件" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/23/2017/android自定义gradle插件/" class="article-date">
  <time datetime="2017-01-23T05:31:00.000Z" itemprop="datePublished">2017-01-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/23/2017/android自定义gradle插件/">android自定义gradle插件</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="android自定义gradle插件"><a href="#android自定义gradle插件" class="headerlink" title="android自定义gradle插件"></a>android自定义gradle插件</h2><p>  在android学习过程中,理解gradle的编译过程是非常重要的,我们可以通过自定义gradle插件来达到在编译打包的过程中人工参与其中的一部分工作,这样可以满足我们的各种需求,比如在编译之前要对所有的class做统一处理,比如打包完成之后要输出到指定的目录,这些都可以通过自定义的gradle插件来完成.</p>
<p>  下面讲解下如何在android studio中实现自定义的gradle插件</p>
<h2 id="在当前工程的gradle文件中实现插件"><a href="#在当前工程的gradle文件中实现插件" class="headerlink" title="在当前工程的gradle文件中实现插件"></a>在当前工程的gradle文件中实现插件</h2><p>  gradle插件理论上就是通过groovy语法实现的类,内部可以制定一些流程task来完成相应的工作.最简单的肯定是在当前工程的 <em>build.gradle</em> 文件中直接实现插件内容.因为实际上 <em>build.gralde</em> 就是一个groovy文件.</p>
<p>  在我们的android主工程目录中输入一下代码:</p>
  <figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"> <span class="class"><span class="keyword">class</span> <span class="title">GreetingPlugin</span> <span class="keyword">implements</span> <span class="title">Plugin</span>&lt;<span class="title">Project</span>&gt; &#123;</span></div><div class="line"></div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="keyword">void</span> apply(Project project) &#123;</div><div class="line">       project.extensions.create(<span class="string">"greeting"</span>, GreetingPluginExtension)</div><div class="line">       project.task(<span class="string">'hello'</span>) &#123;</div><div class="line">           doLast &#123;</div><div class="line">               println <span class="string">"$&#123;project.greeting.message&#125; from $&#123;project.greeting.greeter&#125;"</span></div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">GreetingPluginExtension</span> &#123;</span></div><div class="line">   String message = <span class="string">'Hello from GreetingPlugin'</span></div><div class="line">   String greeter</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> 这里首先是实现一个plugin接口,这个接口是所有的自定义插件的必须实现的.完成里面的 <em>apply</em> 方法,这里用到了一个 <em>extensions</em> 的概念,这个 <em>extensions</em> 是用来给工程project设置一些额外属性的对象.比如我们在android的 <em>build.gradle</em> 文件中经常看到的<br> <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">android&#123;</div><div class="line">  ....</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p> 这个 <em>android{}</em> 内部就是给工程中设置的一些参数.在咱们这里的设置的是 <em>extensions</em> 叫 <em>GreetingPluginExtension</em> ,内部定义了两个参数 <em>message</em> 和 <em>greeter</em> 这里前一个参数有默认值,后一个没有,其实groovy和java的语法基本上一样的,只不过groovy是动态的java.</p>
<p>接着看plugin中的 <em>apply</em> 方法,非常的简单就是定义一个名叫 <em>hello</em> 的 <em>task</em> ,然后在里面打印一下  <em>GreetingPluginExtension</em> 中的两个参数.那在 <em>build.gradle</em> 中如何设置对应的参数呢?看下面的代码:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">greeting &#123;</div><div class="line">    message  &apos;Hi from gradle&apos;</div><div class="line">    greeter  &apos;Gradle&apos;</div><div class="line">&#125;</div><div class="line">```  </div><div class="line">就是这么简单直白.定义完成之后,我们直接在主目录下终端运行一下命令:</div></pre></td></tr></table></figure></p>
<p>./gradlew -q hello<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">可以看到在终端中输出:</div></pre></td></tr></table></figure></p>
<p>Hi from gradle from Gradle<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">是不是非常的简单呢.在当前工程中定义的插件只能自己用,如果要给别人用的话就需要通过一个单独的工程来生成插件了.</div><div class="line"></div><div class="line">### 在单独工程中创建自定义gradle插件</div><div class="line"></div><div class="line">首先在当前的工程中随便创建一个android module ,然后src/main目录下所有文件夹全部删除掉.然后先创建一个groovy文件夹,里面用来存放我们的插件groovy代码,一个是 *GreetingPluginExtension* ,一个是 *MyGradlePlugin* 内部代码分别对应上面的两个class.</div><div class="line"></div><div class="line">然后再创建一个 *resources* 文件夹,里面放入一个 *META-INFO* 文件夹,然后继续在 *META-INFO* 文件夹下创建 *gradle-pulgins* ,在 *gradle-pulgins* 下创建文件</div><div class="line">*com.justyan.gradle.properties* 文件,文件内容为:</div></pre></td></tr></table></figure></p>
<p>implementation-class = com.justyan.gradleplugin.MyGradlePlugin<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">这里的 *com.justyan.gradle.properties* 文件的 *com.justyan.gradle* 就是你以后要给其他工程引用的的 gradle ID.比如这样:</div></pre></td></tr></table></figure></p>
<p>apply plugin: ‘com.justyan.gradle’<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">这个名称你可以随便起,只要在引用的时候引用对了就ok.文件中内容的目的是指定了插件的类路径,这里就是groovy文件下的那两个groovy文件.</div><div class="line"></div><div class="line">最后的文件目录应该是这样的:</div><div class="line">![插件工程的目录结构](images/2017/01/android自定义gradle插件的目录结构.png)</div><div class="line"></div><div class="line">这里的 *META-INFO* 和 *gradle-pulgins* 是android studio给合并显示了,实际上是一个层级关系.</div><div class="line"></div><div class="line">这样插件代码就完成了,剩下的就是如果打包发布的问题了.</div><div class="line"></div><div class="line">在创建的插件的module工程中的 *build.gradle* 文件中输入一下内容:</div></pre></td></tr></table></figure></p>
<p>apply plugin: ‘groovy’<br>apply plugin: ‘maven’</p>
<p>version = ‘1.0.0’<br>group = ‘com.justyan’<br>archivesBaseName = ‘mygradleplugin’<br>repositories {<br>    mavenCentral()<br>}</p>
<p>dependencies {<br>    compile gradleApi()<br>    compile localGroovy()<br>}<br>// 一定要记得使用交叉编译选项，因为我们可能用很高的JDK版本编译，为了让安装了低版本的同学能用上我们写的插件，必须设定source和target<br>compileGroovy {<br>    sourceCompatibility = 1.7<br>    targetCompatibility = 1.7<br>    options.encoding = “UTF-8”<br>}<br>uploadArchives {<br>    repositories {<br>        mavenDeployer {<br>            repository(url: “file:////Users/justyan/Downloads/repo”)<br>        }<br>    }<br>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">version用来表示maven生成的jar包版本号,group表示属于哪个组织, *archivesBaseName* 表示生成的java的名称.最后在 *uploadArchives* 中指定了生成的maven目录在哪里.这个目录你可以随意指定,只要后续引用的时候前后一致就可以.</div><div class="line"></div><div class="line">完成这个之后,我们调用这个工程的 *uploadArchives* task:</div></pre></td></tr></table></figure>
<p>./gradlew -q uploadArchives<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">然后就会在上面的指定目录下生成对应的maven文件了.</div><div class="line"></div><div class="line">最后,来看下如何在其他工程中引用.</div><div class="line"></div><div class="line">在要引用的工程的顶层目录的 *build.gralde* 文件中输入:</div></pre></td></tr></table></figure></p>
<p>buildscript {<br>    repositories {<br>        jcenter()<br>        maven {<br>            url uri(‘file:////Users/justyan/Downloads/repo’)<br>        }<br>    }<br>    dependencies {<br>        classpath ‘com.android.tools.build:gradle:2.2.2’<br>        classpath group: ‘com.justyan’, name: ‘mygradleplugin’,<br>                version: ‘1.0.0’<br>        // NOTE: Do not place your application dependencies here; they belong<br>        // in the individual module build.gradle files<br>    }<br>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">首先指定maven文件目录,和上面的对应,然后在 *dependencies* 中输入组名,插件名,版本号.这样对插件的引用就完成了.最后在要使用的工程中的 *build.gralde* 文件中顶部输入:</div></pre></td></tr></table></figure>
<p>apply plugin: ‘com.justyan.gradle’<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">然后用android studio同步一下gradle就可以了.这个时候在旁边的gradle project中是可以看到 *hello* 这个task的,表明插件加载成功.</div><div class="line">![task列表](images/2017/01/gradle project中的新增的task.png)</div><div class="line"></div><div class="line">最后如果我们要使用这个task和上面的方法一样,在终端中输入:</div></pre></td></tr></table></figure></p>
<p>./gradlew -q hello<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">可以看到在终端中输出:</div></pre></td></tr></table></figure></p>
<p>Hi from gradle from Gradle<br>```<br>这样自定义插件就全部搞定了,后续可以根据需求来自己实现插件中的内容了.</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a href="https://docs.gradle.org/current/userguide/custom_plugins.html" title="cutom_plugin" target="_blank" rel="external">cutom_plugin</a></p>
<p><a href="https://gold.xitu.io/entry/577bc26e165abd005530ead8" title="在 Android Studio 中自定义 Gradle 插件" target="_blank" rel="external">在 Android Studio 中自定义 Gradle 插件</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/01/23/2017/android自定义gradle插件/" data-id="cizy53xrc001t3us6kh1enj4e" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2017/读书笔记/富爸爸 穷爸爸读书笔记" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/23/2017/读书笔记/富爸爸 穷爸爸读书笔记/" class="article-date">
  <time datetime="2017-01-23T00:47:00.000Z" itemprop="datePublished">2017-01-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/23/2017/读书笔记/富爸爸 穷爸爸读书笔记/">富爸爸 穷爸爸 读书笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="富爸爸-穷爸爸-读书笔记"><a href="#富爸爸-穷爸爸-读书笔记" class="headerlink" title="富爸爸 穷爸爸 读书笔记"></a>富爸爸 穷爸爸 读书笔记</h2><p> 我一个爸爸总是习惯对说”我可付不起”,而另一个爸爸则禁止我们说这样的话,他坚持让我们说:”我怎样才能付得起?” 这两句话,一句是陈述句,一句是疑问句.一句让你放弃,而另一句则促使你去想办法.我那个在不久之后就富起来的爸爸解释,当你下意识的说出”我付不起”的时候,你的大脑就会停止思考,而如果你自问”我怎么才能付得起”,则会让你的大脑动起来.</p>
<p> 富爸爸说:”我的大脑越用越活,大脑越活,我挣点钱就越多”.他认为,下意识的说”我可付不起”意味着精神上的懒惰.</p>
<p> 在遇到钱的问题时,一个爸爸习惯于逃避,另一个爸爸则总是想办法解决问题.长此以往,其结果就是,一个爸爸的理财能力越来越弱,而另一个爸爸的理财能力越来越强.这种结果类似于一个经常去健身房锻炼的人与一个总坐在沙发上看电视的人在体质上的不同变化.适当的体育锻炼可以增加获得健康的机会,同时,适当的脑力训练可以增加获得财富的机会.懒惰必定会让你的体质变弱,财富减少.</p>
<p> 我得说生活才是最好的老师.大多数的时候,生活不会和你说什么,只会推着你转,每一次推,它都像是在说: “喂,醒一醒,我要让你学点东西.”<br>
        
          <p class="article-more-link">
            <a href="/2017/01/23/2017/读书笔记/富爸爸 穷爸爸读书笔记/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/01/23/2017/读书笔记/富爸爸 穷爸爸读书笔记/" data-id="cizy53xsv002p3us6129dbwwp" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2017/读书笔记/&lt;搞定-无压工作的艺术&gt;" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/21/2017/读书笔记/<搞定-无压工作的艺术>/" class="article-date">
  <time datetime="2017-01-21T04:06:00.000Z" itemprop="datePublished">2017-01-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/21/2017/读书笔记/<搞定-无压工作的艺术>/">&lt;搞定-无压工作的艺术&gt;</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="搞定-无压工作的艺术"><a href="#搞定-无压工作的艺术" class="headerlink" title="搞定-无压工作的艺术"></a>搞定-无压工作的艺术</h2><h3 id="原则-有效处理内心的承诺"><a href="#原则-有效处理内心的承诺" class="headerlink" title="原则:有效处理内心的承诺"></a>原则:有效处理内心的承诺</h3><blockquote>
<p>任何事情如果没有找到应有的位置和恰当存在方式的事物,都会pa盘踞在我们的脑海中,成为悬而未决的问题</p>
</blockquote>
<p>为了能够高效应对这一问题,首先,你必须明确并收集所有那些”进场唤醒你模糊记忆”的事情,搞定他们对你而言的真正意义,然后决定如何推动它们.</p>
<h3 id="管理承诺时的基本要求"><a href="#管理承诺时的基本要求" class="headerlink" title="管理承诺时的基本要求"></a>管理承诺时的基本要求</h3><p>如果希望出色地管理好所有的工作,那么,你需要做到以下几点:</p>
<ol>
<li>如果这件事总是占据你的大脑,你的思维就会受阻.任何一件你认为还没有完成的事情,都必须被置于一个客观,可靠地体系中,后者是我成为”文件夹”的工具之中–必须经常回访并予以清理.</li>
<li>在明白你的工作到底是什么后,你还必须做出判断:需要采取什么行动来推动工作进程</li>
<li>一旦决定了需要采取的行动方案,你必须在某一个你经常查阅的系统中保存好与这些行动相关的提示信息.</li>
</ol>
<h3 id="检验这种模式的一个重要训练"><a href="#检验这种模式的一个重要训练" class="headerlink" title="检验这种模式的一个重要训练"></a>检验这种模式的一个重要训练</h3><blockquote>
<p>像实干家一样思考,像思想家一样行动</p>
</blockquote>
<p>思考,需要构建以结果和行动为导向的思维方式.</p>
<h3 id="为什么有些事总是萦绕在我们的心头"><a href="#为什么有些事总是萦绕在我们的心头" class="headerlink" title="为什么有些事总是萦绕在我们的心头"></a>为什么有些事总是萦绕在我们的心头</h3><p>通常情况下,你对一些事情总是念念不忘,这是因为你希望他们的情况能有所改善,另外:</p>
<ul>
<li>你还没有明确的认定它们的预期结果是什么.</li>
<li>你还没有确定你下一步的具体行动是什么.</li>
<li>你还没有把关于预期结果和即将采取行动的提示信息存入你所依赖的系统中去.</li>
</ul>
<h3 id="“材料”的转化"><a href="#“材料”的转化" class="headerlink" title="“材料”的转化"></a>“材料”的转化</h3><p>“材料(stuff)”的定义:进入你的精神或现实世界中但尚未找到归属的任何事情,你尚未确定他对你的真正意义,预期结果和下一步具体行动的所有事情.</p>
<blockquote>
<p>我们需要把收集和积累的所有”材料”都转化成包含重要行动,项目和有用信息的明确清单.<br>当想法对行动具有推动作用的时候,它就是有益的;当想法成为行动的替代时,它就会成为行动的障碍.</p>
</blockquote>
<h3 id="过程-管理你的行动"><a href="#过程-管理你的行动" class="headerlink" title="过程:管理你的行动"></a>过程:管理你的行动</h3><p>你首先要养成一个习惯:清空你的大脑中的所有事物.</p>
<h3 id="管理行动的重要性"><a href="#管理行动的重要性" class="headerlink" title="管理行动的重要性"></a>管理行动的重要性</h3><p>问题的关键在于,他们无法断定到底要干些什么,下一步需要采取哪些行动.</p>
<h3 id="对行动的横向管理和纵向管理"><a href="#对行动的横向管理和纵向管理" class="headerlink" title="对行动的横向管理和纵向管理"></a>对行动的横向管理和纵向管理</h3><p>横向控制和纵向控制的目标是一致的:解除你的心理负担,并把事情做好.</p>
<h3 id="最重要的技巧-把一切事物赶出大脑"><a href="#最重要的技巧-把一切事物赶出大脑" class="headerlink" title="最重要的技巧:把一切事物赶出大脑"></a>最重要的技巧:把一切事物赶出大脑</h3><blockquote>
<p>通常,盘踞在你脑中问题的数量与解决问题的效率成反比<br>对一件事情不需要进行两次相同的思考,除非你喜欢重复思考<br>任何仅存于内心的”将会,可能或应该”性质的承诺,都会造成非理性和无法排解的全天候压力<br>思想上开小差,将是你最难战胜的敌人.</p>
</blockquote>
<h3 id="横向管理-横向管理工作流程的5个步骤"><a href="#横向管理-横向管理工作流程的5个步骤" class="headerlink" title="横向管理:横向管理工作流程的5个步骤"></a>横向管理:横向管理工作流程的5个步骤</h3><p>我们:(1)收集引起我们注意的事务和信息;(2)理清每个项目的意义和相关措施;(3)组织整理结果,提出选项;(4)进行思考回顾;(5)选择行动.这些阶段共同构成了我们生活中的横向管理系统,而且我们还可以随时向其中添加所需要考虑的新事项.</p>
<h3 id="收集阶段"><a href="#收集阶段" class="headerlink" title="收集阶段"></a>收集阶段</h3><h4 id="影响收集成功的因素"><a href="#影响收集成功的因素" class="headerlink" title="影响收集成功的因素"></a>影响收集成功的因素</h4><p>成功收集的三个必要条件:</p>
<ol>
<li>每一件悬而未决的事情都必须存储在你的收集系统中,而不是在你的大脑里</li>
<li>你应该尽可能地控制收集工具的数量,越少越好,够用即可</li>
<li>你必须定期清理这些设备</li>
</ol>
<h3 id="理清阶段"><a href="#理清阶段" class="headerlink" title="理清阶段"></a>理清阶段</h3><p>流程如下:</p>
<ol>
<li>它是什么?</li>
<li>是否需要采取行动?<ul>
<li>否<ol>
<li>无用的垃圾,根本没有必要保留</li>
<li>目前不需要,但日后可能需要处理(孵化)</li>
<li>项目具有潜在有用信息,日后可能会排上用场(参考)</li>
</ol>
</li>
<li>是<ol>
<li>你承诺完成哪些工作?达成哪些目标?(项目)</li>
<li>下一步需要采取什么行动?<ul>
<li>立即执行</li>
<li>指派他人<ol>
<li>等待别人完成</li>
</ol>
</li>
<li>延迟处理<ol>
<li>日程表(指定时间完成)</li>
<li>下一步行动(需要尽快完成的行动)<h3 id="组织整理阶段"><a href="#组织整理阶段" class="headerlink" title="组织整理阶段"></a>组织整理阶段</h3>对你那些可以付诸行动的事物,你需要:一个项目清单,一个保存项目规划和资料的存储系统,一个日程表,一个下一步行动清单,以及一个等待清单(清单中包含的内容是那些等待别人完成的任务)</li>
</ol>
</li>
</ul>
</li>
</ol>
</li>
</ul>
</li>
</ol>
<h4 id="项目"><a href="#项目" class="headerlink" title="项目"></a>项目</h4><p>项目就是任何一个需要多个步骤才能完成的任务.<br>我们可以将项目视为一系列未尽之事.</p>
<h4 id="下一步行动的归类"><a href="#下一步行动的归类" class="headerlink" title="下一步行动的归类"></a>下一步行动的归类</h4><h5 id="日程表"><a href="#日程表" class="headerlink" title="日程表"></a>日程表</h5><p>你的日程表上应该标注三种情况:</p>
<ul>
<li>需要在指定时间执行的行动</li>
<li>需要在制定日期执行的行动</li>
<li>需要在指定日期获取的信息</li>
</ul>
<h3 id="回顾阶段"><a href="#回顾阶段" class="headerlink" title="回顾阶段"></a>回顾阶段</h3><p>如果你按照我所推荐的方法建立起个人的组织整理系统,那么拥有一个”项目”清单,一个日程表,”下一步行动”清单(一个或多个)和一个”等待处理”清单就是回顾的全部内容.<br>成功的关键因素:每周回顾<br>每周回顾应该完成以下任务:</p>
<ul>
<li>收集和加工处理所有的”材料”</li>
<li>回顾整个系统</li>
<li>更新各种清单</li>
<li>做到彻底,清楚,实时和完整</li>
</ul>
<h3 id="执行阶段"><a href="#执行阶段" class="headerlink" title="执行阶段"></a>执行阶段</h3><h4 id="确定某一个时刻具体行动的”四标准法”"><a href="#确定某一个时刻具体行动的”四标准法”" class="headerlink" title="确定某一个时刻具体行动的”四标准法”"></a>确定某一个时刻具体行动的”四标准法”</h4><ol>
<li>情景</li>
<li>有多少时间</li>
<li>有多少精力</li>
<li>重要性</li>
</ol>
<h3 id="确认每日工作的”三分类法”"><a href="#确认每日工作的”三分类法”" class="headerlink" title="确认每日工作的”三分类法”"></a>确认每日工作的”三分类法”</h3><ol>
<li>执行实现安排好的工作</li>
<li>处理突发事件</li>
<li>安排自己的工作</li>
</ol>
<h3 id="总体检视工作的-“六层分发”"><a href="#总体检视工作的-“六层分发”" class="headerlink" title="总体检视工作的 “六层分发”"></a>总体检视工作的 “六层分发”</h3><ul>
<li>5楼视野:目的和原则</li>
<li>4楼视野:愿景</li>
<li>3楼视野:目标</li>
<li>2楼视野:关注点及责任范围</li>
<li>1楼视野:当前项目</li>
<li>地面:当前行动</li>
</ul>
<h3 id="控制项目-纵向管理项目的5个阶段"><a href="#控制项目-纵向管理项目的5个阶段" class="headerlink" title="控制项目:纵向管理项目的5个阶段"></a>控制项目:纵向管理项目的5个阶段</h3><p>轻松自如的控制一切的关键是:(1) 明确判定工作的预期结果(目标)以及为实现目标所需要执行的下一步具体行动.(2) 把一切尚未解决的工作的提示信息安置在一个完善可靠的系统中,并定期回顾和审阅.</p>
<p>人的大脑在面对任何一项任务的时候,都要经过5个步骤:</p>
<ol>
<li>定义目标和原则</li>
<li>展望结果</li>
<li>头脑风暴/集思广益</li>
<li>组织整理</li>
<li>明确下一步的行动方案</li>
</ol>
<p>重视原则的另一个重要原因:它能为我们的行为提供清晰明确地指导</p>
<h4 id="头脑风暴的关键技巧"><a href="#头脑风暴的关键技巧" class="headerlink" title="头脑风暴的关键技巧"></a>头脑风暴的关键技巧</h4><p>这些基本的原则可以归纳为以下3点:</p>
<ul>
<li>不判断,不质疑,不评估,不批判</li>
<li>追求数量,不求质量</li>
<li>把分析组织工作置于次要的地位</li>
</ul>
<h4 id="组织整理的基本要点"><a href="#组织整理的基本要点" class="headerlink" title="组织整理的基本要点"></a>组织整理的基本要点</h4><p>组织整理的关键步骤如下:</p>
<ul>
<li>明确事件的重要组成部分</li>
<li>整理分类(按照下面一个或多个标准)<ul>
<li>构成因素</li>
<li>先后顺序</li>
<li>重要程度</li>
</ul>
</li>
<li>足够详细的描述</li>
</ul>
<p>这两个基本层面就是:我们要执行的行动和我们正在推进的项目(折现项目催动了行动).<br>这些模式有一些基本原则- 你必须收集生活中所有悬而未决的问题;然后对这些问题进行预判和处理,并确定下一步行动;接着对这些行动进行组织整理,回顾,最后付诸实施.</p>
<p>处理阶段的方法指导<br>学习的最佳途径是实践.但是,在开始之前,我还要强调几个基本原则:</p>
<ol>
<li>首先要处理工作篮中最上面的事务</li>
<li>一次一事</li>
<li>永远不要把事务再次放回工作篮</li>
</ol>
<p>下一步行动必须是可执行的具体行动</p>
<p>如果某个”下一步行动”的用时不会超过两分钟,那么不要犹豫,立刻动手完成它.</p>
<h4 id="为你创造性的想象力创建一个清单"><a href="#为你创造性的想象力创建一个清单" class="headerlink" title="为你创造性的想象力创建一个清单"></a>为你创造性的想象力创建一个清单</h4><p>典型的事情包括有:</p>
<ul>
<li>为你的家庭购买或者建造房屋</li>
<li>开始从事的业余爱好</li>
<li>想要学习的技能</li>
<li>想要表达的创意</li>
<li>需要购买的服装和饰品</li>
<li>想要得到的玩物(高科技或其他类型的玩具!)</li>
<li>计划中的旅行</li>
<li>打算参与的公益性活动</li>
<li>想了解的事情,想做的事情</li>
</ul>
<h4 id="每周回顾"><a href="#每周回顾" class="headerlink" title="每周回顾"></a>每周回顾</h4><p>如果你拥有自己独立的工作空间,你就可以让自己免于外界的干扰;如果你的工作是周一至周五的标准五天制,那么我建议你在最后工作日下午留出两个小时的时间,专门用于每周回顾.</p>
<h3 id="大局的回顾"><a href="#大局的回顾" class="headerlink" title="大局的回顾"></a>大局的回顾</h3><p>无论是在生活还是工作中,如何找出合适的范围,如果做出合适的决定,如何确定合理的时间间隔,都只有一个标准,就是让你自己感到一切清清楚楚就可以了.这是对你的终身邀约,也是你的终生义务,旨在让你实现所有未竟使命或者意向.</p>
<h3 id="检视工作"><a href="#检视工作" class="headerlink" title="检视工作"></a>检视工作</h3><p>你就有必要考虑一下,要做些什么才能让自己在这条路上走的更远,更好.因此,你应该对自己提出的问题是:</p>
<ol>
<li>我们机构的长期目标和目的是什么?为了履行我的责任,我需要完成哪些相关的项目?</li>
<li>我为自己设定的长期目标和目的是什么?为达成此目标,我改执行哪些项目?</li>
<li>还发生了哪些可能影响到我的行动的重大事情?</li>
</ol>
<h3 id="哪些项目需要你进行计划"><a href="#哪些项目需要你进行计划" class="headerlink" title="哪些项目需要你进行计划?"></a>哪些项目需要你进行计划?</h3><ol>
<li>那些你已经决定了下一步行动,却依然吸引你注意力的事务</li>
<li>那些意外冒出的新点子或临时出现新细节的项目</li>
</ol>
<h3 id="找出需要执行的”下一步行动”"><a href="#找出需要执行的”下一步行动”" class="headerlink" title="找出需要执行的”下一步行动”"></a>找出需要执行的”下一步行动”</h3><p>从最基础的层面入手,定义出行动的具体计划,并将行动提示信息有效地组织和管理起来,这是我们提高工作效率,营造轻松内循环境的关键.</p>
<h3 id="学会关注结果"><a href="#学会关注结果" class="headerlink" title="学会关注结果"></a>学会关注结果</h3><p>处理日常事务时一个重要的技巧就是:学会在脑海中对结果做出正面的预期,并以此影响实践.</p>
<h3 id="预期结果的重要性"><a href="#预期结果的重要性" class="headerlink" title="预期结果的重要性"></a>预期结果的重要性</h3><p>生活中只存在两个问题:(1) 你知道你想要达成的目标,但是不知道如何达成它; (2) 你不知道你的目标到底是上面.<br>也就存在两种解决方法:</p>
<ul>
<li>找到你的目标(结果)</li>
<li>找到具体的方法(行动)</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/01/21/2017/读书笔记/<搞定-无压工作的艺术>/" data-id="cizy53xsq002l3us68agm82g7" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2017/java反射相关知识" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/19/2017/java反射相关知识/" class="article-date">
  <time datetime="2017-01-19T07:16:00.000Z" itemprop="datePublished">2017-01-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/19/2017/java反射相关知识/">java反射相关知识</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="java反射相关知识"><a href="#java反射相关知识" class="headerlink" title="java反射相关知识"></a>java反射相关知识</h2><h3 id="Class-getDeclaringClass-和-Class-getEnclosingClass的区别"><a href="#Class-getDeclaringClass-和-Class-getEnclosingClass的区别" class="headerlink" title="Class.getDeclaringClass 和 Class.getEnclosingClass的区别"></a>Class.getDeclaringClass 和 Class.getEnclosingClass的区别</h3><p>getDeclaringClass表示这个内的声明类是那个,常用于获取在当前中声明的内部类<br>getEnclosingClass表示获取当前类的外部调用类,也可以用于在内部类中获取外部类.<br>二者的区别在于匿名内部类,如果这个类不是在当前类中声明,那么getDeclaringClass返回null,而getEnclosingClass返回外层类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestClassReflection</span></span>&#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchFieldException </span>&#123;</div><div class="line">         <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">             <span class="meta">@Override</span></div><div class="line">             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                 Class&lt;? extends Runnable&gt; aClass = <span class="keyword">this</span>.getClass();</div><div class="line">                 Class&lt;?&gt; declaringClass2 = aClass.getDeclaringClass();</div><div class="line">                 Class&lt;?&gt; enclosingClass1 = aClass.getEnclosingClass();</div><div class="line">                 System.out.println(<span class="string">"declaringClass2 = "</span>+declaringClass2);</div><div class="line">                 System.out.println(<span class="string">"enclosingClass1 = "</span>+enclosingClass1);</div><div class="line">             &#125;</div><div class="line">         &#125;).start();</div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">declaringClass2 = null</div><div class="line">enclosingClass1 = class com.justyan.reflection.TestClassReflection</div></pre></td></tr></table></figure>
<h3 id="打印出继承关系"><a href="#打印出继承关系" class="headerlink" title="打印出继承关系"></a>打印出继承关系</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printAncestor</span><span class="params">(Class aclass, ArrayList&lt;Class&gt; list)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (aclass != <span class="keyword">null</span>) &#123;</div><div class="line">           Class superclass = aclass.getSuperclass();</div><div class="line">           <span class="keyword">if</span> (superclass != <span class="keyword">null</span>) &#123;</div><div class="line">               list.add(superclass);</div><div class="line">               printAncestor(superclass, list);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>最后把所有的父类都在list中.</p>
<h3 id="Class-getGenericInterfaces方法和Class-getInterfaces方法的区别"><a href="#Class-getGenericInterfaces方法和Class-getInterfaces方法的区别" class="headerlink" title="Class.getGenericInterfaces方法和Class.getInterfaces方法的区别"></a>Class.getGenericInterfaces方法和Class.getInterfaces方法的区别</h3><p>getGenericInterfaces返回所有的实现接口,包含接口的泛型<br>getInterfaces返回所有的接口class对象,不包含泛型信息</p>
<h3 id="Class-getTypeParameters-方法"><a href="#Class-getTypeParameters-方法" class="headerlink" title="Class.getTypeParameters 方法"></a>Class.getTypeParameters 方法</h3><p>getTypeParameters返回类的泛型信息</p>
<h3 id="Class-getDeclaredMethods-和-Class-getMethods-区别"><a href="#Class-getDeclaredMethods-和-Class-getMethods-区别" class="headerlink" title="Class.getDeclaredMethods 和 Class.getMethods 区别"></a>Class.getDeclaredMethods 和 Class.getMethods 区别</h3><p>这类前面加了 <em>Declared</em> 的方法,只是获取当前类的成员,不包含父类的相关成员<br>而getMethods会获取所有的方法</p>
<h3 id="Class-getFields和Class-getDeclaredFields"><a href="#Class-getFields和Class-getDeclaredFields" class="headerlink" title="Class.getFields和Class.getDeclaredFields"></a>Class.getFields和Class.getDeclaredFields</h3><p>getFields获取当前类所有的 <em>public</em> 属性<br>getDeclaredFields返回当前类所有的属性<br>下面的话摘自官方教程</p>
<blockquote>
<p>Tip: The Class.getField() and Class.getFields() methods return the public member field(s) of the class, enum, or interface represented by &gt;the Class object. To retrieve all fields declared (but not inherited) in the Class, use the Class.getDeclaredFields() method.</p>
</blockquote>
<h3 id="反射中获取method参数的相关属性"><a href="#反射中获取method参数的相关属性" class="headerlink" title="反射中获取method参数的相关属性"></a>反射中获取method参数的相关属性</h3><p>method.getParameters用来获取该方法的所有参数.返回一个 <em>Parameter[]</em> 数组.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printParam</span><span class="params">(Method declaredMethod)</span> </span>&#123;</div><div class="line">    Parameter[] parameters = declaredMethod.getParameters();</div><div class="line">    <span class="keyword">for</span> (Parameter parameter : parameters) &#123;</div><div class="line">        System.out.println(parameter.getType());</div><div class="line">        System.out.println(parameter.getName());</div><div class="line">        System.out.println(parameter.getModifiers());</div><div class="line">        System.out.println(parameter.isImplicit());</div><div class="line">        System.out.println(parameter.isNamePresent());</div><div class="line">        System.out.println(parameter.isSynthetic());</div><div class="line">    &#125;</div><div class="line">    System.out.println(<span class="string">"-------------------------"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>分别来解释下这几个方法的用法:</p>
<ol>
<li><em>getType</em> 获取参数类型,比如int,java.lang.String等</li>
<li><em>getName</em> 获取参数名称,这里有个问题要注意,默认情况下获取到的参数都是 <em>arg0</em> ,<em>arg1</em> 等这样的系统生成的参数名称,是获取不到原始的命名的,这样做的目的是为了节约class文件的空间.如果想要获取到原始参数名称,需要在编译的 <em>javac</em> 后面加上 <em>-parameters</em> 参数.</li>
<li><p><em>getModifiers</em> 是一个int值,是把下面要3种情况相加得出的.<br><img src="/images/2017/01/method的modifiers属性说明.png" alt="modifiers属性说明"></p>
</li>
<li><p><em>isImplicit</em> 和 <em>isSynthetic</em> 下面重点来讲一下</p>
</li>
<li><em>isNamePresent</em> 对应上面的 <em>getName</em> 的情况,如果是从显示的原始的class中参数命名就是true,如果是编译器生成的 <em>arg0</em> 这种方式就是 false.</li>
</ol>
<h4 id="isImplicit-和-isSynthetic"><a href="#isImplicit-和-isSynthetic" class="headerlink" title="isImplicit 和 isSynthetic"></a><em>isImplicit</em> 和 <em>isSynthetic</em></h4><p>先来看 <em>isImplicit</em> 通过字面理解就是 <em>含蓄的,隐式的</em> ,也就是说这个方法并没有在代码中直接声明,确实是存在的.对应的正常情景就是内部类对外部类的引用.我们都知道 <em>非静态</em> 内部类是对外部类有一个引用的.那么编译器在编译的时候生成的内部类的构造方法中是会有一个外部类的对象引用的.就想下面这样:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodParameterExamples</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InnerClass</span> </span>&#123; &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodParameterExamples</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InnerClass</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> MethodParameterExamples parent;</div><div class="line">        InnerClass(<span class="keyword">final</span> MethodParameterExamples <span class="keyword">this</span>$<span class="number">0</span>) &#123;</div><div class="line">            parent = <span class="keyword">this</span>$<span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>innerClass的默认构造函数其实是对外部的MethodParameterExamples有一个引用的,那么innerClass这个默认的构造方法的 <em>isImplicit</em> 属性就是true.</p>
<p>再来看,如果一个方法既不是显式的也不是隐式的而是通过编译器生成的,那么这个 <em>isSynthetic</em> 属性就为true.经典的用在枚举类型中<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodParameterExamples</span> </span>&#123;</div><div class="line">    <span class="keyword">enum</span> Colors &#123;</div><div class="line">        RED, WHITE;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果答应这里Colors类对象的话,会发现其内部是这样的:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Colors</span> <span class="keyword">extends</span> <span class="title">java</span>.<span class="title">lang</span>.<span class="title">Enum</span>&lt;<span class="title">Colors</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> Colors RED = <span class="keyword">new</span> Colors(<span class="string">"RED"</span>, <span class="number">0</span>);</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> Colors BLUE = <span class="keyword">new</span> Colors(<span class="string">"WHITE"</span>, <span class="number">1</span>);</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> values = <span class="keyword">new</span> Colors[]&#123; RED, BLUE &#125;;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Colors</span><span class="params">(String name, <span class="keyword">int</span> ordinal)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(name, ordinal);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Colors[] values()&#123;</div><div class="line">        <span class="keyword">return</span> values;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Colors <span class="title">valueOf</span><span class="params">(String name)</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> (Colors)java.lang.Enum.valueOf(Colors.class, name);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里面的构造函数 <em>Colors(String name , ind ordinal)</em> 是隐式声明的,其中的参数是编译器给生成的,那么参数的 <em>isSynthetic</em> 属性就是true.其中的 <em>valueOf</em> 方法中的参数是 <em>isImplicit</em> 的.<br><a href="https://docs.oracle.com/javase/tutorial/reflect/member/methodparameterreflection.html" target="_blank" rel="external">implicit and synthetic</a></p>
<h3 id="Method-isVarArgs"><a href="#Method-isVarArgs" class="headerlink" title="Method.isVarArgs()"></a>Method.isVarArgs()</h3><p> Method.isVarArgs() 表明方法的参数是不是隐式数组这种格式,比如main方法中的 <em>String… args</em></p>
<h3 id="Method的isSynthetic和isBridge"><a href="#Method的isSynthetic和isBridge" class="headerlink" title="Method的isSynthetic和isBridge"></a>Method的isSynthetic和isBridge</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestMethodModifiers</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        Method[] methods = Integer.class.getMethods();</div><div class="line">        <span class="keyword">for</span> (Method method : methods) &#123;</div><div class="line">            <span class="keyword">if</span> (method.getName().equals(<span class="string">"compareTo"</span>)) &#123;</div><div class="line">                System.out.println(method.toGenericString());</div><div class="line">                System.out.println(method.isSynthetic());</div><div class="line">                System.out.println(method.isBridge());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">public int java.lang.Integer.compareTo(java.lang.Integer)</div><div class="line">false</div><div class="line">false</div><div class="line">public int java.lang.Integer.compareTo(java.lang.Object)</div><div class="line">true</div><div class="line">true</div></pre></td></tr></table></figure>
<p>编译器会帮助生成一个 <em>compareTo(Object object)</em> 的中间方法,这个方法就是一个中间方法,用来解决 <em>泛型擦除?</em> 这里我也不是很明白.</p>
<h3 id="method反射调用注意事项"><a href="#method反射调用注意事项" class="headerlink" title="method反射调用注意事项"></a>method反射调用注意事项</h3><ol>
<li><p>如果要反射的方法需要传入的参数是一个数组,就像这样的:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">(String... arr)</span> </span>&#123;</div><div class="line">       System.out.println(<span class="string">"Iam test!!!!------"</span> +arr);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>如果你直接这样调用是不行的:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">String[] mainArgs = <span class="keyword">new</span> String[]&#123;<span class="string">"a"</span>, <span class="string">"b"</span>&#125;;</div><div class="line">method.invoke(TestMethodBean2.class.newInstance(), mainArgs);</div></pre></td></tr></table></figure>
<p>虽然你传入的确实是一个数组,但是invoke方法会认为你要调用的方法是参数个数为数组容量的方法,也就是说这里认为你想调用的是包含两个参数的test方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">(String a,String b)</span> </span>&#123;</div><div class="line">       System.out.println(<span class="string">"Iam test!!!!------"</span> +arr);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>如果要正确调用,应该把数组对象转换为Object对象,这样就可以了:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">String[] mainArgs = <span class="keyword">new</span> String[]&#123;<span class="string">"a"</span>, <span class="string">"b"</span>&#125;;</div><div class="line">method.invoke(TestMethodBean2.class.newInstance(), (Object) mainArgs);</div></pre></td></tr></table></figure>
</li>
<li><p>如果要反射一个带有泛型的方法,就像这样:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestMethodBean2</span>&lt;<span class="title">T</span>&gt;</span>&#123;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">(T t)</span> </span>&#123;</div><div class="line">    System.out.println(<span class="string">"it is generic"</span>);</div><div class="line"> &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> TestMethodBean2&lt;Integer&gt;().getClass().getDeclaredMethod(<span class="string">"test"</span>,Integer.class);</div></pre></td></tr></table></figure>
<p>是不行的,会找不到这个方法,因为泛型在编译之后是会被擦除的,这个时候应该找的是最顶上的对象object才可以</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> TestMethodBean2&lt;Integer&gt;().getClass().getDeclaredMethod(<span class="string">"test"</span>,Object.class);</div></pre></td></tr></table></figure>
</li>
<li><p>对private方法的反射调用<br>要在获取到方法对象之后设置 <em>method.setAccessible(true);</em> 就可以了</p>
</li>
<li><p>如果要反射的方法没有参数,那么调用invoke方法的时候一定要注意</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">  public class MethodTrouble &#123;</div><div class="line">    public static void main(String[] args) throws NoSuchMethodException, InvocationTargetException, IllegalAccessException &#123;</div><div class="line">        MethodTroubleBean bean = new MethodTroubleBean();</div><div class="line">        Method test = bean.getClass().getDeclaredMethod("test");</div><div class="line">        test.invoke(bean);  //success</div><div class="line">        test.invoke(bean, null); //success ,但是有警告</div><div class="line">        test.invoke(bean, new Object[0]); //success</div><div class="line">        Object o = new Object[0];</div><div class="line">        test.invoke(bean, o);  //wrong IllegalArgumentException</div><div class="line">        Object n = null;</div><div class="line">        test.invoke(bean, n);  //wrong IllegalArgumentException</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">class MethodTroubleBean &#123;</div><div class="line">    void test() &#123;</div><div class="line">        System.out.println("test");</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">```  </div><div class="line">一定要注意对参数的传入.</div><div class="line"></div><div class="line">### Class.newInstance 和Construction.newInstance的区别</div><div class="line">Class.newInstance只能调用默认的构造函数(没有参数的那个),而且必须是可见的</div><div class="line">Construction.newInstance可以调用所有的构造函数,不管是否是可见的,也不管有多少个参数</div><div class="line">推荐使用后面这个</div><div class="line"></div><div class="line">### 反射创建数组</div><div class="line">```java</div><div class="line">Object o = Array.newInstance(int.class, 3);</div><div class="line">        Array.set(o,0,1);</div><div class="line">        Array.set(o,1,2);</div><div class="line">        Array.set(o,2,3);</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a href="https://docs.oracle.com/javase/tutorial/reflect/TOC.html" title="java reflect tutorial" target="_blank" rel="external">java reflect tutorial</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/01/19/2017/java反射相关知识/" data-id="cizy53xrh001w3us64rg1zi2z" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2017/android asyncTask源码分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/19/2017/android asyncTask源码分析/" class="article-date">
  <time datetime="2017-01-19T01:25:00.000Z" itemprop="datePublished">2017-01-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/19/2017/android asyncTask源码分析/">android asyncTask源码分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="android-AsyncTask源码分析-android7-0"><a href="#android-AsyncTask源码分析-android7-0" class="headerlink" title="android AsyncTask源码分析(android7.0)"></a>android AsyncTask源码分析(android7.0)</h2><p>  说道AsyncTask相信大家并不陌生,每当涉及到异步线程的的任务处理的时候,我们第一时间就会想到AsyncTask或者Handler.这里AsyncTask主要是android给我们封装了一层异步任务处理流程,方便使用,所以平时大家在UI中执行异步线程的时候会优先使用AsyncTask,今天就通过源码讲解一下AsyncTask的实现原理和注意事项.</p>
<h3 id="AsyncTask的用法"><a href="#AsyncTask的用法" class="headerlink" title="AsyncTask的用法"></a>AsyncTask的用法</h3><p>` <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">`	class MainAsyncTask extends AsyncTask&lt;Object,Object,Object&gt;&#123;`</div><div class="line">	 </div><div class="line">	       @Override</div><div class="line">	       protected void onPreExecute() &#123;</div><div class="line">	           super.onPreExecute();</div><div class="line">	       &#125;</div><div class="line">	 </div><div class="line">	       @Override</div><div class="line">	       protected void onPostExecute(Object o) &#123;</div><div class="line">	           super.onPostExecute(o);</div><div class="line">	       &#125;</div><div class="line">	 </div><div class="line">	       @Override</div><div class="line">	       protected Object doInBackground(Object... params) &#123;</div><div class="line">	           return null;</div><div class="line">	       &#125;</div><div class="line">	   &#125;</div><div class="line">` `</div></pre></td></tr></table></figure></p>
<p>`上面这个自定义AsyncTask就是我们平时的用法,可以看到主要用到3个方法,其中 <em>onPreExecute</em> 和 <em>onPostExecute</em> 分别表示任务开始前后的准备和收尾工作,注意这里这两个方法是在UI主线程中执行的.后面的 <em>doInBackground</em> 是任务的执行的代码,耗时的任务执行代码放在这里.注意这个方法是在异步线程中执行的.</p>
<p>当我们要使用AsyncTask的时候,通常是直接创建AsyncTask对象,然后调用execute方法,这样AsyncTask会先调用 <em>onPreExecute</em> 方法,然后开始执行 <em>doInBackground</em> 方法啊,最后任务完成之后回调 <em>onPostExecute</em> 方法.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> MainAsyncTask().execute();</div></pre></td></tr></table></figure></p>
<h3 id="AsyncTask源码"><a href="#AsyncTask源码" class="headerlink" title="AsyncTask源码"></a>AsyncTask源码</h3><p>先说结论,AsyncTask的内部实际上维护了一个线程池来调配异步任务(FutureTask)的执行,当异步任务执行完成之后就把结果交给内部的 <em>Handler</em> 来回调到UI主线程中.<br>就这么简单,我们要注意的细节有这么几点:</p>
<ol>
<li>内部线程池的结构类型</li>
<li>3个常用回调方法的调用时机</li>
<li>任务完成之后为什么不能再次调用这个AsyncTask对象重复执行.</li>
</ol>
<p>我们先从常用的 <em>execute</em> 方法入手:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@MainThread</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> AsyncTask&lt;Params, Progress, Result&gt; <span class="title">execute</span><span class="params">(Params... params)</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> executeOnExecutor(sDefaultExecutor, params);</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>这里execute内部又会调用 <em>executeOnExecutor</em> 方法,这里的 <em>sDefaultExecutor</em> 后面再做解释,只要明白其就是一个线程池就可以:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@MainThread</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> AsyncTask&lt;Params, Progress, Result&gt; <span class="title">executeOnExecutor</span><span class="params">(Executor exec,</span></span></div><div class="line">           Params... params) &#123;</div><div class="line">       <span class="keyword">if</span> (mStatus != Status.PENDING) &#123;</div><div class="line">           <span class="keyword">switch</span> (mStatus) &#123;</div><div class="line">               <span class="keyword">case</span> RUNNING:</div><div class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot execute task:"</span></div><div class="line">                           + <span class="string">" the task is already running."</span>);</div><div class="line">               <span class="keyword">case</span> FINISHED:</div><div class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot execute task:"</span></div><div class="line">                           + <span class="string">" the task has already been executed "</span></div><div class="line">                           + <span class="string">"(a task can be executed only once)"</span>);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       mStatus = Status.RUNNING;</div><div class="line"></div><div class="line">       onPreExecute();</div><div class="line"></div><div class="line">       mWorker.mParams = params;</div><div class="line">       exec.execute(mFuture);</div><div class="line"></div><div class="line">       <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>可以看到,这个代码非常非常的简单,就是判断一下 AsyncTask 对象的状态,如果不是 <em>PENDING</em> 状态就抛出异常.如果是 <em>PENDING</em> 状态就设置为 <em>RUNNING</em> 状态,同时调用 <em>onPreExecute</em> 方法,最后交给线程池的 <em>execute</em> 方法.是不是很清晰.同时在这里发现了我们的第一个回调方法 <em>onPreExecute</em> ,注意这里通过方法上面的注解我们发现是运行在主线程中的.</p>
<p>这里传入线程池的是一个 <em>FutureTask</em> 对象 <em>mFuture</em> ,里面包含了一个 <em>mWorker</em> 对象.下面来看传给线程池的 <em>mWorker</em> 对象的实现. <em>mWorker</em> 对象是一个 <em>WorkerRunable</em> 对象<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">WorkerRunnable</span>&lt;<span class="title">Params</span>, <span class="title">Result</span>&gt; <span class="keyword">implements</span> <span class="title">Callable</span>&lt;<span class="title">Result</span>&gt; </span>&#123;</div><div class="line">      Params[] mParams;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>可以看到 <em>WorkerRunnable</em> 对象就是一个 <em>Callable</em> 对象, <em>Callable</em> 和 <em>Runnable</em> 的区别就是有没有返回值的区别.这里AsyncTask线程池中使用的 <em>Callable</em> .<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">AsyncTask</span><span class="params">()</span> </span>&#123;</div><div class="line">       mWorker = <span class="keyword">new</span> WorkerRunnable&lt;Params, Result&gt;() &#123;</div><div class="line">           <span class="function"><span class="keyword">public</span> Result <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">               mTaskInvoked.set(<span class="keyword">true</span>);</div><div class="line">               Result result = <span class="keyword">null</span>;</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</div><div class="line">                   <span class="comment">//noinspection unchecked</span></div><div class="line">                   result = doInBackground(mParams);</div><div class="line">                   Binder.flushPendingCommands();</div><div class="line">               &#125; <span class="keyword">catch</span> (Throwable tr) &#123;</div><div class="line">                   mCancelled.set(<span class="keyword">true</span>);</div><div class="line">                   <span class="keyword">throw</span> tr;</div><div class="line">               &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                   postResult(result);</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">return</span> result;</div><div class="line">           &#125;</div><div class="line">       &#125;;</div><div class="line"></div><div class="line">       mFuture = <span class="keyword">new</span> FutureTask&lt;Result&gt;(mWorker) &#123;</div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">done</span><span class="params">()</span> </span>&#123;</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   postResultIfNotInvoked(get());</div><div class="line">               &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                   android.util.Log.w(LOG_TAG, e);</div><div class="line">               &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</div><div class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"An error occurred while executing doInBackground()"</span>,</div><div class="line">                           e.getCause());</div><div class="line">               &#125; <span class="keyword">catch</span> (CancellationException e) &#123;</div><div class="line">                   postResultIfNotInvoked(<span class="keyword">null</span>);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>在AsyncTask的构造函数中,完成了 <em>mWorker</em> 对象的初始化.然后把 <em>mWorker</em> 对象传给了 <em>mFuture</em> 对象. 如果对 <em>FutureTask</em> 不是很理解的同学可以去搜索一下相关的资料,非常简单. <em>FutureTask</em> 只是把要运行的对象和其返回值做了一个封装,方便线程池的回调使用.</p>
<p>在 <em>mWorker</em> 的call方法中,我们发现了第二个回调方法 <em>doInBackground</em> ,这个方法用来执行异步任务的,这里是在异步线程中执行的.<br>当任务执行完成之后,会调用 <em>postResult(result);</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Result <span class="title">postResult</span><span class="params">(Result result)</span> </span>&#123;</div><div class="line">       <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">       Message message = getHandler().obtainMessage(MESSAGE_POST_RESULT,</div><div class="line">               <span class="keyword">new</span> AsyncTaskResult&lt;Result&gt;(<span class="keyword">this</span>, result));</div><div class="line">       message.sendToTarget();</div><div class="line">       <span class="keyword">return</span> result;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>这里可看到Handler的常规使用.来看Handler的实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">InternalHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="title">InternalHandler</span><span class="params">()</span> </span>&#123;</div><div class="line">           <span class="keyword">super</span>(Looper.getMainLooper());</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"unchecked"</span>, <span class="string">"RawUseOfParameterizedType"</span>&#125;)</div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">           AsyncTaskResult&lt;?&gt; result = (AsyncTaskResult&lt;?&gt;) msg.obj;</div><div class="line">           <span class="keyword">switch</span> (msg.what) &#123;</div><div class="line">               <span class="keyword">case</span> MESSAGE_POST_RESULT:</div><div class="line">                   <span class="comment">// There is only one result</span></div><div class="line">                   result.mTask.finish(result.mData[<span class="number">0</span>]);</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">               <span class="keyword">case</span> MESSAGE_POST_PROGRESS:</div><div class="line">                   result.mTask.onProgressUpdate(result.mData);</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>这里Handler里面有两个回调,先说 <em>MESSAGE_POST_RESULT</em> ,这里回到了asyncTask的 <em>finish</em> 方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">finish</span><span class="params">(Result result)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (isCancelled()) &#123;</div><div class="line">            onCancelled(result);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            onPostExecute(result);</div><div class="line">        &#125;</div><div class="line">        mStatus = Status.FINISHED;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p><em>finish</em> 方法,有两个点要说明:首先你在外面调用 <em>cancel</em> 停止AsyncTask的时候,AsyncTask内部并没有停止,而是会继续执行,直到最后在finish中才做的的状态判断,只是忽略掉了返回结果而已.so,如果cancel了AsyncTask,那么是不会回调 <em>onPostExecute</em> 的,同时任务也不是立刻就停止的.如果想要任务马上停止,只能是在 <em>doInBackground</em> 方法中来对AsyncTask的状态做判断,如果状态变化了,里面return,这样可以保证任务立刻停止.<br>还有一个点要注意的是,前面有个问题:为什么AsyncTask执行完成之后不能继续调用execute方法呢.是因为在 <em>finish</em> 方法中,把这个AsyncTask对象的状态设置为 <em>FINISHED</em> ,在execute方法中第一步中就判断如果状态不是 <em>PENDING</em> 就会抛出异常.关键点在这里,所有我们如果还要二次执行任务的话,只能是重新创建一个新的AsyncTask对象了.</p>
<p>回到刚才Handler中,可以看到还有另一个异步回调情况 <em>MESSAGE_POST_PROGRESS</em> 这个是用来干什么的呢?通过字面理解我么可以发现是用来更新进度说明的.在代码中,找到了这个方法 <em>publishProgress</em> .<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">    * This method can be invoked from &#123;<span class="doctag">@link</span> #doInBackground&#125; to</div><div class="line">    * publish updates on the UI thread while the background computation is</div><div class="line">    * still running. Each call to this method will trigger the execution of</div><div class="line">    * &#123;<span class="doctag">@link</span> #onProgressUpdate&#125; on the UI thread.</div><div class="line">    *</div><div class="line">    * &#123;<span class="doctag">@link</span> #onProgressUpdate&#125; will not be called if the task has been</div><div class="line">    * canceled.</div><div class="line">    *</div><div class="line">    * <span class="doctag">@param</span> values The progress values to update the UI with.</div><div class="line">    *</div><div class="line">    * <span class="doctag">@see</span> #onProgressUpdate</div><div class="line">    * <span class="doctag">@see</span> #doInBackground</div><div class="line">    */</div><div class="line"><span class="meta">@WorkerThread</span></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">publishProgress</span><span class="params">(Progress... values)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (!isCancelled()) &#123;</div><div class="line">           getHandler().obtainMessage(MESSAGE_POST_PROGRESS,</div><div class="line">                   <span class="keyword">new</span> AsyncTaskResult&lt;Progress&gt;(<span class="keyword">this</span>, values)).sendToTarget();</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>仔细看方法上面的注释,这个方法可以在 <em>doInBackground</em> 中调用,来更新进度说明.最后这个方法会在主线程中回调 <em>onProgressUpdate</em> .<br>也就是说如果我们复写 <em>onProgressUpdate</em> 方法,我们可以在UI主线程中获取到进度更新提示.</p>
<p>上面提出的3个问题中后两个问题我们已经解释了,3个方法的回调时机非常清晰,同时AsyncTask由于最后finish状态原因是无法再次执行的.<br>最后说说AsyncTask中线程池的实现,这个点由于在不同的android版本的变化会有很多的差异,这里的源码使用是最新的7.0源码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * An &#123;<span class="doctag">@link</span> Executor&#125; that executes tasks one at a time in serial</div><div class="line">   * order.  This serialization is global to a particular process.</div><div class="line">   */</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Executor SERIAL_EXECUTOR = <span class="keyword">new</span> SerialExecutor();</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> Executor sDefaultExecutor = SERIAL_EXECUTOR;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SerialExecutor</span> <span class="keyword">implements</span> <span class="title">Executor</span> </span>&#123;</div><div class="line">       <span class="keyword">final</span> ArrayDeque&lt;Runnable&gt; mTasks = <span class="keyword">new</span> ArrayDeque&lt;Runnable&gt;();</div><div class="line">       Runnable mActive;</div><div class="line"></div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> Runnable r)</span> </span>&#123;</div><div class="line">           mTasks.offer(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">               <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                   <span class="keyword">try</span> &#123;</div><div class="line">                       r.run();</div><div class="line">                   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                       scheduleNext();</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125;);</div><div class="line">           <span class="keyword">if</span> (mActive == <span class="keyword">null</span>) &#123;</div><div class="line">               scheduleNext();</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">scheduleNext</span><span class="params">()</span> </span>&#123;</div><div class="line">           <span class="keyword">if</span> ((mActive = mTasks.poll()) != <span class="keyword">null</span>) &#123;</div><div class="line">               THREAD_POOL_EXECUTOR.execute(mActive);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>这里创建了一种叫做 <em>SerialExecutor</em> 的线程池,通过字面理解可以知道是一种串行的线程池,也就是说线程是挨个来交给 <em>THREAD_POOL_EXECUTOR</em> .这里的的 <em>SerialExecutor</em> 用到了 <em>ArrayDeque</em> 这种双向队列数据结构.只允许在结尾插入,在头部取出.可以看下其中的 <em>offer</em> 和 <em>poll</em> 方法.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">offer</span><span class="params">(E e)</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> offerLast(e);</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> E <span class="title">poll</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> pollFirst();</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>首先offer新的任务到 <em>SerialExecutor</em> 中时,判断 <em>mActive</em> 是否存在,如果不存在就去从 <em>ArrayDeque</em> 中取一个出来执行,每当其中一个任务执行完成后,最终会调用 <em>scheduleNext</em> 方法,这样就保证队列中的任务顺序执行了.</p>
<p>最后 <em>SerialExecutor</em> 是把代码交给 <em>THREAD_POOL_EXECUTOR</em> 线程池了,再来看它的实现方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CORE_POOL_SIZE = Math.max(<span class="number">2</span>, Math.min(CPU_COUNT - <span class="number">1</span>, <span class="number">4</span>));</div><div class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAXIMUM_POOL_SIZE = CPU_COUNT * <span class="number">2</span> + <span class="number">1</span>;</div><div class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> KEEP_ALIVE_SECONDS = <span class="number">30</span>;</div><div class="line"></div><div class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadFactory sThreadFactory = <span class="keyword">new</span> ThreadFactory() &#123;</div><div class="line">       <span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger mCount = <span class="keyword">new</span> AtomicInteger(<span class="number">1</span>);</div><div class="line"></div><div class="line">       <span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span> </span>&#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">new</span> Thread(r, <span class="string">"AsyncTask #"</span> + mCount.getAndIncrement());</div><div class="line">       &#125;</div><div class="line">   &#125;;</div><div class="line"></div><div class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; sPoolWorkQueue =</div><div class="line">           <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;(<span class="number">128</span>);</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line">    * An &#123;<span class="doctag">@link</span> Executor&#125; that can be used to execute tasks in parallel.</div><div class="line">    */</div><div class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Executor THREAD_POOL_EXECUTOR;</div><div class="line"></div><div class="line">   <span class="keyword">static</span> &#123;</div><div class="line">       ThreadPoolExecutor threadPoolExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</div><div class="line">               CORE_POOL_SIZE, MAXIMUM_POOL_SIZE, KEEP_ALIVE_SECONDS, TimeUnit.SECONDS,</div><div class="line">               sPoolWorkQueue, sThreadFactory);</div><div class="line">       threadPoolExecutor.allowCoreThreadTimeOut(<span class="keyword">true</span>);</div><div class="line">       THREAD_POOL_EXECUTOR = threadPoolExecutor;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>这里的 <em>THREAD_POOL_EXECUTOR</em> 就是一个线程池的常用实现,这里就不展开了.<br>这里需要说明的是这个 <em>THREAD_POOL_EXECUTOR</em> 存在的意义,通过上面代码我们可以看到asyncTask的任务是顺序执行的,也就是说你有再多的任务也是一个一个的执行的.<br>那这样可能对需求会有影响,所以在 <em>executeOnExecutor</em> 方法中可以看到,我们是可以传入其他的线程池的,这样就可以同时执行很多任务了,而 <em>THREAD_POOL_EXECUTOR</em> 就相当于一个预置的多任务线程池,如果有这种需求,你可以直接把 <em>THREAD_POOL_EXECUTOR</em> 传给 <em>executeOnExecutor</em> 方法,这样就可以让任务同步执行了.</p>
<p>在android2.3之前,AsyncTask使用就是 <em>THREAD_POOL_EXECUTOR</em> 这种线程池模式,不过由于它最对支持128个任务容量,如果超过容量之后就会报错,同时在创建任务的过程中可能会导致ANR,所以从3.0之后就改成现在这种的串行执行的线程池方式了.这个点是要注意的.</p>
<p>如果有大量的异步任务需要执行的,不推荐使用的AsyncTask,毕竟它本身不适合重要大任务量的处理,这个时候应该自己是实现线程池来完成相关的需求.</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a href="http://blog.csdn.net/lmj623565791/article/details/38614699" title="Android AsyncTask 源码解析" target="_blank" rel="external"> Android AsyncTask 源码解析</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/01/19/2017/android asyncTask源码分析/" data-id="cizy53xr0001l3us6hgcwqtkg" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/">&laquo; __('prev')</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/3/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/android/">android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/blog/">blog</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/github/">github</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java-blog-github/">java blog github</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java-blog-github/">java, blog, github</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/android/" style="font-size: 15px;">android</a> <a href="/tags/blog/" style="font-size: 20px;">blog</a> <a href="/tags/github/" style="font-size: 20px;">github</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/java-blog-github/" style="font-size: 10px;">java blog github</a> <a href="/tags/java-blog-github/" style="font-size: 10px;">java, blog, github</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/03/06/2017/读书笔记/如何高效学习-读书笔记/">&lt;如何高效学习&gt;读书笔记</a>
          </li>
        
          <li>
            <a href="/2017/03/02/2017/读书笔记/2017-03-02-如何阅读一本书/">&lt;如何阅读一本书&gt;</a>
          </li>
        
          <li>
            <a href="/2017/02/25/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2017/02/21/2017/android binder与aidl/">android binder与AIDL</a>
          </li>
        
          <li>
            <a href="/2017/02/17/2017/Android LruMemoryCache源码分析/">Android LruMemoryCache源码分析</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>