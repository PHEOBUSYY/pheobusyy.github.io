<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="Hexo">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-2017/java class基础知识" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/13/2017/java class基础知识/" class="article-date">
  <time datetime="2017-01-13T07:16:00.000Z" itemprop="datePublished">2017-01-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/13/2017/java class基础知识/">java class基础知识</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="java-Class对象基础知识"><a href="#java-Class对象基础知识" class="headerlink" title="java Class对象基础知识"></a>java Class对象基础知识</h2><p>这里要说的说Class对象指的是在java源文件完成编译之后生成的.class字节码文件,然后通过JVM的classLoader来把字节码文件载入到虚拟机中生成对应的class对象.也就是平时我们通过 A.class 或者 Class.forName(“className”)等方式生成的Class对象.</p>
<h3 id="类加载器ClassLoader"><a href="#类加载器ClassLoader" class="headerlink" title="类加载器ClassLoader"></a>类加载器ClassLoader</h3><p>java默认提供了三个ClassLoader,分别是:</p>
<ol>
<li>BootStrap ClassLoader 是java类加载层次中最顶层的类加载器,负责加载jdk中的核心类库.</li>
<li>Extension ClassLoader 成为扩展类加载器,负责加载java的扩展类库,默认加载JAVA_HOME/jre/lib/ext/目录下的所有jar.</li>
<li>App ClassLoader 称为系统类加载器,负责加载应用程序classPath目录下的所有jar和class文件.</li>
</ol>
<p>除了java提供的三个默认的ClassLoader之外,用户还可以创建自定义的ClassLoader,只要继承自java.lang.ClassLoader就可以了.也包括java提供的另外两个ClassLoader(Extension和App classLoader),但是Bootstrap ClassLoader不继承自ClassLoader,因为它不是一个普通的java类,底层由C++编写,已经嵌入到JVM内核中,当JVM启动后,Bootstrap Loader也随之启动,负责加载完核心类库后,并构造Extension 和App ClassLoader.</p>
<h4 id="类加载器加载类原理"><a href="#类加载器加载类原理" class="headerlink" title="类加载器加载类原理"></a>类加载器加载类原理</h4><p>这里使用了一种叫 <em>双亲委派</em> 的模式来搜索类,每个classLoader对象都有一个父类classLoader对象的引用,每当要加载类的时候,会去父类去找,如果没有找到就去父类的父类去找,一直到顶层的classLoader.如果没有找到,就尝试从顶层开始加载类,如果失败就依次往回返,如果一直都没成功加载,就叫交回到当前的classLoader,直接返回一个 <em>classNotFound</em> 异常.</p>
<p>这里来看下jdk8的ClassLoader源码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="keyword">boolean</span> resolve)</div><div class="line">      <span class="keyword">throws</span> ClassNotFoundException</div><div class="line">  &#123;</div><div class="line">      <span class="keyword">synchronized</span> (getClassLoadingLock(name)) &#123;</div><div class="line">          <span class="comment">// First, check if the class has already been loaded</span></div><div class="line">          Class&lt;?&gt; c = findLoadedClass(name);</div><div class="line">          <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</div><div class="line">              <span class="keyword">long</span> t0 = System.nanoTime();</div><div class="line">              <span class="keyword">try</span> &#123;</div><div class="line">                  <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</div><div class="line">                      c = parent.loadClass(name, <span class="keyword">false</span>);</div><div class="line">                  &#125; <span class="keyword">else</span> &#123;</div><div class="line">                      c = findBootstrapClassOrNull(name);</div><div class="line">                  &#125;</div><div class="line">              &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">                  <span class="comment">// ClassNotFoundException thrown if class not found</span></div><div class="line">                  <span class="comment">// from the non-null parent class loader</span></div><div class="line">              &#125;</div><div class="line"></div><div class="line">              <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</div><div class="line">                  <span class="comment">// If still not found, then invoke findClass in order</span></div><div class="line">                  <span class="comment">// to find the class.</span></div><div class="line">                  <span class="keyword">long</span> t1 = System.nanoTime();</div><div class="line">                  c = findClass(name);</div><div class="line"></div><div class="line">                  <span class="comment">// this is the defining class loader; record the stats</span></div><div class="line">                  sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);</div><div class="line">                  sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);</div><div class="line">                  sun.misc.PerfCounter.getFindClasses().increment();</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">if</span> (resolve) &#123;</div><div class="line">              resolveClass(c);</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">return</span> c;</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>代码非常的清晰,就是从下到上的去找,然后再从上到下的加载.<br><img src="images/2017/01/java classloader加载流程.gif" alt="java classLoader加载顺序"></p>
<h4 id="为什么要使用双亲委派这种模式"><a href="#为什么要使用双亲委派这种模式" class="headerlink" title="为什么要使用双亲委派这种模式?"></a>为什么要使用双亲委派这种模式?</h4><ol>
<li>为了解决重复加载,当父类已经加载过了,子类就没有必要再去加载了.</li>
<li>为了安全性,比如如果我们自己定义了和系统中一样的基础类,这两个类就会引起安全隐患.如果通过双亲委派,就会优先加载系统的原生类.放在核心代码被 “污染”</li>
</ol>
<h4 id="JVM搜索的时候-如何判断两个class对象是否相同"><a href="#JVM搜索的时候-如何判断两个class对象是否相同" class="headerlink" title="JVM搜索的时候,如何判断两个class对象是否相同"></a>JVM搜索的时候,如何判断两个class对象是否相同</h4><p>JVM在判定两个Class是否相同时,不仅要判断两个类名是否相同,而且要判断是否由同一个类加载器加载出来的.只有两者同时满足,JVM才认为这两个Class是相同的.</p>
<h3 id="class对象加载注意点"><a href="#class对象加载注意点" class="headerlink" title="class对象加载注意点"></a>class对象加载注意点</h3><p>所有的类都是在对其第一次使用的时候,动态加载到JVM中的.当程序创建第一个对象的静态成员的引用时,就会加载这个类.<br>这个证明构造器也是类的静态方法,即使在构造器之前并没有static关键字.因此,使用new操作符创建类的新对象也会被当做对类的静态成员的引用.</p>
<h3 id="new-A-getClass-方法"><a href="#new-A-getClass-方法" class="headerlink" title="new A().getClass()方法"></a>new A().getClass()方法</h3><p>Class classA = new A().getClass();<br>class对象提供了一些非常实用的方法,比如getSimpleName用来返回不包含包名的类名称.而getName和getCanonicalName则会返回全限定的类名称<br>还可以通过 newInstance()方法来直接产生类的实例对象,前提是该类有默认的构造函数.<br>最后还有一些是 getInterfaces(),getSupperclass()等等,这里就不展开了.</p>
<h4 id="A-class-字面量"><a href="#A-class-字面量" class="headerlink" title="A.class 字面量"></a>A.class 字面量</h4><p>这里的字面量指的是通过类名加class后缀之后获得了class对象.这个对象有很多特殊的情况需要特别说明一下.</p>
<p>当通过使用 “.class”来创建Class对象的引用时,不会自动 <em>初始化</em> 该Class对象.<br>这里的 <em>初始化</em> 是什么意思呢?并不是说这个Class对象是空的,而生成的Class对象并没有调用Class内部的静态方法或者静态代码块.<br>为了使用类而做的准备工作实际上包含了三个步骤:</p>
<ol>
<li>加载. 这是由前面讲的类加载器执行的.该步骤讲查找字节码(通常在ClassPath所指定的路径下查找,但这并非必须),并从这些字节码中创建一个class对象.</li>
<li>链接. 在链接阶段将验证类中的字节码,为静态域分配存储空间,并且如果必需的话,将解析这个类创建的对其他类的所有引用.</li>
<li>初始化. 如果该类具有超类,则对其初始化,执行静态初始化器和静态代码块.</li>
</ol>
<p>初始化被延迟到了对静态方法 (构造器隐式地是静态的) 或者非常数静态域进行首次引用才执行.<br>下面通过几个例子来说明:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestClass</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException </span>&#123;</div><div class="line">        System.out.println(TestInitable.num);</div><div class="line">        System.out.println(TestInitable2.name);</div><div class="line">        System.out.println(TestInitable2.num);</div><div class="line">        System.out.println(Class.forName(<span class="string">"com.justyan.TestInitable3"</span>));</div><div class="line">        System.out.println(TestInitable4.bean);</div><div class="line">        System.out.println(TestInitable5.num);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestInitable</span></span>&#123;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> num = <span class="number">100</span>;</div><div class="line">    <span class="keyword">static</span>&#123;</div><div class="line">        System.out.println(<span class="string">"TestInitable is init!!!!"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestInitable2</span></span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String name = <span class="string">"YY"</span>;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">int</span> num = <span class="number">20</span>;</div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        System.out.println(<span class="string">"TestInitable2 is init!!!!!"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestInitable3</span></span>&#123;</div><div class="line">    <span class="keyword">static</span>&#123;</div><div class="line">        System.out.println(<span class="string">"TestInitable3 is init!!!!"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestInitable4</span></span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> TestBean bean = <span class="keyword">new</span> TestBean();</div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        System.out.println(<span class="string">"TestInitable4 is init!!!!!"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestInitable5</span> <span class="keyword">extends</span> <span class="title">TestInitable</span></span>&#123;</div><div class="line">    <span class="keyword">static</span>&#123;</div><div class="line">        System.out.println(<span class="string">"TestInitable5 is init!!!!"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestBean</span> </span>&#123;</div><div class="line">    String name;</div><div class="line">    <span class="keyword">static</span>&#123;</div><div class="line">        System.out.println(<span class="string">"TestBean is init!!!!"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个demo就是通过调用一些类的静态属性,来查看有没有打印类内部的静态代码块,表明这个类对象有没有初始化.<br>先看第一个:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">System.out.println(TestInitable.num);</div></pre></td></tr></table></figure></p>
<p>由于TestInitable的num属性是 static final的,属于 “编译期常量” ,那么这个值是不需要TestInitable来初始化获取的,所以这个时候 TestInitable对象并不会初始化.内部静态代码块也不会执行,也就不会打印出里面的那条初始化信息.<br>这里只会打印<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">100</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">System.out.println(TestInitable2.name);</div><div class="line">System.out.println(TestInitable2.num);</div></pre></td></tr></table></figure>
<p>第一行和上面的情况一样, <em>name</em> 也是属于 “编译器常量”,所以第一行的时候,TestInitable2是不会初始化,但是第二行的时候由于 <em>num</em> 不是final的,所以不属于 “编译期常量”,那么这个时候就会先执行静态代码块,然后才打印num的值<br>这里会打印:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">YY</div><div class="line">TestInitable2 is init!!!!!</div><div class="line">20</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">System.out.println(Class.forName(<span class="string">"com.justyan.TestInitable3"</span>));</div></pre></td></tr></table></figure>
<p>如果通过 <em>Class.forName</em> 反射调用的话会直接初始化该类<br>这里会打印初始化信息:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">TestInitable3 is init!!!!!</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">System.out.println(TestInitable4.bean);</div></pre></td></tr></table></figure>
<p>这里由于用到了TestBean对象,故先去加载TestBean对象,执行TestBean的内部静态代码块,然后才是 TestInitable4的初始化<br>这里会答应:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">TestBean is init!!!!</div><div class="line">TestInitable4 is init!!!!!</div><div class="line">com.justyan.TestBean@610455d6</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">System.out.println(TestInitable5.num);</div></pre></td></tr></table></figure>
<p>这里TestInitable5继承自TestInitable,所以可以获取到里面的num属性.但是不会初始化 TestInitable5,因为那个属性不属于它.<br>这里只会打印<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">100</div></pre></td></tr></table></figure></p>
<p>这里的这种情况比较特殊,需要注意一下.实际上只要调用的父类的静态属性,这里 TestInitable5都不会初始化.</p>
<p>一定要理解 <em>编译期常量</em> 指的是static final的基础类型,不能是对象,如果是对象就不属于 <em>编译期常量</em> ,这个时候对该变量的调用都会导致类的初始化.<br>如果一个static域不是final的,那么对它访问时,总会要求在它被读取之前,要先进行链接(为这个域分配空间) 和初始化 (初始化该空间),就像对前面的TestBean的调用一样.</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><java编程思想> 第14章 类型信息</java编程思想></p>
<p><a href="http://blog.csdn.net/xyang81/article/details/7292380" title="深入分析Java ClassLoader原理" target="_blank" rel="external">深入分析Java ClassLoader原理</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/01/13/2017/java class基础知识/" data-id="cizy2lg17001tszs6ah7u2ncp" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2017/android 开源库NumberProgressBar源码分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/12/2017/android 开源库NumberProgressBar源码分析/" class="article-date">
  <time datetime="2017-01-12T07:12:00.000Z" itemprop="datePublished">2017-01-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/12/2017/android 开源库NumberProgressBar源码分析/">android 开源库NumberProgressBar源码分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="android-开源库NumberProgressBar源码分析"><a href="#android-开源库NumberProgressBar源码分析" class="headerlink" title="android 开源库NumberProgressBar源码分析"></a>android 开源库NumberProgressBar源码分析</h2><p>  这个view是一个简单的自定义view来实现一个横向进度的效果,左边显示完成的进度条,右边显示未完成的进度条,中间是当前的当前的进度说明.实现的思路非常的简单,就是分别画这个view的3部分,完成+文字+未完成的.<br>
        
          <p class="article-more-link">
            <a href="/2017/01/12/2017/android 开源库NumberProgressBar源码分析/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/01/12/2017/android 开源库NumberProgressBar源码分析/" data-id="cizy2lg15001rszs6u1zamd4v" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2017/android 开源Logger库" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/11/2017/android 开源Logger库/" class="article-date">
  <time datetime="2017-01-11T01:05:00.000Z" itemprop="datePublished">2017-01-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/11/2017/android 开源Logger库/">android 开源Logger库</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="android-开源Logger库"><a href="#android-开源Logger库" class="headerlink" title="android 开源Logger库"></a>android 开源Logger库</h2><h3 id="需要明白的问题"><a href="#需要明白的问题" class="headerlink" title="需要明白的问题"></a>需要明白的问题</h3><ol>
<li><p>如何打印当前线程的名称的<br>直接Thread.currentThread.getName调用的</p>
</li>
<li><p>如何打印调用方法的名称和行数的<br>通过StackTraceElement来获取到引用的数组</p>
</li>
<li><p>StackTraceElement的概念<br>StackTraceElement是java1.5新增的用来输出方法调用栈信息的对象,通过它我们可以打印出当前线程中方法的调用栈,从里面可以可以获取到方法名称,行数,类名称等我们想要的信息</p>
</li>
<li><p>如何增加分割线的和边框的<br>为了把打印日志用方框圈起来,这里把整个日志分成了两部分,顶部叫header+剩下的我们真正需要的信息.<br>header又包含了当前顶部分割线,线程名称,方法调用栈信息<br>最后再把底部分割线加上,正好组合成一个方框,这个方框是没有右边的,因为分割线都是顶满整行的</p>
</li>
<li><p>如何保证打印日志没有超过最大字符个数限制<br>由于原生api的单次打印最大字符限制是4M,所以判断如果要打印的字符串超过4M就把字符串拆开成多段来分别打印</p>
</li>
<li><p>如何处理JSON数据<br>JSONObject原生api居然提供了一个带缩进的toString方法….<br>同时Arrays居然也提供了一个deepToString的方法…..</p>
</li>
<li><p>如何处理XML<br>通过java提供的Transformer API来打印XML</p>
</li>
</ol>
<h3 id="主要代码分析"><a href="#主要代码分析" class="headerlink" title="主要代码分析"></a>主要代码分析</h3><p>其他的方法都非常简单,核心方法就是下面这个log方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">log</span><span class="params">(<span class="keyword">int</span> priority, String tag, String message, Throwable throwable)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (settings.getLogLevel() == LogLevel.NONE) &#123;</div><div class="line">     <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (throwable != <span class="keyword">null</span> &amp;&amp; message != <span class="keyword">null</span>) &#123;</div><div class="line">     message += <span class="string">" : "</span> + Helper.getStackTraceString(throwable);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (throwable != <span class="keyword">null</span> &amp;&amp; message == <span class="keyword">null</span>) &#123;</div><div class="line">     message = Helper.getStackTraceString(throwable);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (message == <span class="keyword">null</span>) &#123;</div><div class="line">     message = <span class="string">"No message/exception is set"</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">int</span> methodCount = getMethodCount();</div><div class="line">   <span class="keyword">if</span> (Helper.isEmpty(message)) &#123;</div><div class="line">     message = <span class="string">"Empty/NULL log message"</span>;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   logTopBorder(priority, tag);</div><div class="line">   logHeaderContent(priority, tag, methodCount);</div><div class="line"></div><div class="line">   <span class="comment">//get bytes of message with system's default charset (which is UTF-8 for Android)</span></div><div class="line">   <span class="keyword">byte</span>[] bytes = message.getBytes();</div><div class="line">   <span class="keyword">int</span> length = bytes.length;</div><div class="line">   <span class="keyword">if</span> (length &lt;= CHUNK_SIZE) &#123;</div><div class="line">     <span class="keyword">if</span> (methodCount &gt; <span class="number">0</span>) &#123;</div><div class="line">       logDivider(priority, tag);</div><div class="line">     &#125;</div><div class="line">     logContent(priority, tag, message);</div><div class="line">     logBottomBorder(priority, tag);</div><div class="line">     <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (methodCount &gt; <span class="number">0</span>) &#123;</div><div class="line">     logDivider(priority, tag);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i += CHUNK_SIZE) &#123;</div><div class="line">     <span class="keyword">int</span> count = Math.min(length - i, CHUNK_SIZE);</div><div class="line">     <span class="comment">//create a new String with system's default charset (which is UTF-8 for Android)</span></div><div class="line">     logContent(priority, tag, <span class="keyword">new</span> String(bytes, i, count));</div><div class="line">   &#125;</div><div class="line">   logBottomBorder(priority, tag);</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>注意,这里加锁来保证数据顺序的正确性<br>通过 <em>logHeaderContent(priority, tag, methodCount);</em> 来打印线程信息和方法调用栈信息.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">logHeaderContent</span><span class="params">(<span class="keyword">int</span> logType, String tag, <span class="keyword">int</span> methodCount)</span> </span>&#123;</div><div class="line">   StackTraceElement[] trace = Thread.currentThread().getStackTrace();</div><div class="line">   <span class="keyword">if</span> (settings.isShowThreadInfo()) &#123;</div><div class="line">     logChunk(logType, tag, HORIZONTAL_DOUBLE_LINE + <span class="string">" Thread: "</span> + Thread.currentThread().getName());</div><div class="line">     logDivider(logType, tag);</div><div class="line">   &#125;</div><div class="line">   String level = <span class="string">""</span>;</div><div class="line"></div><div class="line">   <span class="keyword">int</span> stackOffset = getStackOffset(trace) + settings.getMethodOffset();</div><div class="line"></div><div class="line">   <span class="comment">//corresponding method count with the current stack may exceeds the stack trace. Trims the count</span></div><div class="line">   <span class="keyword">if</span> (methodCount + stackOffset &gt; trace.length) &#123;</div><div class="line">     methodCount = trace.length - stackOffset - <span class="number">1</span>;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = methodCount; i &gt; <span class="number">0</span>; i--) &#123;</div><div class="line">     <span class="keyword">int</span> stackIndex = i + stackOffset;</div><div class="line">     <span class="keyword">if</span> (stackIndex &gt;= trace.length) &#123;</div><div class="line">       <span class="keyword">continue</span>;</div><div class="line">     &#125;</div><div class="line">     StringBuilder builder = <span class="keyword">new</span> StringBuilder();</div><div class="line">     builder.append(<span class="string">"║ "</span>)</div><div class="line">         .append(level)</div><div class="line">         .append(getSimpleClassName(trace[stackIndex].getClassName()))</div><div class="line">         .append(<span class="string">"."</span>)</div><div class="line">         .append(trace[stackIndex].getMethodName())</div><div class="line">         .append(<span class="string">" "</span>)</div><div class="line">         .append(<span class="string">" ("</span>)</div><div class="line">         .append(trace[stackIndex].getFileName())</div><div class="line">         .append(<span class="string">":"</span>)</div><div class="line">         .append(trace[stackIndex].getLineNumber())</div><div class="line">         .append(<span class="string">")"</span>);</div><div class="line">     level += <span class="string">"   "</span>;</div><div class="line">     logChunk(logType, tag, builder.toString());</div><div class="line">   &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>获取到调用栈信息,从第三个开始获取,因为前两个都是系统的调用信息,忽略不计,从第三个开始真正的方法调用的.再加上设置里面要求打印的方法个数,组成了要打印的方法的最终个数.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getStackOffset</span><span class="params">(StackTraceElement[] trace)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = MIN_STACK_OFFSET; i &lt; trace.length; i++) &#123;</div><div class="line">     StackTraceElement e = trace[i];</div><div class="line">     String name = e.getClassName();</div><div class="line">     <span class="keyword">if</span> (!name.equals(LoggerPrinter.class.getName()) &amp;&amp; !name.equals(Logger.class.getName())) &#123;</div><div class="line">       <span class="keyword">return</span> --i;</div><div class="line">     &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>剩下的打印主要信息的时候做个容量判断,如果没超过原声API的最大字符串限制直接打印,如果超了就拆成几段分别打印.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">byte</span>[] bytes = message.getBytes();</div><div class="line">   <span class="keyword">int</span> length = bytes.length;</div><div class="line">   <span class="keyword">if</span> (length &lt;= CHUNK_SIZE) &#123;</div><div class="line">     <span class="keyword">if</span> (methodCount &gt; <span class="number">0</span>) &#123;</div><div class="line">       logDivider(priority, tag);</div><div class="line">     &#125;</div><div class="line">     logContent(priority, tag, message);</div><div class="line">     logBottomBorder(priority, tag);</div><div class="line">     <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (methodCount &gt; <span class="number">0</span>) &#123;</div><div class="line">     logDivider(priority, tag);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i += CHUNK_SIZE) &#123;</div><div class="line">     <span class="keyword">int</span> count = Math.min(length - i, CHUNK_SIZE);</div><div class="line">     <span class="comment">//create a new String with system's default charset (which is UTF-8 for Android)</span></div><div class="line">     logContent(priority, tag, <span class="keyword">new</span> String(bytes, i, count));</div><div class="line">   &#125;</div><div class="line">   logBottomBorder(priority, tag)</div></pre></td></tr></table></figure></p>
<p>非常的简单.</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a href="https://github.com/orhanobut/logger" title="logger github" target="_blank" rel="external">logger github</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/01/11/2017/android 开源Logger库/" data-id="cizy2lg13001qszs69fz7qcle" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2017/读书笔记/另外8小时" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/09/2017/读书笔记/另外8小时/" class="article-date">
  <time datetime="2017-01-09T12:27:00.000Z" itemprop="datePublished">2017-01-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/09/2017/读书笔记/另外8小时/">另外8小时</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="另外8小时-作者-罗伯特-帕利亚里尼-出版社-南海出版社"><a href="#另外8小时-作者-罗伯特-帕利亚里尼-出版社-南海出版社" class="headerlink" title="另外8小时 作者:罗伯特.帕利亚里尼 出版社:南海出版社"></a>另外8小时 作者:罗伯特.帕利亚里尼 出版社:南海出版社</h2><p>  书中主要讲了如何通过工作和睡觉之外的8小时创造价值或者实现人生目标.</p>
<h3 id="如何找回剩下的8小时"><a href="#如何找回剩下的8小时" class="headerlink" title="如何找回剩下的8小时"></a>如何找回剩下的8小时</h3><p>以下有六大策略,可以帮助你尽可能的拿回这剩下的8小时:</p>
<h4 id="掌握你的时间"><a href="#掌握你的时间" class="headerlink" title="掌握你的时间"></a>掌握你的时间</h4><p>通过详细的时间记录来找到时间分配比例,然后把无用的删减,把重要的加重.</p>
<ol>
<li>列出大项</li>
<li>找出活动项目</li>
<li>列出花在每一项活动上面的时间</li>
<li>递延,消除,减少或保持</li>
</ol>
<h4 id="学着说不"><a href="#学着说不" class="headerlink" title="学着说不"></a>学着说不</h4><ol>
<li>避开 (学会拒绝别人,尽快结束无用的对话)</li>
<li>平衡 (保证从一项任务的时间增加,就要有另一项任务的时间减少)</li>
</ol>
<h4 id="从8小时里面变出9小时"><a href="#从8小时里面变出9小时" class="headerlink" title="从8小时里面变出9小时"></a>从8小时里面变出9小时</h4><p>没有钱也没有时间</p>
<ol>
<li>无摩擦互惠 (自己本来要做的顺便也帮着别人做了,之后要求对方也这样帮助自己)</li>
<li>专业分工 (做各自喜欢或者擅长的来与别人交换自己不喜欢或者不擅长的)</li>
</ol>
<p>有钱但没有时间</p>
<ol>
<li>写出攻击目标</li>
<li>最不想做的事</li>
<li>报价</li>
<li>设定预算</li>
<li>实际动手</li>
</ol>
<h4 id="排列组合"><a href="#排列组合" class="headerlink" title="排列组合"></a>排列组合</h4><p>诀窍在于结合脑力工作和体力工作,选择去做两种不会争夺同样资源的任务.</p>
<ol>
<li>列出无用时间</li>
<li>列出你想多做的有益活动</li>
<li>判定特定活动需要用到的是脑力还是体力</li>
<li>建立链接</li>
</ol>
<h4 id="注入正面因素"><a href="#注入正面因素" class="headerlink" title="注入正面因素"></a>注入正面因素</h4><p>火花指的是正面思考或者正向的做事态度,可以在你的人生中创造出极大的改变,带来不同的结果.</p>
<ol>
<li>选用一种火花</li>
<li>选择在无用时间点火</li>
<li>建立链接</li>
</ol>
<h4 id="善用科技"><a href="#善用科技" class="headerlink" title="善用科技"></a>善用科技</h4><p>(利用各种app,网站来帮助你提高效率,获取信息等等.)</p>
<h3 id="阅读的目的"><a href="#阅读的目的" class="headerlink" title="阅读的目的"></a>阅读的目的</h3><p>除了为自己高兴而阅读,阅读的另一个目的是为了学习.学习不是被动的:若要从投资在阅读的时间上获得最大报酬,你可以从以下秘诀入手.</p>
<ol>
<li>不要浪费时间去读不正确的东西(先略读一遍,了解以下书中的内容,如果看到感兴趣的地方就重点读一下,否则如果啥都没发现就没有读的必要了)</li>
<li>绝对不要在手边没有笔及纸时阅读.在你开始读每一章时,先问问自己从中能学到什么.阅读时,你要记笔记,划重点,在书空白处写下心得,并不断的自问要怎样把所学应用在生活中.</li>
</ol>
<h3 id="100万的问题"><a href="#100万的问题" class="headerlink" title="100万的问题"></a>100万的问题</h3><p>每天不断地问问自己,如果生死就在此一役,要怎样在365天内赚到100万美元? 如果答案仍然相同,你就应该慎重的考虑去完成这件事</p>
<h3 id="这要怎么改善"><a href="#这要怎么改善" class="headerlink" title="这要怎么改善"></a>这要怎么改善</h3><p>你可以挑选心里想到的任务产品或服务,然后在一分钟内尽量想出任何可改善的地方.</p>
<h3 id="学习"><a href="#学习" class="headerlink" title="学习"></a>学习</h3><p>把每一次接触到的机会当做学习经验,”有时候你赢了,有时候你学到了.”</p>
<h3 id="创8者法则"><a href="#创8者法则" class="headerlink" title="创8者法则"></a>创8者法则</h3><ol>
<li>保有全职工作</li>
<li>核子大爆发 (高杠杆率高回报)</li>
<li>了解你的最高最优用途 (自己做擅长最容易成功的领域)</li>
<li>限制风险</li>
<li>常挥棒 (多试错)</li>
<li>市场 (营销)</li>
<li>货币化 (盈利)</li>
<li>拥有 (所有权)</li>
</ol>
<h3 id="创8者的10大渠道"><a href="#创8者的10大渠道" class="headerlink" title="创8者的10大渠道"></a>创8者的10大渠道</h3><p>想法</p>
<ol>
<li>经营博客</li>
<li>发明</li>
<li>出书,写剧本,创作音乐</li>
</ol>
<p>产品</p>
<ol>
<li>开办公司</li>
<li>经销,策略联盟,授权</li>
<li>善用风尚或噱头</li>
</ol>
<p>时间</p>
<ol>
<li>以服务交换公司股票</li>
<li>推进事业发展或大跃进</li>
<li>成为自由职业者</li>
<li>把闲暇爱好变成收入</li>
</ol>
<h4 id="经营博客的规则"><a href="#经营博客的规则" class="headerlink" title="经营博客的规则"></a>经营博客的规则</h4><ol>
<li>创作有价值的内容</li>
<li>有特色</li>
<li>找出普遍的市场</li>
<li>要有主见</li>
<li>要表现个人的那一面</li>
<li>打造品牌</li>
<li>全力营销你的博客</li>
<li>建立多重收入来源</li>
</ol>
<h3 id="“拥有人生”是什么意思"><a href="#“拥有人生”是什么意思" class="headerlink" title="“拥有人生”是什么意思"></a>“拥有人生”是什么意思</h3><h4 id="少一点"><a href="#少一点" class="headerlink" title="少一点"></a>少一点</h4><ul>
<li>后悔 (我本可以)</li>
</ul>
<ol>
<li>克服你身上背负的后悔</li>
<li>通过防范遗憾发生来战胜未来的遗憾</li>
</ol>
<ul>
<li>恐惧</li>
<li>懒散</li>
<li>生命水蛭</li>
</ul>
<h4 id="多一点"><a href="#多一点" class="headerlink" title="多一点"></a>多一点</h4><ul>
<li>成长</li>
<li>经验</li>
<li>改变</li>
<li>向前看</li>
<li>错误</li>
<li>恐惧</li>
<li>闲暇爱好</li>
<li>感恩</li>
<li>人生目标</li>
<li>方向</li>
<li>人际关系</li>
<li>贡献</li>
<li>学习</li>
<li>行动</li>
</ul>
<h3 id="找到你的人生脉动"><a href="#找到你的人生脉动" class="headerlink" title="找到你的人生脉动"></a>找到你的人生脉动</h3><p>遵循下面6个步骤,你会知道如何运用这剩下的8个小时去实现你的理想:</p>
<ol>
<li>拥抱差距 (定位)</li>
<li>写下座右铭 (信念,人生观,价值观)</li>
<li>判定优先次序 (高收益,低半衰)</li>
<li>设定目标 (SMART)</li>
<li>预期挫折 (WOOP)</li>
<li>养成习惯 (习惯)</li>
</ol>
<h4 id="预期挫折"><a href="#预期挫折" class="headerlink" title="预期挫折"></a>预期挫折</h4><p>下面是一些常见的放弃理由:</p>
<ol>
<li>没有时间</li>
<li>失去动力</li>
<li>分心</li>
<li>害怕失败</li>
</ol>
<h3 id="不要做而言-马上起而行-动起来"><a href="#不要做而言-马上起而行-动起来" class="headerlink" title="不要做而言,马上起而行(动起来)"></a>不要做而言,马上起而行(动起来)</h3><p>以下是培养习惯的9个步骤:</p>
<ol>
<li>写出日程表中的固定事项</li>
<li>改掉你的”早叹” (一日之计在于晨)</li>
<li>找出你一天的可用时间</li>
<li>写出其他固定事项</li>
<li>找到开放的时间</li>
<li>排入你的目标</li>
<li>写出任务</li>
<li>组合多重任务</li>
<li>增强精力</li>
</ol>
<h4 id="改掉你的”早叹”"><a href="#改掉你的”早叹”" class="headerlink" title="改掉你的”早叹”"></a>改掉你的”早叹”</h4><p>每天最初的30分钟拥有强大的力量,能帮助你好好掌握眼前的一天.你每天早上的行为和态度会影响你的感受和当天的所作所为.你要做以下几件简单的事,以比较美妙的基调展开一天的生活:</p>
<ol>
<li>毁掉让你越来越衰弱的”克星石”</li>
<li>善用前五秒</li>
<li>让血液奔腾</li>
<li>力量日志(感恩,新事业点子,未来,灵性,一年赚100美元)</li>
<li>早餐</li>
</ol>
<h4 id="排入你的目标"><a href="#排入你的目标" class="headerlink" title="排入你的目标"></a>排入你的目标</h4><p>当你把目标写入目标行动计划书中时,要注意一下这些因素:</p>
<ol>
<li>精力 (合适的时间做合适的事)</li>
<li>流程 (把适合的活动安排在一起,劳逸结合)</li>
</ol>
<h4 id="增强精力"><a href="#增强精力" class="headerlink" title="增强精力"></a>增强精力</h4><ol>
<li>努力缩短差距</li>
<li>成就</li>
<li>运动</li>
<li>营养</li>
<li>榨出”兴奋”</li>
<li>音乐</li>
<li>电视节目</li>
<li>太阳</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/01/09/2017/读书笔记/另外8小时/" data-id="cizy2lg2j002kszs6069yfu10" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2017/android 自定义URI Router" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/09/2017/android 自定义URI Router/" class="article-date">
  <time datetime="2017-01-09T02:25:00.000Z" itemprop="datePublished">2017-01-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/09/2017/android 自定义URI Router/">android 自定义URI Router</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="android-自定义URI-Router"><a href="#android-自定义URI-Router" class="headerlink" title="android 自定义URI Router"></a>android 自定义URI Router</h2><h3 id="关于自定义Router学习之前的预备知识"><a href="#关于自定义Router学习之前的预备知识" class="headerlink" title="关于自定义Router学习之前的预备知识"></a>关于自定义Router学习之前的预备知识</h3><ol>
<li>为什么要使用google的auto-service这个包<br>如何才能获取一个接口的所有实现类?通过反射来遍历所有的类,然后判断该类是否是实现指定的接口,不过这样效率不太高,毕竟得对所有的类进行遍历;还有一种方法就是就是把实现了该接口的类的全路径名称放入一个配置文件中,这样在使用的时候,从配置文件中获取实现类就可以了.有点反着来的意思.那这里配置文件放在哪里呢?放在了jar包里面的META-INF这个文件夹中,这个文件夹中放的是jar包的一些签名和说明文件,通用的定义是把实现接口类的描述文件放在 META-INF/service/接口名称/中.注意,前面的这种方式是需要人工来完成的,每当你调整了实现接口的数量的话,就需要手动更新一下 META-INF文件,但是 auto-service可以自动完成这些工作,这个就是它的作用.<br><img src="images/2017/01/auto-service生成的配置文件.png" alt="auto-service生成的配置文件"></li>
</ol>
<ol>
<li><p>为什么要使用squareup:javapoet这个包<br>用来通过封装的API来生成java源文件,非常的方便,这里还没有深入的学习</p>
</li>
<li><p>java的METE-INF的作用是说明?</p>
<p>jar包中的签名,配置文件,清单文件,还有接口实现类的列表文件</p>
</li>
<li><p>java的serviceLoader类作用</p>
<p>可以从 METE-INF 中取出指定接口的实现类名称列表,方便直接调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line"></div><div class="line">     ServiceLoader&lt;ITest&gt; serviceLoader = ServiceLoader.load(ITest.class);</div><div class="line">     <span class="keyword">for</span> (ITest iTest : serviceLoader) &#123;</div><div class="line">         iTest.test();</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>自定义的注解是怎么起作用的<br>实现步骤如下:</p>
<ol>
<li><p>顶部工程的gradle中配置:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">    classpath <span class="string">'com.android.tools.build:gradle:2.2.2'</span></div><div class="line">    ....</div><div class="line">    <span class="comment">//引入apt插件</span></div><div class="line">    classpath <span class="string">'com.neenbedankt.gradle.plugins:android-apt:1.8'</span></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>主工程的gradle中配置:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">apply plugin: <span class="string">'com.neenbedankt.android-apt'</span></div><div class="line">.....</div><div class="line"><span class="function">compile <span class="title">project</span> <span class="params">(<span class="string">':annotationprocessor'</span>)</span></span></div><div class="line">apt <span class="title">project</span> <span class="params">(<span class="string">':annotationprocessor'</span>)</span></div></pre></td></tr></table></figure>
</li>
</ol>
<p>这里的 <em>annotationprocessor</em> 用来包含自定义的processor的java子工程</p>
<ol>
<li>用来包含自定义processor的java工程中的gradle中配置:<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">  dependencies &#123;</div><div class="line">    <span class="function">compile <span class="title">fileTree</span><span class="params">(dir: <span class="string">'libs'</span>, include: [<span class="string">'*.jar'</span>])</span></span></div><div class="line">    compile <span class="title">project</span><span class="params">(<span class="string">':annotation'</span>)</span></div><div class="line">    compile 'com.google.auto.service:auto-service:1.0-rc2'</div><div class="line">    compile 'com.squareup:javapoet:1.7.0'</div><div class="line">&#125;</div><div class="line"></div><div class="line">sourceCompatibility = <span class="string">"1.7"</span></div><div class="line">targetCompatibility = <span class="string">"1.7"</span></div></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ol>
<p>这里的 <em>javapoet</em> 根据需求添加,默认可以不适用.<br><em>annotation</em> 工程中存放的是自定义的 <em>annotation</em> 类文件</p>
<ol>
<li>最后就是java代码的书写了,首先是一个自定义的java注解类<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Target</span>(ElementType.TYPE)</div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.CLASS)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> YYAnnotation &#123;</div><div class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>然后是自定义的解析processor<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@AutoService</span>(Processor.class)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">YYAnnotationProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Filer filer;</div><div class="line">    <span class="keyword">private</span> Messager messager;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ProcessingEnvironment processingEnvironment)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.init(processingEnvironment);</div><div class="line">        filer = processingEnvironment.getFiler();</div><div class="line">        messager = processingEnvironment.getMessager();</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> SourceVersion <span class="title">getSupportedSourceVersion</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> SourceVersion.latestSupported();</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getSupportedAnnotationTypes</span><span class="params">()</span> </span>&#123;</div><div class="line">        Set&lt;String&gt; set = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line">        <span class="comment">//这里是你要处理注解的集合</span></div><div class="line">        set.add(YYAnnotation.class.getCanonicalName());</div><div class="line">        <span class="keyword">return</span> set;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Set&lt;? extends Element&gt; mainAppElement = roundEnv.getElementsAnnotatedWith(YYAnnotation.class);</div><div class="line">            <span class="keyword">if</span> (!mainAppElement.isEmpty()) &#123;</div><div class="line">                <span class="comment">//这里实现自己的需求</span></div><div class="line">                process(mainAppElement);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            messager.printMessage(Diagnostic.Kind.ERROR, e.getMessage());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(Set&lt;? extends Element&gt; elementsAnnotatedWith)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">      TypeElement typeElement = (TypeElement) elementsAnnotatedWith.iterator().next();</div><div class="line">      <span class="comment">//这里的Config.FILE_NAME是你要生成的java源文件的名称</span></div><div class="line">      JavaFileObject javaFileObject = filer.createSourceFile(Config.FILE_NAME, typeElement);</div><div class="line">      <span class="comment">//通过printWriter来生成java源文件</span></div><div class="line">      PrintWriter writer = <span class="keyword">new</span> PrintWriter(javaFileObject.openWriter());</div><div class="line">      <span class="comment">//这里的Config.PACKAGE_NAME你要生成的java源文件的包名</span></div><div class="line">      writer.println(<span class="string">"package "</span> + Config.PACKAGE_NAME + <span class="string">";"</span>);</div><div class="line">      writer.println(<span class="string">"public class TestProcessor &#123;"</span>);</div><div class="line">      writer.println(<span class="string">"public static void test () &#123;"</span>);</div><div class="line"></div><div class="line">      YYAnnotation componentsAnnotation = typeElement.getAnnotation(YYAnnotation.class);</div><div class="line">      String components = componentsAnnotation.value();</div><div class="line">      writer.println(<span class="string">"System.out.println(\""</span>+components+<span class="string">"\");"</span>);</div><div class="line"></div><div class="line">      writer.println(<span class="string">"&#125;"</span>);</div><div class="line">      writer.println(<span class="string">"&#125;"</span>);</div><div class="line"></div><div class="line">      writer.flush();</div><div class="line">      writer.close();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>是不是非常的神奇,你可以再编译之前做一些事情,比如生成一个java文件,或者对一些java源文件做处理等等,给了我们很大的灵活性,在这里我们是通过apt生成了可以打印信息的java类,非常的简单,后期可以根据需求调整成更加复杂的逻辑.</p>
<ol>
<li>如何某个接口的所有实现类或者某个父类的所有子类<br>反射遍历所有的java类文件,找到实现该接口的类名称.</li>
</ol>
<h3 id="别人写的Router框架解析"><a href="#别人写的Router框架解析" class="headerlink" title="别人写的Router框架解析"></a>别人写的Router框架解析</h3><p>首先要明白,Router的真正的作用是用在模块之间的解耦上,我们都知道android可以分为主工程+多个library,多个library可以作为单独module的体现,这里Router的作用就是可以让多个library互相之间调用各自的页面,service或者广播,而不用互相知道对方的具体类名称等信息,达到了内部解耦的功能.<br>先看工程目录结构:<br><img src="/images/2017/01/router工程目录结构.png" alt="router工程目录结构"></p>
<p>这里主要的功能实现就在 annotation,router,routerhelper中实现的.其他的两个shoplib和bbslib代表了两个独立模块.主工程app,uitlslib和reslib内部定义了一些工具类,这里不过多的介绍了.</p>
<h4 id="annotation工程"><a href="#annotation工程" class="headerlink" title="annotation工程"></a>annotation工程</h4><p>首先来看annotation,这个工程主要放置的是关于Router定义的各种注解.是一个纯java工程.<br><img src="/images/2017/01/annotation项目类定义.png" alt=""></p>
<p>其中, <em>AutoRouter</em> , <em>StaticRouter</em> 是router注解的两种模式,分别对应自动根据绑定的class类型来给URI添加对应的前缀,比如如果绑定的是activity则前缀为 <em>activity://</em> ,而后者则是完全按照注解的value值来作为绑定的URI.这个后续在代码中就明白怎么用了.<br><em>Components</em> 对应所有模块的注解,主要用在application中声明都有那几个需要Router的模块.<br><em>Component</em> 对应每个独立的模块<br>下面来看代码定义,非常的简单,就是普通的java注解声明:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Target</span>(ElementType.TYPE)</div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.CLASS)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> AutoRouter &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Target</span>(ElementType.TYPE)</div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.CLASS)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> StaticRouter &#123;</div><div class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Target</span>(ElementType.TYPE)</div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.CLASS)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Component &#123;</div><div class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.CLASS)</div><div class="line"><span class="meta">@Target</span>(ElementType.TYPE)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Components &#123;</div><div class="line">    String[] value();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="routerhelper工程"><a href="#routerhelper工程" class="headerlink" title="routerhelper工程"></a>routerhelper工程</h4><p>上面再 <em>annotation</em> 项目中完成了注解的定义,那势必会有一个 <em>processor</em> 来完成注解的解析和逻辑处理,这里如果对注解的处理流程不是很熟悉的话可以看下相关的java注解处理的资源.这里就不重点介绍了.直接进入 <em>RouterHelper</em> 这个解析注解类中.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@AutoService</span>(Processor.class)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RouterProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Filer mFiler;</div><div class="line">    <span class="keyword">private</span> Messager mMessager;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; mStaticRouterMap = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">    <span class="keyword">private</span> List&lt;String&gt; mAutoRouterList = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ProcessingEnvironment processingEnvironment)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.init(processingEnvironment);</div><div class="line">        mFiler = processingEnvironment.getFiler();</div><div class="line">        mMessager = processingEnvironment.getMessager();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> SourceVersion <span class="title">getSupportedSourceVersion</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> SourceVersion.latestSupported();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getSupportedAnnotationTypes</span><span class="params">()</span> </span>&#123;</div><div class="line">        Set&lt;String&gt; set = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line">        set.add(AutoRouter.class.getCanonicalName());</div><div class="line">        set.add(StaticRouter.class.getCanonicalName());</div><div class="line">        set.add(Component.class.getCanonicalName());</div><div class="line">        set.add(Components.class.getCanonicalName());</div><div class="line">        <span class="keyword">return</span> set;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; set, RoundEnvironment roundEnvironment)</span> </span>&#123;</div><div class="line">        mStaticRouterMap.clear();</div><div class="line">        mAutoRouterList.clear();</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Set&lt;? extends Element&gt; mainAppElement = roundEnvironment.getElementsAnnotatedWith(Components.class);</div><div class="line">            <span class="keyword">if</span> (!mainAppElement.isEmpty()) &#123;</div><div class="line">                processInstaller(mainAppElement);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">            processComponent(roundEnvironment);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            mMessager.printMessage(Diagnostic.Kind.ERROR, e.getMessage());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processInstaller</span><span class="params">(Set&lt;? extends Element&gt; mainAppElement)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        TypeElement typeElement = (TypeElement) mainAppElement.iterator().next();</div><div class="line">        JavaFileObject javaFileObject = mFiler.createSourceFile(Config.ROUTER_MANAGER, typeElement);</div><div class="line">        PrintWriter writer = <span class="keyword">new</span> PrintWriter(javaFileObject.openWriter());</div><div class="line"></div><div class="line">        writer.println(<span class="string">"package "</span> + Config.PACKAGE_NAME + <span class="string">";"</span>);</div><div class="line">        writer.println(<span class="string">"public class "</span> + Config.ROUTER_MANAGER + <span class="string">" &#123;"</span>);</div><div class="line">        writer.println(<span class="string">"public static void "</span> + Config.ROUTER_MANAGER_METHOD + <span class="string">"() &#123;"</span>);</div><div class="line"></div><div class="line">        Components componentsAnnotation = typeElement.getAnnotation(Components.class);</div><div class="line">        String[] components = componentsAnnotation.value();</div><div class="line">        <span class="keyword">for</span> (String item : components) &#123;</div><div class="line">            writer.println(Config.FILE_PREFIX + item + <span class="string">".router();"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        writer.println(<span class="string">"&#125;"</span>);</div><div class="line">        writer.println(<span class="string">"&#125;"</span>);</div><div class="line"></div><div class="line">        writer.flush();</div><div class="line">        writer.close();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processComponent</span><span class="params">(RoundEnvironment roundEnvironment)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        Set&lt;? extends Element&gt; compElements = roundEnvironment.getElementsAnnotatedWith(Component.class);</div><div class="line">        <span class="keyword">if</span> (compElements.isEmpty()) &#123; <span class="keyword">return</span>;&#125;</div><div class="line"></div><div class="line">        Element item = compElements.iterator().next();</div><div class="line">        String componentName = item.getAnnotation(Component.class).value();</div><div class="line"></div><div class="line">        Set&lt;? extends Element&gt; routerElements = roundEnvironment.getElementsAnnotatedWith(StaticRouter.class);</div><div class="line">        <span class="keyword">for</span> (Element e : routerElements) &#123;</div><div class="line">            <span class="keyword">if</span> (! (e <span class="keyword">instanceof</span> TypeElement)) &#123; <span class="keyword">continue</span>;&#125;</div><div class="line">            TypeElement typeElement = (TypeElement) e;</div><div class="line">            String pattern = typeElement.getAnnotation(StaticRouter.class).value();</div><div class="line">            mStaticRouterMap.put(pattern, typeElement.getQualifiedName().toString());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Set&lt;? extends Element&gt; autoRouterElements = roundEnvironment.getElementsAnnotatedWith(AutoRouter.class);</div><div class="line">        <span class="keyword">for</span> (Element e : autoRouterElements) &#123;</div><div class="line">            <span class="keyword">if</span> (!(e <span class="keyword">instanceof</span> TypeElement)) &#123; <span class="keyword">continue</span>;&#125;</div><div class="line">            TypeElement typeElement = (TypeElement) e;</div><div class="line">            mAutoRouterList.add(typeElement.getQualifiedName().toString());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        writeComponentFile(componentName);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeComponentFile</span><span class="params">(String componentName)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        String className = Config.FILE_PREFIX + componentName;</div><div class="line">        JavaFileObject javaFileObject = mFiler.createSourceFile(className);</div><div class="line"><span class="comment">//        javaFileObject.delete();</span></div><div class="line"></div><div class="line">        PrintWriter printWriter = <span class="keyword">new</span> PrintWriter(javaFileObject.openWriter());</div><div class="line"></div><div class="line">        printWriter.println(<span class="string">"package "</span> + Config.PACKAGE_NAME + <span class="string">";"</span>);</div><div class="line"></div><div class="line">        printWriter.println(<span class="string">"import android.app.Activity;"</span>);</div><div class="line">        printWriter.println(<span class="string">"import android.app.Service;"</span>);</div><div class="line">        printWriter.println(<span class="string">"import android.content.BroadcastReceiver;"</span>);</div><div class="line"></div><div class="line">        printWriter.println(<span class="string">"public class "</span> + className + <span class="string">" &#123;"</span>);</div><div class="line">        printWriter.println(<span class="string">"public static void router() &#123;"</span>);</div><div class="line"></div><div class="line">        <span class="comment">// // Router.router(ActivityRule.ACTIVITY_SCHEME + "shop.main", ShopActivity.class);</span></div><div class="line">        <span class="keyword">for</span>(Map.Entry&lt;String, String&gt; entry : mStaticRouterMap.entrySet()) &#123;</div><div class="line">            printWriter.println(<span class="string">"org.loader.router.Router.router(\""</span> + entry.getKey()</div><div class="line">                    +<span class="string">"\", "</span>+entry.getValue()+<span class="string">".class);"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (String klass : mAutoRouterList) &#123;</div><div class="line">            printWriter.println(<span class="string">"if (Activity.class.isAssignableFrom("</span> + klass + <span class="string">".class)) &#123;"</span>);</div><div class="line">            printWriter.println(<span class="string">"org.loader.router.Router.router(org.loader.router.rule.ActivityRule.ACTIVITY_SCHEME + \""</span></div><div class="line">                    +klass+<span class="string">"\", "</span> + klass + <span class="string">".class);"</span>);</div><div class="line">            printWriter.println(<span class="string">"&#125;"</span>);</div><div class="line"></div><div class="line">            printWriter.println(<span class="string">"else if (Service.class.isAssignableFrom("</span> + klass + <span class="string">".class)) &#123;"</span>);</div><div class="line">            printWriter.println(<span class="string">"org.loader.router.Router.router(org.loader.router.rule.ServiceRule.SERVICE_SCHEME + \""</span></div><div class="line">                    +klass+<span class="string">"\", "</span> + klass + <span class="string">".class);"</span>);</div><div class="line">            printWriter.println(<span class="string">"&#125;"</span>);</div><div class="line"></div><div class="line">            printWriter.println(<span class="string">"else if (BroadcastReceiver.class.isAssignableFrom("</span> + klass + <span class="string">".class)) &#123;"</span>);</div><div class="line">            printWriter.println(<span class="string">"org.loader.router.Router.router(org.loader.router.rule.ReceiverRule.RECEIVER_SCHEME + \""</span></div><div class="line">                    +klass+<span class="string">"\", "</span>+klass+<span class="string">".class);"</span>);</div><div class="line">            printWriter.println(<span class="string">"&#125;"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        printWriter.println(<span class="string">"&#125;"</span>);</div><div class="line">        printWriter.println(<span class="string">"&#125;"</span>);</div><div class="line">        printWriter.flush();</div><div class="line">        printWriter.close();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>首先在顶部声明了 <em>AutoService</em> 对应本文最上面提到的它的作用用来更新METE-INF中接口的列表文件的.这样可以快速找到工程都有哪些 <em>processor</em> .</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getSupportedAnnotationTypes</span><span class="params">()</span> </span>&#123;</div><div class="line">    Set&lt;String&gt; set = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line">    set.add(AutoRouter.class.getCanonicalName());</div><div class="line">    set.add(StaticRouter.class.getCanonicalName());</div><div class="line">    set.add(Component.class.getCanonicalName());</div><div class="line">    set.add(Components.class.getCanonicalName());</div><div class="line">    <span class="keyword">return</span> set;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>用来声明这个processor可以支持处理哪些注解.是一个set集合<br>mFiler可以用来生成一些自定义的源文件,class或其他文件.<br>mMessager 可以把错误信息打印出来<br>重点解析注解的逻辑就在 <em>process</em> 方法中.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Set&lt;? extends Element&gt; mainAppElement = roundEnvironment.getElementsAnnotatedWith(Components.class);</div><div class="line"><span class="keyword">if</span> (!mainAppElement.isEmpty()) &#123;</div><div class="line">    processInstaller(mainAppElement);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>来看第一个关键点,先是找到所有声明 <em>Components</em> 的类对象,这里注意由于 <em>Components</em> 声明的是 <em>ElementType.TYPE</em> 表明只能在类顶部定义,那么这里找到的element都是TypeElement表示类元素.<br>前面说到 <em>Components</em> 的作用是用来表示都有哪些模块需要Router的.比如这里在Application顶部声明了:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@Components</span>(&#123;<span class="string">"shop"</span>, <span class="string">"bbs"</span>&#125;)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">MultiDexApplication</span> </span>&#123;</div><div class="line">  ....</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>说明了有两个工程工程需要Router功能,对应上面说的 shop和bbs两个模块.<br>回到 <em>process</em> 方法中,找到了 <em>Components</em> 的声明类并且不为空的话就进入 <em>processInstaller</em> 方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processInstaller</span><span class="params">(Set&lt;? extends Element&gt; mainAppElement)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">       TypeElement typeElement = (TypeElement) mainAppElement.iterator().next();</div><div class="line">       JavaFileObject javaFileObject = mFiler.createSourceFile(Config.ROUTER_MANAGER, typeElement);</div><div class="line">       PrintWriter writer = <span class="keyword">new</span> PrintWriter(javaFileObject.openWriter());</div><div class="line"></div><div class="line">       writer.println(<span class="string">"package "</span> + Config.PACKAGE_NAME + <span class="string">";"</span>);</div><div class="line">       writer.println(<span class="string">"public class "</span> + Config.ROUTER_MANAGER + <span class="string">" &#123;"</span>);</div><div class="line">       writer.println(<span class="string">"public static void "</span> + Config.ROUTER_MANAGER_METHOD + <span class="string">"() &#123;"</span>);</div><div class="line"></div><div class="line">       Components componentsAnnotation = typeElement.getAnnotation(Components.class);</div><div class="line">       String[] components = componentsAnnotation.value();</div><div class="line">       <span class="keyword">for</span> (String item : components) &#123;</div><div class="line">           writer.println(Config.FILE_PREFIX + item + <span class="string">".router();"</span>);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       writer.println(<span class="string">"&#125;"</span>);</div><div class="line">       writer.println(<span class="string">"&#125;"</span>);</div><div class="line"></div><div class="line">       writer.flush();</div><div class="line">       writer.close();</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>可以看到这里,通过mFiler对象创建了新的java源文件,位于 <em>Config.PACKAGE_NAME</em> 中的叫做 <em>Config.ROUTER_MANAGER</em> 的java文件,其内部定义了一个 <em>Config.ROUTER_MANAGER_METHOD</em> 方法,我们可以在编译完成后,在我们的工程中对应的目录中找到这个生成的源文件.<br><img src="/images/2017/01/processor生成的java源码.png" alt="processor生成的java源码"></p>
<p>看到这里就发现我们居然可以自己生成java源文件,简直是打开了新世界的大门啊,用java来写java源文件,这本身就有种递归的感觉在里边,通过想象,我们可以做很多事情了,这个后续我们可以研究一下更多的用法.<br>生成的java类中的方法调用了每个模块的Router类的Router方法.可以看到这个Router是红色的,但是搜索一下发现,这个类居然也是生成的.那我们可以发现这个类肯定是通过 <em>processor</em> 方法中剩下那句代码来完成, 进入 <em>processComponent(roundEnvironment);</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processComponent</span><span class="params">(RoundEnvironment roundEnvironment)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">       Set&lt;? extends Element&gt; compElements = roundEnvironment.getElementsAnnotatedWith(Component.class);</div><div class="line">       <span class="keyword">if</span> (compElements.isEmpty()) &#123; <span class="keyword">return</span>;&#125;</div><div class="line"></div><div class="line">       Element item = compElements.iterator().next();</div><div class="line">       String componentName = item.getAnnotation(Component.class).value();</div><div class="line"></div><div class="line">       Set&lt;? extends Element&gt; routerElements = roundEnvironment.getElementsAnnotatedWith(StaticRouter.class);</div><div class="line">       <span class="keyword">for</span> (Element e : routerElements) &#123;</div><div class="line">           <span class="keyword">if</span> (! (e <span class="keyword">instanceof</span> TypeElement)) &#123; <span class="keyword">continue</span>;&#125;</div><div class="line">           TypeElement typeElement = (TypeElement) e;</div><div class="line">           String pattern = typeElement.getAnnotation(StaticRouter.class).value();</div><div class="line">           mStaticRouterMap.put(pattern, typeElement.getQualifiedName().toString());</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       Set&lt;? extends Element&gt; autoRouterElements = roundEnvironment.getElementsAnnotatedWith(AutoRouter.class);</div><div class="line">       <span class="keyword">for</span> (Element e : autoRouterElements) &#123;</div><div class="line">           <span class="keyword">if</span> (!(e <span class="keyword">instanceof</span> TypeElement)) &#123; <span class="keyword">continue</span>;&#125;</div><div class="line">           TypeElement typeElement = (TypeElement) e;</div><div class="line">           mAutoRouterList.add(typeElement.getQualifiedName().toString());</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       writeComponentFile(componentName);</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>可以看到,这里也很好理解,把所有的router声明类和URI放入集合中.通过后面的 <em>writeComponentFile</em> 方法来完成每个工程自己的router类生成.<br>之前读到这里这里的时候有个问题一直不明白:就是很明显关于 <em>Component</em> 注解应该有两个啊,但是这里却只是通过iterator的next方法获取注解集合中的一个然就去生成router类,那不就少了另外一个 <em>Component</em> 吗?,也就是说一个shop,一个bbs,都是注册了 <em>Component</em> 注解的,但是这里确只是从集合中取了一个,那后面那个就没人管了,岂不是少了一个.后来想明白了:<br>每个工程都是单独的调用 <em>processor</em> 来完成注解解析的,也就是说 shop工程中会调用一次这个 <em>processor</em> ,bbs工程中也会调用一次这个 <em>processor</em> ,这样关于 <em>component</em> 注解的处理就会执行两次,同时为每个模块各自生成一个 Router类.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeComponentFile</span><span class="params">(String componentName)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">      String className = Config.FILE_PREFIX + componentName;</div><div class="line">      JavaFileObject javaFileObject = mFiler.createSourceFile(className);</div><div class="line"><span class="comment">//        javaFileObject.delete();</span></div><div class="line"></div><div class="line">      PrintWriter printWriter = <span class="keyword">new</span> PrintWriter(javaFileObject.openWriter());</div><div class="line"></div><div class="line">      printWriter.println(<span class="string">"package "</span> + Config.PACKAGE_NAME + <span class="string">";"</span>);</div><div class="line"></div><div class="line">      printWriter.println(<span class="string">"import android.app.Activity;"</span>);</div><div class="line">      printWriter.println(<span class="string">"import android.app.Service;"</span>);</div><div class="line">      printWriter.println(<span class="string">"import android.content.BroadcastReceiver;"</span>);</div><div class="line"></div><div class="line">      printWriter.println(<span class="string">"public class "</span> + className + <span class="string">" &#123;"</span>);</div><div class="line">      printWriter.println(<span class="string">"public static void router() &#123;"</span>);</div><div class="line"></div><div class="line">      <span class="comment">// // Router.router(ActivityRule.ACTIVITY_SCHEME + "shop.main", ShopActivity.class);</span></div><div class="line">      <span class="keyword">for</span>(Map.Entry&lt;String, String&gt; entry : mStaticRouterMap.entrySet()) &#123;</div><div class="line">          printWriter.println(<span class="string">"org.loader.router.Router.router(\""</span> + entry.getKey()</div><div class="line">                  +<span class="string">"\", "</span>+entry.getValue()+<span class="string">".class);"</span>);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">for</span> (String klass : mAutoRouterList) &#123;</div><div class="line">          printWriter.println(<span class="string">"if (Activity.class.isAssignableFrom("</span> + klass + <span class="string">".class)) &#123;"</span>);</div><div class="line">          printWriter.println(<span class="string">"org.loader.router.Router.router(org.loader.router.rule.ActivityRule.ACTIVITY_SCHEME + \""</span></div><div class="line">                  +klass+<span class="string">"\", "</span> + klass + <span class="string">".class);"</span>);</div><div class="line">          printWriter.println(<span class="string">"&#125;"</span>);</div><div class="line"></div><div class="line">          printWriter.println(<span class="string">"else if (Service.class.isAssignableFrom("</span> + klass + <span class="string">".class)) &#123;"</span>);</div><div class="line">          printWriter.println(<span class="string">"org.loader.router.Router.router(org.loader.router.rule.ServiceRule.SERVICE_SCHEME + \""</span></div><div class="line">                  +klass+<span class="string">"\", "</span> + klass + <span class="string">".class);"</span>);</div><div class="line">          printWriter.println(<span class="string">"&#125;"</span>);</div><div class="line"></div><div class="line">          printWriter.println(<span class="string">"else if (BroadcastReceiver.class.isAssignableFrom("</span> + klass + <span class="string">".class)) &#123;"</span>);</div><div class="line">          printWriter.println(<span class="string">"org.loader.router.Router.router(org.loader.router.rule.ReceiverRule.RECEIVER_SCHEME + \""</span></div><div class="line">                  +klass+<span class="string">"\", "</span>+klass+<span class="string">".class);"</span>);</div><div class="line">          printWriter.println(<span class="string">"&#125;"</span>);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      printWriter.println(<span class="string">"&#125;"</span>);</div><div class="line">      printWriter.println(<span class="string">"&#125;"</span>);</div><div class="line">      printWriter.flush();</div><div class="line">      printWriter.close();</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>这个 <em>writeComponentFile</em> 方法就是用来完成Router注册的,可以看到很直白的java代码,把java代码作为输入交给pritWriter来写入指定的文件中.<br>来看下两个生成的Router类的代码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.loader.router;</div><div class="line"><span class="keyword">import</span> android.app.Activity;</div><div class="line"><span class="keyword">import</span> android.app.Service;</div><div class="line"><span class="keyword">import</span> android.content.BroadcastReceiver;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Router_bbs</span> </span>&#123;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">router</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="keyword">if</span> (Activity.class.isAssignableFrom(org.loader.bbslib.BBSActivity.class)) &#123;</div><div class="line">org.loader.router.Router.router(org.loader.router.rule.ActivityRule.ACTIVITY_SCHEME + <span class="string">"org.loader.bbslib.BBSActivity"</span>, org.loader.bbslib.BBSActivity.class);</div><div class="line">&#125;</div><div class="line"><span class="keyword">else</span> <span class="keyword">if</span> (Service.class.isAssignableFrom(org.loader.bbslib.BBSActivity.class)) &#123;</div><div class="line">org.loader.router.Router.router(org.loader.router.rule.ServiceRule.SERVICE_SCHEME + <span class="string">"org.loader.bbslib.BBSActivity"</span>, org.loader.bbslib.BBSActivity.class);</div><div class="line">&#125;</div><div class="line"><span class="keyword">else</span> <span class="keyword">if</span> (BroadcastReceiver.class.isAssignableFrom(org.loader.bbslib.BBSActivity.class)) &#123;</div><div class="line">org.loader.router.Router.router(org.loader.router.rule.ReceiverRule.RECEIVER_SCHEME + <span class="string">"org.loader.bbslib.BBSActivity"</span>, org.loader.bbslib.BBSActivity.class);</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.loader.router;</div><div class="line"><span class="keyword">import</span> android.app.Activity;</div><div class="line"><span class="keyword">import</span> android.app.Service;</div><div class="line"><span class="keyword">import</span> android.content.BroadcastReceiver;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Router_shop</span> </span>&#123;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">router</span><span class="params">()</span> </span>&#123;</div><div class="line">org.loader.router.Router.router(<span class="string">"activity://shop.main"</span>, org.loader.shoplib.ShopActivity.class);</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到这两个通过代码生成源文件最后都是进入了Router类的router方法.<br>到这里关于注解的解析就完成,下面开始进入的Router的核心实现.</p>
<h3 id="router工程"><a href="#router工程" class="headerlink" title="router工程"></a>router工程</h3><p>到这里,才算真正开始Router核心实现,要知道两个模块互相调用对方的元素,而又不直接调用,势必会有一个中间的东西来完成Router功能,首先是每个模块把自己的对外开放的元素注册到中间人,然后在需要调用别的模块的元素的时候,通过URI从中间人中来匹配找到对方的元素.这就是一个完成的Router流程.<br>很明显,需要一个map结构,key是URI,value是对应的class对象或者className.<br>上面每个模块的Router类都是最终调用的这个工程的Router类的router方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Router</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 添加自定义路由规则</div><div class="line">     * <span class="doctag">@param</span> scheme 路由scheme</div><div class="line">     * <span class="doctag">@param</span> rule 路由规则</div><div class="line">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> RouterInternal&#125; Router真实调用类</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RouterInternal <span class="title">addRule</span><span class="params">(String scheme, Rule rule)</span> </span>&#123;</div><div class="line">        RouterInternal router = RouterInternal.get();</div><div class="line">        router.addRule(scheme, rule);</div><div class="line">        <span class="keyword">return</span> router;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 添加路由</div><div class="line">     * <span class="doctag">@param</span> pattern 路由uri</div><div class="line">     * <span class="doctag">@param</span> klass 路由class</div><div class="line">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> RouterInternal&#125; Router真实调用类</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">RouterInternal <span class="title">router</span><span class="params">(String pattern, Class&lt;T&gt; klass)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> RouterInternal.get().router(pattern, klass);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 路由调用</div><div class="line">     * <span class="doctag">@param</span> ctx Context</div><div class="line">     * <span class="doctag">@param</span> pattern 路由uri</div><div class="line">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> V&#125; 返回对应的返回值</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;V&gt; <span class="function">V <span class="title">invoke</span><span class="params">(Context ctx, String pattern)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> RouterInternal.get().invoke(ctx, pattern);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 是否存在该路由</div><div class="line">     * <span class="doctag">@param</span> pattern</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">resolveRouter</span><span class="params">(String pattern)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> RouterInternal.get().resolveRouter(pattern);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个router方法就是用来注册URI的.<br>可以看到所有的逻辑都是在 <em>RouterInternal</em> 中实现的.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RouterInternal</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> RouterInternal sInstance;</div><div class="line"></div><div class="line">    <span class="comment">/** scheme-&gt;路由规则 */</span></div><div class="line">    <span class="keyword">private</span> HashMap&lt;String, Rule&gt; mRules;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">RouterInternal</span><span class="params">()</span> </span>&#123;</div><div class="line">        mRules = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">        initDefaultRouter();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 添加默认的Activity，Service，Receiver路由</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initDefaultRouter</span><span class="params">()</span> </span>&#123;</div><div class="line">        addRule(ActivityRule.ACTIVITY_SCHEME, <span class="keyword">new</span> ActivityRule());</div><div class="line">        addRule(ServiceRule.SERVICE_SCHEME, <span class="keyword">new</span> ServiceRule());</div><div class="line">        addRule(ReceiverRule.RECEIVER_SCHEME, <span class="keyword">new</span> ReceiverRule());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/*package */</span> <span class="function"><span class="keyword">static</span> RouterInternal <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (sInstance == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">synchronized</span> (RouterInternal.class) &#123;</div><div class="line">                <span class="keyword">if</span> (sInstance == <span class="keyword">null</span>) &#123;</div><div class="line">                    sInstance = <span class="keyword">new</span> RouterInternal();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> sInstance;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 添加自定义路由规则</div><div class="line">     * <span class="doctag">@param</span> scheme 路由scheme</div><div class="line">     * <span class="doctag">@param</span> rule 路由规则</div><div class="line">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> RouterInternal&#125; Router真实调用类</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> RouterInternal <span class="title">addRule</span><span class="params">(String scheme, Rule rule)</span> </span>&#123;</div><div class="line">        mRules.put(scheme, rule);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> &lt;T, V&gt; <span class="function">Rule&lt;T, V&gt; <span class="title">getRule</span><span class="params">(String pattern)</span> </span>&#123;</div><div class="line">        HashMap&lt;String, Rule&gt; rules = mRules;</div><div class="line">        Set&lt;String&gt; keySet = rules.keySet();</div><div class="line">        Rule&lt;T, V&gt; rule = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">for</span> (String scheme : keySet) &#123;</div><div class="line">            <span class="keyword">if</span> (pattern.startsWith(scheme)) &#123;</div><div class="line">                rule = rules.get(scheme);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> rule;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 添加路由</div><div class="line">     * <span class="doctag">@param</span> pattern 路由uri</div><div class="line">     * <span class="doctag">@param</span> klass 路由class</div><div class="line">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> RouterInternal&#125; Router真实调用类</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> &lt;T&gt; <span class="function">RouterInternal <span class="title">router</span><span class="params">(String pattern, Class&lt;T&gt; klass)</span> </span>&#123;</div><div class="line">        Rule&lt;T, ?&gt; rule = getRule(pattern);</div><div class="line">        <span class="keyword">if</span> (rule == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NotRouteException(<span class="string">"unknown"</span>, pattern);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        rule.router(pattern, klass);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 路由调用</div><div class="line">     * <span class="doctag">@param</span> ctx Context</div><div class="line">     * <span class="doctag">@param</span> pattern 路由uri</div><div class="line">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> V&#125; 返回对应的返回值</div><div class="line">     */</div><div class="line">    <span class="comment">/*package*/</span> <span class="keyword">final</span> &lt;V&gt; <span class="function">V <span class="title">invoke</span><span class="params">(Context ctx, String pattern)</span> </span>&#123;</div><div class="line">        Rule&lt;?, V&gt; rule = getRule(pattern);</div><div class="line">        <span class="keyword">if</span> (rule == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NotRouteException(<span class="string">"unknown"</span>, pattern);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> rule.invoke(ctx, pattern);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 是否存在该路由</div><div class="line">     * <span class="doctag">@param</span> pattern</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">resolveRouter</span><span class="params">(String pattern)</span> </span>&#123;</div><div class="line">        Rule&lt;?, ?&gt; rule = getRule(pattern);</div><div class="line">        <span class="keyword">return</span> rule != <span class="keyword">null</span> &amp;&amp; rule.resolveRule(pattern);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里 <em>RouterInternal</em> 对象通过一个两层map结构来完成路由功能,第一层就是pattern—&gt;rule对象,第二次是rule对象内部的pattern—–&gt;class对象.这样有什么好处呢?可以看到通过 <em>initDefaultRouter</em> 预置了3个默认的rule对象在 <em>RouterInternal</em> 内部的map中,分别对应activity,service和广播.然后每次先通过pattern来找到这3个内置rule中的一个,然后才把pattern和class对象放入rule对象中.<br>这样的好处是便于管理,所有的activity都放入一个rule对象的,所有的service都放入同一个rule中,结构非常的清晰,同时也节约了内存.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Rule</span>&lt;<span class="title">T</span>, <span class="title">V</span>&gt; </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 添加路由</div><div class="line">     * <span class="doctag">@param</span> pattern 路由uri</div><div class="line">     * <span class="doctag">@param</span> klass 路由class</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">router</span><span class="params">(String pattern, Class&lt;T&gt; klass)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 路由调用</div><div class="line">     * <span class="doctag">@param</span> ctx Context</div><div class="line">     * <span class="doctag">@param</span> pattern 路由uri</div><div class="line">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> V&#125; 返回对应的返回值</div><div class="line">     */</div><div class="line">    <span class="function">V <span class="title">invoke</span><span class="params">(Context ctx, String pattern)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 查看是否存在pattern对应的路由</div><div class="line">     * <span class="doctag">@param</span> pattern</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">resolveRule</span><span class="params">(String pattern)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>rule是一个map结构的对象,用来URI匹配的细分,具体实现在 <em>BaseInternRule</em> 中<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseIntentRule</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Rule</span>&lt;<span class="title">T</span>, <span class="title">Intent</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> HashMap&lt;String, Class&lt;T&gt;&gt; mIntentRules;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseIntentRule</span><span class="params">()</span> </span>&#123;</div><div class="line">        mIntentRules = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * &#123;<span class="doctag">@inheritDoc</span>&#125;</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">router</span><span class="params">(String pattern, Class&lt;T&gt; klass)</span> </span>&#123;</div><div class="line">        mIntentRules.put(pattern, klass);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * &#123;<span class="doctag">@inheritDoc</span>&#125;</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Intent <span class="title">invoke</span><span class="params">(Context ctx, String pattern)</span> </span>&#123;</div><div class="line">        Class&lt;T&gt; klass = mIntentRules.get(pattern);</div><div class="line">        <span class="keyword">if</span> (klass == <span class="keyword">null</span>) &#123; throwException(pattern);&#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Intent(ctx, klass);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">resolveRule</span><span class="params">(String pattern)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mIntentRules.get(pattern) != <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 当找不到路由规则时抛出异常</div><div class="line">     * <span class="doctag">@param</span> pattern 路由pattern</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">throwException</span><span class="params">(String pattern)</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到这里就是一个简单的map结构<br>剩下的 <em>ActivityRule</em> ,<em>ReceiverRule</em> ,<em>ServiceRule</em> 都是继承自 <em>BaseIntentRule</em> 中,内部定义了各自的前缀.</p>
<p>到这里router的核心逻辑就完成了,下面来看怎么用的</p>
<h3 id="app工程的router调用"><a href="#app工程的router调用" class="headerlink" title="app工程的router调用"></a>app工程的router调用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@Components</span>(&#123;<span class="string">"shop"</span>, <span class="string">"bbs"</span>&#125;)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">MultiDexApplication</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate();</div><div class="line">        setupRouter();</div><div class="line">        Logger.dump(<span class="string">"TAG"</span>, <span class="string">"application: "</span> + getClass().getName());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setupRouter</span><span class="params">()</span> </span>&#123;</div><div class="line">        RouterHelper.install();</div><div class="line"></div><div class="line"><span class="comment">//        Router.router(ActivityRule.ACTIVITY_SCHEME + "shop.main", ShopActivity.class);</span></div><div class="line"><span class="comment">//        Router.router(ActivityRule.ACTIVITY_SCHEME + "bbs.main", BBSActivity.class);</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在工程的总入口application对象中完成了模块的注册,同是调用了 <em>RouterHelper.install();</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RouterHelper</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">install</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Class&lt;?&gt; klass = Class.forName(Config.PACKAGE_NAME + <span class="string">"."</span> + Config.ROUTER_MANAGER);</div><div class="line">            Method method = klass.getDeclaredMethod(Config.ROUTER_MANAGER_METHOD);</div><div class="line">            method.invoke(<span class="keyword">null</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里就是通过反射来找到上面那个 <em>processor</em> 生成的java源文件,调用里面的唯一方法.完成router的注册的.</p>
<p>再看两个子模块是怎么互相调用对方的</p>
<h3 id="shop工程"><a href="#shop工程" class="headerlink" title="shop工程"></a>shop工程</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span>(<span class="string">"shop"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Shop</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@StaticRouter</span>(ActivityRule.ACTIVITY_SCHEME + <span class="string">"shop.main"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShopActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        TextView tv = <span class="keyword">new</span> TextView(<span class="keyword">this</span>);</div><div class="line">        tv.setTextSize(<span class="number">50</span>);</div><div class="line">        tv.setText(<span class="string">"SHOP!!!"</span>);</div><div class="line">        setContentView(tv);</div><div class="line"></div><div class="line">        Logger.dump(<span class="string">"TAG"</span>, <span class="string">"Hei! I am shop!!!"</span>);</div><div class="line">        UseContext.use(Application.get());</div><div class="line"></div><div class="line">        tv.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">                Toast.makeText(ShopActivity.<span class="keyword">this</span>, getResources().getString(R.string.click_notice), Toast.LENGTH_SHORT).show();</div><div class="line">                <span class="keyword">if</span> (Router.resolveRouter(ActivityRule.ACTIVITY_SCHEME + <span class="string">"org.loader.bbslib.BBSActivity"</span>)) &#123;</div><div class="line">                    Intent it = org.loader.router.Router.invoke(ShopActivity.<span class="keyword">this</span>, ActivityRule.ACTIVITY_SCHEME + <span class="string">"org.loader.bbslib.BBSActivity"</span>);</div><div class="line">                    startActivity(it);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到这里通过Shop对象完成模块的注册,最后在textView的跳转是调用 <em>Router的invoke</em> 方法来找到bbs的制定页面.<br>这里的注册用是 <em>StaticRouter</em> 所以要写完整的URI路径.</p>
<h3 id="bbs工程"><a href="#bbs工程" class="headerlink" title="bbs工程"></a>bbs工程</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span>(<span class="string">"bbs"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BBS</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@AutoRouter</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BBSActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        TextView tv = <span class="keyword">new</span> TextView(<span class="keyword">this</span>);</div><div class="line">        tv.setTextSize(<span class="number">50</span>);</div><div class="line">        tv.setText(<span class="string">"BBS!!!"</span>);</div><div class="line">        setContentView(tv);</div><div class="line"></div><div class="line">        Logger.dump(<span class="string">"TAG"</span>, <span class="string">"Hei! I am bbs!!!"</span>);</div><div class="line">        UseContext.use(Application.get());</div><div class="line"></div><div class="line">        tv.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">                Toast.makeText(BBSActivity.<span class="keyword">this</span>, getResources().getString(R.string.click_notice), Toast.LENGTH_SHORT).show();</div><div class="line">                <span class="keyword">if</span> (Router.resolveRouter(ActivityRule.ACTIVITY_SCHEME + <span class="string">"shop.main"</span>)) &#123;</div><div class="line">                    Intent it = Router.invoke(BBSActivity.<span class="keyword">this</span>, ActivityRule.ACTIVITY_SCHEME + <span class="string">"shop.main"</span>);</div><div class="line">                    startActivity(it);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里的注册用的 <em>AutoRouter</em> 所以不需要写URI,自动生成的URI是 类型+类的全路径</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>可以看到 Router结构实际上就是通过一个URI找到对方的制定类.结构非常简单.之所以用了多点的时间主要是用来消化注解的相关处理逻辑,用着方便,但是要理解还是要话点时间的.<br>不过这种通过注解来生成中间类,最终达到解耦目的的思路非常值得尝试.开阔了视野.</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a href="https://github.com/qibin0506/Module2Module" title="Module2Module" target="_blank" rel="external">Module2Module</a></p>
<p><a href="http://blog.csdn.net/qibin0506/article/details/53373412" title="Android路由实现" target="_blank" rel="external">Android路由实现</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/01/09/2017/android 自定义URI Router/" data-id="cizy2lg18001uszs6ewr97uaf" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2017/java线程池源码分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/04/2017/java线程池源码分析/" class="article-date">
  <time datetime="2017-01-04T00:27:00.000Z" itemprop="datePublished">2017-01-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/04/2017/java线程池源码分析/">java线程池源码分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="java线程池源码分析"><a href="#java线程池源码分析" class="headerlink" title="java线程池源码分析"></a>java线程池源码分析</h2><h3 id="Executor接口"><a href="#Executor接口" class="headerlink" title="Executor接口"></a>Executor接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Executor</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable command)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>线程池的基础接口</p>
<h3 id="ExecutorService接口方法"><a href="#ExecutorService接口方法" class="headerlink" title="ExecutorService接口方法"></a>ExecutorService接口方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ExecutorService</span> <span class="keyword">extends</span> <span class="title">Executor</span> </span>&#123;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function">List&lt;Runnable&gt; <span class="title">shutdownNow</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isShutdown</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isTerminated</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">awaitTermination</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span></span></div><div class="line">        <span class="keyword">throws</span> InterruptedException;</div><div class="line"></div><div class="line"></div><div class="line">    &lt;T&gt; <span class="function">Future&lt;T&gt; <span class="title">submit</span><span class="params">(Callable&lt;T&gt; task)</span></span>;</div><div class="line"></div><div class="line"></div><div class="line">    &lt;T&gt; <span class="function">Future&lt;T&gt; <span class="title">submit</span><span class="params">(Runnable task, T result)</span></span>;</div><div class="line"></div><div class="line"></div><div class="line">    Future&lt;?&gt; submit(Runnable task);</div><div class="line"></div><div class="line"></div><div class="line">    &lt;T&gt; List&lt;Future&lt;T&gt;&gt; invokeAll(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks)</div><div class="line">        <span class="keyword">throws</span> InterruptedException;</div><div class="line"></div><div class="line">    &lt;T&gt; List&lt;Future&lt;T&gt;&gt; invokeAll(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks,</div><div class="line">                                  <span class="keyword">long</span> timeout, TimeUnit unit)</div><div class="line">        <span class="keyword">throws</span> InterruptedException;</div><div class="line"></div><div class="line">    &lt;T&gt; <span class="function">T <span class="title">invokeAny</span><span class="params">(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks)</span></span></div><div class="line">        <span class="keyword">throws</span> InterruptedException, ExecutionException;</div><div class="line"></div><div class="line"></div><div class="line">    &lt;T&gt; <span class="function">T <span class="title">invokeAny</span><span class="params">(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks,</span></span></div><div class="line">                    <span class="keyword">long</span> timeout, TimeUnit unit)</div><div class="line">        <span class="keyword">throws</span> InterruptedException, ExecutionException, TimeoutException;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>线程池相关操作的定义接口</p>
<h3 id="RunnableFuture-接口"><a href="#RunnableFuture-接口" class="headerlink" title="RunnableFuture 接口"></a>RunnableFuture 接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RunnableFuture</span>&lt;<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">Runnable</span>, <span class="title">Future</span>&lt;<span class="title">V</span>&gt; </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Sets this Future to the result of its computation</div><div class="line">     * unless it has been cancelled.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过适配器把两个不相关的对象组合在一起了.</p>
<h3 id="Future-和-FutureTask"><a href="#Future-和-FutureTask" class="headerlink" title="Future 和 FutureTask"></a>Future 和 FutureTask</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Future</span>&lt;<span class="title">V</span>&gt; </span>&#123;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">cancel</span><span class="params">(<span class="keyword">boolean</span> mayInterruptIfRunning)</span></span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isCancelled</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isDone</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function">V <span class="title">get</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException</span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function">V <span class="title">get</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span></span></div><div class="line">        <span class="keyword">throws</span> InterruptedException, ExecutionException, TimeoutException;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>FutureTask是实现返回值的关键类,里面的核心方法就是 <em>get</em> 方法,下面来看一下具体实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException </span>&#123;</div><div class="line">       <span class="keyword">int</span> s = state;</div><div class="line">       <span class="keyword">if</span> (s &lt;= COMPLETING)</div><div class="line">           s = awaitDone(<span class="keyword">false</span>, <span class="number">0L</span>);</div><div class="line">       <span class="keyword">return</span> report(s);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line">    * <span class="doctag">@throws</span> CancellationException &#123;<span class="doctag">@inheritDoc</span>&#125;</div><div class="line">    */</div><div class="line">   <span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span></span></div><div class="line">       <span class="keyword">throws</span> InterruptedException, ExecutionException, TimeoutException &#123;</div><div class="line">       <span class="keyword">if</span> (unit == <span class="keyword">null</span>)</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">       <span class="keyword">int</span> s = state;</div><div class="line">       <span class="keyword">if</span> (s &lt;= COMPLETING &amp;&amp;</div><div class="line">           (s = awaitDone(<span class="keyword">true</span>, unit.toNanos(timeout))) &lt;= COMPLETING)</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> TimeoutException();</div><div class="line">       <span class="keyword">return</span> report(s);</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>很明显的就是通过state的状态来判断是否需要返回结果,还没有完成就进入 <em>awaitDone</em> ,目的是为了在结果没有返回的时候阻塞等待.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">awaitDone</span><span class="params">(<span class="keyword">boolean</span> timed, <span class="keyword">long</span> nanos)</span></span></div><div class="line">       <span class="keyword">throws</span> InterruptedException &#123;</div><div class="line">       <span class="comment">// The code below is very delicate, to achieve these goals:</span></div><div class="line">       <span class="comment">// - call nanoTime exactly once for each call to park</span></div><div class="line">       <span class="comment">// - if nanos &lt;= 0, return promptly without allocation or nanoTime</span></div><div class="line">       <span class="comment">// - if nanos == Long.MIN_VALUE, don't underflow</span></div><div class="line">       <span class="comment">// - if nanos == Long.MAX_VALUE, and nanoTime is non-monotonic</span></div><div class="line">       <span class="comment">//   and we suffer a spurious wakeup, we will do no worse than</span></div><div class="line">       <span class="comment">//   to park-spin for a while</span></div><div class="line">       <span class="keyword">long</span> startTime = <span class="number">0L</span>;    <span class="comment">// Special value 0L means not yet parked</span></div><div class="line">       WaitNode q = <span class="keyword">null</span>;</div><div class="line">       <span class="keyword">boolean</span> queued = <span class="keyword">false</span>;</div><div class="line">       <span class="keyword">for</span> (;;) &#123;</div><div class="line">           <span class="keyword">int</span> s = state;</div><div class="line">           <span class="keyword">if</span> (s &gt; COMPLETING) &#123;</div><div class="line">               <span class="keyword">if</span> (q != <span class="keyword">null</span>)</div><div class="line">                   q.thread = <span class="keyword">null</span>;</div><div class="line">               <span class="keyword">return</span> s;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (s == COMPLETING)</div><div class="line">               <span class="comment">// We may have already promised (via isDone) that we are done</span></div><div class="line">               <span class="comment">// so never return empty-handed or throw InterruptedException</span></div><div class="line">               Thread.yield();</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (Thread.interrupted()) &#123;</div><div class="line">               removeWaiter(q);</div><div class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (q == <span class="keyword">null</span>) &#123;</div><div class="line">               <span class="keyword">if</span> (timed &amp;&amp; nanos &lt;= <span class="number">0L</span>)</div><div class="line">                   <span class="keyword">return</span> s;</div><div class="line">               q = <span class="keyword">new</span> WaitNode();</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (!queued)</div><div class="line">               queued = U.compareAndSwapObject(<span class="keyword">this</span>, WAITERS,</div><div class="line">                                               q.next = waiters, q);</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (timed) &#123;</div><div class="line">               <span class="keyword">final</span> <span class="keyword">long</span> parkNanos;</div><div class="line">               <span class="keyword">if</span> (startTime == <span class="number">0L</span>) &#123; <span class="comment">// first time</span></div><div class="line">                   startTime = System.nanoTime();</div><div class="line">                   <span class="keyword">if</span> (startTime == <span class="number">0L</span>)</div><div class="line">                       startTime = <span class="number">1L</span>;</div><div class="line">                   parkNanos = nanos;</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   <span class="keyword">long</span> elapsed = System.nanoTime() - startTime;</div><div class="line">                   <span class="keyword">if</span> (elapsed &gt;= nanos) &#123;</div><div class="line">                       removeWaiter(q);</div><div class="line">                       <span class="keyword">return</span> state;</div><div class="line">                   &#125;</div><div class="line">                   parkNanos = nanos - elapsed;</div><div class="line">               &#125;</div><div class="line">               <span class="comment">// nanoTime may be slow; recheck before parking</span></div><div class="line">               <span class="keyword">if</span> (state &lt; COMPLETING)</div><div class="line">                   LockSupport.parkNanos(<span class="keyword">this</span>, parkNanos);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span></div><div class="line">               LockSupport.park(<span class="keyword">this</span>);</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>具体的细节就不说了,最终就是如果状态是运行中的话就阻塞线程等待,直到那边run方法执行完成之后,修改线程状态:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">if</span> (state != NEW ||</div><div class="line">          !U.compareAndSwapObject(<span class="keyword">this</span>, RUNNER, <span class="keyword">null</span>, Thread.currentThread()))</div><div class="line">          <span class="keyword">return</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">          Callable&lt;V&gt; c = callable;</div><div class="line">          <span class="keyword">if</span> (c != <span class="keyword">null</span> &amp;&amp; state == NEW) &#123;</div><div class="line">              V result;</div><div class="line">              <span class="keyword">boolean</span> ran;</div><div class="line">              <span class="keyword">try</span> &#123;</div><div class="line">                  result = c.call();</div><div class="line">                  ran = <span class="keyword">true</span>;</div><div class="line">              &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</div><div class="line">                  result = <span class="keyword">null</span>;</div><div class="line">                  ran = <span class="keyword">false</span>;</div><div class="line">                  setException(ex);</div><div class="line">              &#125;</div><div class="line">              <span class="keyword">if</span> (ran)</div><div class="line">                  set(result);</div><div class="line">          &#125;</div><div class="line">      &#125; <span class="keyword">finally</span> &#123;</div><div class="line">          <span class="comment">// runner must be non-null until state is settled to</span></div><div class="line">          <span class="comment">// prevent concurrent calls to run()</span></div><div class="line">          runner = <span class="keyword">null</span>;</div><div class="line">          <span class="comment">// state must be re-read after nulling runner to prevent</span></div><div class="line">          <span class="comment">// leaked interrupts</span></div><div class="line">          <span class="keyword">int</span> s = state;</div><div class="line">          <span class="keyword">if</span> (s &gt;= INTERRUPTING)</div><div class="line">              handlePossibleCancellationInterrupt(s);</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>执行完成之后进入set(result):<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(V v)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, STATE, NEW, COMPLETING)) &#123;</div><div class="line">           outcome = v;</div><div class="line">           U.putOrderedInt(<span class="keyword">this</span>, STATE, NORMAL); <span class="comment">// final state</span></div><div class="line">           finishCompletion();</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">finishCompletion</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="comment">// assert state &gt; COMPLETING;</span></div><div class="line">      <span class="keyword">for</span> (WaitNode q; (q = waiters) != <span class="keyword">null</span>;) &#123;</div><div class="line">          <span class="keyword">if</span> (U.compareAndSwapObject(<span class="keyword">this</span>, WAITERS, q, <span class="keyword">null</span>)) &#123;</div><div class="line">              <span class="keyword">for</span> (;;) &#123;</div><div class="line">                  Thread t = q.thread;</div><div class="line">                  <span class="keyword">if</span> (t != <span class="keyword">null</span>) &#123;</div><div class="line">                      q.thread = <span class="keyword">null</span>;</div><div class="line">                      LockSupport.unpark(t);</div><div class="line">                  &#125;</div><div class="line">                  WaitNode next = q.next;</div><div class="line">                  <span class="keyword">if</span> (next == <span class="keyword">null</span>)</div><div class="line">                      <span class="keyword">break</span>;</div><div class="line">                  q.next = <span class="keyword">null</span>; <span class="comment">// unlink to help gc</span></div><div class="line">                  q = next;</div><div class="line">              &#125;</div><div class="line">              <span class="keyword">break</span>;</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      done();</div><div class="line"></div><div class="line">      callable = <span class="keyword">null</span>;        <span class="comment">// to reduce footprint</span></div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>在这里唤醒线程,通知get方法,已经完成处理了,可以获取返回值了.</p>
<h3 id="ThreadPoolExecutor"><a href="#ThreadPoolExecutor" class="headerlink" title="ThreadPoolExecutor"></a>ThreadPoolExecutor</h3><p>ThreadPoolExecutor中的一个难点是在如何通过一个int值来代表两个作用,一个是线程池状态,一个是线程池运行任务的个数.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger ctl = <span class="keyword">new</span> AtomicInteger(ctlOf(RUNNING, <span class="number">0</span>));</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COUNT_BITS = Integer.SIZE - <span class="number">3</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CAPACITY   = (<span class="number">1</span> &lt;&lt; COUNT_BITS) - <span class="number">1</span>;</div><div class="line"></div><div class="line"><span class="comment">// runState is stored in the high-order bits</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RUNNING    = -<span class="number">1</span> &lt;&lt; COUNT_BITS;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SHUTDOWN   =  <span class="number">0</span> &lt;&lt; COUNT_BITS;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STOP       =  <span class="number">1</span> &lt;&lt; COUNT_BITS;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TIDYING    =  <span class="number">2</span> &lt;&lt; COUNT_BITS;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TERMINATED =  <span class="number">3</span> &lt;&lt; COUNT_BITS;</div><div class="line"></div><div class="line"><span class="comment">// Packing and unpacking ctl</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">runStateOf</span><span class="params">(<span class="keyword">int</span> c)</span>     </span>&#123; <span class="keyword">return</span> c &amp; ~CAPACITY; &#125;</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">workerCountOf</span><span class="params">(<span class="keyword">int</span> c)</span>  </span>&#123; <span class="keyword">return</span> c &amp; CAPACITY; &#125;</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">ctlOf</span><span class="params">(<span class="keyword">int</span> rs, <span class="keyword">int</span> wc)</span> </span>&#123; <span class="keyword">return</span> rs | wc; &#125;</div></pre></td></tr></table></figure></p>
<p>把一个int值的高位3为作为线程池的状态,后面的29位作为线程池的任务个数.<br>这里的 <em>COUNT_BITS</em> 是29,那么 <em>CAPACITY</em> 就是 00011111111111111111111111111111 ,这样 <em>~CAPACITY</em> 为 11100000000000000000000000000000,这样通过与操作就可以分别处理两个属性了.非常的巧妙.</p>
<p>然后要明白两个重要的属性 <em>corePoolSize</em> 和 <em>maximumPoolSize</em> . corePoolSize是用来表示当前允许运行的最小任务个数,也叫核心任务数.maximumPoolSize是指线程池运行运行的最大任务数.</p>
<p>正常情况下,如果没有满足 corePoolSize 的话就创建新的 <em>worker</em> 然后执行,如果超过了 corePoolSize 的话一般是进入阻塞队列中等待.如果连阻塞队列都满了的话,尝试在创建新的线程来执行任务,前提是运行的任务数不能超过最大的任务数,也就是 maximumPoolSize .这就是两个size的作用.4中不同的线程池类型的区别主要就在这两个参数上面.<br>举个例子,比如现在总共有12个任务, corePoolSize 为2,阻塞队列容量为5,最大线程数 maximumPoolSize为10,那首先会优先满足corePoolSize ,1号,2号运行,然后剩下的5个也就是,3,4,5,6,7进入阻塞队列,然后8,9,10号创建新线程来执行填满最大线程数,还剩下的11,12就不予执行了.</p>
<p>上面的这个流程就是线程池的核心流程原理,下面来看具体的代码实现:<br>ThreadPoolExecutor调用任务有两个方法一个是submit,一个是execute,二者的唯一区别就是submit有返回值,但是内部都是调用了execute方法.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">Future&lt;T&gt; <span class="title">submit</span><span class="params">(Runnable task, T result)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (task == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">       RunnableFuture&lt;T&gt; ftask = newTaskFor(task, result);</div><div class="line">       execute(ftask);</div><div class="line">       <span class="keyword">return</span> ftask;</div><div class="line">   &#125;</div><div class="line"></div><div class="line"></div><div class="line">   <span class="keyword">public</span> &lt;T&gt; <span class="function">Future&lt;T&gt; <span class="title">submit</span><span class="params">(Callable&lt;T&gt; task)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (task == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">       RunnableFuture&lt;T&gt; ftask = newTaskFor(task);</div><div class="line">       execute(ftask);</div><div class="line">       <span class="keyword">return</span> ftask;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>这里传入的就是FutureTask对象啦,FutureTask的细节前面已经说过了,先看 <em>execute</em> 方法的实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable command)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (command == <span class="keyword">null</span>)</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">        <span class="comment">/*</span></div><div class="line">         * Proceed in 3 steps:</div><div class="line">         *</div><div class="line">         * 1. If fewer than corePoolSize threads are running, try to</div><div class="line">         * start a new thread with the given command as its first</div><div class="line">         * task.  The call to addWorker atomically checks runState and</div><div class="line">         * workerCount, and so prevents false alarms that would add</div><div class="line">         * threads when it shouldn't, by returning false.</div><div class="line">         *</div><div class="line">         * 如果要执行的任务数量小于corePoolSize,直接通过调用addWorker方法来执行任务.</div><div class="line">         *</div><div class="line">         * 2. If a task can be successfully queued, then we still need</div><div class="line">         * to double-check whether we should have added a thread</div><div class="line">         * (because existing ones died since last checking) or that</div><div class="line">         * the pool shut down since entry into this method. So we</div><div class="line">         * recheck state and if necessary roll back the enqueuing if</div><div class="line">         * stopped, or start a new thread if there are none.</div><div class="line">         *</div><div class="line">         * 如果线程池处于运行状态并且任务成功的进入阻塞队列,二次检查线程池的状态,如果状态变为非运行的时候,尝试回退任务</div><div class="line">         * 如果运行中的任务个数为0,运行一个空的任务到addWorker</div><div class="line">         *</div><div class="line">         * 3. If we cannot queue task, then we try to add a new</div><div class="line">         * thread.  If it fails, we know we are shut down or saturated</div><div class="line">         * and so reject the task.</div><div class="line">         * 如果不能入列,那尝试直接通过addWorker运行任务,如果失败说明线程池已经停止了或者已经满了,拒绝任务</div><div class="line">         */</div><div class="line">        <span class="keyword">int</span> c = ctl.get();</div><div class="line">        <span class="keyword">if</span> (workerCountOf(c) &lt; corePoolSize) &#123;</div><div class="line">            <span class="keyword">if</span> (addWorker(command, <span class="keyword">true</span>))</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            c = ctl.get();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123;</div><div class="line">            <span class="keyword">int</span> recheck = ctl.get();</div><div class="line">            <span class="keyword">if</span> (! isRunning(recheck) &amp;&amp; remove(command))</div><div class="line">                reject(command);</div><div class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (workerCountOf(recheck) == <span class="number">0</span>)</div><div class="line">                addWorker(<span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!addWorker(command, <span class="keyword">false</span>))</div><div class="line">            reject(command);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>这里就对应上面的三种情况,核心任务数没满直接addWorker,如果满了就放入阻塞队列中,如果阻塞队列也满了尝试直接运行,那如何运行任务就进入addWorker方法了.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">addWorker</span><span class="params">(Runnable firstTask, <span class="keyword">boolean</span> core)</span> </span>&#123;</div><div class="line">      <span class="comment">/**</span></div><div class="line">      * 通过一个循环标示来控制一个两层的死循环</div><div class="line">      * 首先是判断线程池的状态,如果是停止或以上的状态直接返回false</div><div class="line">      * 另外就是前面的 *execute* 方法的传入的 *addWorker(null, false);* 这种情况下说明阻塞队列还有任务没有执行完成,所以要继续把阻塞队列里面的任务执行完才可以,这种情况就会进入底下的第二个循环里面.</div><div class="line">      * 第二个循环直接更改运行的线程数,如果成功就跳出循环,如果超出最大限制就返回false</div><div class="line">      * 如果发现线程池的状态变化了就重新更新一下</div><div class="line">      */</div><div class="line">       retry:</div><div class="line">       <span class="keyword">for</span> (;;) &#123;</div><div class="line">           <span class="keyword">int</span> c = ctl.get();</div><div class="line">           <span class="keyword">int</span> rs = runStateOf(c);</div><div class="line"></div><div class="line">           <span class="comment">// Check if queue empty only if necessary.</span></div><div class="line">           <span class="keyword">if</span> (rs &gt;= SHUTDOWN &amp;&amp;</div><div class="line">               ! (rs == SHUTDOWN &amp;&amp;</div><div class="line">                  firstTask == <span class="keyword">null</span> &amp;&amp;</div><div class="line">                  ! workQueue.isEmpty()))</div><div class="line">               <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"></div><div class="line">           <span class="keyword">for</span> (;;) &#123;</div><div class="line">               <span class="keyword">int</span> wc = workerCountOf(c);</div><div class="line">               <span class="keyword">if</span> (wc &gt;= CAPACITY ||</div><div class="line">                   wc &gt;= (core ? corePoolSize : maximumPoolSize))</div><div class="line">                   <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">               <span class="keyword">if</span> (compareAndIncrementWorkerCount(c))</div><div class="line">                   <span class="keyword">break</span> retry;</div><div class="line">               c = ctl.get();  <span class="comment">// Re-read ctl</span></div><div class="line">               <span class="keyword">if</span> (runStateOf(c) != rs)</div><div class="line">                   <span class="keyword">continue</span> retry;</div><div class="line">               <span class="comment">// else CAS failed due to workerCount change; retry inner loop</span></div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">        <span class="comment">/**</span></div><div class="line">        * 如果进入这里说明任务可以执行了</div><div class="line">        */</div><div class="line">       <span class="keyword">boolean</span> workerStarted = <span class="keyword">false</span>;</div><div class="line">       <span class="keyword">boolean</span> workerAdded = <span class="keyword">false</span>;</div><div class="line">       Worker w = <span class="keyword">null</span>;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">          <span class="comment">//包装一个worker对象</span></div><div class="line">           w = <span class="keyword">new</span> Worker(firstTask);</div><div class="line">           <span class="comment">//这里的Thread是通过线程池构造函数的ThreadFactory来创建出来的,这里的线程就是worker对象用来执行任务的线程对象,这个对象会陪伴着worker从生到死,不断的执行任务,如果阻塞队列中没有任务的时候,它会阻塞挂起,除非设置了keepAliveTime参数.</span></div><div class="line">           <span class="keyword">final</span> Thread t = w.thread;</div><div class="line">           <span class="keyword">if</span> (t != <span class="keyword">null</span>) &#123;</div><div class="line">               <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</div><div class="line">               mainLock.lock();</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   <span class="comment">// Recheck while holding lock.</span></div><div class="line">                   <span class="comment">// Back out on ThreadFactory failure or if</span></div><div class="line">                   <span class="comment">// shut down before lock acquired.</span></div><div class="line">                   <span class="keyword">int</span> rs = runStateOf(ctl.get());</div><div class="line">                    <span class="comment">//运行态或者停止之后但是阻塞队列还有任务没有完成,设置workerAdded true</span></div><div class="line">                   <span class="keyword">if</span> (rs &lt; SHUTDOWN ||</div><div class="line">                       (rs == SHUTDOWN &amp;&amp; firstTask == <span class="keyword">null</span>)) &#123;</div><div class="line">                       <span class="keyword">if</span> (t.isAlive()) <span class="comment">// precheck that t is startable</span></div><div class="line">                           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalThreadStateException();</div><div class="line">                       workers.add(w);</div><div class="line">                       <span class="keyword">int</span> s = workers.size();</div><div class="line">                       <span class="comment">//设置当前最大的运行任务数</span></div><div class="line">                       <span class="keyword">if</span> (s &gt; largestPoolSize)</div><div class="line">                           largestPoolSize = s;</div><div class="line">                       workerAdded = <span class="keyword">true</span>;</div><div class="line">                   &#125;</div><div class="line">               &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                   mainLock.unlock();</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">if</span> (workerAdded) &#123;</div><div class="line">                 <span class="comment">//这里调用worker线程的start方法,最后进入了 *runWorker* 方法</span></div><div class="line">                   t.start();</div><div class="line">                   workerStarted = <span class="keyword">true</span>;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">finally</span> &#123;</div><div class="line">           <span class="keyword">if</span> (! workerStarted)</div><div class="line">               addWorkerFailed(w);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> workerStarted;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>当调用worker的中线程的start方法实际上进入了runWorker方法中,先看下work对象的实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Worker</span></span></div><div class="line">      <span class="keyword">extends</span> <span class="title">AbstractQueuedSynchronizer</span></div><div class="line">      <span class="keyword">implements</span> <span class="title">Runnable</span></div><div class="line">  &#123;</div><div class="line">      <span class="comment">/**</span></div><div class="line">       * This class will never be serialized, but we provide a</div><div class="line">       * serialVersionUID to suppress a javac warning.</div><div class="line">       */</div><div class="line">      <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">6138294804551838833L</span>;</div><div class="line"></div><div class="line">      <span class="comment">/** Thread this worker is running in.  Null if factory fails. */</span></div><div class="line">      <span class="keyword">final</span> Thread thread;</div><div class="line">      <span class="comment">/** Initial task to run.  Possibly null. */</span></div><div class="line">      Runnable firstTask;</div><div class="line">      <span class="comment">/** Per-thread task counter */</span></div><div class="line">      <span class="keyword">volatile</span> <span class="keyword">long</span> completedTasks;</div><div class="line"></div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Creates with given first task and thread from ThreadFactory.</div><div class="line">       * <span class="doctag">@param</span> firstTask the first task (null if none)</div><div class="line">       */</div><div class="line">      Worker(Runnable firstTask) &#123;</div><div class="line">          setState(-<span class="number">1</span>); <span class="comment">// inhibit interrupts until runWorker</span></div><div class="line">          <span class="keyword">this</span>.firstTask = firstTask;</div><div class="line">          <span class="keyword">this</span>.thread = getThreadFactory().newThread(<span class="keyword">this</span>);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">/** Delegates main run loop to outer runWorker. */</span></div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">          runWorker(<span class="keyword">this</span>);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// Lock methods</span></div><div class="line">      <span class="comment">//</span></div><div class="line">      <span class="comment">// The value 0 represents the unlocked state.</span></div><div class="line">      <span class="comment">// The value 1 represents the locked state.</span></div><div class="line"></div><div class="line">      <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isHeldExclusively</span><span class="params">()</span> </span>&#123;</div><div class="line">          <span class="keyword">return</span> getState() != <span class="number">0</span>;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> unused)</span> </span>&#123;</div><div class="line">          <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>)) &#123;</div><div class="line">              setExclusiveOwnerThread(Thread.currentThread());</div><div class="line">              <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">tryRelease</span><span class="params">(<span class="keyword">int</span> unused)</span> </span>&#123;</div><div class="line">          setExclusiveOwnerThread(<span class="keyword">null</span>);</div><div class="line">          setState(<span class="number">0</span>);</div><div class="line">          <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span>        </span>&#123; acquire(<span class="number">1</span>); &#125;</div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">()</span>  </span>&#123; <span class="keyword">return</span> tryAcquire(<span class="number">1</span>); &#125;</div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span>      </span>&#123; release(<span class="number">1</span>); &#125;</div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isLocked</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> isHeldExclusively(); &#125;</div><div class="line"></div><div class="line">      <span class="function"><span class="keyword">void</span> <span class="title">interruptIfStarted</span><span class="params">()</span> </span>&#123;</div><div class="line">          Thread t;</div><div class="line">          <span class="keyword">if</span> (getState() &gt;= <span class="number">0</span> &amp;&amp; (t = thread) != <span class="keyword">null</span> &amp;&amp; !t.isInterrupted()) &#123;</div><div class="line">              <span class="keyword">try</span> &#123;</div><div class="line">                  t.interrupt();</div><div class="line">              &#125; <span class="keyword">catch</span> (SecurityException ignore) &#123;</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>worker是一个AQS的简单实现,其中要注意的就是它的构造函数,首先通过setState(-1)来把对象锁定,防止中断操作,然后就是thread对象,这里是通过ThreadFactory的newThread来创建出来的新线程,这个线程用来调用传入线程池的任务,相当于任务的载体.这个Thread对象就是worker用来执行任务的环境了,它会和worker一起丛生到死.</p>
<p>线程池是是如何减少了线程的创建的呢?<br>比如我有100个任务,那你直接调用100个任务的start方法相当于创建了100个线程对不对.而交给线程池却不会傻傻的创建100个线程对象,它会创建你设置的 <em>corePoolSize</em> 个worker对象,在worker对象的Thread中来执行任务代码,也就是说每个worker对象不仅仅只是运行一个任务就完了,它会不断的运行任务,从阻塞队列中不断的去取任务,直到没有任务给它处理为止.这个时候它会阻塞,一直等着阻塞队列有数据进来.</p>
<p>注意这里说的worker对象不止执行一个任务是理解线程池的关键.通过这样才能减少线程的创建和消耗,重点要理解worker是怎么处理任务的.下面我们来看runWorker方法的实现:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">runWorker</span><span class="params">(Worker w)</span> </span>&#123;</div><div class="line">        Thread wt = Thread.currentThread();</div><div class="line">        Runnable task = w.firstTask;</div><div class="line">        w.firstTask = <span class="keyword">null</span>;</div><div class="line">        w.unlock(); <span class="comment">// allow interrupts</span></div><div class="line">        <span class="keyword">boolean</span> completedAbruptly = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          <span class="comment">//这里getTask是从阻塞队列中取没有运行的任务,一直到阻塞队列中没有数据为止</span></div><div class="line">            <span class="keyword">while</span> (task != <span class="keyword">null</span> || (task = getTask()) != <span class="keyword">null</span>) &#123;</div><div class="line">                w.lock();</div><div class="line">                <span class="comment">// If pool is stopping, ensure thread is interrupted;</span></div><div class="line">                <span class="comment">// if not, ensure thread is not interrupted.  This</span></div><div class="line">                <span class="comment">// requires a recheck in second case to deal with</span></div><div class="line">            <span class="comment">// shutdownNow race while clearing interrupt</span></div><div class="line">                <span class="keyword">if</span> ((runStateAtLeast(ctl.get(), STOP) ||</div><div class="line">                     (Thread.interrupted() &amp;&amp;</div><div class="line">                      runStateAtLeast(ctl.get(), STOP))) &amp;&amp;</div><div class="line">                    !wt.isInterrupted())</div><div class="line">                    wt.interrupt();</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                  <span class="comment">//这个方法是个钩子函数</span></div><div class="line">                    beforeExecute(wt, task);</div><div class="line">                    Throwable thrown = <span class="keyword">null</span>;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                      <span class="comment">//运行任务</span></div><div class="line">                        task.run();</div><div class="line">                    &#125; <span class="keyword">catch</span> (RuntimeException x) &#123;</div><div class="line">                        thrown = x; <span class="keyword">throw</span> x;</div><div class="line">                    &#125; <span class="keyword">catch</span> (Error x) &#123;</div><div class="line">                        thrown = x; <span class="keyword">throw</span> x;</div><div class="line">                    &#125; <span class="keyword">catch</span> (Throwable x) &#123;</div><div class="line">                        thrown = x; <span class="keyword">throw</span> <span class="keyword">new</span> Error(x);</div><div class="line">                    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                        afterExecute(task, thrown);</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                    task = <span class="keyword">null</span>;</div><div class="line">                    w.completedTasks++;</div><div class="line">                    w.unlock();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            completedAbruptly = <span class="keyword">false</span>;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            processWorkerExit(w, completedAbruptly);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>这里就是调用任务的核心所在了,之所以有这么代码判断是为了处理线程池状态的变化的,比如正在运行任务的过程中,线程池调用了shutDown方法或者shutDownNow方法的时候,要协调这些任务的运行状态.<br>方法中while的判断,如果worker中的task为空的时候,就对应上面addWorker的时候线程池已经停止了,但是在阻塞队列中还是有任务,就得把阻塞队列中的任务取出来处理.这里就调用的是 <em>getTask</em> 方法,从阻塞队列中取任务.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Runnable <span class="title">getTask</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">boolean</span> timedOut = <span class="keyword">false</span>; <span class="comment">// Did the last poll() time out?</span></div><div class="line"></div><div class="line">        <span class="keyword">for</span> (;;) &#123;</div><div class="line">            <span class="keyword">int</span> c = ctl.get();</div><div class="line">            <span class="keyword">int</span> rs = runStateOf(c);</div><div class="line"></div><div class="line">            <span class="comment">// Check if queue empty only if necessary.</span></div><div class="line">            <span class="keyword">if</span> (rs &gt;= SHUTDOWN &amp;&amp; (rs &gt;= STOP || workQueue.isEmpty())) &#123;</div><div class="line">                decrementWorkerCount();</div><div class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">int</span> wc = workerCountOf(c);</div><div class="line"></div><div class="line">            <span class="comment">// Are workers subject to culling?</span></div><div class="line">            <span class="keyword">boolean</span> timed = allowCoreThreadTimeOut || wc &gt; corePoolSize;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> ((wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut))</div><div class="line">                &amp;&amp; (wc &gt; <span class="number">1</span> || workQueue.isEmpty())) &#123;</div><div class="line">                <span class="keyword">if</span> (compareAndDecrementWorkerCount(c))</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">              <span class="comment">//从阻塞队列中获取一个任务</span></div><div class="line">                Runnable r = timed ?</div><div class="line">                    workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :</div><div class="line">                    workQueue.take();</div><div class="line">                <span class="keyword">if</span> (r != <span class="keyword">null</span>)</div><div class="line">                    <span class="keyword">return</span> r;</div><div class="line">                timedOut = <span class="keyword">true</span>;</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException retry) &#123;</div><div class="line">                timedOut = <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>这样就保证了只要worker活着它就会不断的从阻塞队列取数据并执行,这种阻塞了等待着执行任务的worker成为IdleWorker,也是在后面会被回收的worker对象.在每次执行完成任务之后来判断一下是不是需要回收闲置的worker对象.关键点就在这里的 <em>workQueue.poll</em> 和 <em>workQueue.take</em> ,poll支持超时,如果在指定的 <em>keepAliveTime</em> 的时间内,阻塞队列中还是没有数据,那么就返回null,如果是 <em>take</em> 的话,就会阻塞,等待有新的数据进入阻塞队列中.这个关键点是实现后面要讲的 <em>newCachedThreadPool</em> 关键所在.也就是在keepAliveTime的时间内,还是没有新的任务,那么这个worker对象就会被回收.<br>最后,如果是设置了keepAliveTime的话,超时没有取到数据,就会设置timedOut为true,再次进入上面的 <em>timed &amp;&amp; timedOut</em> 就会满足条件了,然后返回null,回到上面的runWoker的while循环并跳出,交给下面的 <em>processWorkerExit</em> 方法.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processWorkerExit</span><span class="params">(Worker w, <span class="keyword">boolean</span> completedAbruptly)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (completedAbruptly) <span class="comment">// If abrupt, then workerCount wasn't adjusted</span></div><div class="line">            decrementWorkerCount();</div><div class="line"></div><div class="line">        <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</div><div class="line">        mainLock.lock();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            completedTaskCount += w.completedTasks;</div><div class="line">            workers.remove(w);</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            mainLock.unlock();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        tryTerminate();</div><div class="line"></div><div class="line">        <span class="keyword">int</span> c = ctl.get();</div><div class="line">        <span class="keyword">if</span> (runStateLessThan(c, STOP)) &#123;</div><div class="line">            <span class="keyword">if</span> (!completedAbruptly) &#123;</div><div class="line">                <span class="keyword">int</span> min = allowCoreThreadTimeOut ? <span class="number">0</span> : corePoolSize;</div><div class="line">                <span class="keyword">if</span> (min == <span class="number">0</span> &amp;&amp; ! workQueue.isEmpty())</div><div class="line">                    min = <span class="number">1</span>;</div><div class="line">                <span class="keyword">if</span> (workerCountOf(c) &gt;= min)</div><div class="line">                    <span class="keyword">return</span>; <span class="comment">// replacement not needed</span></div><div class="line">            &#125;</div><div class="line">            addWorker(<span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>这里通过重入锁锁定之后修改workers集合的数据,把运行完成的worker移除.如果线程池还没到stop的状态,继续调用addWorker执行阻塞队列中的任务.同时还尝试结束线程池,再来看其中的 <em>tryTerminate</em> 方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">tryTerminate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (;;) &#123;</div><div class="line">            <span class="keyword">int</span> c = ctl.get();</div><div class="line">            <span class="keyword">if</span> (isRunning(c) ||</div><div class="line">                runStateAtLeast(c, TIDYING) ||</div><div class="line">                (runStateOf(c) == SHUTDOWN &amp;&amp; ! workQueue.isEmpty()))</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            <span class="keyword">if</span> (workerCountOf(c) != <span class="number">0</span>) &#123; <span class="comment">// Eligible to terminate</span></div><div class="line">                interruptIdleWorkers(ONLY_ONE);</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</div><div class="line">            mainLock.lock();</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">if</span> (ctl.compareAndSet(c, ctlOf(TIDYING, <span class="number">0</span>))) &#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                      <span class="comment">//空方法,没有实现</span></div><div class="line">                        terminated();</div><div class="line">                    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                        ctl.set(ctlOf(TERMINATED, <span class="number">0</span>));</div><div class="line">                        termination.signalAll();</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">return</span>;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                mainLock.unlock();</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// else retry on failed CAS</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>如果现在状态是shutDown,但是阻塞队列中还是有任务就退出,不中止线程池.如果核心线程还是有在运行的时候,调用 <em>interruptIdleWorkers</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">interruptIdleWorkers</span><span class="params">(<span class="keyword">boolean</span> onlyOne)</span> </span>&#123;</div><div class="line">      <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</div><div class="line">      mainLock.lock();</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">          <span class="keyword">for</span> (Worker w : workers) &#123;</div><div class="line">              Thread t = w.thread;</div><div class="line">              <span class="keyword">if</span> (!t.isInterrupted() &amp;&amp; w.tryLock()) &#123;</div><div class="line">                  <span class="keyword">try</span> &#123;</div><div class="line">                      t.interrupt();</div><div class="line">                  &#125; <span class="keyword">catch</span> (SecurityException ignore) &#123;</div><div class="line">                  &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                      w.unlock();</div><div class="line">                  &#125;</div><div class="line">              &#125;</div><div class="line">              <span class="keyword">if</span> (onlyOne)</div><div class="line">                  <span class="keyword">break</span>;</div><div class="line">          &#125;</div><div class="line">      &#125; <span class="keyword">finally</span> &#123;</div><div class="line">          mainLock.unlock();</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>如果是空闲线程,也就是没有任务在运行,所以可以获得锁,就把worker所在的线程中断.</p>
<p>到这里,就会引出两个中断方法的差异,shutDown和showDownNow的区别是:shutDown是中断之后,后续的加入的任务就无法直接运行了,已经在运行和阻塞队列中的还是会继续执行,而shutDownNow是直接中断全部的任务,不管是否在队列中,也不管是否在运行;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</div><div class="line">        mainLock.lock();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            checkShutdownAccess();</div><div class="line">            advanceRunState(SHUTDOWN);</div><div class="line">            interruptIdleWorkers();</div><div class="line">            onShutdown(); <span class="comment">// hook for ScheduledThreadPoolExecutor</span></div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            mainLock.unlock();</div><div class="line">        &#125;</div><div class="line">        tryTerminate();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>可以看到这里调用的是 <em>interruptIdleWorkers</em> 方法.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> List&lt;Runnable&gt; <span class="title">shutdownNow</span><span class="params">()</span> </span>&#123;</div><div class="line">       List&lt;Runnable&gt; tasks;</div><div class="line">       <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</div><div class="line">       mainLock.lock();</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           checkShutdownAccess();</div><div class="line">           advanceRunState(STOP);</div><div class="line">           interruptWorkers();</div><div class="line">           tasks = drainQueue();</div><div class="line">       &#125; <span class="keyword">finally</span> &#123;</div><div class="line">           mainLock.unlock();</div><div class="line">       &#125;</div><div class="line">       tryTerminate();</div><div class="line">       <span class="keyword">return</span> tasks;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">interruptWorkers</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</div><div class="line">       mainLock.lock();</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="keyword">for</span> (Worker w : workers)</div><div class="line">               w.interruptIfStarted();</div><div class="line">       &#125; <span class="keyword">finally</span> &#123;</div><div class="line">           mainLock.unlock();</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>然后回到worker的内部interruptIfStarted:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">interruptIfStarted</span><span class="params">()</span> </span>&#123;</div><div class="line">           Thread t;</div><div class="line">           <span class="keyword">if</span> (getState() &gt;= <span class="number">0</span> &amp;&amp; (t = thread) != <span class="keyword">null</span> &amp;&amp; !t.isInterrupted()) &#123;</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   t.interrupt();</div><div class="line">               &#125; <span class="keyword">catch</span> (SecurityException ignore) &#123;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div></pre></td></tr></table></figure></p>
<p>可以看到这里调用的 <em>interruptWorkers</em> 方法.这就是两个shutdown方法的区别所在.一个是中断空闲任务,一个是中断所有任务.</p>
<h3 id="newFixedThreadPool-newSingleThreadExecutor-newCachedThreadPool-newScheduledThreadPool-四种类型的区别"><a href="#newFixedThreadPool-newSingleThreadExecutor-newCachedThreadPool-newScheduledThreadPool-四种类型的区别" class="headerlink" title="newFixedThreadPool,newSingleThreadExecutor,newCachedThreadPool,newScheduledThreadPool 四种类型的区别"></a>newFixedThreadPool,newSingleThreadExecutor,newCachedThreadPool,newScheduledThreadPool 四种类型的区别</h3><p>这4种常用的线程池的创建都交给Executors来完成的,实际上就是创建了不同的ThreadPoolExecutor.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newFixedThreadPool</span><span class="params">(<span class="keyword">int</span> nThreads)</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> ThreadPoolExecutor(nThreads, nThreads,</div><div class="line">                                    <span class="number">0L</span>, TimeUnit.MILLISECONDS,</div><div class="line">                                    <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;());</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>可以看到核心任务数和最大任务数是一样的,那就是说线程池支持最多有 <em>nThreads</em> 个worker在运行,剩下的任务全部放入阻塞中,等待前面的任务完成后才取出来继续执行.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newSingleThreadExecutor</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> FinalizableDelegatedExecutorService</div><div class="line">           (<span class="keyword">new</span> ThreadPoolExecutor(<span class="number">1</span>, <span class="number">1</span>,</div><div class="line">                                   <span class="number">0L</span>, TimeUnit.MILLISECONDS,</div><div class="line">                                   <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;()));</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>可以看到核心线程和最大线程数都是1,也就是说同一时间只能有一个任务执行,后续的任务挨个按顺序执行.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newCachedThreadPool</span><span class="params">(ThreadFactory threadFactory)</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">0</span>, Integer.MAX_VALUE,</div><div class="line">                                    <span class="number">60L</span>, TimeUnit.SECONDS,</div><div class="line">                                    <span class="keyword">new</span> SynchronousQueue&lt;Runnable&gt;(),</div><div class="line">                                    threadFactory);</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>可以重复使用线程的线程池,直接把所有任务同时创建worker来运行,不管有多少个,同时由于设置了超时keepAliveTime,到了制定的时候就会回收空闲的worker对象,达到回收资源的目的.注意这里只是回收 <em>空闲</em> 的worker,正在运行的worker是不会回收的.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ScheduledExecutorService <span class="title">newScheduledThreadPool</span><span class="params">(</span></span></div><div class="line">            <span class="keyword">int</span> corePoolSize, ThreadFactory threadFactory) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ScheduledThreadPoolExecutor(corePoolSize, threadFactory);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>支持指定时间的任务的线程池,这里内部通过一个 <em>DelayedWorkQueue</em> 来完成定时操作,就不多做解释了.</p>
<h3 id="Callable和Runnable"><a href="#Callable和Runnable" class="headerlink" title="Callable和Runnable"></a>Callable和Runnable</h3><p>Callable是具有返回值的Runnable,这是两个区别.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Callable</span>&lt;<span class="title">V</span>&gt; </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Computes a result, or throws an exception if unable to do so.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> computed result</div><div class="line">     * <span class="doctag">@throws</span> Exception if unable to compute a result</div><div class="line">     */</div><div class="line">    <span class="function">V <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Starts executing the active part of the class' code. This method is</div><div class="line">     * called when a thread is started that has been created with a class which</div><div class="line">     * implements &#123;<span class="doctag">@code</span> Runnable&#125;.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>线程池的实现难点都在于 ThreadPoolExecutor 中,主要是对其中worker工作方式的理解,还有线程的运行和任务的运行的区别.这是关键,底层还是通过CAS来自旋判断线程的运行状态等属性变化,可以看到CAS是java多线程的核心基础.<br>刚开始完全不理解worker的实现,后来耐着性子看了好几遍别人的博客总于弄明白个大概,不得不说线程池的实现非常的巧妙.首先是一个int表示两个属性,然后是worker的实现思路来减少线程的创建消耗,对线程的理解更进一步.</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a href="http://fangjian0423.github.io/2016/03/22/java-threadpool-analysis/" title="Java线程池ThreadPoolExecutor源码分析" target="_blank" rel="external">Java线程池ThreadPoolExecutor源码分析</a></p>
<p><a href="http://zhanjindong.com/2015/03/30/java-concurrent-package-ThreadPoolExecutor" title="Java并发包源码学习之线程池（一）ThreadPoolExecutor源码分析" target="_blank" rel="external">Java并发包源码学习之线程池（一）ThreadPoolExecutor源码分析</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/01/04/2017/java线程池源码分析/" data-id="cizy2lg1m001xszs6edf0egii" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2017/android Handler,Looper,MessageQueue源码分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/03/2017/android Handler,Looper,MessageQueue源码分析/" class="article-date">
  <time datetime="2017-01-03T06:09:00.000Z" itemprop="datePublished">2017-01-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/03/2017/android Handler,Looper,MessageQueue源码分析/">android Handler,Looper,MessageQueue源码分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="android-Handler-Looper-MessageQueue源码分析"><a href="#android-Handler-Looper-MessageQueue源码分析" class="headerlink" title="android Handler,Looper,MessageQueue源码分析"></a>android Handler,Looper,MessageQueue源码分析</h2><p>  Handler是一个在android开发过程中经常用到的类,同时在面试的时候也会经常问道其中的实现原理,那今天就重点讲解一下Handler的用法和实现原理.</p>
<blockquote>
<p>一个Handler可以使你发送并处理一个消息或者线程通过关联一个 <em>MessageQueue</em> .每一个handler的实例都唯一关联一个线程和 <em>MessageQueue</em> .当你创建一个Handler它就和当前线程和线程的 <em>MessageQueue</em> 绑定在一起了.它会发送消息或者线程到对应 <em>MessageQueue</em> ,并且在从 <em>MessageQueue</em> 取出的时候执行它们.<br>Handler主要有两个作用:一个是可以在未来的某个时间点执行消息或者线程 ;另一个是在你当前拥有的另一个线程中排队执行一些任务.<br>发送消息一般可以使用 post(Runnable),postAtTime(Runnable,long),postDelay(Runnable,long),sendEmptyMessage(int),sendMessage(Message),sendMessageAtTime(Message,long) 和 sendMessageDelay(Message,long).这几个方法.post开头的方法可以在消息队列入队的时候调用.而sendMessage开头的方法允许把一个带有bundle对象的消息对象入队,并在未来交给 <em>handleMessage(Message)</em> 去处理.</p>
</blockquote>
<p>  上面这个是我照着官方文档翻译的,水平有限,说白了就是Handler可以把消息对象或者线程放入消息队列中,等到出列的时候调用.<br>  比如当子线程中发送网络请求之后回调可以通过给主线程的handler发送一个message,这样可以把网络请求的回调结果返回到主线程中处理.</p>
<p>  下面开始分析Handler的源码:</p>
<h3 id="Handler源码分析"><a href="#Handler源码分析" class="headerlink" title="Handler源码分析"></a>Handler源码分析</h3><p>  我们先从Handler的使用入口来看,也就是那一堆post和sendMessage开头的方法入手,可以看到所有的传递事件的方法最终都是调用了 <em>sendMessageAtTime</em> :</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">sendMessageAtTime</span><span class="params">(Message msg, <span class="keyword">long</span> uptimeMillis)</span> </span>&#123;</div><div class="line">      MessageQueue queue = mQueue;</div><div class="line">      <span class="keyword">if</span> (queue == <span class="keyword">null</span>) &#123;</div><div class="line">          RuntimeException e = <span class="keyword">new</span> RuntimeException(</div><div class="line">                  <span class="keyword">this</span> + <span class="string">" sendMessageAtTime() called with no mQueue"</span>);</div><div class="line">          Log.w(<span class="string">"Looper"</span>, e.getMessage(), e);</div><div class="line">          <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> enqueueMessage(queue, msg, uptimeMillis);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>  post方法开头的只是多做了一部处理,把Runnable对象作为message的回调使用了,然后也是调用了 <em>sendMessageAtTime</em> :<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Message <span class="title">getPostMessage</span><span class="params">(Runnable r)</span> </span>&#123;</div><div class="line">    Message m = Message.obtain();</div><div class="line">    m.callback = r;</div><div class="line">    <span class="keyword">return</span> m;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>  可以看到在 <em>sendMessageAtTime</em> 的方法刚开始的时候显示判断消息队列 <em>MessageQueue</em> 是否为空,如果为空的直接返回false不予执行.那这个消息队列是从哪里来的的呢?这个时候回到Handler的构造方法:<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Handler</span><span class="params">()</span> </span>&#123;</div><div class="line">     <span class="keyword">this</span>(<span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line"> &#125;</div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="title">Handler</span><span class="params">(Callback callback)</span> </span>&#123;</div><div class="line">     <span class="keyword">this</span>(callback, <span class="keyword">false</span>);</div><div class="line"> &#125;</div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="title">Handler</span><span class="params">(Looper looper)</span> </span>&#123;</div><div class="line">     <span class="keyword">this</span>(looper, <span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line"> &#125;</div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="title">Handler</span><span class="params">(Looper looper, Callback callback)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>(looper, callback, <span class="keyword">false</span>);</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">*.......</div><div class="line">*<span class="doctag">@hide</span></div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Handler</span><span class="params">(<span class="keyword">boolean</span> async)</span> </span>&#123;</div><div class="line">      <span class="keyword">this</span>(<span class="keyword">null</span>, async);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Handler</span><span class="params">(Callback callback, <span class="keyword">boolean</span> async)</span> </span>&#123;</div><div class="line">     <span class="keyword">if</span> (FIND_POTENTIAL_LEAKS) &#123;</div><div class="line">         <span class="keyword">final</span> Class&lt;? extends Handler&gt; klass = getClass();</div><div class="line">         <span class="keyword">if</span> ((klass.isAnonymousClass() || klass.isMemberClass() || klass.isLocalClass()) &amp;&amp;</div><div class="line">                 (klass.getModifiers() &amp; Modifier.STATIC) == <span class="number">0</span>) &#123;</div><div class="line">             Log.w(TAG, <span class="string">"The following Handler class should be static or leaks might occur: "</span> +</div><div class="line">                 klass.getCanonicalName());</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     mLooper = Looper.myLooper();</div><div class="line">     <span class="keyword">if</span> (mLooper == <span class="keyword">null</span>) &#123;</div><div class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</div><div class="line">             <span class="string">"Can't create handler inside thread that has not called Looper.prepare()"</span>);</div><div class="line">     &#125;</div><div class="line">     mQueue = mLooper.mQueue;</div><div class="line">     mCallback = callback;</div><div class="line">     mAsynchronous = async;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>  这里有个细节就是6个构造函数的其中一个是不对外开放的,就是那个加了 <em>@hide</em> 注解的构造函数.也就是这个构造函数只能在手机自己内部调用,和android的internal包戏下面的代码一样,都是不对外开发的.</p>
<p>  可以看到在构造方法顶部有一个tip提示,就是说如果这里handler不是静态的话可能导致内存泄漏,这种情况是很常见的,内部类持有外部类的引用,也就是当前handler持有外部的activity对象,当activity销毁的时候,如果handler中还是有任务没有完成的,activity是无法被内存回收的.这就会导致内存泄漏,解决方法就是把handler设置为static并且把activity的关联设置为弱引用(WeakReference).</p>
<p>  继续往下看,开始调用 Looper.myLooper() 如果Looper对象为空的话抛出异常,看来handler必须能够获取到looper对象,否者没法往下执行.到了后面我们就知道,looper的作用是用来不停的从消息队列中取出消息来交给Handler来执行的.所以没有looper的话handler获取不到消息就没有了意义.<br>  在往下就会发现handler里面的 MessageQueue用的就是looper里面的mQueue.后面我们在分析looper的实现.现在消息队列有了,我们回到上面的 <em>sendMessageAtTime</em> 方法中.可以看到该方法最终调用了 <em>enqueueMessage</em> 方法.<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">enqueueMessage</span><span class="params">(MessageQueue queue, Message msg, <span class="keyword">long</span> uptimeMillis)</span> </span>&#123;</div><div class="line">     msg.target = <span class="keyword">this</span>;</div><div class="line">     <span class="keyword">if</span> (mAsynchronous) &#123;</div><div class="line">         msg.setAsynchronous(<span class="keyword">true</span>);</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">return</span> queue.enqueueMessage(msg, uptimeMillis);</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>  非常简单,调用消息队列自己的 <em>enqueueMessage</em> 方法,这里如果handler设置为异步(mAsynchronous)的话,那发送的消息类型也是异步的.至于异步有啥作用,我们后面会提到.<br>  可以看到Handler的代码非常的见到,就是把消息放入消息队列中就完成任务了.那怎么从消息队列中取出消息来回调了,这个功能就交给下面要讲的looper实现了.</p>
<h3 id="Looper的实现"><a href="#Looper的实现" class="headerlink" title="Looper的实现"></a>Looper的实现</h3><p>  上面看Handler得源码发现,其内部的消息队列指向的是Looper的内部的消息队列,那可以断定这个消息队列是由looper来维护的,同时由于每个线程都有一个唯一的线程队列,这个是怎么实现呢,可以马上想到之前我们学习过的 <em>ThreadLocal</em> 每个线程都拥有自己唯一的变量对象.这里就是 <em>ThreadLocal</em> 的典型实现场景了.</p>
<p>  可以看到Looper的构造函数是私有的,外面只能通过调用 <em>myLooper</em> 方法来获取到当前线程中的Looper对象.<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="meta">@Nullable</span> <span class="function">Looper <span class="title">myLooper</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> sThreadLocal.get();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Looper&gt; sThreadLocal = <span class="keyword">new</span> ThreadLocal&lt;Looper&gt;();</div></pre></td></tr></table></figure>
<p>  刚才说了Handler在发送之前必须得能通过 <em>myLooper</em> 方法获取到looper对象.但是这里的sThreadLocal并没有实现 <em>initialValue</em> 方法,所以必须得外部调用一个方法来给ThreadLocal赋值,这里使用的是 <em>prepare</em> 方法.<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">()</span> </span>&#123;</div><div class="line">      prepare(<span class="keyword">true</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(<span class="keyword">boolean</span> quitAllowed)</span> </span>&#123;</div><div class="line">      <span class="keyword">if</span> (sThreadLocal.get() != <span class="keyword">null</span>) &#123;</div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Only one Looper may be created per thread"</span>);</div><div class="line">      &#125;</div><div class="line">      sThreadLocal.set(<span class="keyword">new</span> Looper(quitAllowed));</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>  通过 <em>prepare</em> 方法,就可以是当前线程中的looper对象不为空了,同时handler就可以来发送消息了.so,可以看到在创建Handler之前的必备步骤必须先得调用一下Looper.prepare()方法,这样才能正常运行.<br>  这个时候有人可能会说,为啥在activity的使用过程中,我们并没有显式的调用 <em>Looper.prepare()</em> 方法呢,其实是activity在创建的时候已经在底层帮我们调用过了,这样朱祥成中的looper对象就不为空,我们就可以随便创建新的Handler而不用担心looper为空了.</p>
<p>  looper为主线程的looper提供了直接调用方法:<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepareMainLooper</span><span class="params">()</span> </span>&#123;</div><div class="line">     prepare(<span class="keyword">false</span>);</div><div class="line">     <span class="keyword">synchronized</span> (Looper.class) &#123;</div><div class="line">         <span class="keyword">if</span> (sMainLooper != <span class="keyword">null</span>) &#123;</div><div class="line">             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The main Looper has already been prepared."</span>);</div><div class="line">         &#125;</div><div class="line">         sMainLooper = myLooper();</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>  这个方法就是用来给UI主线程来生成唯一的looper的.我们平时经常通 <em>Looper.myLooper() == Looper.getMainLooper()</em> 来判断当前是不是在UI主线程中就是这个道理.<br>  looper的初始化完成后,怎么才能让消息队列的消息出列呢.这里是通过调用 <em>loop</em> 方法来完成的<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loop</span><span class="params">()</span> </span>&#123;</div><div class="line">     <span class="keyword">final</span> Looper me = myLooper();</div><div class="line">     <span class="keyword">if</span> (me == <span class="keyword">null</span>) &#123;</div><div class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"No Looper; Looper.prepare() wasn't called on this thread."</span>);</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">final</span> MessageQueue queue = me.mQueue;</div><div class="line"></div><div class="line">     <span class="comment">// Make sure the identity of this thread is that of the local process,</span></div><div class="line">     <span class="comment">// and keep track of what that identity token actually is.</span></div><div class="line">     Binder.clearCallingIdentity();</div><div class="line">     <span class="keyword">final</span> <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</div><div class="line"></div><div class="line">     <span class="keyword">for</span> (;;) &#123;</div><div class="line">         Message msg = queue.next(); <span class="comment">// might block</span></div><div class="line">         <span class="keyword">if</span> (msg == <span class="keyword">null</span>) &#123;</div><div class="line">             <span class="comment">// No message indicates that the message queue is quitting.</span></div><div class="line">             <span class="keyword">return</span>;</div><div class="line">         &#125;</div><div class="line"></div><div class="line">         <span class="comment">// This must be in a local variable, in case a UI event sets the logger</span></div><div class="line">         Printer logging = me.mLogging;</div><div class="line">         <span class="keyword">if</span> (logging != <span class="keyword">null</span>) &#123;</div><div class="line">             logging.println(<span class="string">"&gt;&gt;&gt;&gt;&gt; Dispatching to "</span> + msg.target + <span class="string">" "</span> +</div><div class="line">                     msg.callback + <span class="string">": "</span> + msg.what);</div><div class="line">         &#125;</div><div class="line"></div><div class="line">         msg.target.dispatchMessage(msg);</div><div class="line"></div><div class="line">         <span class="keyword">if</span> (logging != <span class="keyword">null</span>) &#123;</div><div class="line">             logging.println(<span class="string">"&lt;&lt;&lt;&lt;&lt; Finished to "</span> + msg.target + <span class="string">" "</span> + msg.callback);</div><div class="line">         &#125;</div><div class="line"></div><div class="line">         <span class="comment">// Make sure that during the course of dispatching the</span></div><div class="line">         <span class="comment">// identity of the thread wasn't corrupted.</span></div><div class="line">         <span class="keyword">final</span> <span class="keyword">long</span> newIdent = Binder.clearCallingIdentity();</div><div class="line">         <span class="keyword">if</span> (ident != newIdent) &#123;</div><div class="line">             Log.wtf(TAG, <span class="string">"Thread identity changed from 0x"</span></div><div class="line">                     + Long.toHexString(ident) + <span class="string">" to 0x"</span></div><div class="line">                     + Long.toHexString(newIdent) + <span class="string">" while dispatching to "</span></div><div class="line">                     + msg.target.getClass().getName() + <span class="string">" "</span></div><div class="line">                     + msg.callback + <span class="string">" what="</span> + msg.what);</div><div class="line">         &#125;</div><div class="line"></div><div class="line">         msg.recycleUnchecked();</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>  这里去掉无用信息之后,实际上就是调用了消息队列的 <em>next</em> 方法,如果取到新的消息对象,就交给消息对象的target也就是handler来处理.同时也看到在注释写到消息队列的next方法可能会阻塞.回到了handler的 <em>dispatchMessage</em> 方法中了</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Handle system messages here.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (msg.callback != <span class="keyword">null</span>) &#123;</div><div class="line">        handleCallback(msg);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">if</span> (mCallback != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (mCallback.handleMessage(msg)) &#123;</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        handleMessage(msg);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handleCallback</span><span class="params">(Message message)</span> </span>&#123;</div><div class="line">       message.callback.run();</div><div class="line">   &#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* Subclasses must implement this to receive messages.</div><div class="line">*/</div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>  这里可以看到,如果是post的时候,调用callBack,如果是sendMessage的话直接调用handleMessage,这个方法是个空方法,是交给我们自己根据需求去实现的.</p>
<p>  这里其实一直有一个疑问,就是明明在线程中调用Handler的post方法,传入一个线程对象,为啥就说这玩意是在主线程中运行的呢?明明代码都在线程里面的,要运行也应该是在子线程中运行,为啥大家都说是在主线程中运行?<br>  今天才明白了,一直忽略了一个细节,就是上面的 <em>handleCallback</em> 的内部实现,细细看它里面内部调用的居然是callback的 <em>run</em> 方法,而不是咱们一直使用的 <em>start</em> 方法,二者唯一的区别就是start是新开一个线程来执行run方法中的代码,而run方法是直接在当前线程中执行run方法中的代码,这是二者的不同之处,so,这里其实是在主线程中直接执行了run方法中的代码,那个子线程根本就没有运行,相当于一个普通的对象.</p>
<p>  到这里looper的功能就讲完了,可以看到looper就是不断的从消息队列中取消息的作用.<br>  下面我们进入消息队列的具体实现,来重点看一下两个方法 <em>enqueueMessage</em> , <em>next</em>:</p>
<h3 id="MessageQueue的实现"><a href="#MessageQueue的实现" class="headerlink" title="MessageQueue的实现"></a>MessageQueue的实现</h3><p>  先来看 <em>enqueueMessage</em> 的实现:<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">enqueueMessage</span><span class="params">(Message msg, <span class="keyword">long</span> when)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (msg.target == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Message must have a target."</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (msg.isInUse()) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(msg + <span class="string">" This message is already in use."</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (mQuitting) &#123;</div><div class="line">            IllegalStateException e = <span class="keyword">new</span> IllegalStateException(</div><div class="line">                    msg.target + <span class="string">" sending message to a Handler on a dead thread"</span>);</div><div class="line">            Log.w(TAG, e.getMessage(), e);</div><div class="line">            msg.recycle();</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        msg.markInUse();</div><div class="line">        msg.when = when;</div><div class="line">        Message p = mMessages;</div><div class="line">        <span class="keyword">boolean</span> needWake;</div><div class="line">        <span class="keyword">if</span> (p == <span class="keyword">null</span> || when == <span class="number">0</span> || when &lt; p.when) &#123;</div><div class="line">            <span class="comment">// New head, wake up the event queue if blocked.</span></div><div class="line">            msg.next = p;</div><div class="line">            mMessages = msg;</div><div class="line">            needWake = mBlocked;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// Inserted within the middle of the queue.  Usually we don't have to wake</span></div><div class="line">            <span class="comment">// up the event queue unless there is a barrier at the head of the queue</span></div><div class="line">            <span class="comment">// and the message is the earliest asynchronous message in the queue.</span></div><div class="line">            needWake = mBlocked &amp;&amp; p.target == <span class="keyword">null</span> &amp;&amp; msg.isAsynchronous();</div><div class="line">            Message prev;</div><div class="line">            <span class="keyword">for</span> (;;) &#123;</div><div class="line">                prev = p;</div><div class="line">                p = p.next;</div><div class="line">                <span class="keyword">if</span> (p == <span class="keyword">null</span> || when &lt; p.when) &#123;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (needWake &amp;&amp; p.isAsynchronous()) &#123;</div><div class="line">                    needWake = <span class="keyword">false</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            msg.next = p; <span class="comment">// invariant: p == prev.next</span></div><div class="line">            prev.next = msg;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// We can assume mPtr != 0 because mQuitting is false.</span></div><div class="line">        <span class="keyword">if</span> (needWake) &#123;</div><div class="line">            nativeWake(mPtr);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>  可以很明显的看出消息队列实际上是一个单向链表的实现.这里的全局变量 <em>mMessages</em> 代表着初始的头结点,如果刚开始列表为空的话就把当前的入队的message作为头结点,如果不为空的话就遍历整个列表直到找到触发时间(when)小于当前的message的消息,把message插入他的后面.</p>
<p>  这里的needWake变量是用来处理如果是异步任务的时候来h唤醒队列用的,平时我们用不到,这里不深入讲了</p>
<p>  下面再来看下 <em>next</em> 方法是如何阻塞线程的:<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div></pre></td><td class="code"><pre><div class="line"><span class="function">Message <span class="title">next</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="comment">// Return here if the message loop has already quit and been disposed.</span></div><div class="line">      <span class="comment">// This can happen if the application tries to restart a looper after quit</span></div><div class="line">      <span class="comment">// which is not supported.</span></div><div class="line">      <span class="keyword">final</span> <span class="keyword">long</span> ptr = mPtr;</div><div class="line">      <span class="keyword">if</span> (ptr == <span class="number">0</span>) &#123;</div><div class="line">          <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">int</span> pendingIdleHandlerCount = -<span class="number">1</span>; <span class="comment">// -1 only during first iteration</span></div><div class="line">      <span class="keyword">int</span> nextPollTimeoutMillis = <span class="number">0</span>;</div><div class="line">      <span class="keyword">for</span> (;;) &#123;</div><div class="line">          <span class="keyword">if</span> (nextPollTimeoutMillis != <span class="number">0</span>) &#123;</div><div class="line">              Binder.flushPendingCommands();</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          nativePollOnce(ptr, nextPollTimeoutMillis);</div><div class="line"></div><div class="line">          <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">              <span class="comment">// Try to retrieve the next message.  Return if found.</span></div><div class="line">              <span class="keyword">final</span> <span class="keyword">long</span> now = SystemClock.uptimeMillis();</div><div class="line">              Message prevMsg = <span class="keyword">null</span>;</div><div class="line">              Message msg = mMessages;</div><div class="line">              <span class="keyword">if</span> (msg != <span class="keyword">null</span> &amp;&amp; msg.target == <span class="keyword">null</span>) &#123;</div><div class="line">                  <span class="comment">// Stalled by a barrier.  Find the next asynchronous message in the queue.</span></div><div class="line">                  <span class="keyword">do</span> &#123;</div><div class="line">                      prevMsg = msg;</div><div class="line">                      msg = msg.next;</div><div class="line">                  &#125; <span class="keyword">while</span> (msg != <span class="keyword">null</span> &amp;&amp; !msg.isAsynchronous());</div><div class="line">              &#125;</div><div class="line">              <span class="keyword">if</span> (msg != <span class="keyword">null</span>) &#123;</div><div class="line">                  <span class="keyword">if</span> (now &lt; msg.when) &#123;</div><div class="line">                      <span class="comment">// Next message is not ready.  Set a timeout to wake up when it is ready.</span></div><div class="line">                      nextPollTimeoutMillis = (<span class="keyword">int</span>) Math.min(msg.when - now, Integer.MAX_VALUE);</div><div class="line">                  &#125; <span class="keyword">else</span> &#123;</div><div class="line">                      <span class="comment">// Got a message.</span></div><div class="line">                      mBlocked = <span class="keyword">false</span>;</div><div class="line">                      <span class="keyword">if</span> (prevMsg != <span class="keyword">null</span>) &#123;</div><div class="line">                          prevMsg.next = msg.next;</div><div class="line">                      &#125; <span class="keyword">else</span> &#123;</div><div class="line">                          mMessages = msg.next;</div><div class="line">                      &#125;</div><div class="line">                      msg.next = <span class="keyword">null</span>;</div><div class="line">                      <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">"Returning message: "</span> + msg);</div><div class="line">                      msg.markInUse();</div><div class="line">                      <span class="keyword">return</span> msg;</div><div class="line">                  &#125;</div><div class="line">              &#125; <span class="keyword">else</span> &#123;</div><div class="line">                  <span class="comment">// No more messages.</span></div><div class="line">                  nextPollTimeoutMillis = -<span class="number">1</span>;</div><div class="line">              &#125;</div><div class="line"></div><div class="line">              <span class="comment">// Process the quit message now that all pending messages have been handled.</span></div><div class="line">              <span class="keyword">if</span> (mQuitting) &#123;</div><div class="line">                  dispose();</div><div class="line">                  <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">              &#125;</div><div class="line"></div><div class="line">              <span class="comment">// If first time idle, then get the number of idlers to run.</span></div><div class="line">              <span class="comment">// Idle handles only run if the queue is empty or if the first message</span></div><div class="line">              <span class="comment">// in the queue (possibly a barrier) is due to be handled in the future.</span></div><div class="line">              <span class="keyword">if</span> (pendingIdleHandlerCount &lt; <span class="number">0</span></div><div class="line">                      &amp;&amp; (mMessages == <span class="keyword">null</span> || now &lt; mMessages.when)) &#123;</div><div class="line">                  pendingIdleHandlerCount = mIdleHandlers.size();</div><div class="line">              &#125;</div><div class="line">              <span class="keyword">if</span> (pendingIdleHandlerCount &lt;= <span class="number">0</span>) &#123;</div><div class="line">                  <span class="comment">// No idle handlers to run.  Loop and wait some more.</span></div><div class="line">                  mBlocked = <span class="keyword">true</span>;</div><div class="line">                  <span class="keyword">continue</span>;</div><div class="line">              &#125;</div><div class="line"></div><div class="line">              <span class="keyword">if</span> (mPendingIdleHandlers == <span class="keyword">null</span>) &#123;</div><div class="line">                  mPendingIdleHandlers = <span class="keyword">new</span> IdleHandler[Math.max(pendingIdleHandlerCount, <span class="number">4</span>)];</div><div class="line">              &#125;</div><div class="line">              mPendingIdleHandlers = mIdleHandlers.toArray(mPendingIdleHandlers);</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="comment">// Run the idle handlers.</span></div><div class="line">          <span class="comment">// We only ever reach this code block during the first iteration.</span></div><div class="line">          <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pendingIdleHandlerCount; i++) &#123;</div><div class="line">              <span class="keyword">final</span> IdleHandler idler = mPendingIdleHandlers[i];</div><div class="line">              mPendingIdleHandlers[i] = <span class="keyword">null</span>; <span class="comment">// release the reference to the handler</span></div><div class="line"></div><div class="line">              <span class="keyword">boolean</span> keep = <span class="keyword">false</span>;</div><div class="line">              <span class="keyword">try</span> &#123;</div><div class="line">                  keep = idler.queueIdle();</div><div class="line">              &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                  Log.wtf(TAG, <span class="string">"IdleHandler threw exception"</span>, t);</div><div class="line">              &#125;</div><div class="line"></div><div class="line">              <span class="keyword">if</span> (!keep) &#123;</div><div class="line">                  <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">                      mIdleHandlers.remove(idler);</div><div class="line">                  &#125;</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="comment">// Reset the idle handler count to 0 so we do not run them again.</span></div><div class="line">          pendingIdleHandlerCount = <span class="number">0</span>;</div><div class="line"></div><div class="line">          <span class="comment">// While calling an idle handler, a new message could have been delivered</span></div><div class="line">          <span class="comment">// so go back and look again for a pending message without waiting.</span></div><div class="line">          nextPollTimeoutMillis = <span class="number">0</span>;</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>  可以看到这里已经来就弄出一个死循环来,就是这么的霸气,通过这个循环来不断从链表中获取头结点的message对象,for循环开始有一个 <em>nativePollOnce</em><br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nativePollOnce(ptr, nextPollTimeoutMillis);</div></pre></td></tr></table></figure></p>
<p>  这个方法是一个native方法,作用就是在指定的时间内唤醒ptr,也就是消息队列的内存地址.</p>
<p>  那这个参数 <em>nextPollTimeoutMillis</em> 就很是关键点了.如果头结点不为空的话,判断一下当前事件是不是小于message的when,如果小于说明还没有到消息出列的时候,把 <em>nextPollTimeoutMillis</em> 调整为二者的差值,等待下次的唤醒.如果时间正好,就把头结点返回,链表前移.<br>  有点像你定了6点闹钟上班,5点半醒了发现没到点就继续睡半小时的,等到了6点闹钟响了你就起床上班了.差不多就是这个意思.</p>
<p>  核心逻辑走完之后地下出现了一个 <em>IdleHandler</em> 数组,并调用了 <em>queueIdle</em> 这个东西的作用就是用来在消息队列空闲的时候执行一些额外的工作.比如GC说明的,你可以根据需要调用消息队列的 <em>addIdleHandler</em><br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addIdleHandler</span><span class="params">(@NonNull IdleHandler handler)</span> </span>&#123;</div><div class="line">     <span class="keyword">if</span> (handler == <span class="keyword">null</span>) &#123;</div><div class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"Can't add a null IdleHandler"</span>);</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">         mIdleHandlers.add(handler);</div><div class="line">     &#125;</div><div class="line"> &#125;</div><div class="line"></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeIdleHandler</span><span class="params">(@NonNull IdleHandler handler)</span> </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">            mIdleHandlers.remove(handler);</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>  最后的最后我们可以看到在 <em>next</em> 方法中判断如果message的target为空的时候的处理.那什么情况下message的target为空的,是在消息队列中的 <em>postSyncBarrier</em><br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">postSyncBarrier</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> postSyncBarrier(SystemClock.uptimeMillis());</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">postSyncBarrier</span><span class="params">(<span class="keyword">long</span> when)</span> </span>&#123;</div><div class="line">      <span class="comment">// Enqueue a new sync barrier token.</span></div><div class="line">      <span class="comment">// We don't need to wake the queue because the purpose of a barrier is to stall it.</span></div><div class="line">      <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">          <span class="keyword">final</span> <span class="keyword">int</span> token = mNextBarrierToken++;</div><div class="line">          <span class="keyword">final</span> Message msg = Message.obtain();</div><div class="line">          msg.markInUse();</div><div class="line">          msg.when = when;</div><div class="line">          msg.arg1 = token;</div><div class="line"></div><div class="line">          Message prev = <span class="keyword">null</span>;</div><div class="line">          Message p = mMessages;</div><div class="line">          <span class="keyword">if</span> (when != <span class="number">0</span>) &#123;</div><div class="line">              <span class="keyword">while</span> (p != <span class="keyword">null</span> &amp;&amp; p.when &lt;= when) &#123;</div><div class="line">                  prev = p;</div><div class="line">                  p = p.next;</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">if</span> (prev != <span class="keyword">null</span>) &#123; <span class="comment">// invariant: p == prev.next</span></div><div class="line">              msg.next = p;</div><div class="line">              prev.next = msg;</div><div class="line">          &#125; <span class="keyword">else</span> &#123;</div><div class="line">              msg.next = p;</div><div class="line">              mMessages = msg;</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">return</span> token;</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>  这个barrier的作用翻译过来叫栅栏,也就是用来阻隔消息继续发送的.如果你调用了 <em>postSyncBarrier</em> 那这个时间点之后的同步消息都不会执行了,除非了你把它移除掉,调用 <em>removeSyncBarrier</em> .这里不包括异步消息,异步消息还是可以继续执行的.我们平时调用的都是同步消息,异步消息应该是系统内部使用的.<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeSyncBarrier</span><span class="params">(<span class="keyword">int</span> token)</span> </span>&#123;</div><div class="line">     <span class="comment">// Remove a sync barrier token from the queue.</span></div><div class="line">     <span class="comment">// If the queue is no longer stalled by a barrier then wake it.</span></div><div class="line">     <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">         Message prev = <span class="keyword">null</span>;</div><div class="line">         Message p = mMessages;</div><div class="line">         <span class="keyword">while</span> (p != <span class="keyword">null</span> &amp;&amp; (p.target != <span class="keyword">null</span> || p.arg1 != token)) &#123;</div><div class="line">             prev = p;</div><div class="line">             p = p.next;</div><div class="line">         &#125;</div><div class="line">         <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</div><div class="line">             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The specified message queue synchronization "</span></div><div class="line">                     + <span class="string">" barrier token has not been posted or has already been removed."</span>);</div><div class="line">         &#125;</div><div class="line">         <span class="keyword">final</span> <span class="keyword">boolean</span> needWake;</div><div class="line">         <span class="keyword">if</span> (prev != <span class="keyword">null</span>) &#123;</div><div class="line">             prev.next = p.next;</div><div class="line">             needWake = <span class="keyword">false</span>;</div><div class="line">         &#125; <span class="keyword">else</span> &#123;</div><div class="line">             mMessages = p.next;</div><div class="line">             needWake = mMessages == <span class="keyword">null</span> || mMessages.target != <span class="keyword">null</span>;</div><div class="line">         &#125;</div><div class="line">         p.recycleUnchecked();</div><div class="line"></div><div class="line">         <span class="comment">// If the loop is quitting then it is already awake.</span></div><div class="line">         <span class="comment">// We can assume mPtr != 0 when mQuitting is false.</span></div><div class="line">         <span class="keyword">if</span> (needWake &amp;&amp; !mQuitting) &#123;</div><div class="line">             nativeWake(mPtr);</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>  消息队列的大概流程就讲完了,最后我们来看下Message对象的内部实现:</p>
<h3 id="Message源码"><a href="#Message源码" class="headerlink" title="Message源码"></a>Message源码</h3><p>  可以看到在Message中提供了一系列的obtain方法来用来初始赋值,这里有个简单对象池的实现,值得我们注意下:</p>
<p>  在上面的looper的loop方法中,当取出message之后并交给message的target执行完成后,后面有一句 <em>msg.recycleUnchecked();</em> 用来回收message对象<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">recycleUnchecked</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// Mark the message as in use while it remains in the recycled object pool.</span></div><div class="line">    <span class="comment">// Clear out all other details.</span></div><div class="line">    flags = FLAG_IN_USE;</div><div class="line">    what = <span class="number">0</span>;</div><div class="line">    arg1 = <span class="number">0</span>;</div><div class="line">    arg2 = <span class="number">0</span>;</div><div class="line">    obj = <span class="keyword">null</span>;</div><div class="line">    replyTo = <span class="keyword">null</span>;</div><div class="line">    sendingUid = -<span class="number">1</span>;</div><div class="line">    when = <span class="number">0</span>;</div><div class="line">    target = <span class="keyword">null</span>;</div><div class="line">    callback = <span class="keyword">null</span>;</div><div class="line">    data = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="keyword">synchronized</span> (sPoolSync) &#123;</div><div class="line">        <span class="keyword">if</span> (sPoolSize &lt; MAX_POOL_SIZE) &#123;</div><div class="line">            next = sPool;</div><div class="line">            sPool = <span class="keyword">this</span>;</div><div class="line">            sPoolSize++;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>  可以看到这里把用完的对象清空属性之后赋给了sPool,达到了回收的目的.<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Message <span class="title">obtain</span><span class="params">()</span> </span>&#123;</div><div class="line">     <span class="keyword">synchronized</span> (sPoolSync) &#123;</div><div class="line">         <span class="keyword">if</span> (sPool != <span class="keyword">null</span>) &#123;</div><div class="line">             Message m = sPool;</div><div class="line">             sPool = m.next;</div><div class="line">             m.next = <span class="keyword">null</span>;</div><div class="line">             m.flags = <span class="number">0</span>; <span class="comment">// clear in-use flag</span></div><div class="line">             sPoolSize--;</div><div class="line">             <span class="keyword">return</span> m;</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">return</span> <span class="keyword">new</span> Message();</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>  可以看到在obtain的时候优先从sPool中获取是否有么有使用的Message对象,如果有的话就直接使用了,没有的时候才创建新的Message对象.所以为了节约内存,最好还是使用obtain方法.</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>看了下Handler,Looper,MessageQueue的源码感觉难点是在 MessageQueue的内部 <em>next</em> 方法中,里面有一些底层native的东西,自己不是很了解,耽搁了点时间来消化.至于Handler和Looper上层实现还是比较简单的.那么,handler的讲解就到这里.</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a href="https://hjdzone.gitbooks.io/thinkandroid/content/ThreadMessage/Chapter_1_6.html" title="MessageQueue源码分析" target="_blank" rel="external">MessageQueue源码分析</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/01/03/2017/android Handler,Looper,MessageQueue源码分析/" data-id="cizy2lg0w001lszs6h6pfdeed" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2017/android universal image loader源码分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/01/2017/android universal image loader源码分析/" class="article-date">
  <time datetime="2017-01-01T02:21:00.000Z" itemprop="datePublished">2017-01-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/01/2017/android universal image loader源码分析/">android universal image loader源码分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="android-universal-image-loader-源码分析"><a href="#android-universal-image-loader-源码分析" class="headerlink" title="android universal image loader 源码分析"></a>android universal image loader 源码分析</h2><p>  UIL是在android中4大主流图片加载框架之一,它为图片加载提供了一套功能强大,灵活和高可定制性的解决方案,具有非常重要的学习意义,虽然该项目目前已经不维护了,但是很多程序依然在使用着,所以本期重点来学习UIL的内部实现,看看作者的实现思路和我们平时实现的图片加载有什么区别和共同点.</p>
<p>  说道图片加载我们常用的3级缓存,先从内存中找对应url的图片,如果没有找到就从手机存储中找,如果还没找到就从网络上去下载.这里的内存,磁盘,网络称为图片加载3级缓存.我么以前的实现也就是这么个大概流程,唯一需要注意的是从本地磁盘加载和从服务器下载是需要在子线程中工作,否者在主线程中耗时太长会阻塞主线程,导致ANR等等问题.</p>
<p>  UIL的实现流程也是这样的,唯一不用的是对三层的定义通过接口来完成灵活的定制,同时内部通过线程池来统一调度任务,还有一些对图片的Bitmap对象的二次处理等等,这些东西我们在下面都会讲到,总之非常值得学习.</p>
<p>  下面这张图是作者画的UIL的流程图,从图中可以看出和我们上面分析的流程类似<br><img src="images/2017/01/UIL_Flow.png" alt="  UIL流程图"></p>
<h3 id="UIL源码分析"><a href="#UIL源码分析" class="headerlink" title="UIL源码分析"></a>UIL源码分析</h3><h4 id="ImageLoader"><a href="#ImageLoader" class="headerlink" title="ImageLoader"></a>ImageLoader</h4><p>首先因为全局只有一个ImageLoader对象来管理加载,so,肯定是个单例:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> ImageLoader instance;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ImageLoader <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">synchronized</span> (ImageLoader.class) &#123;</div><div class="line">				<span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</div><div class="line">					instance = <span class="keyword">new</span> ImageLoader();</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> instance;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>然后把各种配置作为一个对象也就是下面提到的 <em>ImageLoaderConfiguration</em> 传给ImageLoader对象来完成配置,这里调用了init方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ImageLoaderConfiguration configuration)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (configuration == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(ERROR_INIT_CONFIG_WITH_NULL);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.configuration == <span class="keyword">null</span>) &#123;</div><div class="line">			L.d(LOG_INIT_CONFIG);</div><div class="line">			engine = <span class="keyword">new</span> ImageLoaderEngine(configuration);</div><div class="line">			<span class="keyword">this</span>.configuration = configuration;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			L.w(WARNING_RE_INIT_CONFIG);</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>注意这里,通过代码发现如果你要修改配置,直接二次调用init方法是无效的,应该先ImageLoader的destroy方法,然后再重新初始化</p>
<blockquote>
<p>Try to initialize ImageLoader which had already been initialized before. “ + “To re-init ImageLoader with new configuration call &gt;ImageLoader.destroy() at first.”;</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (configuration != <span class="keyword">null</span>) L.d(LOG_DESTROY);</div><div class="line">		stop();</div><div class="line">		configuration.diskCache.close();</div><div class="line">		engine = <span class="keyword">null</span>;</div><div class="line">		configuration = <span class="keyword">null</span>;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>可以看到这里在destroy的时候把config对象置空了.</p>
<h5 id="核心displayImage方法"><a href="#核心displayImage方法" class="headerlink" title="核心displayImage方法"></a>核心displayImage方法</h5><p>上面的init方法初始化了一个 <em>ImageLoaderEngine</em> 对象,并把config对象传入了,这里暂时先不讲该对象的实现,先从外部是如何调用ImageLoader显示图片的方法来看起,用的最多的就是 <em>displayImage</em> 这个对象.我们常用到的方法是这个:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">displayImage</span><span class="params">(String uri, ImageView imageView, DisplayImageOptions options)</span> </span>&#123;</div><div class="line">		displayImage(uri, <span class="keyword">new</span> ImageViewAware(imageView), options, <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>等一系列的重载方法,最终,这些方法会进入下面的这个 <em>displayImage</em> 方法中.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">displayImage</span><span class="params">(String uri, ImageAware imageAware, DisplayImageOptions options,</span></span></div><div class="line">			ImageSize targetSize, ImageLoadingListener listener, ImageLoadingProgressListener progressListener) &#123;</div><div class="line">		checkConfiguration();</div><div class="line">		<span class="keyword">if</span> (imageAware == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(ERROR_WRONG_ARGUMENTS);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (listener == <span class="keyword">null</span>) &#123;</div><div class="line">			listener = defaultListener;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (options == <span class="keyword">null</span>) &#123;</div><div class="line">			options = configuration.defaultDisplayImageOptions;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (TextUtils.isEmpty(uri)) &#123;</div><div class="line">			engine.cancelDisplayTaskFor(imageAware);</div><div class="line">			listener.onLoadingStarted(uri, imageAware.getWrappedView());</div><div class="line">			<span class="keyword">if</span> (options.shouldShowImageForEmptyUri()) &#123;</div><div class="line">				imageAware.setImageDrawable(options.getImageForEmptyUri(configuration.resources));</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				imageAware.setImageDrawable(<span class="keyword">null</span>);</div><div class="line">			&#125;</div><div class="line">			listener.onLoadingComplete(uri, imageAware.getWrappedView(), <span class="keyword">null</span>);</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (targetSize == <span class="keyword">null</span>) &#123;</div><div class="line">			targetSize = ImageSizeUtils.defineTargetSizeForView(imageAware, configuration.getMaxImageSize());</div><div class="line">		&#125;</div><div class="line">		String memoryCacheKey = MemoryCacheUtils.generateKey(uri, targetSize);</div><div class="line">		engine.prepareDisplayTaskFor(imageAware, memoryCacheKey);</div><div class="line"></div><div class="line">		listener.onLoadingStarted(uri, imageAware.getWrappedView());</div><div class="line"></div><div class="line">		Bitmap bmp = configuration.memoryCache.get(memoryCacheKey);</div><div class="line">		<span class="keyword">if</span> (bmp != <span class="keyword">null</span> &amp;&amp; !bmp.isRecycled()) &#123;</div><div class="line">			L.d(LOG_LOAD_IMAGE_FROM_MEMORY_CACHE, memoryCacheKey);</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (options.shouldPostProcess()) &#123;</div><div class="line">				ImageLoadingInfo imageLoadingInfo = <span class="keyword">new</span> ImageLoadingInfo(uri, imageAware, targetSize, memoryCacheKey,</div><div class="line">						options, listener, progressListener, engine.getLockForUri(uri));</div><div class="line">				ProcessAndDisplayImageTask displayTask = <span class="keyword">new</span> ProcessAndDisplayImageTask(engine, bmp, imageLoadingInfo,</div><div class="line">						defineHandler(options));</div><div class="line">				<span class="keyword">if</span> (options.isSyncLoading()) &#123;</div><div class="line">					displayTask.run();</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					engine.submit(displayTask);</div><div class="line">				&#125;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				options.getDisplayer().display(bmp, imageAware, LoadedFrom.MEMORY_CACHE);</div><div class="line">				listener.onLoadingComplete(uri, imageAware.getWrappedView(), bmp);</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">if</span> (options.shouldShowImageOnLoading()) &#123;</div><div class="line">				imageAware.setImageDrawable(options.getImageOnLoading(configuration.resources));</div><div class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (options.isResetViewBeforeLoading()) &#123;</div><div class="line">				imageAware.setImageDrawable(<span class="keyword">null</span>);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			ImageLoadingInfo imageLoadingInfo = <span class="keyword">new</span> ImageLoadingInfo(uri, imageAware, targetSize, memoryCacheKey,</div><div class="line">					options, listener, progressListener, engine.getLockForUri(uri));</div><div class="line">			LoadAndDisplayImageTask displayTask = <span class="keyword">new</span> LoadAndDisplayImageTask(engine, imageLoadingInfo,</div><div class="line">					defineHandler(options));</div><div class="line">			<span class="keyword">if</span> (options.isSyncLoading()) &#123;</div><div class="line">				displayTask.run();</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				engine.submit(displayTask);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>这个方法是ImageLoader的核心方法,所有的显示图片的逻辑都是在这里完成,包括我们上面提到的3级缓存的调用,都是在这里完成初始化然后交给 <em>ImageLoaderEngine</em> 来控制完成的.<br>我们把这个方法分为3个部分:参数检查和加载前listener回调准备,从内存中获取到了想要的Bitmap对象和最后没有从内存中获取到Bitmap的逻辑.</p>
<p>先看第一部分,参数检查和加载前listener回调准备<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">  checkConfiguration();</div><div class="line"><span class="keyword">if</span> (imageAware == <span class="keyword">null</span>) &#123;</div><div class="line">	<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(ERROR_WRONG_ARGUMENTS);</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span> (listener == <span class="keyword">null</span>) &#123;</div><div class="line">	listener = defaultListener;</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span> (options == <span class="keyword">null</span>) &#123;</div><div class="line">	options = configuration.defaultDisplayImageOptions;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (TextUtils.isEmpty(uri)) &#123;</div><div class="line">	engine.cancelDisplayTaskFor(imageAware);</div><div class="line">	listener.onLoadingStarted(uri, imageAware.getWrappedView());</div><div class="line">	<span class="keyword">if</span> (options.shouldShowImageForEmptyUri()) &#123;</div><div class="line">		imageAware.setImageDrawable(options.getImageForEmptyUri(configuration.resources));</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		imageAware.setImageDrawable(<span class="keyword">null</span>);</div><div class="line">	&#125;</div><div class="line">	listener.onLoadingComplete(uri, imageAware.getWrappedView(), <span class="keyword">null</span>);</div><div class="line">	<span class="keyword">return</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (targetSize == <span class="keyword">null</span>) &#123;</div><div class="line">	targetSize = ImageSizeUtils.defineTargetSizeForView(imageAware, configuration.getMaxImageSize());</div><div class="line">&#125;</div><div class="line">String memoryCacheKey = MemoryCacheUtils.generateKey(uri, targetSize);</div><div class="line">engine.prepareDisplayTaskFor(imageAware, memoryCacheKey);</div><div class="line"></div><div class="line">listener.onLoadingStarted(uri, imageAware.getWrappedView());</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkConfiguration</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (configuration == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(ERROR_NOT_INIT);</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>检查配置对象是否加载成功,如果没有的throw一个异常出去.<br>这里的 <em>imageAware</em> 对象实际上是对加载图片的view的一个包装,下面来看ImageAware的实现</p>
<h5 id="ImageAware对象"><a href="#ImageAware对象" class="headerlink" title="ImageAware对象"></a>ImageAware对象</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ImageAware</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">int</span> <span class="title">getWidth</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">	<span class="function">ViewScaleType <span class="title">getScaleType</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">	<span class="function">View <span class="title">getWrappedView</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">isCollected</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">setImageDrawable</span><span class="params">(Drawable drawable)</span></span>;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">setImageBitmap</span><span class="params">(Bitmap bitmap)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过代码我们发现 <em>ImageAware</em> 居然是一个接口,为什么要这样做呢,是因为不仅仅是ImageView可以加载图片,其他的view也是可以的,所以这里做了一层封装,只要是实现了ImageAware接口的view或者对象都是可以完成加载图片的操作的.</p>
<p>通过ImageAware所在的目录我们找到了下面的 <em>ImageViewAware</em> 对象,这个对象就是我们最常用的ImageView的包装对象了,来看它的实现.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewAware</span> <span class="keyword">implements</span> <span class="title">ImageAware</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String WARN_CANT_SET_DRAWABLE = <span class="string">"Can't set a drawable into view. You should call ImageLoader on UI thread for it."</span>;</div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String WARN_CANT_SET_BITMAP = <span class="string">"Can't set a bitmap into view. You should call ImageLoader on UI thread for it."</span>;</div><div class="line"></div><div class="line">	<span class="keyword">protected</span> Reference&lt;View&gt; viewRef;</div><div class="line">	<span class="keyword">protected</span> <span class="keyword">boolean</span> checkActualViewSize;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ViewAware</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>(view, <span class="keyword">true</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ViewAware</span><span class="params">(View view, <span class="keyword">boolean</span> checkActualViewSize)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (view == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"view must not be null"</span>);</div><div class="line"></div><div class="line">		<span class="keyword">this</span>.viewRef = <span class="keyword">new</span> WeakReference&lt;View&gt;(view);</div><div class="line">		<span class="keyword">this</span>.checkActualViewSize = checkActualViewSize;</div><div class="line">	&#125;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getWidth</span><span class="params">()</span> </span>&#123;</div><div class="line">		View view = viewRef.get();</div><div class="line">		<span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">final</span> ViewGroup.LayoutParams params = view.getLayoutParams();</div><div class="line">			<span class="keyword">int</span> width = <span class="number">0</span>;</div><div class="line">			<span class="keyword">if</span> (checkActualViewSize &amp;&amp; params != <span class="keyword">null</span> &amp;&amp; params.width != ViewGroup.LayoutParams.WRAP_CONTENT) &#123;</div><div class="line">				width = view.getWidth(); <span class="comment">// Get actual image width</span></div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (width &lt;= <span class="number">0</span> &amp;&amp; params != <span class="keyword">null</span>) width = params.width; <span class="comment">// Get layout width parameter</span></div><div class="line">			<span class="keyword">return</span> width;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getHeight</span><span class="params">()</span> </span>&#123;</div><div class="line">		View view = viewRef.get();</div><div class="line">		<span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">final</span> ViewGroup.LayoutParams params = view.getLayoutParams();</div><div class="line">			<span class="keyword">int</span> height = <span class="number">0</span>;</div><div class="line">			<span class="keyword">if</span> (checkActualViewSize &amp;&amp; params != <span class="keyword">null</span> &amp;&amp; params.height != ViewGroup.LayoutParams.WRAP_CONTENT) &#123;</div><div class="line">				height = view.getHeight(); <span class="comment">// Get actual image height</span></div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (height &lt;= <span class="number">0</span> &amp;&amp; params != <span class="keyword">null</span>) height = params.height; <span class="comment">// Get layout height parameter</span></div><div class="line">			<span class="keyword">return</span> height;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> ViewScaleType <span class="title">getScaleType</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> ViewScaleType.CROP;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> View <span class="title">getWrappedView</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> viewRef.get();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isCollected</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> viewRef.get() == <span class="keyword">null</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;</div><div class="line">		View view = viewRef.get();</div><div class="line">		<span class="keyword">return</span> view == <span class="keyword">null</span> ? <span class="keyword">super</span>.hashCode() : view.hashCode();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">setImageDrawable</span><span class="params">(Drawable drawable)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (Looper.myLooper() == Looper.getMainLooper()) &#123;</div><div class="line">			View view = viewRef.get();</div><div class="line">			<span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</div><div class="line">				setImageDrawableInto(drawable, view);</div><div class="line">				<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			L.w(WARN_CANT_SET_DRAWABLE);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">setImageBitmap</span><span class="params">(Bitmap bitmap)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (Looper.myLooper() == Looper.getMainLooper()) &#123;</div><div class="line">			View view = viewRef.get();</div><div class="line">			<span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</div><div class="line">				setImageBitmapInto(bitmap, view);</div><div class="line">				<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			L.w(WARN_CANT_SET_BITMAP);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Should set drawable into incoming view. Incoming view is guaranteed not null.&lt;br /&gt;</div><div class="line">	 * This method is called on UI thread.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">setImageDrawableInto</span><span class="params">(Drawable drawable, View view)</span></span>;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Should set Bitmap into incoming view. Incoming view is guaranteed not null.&lt; br /&gt;</div><div class="line">	 * This method is called on UI thread.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">setImageBitmapInto</span><span class="params">(Bitmap bitmap, View view)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>为什么要对View做包装呢,这里有下面几个作用:</p>
<p>首先是要显示的图片View可能在加载的过程中被回收了或者移除了,这个时候再往下加载就没有意义了,所以这里我们看到通过弱引用来把view对象包装起来了.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ViewAware</span><span class="params">(View view, <span class="keyword">boolean</span> checkActualViewSize)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (view == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"view must not be null"</span>);</div><div class="line"></div><div class="line">		<span class="keyword">this</span>.viewRef = <span class="keyword">new</span> WeakReference&lt;View&gt;(view);</div><div class="line">		<span class="keyword">this</span>.checkActualViewSize = checkActualViewSize;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>还有一个作用就是给view对象附一个唯一的ID,为什么要这么做,这里也要两个原因:一个是为了防止一个view重复的去请求图片,如果一个view在重复的请求图片的时候,ImageLoader会取消掉旧的请求并重新开始新的加载逻辑;二是为了解决异步加载图片错位的问题,我们都知道在android中的listView或者gridView是推荐使用缓存机制的,也就是说只是生成当前屏幕那么多的view对象,然后再滚动的时候来重复利用已经有的对象来节约内存,这就导致一个问题,比如刚开始去异步加载的view在图片加载回来的时候可能已经不是刚开始的那个view了,如果这个时候把图片附上就会产生图片不对应的问题.而这个ID的作用就在这里,通过比较刚开始和后来图片回来的view的唯一ID,如果一致的话就加载图片,不一致就什么都不做,这样就可以解决图片错位的问题了.<br>下面是具体的ImageView的包装对象的实现:</p>
<p>另外一个作用是判断当前是否是在主线程中,如果在主线程中就可以顺利的加载图片,否者不予执行.防止在子线程中更新UI报错.</p>
<p>最后的一个作用就是可以提前获取到view的宽度和高度,这样可以在加载图片的时候根据view的宽高来对图片进行缩放来节约内存空间.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageViewAware</span> <span class="keyword">extends</span> <span class="title">ViewAware</span> </span>&#123;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ImageViewAware</span><span class="params">(ImageView imageView)</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>(imageView);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ImageViewAware</span><span class="params">(ImageView imageView, <span class="keyword">boolean</span> checkActualViewSize)</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>(imageView, checkActualViewSize);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getWidth</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> width = <span class="keyword">super</span>.getWidth();</div><div class="line">		<span class="keyword">if</span> (width &lt;= <span class="number">0</span>) &#123;</div><div class="line">			ImageView imageView = (ImageView) viewRef.get();</div><div class="line">			<span class="keyword">if</span> (imageView != <span class="keyword">null</span>) &#123;</div><div class="line">				width = getImageViewFieldValue(imageView, <span class="string">"mMaxWidth"</span>); <span class="comment">// Check maxWidth parameter</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> width;</div><div class="line">	&#125;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getHeight</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> height = <span class="keyword">super</span>.getHeight();</div><div class="line">		<span class="keyword">if</span> (height &lt;= <span class="number">0</span>) &#123;</div><div class="line">			ImageView imageView = (ImageView) viewRef.get();</div><div class="line">			<span class="keyword">if</span> (imageView != <span class="keyword">null</span>) &#123;</div><div class="line">				height = getImageViewFieldValue(imageView, <span class="string">"mMaxHeight"</span>); <span class="comment">// Check maxHeight parameter</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> height;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> ViewScaleType <span class="title">getScaleType</span><span class="params">()</span> </span>&#123;</div><div class="line">		ImageView imageView = (ImageView) viewRef.get();</div><div class="line">		<span class="keyword">if</span> (imageView != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">return</span> ViewScaleType.fromImageView(imageView);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">super</span>.getScaleType();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> ImageView <span class="title">getWrappedView</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> (ImageView) <span class="keyword">super</span>.getWrappedView();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setImageDrawableInto</span><span class="params">(Drawable drawable, View view)</span> </span>&#123;</div><div class="line">		((ImageView) view).setImageDrawable(drawable);</div><div class="line">		<span class="keyword">if</span> (drawable <span class="keyword">instanceof</span> AnimationDrawable) &#123;</div><div class="line">			((AnimationDrawable)drawable).start();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setImageBitmapInto</span><span class="params">(Bitmap bitmap, View view)</span> </span>&#123;</div><div class="line">		((ImageView) view).setImageBitmap(bitmap);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getImageViewFieldValue</span><span class="params">(Object object, String fieldName)</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> value = <span class="number">0</span>;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			Field field = ImageView.class.getDeclaredField(fieldName);</div><div class="line">			field.setAccessible(<span class="keyword">true</span>);</div><div class="line">			<span class="keyword">int</span> fieldValue = (Integer) field.get(object);</div><div class="line">			<span class="keyword">if</span> (fieldValue &gt; <span class="number">0</span> &amp;&amp; fieldValue &lt; Integer.MAX_VALUE) &#123;</div><div class="line">				value = fieldValue;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">			L.e(e);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> value;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ImageViewAware就是ImageView的包装对象了,它可以获取到imageView的宽高和缩放类型,然后调用原声api来完成图片的加载到ImageView的操作.</p>
<h5 id="ImageSize对象"><a href="#ImageSize对象" class="headerlink" title="ImageSize对象"></a>ImageSize对象</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageSize</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TO_STRING_MAX_LENGHT = <span class="number">9</span>; <span class="comment">// "9999x9999".length()</span></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SEPARATOR = <span class="string">"x"</span>;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> width;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> height;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ImageSize</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.width = width;</div><div class="line">		<span class="keyword">this</span>.height = height;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ImageSize</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height, <span class="keyword">int</span> rotation)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (rotation % <span class="number">180</span> == <span class="number">0</span>) &#123;</div><div class="line">			<span class="keyword">this</span>.width = width;</div><div class="line">			<span class="keyword">this</span>.height = height;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">this</span>.width = height;</div><div class="line">			<span class="keyword">this</span>.height = width;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getWidth</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> width;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getHeight</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> height;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** Scales down dimensions in &lt;b&gt;sampleSize&lt;/b&gt; times. Returns new object. */</span></div><div class="line">	<span class="function"><span class="keyword">public</span> ImageSize <span class="title">scaleDown</span><span class="params">(<span class="keyword">int</span> sampleSize)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ImageSize(width / sampleSize, height / sampleSize);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** Scales dimensions according to incoming scale. Returns new object. */</span></div><div class="line">	<span class="function"><span class="keyword">public</span> ImageSize <span class="title">scale</span><span class="params">(<span class="keyword">float</span> scale)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ImageSize((<span class="keyword">int</span>) (width * scale), (<span class="keyword">int</span>) (height * scale));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> StringBuilder(TO_STRING_MAX_LENGHT).append(width).append(SEPARATOR).append(height).toString();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里的 <em>ImageSize</em> 对象是存储图片的宽高旋转信息的载体对象,为了方便后期对图片做处理的时候使用.这里如果取不到具体的宽高的时候使用config对象中配置的默认宽高:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ImageSize <span class="title">defineTargetSizeForView</span><span class="params">(ImageAware imageAware, ImageSize maxImageSize)</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> width = imageAware.getWidth();</div><div class="line">		<span class="keyword">if</span> (width &lt;= <span class="number">0</span>) width = maxImageSize.getWidth();</div><div class="line"></div><div class="line">		<span class="keyword">int</span> height = imageAware.getHeight();</div><div class="line">		<span class="keyword">if</span> (height &lt;= <span class="number">0</span>) height = maxImageSize.getHeight();</div><div class="line"></div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ImageSize(width, height);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>对url图片为空的处理可能会造成默认图片的显示和正常图片的显示不一样,因为url为空的时候没有走图片处理的流程,比如都要圆角图片,但是没有url的时候是无法实现的,因为没有Bitmap对象可以给它处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (TextUtils.isEmpty(uri)) &#123;</div><div class="line">			engine.cancelDisplayTaskFor(imageAware);</div><div class="line">			listener.onLoadingStarted(uri, imageAware.getWrappedView());</div><div class="line">			<span class="keyword">if</span> (options.shouldShowImageForEmptyUri()) &#123;</div><div class="line">				imageAware.setImageDrawable(options.getImageForEmptyUri(configuration.resources));</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				imageAware.setImageDrawable(<span class="keyword">null</span>);</div><div class="line">			&#125;</div><div class="line">			listener.onLoadingComplete(uri, imageAware.getWrappedView(), <span class="keyword">null</span>);</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div></pre></td></tr></table></figure>
<p>最后关于内存缓存的key值得生成:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">String memoryCacheKey = MemoryCacheUtils.generateKey(uri, targetSize);</div><div class="line">engine.prepareDisplayTaskFor(imageAware, memoryCacheKey);</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">generateKey</span><span class="params">(String imageUri, ImageSize targetSize)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> StringBuilder(imageUri).append(URI_AND_SIZE_SEPARATOR).append(targetSize.getWidth()).append(WIDTH_AND_HEIGHT_SEPARATOR).append(targetSize.getHeight()).toString();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里采用的是URL+”_“ + size信息的方式来作为缓存key的.</p>
<p>到这里, <em>displayImage</em> 的第一部分就完成了.下面进入那个来看剩下的两部分,也就是从内存中找到和没找到图片对象的处理.<br>先看如果在内存中找到了想要的图片对象的处理:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">Bitmap bmp = configuration.memoryCache.get(memoryCacheKey);</div><div class="line"><span class="keyword">if</span> (bmp != <span class="keyword">null</span> &amp;&amp; !bmp.isRecycled()) &#123;</div><div class="line">			L.d(LOG_LOAD_IMAGE_FROM_MEMORY_CACHE, memoryCacheKey);</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (options.shouldPostProcess()) &#123;</div><div class="line">				ImageLoadingInfo imageLoadingInfo = <span class="keyword">new</span> ImageLoadingInfo(uri, imageAware, targetSize, memoryCacheKey,</div><div class="line">						options, listener, progressListener, engine.getLockForUri(uri));</div><div class="line">				ProcessAndDisplayImageTask displayTask = <span class="keyword">new</span> ProcessAndDisplayImageTask(engine, bmp, imageLoadingInfo,</div><div class="line">						defineHandler(options));</div><div class="line">				<span class="keyword">if</span> (options.isSyncLoading()) &#123;</div><div class="line">					displayTask.run();</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					engine.submit(displayTask);</div><div class="line">				&#125;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				options.getDisplayer().display(bmp, imageAware, LoadedFrom.MEMORY_CACHE);</div><div class="line">				listener.onLoadingComplete(uri, imageAware.getWrappedView(), bmp);</div><div class="line">			&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>首先生成一个 <em>ImageLoadingInfo对象</em> 来保存图片加载过程中需要的信息,看下面的代码基本上所有的对象都包含了:</p>
<h5 id="ImageLoadingInfo对象"><a href="#ImageLoadingInfo对象" class="headerlink" title="ImageLoadingInfo对象"></a>ImageLoadingInfo对象</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageLoadingInfo</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> String uri;</div><div class="line">	<span class="keyword">final</span> String memoryCacheKey;</div><div class="line">	<span class="keyword">final</span> ImageAware imageAware;</div><div class="line">	<span class="keyword">final</span> ImageSize targetSize;</div><div class="line">	<span class="keyword">final</span> DisplayImageOptions options;</div><div class="line">	<span class="keyword">final</span> ImageLoadingListener listener;</div><div class="line">	<span class="keyword">final</span> ImageLoadingProgressListener progressListener;</div><div class="line">	<span class="keyword">final</span> ReentrantLock loadFromUriLock;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ImageLoadingInfo</span><span class="params">(String uri, ImageAware imageAware, ImageSize targetSize, String memoryCacheKey,</span></span></div><div class="line">			DisplayImageOptions options, ImageLoadingListener listener,</div><div class="line">			ImageLoadingProgressListener progressListener, ReentrantLock loadFromUriLock) &#123;</div><div class="line">		<span class="keyword">this</span>.uri = uri;</div><div class="line">		<span class="keyword">this</span>.imageAware = imageAware;</div><div class="line">		<span class="keyword">this</span>.targetSize = targetSize;</div><div class="line">		<span class="keyword">this</span>.options = options;</div><div class="line">		<span class="keyword">this</span>.listener = listener;</div><div class="line">		<span class="keyword">this</span>.progressListener = progressListener;</div><div class="line">		<span class="keyword">this</span>.loadFromUriLock = loadFromUriLock;</div><div class="line">		<span class="keyword">this</span>.memoryCacheKey = memoryCacheKey;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到如果需要对图片对象做处理的时候就把创建的 <em>ProcessAndDisplayImageTask</em> 这个对象交给 <em>ImageLoaderEngine</em> 来完成,如果是 <em>isSyncLoading</em> 的话就直接运行 <em>ProcessAndDisplayImageTask</em> 对象(实际上就是一个线程).<br>如果不需要处理,就直接显示交给BitmapDisplayer来显示图片:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BitmapDisplayer</span> </span>&#123;</div><div class="line">  <span class="comment">//This method is called on UI thread so it's strongly recommended not to do any heavy work in it.</span></div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">display</span><span class="params">(Bitmap bitmap, ImageAware imageAware, LoadedFrom loadedFrom)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>默认使用的这个:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleBitmapDisplayer</span> <span class="keyword">implements</span> <span class="title">BitmapDisplayer</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">display</span><span class="params">(Bitmap bitmap, ImageAware imageAware, LoadedFrom loadedFrom)</span> </span>&#123;</div><div class="line">		imageAware.setImageBitmap(bitmap);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>到这里,成功从内存中加载图片的逻辑就完成了,下面在看如果从内存中没有找到对应的图片对象的处理:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">if</span> (options.shouldShowImageOnLoading()) &#123;</div><div class="line">				imageAware.setImageDrawable(options.getImageOnLoading(configuration.resources));</div><div class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (options.isResetViewBeforeLoading()) &#123;</div><div class="line">				imageAware.setImageDrawable(<span class="keyword">null</span>);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			ImageLoadingInfo imageLoadingInfo = <span class="keyword">new</span> ImageLoadingInfo(uri, imageAware, targetSize, memoryCacheKey,</div><div class="line">					options, listener, progressListener, engine.getLockForUri(uri));</div><div class="line">			LoadAndDisplayImageTask displayTask = <span class="keyword">new</span> LoadAndDisplayImageTask(engine, imageLoadingInfo,</div><div class="line">					defineHandler(options));</div><div class="line">			<span class="keyword">if</span> (options.isSyncLoading()) &#123;</div><div class="line">				displayTask.run();</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				engine.submit(displayTask);</div><div class="line">			&#125;</div><div class="line">		&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到这里也是很清晰的,直接创建一个 <em>LoadAndDisplayImageTask</em> 对象交给engin来处理.如果是 <em>isSyncLoading</em> 的话就直接运行 <em>LoadAndDisplayImageTask</em> ,这个对象实际上也是要给线程对象,这个后面我们会讲到.</p>
<p>到这里displayImage的实现就讲完了,可以看到非常的简单,下面开始 <em>ImageLoderEngine</em> 的任务调度处理逻辑.</p>
<h4 id="ImageLoaderEngine"><a href="#ImageLoaderEngine" class="headerlink" title="ImageLoaderEngine"></a>ImageLoaderEngine</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImageLoaderEngine</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> ImageLoaderConfiguration configuration;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> Executor taskExecutor;</div><div class="line">	<span class="keyword">private</span> Executor taskExecutorForCachedImages;</div><div class="line">	<span class="keyword">private</span> Executor taskDistributor;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Integer, String&gt; cacheKeysForImageAwares = Collections</div><div class="line">			.synchronizedMap(<span class="keyword">new</span> HashMap&lt;Integer, String&gt;());</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, ReentrantLock&gt; uriLocks = <span class="keyword">new</span> WeakHashMap&lt;String, ReentrantLock&gt;();</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> AtomicBoolean paused = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> AtomicBoolean networkDenied = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> AtomicBoolean slowNetwork = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Object pauseLock = <span class="keyword">new</span> Object();</div><div class="line"></div><div class="line">	ImageLoaderEngine(ImageLoaderConfiguration configuration) &#123;</div><div class="line">		<span class="keyword">this</span>.configuration = configuration;</div><div class="line"></div><div class="line">		taskExecutor = configuration.taskExecutor;</div><div class="line">		taskExecutorForCachedImages = configuration.taskExecutorForCachedImages;</div><div class="line"></div><div class="line">		taskDistributor = DefaultConfigurationFactory.createTaskDistributor();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** Submits task to execution pool */</span></div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">submit</span><span class="params">(<span class="keyword">final</span> LoadAndDisplayImageTask task)</span> </span>&#123;</div><div class="line">		taskDistributor.execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">				File image = configuration.diskCache.get(task.getLoadingUri());</div><div class="line">				<span class="keyword">boolean</span> isImageCachedOnDisk = image != <span class="keyword">null</span> &amp;&amp; image.exists();</div><div class="line">				initExecutorsIfNeed();</div><div class="line">				<span class="keyword">if</span> (isImageCachedOnDisk) &#123;</div><div class="line">					taskExecutorForCachedImages.execute(task);</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					taskExecutor.execute(task);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** Submits task to execution pool */</span></div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">submit</span><span class="params">(ProcessAndDisplayImageTask task)</span> </span>&#123;</div><div class="line">		initExecutorsIfNeed();</div><div class="line">		taskExecutorForCachedImages.execute(task);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initExecutorsIfNeed</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (!configuration.customExecutor &amp;&amp; ((ExecutorService) taskExecutor).isShutdown()) &#123;</div><div class="line">			taskExecutor = createTaskExecutor();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (!configuration.customExecutorForCachedImages &amp;&amp; ((ExecutorService) taskExecutorForCachedImages)</div><div class="line">				.isShutdown()) &#123;</div><div class="line">			taskExecutorForCachedImages = createTaskExecutor();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> Executor <span class="title">createTaskExecutor</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> DefaultConfigurationFactory</div><div class="line">				.createExecutor(configuration.threadPoolSize, configuration.threadPriority,</div><div class="line">				configuration.tasksProcessingType);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Returns URI of image which is loading at this moment into passed &#123;<span class="doctag">@link</span> com.nostra13.universalimageloader.core.imageaware.ImageAware&#125;</div><div class="line">	 */</div><div class="line">	<span class="function">String <span class="title">getLoadingUriForView</span><span class="params">(ImageAware imageAware)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> cacheKeysForImageAwares.get(imageAware.getId());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Associates &lt;b&gt;memoryCacheKey&lt;/b&gt; with &lt;b&gt;imageAware&lt;/b&gt;. Then it helps to define image URI is loaded into View at</div><div class="line">	 * exact moment.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">prepareDisplayTaskFor</span><span class="params">(ImageAware imageAware, String memoryCacheKey)</span> </span>&#123;</div><div class="line">		cacheKeysForImageAwares.put(imageAware.getId(), memoryCacheKey);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Cancels the task of loading and displaying image for incoming &lt;b&gt;imageAware&lt;/b&gt;.</div><div class="line">	 *</div><div class="line">	 * <span class="doctag">@param</span> imageAware &#123;<span class="doctag">@link</span> com.nostra13.universalimageloader.core.imageaware.ImageAware&#125; for which display task</div><div class="line">	 *                   will be cancelled</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">cancelDisplayTaskFor</span><span class="params">(ImageAware imageAware)</span> </span>&#123;</div><div class="line">		cacheKeysForImageAwares.remove(imageAware.getId());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Denies or allows engine to download images from the network.&lt;br /&gt; &lt;br /&gt; If downloads are denied and if image</div><div class="line">	 * isn't cached then &#123;<span class="doctag">@link</span> ImageLoadingListener#onLoadingFailed(String, View, FailReason)&#125; callback will be fired</div><div class="line">	 * with &#123;<span class="doctag">@link</span> FailReason.FailType#NETWORK_DENIED&#125;</div><div class="line">	 *</div><div class="line">	 * <span class="doctag">@param</span> denyNetworkDownloads pass &lt;b&gt;true&lt;/b&gt; - to deny engine to download images from the network; &lt;b&gt;false&lt;/b&gt; -</div><div class="line">	 *                             to allow engine to download images from network.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">denyNetworkDownloads</span><span class="params">(<span class="keyword">boolean</span> denyNetworkDownloads)</span> </span>&#123;</div><div class="line">		networkDenied.set(denyNetworkDownloads);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Sets option whether ImageLoader will use &#123;<span class="doctag">@link</span> FlushedInputStream&#125; for network downloads to handle &lt;a</div><div class="line">	 * href="http://code.google.com/p/android/issues/detail?id=6066"&gt;this known problem&lt;/a&gt; or not.</div><div class="line">	 *</div><div class="line">	 * <span class="doctag">@param</span> handleSlowNetwork pass &lt;b&gt;true&lt;/b&gt; - to use &#123;<span class="doctag">@link</span> FlushedInputStream&#125; for network downloads; &lt;b&gt;false&lt;/b&gt;</div><div class="line">	 *                          - otherwise.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">handleSlowNetwork</span><span class="params">(<span class="keyword">boolean</span> handleSlowNetwork)</span> </span>&#123;</div><div class="line">		slowNetwork.set(handleSlowNetwork);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Pauses engine. All new "load&amp;display" tasks won't be executed until ImageLoader is &#123;<span class="doctag">@link</span> #resume() resumed&#125;.&lt;br</div><div class="line">	 * /&gt; Already running tasks are not paused.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">pause</span><span class="params">()</span> </span>&#123;</div><div class="line">		paused.set(<span class="keyword">true</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** Resumes engine work. Paused "load&amp;display" tasks will continue its work. */</span></div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">resume</span><span class="params">()</span> </span>&#123;</div><div class="line">		paused.set(<span class="keyword">false</span>);</div><div class="line">		<span class="keyword">synchronized</span> (pauseLock) &#123;</div><div class="line">			pauseLock.notifyAll();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Stops engine, cancels all running and scheduled display image tasks. Clears internal data.</div><div class="line">	 * &lt;br /&gt;</div><div class="line">	 * &lt;b&gt;<span class="doctag">NOTE:</span>&lt;/b&gt; This method doesn't shutdown</div><div class="line">	 * &#123;<span class="doctag">@linkplain</span> com.nostra13.universalimageloader.core.ImageLoaderConfiguration.Builder#taskExecutor(java.util.concurrent.Executor)</div><div class="line">	 * custom task executors&#125; if you set them.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (!configuration.customExecutor) &#123;</div><div class="line">			((ExecutorService) taskExecutor).shutdownNow();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (!configuration.customExecutorForCachedImages) &#123;</div><div class="line">			((ExecutorService) taskExecutorForCachedImages).shutdownNow();</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		cacheKeysForImageAwares.clear();</div><div class="line">		uriLocks.clear();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">fireCallback</span><span class="params">(Runnable r)</span> </span>&#123;</div><div class="line">		taskDistributor.execute(r);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function">ReentrantLock <span class="title">getLockForUri</span><span class="params">(String uri)</span> </span>&#123;</div><div class="line">		ReentrantLock lock = uriLocks.get(uri);</div><div class="line">		<span class="keyword">if</span> (lock == <span class="keyword">null</span>) &#123;</div><div class="line">			lock = <span class="keyword">new</span> ReentrantLock();</div><div class="line">			uriLocks.put(uri, lock);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> lock;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function">AtomicBoolean <span class="title">getPause</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> paused;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function">Object <span class="title">getPauseLock</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> pauseLock;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">isNetworkDenied</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> networkDenied.get();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">isSlowNetwork</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> slowNetwork.get();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到在 <em>ImageLoaderEngine</em> 对象中主要有3个线程池来做任务调度,核心的方法就是两个 <em>submit</em> 方法.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> Executor taskExecutor;</div><div class="line"><span class="keyword">private</span> Executor taskExecutorForCachedImages;</div><div class="line"><span class="keyword">private</span> Executor taskDistributor;</div></pre></td></tr></table></figure></p>
<p><em>taskDistributor</em> 用来统一管理所有的任务,根据任务类型把任务放入不同的线程池中,如果是内存中或者本地存储中加载图片的话交给 <em>taskExecutorForCachedImages</em> 否者就交给 <em>taskExecutor</em> 来处理.</p>
<p>两个submit方法用来把对应类型的task放入不同的线程池中来执行任务,非常的清晰.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** Submits task to execution pool */</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">submit</span><span class="params">(<span class="keyword">final</span> LoadAndDisplayImageTask task)</span> </span>&#123;</div><div class="line">  taskDistributor.execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">      File image = configuration.diskCache.get(task.getLoadingUri());</div><div class="line">      <span class="keyword">boolean</span> isImageCachedOnDisk = image != <span class="keyword">null</span> &amp;&amp; image.exists();</div><div class="line">      initExecutorsIfNeed();</div><div class="line">      <span class="keyword">if</span> (isImageCachedOnDisk) &#123;</div><div class="line">        taskExecutorForCachedImages.execute(task);</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        taskExecutor.execute(task);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/** Submits task to execution pool */</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">submit</span><span class="params">(ProcessAndDisplayImageTask task)</span> </span>&#123;</div><div class="line">  initExecutorsIfNeed();</div><div class="line">  taskExecutorForCachedImages.execute(task);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>关于Engine对象还有要注意的地方就是UIL对每个url提供了一个ReentrantLock锁,来解决对重复URL加载的线程同步问题.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function">ReentrantLock <span class="title">getLockForUri</span><span class="params">(String uri)</span> </span>&#123;</div><div class="line">		ReentrantLock lock = uriLocks.get(uri);</div><div class="line">		<span class="keyword">if</span> (lock == <span class="keyword">null</span>) &#123;</div><div class="line">			lock = <span class="keyword">new</span> ReentrantLock();</div><div class="line">			uriLocks.put(uri, lock);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> lock;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>这个锁在后面要讲到的两个Task中会用到,稍后我们再讲他们的具体实现.<br>Engine对象同时还提供了暂停,停止,开始等操作,通过线程安全的AtomicBoolean对象来控制任务调度状态,这里就不具体讲了,都是线程同步的简单实现.<br>下面开始讲两个具体的Task线程对象:</p>
<h4 id="ProcessAndDisplayImageTask"><a href="#ProcessAndDisplayImageTask" class="headerlink" title="ProcessAndDisplayImageTask"></a>ProcessAndDisplayImageTask</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ProcessAndDisplayImageTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOG_POSTPROCESS_IMAGE = <span class="string">"PostProcess image before displaying [%s]"</span>;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ImageLoaderEngine engine;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Bitmap bitmap;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ImageLoadingInfo imageLoadingInfo;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Handler handler;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ProcessAndDisplayImageTask</span><span class="params">(ImageLoaderEngine engine, Bitmap bitmap, ImageLoadingInfo imageLoadingInfo,</span></span></div><div class="line">			Handler handler) &#123;</div><div class="line">		<span class="keyword">this</span>.engine = engine;</div><div class="line">		<span class="keyword">this</span>.bitmap = bitmap;</div><div class="line">		<span class="keyword">this</span>.imageLoadingInfo = imageLoadingInfo;</div><div class="line">		<span class="keyword">this</span>.handler = handler;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">		L.d(LOG_POSTPROCESS_IMAGE, imageLoadingInfo.memoryCacheKey);</div><div class="line"></div><div class="line">		BitmapProcessor processor = imageLoadingInfo.options.getPostProcessor();</div><div class="line">		Bitmap processedBitmap = processor.process(bitmap);</div><div class="line">		DisplayBitmapTask displayBitmapTask = <span class="keyword">new</span> DisplayBitmapTask(processedBitmap, imageLoadingInfo, engine,</div><div class="line">				LoadedFrom.MEMORY_CACHE);</div><div class="line">		LoadAndDisplayImageTask.runTask(displayBitmapTask, imageLoadingInfo.options.isSyncLoading(), handler, engine);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到 <em>ProcessAndDisplayImageTask</em> 很简单,如果需要对图片做处理的话就交给 <em>BitmapProcessor</em> 把图片处理一下,然后把处理完的Bitmap对象封装成一个 <em>DisplayBitmapTask</em> 交给 <em>LoadAndDisplayImageTask</em> 的 <em>runTask</em> 方法来处理.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runTask</span><span class="params">(Runnable r, <span class="keyword">boolean</span> sync, Handler handler, ImageLoaderEngine engine)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (sync) &#123;</div><div class="line">			r.run();</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (handler == <span class="keyword">null</span>) &#123;</div><div class="line">			engine.fireCallback(r);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			handler.post(r);</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到通过具体的情况来完成回调处理.如果是同步的话直接运行该线程,如果handler为空的话交给总调度线程池 <em>taskDistributor</em> 来调用,否者通过handler来执行该线程.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DisplayBitmapTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOG_DISPLAY_IMAGE_IN_IMAGEAWARE = <span class="string">"Display image in ImageAware (loaded from %1$s) [%2$s]"</span>;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOG_TASK_CANCELLED_IMAGEAWARE_REUSED = <span class="string">"ImageAware is reused for another image. Task is cancelled. [%s]"</span>;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOG_TASK_CANCELLED_IMAGEAWARE_COLLECTED = <span class="string">"ImageAware was collected by GC. Task is cancelled. [%s]"</span>;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Bitmap bitmap;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String imageUri;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ImageAware imageAware;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String memoryCacheKey;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> BitmapDisplayer displayer;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ImageLoadingListener listener;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ImageLoaderEngine engine;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> LoadedFrom loadedFrom;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">DisplayBitmapTask</span><span class="params">(Bitmap bitmap, ImageLoadingInfo imageLoadingInfo, ImageLoaderEngine engine,</span></span></div><div class="line">			LoadedFrom loadedFrom) &#123;</div><div class="line">		<span class="keyword">this</span>.bitmap = bitmap;</div><div class="line">		imageUri = imageLoadingInfo.uri;</div><div class="line">		imageAware = imageLoadingInfo.imageAware;</div><div class="line">		memoryCacheKey = imageLoadingInfo.memoryCacheKey;</div><div class="line">		displayer = imageLoadingInfo.options.getDisplayer();</div><div class="line">		listener = imageLoadingInfo.listener;</div><div class="line">		<span class="keyword">this</span>.engine = engine;</div><div class="line">		<span class="keyword">this</span>.loadedFrom = loadedFrom;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (imageAware.isCollected()) &#123;</div><div class="line">			L.d(LOG_TASK_CANCELLED_IMAGEAWARE_COLLECTED, memoryCacheKey);</div><div class="line">			listener.onLoadingCancelled(imageUri, imageAware.getWrappedView());</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (isViewWasReused()) &#123;</div><div class="line">			L.d(LOG_TASK_CANCELLED_IMAGEAWARE_REUSED, memoryCacheKey);</div><div class="line">			listener.onLoadingCancelled(imageUri, imageAware.getWrappedView());</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			L.d(LOG_DISPLAY_IMAGE_IN_IMAGEAWARE, loadedFrom, memoryCacheKey);</div><div class="line">			displayer.display(bitmap, imageAware, loadedFrom);</div><div class="line">			engine.cancelDisplayTaskFor(imageAware);</div><div class="line">			listener.onLoadingComplete(imageUri, imageAware.getWrappedView(), bitmap);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** Checks whether memory cache key (image URI) for current ImageAware is actual */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isViewWasReused</span><span class="params">()</span> </span>&#123;</div><div class="line">		String currentCacheKey = engine.getLoadingUriForView(imageAware);</div><div class="line">		<span class="keyword">return</span> !memoryCacheKey.equals(currentCacheKey);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到 <em>DisplayBitmapTask</em> 的run方法的钱两个判断,正好对应前面讲到的关于view的回收或删除和重复利用view错位的问题的判断,如果两种情况对应上就任务本次任务被取消.否则直接通知 <em>displayer</em> 显示图片.这里不用担心是在子线程中更新UI,因为 <em>displayer</em> 内部的display方法是调用的 <em>ImageAware</em> 接口的实现类中 的setImageBitmap方法,在这个方法的具体实现中已经判断了是否是在主线程中了.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"> ViewAware对象的setImageView方法</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">setImageBitmap</span><span class="params">(Bitmap bitmap)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (Looper.myLooper() == Looper.getMainLooper()) &#123;</div><div class="line">		View view = viewRef.get();</div><div class="line">		<span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</div><div class="line">			setImageBitmapInto(bitmap, view);</div><div class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		L.w(WARN_CANT_SET_BITMAP);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="LoadAndDisplayImageTask"><a href="#LoadAndDisplayImageTask" class="headerlink" title="LoadAndDisplayImageTask"></a>LoadAndDisplayImageTask</h4><p>下面进入比较复杂的任务对象 <em>LoadAndDisplayImageTask</em> 中,改对象之所以复杂,主要是因为要判断硬盘中是否有需要的图片的对象,如果没有就去下载,然后保存图片,最后才把图片对象返回,代码较多,我们一步步的来分析</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LoadAndDisplayImageTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span>, <span class="title">IoUtils</span>.<span class="title">CopyListener</span> </span>&#123;</div><div class="line"></div><div class="line">  ....</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ImageLoaderEngine engine;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ImageLoadingInfo imageLoadingInfo;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Handler handler;</div><div class="line"></div><div class="line">	<span class="comment">// Helper references</span></div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ImageLoaderConfiguration configuration;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ImageDownloader downloader;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ImageDownloader networkDeniedDownloader;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ImageDownloader slowNetworkDownloader;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ImageDecoder decoder;</div><div class="line">	<span class="keyword">final</span> String uri;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String memoryCacheKey;</div><div class="line">	<span class="keyword">final</span> ImageAware imageAware;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ImageSize targetSize;</div><div class="line">	<span class="keyword">final</span> DisplayImageOptions options;</div><div class="line">	<span class="keyword">final</span> ImageLoadingListener listener;</div><div class="line">	<span class="keyword">final</span> ImageLoadingProgressListener progressListener;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> syncLoading;</div><div class="line"></div><div class="line">	<span class="comment">// State vars</span></div><div class="line">	<span class="keyword">private</span> LoadedFrom loadedFrom = LoadedFrom.NETWORK;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">LoadAndDisplayImageTask</span><span class="params">(ImageLoaderEngine engine, ImageLoadingInfo imageLoadingInfo, Handler handler)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.engine = engine;</div><div class="line">		<span class="keyword">this</span>.imageLoadingInfo = imageLoadingInfo;</div><div class="line">		<span class="keyword">this</span>.handler = handler;</div><div class="line"></div><div class="line">		configuration = engine.configuration;</div><div class="line">		downloader = configuration.downloader;</div><div class="line">		networkDeniedDownloader = configuration.networkDeniedDownloader;</div><div class="line">		slowNetworkDownloader = configuration.slowNetworkDownloader;</div><div class="line">		decoder = configuration.decoder;</div><div class="line">		uri = imageLoadingInfo.uri;</div><div class="line">		memoryCacheKey = imageLoadingInfo.memoryCacheKey;</div><div class="line">		imageAware = imageLoadingInfo.imageAware;</div><div class="line">		targetSize = imageLoadingInfo.targetSize;</div><div class="line">		options = imageLoadingInfo.options;</div><div class="line">		listener = imageLoadingInfo.listener;</div><div class="line">		progressListener = imageLoadingInfo.progressListener;</div><div class="line">		syncLoading = options.isSyncLoading();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (waitIfPaused()) <span class="keyword">return</span>;</div><div class="line">		<span class="keyword">if</span> (delayIfNeed()) <span class="keyword">return</span>;</div><div class="line"></div><div class="line">		ReentrantLock loadFromUriLock = imageLoadingInfo.loadFromUriLock;</div><div class="line">		L.d(LOG_START_DISPLAY_IMAGE_TASK, memoryCacheKey);</div><div class="line">		<span class="keyword">if</span> (loadFromUriLock.isLocked()) &#123;</div><div class="line">			L.d(LOG_WAITING_FOR_IMAGE_LOADED, memoryCacheKey);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		loadFromUriLock.lock();</div><div class="line">		Bitmap bmp;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			checkTaskNotActual();</div><div class="line"></div><div class="line">			bmp = configuration.memoryCache.get(memoryCacheKey);</div><div class="line">			<span class="keyword">if</span> (bmp == <span class="keyword">null</span> || bmp.isRecycled()) &#123;</div><div class="line">				bmp = tryLoadBitmap();</div><div class="line">				<span class="keyword">if</span> (bmp == <span class="keyword">null</span>) <span class="keyword">return</span>; <span class="comment">// listener callback already was fired</span></div><div class="line"></div><div class="line">				checkTaskNotActual();</div><div class="line">				checkTaskInterrupted();</div><div class="line"></div><div class="line">				<span class="keyword">if</span> (options.shouldPreProcess()) &#123;</div><div class="line">					L.d(LOG_PREPROCESS_IMAGE, memoryCacheKey);</div><div class="line">					bmp = options.getPreProcessor().process(bmp);</div><div class="line">					<span class="keyword">if</span> (bmp == <span class="keyword">null</span>) &#123;</div><div class="line">						L.e(ERROR_PRE_PROCESSOR_NULL, memoryCacheKey);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				<span class="keyword">if</span> (bmp != <span class="keyword">null</span> &amp;&amp; options.isCacheInMemory()) &#123;</div><div class="line">					L.d(LOG_CACHE_IMAGE_IN_MEMORY, memoryCacheKey);</div><div class="line">					configuration.memoryCache.put(memoryCacheKey, bmp);</div><div class="line">				&#125;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				loadedFrom = LoadedFrom.MEMORY_CACHE;</div><div class="line">				L.d(LOG_GET_IMAGE_FROM_MEMORY_CACHE_AFTER_WAITING, memoryCacheKey);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (bmp != <span class="keyword">null</span> &amp;&amp; options.shouldPostProcess()) &#123;</div><div class="line">				L.d(LOG_POSTPROCESS_IMAGE, memoryCacheKey);</div><div class="line">				bmp = options.getPostProcessor().process(bmp);</div><div class="line">				<span class="keyword">if</span> (bmp == <span class="keyword">null</span>) &#123;</div><div class="line">					L.e(ERROR_POST_PROCESSOR_NULL, memoryCacheKey);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			checkTaskNotActual();</div><div class="line">			checkTaskInterrupted();</div><div class="line">		&#125; <span class="keyword">catch</span> (TaskCancelledException e) &#123;</div><div class="line">			fireCancelEvent();</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125; <span class="keyword">finally</span> &#123;</div><div class="line">			loadFromUriLock.unlock();</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		DisplayBitmapTask displayBitmapTask = <span class="keyword">new</span> DisplayBitmapTask(bmp, imageLoadingInfo, engine, loadedFrom);</div><div class="line">		runTask(displayBitmapTask, syncLoading, handler, engine);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** <span class="doctag">@return</span> &lt;b&gt;true&lt;/b&gt; - if task should be interrupted; &lt;b&gt;false&lt;/b&gt; - otherwise */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">waitIfPaused</span><span class="params">()</span> </span>&#123;</div><div class="line">		AtomicBoolean pause = engine.getPause();</div><div class="line">		<span class="keyword">if</span> (pause.get()) &#123;</div><div class="line">			<span class="keyword">synchronized</span> (engine.getPauseLock()) &#123;</div><div class="line">				<span class="keyword">if</span> (pause.get()) &#123;</div><div class="line">					L.d(LOG_WAITING_FOR_RESUME, memoryCacheKey);</div><div class="line">					<span class="keyword">try</span> &#123;</div><div class="line">						engine.getPauseLock().wait();</div><div class="line">					&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">						L.e(LOG_TASK_INTERRUPTED, memoryCacheKey);</div><div class="line">						<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">					&#125;</div><div class="line">					L.d(LOG_RESUME_AFTER_PAUSE, memoryCacheKey);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> isTaskNotActual();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** <span class="doctag">@return</span> &lt;b&gt;true&lt;/b&gt; - if task should be interrupted; &lt;b&gt;false&lt;/b&gt; - otherwise */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">delayIfNeed</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (options.shouldDelayBeforeLoading()) &#123;</div><div class="line">			L.d(LOG_DELAY_BEFORE_LOADING, options.getDelayBeforeLoading(), memoryCacheKey);</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				Thread.sleep(options.getDelayBeforeLoading());</div><div class="line">			&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">				L.e(LOG_TASK_INTERRUPTED, memoryCacheKey);</div><div class="line">				<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> isTaskNotActual();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> Bitmap <span class="title">tryLoadBitmap</span><span class="params">()</span> <span class="keyword">throws</span> TaskCancelledException </span>&#123;</div><div class="line">		Bitmap bitmap = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			File imageFile = configuration.diskCache.get(uri);</div><div class="line">			<span class="keyword">if</span> (imageFile != <span class="keyword">null</span> &amp;&amp; imageFile.exists() &amp;&amp; imageFile.length() &gt; <span class="number">0</span>) &#123;</div><div class="line">				L.d(LOG_LOAD_IMAGE_FROM_DISK_CACHE, memoryCacheKey);</div><div class="line">				loadedFrom = LoadedFrom.DISC_CACHE;</div><div class="line"></div><div class="line">				checkTaskNotActual();</div><div class="line">				bitmap = decodeImage(Scheme.FILE.wrap(imageFile.getAbsolutePath()));</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (bitmap == <span class="keyword">null</span> || bitmap.getWidth() &lt;= <span class="number">0</span> || bitmap.getHeight() &lt;= <span class="number">0</span>) &#123;</div><div class="line">				L.d(LOG_LOAD_IMAGE_FROM_NETWORK, memoryCacheKey);</div><div class="line">				loadedFrom = LoadedFrom.NETWORK;</div><div class="line"></div><div class="line">				String imageUriForDecoding = uri;</div><div class="line">				<span class="keyword">if</span> (options.isCacheOnDisk() &amp;&amp; tryCacheImageOnDisk()) &#123;</div><div class="line">					imageFile = configuration.diskCache.get(uri);</div><div class="line">					<span class="keyword">if</span> (imageFile != <span class="keyword">null</span>) &#123;</div><div class="line">						imageUriForDecoding = Scheme.FILE.wrap(imageFile.getAbsolutePath());</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				checkTaskNotActual();</div><div class="line">				bitmap = decodeImage(imageUriForDecoding);</div><div class="line"></div><div class="line">				<span class="keyword">if</span> (bitmap == <span class="keyword">null</span> || bitmap.getWidth() &lt;= <span class="number">0</span> || bitmap.getHeight() &lt;= <span class="number">0</span>) &#123;</div><div class="line">					fireFailEvent(FailType.DECODING_ERROR, <span class="keyword">null</span>);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">catch</span> (IllegalStateException e) &#123;</div><div class="line">			fireFailEvent(FailType.NETWORK_DENIED, <span class="keyword">null</span>);</div><div class="line">		&#125; <span class="keyword">catch</span> (TaskCancelledException e) &#123;</div><div class="line">			<span class="keyword">throw</span> e;</div><div class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">			L.e(e);</div><div class="line">			fireFailEvent(FailType.IO_ERROR, e);</div><div class="line">		&#125; <span class="keyword">catch</span> (OutOfMemoryError e) &#123;</div><div class="line">			L.e(e);</div><div class="line">			fireFailEvent(FailType.OUT_OF_MEMORY, e);</div><div class="line">		&#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">			L.e(e);</div><div class="line">			fireFailEvent(FailType.UNKNOWN, e);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> bitmap;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> Bitmap <span class="title">decodeImage</span><span class="params">(String imageUri)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">		ViewScaleType viewScaleType = imageAware.getScaleType();</div><div class="line">		ImageDecodingInfo decodingInfo = <span class="keyword">new</span> ImageDecodingInfo(memoryCacheKey, imageUri, uri, targetSize, viewScaleType,</div><div class="line">				getDownloader(), options);</div><div class="line">		<span class="keyword">return</span> decoder.decode(decodingInfo);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** <span class="doctag">@return</span> &lt;b&gt;true&lt;/b&gt; - if image was downloaded successfully; &lt;b&gt;false&lt;/b&gt; - otherwise */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">tryCacheImageOnDisk</span><span class="params">()</span> <span class="keyword">throws</span> TaskCancelledException </span>&#123;</div><div class="line">		L.d(LOG_CACHE_IMAGE_ON_DISK, memoryCacheKey);</div><div class="line"></div><div class="line">		<span class="keyword">boolean</span> loaded;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			loaded = downloadImage();</div><div class="line">			<span class="keyword">if</span> (loaded) &#123;</div><div class="line">				<span class="keyword">int</span> width = configuration.maxImageWidthForDiskCache;</div><div class="line">				<span class="keyword">int</span> height = configuration.maxImageHeightForDiskCache;</div><div class="line">				<span class="keyword">if</span> (width &gt; <span class="number">0</span> || height &gt; <span class="number">0</span>) &#123;</div><div class="line">					L.d(LOG_RESIZE_CACHED_IMAGE_FILE, memoryCacheKey);</div><div class="line">					resizeAndSaveImage(width, height); <span class="comment">// TODO : process boolean result</span></div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">			L.e(e);</div><div class="line">			loaded = <span class="keyword">false</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> loaded;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">downloadImage</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">		InputStream is = getDownloader().getStream(uri, options.getExtraForDownloader());</div><div class="line">		<span class="keyword">if</span> (is == <span class="keyword">null</span>) &#123;</div><div class="line">			L.e(ERROR_NO_IMAGE_STREAM, memoryCacheKey);</div><div class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				<span class="keyword">return</span> configuration.diskCache.save(uri, is, <span class="keyword">this</span>);</div><div class="line">			&#125; <span class="keyword">finally</span> &#123;</div><div class="line">				IoUtils.closeSilently(is);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** Decodes image file into Bitmap, resize it and save it back */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">resizeAndSaveImage</span><span class="params">(<span class="keyword">int</span> maxWidth, <span class="keyword">int</span> maxHeight)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">		<span class="comment">// Decode image file, compress and re-save it</span></div><div class="line">		<span class="keyword">boolean</span> saved = <span class="keyword">false</span>;</div><div class="line">		File targetFile = configuration.diskCache.get(uri);</div><div class="line">		<span class="keyword">if</span> (targetFile != <span class="keyword">null</span> &amp;&amp; targetFile.exists()) &#123;</div><div class="line">			ImageSize targetImageSize = <span class="keyword">new</span> ImageSize(maxWidth, maxHeight);</div><div class="line">			DisplayImageOptions specialOptions = <span class="keyword">new</span> DisplayImageOptions.Builder().cloneFrom(options)</div><div class="line">					.imageScaleType(ImageScaleType.IN_SAMPLE_INT).build();</div><div class="line">			ImageDecodingInfo decodingInfo = <span class="keyword">new</span> ImageDecodingInfo(memoryCacheKey,</div><div class="line">					Scheme.FILE.wrap(targetFile.getAbsolutePath()), uri, targetImageSize, ViewScaleType.FIT_INSIDE,</div><div class="line">					getDownloader(), specialOptions);</div><div class="line">			Bitmap bmp = decoder.decode(decodingInfo);</div><div class="line">			<span class="keyword">if</span> (bmp != <span class="keyword">null</span> &amp;&amp; configuration.processorForDiskCache != <span class="keyword">null</span>) &#123;</div><div class="line">				L.d(LOG_PROCESS_IMAGE_BEFORE_CACHE_ON_DISK, memoryCacheKey);</div><div class="line">				bmp = configuration.processorForDiskCache.process(bmp);</div><div class="line">				<span class="keyword">if</span> (bmp == <span class="keyword">null</span>) &#123;</div><div class="line">					L.e(ERROR_PROCESSOR_FOR_DISK_CACHE_NULL, memoryCacheKey);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (bmp != <span class="keyword">null</span>) &#123;</div><div class="line">				saved = configuration.diskCache.save(uri, bmp);</div><div class="line">				bmp.recycle();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> saved;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onBytesCopied</span><span class="params">(<span class="keyword">int</span> current, <span class="keyword">int</span> total)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> syncLoading || fireProgressEvent(current, total);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** <span class="doctag">@return</span> &lt;b&gt;true&lt;/b&gt; - if loading should be continued; &lt;b&gt;false&lt;/b&gt; - if loading should be interrupted */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">fireProgressEvent</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> current, <span class="keyword">final</span> <span class="keyword">int</span> total)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (isTaskInterrupted() || isTaskNotActual()) <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">		<span class="keyword">if</span> (progressListener != <span class="keyword">null</span>) &#123;</div><div class="line">			Runnable r = <span class="keyword">new</span> Runnable() &#123;</div><div class="line">				<span class="meta">@Override</span></div><div class="line">				<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">					progressListener.onProgressUpdate(uri, imageAware.getWrappedView(), current, total);</div><div class="line">				&#125;</div><div class="line">			&#125;;</div><div class="line">			runTask(r, <span class="keyword">false</span>, handler, engine);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fireFailEvent</span><span class="params">(<span class="keyword">final</span> FailType failType, <span class="keyword">final</span> Throwable failCause)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (syncLoading || isTaskInterrupted() || isTaskNotActual()) <span class="keyword">return</span>;</div><div class="line">		Runnable r = <span class="keyword">new</span> Runnable() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">				<span class="keyword">if</span> (options.shouldShowImageOnFail()) &#123;</div><div class="line">					imageAware.setImageDrawable(options.getImageOnFail(configuration.resources));</div><div class="line">				&#125;</div><div class="line">				listener.onLoadingFailed(uri, imageAware.getWrappedView(), <span class="keyword">new</span> FailReason(failType, failCause));</div><div class="line">			&#125;</div><div class="line">		&#125;;</div><div class="line">		runTask(r, <span class="keyword">false</span>, handler, engine);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fireCancelEvent</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (syncLoading || isTaskInterrupted()) <span class="keyword">return</span>;</div><div class="line">		Runnable r = <span class="keyword">new</span> Runnable() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">				listener.onLoadingCancelled(uri, imageAware.getWrappedView());</div><div class="line">			&#125;</div><div class="line">		&#125;;</div><div class="line">		runTask(r, <span class="keyword">false</span>, handler, engine);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> ImageDownloader <span class="title">getDownloader</span><span class="params">()</span> </span>&#123;</div><div class="line">		ImageDownloader d;</div><div class="line">		<span class="keyword">if</span> (engine.isNetworkDenied()) &#123;</div><div class="line">			d = networkDeniedDownloader;</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (engine.isSlowNetwork()) &#123;</div><div class="line">			d = slowNetworkDownloader;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			d = downloader;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> d;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * <span class="doctag">@throws</span> TaskCancelledException if task is not actual (target ImageAware is collected by GC or the image URI of</div><div class="line">	 *                                this task doesn't match to image URI which is actual for current ImageAware at</div><div class="line">	 *                                this moment)</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkTaskNotActual</span><span class="params">()</span> <span class="keyword">throws</span> TaskCancelledException </span>&#123;</div><div class="line">		checkViewCollected();</div><div class="line">		checkViewReused();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * <span class="doctag">@return</span> &lt;b&gt;true&lt;/b&gt; - if task is not actual (target ImageAware is collected by GC or the image URI of this task</div><div class="line">	 * doesn't match to image URI which is actual for current ImageAware at this moment)); &lt;b&gt;false&lt;/b&gt; - otherwise</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isTaskNotActual</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> isViewCollected() || isViewReused();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** <span class="doctag">@throws</span> TaskCancelledException if target ImageAware is collected */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkViewCollected</span><span class="params">()</span> <span class="keyword">throws</span> TaskCancelledException </span>&#123;</div><div class="line">		<span class="keyword">if</span> (isViewCollected()) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> TaskCancelledException();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** <span class="doctag">@return</span> &lt;b&gt;true&lt;/b&gt; - if target ImageAware is collected by GC; &lt;b&gt;false&lt;/b&gt; - otherwise */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isViewCollected</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (imageAware.isCollected()) &#123;</div><div class="line">			L.d(LOG_TASK_CANCELLED_IMAGEAWARE_COLLECTED, memoryCacheKey);</div><div class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** <span class="doctag">@throws</span> TaskCancelledException if target ImageAware is collected by GC */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkViewReused</span><span class="params">()</span> <span class="keyword">throws</span> TaskCancelledException </span>&#123;</div><div class="line">		<span class="keyword">if</span> (isViewReused()) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> TaskCancelledException();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** <span class="doctag">@return</span> &lt;b&gt;true&lt;/b&gt; - if current ImageAware is reused for displaying another image; &lt;b&gt;false&lt;/b&gt; - otherwise */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isViewReused</span><span class="params">()</span> </span>&#123;</div><div class="line">		String currentCacheKey = engine.getLoadingUriForView(imageAware);</div><div class="line">		<span class="comment">// Check whether memory cache key (image URI) for current ImageAware is actual.</span></div><div class="line">		<span class="comment">// If ImageAware is reused for another task then current task should be cancelled.</span></div><div class="line">		<span class="keyword">boolean</span> imageAwareWasReused = !memoryCacheKey.equals(currentCacheKey);</div><div class="line">		<span class="keyword">if</span> (imageAwareWasReused) &#123;</div><div class="line">			L.d(LOG_TASK_CANCELLED_IMAGEAWARE_REUSED, memoryCacheKey);</div><div class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** <span class="doctag">@throws</span> TaskCancelledException if current task was interrupted */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkTaskInterrupted</span><span class="params">()</span> <span class="keyword">throws</span> TaskCancelledException </span>&#123;</div><div class="line">		<span class="keyword">if</span> (isTaskInterrupted()) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> TaskCancelledException();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** <span class="doctag">@return</span> &lt;b&gt;true&lt;/b&gt; - if current task was interrupted; &lt;b&gt;false&lt;/b&gt; - otherwise */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isTaskInterrupted</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (Thread.interrupted()) &#123;</div><div class="line">			L.d(LOG_TASK_INTERRUPTED, memoryCacheKey);</div><div class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function">String <span class="title">getLoadingUri</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> uri;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runTask</span><span class="params">(Runnable r, <span class="keyword">boolean</span> sync, Handler handler, ImageLoaderEngine engine)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (sync) &#123;</div><div class="line">			r.run();</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (handler == <span class="keyword">null</span>) &#123;</div><div class="line">			engine.fireCallback(r);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			handler.post(r);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>核心代码就是在run方法中,先看开始的两个判断 <em>waitIfPaused</em> 和 <em>delayIfNeed</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">waitIfPaused</span><span class="params">()</span> </span>&#123;</div><div class="line">		AtomicBoolean pause = engine.getPause();</div><div class="line">		<span class="keyword">if</span> (pause.get()) &#123;</div><div class="line">			<span class="keyword">synchronized</span> (engine.getPauseLock()) &#123;</div><div class="line">				<span class="keyword">if</span> (pause.get()) &#123;</div><div class="line">					L.d(LOG_WAITING_FOR_RESUME, memoryCacheKey);</div><div class="line">					<span class="keyword">try</span> &#123;</div><div class="line">						engine.getPauseLock().wait();</div><div class="line">					&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">						L.e(LOG_TASK_INTERRUPTED, memoryCacheKey);</div><div class="line">						<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">					&#125;</div><div class="line">					L.d(LOG_RESUME_AFTER_PAUSE, memoryCacheKey);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> isTaskNotActual();</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>如果engine对象处于暂停状态的时候,会让阻塞当前运行的线程,等待engine再次调用 <em>resume</em> 方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** <span class="doctag">@return</span> &lt;b&gt;true&lt;/b&gt; - if task should be interrupted; &lt;b&gt;false&lt;/b&gt; - otherwise */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">delayIfNeed</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (options.shouldDelayBeforeLoading()) &#123;</div><div class="line">			L.d(LOG_DELAY_BEFORE_LOADING, options.getDelayBeforeLoading(), memoryCacheKey);</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				Thread.sleep(options.getDelayBeforeLoading());</div><div class="line">			&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">				L.e(LOG_TASK_INTERRUPTED, memoryCacheKey);</div><div class="line">				<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> isTaskNotActual();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>如果在配置中设定了延迟显示的属性的话,休眠设置的时间然后继续执行.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">ReentrantLock loadFromUriLock = imageLoadingInfo.loadFromUriLock;</div><div class="line">		L.d(LOG_START_DISPLAY_IMAGE_TASK, memoryCacheKey);</div><div class="line">		<span class="keyword">if</span> (loadFromUriLock.isLocked()) &#123;</div><div class="line">			L.d(LOG_WAITING_FOR_IMAGE_LOADED, memoryCacheKey);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		loadFromUriLock.lock();</div></pre></td></tr></table></figure>
<p>对应前面url锁,一个url对应一个锁对象,这样同一时间内相同的URL只有一个任务在运行.<br>下面的 <em>checkTaskNotActual</em> 在前面讲过了,无非就是判断view的状态是否可用,这里不重复了</p>
<p>然后再次从内存中获取,这是因为加锁的原因,可能前面的线程已经把相同的url加载完成了,这里就先从内存中获取一下,防止重复下载.<br>如何没有找到bitmap对象就进入核心方法 <em>tryLoadBitmap</em> 中,这个方法就完成了上面的本地存储查找,如果没有的就从网上下载的逻辑,最后和上面一样,交给displayer来显示.下面重点讲下 <em>tryLoadBitmap</em> 这个方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Bitmap <span class="title">tryLoadBitmap</span><span class="params">()</span> <span class="keyword">throws</span> TaskCancelledException </span>&#123;</div><div class="line">		Bitmap bitmap = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			File imageFile = configuration.diskCache.get(uri);</div><div class="line">			<span class="keyword">if</span> (imageFile != <span class="keyword">null</span> &amp;&amp; imageFile.exists() &amp;&amp; imageFile.length() &gt; <span class="number">0</span>) &#123;</div><div class="line">				L.d(LOG_LOAD_IMAGE_FROM_DISK_CACHE, memoryCacheKey);</div><div class="line">				loadedFrom = LoadedFrom.DISC_CACHE;</div><div class="line"></div><div class="line">				checkTaskNotActual();</div><div class="line">				bitmap = decodeImage(Scheme.FILE.wrap(imageFile.getAbsolutePath()));</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (bitmap == <span class="keyword">null</span> || bitmap.getWidth() &lt;= <span class="number">0</span> || bitmap.getHeight() &lt;= <span class="number">0</span>) &#123;</div><div class="line">				L.d(LOG_LOAD_IMAGE_FROM_NETWORK, memoryCacheKey);</div><div class="line">				loadedFrom = LoadedFrom.NETWORK;</div><div class="line"></div><div class="line">				String imageUriForDecoding = uri;</div><div class="line">				<span class="keyword">if</span> (options.isCacheOnDisk() &amp;&amp; tryCacheImageOnDisk()) &#123;</div><div class="line">					imageFile = configuration.diskCache.get(uri);</div><div class="line">					<span class="keyword">if</span> (imageFile != <span class="keyword">null</span>) &#123;</div><div class="line">						imageUriForDecoding = Scheme.FILE.wrap(imageFile.getAbsolutePath());</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				checkTaskNotActual();</div><div class="line">				bitmap = decodeImage(imageUriForDecoding);</div><div class="line"></div><div class="line">				<span class="keyword">if</span> (bitmap == <span class="keyword">null</span> || bitmap.getWidth() &lt;= <span class="number">0</span> || bitmap.getHeight() &lt;= <span class="number">0</span>) &#123;</div><div class="line">					fireFailEvent(FailType.DECODING_ERROR, <span class="keyword">null</span>);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">catch</span> (IllegalStateException e) &#123;</div><div class="line">			fireFailEvent(FailType.NETWORK_DENIED, <span class="keyword">null</span>);</div><div class="line">		&#125; <span class="keyword">catch</span> (TaskCancelledException e) &#123;</div><div class="line">			<span class="keyword">throw</span> e;</div><div class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">			L.e(e);</div><div class="line">			fireFailEvent(FailType.IO_ERROR, e);</div><div class="line">		&#125; <span class="keyword">catch</span> (OutOfMemoryError e) &#123;</div><div class="line">			L.e(e);</div><div class="line">			fireFailEvent(FailType.OUT_OF_MEMORY, e);</div><div class="line">		&#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">			L.e(e);</div><div class="line">			fireFailEvent(FailType.UNKNOWN, e);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> bitmap;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>首先是从diskCache中查找有没有对应的图片对象,如果有的话交给 <em>decodeImage</em> 方法处理完图片之后直接返回,如果没有的话就进入下面的判断中<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">.....</div><div class="line"><span class="keyword">if</span> (options.isCacheOnDisk() &amp;&amp; tryCacheImageOnDisk()) &#123;</div><div class="line">					imageFile = configuration.diskCache.get(uri);</div><div class="line">					<span class="keyword">if</span> (imageFile != <span class="keyword">null</span>) &#123;</div><div class="line">						imageUriForDecoding = Scheme.FILE.wrap(imageFile.getAbsolutePath());</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">.....</div></pre></td></tr></table></figure></p>
<p>是否需要缓存到本地,如果需要的话进入 <em>tryCacheImageOnDisk</em> 这个方法用来从网络上下载图片<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">tryCacheImageOnDisk</span><span class="params">()</span> <span class="keyword">throws</span> TaskCancelledException </span>&#123;</div><div class="line">		L.d(LOG_CACHE_IMAGE_ON_DISK, memoryCacheKey);</div><div class="line"></div><div class="line">		<span class="keyword">boolean</span> loaded;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			loaded = downloadImage();</div><div class="line">			<span class="keyword">if</span> (loaded) &#123;</div><div class="line">				<span class="keyword">int</span> width = configuration.maxImageWidthForDiskCache;</div><div class="line">				<span class="keyword">int</span> height = configuration.maxImageHeightForDiskCache;</div><div class="line">				<span class="keyword">if</span> (width &gt; <span class="number">0</span> || height &gt; <span class="number">0</span>) &#123;</div><div class="line">					L.d(LOG_RESIZE_CACHED_IMAGE_FILE, memoryCacheKey);</div><div class="line">					resizeAndSaveImage(width, height); <span class="comment">// TODO : process boolean result</span></div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">			L.e(e);</div><div class="line">			loaded = <span class="keyword">false</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> loaded;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>进入 <em>downloadImage</em> 方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">downloadImage</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">  InputStream is = getDownloader().getStream(uri, options.getExtraForDownloader());</div><div class="line">  <span class="keyword">if</span> (is == <span class="keyword">null</span>) &#123;</div><div class="line">    L.e(ERROR_NO_IMAGE_STREAM, memoryCacheKey);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="keyword">return</span> configuration.diskCache.save(uri, is, <span class="keyword">this</span>);</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">      IoUtils.closeSilently(is);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到如果下载成功后,先把对象放入diskCache中,和最上面那个流程一样,下载先保存,然后从缓存中取.<br>这里 <em>getDownloader</em> 的对象是一个 <em>ImageDownloader</em> 接口对象,之所以要这样式因为UIL不仅仅可以处理http和https类型的图片,它也可以处理 “file:///“,”content://“,”assert://“,”drawable://“ 这些类型的URI,所以要根据不同的URI类型来找到不通的 <em>ImageDownloader</em> 加载图片.<br>最后当从内存中找到了对应的图片对象之后也是交给 <em>decode</em> 方法来处理图片. <em>decode</em> 主要是用来处理图片缩放的:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Bitmap <span class="title">decodeImage</span><span class="params">(String imageUri)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">  ViewScaleType viewScaleType = imageAware.getScaleType();</div><div class="line">  ImageDecodingInfo decodingInfo = <span class="keyword">new</span> ImageDecodingInfo(memoryCacheKey, imageUri, uri, targetSize, viewScaleType,</div><div class="line">      getDownloader(), options);</div><div class="line">  <span class="keyword">return</span> decoder.decode(decodingInfo);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里ImageDecodingInfo也是一个中间对象,用来把需要的参数都封装成一个对象传给Decoder对象<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ImageDecoder</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Decodes image to &#123;<span class="doctag">@link</span> Bitmap&#125; according target size and other parameters.</div><div class="line">	 *</div><div class="line">	 * <span class="doctag">@param</span> imageDecodingInfo</div><div class="line">	 * <span class="doctag">@return</span></div><div class="line">	 * <span class="doctag">@throws</span> IOException</div><div class="line">	 */</div><div class="line">	<span class="function">Bitmap <span class="title">decode</span><span class="params">(ImageDecodingInfo imageDecodingInfo)</span> <span class="keyword">throws</span> IOException</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseImageDecoder</span> <span class="keyword">implements</span> <span class="title">ImageDecoder</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOG_SUBSAMPLE_IMAGE = <span class="string">"Subsample original image (%1$s) to %2$s (scale = %3$d) [%4$s]"</span>;</div><div class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOG_SCALE_IMAGE = <span class="string">"Scale subsampled image (%1$s) to %2$s (scale = %3$.5f) [%4$s]"</span>;</div><div class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOG_ROTATE_IMAGE = <span class="string">"Rotate image on %1$d\u00B0 [%2$s]"</span>;</div><div class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOG_FLIP_IMAGE = <span class="string">"Flip image horizontally [%s]"</span>;</div><div class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> String ERROR_NO_IMAGE_STREAM = <span class="string">"No stream for image [%s]"</span>;</div><div class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> String ERROR_CANT_DECODE_IMAGE = <span class="string">"Image can't be decoded [%s]"</span>;</div><div class="line"></div><div class="line">	<span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> loggingEnabled;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">BaseImageDecoder</span><span class="params">(<span class="keyword">boolean</span> loggingEnabled)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.loggingEnabled = loggingEnabled;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Decodes image from URI into &#123;<span class="doctag">@link</span> Bitmap&#125;. Image is scaled close to incoming &#123;<span class="doctag">@linkplain</span> ImageSize target size&#125;</div><div class="line">	 * during decoding (depend on incoming parameters).</div><div class="line">	 *</div><div class="line">	 * <span class="doctag">@param</span> decodingInfo Needed data for decoding image</div><div class="line">	 * <span class="doctag">@return</span> Decoded bitmap</div><div class="line">	 * <span class="doctag">@throws</span> IOException                   if some I/O exception occurs during image reading</div><div class="line">	 * <span class="doctag">@throws</span> UnsupportedOperationException if image URI has unsupported scheme(protocol)</div><div class="line">	 */</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> Bitmap <span class="title">decode</span><span class="params">(ImageDecodingInfo decodingInfo)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">		Bitmap decodedBitmap;</div><div class="line">		ImageFileInfo imageInfo;</div><div class="line"></div><div class="line">		InputStream imageStream = getImageStream(decodingInfo);</div><div class="line">		<span class="keyword">if</span> (imageStream == <span class="keyword">null</span>) &#123;</div><div class="line">			L.e(ERROR_NO_IMAGE_STREAM, decodingInfo.getImageKey());</div><div class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			imageInfo = defineImageSizeAndRotation(imageStream, decodingInfo);</div><div class="line">			imageStream = resetStream(imageStream, decodingInfo);</div><div class="line">			Options decodingOptions = prepareDecodingOptions(imageInfo.imageSize, decodingInfo);</div><div class="line">			decodedBitmap = BitmapFactory.decodeStream(imageStream, <span class="keyword">null</span>, decodingOptions);</div><div class="line">		&#125; <span class="keyword">finally</span> &#123;</div><div class="line">			IoUtils.closeSilently(imageStream);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (decodedBitmap == <span class="keyword">null</span>) &#123;</div><div class="line">			L.e(ERROR_CANT_DECODE_IMAGE, decodingInfo.getImageKey());</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			decodedBitmap = considerExactScaleAndOrientatiton(decodedBitmap, decodingInfo, imageInfo.exif.rotation,</div><div class="line">					imageInfo.exif.flipHorizontal);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> decodedBitmap;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">protected</span> InputStream <span class="title">getImageStream</span><span class="params">(ImageDecodingInfo decodingInfo)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">		<span class="keyword">return</span> decodingInfo.getDownloader().getStream(decodingInfo.getImageUri(), decodingInfo.getExtraForDownloader());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">protected</span> ImageFileInfo <span class="title">defineImageSizeAndRotation</span><span class="params">(InputStream imageStream, ImageDecodingInfo decodingInfo)</span></span></div><div class="line">			<span class="keyword">throws</span> IOException &#123;</div><div class="line">		Options options = <span class="keyword">new</span> Options();</div><div class="line">		options.inJustDecodeBounds = <span class="keyword">true</span>;</div><div class="line">		BitmapFactory.decodeStream(imageStream, <span class="keyword">null</span>, options);</div><div class="line"></div><div class="line">		ExifInfo exif;</div><div class="line">		String imageUri = decodingInfo.getImageUri();</div><div class="line">		<span class="keyword">if</span> (decodingInfo.shouldConsiderExifParams() &amp;&amp; canDefineExifParams(imageUri, options.outMimeType)) &#123;</div><div class="line">			exif = defineExifOrientation(imageUri);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			exif = <span class="keyword">new</span> ExifInfo();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ImageFileInfo(<span class="keyword">new</span> ImageSize(options.outWidth, options.outHeight, exif.rotation), exif);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">canDefineExifParams</span><span class="params">(String imageUri, String mimeType)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">"image/jpeg"</span>.equalsIgnoreCase(mimeType) &amp;&amp; (Scheme.ofUri(imageUri) == Scheme.FILE);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">protected</span> ExifInfo <span class="title">defineExifOrientation</span><span class="params">(String imageUri)</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> rotation = <span class="number">0</span>;</div><div class="line">		<span class="keyword">boolean</span> flip = <span class="keyword">false</span>;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			ExifInterface exif = <span class="keyword">new</span> ExifInterface(Scheme.FILE.crop(imageUri));</div><div class="line">			<span class="keyword">int</span> exifOrientation = exif.getAttributeInt(ExifInterface.TAG_ORIENTATION, ExifInterface.ORIENTATION_NORMAL);</div><div class="line">			<span class="keyword">switch</span> (exifOrientation) &#123;</div><div class="line">				<span class="keyword">case</span> ExifInterface.ORIENTATION_FLIP_HORIZONTAL:</div><div class="line">					flip = <span class="keyword">true</span>;</div><div class="line">				<span class="keyword">case</span> ExifInterface.ORIENTATION_NORMAL:</div><div class="line">					rotation = <span class="number">0</span>;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				<span class="keyword">case</span> ExifInterface.ORIENTATION_TRANSVERSE:</div><div class="line">					flip = <span class="keyword">true</span>;</div><div class="line">				<span class="keyword">case</span> ExifInterface.ORIENTATION_ROTATE_90:</div><div class="line">					rotation = <span class="number">90</span>;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				<span class="keyword">case</span> ExifInterface.ORIENTATION_FLIP_VERTICAL:</div><div class="line">					flip = <span class="keyword">true</span>;</div><div class="line">				<span class="keyword">case</span> ExifInterface.ORIENTATION_ROTATE_180:</div><div class="line">					rotation = <span class="number">180</span>;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				<span class="keyword">case</span> ExifInterface.ORIENTATION_TRANSPOSE:</div><div class="line">					flip = <span class="keyword">true</span>;</div><div class="line">				<span class="keyword">case</span> ExifInterface.ORIENTATION_ROTATE_270:</div><div class="line">					rotation = <span class="number">270</span>;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">			L.w(<span class="string">"Can't read EXIF tags from file [%s]"</span>, imageUri);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ExifInfo(rotation, flip);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">protected</span> Options <span class="title">prepareDecodingOptions</span><span class="params">(ImageSize imageSize, ImageDecodingInfo decodingInfo)</span> </span>&#123;</div><div class="line">		ImageScaleType scaleType = decodingInfo.getImageScaleType();</div><div class="line">		<span class="keyword">int</span> scale;</div><div class="line">		<span class="keyword">if</span> (scaleType == ImageScaleType.NONE) &#123;</div><div class="line">			scale = <span class="number">1</span>;</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (scaleType == ImageScaleType.NONE_SAFE) &#123;</div><div class="line">			scale = ImageSizeUtils.computeMinImageSampleSize(imageSize);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			ImageSize targetSize = decodingInfo.getTargetSize();</div><div class="line">			<span class="keyword">boolean</span> powerOf2 = scaleType == ImageScaleType.IN_SAMPLE_POWER_OF_2;</div><div class="line">			scale = ImageSizeUtils.computeImageSampleSize(imageSize, targetSize, decodingInfo.getViewScaleType(), powerOf2);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (scale &gt; <span class="number">1</span> &amp;&amp; loggingEnabled) &#123;</div><div class="line">			L.d(LOG_SUBSAMPLE_IMAGE, imageSize, imageSize.scaleDown(scale), scale, decodingInfo.getImageKey());</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		Options decodingOptions = decodingInfo.getDecodingOptions();</div><div class="line">		decodingOptions.inSampleSize = scale;</div><div class="line">		<span class="keyword">return</span> decodingOptions;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">protected</span> InputStream <span class="title">resetStream</span><span class="params">(InputStream imageStream, ImageDecodingInfo decodingInfo)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">		<span class="keyword">if</span> (imageStream.markSupported()) &#123;</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				imageStream.reset();</div><div class="line">				<span class="keyword">return</span> imageStream;</div><div class="line">			&#125; <span class="keyword">catch</span> (IOException ignored) &#123;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		IoUtils.closeSilently(imageStream);</div><div class="line">		<span class="keyword">return</span> getImageStream(decodingInfo);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">protected</span> Bitmap <span class="title">considerExactScaleAndOrientatiton</span><span class="params">(Bitmap subsampledBitmap, ImageDecodingInfo decodingInfo,</span></span></div><div class="line">			<span class="keyword">int</span> rotation, <span class="keyword">boolean</span> flipHorizontal) &#123;</div><div class="line">		Matrix m = <span class="keyword">new</span> Matrix();</div><div class="line">		<span class="comment">// Scale to exact size if need</span></div><div class="line">		ImageScaleType scaleType = decodingInfo.getImageScaleType();</div><div class="line">		<span class="keyword">if</span> (scaleType == ImageScaleType.EXACTLY || scaleType == ImageScaleType.EXACTLY_STRETCHED) &#123;</div><div class="line">			ImageSize srcSize = <span class="keyword">new</span> ImageSize(subsampledBitmap.getWidth(), subsampledBitmap.getHeight(), rotation);</div><div class="line">			<span class="keyword">float</span> scale = ImageSizeUtils.computeImageScale(srcSize, decodingInfo.getTargetSize(), decodingInfo</div><div class="line">					.getViewScaleType(), scaleType == ImageScaleType.EXACTLY_STRETCHED);</div><div class="line">			<span class="keyword">if</span> (Float.compare(scale, <span class="number">1f</span>) != <span class="number">0</span>) &#123;</div><div class="line">				m.setScale(scale, scale);</div><div class="line"></div><div class="line">				<span class="keyword">if</span> (loggingEnabled) &#123;</div><div class="line">					L.d(LOG_SCALE_IMAGE, srcSize, srcSize.scale(scale), scale, decodingInfo.getImageKey());</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// Flip bitmap if need</span></div><div class="line">		<span class="keyword">if</span> (flipHorizontal) &#123;</div><div class="line">			m.postScale(-<span class="number">1</span>, <span class="number">1</span>);</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (loggingEnabled) L.d(LOG_FLIP_IMAGE, decodingInfo.getImageKey());</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// Rotate bitmap if need</span></div><div class="line">		<span class="keyword">if</span> (rotation != <span class="number">0</span>) &#123;</div><div class="line">			m.postRotate(rotation);</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (loggingEnabled) L.d(LOG_ROTATE_IMAGE, rotation, decodingInfo.getImageKey());</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		Bitmap finalBitmap = Bitmap.createBitmap(subsampledBitmap, <span class="number">0</span>, <span class="number">0</span>, subsampledBitmap.getWidth(), subsampledBitmap</div><div class="line">				.getHeight(), m, <span class="keyword">true</span>);</div><div class="line">		<span class="keyword">if</span> (finalBitmap != subsampledBitmap) &#123;</div><div class="line">			subsampledBitmap.recycle();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> finalBitmap;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ExifInfo</span> </span>&#123;</div><div class="line"></div><div class="line">		<span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> rotation;</div><div class="line">		<span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> flipHorizontal;</div><div class="line"></div><div class="line">		<span class="function"><span class="keyword">protected</span> <span class="title">ExifInfo</span><span class="params">()</span> </span>&#123;</div><div class="line">			<span class="keyword">this</span>.rotation = <span class="number">0</span>;</div><div class="line">			<span class="keyword">this</span>.flipHorizontal = <span class="keyword">false</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="function"><span class="keyword">protected</span> <span class="title">ExifInfo</span><span class="params">(<span class="keyword">int</span> rotation, <span class="keyword">boolean</span> flipHorizontal)</span> </span>&#123;</div><div class="line">			<span class="keyword">this</span>.rotation = rotation;</div><div class="line">			<span class="keyword">this</span>.flipHorizontal = flipHorizontal;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageFileInfo</span> </span>&#123;</div><div class="line"></div><div class="line">		<span class="keyword">public</span> <span class="keyword">final</span> ImageSize imageSize;</div><div class="line">		<span class="keyword">public</span> <span class="keyword">final</span> ExifInfo exif;</div><div class="line"></div><div class="line">		<span class="function"><span class="keyword">protected</span> <span class="title">ImageFileInfo</span><span class="params">(ImageSize imageSize, ExifInfo exif)</span> </span>&#123;</div><div class="line">			<span class="keyword">this</span>.imageSize = imageSize;</div><div class="line">			<span class="keyword">this</span>.exif = exif;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到decoder类对Bitmap根据需要做了缩放和旋转处理,如果必要的话.这里涉及到Bitmap操作的api,这里就不展开了,后续有时间我们介绍一下Bitmap的常用操作方法.<br>回到 <em>LoadAndDisplayImageTask</em> 的run方法,可以看到,这里在等到获取到Bitmap对象之后,可以调用getPreProcessor来对对象做二次处理,然后放入内存缓存中,最后也可以再对Bitmap做一次处理,如果设置了getPostProcessor的话,最后就交给 <em>DisplayBitmapTask</em> 去显示图片了,和上面的 <em>ProcessAndDisplayImageTask</em> 一样.</p>
<p>核心加载流程就讲完了,是不是很容易理解,其实也没有上面特别拿点的地方,只要明白加载的流程就很容易跟到代码了.最后简单介绍一下config对象的相关属性:</p>
<h4 id="ImageLoaderConfiguration"><a href="#ImageLoaderConfiguration" class="headerlink" title="ImageLoaderConfiguration"></a>ImageLoaderConfiguration</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageLoaderConfiguration</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> Resources resources;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> maxImageWidthForMemoryCache;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> maxImageHeightForMemoryCache;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> maxImageWidthForDiskCache;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> maxImageHeightForDiskCache;</div><div class="line">	<span class="keyword">final</span> BitmapProcessor processorForDiskCache;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> Executor taskExecutor;</div><div class="line">	<span class="keyword">final</span> Executor taskExecutorForCachedImages;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> customExecutor;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> customExecutorForCachedImages;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> threadPoolSize;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> threadPriority;</div><div class="line">	<span class="keyword">final</span> QueueProcessingType tasksProcessingType;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> MemoryCache memoryCache;</div><div class="line">	<span class="keyword">final</span> DiskCache diskCache;</div><div class="line">	<span class="keyword">final</span> ImageDownloader downloader;</div><div class="line">	<span class="keyword">final</span> ImageDecoder decoder;</div><div class="line">	<span class="keyword">final</span> DisplayImageOptions defaultDisplayImageOptions;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> ImageDownloader networkDeniedDownloader;</div><div class="line">	<span class="keyword">final</span> ImageDownloader slowNetworkDownloader;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="title">ImageLoaderConfiguration</span><span class="params">(<span class="keyword">final</span> Builder builder)</span> </span>&#123;</div><div class="line">		resources = builder.context.getResources();</div><div class="line">		maxImageWidthForMemoryCache = builder.maxImageWidthForMemoryCache;</div><div class="line">		maxImageHeightForMemoryCache = builder.maxImageHeightForMemoryCache;</div><div class="line">		maxImageWidthForDiskCache = builder.maxImageWidthForDiskCache;</div><div class="line">		maxImageHeightForDiskCache = builder.maxImageHeightForDiskCache;</div><div class="line">		processorForDiskCache = builder.processorForDiskCache;</div><div class="line">		taskExecutor = builder.taskExecutor;</div><div class="line">		taskExecutorForCachedImages = builder.taskExecutorForCachedImages;</div><div class="line">		threadPoolSize = builder.threadPoolSize;</div><div class="line">		threadPriority = builder.threadPriority;</div><div class="line">		tasksProcessingType = builder.tasksProcessingType;</div><div class="line">		diskCache = builder.diskCache;</div><div class="line">		memoryCache = builder.memoryCache;</div><div class="line">		defaultDisplayImageOptions = builder.defaultDisplayImageOptions;</div><div class="line">		downloader = builder.downloader;</div><div class="line">		decoder = builder.decoder;</div><div class="line"></div><div class="line">		customExecutor = builder.customExecutor;</div><div class="line">		customExecutorForCachedImages = builder.customExecutorForCachedImages;</div><div class="line"></div><div class="line">		networkDeniedDownloader = <span class="keyword">new</span> NetworkDeniedImageDownloader(downloader);</div><div class="line">		slowNetworkDownloader = <span class="keyword">new</span> SlowNetworkImageDownloader(downloader);</div><div class="line"></div><div class="line">		L.writeDebugLogs(builder.writeLogs);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ImageLoaderConfiguration <span class="title">createDefault</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> Builder(context).build();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function">ImageSize <span class="title">getMaxImageSize</span><span class="params">()</span> </span>&#123;</div><div class="line">		DisplayMetrics displayMetrics = resources.getDisplayMetrics();</div><div class="line"></div><div class="line">		<span class="keyword">int</span> width = maxImageWidthForMemoryCache;</div><div class="line">		<span class="keyword">if</span> (width &lt;= <span class="number">0</span>) &#123;</div><div class="line">			width = displayMetrics.widthPixels;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">int</span> height = maxImageHeightForMemoryCache;</div><div class="line">		<span class="keyword">if</span> (height &lt;= <span class="number">0</span>) &#123;</div><div class="line">			height = displayMetrics.heightPixels;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ImageSize(width, height);</div><div class="line">	&#125;</div><div class="line">  ....</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>config对象的属性起名很清晰,基本和字面翻译一致,可以看到很多地方都可以配置,比如线程池,decoder等对象,非常的灵活.方便根据需求去扩展.</p>
<p>最后的最后,来看下两个接口,分别对应图片二次处理和图片显示的</p>
<h4 id="processor-和-displayer"><a href="#processor-和-displayer" class="headerlink" title="processor 和 displayer"></a>processor 和 displayer</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BitmapProcessor</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function">Bitmap <span class="title">process</span><span class="params">(Bitmap bitmap)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BitmapDisplayer</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">display</span><span class="params">(Bitmap bitmap, ImageAware imageAware, LoadedFrom loadedFrom)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里可以根据需求去实现自己的process和displayer,UIL已经给提供了几种displayer了,比如 <em>CircleBitmapDisplayer</em> , <em>FadeInBitmapDisplayer</em> 等,位于core包目录下的display包下面,感兴趣的话可以自己看下实现.</p>
<h3 id="DefaultConfigurationFactory"><a href="#DefaultConfigurationFactory" class="headerlink" title="DefaultConfigurationFactory"></a>DefaultConfigurationFactory</h3><p>这个类用来生成默认的config和option对象的,都是一些简单的初始化操作,这里就不讲了,具体的请看代码实现.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultConfigurationFactory</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">/** Creates default implementation of task executor */</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Executor <span class="title">createExecutor</span><span class="params">(<span class="keyword">int</span> threadPoolSize, <span class="keyword">int</span> threadPriority,</span></span></div><div class="line">			QueueProcessingType tasksProcessingType) &#123;</div><div class="line">		<span class="keyword">boolean</span> lifo = tasksProcessingType == QueueProcessingType.LIFO;</div><div class="line">		BlockingQueue&lt;Runnable&gt; taskQueue =</div><div class="line">				lifo ? <span class="keyword">new</span> LIFOLinkedBlockingDeque&lt;Runnable&gt;() : <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;();</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ThreadPoolExecutor(threadPoolSize, threadPoolSize, <span class="number">0L</span>, TimeUnit.MILLISECONDS, taskQueue,</div><div class="line">				createThreadFactory(threadPriority, <span class="string">"uil-pool-"</span>));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** Creates default implementation of task distributor */</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Executor <span class="title">createTaskDistributor</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> Executors.newCachedThreadPool(createThreadFactory(Thread.NORM_PRIORITY, <span class="string">"uil-pool-d-"</span>));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** Creates &#123;<span class="doctag">@linkplain</span> HashCodeFileNameGenerator default implementation&#125; of FileNameGenerator */</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> FileNameGenerator <span class="title">createFileNameGenerator</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> HashCodeFileNameGenerator();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Creates default implementation of &#123;<span class="doctag">@link</span> DiskCache&#125; depends on incoming parameters</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DiskCache <span class="title">createDiskCache</span><span class="params">(Context context, FileNameGenerator diskCacheFileNameGenerator,</span></span></div><div class="line">			<span class="keyword">long</span> diskCacheSize, <span class="keyword">int</span> diskCacheFileCount) &#123;</div><div class="line">		File reserveCacheDir = createReserveDiskCacheDir(context);</div><div class="line">		<span class="keyword">if</span> (diskCacheSize &gt; <span class="number">0</span> || diskCacheFileCount &gt; <span class="number">0</span>) &#123;</div><div class="line">			File individualCacheDir = StorageUtils.getIndividualCacheDirectory(context);</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				<span class="keyword">return</span> <span class="keyword">new</span> LruDiskCache(individualCacheDir, reserveCacheDir, diskCacheFileNameGenerator, diskCacheSize,</div><div class="line">						diskCacheFileCount);</div><div class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">				L.e(e);</div><div class="line">				<span class="comment">// continue and create unlimited cache</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		File cacheDir = StorageUtils.getCacheDirectory(context);</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> UnlimitedDiskCache(cacheDir, reserveCacheDir, diskCacheFileNameGenerator);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** Creates reserve disk cache folder which will be used if primary disk cache folder becomes unavailable */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> File <span class="title">createReserveDiskCacheDir</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">		File cacheDir = StorageUtils.getCacheDirectory(context, <span class="keyword">false</span>);</div><div class="line">		File individualDir = <span class="keyword">new</span> File(cacheDir, <span class="string">"uil-images"</span>);</div><div class="line">		<span class="keyword">if</span> (individualDir.exists() || individualDir.mkdir()) &#123;</div><div class="line">			cacheDir = individualDir;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> cacheDir;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Creates default implementation of &#123;<span class="doctag">@link</span> MemoryCache&#125; - &#123;<span class="doctag">@link</span> LruMemoryCache&#125;&lt;br /&gt;</div><div class="line">	 * Default cache size = 1/8 of available app memory.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MemoryCache <span class="title">createMemoryCache</span><span class="params">(Context context, <span class="keyword">int</span> memoryCacheSize)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (memoryCacheSize == <span class="number">0</span>) &#123;</div><div class="line">			ActivityManager am = (ActivityManager) context.getSystemService(Context.ACTIVITY_SERVICE);</div><div class="line">			<span class="keyword">int</span> memoryClass = am.getMemoryClass();</div><div class="line">			<span class="keyword">if</span> (hasHoneycomb() &amp;&amp; isLargeHeap(context)) &#123;</div><div class="line">				memoryClass = getLargeMemoryClass(am);</div><div class="line">			&#125;</div><div class="line">			memoryCacheSize = <span class="number">1024</span> * <span class="number">1024</span> * memoryClass / <span class="number">8</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> LruMemoryCache(memoryCacheSize);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">hasHoneycomb</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.HONEYCOMB;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@TargetApi</span>(Build.VERSION_CODES.HONEYCOMB)</div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isLargeHeap</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> (context.getApplicationInfo().flags &amp; ApplicationInfo.FLAG_LARGE_HEAP) != <span class="number">0</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@TargetApi</span>(Build.VERSION_CODES.HONEYCOMB)</div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getLargeMemoryClass</span><span class="params">(ActivityManager am)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> am.getLargeMemoryClass();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** Creates default implementation of &#123;<span class="doctag">@link</span> ImageDownloader&#125; - &#123;<span class="doctag">@link</span> BaseImageDownloader&#125; */</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ImageDownloader <span class="title">createImageDownloader</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> BaseImageDownloader(context);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** Creates default implementation of &#123;<span class="doctag">@link</span> ImageDecoder&#125; - &#123;<span class="doctag">@link</span> BaseImageDecoder&#125; */</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ImageDecoder <span class="title">createImageDecoder</span><span class="params">(<span class="keyword">boolean</span> loggingEnabled)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> BaseImageDecoder(loggingEnabled);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** Creates default implementation of &#123;<span class="doctag">@link</span> BitmapDisplayer&#125; - &#123;<span class="doctag">@link</span> SimpleBitmapDisplayer&#125; */</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BitmapDisplayer <span class="title">createBitmapDisplayer</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> SimpleBitmapDisplayer();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** Creates default implementation of &#123;<span class="doctag">@linkplain</span> ThreadFactory thread factory&#125; for task executor */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ThreadFactory <span class="title">createThreadFactory</span><span class="params">(<span class="keyword">int</span> threadPriority, String threadNamePrefix)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> DefaultThreadFactory(threadPriority, threadNamePrefix);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultThreadFactory</span> <span class="keyword">implements</span> <span class="title">ThreadFactory</span> </span>&#123;</div><div class="line"></div><div class="line">		<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicInteger poolNumber = <span class="keyword">new</span> AtomicInteger(<span class="number">1</span>);</div><div class="line"></div><div class="line">		<span class="keyword">private</span> <span class="keyword">final</span> ThreadGroup group;</div><div class="line">		<span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger threadNumber = <span class="keyword">new</span> AtomicInteger(<span class="number">1</span>);</div><div class="line">		<span class="keyword">private</span> <span class="keyword">final</span> String namePrefix;</div><div class="line">		<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> threadPriority;</div><div class="line"></div><div class="line">		DefaultThreadFactory(<span class="keyword">int</span> threadPriority, String threadNamePrefix) &#123;</div><div class="line">			<span class="keyword">this</span>.threadPriority = threadPriority;</div><div class="line">			group = Thread.currentThread().getThreadGroup();</div><div class="line">			namePrefix = threadNamePrefix + poolNumber.getAndIncrement() + <span class="string">"-thread-"</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span> </span>&#123;</div><div class="line">			Thread t = <span class="keyword">new</span> Thread(group, r, namePrefix + threadNumber.getAndIncrement(), <span class="number">0</span>);</div><div class="line">			<span class="keyword">if</span> (t.isDaemon()) t.setDaemon(<span class="keyword">false</span>);</div><div class="line">			t.setPriority(threadPriority);</div><div class="line">			<span class="keyword">return</span> t;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>到这里,UIL的源码主流程就分析完成了,这是第二个研究的开源项目,第一个是EventBus,以前老是觉得UIL非常的复杂,现在回头看了其实很简单,内部的调用也很清晰,看来还是得勇敢迈出第一步,这样才能提高.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/01/01/2017/android universal image loader源码分析/" data-id="cizy2lg1n001yszs6fqluqe7d" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2016/计划与总结/2017年度计划" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/31/2016/计划与总结/2017年度计划/" class="article-date">
  <time datetime="2016-12-31T07:30:00.000Z" itemprop="datePublished">2016-12-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/31/2016/计划与总结/2017年度计划/">2017年度计划</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>#2017年度计划</p>
<p>  今天是2016的最后一天,刚刚写完了201年度总结,对这一整年的所作所为做一个整体的总结,感觉还是很有收获的.下面开始填写2017年度的计划,还是分成工作,生活等这几个方面来说吧,最后再统一写一个list来量化要完成的内容.</p>
<h3 id="工作和技术方面"><a href="#工作和技术方面" class="headerlink" title="工作和技术方面"></a>工作和技术方面</h3><p>  通过一整年的学习,完成IOS和python的学习,达到实战的水平,然后完成一个项目,从前到后的做,包括客户端和服务端,成为一个合格的前端”全栈工程师”.要不断提高自己的技术竞争力,永不out,升职加薪,走上人生巅峰!</p>
<p>  同时也希望可以在github上有所贡献,最起码可以贡献几个开源项目,挣几个star.</p>
<p>  还有书写技术博客,来提升自己的技术品牌,说不定以后可以出书呢.</p>
<h3 id="生活方面"><a href="#生活方面" class="headerlink" title="生活方面"></a>生活方面</h3><h4 id="生活习惯方面"><a href="#生活习惯方面" class="headerlink" title="生活习惯方面"></a>生活习惯方面</h4><p>  2016的写日记的习惯要不断的坚持,同时不断的完善自己的日记模板,现在的方式有点low,先是写在pager,然后通过evernote传到手机上,再通过手机来复制到day one上,希望今天可以把这个流程简化,主要是文字的迁移上.</p>
<p>  身体方面要不断坚持跑步和每天的哑铃练习,跑步可以平衡自己身体均衡,哑铃可以锻炼自己的力量,一个有氧一个无氧,刚好相互结合,争取把体重搜到150斤一下,现在是快到160了,相当于廋10斤,只要可以把这两项坚持下来,应该问题不大.</p>
<p>  在时间管理方面有所进步,详细记录每天的事件详细,通过这个来判定自己的行为和效率.向柳比歇夫学习</p>
<p>  另外要培养一项自己的爱好,比如学习一门乐器,或者运动方式,现在还没想好做啥,在过春节前要定下来</p>
<p>  要养车读书的习惯,并且产出读书笔记,每周都要读一本书,这样一年可以读50多本了,非常可观的数目</p>
<p>  在记忆力的锻炼方面,可以尝试一下</p>
<p>  书法方面也想突破一下,现在这个字简直不能看</p>
<p>  希望可以提高自己的篮球水平,不能每次都被别人打爆,要学会两只手运球过人</p>
<h3 id="生活态度方面"><a href="#生活态度方面" class="headerlink" title="生活态度方面"></a>生活态度方面</h3><p>  希望自己不管遇到什么事情,都要乘沉着应对,大脑一定要清醒<br>  学会感恩,每天都要有进步,要不断的思考<br>  珍惜和家人在一起的每一天<br>  常和父母长辈联系</p>
<h3 id="感情方面"><a href="#感情方面" class="headerlink" title="感情方面"></a>感情方面</h3><p>  希望和老婆相处的越来越融洽,不为小事闹矛盾,同时争取生个健康的小baby</p>
<h3 id="条目"><a href="#条目" class="headerlink" title="条目"></a>条目</h3><ol>
<li>IOS和python达到实战的水平</li>
<li>完成一个从前到后的项目,包括客户端和服务端</li>
<li>github上要有自己的开源项目,争取获得到越多的star越好</li>
<li>书写技术博客,提升自己的技术品牌</li>
<li>坚持每天写日记,同时完成自己写日记的流程</li>
<li>每周都要读一本书,一年至少要读50本书</li>
<li>抽时间练习一下书法,改变自己难看的字</li>
<li>做一些记忆力的训练,提高自己的记忆力</li>
<li>养成跑步和每天哑铃的习惯,最终体重要减到150公斤以下,标准的体重是144</li>
<li>养成记录时间的习惯,通过时间管理和平衡自己的行为</li>
<li>培养一项个人爱好,乐器或者运动</li>
<li>锻炼自己遇到事情的处理能力,不能慌张,要沉着冷静</li>
<li>学会感恩</li>
<li>常和父母长辈联系</li>
<li><p>珍惜和家人在一起的每一天</p>
<p>要根据具体的环境和时间来合理安排计划的执行,比如锻炼身体的跑步可以安排在4,5月份开始天气暖和了之后,每周读书这种的话可以随时进行,那春天的重点是在技术提升上,夏天是在身体锻炼上,秋天可能是爱好培养和其他习惯的培养上,到了冬天就做一些整理和调整性的工作.</p>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/12/31/2016/计划与总结/2017年度计划/" data-id="cizy2lg2e002fszs6wv9ensgs" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2016/计划与总结/2016年度总结" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/31/2016/计划与总结/2016年度总结/" class="article-date">
  <time datetime="2016-12-31T02:08:00.000Z" itemprop="datePublished">2016-12-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/31/2016/计划与总结/2016年度总结/">2016年度总结</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="2016年度总结"><a href="#2016年度总结" class="headerlink" title="2016年度总结"></a>2016年度总结</h2><p>  今天是16年的最后一天了,决定对今年一整年做一个总结,看看这一年都有哪些收获和感悟,得到了什么,还没有得到什么,需要后续继续努力得到什么.</p>
<h3 id="工作方面"><a href="#工作方面" class="headerlink" title="工作方面"></a>工作方面</h3><p>  先说环境,从天下互联离开之后辗转金和,最后再到现在的用有,相当于一个职业的重新归零吧,想想在天下互联这5年自己的收获,不能说没有但是效果不尽如人意,技术上的进步基本上是靠自己的零敲碎打的学来的,流程的规范和大公司也没法相提并论,包括各种软硬件配置也是相差的很远,最大的成就可能就是通过邱哥丈母娘然后认识了我亲爱的老婆吧,现在的用有感觉软硬件都还可以,有班车食堂,有各种娱乐设施,最最满意的可以打篮球锻炼身体,同时单位距离家里的路程还是可以接受的,每天开车上下班,40多分钟就可以到公司和回家,想想之前每天光是在公交车上花费的事件就要1个半小时,这还是不包括走路还要走好远的事件,每天有4个小时都浪费在路途上,想想自己居然坚持了两年多真心不容易;</p>
<p>  其次再说领导,潘哥作为一个领导的话严格来说是不称职的,同时思维的局限性也制约了他的眼界和想法.导致我们这些小弟没有学到怎么做管理如何才能发动手下的兄弟一个奋斗有个清晰的目标管理.这些统统没有.来到用友之后马哥作为自己的新领导感觉对手下人都非常的和善,只要工作上按时完成要求其他一概可以ok,没有像以前对潘哥那么的心里压力,老是感觉很纠结,特别容易郁闷.</p>
<p>  最后是心情,以前在天下的时候每天感觉很压抑,看不到希望,那个东西翻来覆去做了那么多年,到现在还是那个样子,不能说自己的问题吧但是更多的是战略和用人的问题.之前老是觉得不合理需求坑爹的肯定是产品或者潘哥提的,后来潘哥走了之后直面老板发现,好吧确实错怪潘哥了,老板的思维可能停留在自己以前的辉煌时刻吧,现在真心已经out了,无法跟上现在节奏,抓不到现在用户的痛点同时也没有个明确的定位,大而空的东西很难成功.用人上潘哥为了”省钱”根本就不会把牛人给找进来,威胁自己的地位,这不能不说是一个从上到下的悲剧,后来幡然悔悟可是已经错过了.看着每次老板忽悠着各种假大空,渐渐感觉得很恶心,决定换工作,当时在找工作的时候感觉自己的水平真的很差,有很多东西是在面试过程中逼着自己学的,后来慢慢的面试的准备过过程中发现java基础,设计模式这些东西的好处了,面试的时候也不在慌张,对自己有了点点信心.这里有个小插曲就是差一点点就进入宜信了,当时面试3轮都非常的成功,可能最后就是错在找了猎头的问题上.这叫有缘无分吧,在金和的那一个月也不是很开心,做的东西和环境很糟糕,身边的人的想法和做法比较官僚主义,也是无法忍受,最后来到了用有,整体我都非常满意,除了可能待遇上比外面差一点点,其他可以总结为事少钱多离家近.现状就是身边的人有点不太负责任,混日子的比较多,自己还是在坚持做点东西的,想把东西做好,同时积极主动的帮着解决一些问题.总之,这一年的工作还是比较满意的,希望能在用有多呆段日子吧.调养下身心.</p>
<h3 id="技术方面"><a href="#技术方面" class="headerlink" title="技术方面"></a>技术方面</h3><p>  2016年技术来说是有巨大进步的一年,回想之前的工作的种种遇到的问题,可能很多的症结就是在java基础和编程思想上,也从根本上明白了java基础的重要性,从更高层面上对编程有个整体的认识,这点我觉得是巨大的收获.这可能就是之前大家都在说的”道”与”术”的区别,也就是”战略”和”战术”的区别,只要明白了很多抽象的东西,那所有的编程语言都是一样的,唯一不一样的可能是实现的思想和具体的语法,这个是通过学习IOS的过程中发现的;最终编程的目的就是实现各种各样帮助别人的工具或者提供信息的资源.而为什么我们平时要写很多很多的代码,其实是为了”缓存”的具体实现,有了”缓存”就可以把各种东西分层,然后替换,一种整体模块化的思想.我觉得这点是最重要的.</p>
<p>  首先的收获就是算勉强学会了点点IOS,完成IOS的一个基础的学习,虽然距离实战还是有点距离的,但是起码对IOS整体有个初步的了解,确实比android简单,并且很多地方比安卓要求规范些,可能制约IOS入门最大的问题就剩Xcode了,嘿嘿</p>
<p>  还有就是写博客,各种博客,不仅仅是技术博客,还包括其他方面的博客,好记性不如烂笔头,通过文字来把生活中遇到的各种问题和解决方法写出来,是一次重新整理和消化的过程,同时也加深了记忆.现在的博客是一个刚刚的开始,期待明年可以有所突破吧,提高自己的文学编写能力和表达能力.</p>
<p>  另一个感悟就是最近阅读源码体会到的,如何才能快速的提高编程能力,我觉得主要有两个方面:一个是通过阅读别人的开源代码来看下别人是怎么实现一个东西的,同时里面有很多的api或者技巧可能自己根本就不知道或者不清楚怎么用,通过看比人的代码来达到一个学习的过程;另一个就是编程想要提高就要明确目的性,也就是你到底要做出个说明东西出来,要以目的来导向,实际所有的学习都应该是带着问题和目的去学习的,这样的效率是最高的.这个后面的收获感悟会重新说明一下.明白了这两点对提高编程思想至关重要,这样在后续的学习和工作工程中可以少走很多弯路.</p>
<p>  还有一个感悟就是在对待开源项目的使用方式,之前看到别人的都是原封不动的把对方代码拿来直接用了,把自己的代码和对方的代码都掺杂在一起了,后面如果要替换掉这个库发现代价非常的大,”拿来主义”是要讲究形式的,最好在调用的时候再加一层中间层来解耦,这样在后续代码调整的过程中,只要直接替换中间层代码就可以,上层的代码是不需要改变的.这点非常非常的重要.在调整架构的时候要时刻保持关注.</p>
<p>  最后一个感悟就是自动化对工作效率上的提升,不过这一点目前做的还不是很到位,比如一些重复性的工作应该写脚本自动化运行,比如通过VI的学习来加快编程的速度.还有通过写一个命令来完成常用操作,等等,这些重复性的工作最好是都交给自动化来处理,不能傻傻的”硬”写.</p>
<h3 id="生活方面"><a href="#生活方面" class="headerlink" title="生活方面"></a>生活方面</h3><p>  生活方面我准备分几个方面来讲,一个生活习惯方面,一个是生活态度方面.</p>
<h4 id="生活习惯方面"><a href="#生活习惯方面" class="headerlink" title="生活习惯方面"></a>生活习惯方面</h4><p>  2016年在习惯方面有个巨大的进步就是写日记,感谢day one这个神奇的app,事件的起因就是通过app限免安装了day one这个神奇的软件,软件做的非常棒,可能是因为挺贵的,所以就坚持了几天写日记,没想到居然坚持下来了,不得不说真是一个奇迹,要知道长这么大,今天的写日记可能是我坚持的最久的一个习惯了.看了day one上的记录,从今年的2月18号开始,一直到今天,坚持了277天,歇了278条记录,拍了575张照片,真的,这是从小到大我坚持最久的一个习惯活动.再次谢谢day one这个app,后续等有钱了就买一个mac上的付费版本.</p>
<p>  另外一个坚持的算比较久的就是哑铃了,从9月份开始的,中间断断续续的一直坚持到最近,每天晚上在快10点的时候来个几十下,慢慢的发现胳膊居然越来越力量了,看看小习惯大作用啊,不过最近挺了几天了,前段时间打球伤到腰了,导致练哑铃的时候腰部不适很舒服,看看今天晚上能不能重新开始,争取把右手力量也练出来.</p>
<p>  还有一个没坚持下来但是非常应该坚持的习惯就是跑步,在5月份的时候坚持了一段时间,后来中间不知道为啥就停了,11月的时候早上去跑过几次,不过后来由于雾霾和天气的问题就停了,冬天果然不是一个适合跑步的季节.看开春的时候能不能重新开始,明年争取像13年的时候通过跑步来完成身体和精神上的重塑.</p>
<p>  还有就是明白读书笔记的重要性,以前读书都是看一遍就完了,以后可能过段时间就不记得了,白看,后来明白了读书一定做读书笔记,把书里重要的或者写的很精辟的地方记下来,整理归档,这样才算真正的”读书”.也谢谢&lt;如何有效阅读一本书：超实用笔记读书法&gt;,虽然写的比较简单,但是对阅读的技巧提出的建议是非常实用的.</p>
<p>  最后就是在游戏方面,之前玩dota玩的比较多了,后来发现越来越费神,同时玩完之后有很大的内疚和空虚感,所以就把dota给删除了,同时游戏也玩的很少很少了.明白了游戏的局限性,在减压方面还是运动和休息来的效果明显.玩游戏会越玩越累.</p>
<h4 id="生活态度方面"><a href="#生活态度方面" class="headerlink" title="生活态度方面"></a>生活态度方面</h4><p>  在生活态度方面主要是有被两件事给影响到了:<br>  一个是去年做胆结石手术,感觉特别不值得,身体被工作给拖垮了,身心都受到了很大的影响,以前老是觉得自己很重要,没有自己啥都搞不定,单位没了我不行,后来发现自己真的没那么重要,同时自己在老板眼里也没有那么重要,为了工作把身体搞垮是真的不值当的.</p>
<p>  另外一个就是高中的好友”鸭子”在青岛由于工作压力过大去世了,一个活生生的例子出现在自己的身边,以前觉得过劳死这种事情离自己很远,光是在网上听说了没有很重视,现在就活生生的发生的自己的身边,”鸭子”刚在青岛买房结婚,家里就他一个孩子,还要还房贷,可能这些种种原因吧,把自己给拖垮了,人没了,说明东西都没有了意义.so,身体和陪伴家人最重要,好好珍惜和家人在一起的每一天,世道艰辛,我们唯一能做的就是乐观的活着,好好享受每一天.</p>
<p>  总结下来,就是好好享受生活,想吃啥吃点啥,想买啥买点啥,好好珍惜和家人在一起的日子,每天都要学会感恩,同时每天都要开开心心的.这样才是生活的真正态度.活在当下!</p>
<h3 id="感情方面"><a href="#感情方面" class="headerlink" title="感情方面"></a>感情方面</h3><p>  在感情方面,今年做的还算不错,和老婆的相处越来越融洽,吵架的次数越来越少,随之而来就是俩人越来越胖,在减肥的道路上越走越远了.这一年明白了和家人相处的重要性,所以对老婆也格外的关心和爱护,可以说大事小事全都她说了算,我也乐得费脑子去思考,虽然老是被她说自己彪,嘿嘿,不过我自己不觉得,我只是不够”灵活”而已啦.</p>
<p>  做的不太好的方面可能是给奶奶和家里打电话的次数不算多,没有好好关注一下他们的动态,奶奶换了房子也是后来才知道的,父母身体也是后知后觉,感觉亏欠他们很多,明年一定好好的报答他们这么多年的养育之恩.</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>  好的方面就是明白了身体的重要性,同时也知道思考的重要性,还有写作的重要性,这些都是可以提升自己的全面素质的东西.差的的方面可能就是在计划的制定和执行上,还是在计划的制定上比较杂乱,同时执行力上还是不够强,导致效率不是很高,希望这点在来年可以好好的改善.同时,通过不断的”自省”,我发现今天一年突然很有收获,时间也过得慢了很多,往年都是不知不觉就过完了,没啥感觉也没啥收获,今年算是一个左右成效的一年吧.我把它称为”开智元年”.期待2017年我可以收获更大的进步,同时在”开智”方面取得长足的进步.下面就是2017年的年度计划了哦.</p>
<p>  最后,祝愿我和我的家人在新的一年里身体健康,事事顺心.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/12/31/2016/计划与总结/2016年度总结/" data-id="cizy2lg2d002eszs6o2k1couv" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/page/2/">&laquo; __('prev')</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/4/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/android/">android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/blog/">blog</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/github/">github</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java-blog-github/">java blog github</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java-blog-github/">java, blog, github</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/android/" style="font-size: 15px;">android</a> <a href="/tags/blog/" style="font-size: 20px;">blog</a> <a href="/tags/github/" style="font-size: 20px;">github</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/java-blog-github/" style="font-size: 10px;">java blog github</a> <a href="/tags/java-blog-github/" style="font-size: 10px;">java, blog, github</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/02/25/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2017/02/21/2017/android binder与aidl/">android binder与AIDL</a>
          </li>
        
          <li>
            <a href="/2017/02/17/2017/Android LruMemoryCache源码分析/">Android LruMemoryCache源码分析</a>
          </li>
        
          <li>
            <a href="/2017/02/17/2017/android DiskLruCache源码分析/">android DiskLruCache源码分析</a>
          </li>
        
          <li>
            <a href="/2017/02/15/2017/读书笔记/读书笔记书写技巧/">读书笔记书写技巧</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>