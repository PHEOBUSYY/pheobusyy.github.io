<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> android ButterKnife源码解析 · pheobusyy</title><meta name="description" content="android ButterKnife源码解析 - yanyi"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://pheobusyy.github.io/atom.xml" title="pheobusyy"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/sunchongsheng" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/pinggod" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">android ButterKnife源码解析</h1><div class="post-info">Jan 16, 2017</div><div class="post-content"><h2 id="android-ButterKnife源码解析"><a href="#android-ButterKnife源码解析" class="headerlink" title="android ButterKnife源码解析"></a>android ButterKnife源码解析</h2><h3 id="ButterKnife基本原理"><a href="#ButterKnife基本原理" class="headerlink" title="ButterKnife基本原理"></a>ButterKnife基本原理</h3><p>通过初次查看代码结构,发现原理大致和EventBus相同,通过定义不同的注解,然后通过注解分析器来生成新的源文件代码,在里面完成view的初始化和事件绑定,最后通过 <em>ButterKnife.bind</em> 方法来反射调用生成的新的源文件的中的初始化方法,来完成view的初始化和时间绑定.</p>
<p>可以这样理解,实际上以前是把findViewById等语句放在一个方法里面了,而这个方法在onCreate里面调用.现在是onCreate里面调用了 <em>ButterKnif.bind</em> 方法,里面还是findViewById那一套,只不过是通过注解分析器提前生成了源代码,里面是findViewById那些相关的声明语句.</p>
<p>注意,通过注解预编译这种方式可以达到在编译阶段来完成view的初始化和事件绑定,相对于反射是基本上没有性能消耗,所以是值得提倡的一种的技术方式.包括之前研究的Router也是通过这种方式来达到模块之间的相互调用的功能的.</p>
<h3 id="ButterKnife源代码分析"><a href="#ButterKnife源代码分析" class="headerlink" title="ButterKnife源代码分析"></a>ButterKnife源代码分析</h3><h4 id="ButterKnife的Bind方法调用"><a href="#ButterKnife的Bind方法调用" class="headerlink" title="ButterKnife的Bind方法调用"></a>ButterKnife的Bind方法调用</h4><p>先从ButterKnife的入口来分析,比如在Activity中我们调用 <em>ButterKnife.bind(this)</em> 方法,来看其内部实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@NonNull</span> <span class="meta">@UiThread</span></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Unbinder <span class="title">bind</span><span class="params">(@NonNull Activity target)</span> </span>&#123;</div><div class="line">   View sourceView = target.getWindow().getDecorView();</div><div class="line">   <span class="keyword">return</span> createBinding(target, sourceView);</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>这里获取到的是顶层DecorView,target是activity对象本身,然后交给 <em>createBinding</em> 方法.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Unbinder <span class="title">createBinding</span><span class="params">(@NonNull Object target, @NonNull View source)</span> </span>&#123;</div><div class="line">   Class&lt;?&gt; targetClass = target.getClass();</div><div class="line">   <span class="keyword">if</span> (debug) Log.d(TAG, <span class="string">"Looking up binding for "</span> + targetClass.getName());</div><div class="line">   Constructor&lt;? extends Unbinder&gt; constructor = findBindingConstructorForClass(targetClass);</div><div class="line"></div><div class="line">   <span class="keyword">if</span> (constructor == <span class="keyword">null</span>) &#123;</div><div class="line">     <span class="keyword">return</span> Unbinder.EMPTY;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">//noinspection TryWithIdenticalCatches Resolves to API 19+ only type.</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">     <span class="keyword">return</span> constructor.newInstance(target, source);</div><div class="line">   &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</div><div class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unable to invoke "</span> + constructor, e);</div><div class="line">   &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</div><div class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unable to invoke "</span> + constructor, e);</div><div class="line">   &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</div><div class="line">     Throwable cause = e.getCause();</div><div class="line">     <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> RuntimeException) &#123;</div><div class="line">       <span class="keyword">throw</span> (RuntimeException) cause;</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> Error) &#123;</div><div class="line">       <span class="keyword">throw</span> (Error) cause;</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unable to create binding instance."</span>, cause);</div><div class="line">   &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>这里可以看到 根据类名称来通过 <em>findBindingConstructorForClass</em> 查找该类具有两个参数的构造函数.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Nullable</span> <span class="meta">@CheckResult</span> <span class="meta">@UiThread</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> Constructor&lt;? extends Unbinder&gt; findBindingConstructorForClass(Class&lt;?&gt; cls) &#123;</div><div class="line">    Constructor&lt;? extends Unbinder&gt; bindingCtor = BINDINGS.get(cls);</div><div class="line">    <span class="keyword">if</span> (bindingCtor != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">if</span> (debug) Log.d(TAG, <span class="string">"HIT: Cached in binding map."</span>);</div><div class="line">      <span class="keyword">return</span> bindingCtor;</div><div class="line">    &#125;</div><div class="line">    String clsName = cls.getName();</div><div class="line">    <span class="keyword">if</span> (clsName.startsWith(<span class="string">"android."</span>) || clsName.startsWith(<span class="string">"java."</span>)) &#123;</div><div class="line">      <span class="keyword">if</span> (debug) Log.d(TAG, <span class="string">"MISS: Reached framework class. Abandoning search."</span>);</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      Class&lt;?&gt; bindingClass = Class.forName(clsName + <span class="string">"_ViewBinding"</span>);</div><div class="line">      <span class="comment">//noinspection unchecked</span></div><div class="line">      bindingCtor = (Constructor&lt;? extends Unbinder&gt;) bindingClass.getConstructor(cls, View.class);</div><div class="line">      <span class="keyword">if</span> (debug) Log.d(TAG, <span class="string">"HIT: Loaded binding class and constructor."</span>);</div><div class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">      <span class="keyword">if</span> (debug) Log.d(TAG, <span class="string">"Not found. Trying superclass "</span> + cls.getSuperclass().getName());</div><div class="line">      bindingCtor = findBindingConstructorForClass(cls.getSuperclass());</div><div class="line">    &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unable to find binding constructor for "</span> + clsName, e);</div><div class="line">    &#125;</div><div class="line">    BINDINGS.put(cls, bindingCtor);</div><div class="line">    <span class="keyword">return</span> bindingCtor;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@VisibleForTesting</span></div><div class="line"> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, Constructor&lt;? extends Unbinder&gt;&gt; BINDINGS = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</div></pre></td></tr></table></figure>
<p>这里 BINDINGS 是一个LinkedHashMap,存放的是类对象和它的构造函数对应关系.相当于一个缓存的作用,注意这里找的class对象是获取activity的类名称再加上 <em>_ViewBinding</em> 后缀.当使用ButterKnife编译完成之后,我们可以在我们工程中的build目录中找到 这些中间类.比如 你的activity名称叫做 “MainActivity”,那么生成的<br>中间类就叫做 “MainActivity_ViewBinding”.可以查看下里面的代码.就像这样:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleActivity_ViewBinding</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">SimpleActivity</span>&gt; <span class="keyword">implements</span> <span class="title">Unbinder</span> </span>&#123;</div><div class="line">  <span class="keyword">protected</span> T target;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> View view2130968578;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> View view2130968579;</div><div class="line"></div><div class="line">  <span class="meta">@UiThread</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">SimpleActivity_ViewBinding</span><span class="params">(<span class="keyword">final</span> T target, View source)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.target = target;</div><div class="line"></div><div class="line">    View view;</div><div class="line">    target.title = Utils.findRequiredViewAsType(source, R.id.title, <span class="string">"field 'title'"</span>, TextView.class);</div><div class="line">    target.subtitle = Utils.findRequiredViewAsType(source, R.id.subtitle, <span class="string">"field 'subtitle'"</span>, TextView.class);</div><div class="line">    view = Utils.findRequiredView(source, R.id.hello, <span class="string">"field 'hello', method 'sayHello', and method 'sayGetOffMe'"</span>);</div><div class="line">    target.hello = Utils.castView(view, R.id.hello, <span class="string">"field 'hello'"</span>, Button.class);</div><div class="line">    view2130968578 = view;</div><div class="line">    view.setOnClickListener(<span class="keyword">new</span> DebouncingOnClickListener() &#123;</div><div class="line">      <span class="meta">@Override</span></div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doClick</span><span class="params">(View p0)</span> </span>&#123;</div><div class="line">        target.sayHello();</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">    view.setOnLongClickListener(<span class="keyword">new</span> View.OnLongClickListener() &#123;</div><div class="line">      <span class="meta">@Override</span></div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onLongClick</span><span class="params">(View p0)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> target.sayGetOffMe();</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">    view = Utils.findRequiredView(source, R.id.list_of_things, <span class="string">"field 'listOfThings' and method 'onItemClick'"</span>);</div><div class="line">    target.listOfThings = Utils.castView(view, R.id.list_of_things, <span class="string">"field 'listOfThings'"</span>, ListView.class);</div><div class="line">    view2130968579 = view;</div><div class="line">    ((AdapterView&lt;?&gt;) view).setOnItemClickListener(<span class="keyword">new</span> AdapterView.OnItemClickListener() &#123;</div><div class="line">      <span class="meta">@Override</span></div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemClick</span><span class="params">(AdapterView&lt;?&gt; p0, View p1, <span class="keyword">int</span> p2, <span class="keyword">long</span> p3)</span> </span>&#123;</div><div class="line">        target.onItemClick(p2);</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">    target.footer = Utils.findRequiredViewAsType(source, R.id.footer, <span class="string">"field 'footer'"</span>, TextView.class);</div><div class="line">    target.headerViews = Utils.listOf(</div><div class="line">        Utils.findRequiredView(source, R.id.title, <span class="string">"field 'headerViews'"</span>),</div><div class="line">        Utils.findRequiredView(source, R.id.subtitle, <span class="string">"field 'headerViews'"</span>),</div><div class="line">        Utils.findRequiredView(source, R.id.hello, <span class="string">"field 'headerViews'"</span>));</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="meta">@CallSuper</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unbind</span><span class="params">()</span> </span>&#123;</div><div class="line">    T target = <span class="keyword">this</span>.target;</div><div class="line">    <span class="keyword">if</span> (target == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Bindings already cleared."</span>);</div><div class="line"></div><div class="line">    target.title = <span class="keyword">null</span>;</div><div class="line">    target.subtitle = <span class="keyword">null</span>;</div><div class="line">    target.hello = <span class="keyword">null</span>;</div><div class="line">    target.listOfThings = <span class="keyword">null</span>;</div><div class="line">    target.footer = <span class="keyword">null</span>;</div><div class="line">    target.headerViews = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    view2130968578.setOnClickListener(<span class="keyword">null</span>);</div><div class="line">    view2130968578.setOnLongClickListener(<span class="keyword">null</span>);</div><div class="line">    view2130968578 = <span class="keyword">null</span>;</div><div class="line">    ((AdapterView&lt;?&gt;) view2130968579).setOnItemClickListener(<span class="keyword">null</span>);</div><div class="line">    view2130968579 = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="keyword">this</span>.target = <span class="keyword">null</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个java类是通过注解解析器完成通过代码来生成的.可以看到里面就是一些view的初始化和事件绑定.唯一要注意的一点是,这里的中间类都是实现了unBinder接口,实现了unBind方法,里面是对view和各种事件的回收.主要是用在 <em>fragment</em> 中的使用的,看下ButterKnife的说明会看到,在 fragment使用完成之后必须调用 <em>ViewBinder.unBinder</em> 方法来完成view的回收.<br>下面的代码来着ButterKnife的说明:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">BINDING RESET</div><div class="line"></div><div class="line">Fragments have a different view lifecycle than activities. When binding a fragment in onCreateView, set the views to <span class="keyword">null</span> in onDestroyView. Butter Knife returns an Unbinder instance when you call bind to <span class="keyword">do</span> <span class="keyword">this</span> <span class="keyword">for</span> you. Call its unbind method in the appropriate lifecycle callback.</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FancyFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> </span>&#123;</div><div class="line">  <span class="meta">@BindView</span>(R.id.button1) Button button1;</div><div class="line">  <span class="meta">@BindView</span>(R.id.button2) Button button2;</div><div class="line">  <span class="keyword">private</span> Unbinder unbinder;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">    View view = inflater.inflate(R.layout.fancy_fragment, container, <span class="keyword">false</span>);</div><div class="line">    unbinder = ButterKnife.bind(<span class="keyword">this</span>, view);</div><div class="line">    <span class="comment">// TODO Use fields...</span></div><div class="line">    <span class="keyword">return</span> view;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroyView</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onDestroyView();</div><div class="line">    unbinder.unbind();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="注解分析器AnnotationProcessor的逻辑分析"><a href="#注解分析器AnnotationProcessor的逻辑分析" class="headerlink" title="注解分析器AnnotationProcessor的逻辑分析"></a>注解分析器AnnotationProcessor的逻辑分析</h4><p>核心点就在 <em>ButterKnifeProcessor</em> 里面.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getSupportedAnnotationTypes</span><span class="params">()</span> </span>&#123;</div><div class="line">    Set&lt;String&gt; types = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</div><div class="line">    <span class="keyword">for</span> (Class&lt;? extends Annotation&gt; annotation : getSupportedAnnotations()) &#123;</div><div class="line">      types.add(annotation.getCanonicalName());</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> types;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> Set&lt;Class&lt;? extends Annotation&gt;&gt; getSupportedAnnotations() &#123;</div><div class="line">    Set&lt;Class&lt;? extends Annotation&gt;&gt; annotations = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</div><div class="line"></div><div class="line">    annotations.add(BindArray.class);</div><div class="line">    annotations.add(BindBitmap.class);</div><div class="line">    annotations.add(BindBool.class);</div><div class="line">    annotations.add(BindColor.class);</div><div class="line">    annotations.add(BindDimen.class);</div><div class="line">    annotations.add(BindDrawable.class);</div><div class="line">    annotations.add(BindFloat.class);</div><div class="line">    annotations.add(BindInt.class);</div><div class="line">    annotations.add(BindString.class);</div><div class="line">    annotations.add(BindView.class);</div><div class="line">    annotations.add(BindViews.class);</div><div class="line">    annotations.addAll(LISTENERS);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> annotations;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;Class&lt;? extends Annotation&gt;&gt; LISTENERS = Arrays.asList(<span class="comment">//</span></div><div class="line">       OnCheckedChanged.class, <span class="comment">//</span></div><div class="line">       OnClick.class, <span class="comment">//</span></div><div class="line">       OnEditorAction.class, <span class="comment">//</span></div><div class="line">       OnFocusChange.class, <span class="comment">//</span></div><div class="line">       OnItemClick.class, <span class="comment">//</span></div><div class="line">       OnItemLongClick.class, <span class="comment">//</span></div><div class="line">       OnItemSelected.class, <span class="comment">//</span></div><div class="line">       OnLongClick.class, <span class="comment">//</span></div><div class="line">       OnPageChange.class, <span class="comment">//</span></div><div class="line">       OnTextChanged.class, <span class="comment">//</span></div><div class="line">       OnTouch.class <span class="comment">//</span></div><div class="line">   );</div></pre></td></tr></table></figure></p>
<p>可以通过 <em>getSupportedAnnotationTypes</em> 方法看到都支持哪些注解的处理.<br>重点的处理方法就在 <em>process</em> 方法中:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; elements, RoundEnvironment env)</span> </span>&#123;</div><div class="line">   Map&lt;TypeElement, BindingSet&gt; bindingMap = findAndParseTargets(env);</div><div class="line"></div><div class="line">   <span class="keyword">for</span> (Map.Entry&lt;TypeElement, BindingSet&gt; entry : bindingMap.entrySet()) &#123;</div><div class="line">     TypeElement typeElement = entry.getKey();</div><div class="line">     BindingSet binding = entry.getValue();</div><div class="line"></div><div class="line">     JavaFile javaFile = binding.brewJava(sdk);</div><div class="line">     <span class="keyword">try</span> &#123;</div><div class="line">       javaFile.writeTo(filer);</div><div class="line">     &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">       error(typeElement, <span class="string">"Unable to write binding for type %s: %s"</span>, typeElement, e.getMessage());</div><div class="line">     &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>可以看到第一行就是通过遍历扫描来找到对应类的所有 <em>ButterKnife</em> 注解,然后一次性来生成每个类的新的源文件类.</p>
<p>下面来看 <em>findAndParseTargets</em> 方法.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Map&lt;TypeElement, BindingSet&gt; <span class="title">findAndParseTargets</span><span class="params">(RoundEnvironment env)</span> </span>&#123;</div><div class="line">    Map&lt;TypeElement, BindingSet.Builder&gt; builderMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</div><div class="line">    Set&lt;TypeElement&gt; erasedTargetNames = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</div><div class="line"></div><div class="line">    scanForRClasses(env);</div><div class="line"></div><div class="line">    <span class="comment">// Process each @BindArray element.</span></div><div class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindArray.class)) &#123;</div><div class="line">      <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        parseResourceArray(element, builderMap, erasedTargetNames);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logParsingError(element, BindArray.class, e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Process each @BindBitmap element.</span></div><div class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindBitmap.class)) &#123;</div><div class="line">      <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        parseResourceBitmap(element, builderMap, erasedTargetNames);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logParsingError(element, BindBitmap.class, e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Process each @BindBool element.</span></div><div class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindBool.class)) &#123;</div><div class="line">      <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        parseResourceBool(element, builderMap, erasedTargetNames);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logParsingError(element, BindBool.class, e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Process each @BindColor element.</span></div><div class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindColor.class)) &#123;</div><div class="line">      <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        parseResourceColor(element, builderMap, erasedTargetNames);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logParsingError(element, BindColor.class, e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Process each @BindDimen element.</span></div><div class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindDimen.class)) &#123;</div><div class="line">      <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        parseResourceDimen(element, builderMap, erasedTargetNames);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logParsingError(element, BindDimen.class, e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Process each @BindDrawable element.</span></div><div class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindDrawable.class)) &#123;</div><div class="line">      <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        parseResourceDrawable(element, builderMap, erasedTargetNames);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logParsingError(element, BindDrawable.class, e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Process each @BindFloat element.</span></div><div class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindFloat.class)) &#123;</div><div class="line">      <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        parseResourceFloat(element, builderMap, erasedTargetNames);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logParsingError(element, BindFloat.class, e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Process each @BindInt element.</span></div><div class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindInt.class)) &#123;</div><div class="line">      <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        parseResourceInt(element, builderMap, erasedTargetNames);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logParsingError(element, BindInt.class, e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Process each @BindString element.</span></div><div class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindString.class)) &#123;</div><div class="line">      <span class="keyword">if</span> (!SuperficialValidation.validateElement(element)) <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        parseResourceString(element, builderMap, erasedTargetNames);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logParsingError(element, BindString.class, e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Process each @BindView element.</span></div><div class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindView.class)) &#123;</div><div class="line">      <span class="comment">// we don't SuperficialValidation.validateElement(element)</span></div><div class="line">      <span class="comment">// so that an unresolved View type can be generated by later processing rounds</span></div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        parseBindView(element, builderMap, erasedTargetNames);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logParsingError(element, BindView.class, e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Process each @BindViews element.</span></div><div class="line">    <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindViews.class)) &#123;</div><div class="line">      <span class="comment">// we don't SuperficialValidation.validateElement(element)</span></div><div class="line">      <span class="comment">// so that an unresolved View type can be generated by later processing rounds</span></div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        parseBindViews(element, builderMap, erasedTargetNames);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logParsingError(element, BindViews.class, e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Process each annotation that corresponds to a listener.</span></div><div class="line">    <span class="keyword">for</span> (Class&lt;? extends Annotation&gt; listener : LISTENERS) &#123;</div><div class="line">      findAndParseListener(env, listener, builderMap, erasedTargetNames);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Associate superclass binders with their subclass binders. This is a queue-based tree walk</span></div><div class="line">    <span class="comment">// which starts at the roots (superclasses) and walks to the leafs (subclasses).</span></div><div class="line">    Deque&lt;Map.Entry&lt;TypeElement, BindingSet.Builder&gt;&gt; entries =</div><div class="line">        <span class="keyword">new</span> ArrayDeque&lt;&gt;(builderMap.entrySet());</div><div class="line">    Map&lt;TypeElement, BindingSet&gt; bindingMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</div><div class="line">    <span class="keyword">while</span> (!entries.isEmpty()) &#123;</div><div class="line">      Map.Entry&lt;TypeElement, BindingSet.Builder&gt; entry = entries.removeFirst();</div><div class="line"></div><div class="line">      TypeElement type = entry.getKey();</div><div class="line">      BindingSet.Builder builder = entry.getValue();</div><div class="line"></div><div class="line">      TypeElement parentType = findParentType(type, erasedTargetNames);</div><div class="line">      <span class="keyword">if</span> (parentType == <span class="keyword">null</span>) &#123;</div><div class="line">        bindingMap.put(type, builder.build());</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        BindingSet parentBinding = bindingMap.get(parentType);</div><div class="line">        <span class="keyword">if</span> (parentBinding != <span class="keyword">null</span>) &#123;</div><div class="line">          builder.setParent(parentBinding);</div><div class="line">          bindingMap.put(type, builder.build());</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          <span class="comment">// Has a superclass binding but we haven't built it yet. Re-enqueue for later.</span></div><div class="line">          entries.addLast(entry);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> bindingMap;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>这个 <em>findAndParseTargets</em> 方法看着很长,实际上分成了3部分,顶部是用来生成id和view的对应关系,中间是各种注解的处理后放入builderMap中,第三部分是遍历builderMap来生成BindingMap的.<br>先看如何生成ID的对应关系:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">scanForRClasses(env);</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scanForRClasses</span><span class="params">(RoundEnvironment env)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (trees == <span class="keyword">null</span>) <span class="keyword">return</span>;</div><div class="line"></div><div class="line">   RClassScanner scanner = <span class="keyword">new</span> RClassScanner();</div><div class="line"></div><div class="line">   <span class="keyword">for</span> (Class&lt;? extends Annotation&gt; annotation : getSupportedAnnotations()) &#123;</div><div class="line">     <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(annotation)) &#123;</div><div class="line">       JCTree tree = (JCTree) trees.getTree(element, getMirror(element, annotation));</div><div class="line">       <span class="keyword">if</span> (tree != <span class="keyword">null</span>) &#123; <span class="comment">// tree can be null if the references are compiled types and not source</span></div><div class="line">         tree.accept(scanner);</div><div class="line">       &#125;</div><div class="line">     &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">for</span> (String rClass : scanner.getRClasses()) &#123;</div><div class="line">     parseRClass(rClass);</div><div class="line">   &#125;</div><div class="line"> &#125;</div><div class="line"></div><div class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseRClass</span><span class="params">(String rClass)</span> </span>&#123;</div><div class="line">   Element element;</div><div class="line"></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">     element = elementUtils.getTypeElement(rClass);</div><div class="line">   &#125; <span class="keyword">catch</span> (MirroredTypeException mte) &#123;</div><div class="line">     element = typeUtils.asElement(mte.getTypeMirror());</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   JCTree tree = (JCTree) trees.getTree(element);</div><div class="line">   <span class="keyword">if</span> (tree != <span class="keyword">null</span>) &#123; <span class="comment">// tree can be null if the references are compiled types and not source</span></div><div class="line">     IdScanner idScanner =</div><div class="line">         <span class="keyword">new</span> IdScanner(symbols, elementUtils.getPackageOf(element).getQualifiedName().toString());</div><div class="line">     tree.accept(idScanner);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">     parseCompiledR((TypeElement) element);</div><div class="line">   &#125;</div><div class="line"> &#125;</div><div class="line"></div><div class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseCompiledR</span><span class="params">(TypeElement rClass)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (Element element : rClass.getEnclosedElements()) &#123;</div><div class="line">     String innerClassName = element.getSimpleName().toString();</div><div class="line">     <span class="keyword">if</span> (SUPPORTED_TYPES.contains(innerClassName)) &#123;</div><div class="line">       <span class="keyword">for</span> (Element enclosedElement : element.getEnclosedElements()) &#123;</div><div class="line">         <span class="keyword">if</span> (enclosedElement <span class="keyword">instanceof</span> VariableElement) &#123;</div><div class="line">           VariableElement variableElement = (VariableElement) enclosedElement;</div><div class="line">           Object value = variableElement.getConstantValue();</div><div class="line"></div><div class="line">           <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Integer) &#123;</div><div class="line">             <span class="keyword">int</span> id = (Integer) value;</div><div class="line">             ClassName rClassName =</div><div class="line">                 ClassName.get(elementUtils.getPackageOf(variableElement).toString(), <span class="string">"R"</span>,</div><div class="line">                     innerClassName);</div><div class="line">             String resourceName = variableElement.getSimpleName().toString();</div><div class="line">             symbols.put(id, <span class="keyword">new</span> Id(id, rClassName, resourceName));</div><div class="line">           &#125;</div><div class="line">         &#125;</div><div class="line">       &#125;</div><div class="line">     &#125;</div><div class="line">   &#125;</div><div class="line"> &#125;</div><div class="line"></div><div class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">RClassScanner</span> <span class="keyword">extends</span> <span class="title">TreeScanner</span> </span>&#123;</div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; rClasses = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</div><div class="line"></div><div class="line">   <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitSelect</span><span class="params">(JCTree.JCFieldAccess jcFieldAccess)</span> </span>&#123;</div><div class="line">     Symbol symbol = jcFieldAccess.sym;</div><div class="line">     <span class="keyword">if</span> (symbol != <span class="keyword">null</span></div><div class="line">         &amp;&amp; symbol.getEnclosingElement() != <span class="keyword">null</span></div><div class="line">         &amp;&amp; symbol.getEnclosingElement().getEnclosingElement() != <span class="keyword">null</span></div><div class="line">         &amp;&amp; symbol.getEnclosingElement().getEnclosingElement().enclClass() != <span class="keyword">null</span>) &#123;</div><div class="line">       rClasses.add(symbol.getEnclosingElement().getEnclosingElement().enclClass().className());</div><div class="line">     &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="function">Set&lt;String&gt; <span class="title">getRClasses</span><span class="params">()</span> </span>&#123;</div><div class="line">     <span class="keyword">return</span> rClasses;</div><div class="line">   &#125;</div><div class="line"> &#125;</div><div class="line"></div><div class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">IdScanner</span> <span class="keyword">extends</span> <span class="title">TreeScanner</span> </span>&#123;</div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Integer, Id&gt; ids;</div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> String packageName;</div><div class="line"></div><div class="line">   IdScanner(Map&lt;Integer, Id&gt; ids, String packageName) &#123;</div><div class="line">     <span class="keyword">this</span>.ids = ids;</div><div class="line">     <span class="keyword">this</span>.packageName = packageName;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitClassDef</span><span class="params">(JCTree.JCClassDecl jcClassDecl)</span> </span>&#123;</div><div class="line">     <span class="keyword">for</span> (JCTree tree : jcClassDecl.defs) &#123;</div><div class="line">       <span class="keyword">if</span> (tree <span class="keyword">instanceof</span> ClassTree) &#123;</div><div class="line">         ClassTree classTree = (ClassTree) tree;</div><div class="line">         String className = classTree.getSimpleName().toString();</div><div class="line">         <span class="keyword">if</span> (SUPPORTED_TYPES.contains(className)) &#123;</div><div class="line">           ClassName rClassName = ClassName.get(packageName, <span class="string">"R"</span>, className);</div><div class="line">           VarScanner scanner = <span class="keyword">new</span> VarScanner(ids, rClassName);</div><div class="line">           ((JCTree) classTree).accept(scanner);</div><div class="line">         &#125;</div><div class="line">       &#125;</div><div class="line">     &#125;</div><div class="line">   &#125;</div><div class="line"> &#125;</div><div class="line"></div><div class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">VarScanner</span> <span class="keyword">extends</span> <span class="title">TreeScanner</span> </span>&#123;</div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Integer, Id&gt; ids;</div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> ClassName className;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="title">VarScanner</span><span class="params">(Map&lt;Integer, Id&gt; ids, ClassName className)</span> </span>&#123;</div><div class="line">     <span class="keyword">this</span>.ids = ids;</div><div class="line">     <span class="keyword">this</span>.className = className;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitVarDef</span><span class="params">(JCTree.JCVariableDecl jcVariableDecl)</span> </span>&#123;</div><div class="line">     <span class="keyword">if</span> (<span class="string">"int"</span>.equals(jcVariableDecl.getType().toString())) &#123;</div><div class="line">       <span class="keyword">int</span> id = Integer.valueOf(jcVariableDecl.getInitializer().toString());</div><div class="line">       String resourceName = jcVariableDecl.getName().toString();</div><div class="line">       ids.put(id, <span class="keyword">new</span> Id(id, className, resourceName));</div><div class="line">     &#125;</div><div class="line">   &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>这里,如何关于如何生成这个对应关系的里面用到一些api我不是很了解,网上的资料也很少,后续等到研究明白了再补充吧,只是通过字面理解应该是通过遍历java的语法分析树找到R文件中对应的filed的ID,组合成一个 <em>Id</em> .<br>中间的部分就是用来做生成builderMap的,我们挑其中的一个方法来看,大部分的方法都是类似的.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseBindView</span><span class="params">(Element element, Map&lt;TypeElement, BindingSet.Builder&gt; builderMap,</span></span></div><div class="line">                              Set&lt;TypeElement&gt; erasedTargetNames) &#123;</div><div class="line">       TypeElement enclosingElement = (TypeElement) element.getEnclosingElement();</div><div class="line"></div><div class="line">       <span class="comment">// Start by verifying common generated code restrictions.</span></div><div class="line">       <span class="keyword">boolean</span> hasError = isInaccessibleViaGeneratedCode(BindView.class, <span class="string">"fields"</span>, element)</div><div class="line">               || isBindingInWrongPackage(BindView.class, element);</div><div class="line"></div><div class="line">       <span class="comment">// Verify that the target type extends from View.</span></div><div class="line">       TypeMirror elementType = element.asType();</div><div class="line">       <span class="keyword">if</span> (elementType.getKind() == TypeKind.TYPEVAR) &#123;</div><div class="line">           TypeVariable typeVariable = (TypeVariable) elementType;</div><div class="line">           elementType = typeVariable.getUpperBound();</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (!isSubtypeOfType(elementType, VIEW_TYPE) &amp;&amp; !isInterface(elementType)) &#123;</div><div class="line">           <span class="keyword">if</span> (elementType.getKind() == TypeKind.ERROR) &#123;</div><div class="line">               note(element, <span class="string">"@%s field with unresolved type (%s) "</span></div><div class="line">                               + <span class="string">"must elsewhere be generated as a View or interface. (%s.%s)"</span>,</div><div class="line">                       BindView.class.getSimpleName(), elementType, enclosingElement.getQualifiedName(),</div><div class="line">                       element.getSimpleName());</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               error(element, <span class="string">"@%s fields must extend from View or be an interface. (%s.%s)"</span>,</div><div class="line">                       BindView.class.getSimpleName(), enclosingElement.getQualifiedName(),</div><div class="line">                       element.getSimpleName());</div><div class="line">               hasError = <span class="keyword">true</span>;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (hasError) &#123;</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// Assemble information on the field.</span></div><div class="line">       <span class="keyword">int</span> id = element.getAnnotation(BindView.class).value();</div><div class="line"></div><div class="line">       BindingSet.Builder builder = builderMap.get(enclosingElement);</div><div class="line">       <span class="keyword">if</span> (builder != <span class="keyword">null</span>) &#123;</div><div class="line">           String existingBindingName = builder.findExistingBindingName(getId(id));</div><div class="line">           <span class="keyword">if</span> (existingBindingName != <span class="keyword">null</span>) &#123;</div><div class="line">               error(element, <span class="string">"Attempt to use @%s for an already bound ID %d on '%s'. (%s.%s)"</span>,</div><div class="line">                       BindView.class.getSimpleName(), id, existingBindingName,</div><div class="line">                       enclosingElement.getQualifiedName(), element.getSimpleName());</div><div class="line">               <span class="keyword">return</span>;</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           builder = getOrCreateBindingBuilder(builderMap, enclosingElement);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       String name = element.getSimpleName().toString();</div><div class="line">       TypeName type = TypeName.get(elementType);</div><div class="line">       <span class="keyword">boolean</span> required = isFieldRequired(element);</div><div class="line"></div><div class="line">       builder.addField(getId(id), <span class="keyword">new</span> FieldViewBinding(name, type, required));</div><div class="line"></div><div class="line">       <span class="comment">// Add the type-erased version to the valid binding targets set.</span></div><div class="line">       erasedTargetNames.add(enclosingElement);</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>这个方法前半部分用来做ID校验,防止有重复的Id定义出现错误.<br>后半部分生成一个 <em>BindingSet.Builder</em> 对象,这个对象就是用来后续通过 <em>javapoet</em> 来生成制定的java源文件的.builderMap的key是声明注解的类,通常是我们的Activity或者viewHolder.<br>然后把 <em>FieldViewBinding</em> 放入builder中,其中 filed的key就是view本身的ID.</p>
<p><em>findAndParseTargets</em> 的最后一部分是用来生成bindingMap的,key是声明类,value是BindingSet对象.<br>通过中间生成的 <em>builderMap</em> 来完成.主要是用来子类和父类如果同时声明的时把两者合并成一个BindingSet对象.</p>
<p><em>BindingSet</em> 对象就是用来交给javaPoet来生成中间源文件的对象.</p>
<p>生成了BindingMap之后回到顶层的 <em>process</em> 方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (Map.Entry&lt;TypeElement, BindingSet&gt; entry : bindingMap.entrySet()) &#123;</div><div class="line">            TypeElement typeElement = entry.getKey();</div><div class="line">            BindingSet binding = entry.getValue();</div><div class="line"></div><div class="line">            JavaFile javaFile = binding.brewJava(sdk);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                javaFile.writeTo(filer);</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                error(typeElement, <span class="string">"Unable to write binding for type %s: %s"</span>, typeElement, e.getMessage());</div><div class="line">            &#125;</div><div class="line">        &#125;</div></pre></td></tr></table></figure></p>
<p>可以看到这里调用的是 <em>bindingSet</em> 对象的 <em>brewJava</em> 方法来完成java源文件的写入的:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function">JavaFile <span class="title">brewJava</span><span class="params">(<span class="keyword">int</span> sdk)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> JavaFile.builder(bindingClassName.packageName(), createType(sdk))</div><div class="line">      .addFileComment(<span class="string">"Generated code from Butter Knife. Do not modify!"</span>)</div><div class="line">      .build();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后调用 <em>createType</em> 方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> TypeSpec <span class="title">createType</span><span class="params">(<span class="keyword">int</span> sdk)</span> </span>&#123;</div><div class="line">    TypeSpec.Builder result = TypeSpec.classBuilder(bindingClassName.simpleName())</div><div class="line">        .addModifiers(PUBLIC);</div><div class="line">    <span class="keyword">if</span> (isFinal) &#123;</div><div class="line">      result.addModifiers(FINAL);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (parentBinding != <span class="keyword">null</span>) &#123;</div><div class="line">      result.superclass(parentBinding.bindingClassName);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      result.addSuperinterface(UNBINDER);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (hasTargetField()) &#123;</div><div class="line">      result.addField(targetTypeName, <span class="string">"target"</span>, PRIVATE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!constructorNeedsView()) &#123;</div><div class="line">      <span class="comment">// Add a delegating constructor with a target type + view signature for reflective use.</span></div><div class="line">      result.addMethod(createBindingViewDelegateConstructor(targetTypeName));</div><div class="line">    &#125;</div><div class="line">    result.addMethod(createBindingConstructor(targetTypeName, sdk));</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (hasViewBindings() || parentBinding == <span class="keyword">null</span>) &#123;</div><div class="line">      result.addMethod(createBindingUnbindMethod(result, targetTypeName));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> result.build();</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p><em>createType</em> 分为三部分,一部分是createBindingViewDelegateConstructor,一部分是createBindingConstructor,还有一部分是createBindingUnbindMethod<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> MethodSpec <span class="title">createBindingViewDelegateConstructor</span><span class="params">(TypeName targetType)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> MethodSpec.constructorBuilder()</div><div class="line">      .addJavadoc(<span class="string">"@deprecated Use &#123;@link #$T($T, $T)&#125; for direct creation.\n    "</span></div><div class="line">              + <span class="string">"Only present for runtime invocation through &#123;@code ButterKnife.bind()&#125;.\n"</span>,</div><div class="line">          bindingClassName, targetType, CONTEXT)</div><div class="line">      .addAnnotation(Deprecated.class)</div><div class="line">      .addAnnotation(UI_THREAD)</div><div class="line">      .addModifiers(PUBLIC)</div><div class="line">      .addParameter(targetType, <span class="string">"target"</span>)</div><div class="line">      .addParameter(VIEW, <span class="string">"source"</span>)</div><div class="line">      .addStatement((<span class="string">"this(target, source.getContext())"</span>))</div><div class="line">      .build();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个构造函数的作用暂时没有弄明白,看说明好像是用来在运行的时候反射用的.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> MethodSpec <span class="title">createBindingConstructor</span><span class="params">(TypeName targetType, <span class="keyword">int</span> sdk)</span> </span>&#123;</div><div class="line">    MethodSpec.Builder constructor = MethodSpec.constructorBuilder()</div><div class="line">        .addAnnotation(UI_THREAD)</div><div class="line">        .addModifiers(PUBLIC);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (hasMethodBindings()) &#123;</div><div class="line">      constructor.addParameter(targetType, <span class="string">"target"</span>, FINAL);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      constructor.addParameter(targetType, <span class="string">"target"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (constructorNeedsView()) &#123;</div><div class="line">      constructor.addParameter(VIEW, <span class="string">"source"</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      constructor.addParameter(CONTEXT, <span class="string">"context"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (hasUnqualifiedResourceBindings()) &#123;</div><div class="line">      <span class="comment">// Aapt can change IDs out from underneath us, just suppress since all will work at runtime.</span></div><div class="line">      constructor.addAnnotation(AnnotationSpec.builder(SuppressWarnings.class)</div><div class="line">          .addMember(<span class="string">"value"</span>, <span class="string">"$S"</span>, <span class="string">"ResourceType"</span>)</div><div class="line">          .build());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (hasOnTouchMethodBindings()) &#123;</div><div class="line">      constructor.addAnnotation(AnnotationSpec.builder(SUPPRESS_LINT)</div><div class="line">          .addMember(<span class="string">"value"</span>, <span class="string">"$S"</span>, <span class="string">"ClickableViewAccessibility"</span>)</div><div class="line">          .build());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (parentBinding != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">if</span> (parentBinding.constructorNeedsView()) &#123;</div><div class="line">        constructor.addStatement(<span class="string">"super(target, source)"</span>);</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (constructorNeedsView()) &#123;</div><div class="line">        constructor.addStatement(<span class="string">"super(target, source.getContext())"</span>);</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        constructor.addStatement(<span class="string">"super(target, context)"</span>);</div><div class="line">      &#125;</div><div class="line">      constructor.addCode(<span class="string">"\n"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (hasTargetField()) &#123;</div><div class="line">      constructor.addStatement(<span class="string">"this.target = target"</span>);</div><div class="line">      constructor.addCode(<span class="string">"\n"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (hasViewBindings()) &#123;</div><div class="line">      <span class="keyword">if</span> (hasViewLocal()) &#123;</div><div class="line">        <span class="comment">// Local variable in which all views will be temporarily stored.</span></div><div class="line">        constructor.addStatement(<span class="string">"$T view"</span>, VIEW);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">for</span> (ViewBinding binding : viewBindings) &#123;</div><div class="line">        addViewBinding(constructor, binding);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">for</span> (FieldCollectionViewBinding binding : collectionBindings) &#123;</div><div class="line">        constructor.addStatement(<span class="string">"$L"</span>, binding.render());</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (!resourceBindings.isEmpty()) &#123;</div><div class="line">        constructor.addCode(<span class="string">"\n"</span>);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!resourceBindings.isEmpty()) &#123;</div><div class="line">      <span class="keyword">if</span> (constructorNeedsView()) &#123;</div><div class="line">        constructor.addStatement(<span class="string">"$T context = source.getContext()"</span>, CONTEXT);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (hasResourceBindingsNeedingResource(sdk)) &#123;</div><div class="line">        constructor.addStatement(<span class="string">"$T res = context.getResources()"</span>, RESOURCES);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">for</span> (ResourceBinding binding : resourceBindings) &#123;</div><div class="line">        constructor.addStatement(<span class="string">"$L"</span>, binding.render(sdk));</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> constructor.build();</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>这个方法来生成中间类的构造函数,里面定义了view的findViewById和绑定事件,生成的结果在前面已经列出了,就是 <em>javaPoet</em> 的API调用,非常容易理解.</p>
<p>最后是生成filed和unbind方法的 <em>createBindingUnbindMethod</em>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> MethodSpec <span class="title">createBindingUnbindMethod</span><span class="params">(TypeSpec.Builder bindingClass,</span></span></div><div class="line">    TypeName targetType) &#123;</div><div class="line">  MethodSpec.Builder result = MethodSpec.methodBuilder(<span class="string">"unbind"</span>)</div><div class="line">      .addAnnotation(Override.class)</div><div class="line">      .addModifiers(PUBLIC);</div><div class="line">  <span class="keyword">if</span> (!isFinal &amp;&amp; parentBinding == <span class="keyword">null</span>) &#123;</div><div class="line">    result.addAnnotation(CALL_SUPER);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (hasTargetField()) &#123;</div><div class="line">    <span class="keyword">if</span> (hasFieldBindings()) &#123;</div><div class="line">      result.addStatement(<span class="string">"$T target = this.target"</span>, targetType);</div><div class="line">    &#125;</div><div class="line">    result.addStatement(<span class="string">"if (target == null) throw new $T($S)"</span>, IllegalStateException.class,</div><div class="line">        <span class="string">"Bindings already cleared."</span>);</div><div class="line">    result.addStatement(<span class="string">"$N = null"</span>, hasFieldBindings() ? <span class="string">"this.target"</span> : <span class="string">"target"</span>);</div><div class="line">    result.addCode(<span class="string">"\n"</span>);</div><div class="line">    <span class="keyword">for</span> (ViewBinding binding : viewBindings) &#123;</div><div class="line">      <span class="keyword">if</span> (binding.getFieldBinding() != <span class="keyword">null</span>) &#123;</div><div class="line">        result.addStatement(<span class="string">"target.$L = null"</span>, binding.getFieldBinding().getName());</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (FieldCollectionViewBinding binding : collectionBindings) &#123;</div><div class="line">      result.addStatement(<span class="string">"target.$L = null"</span>, binding.name);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (hasMethodBindings()) &#123;</div><div class="line">    result.addCode(<span class="string">"\n"</span>);</div><div class="line">    <span class="keyword">for</span> (ViewBinding binding : viewBindings) &#123;</div><div class="line">      addFieldAndUnbindStatement(bindingClass, result, binding);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (parentBinding != <span class="keyword">null</span>) &#123;</div><div class="line">    result.addCode(<span class="string">"\n"</span>);</div><div class="line">    result.addStatement(<span class="string">"super.unbind()"</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> result.build();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里unBind方法不做过多的解释,主要是来看<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (ViewBinding binding : viewBindings) &#123;</div><div class="line">  addFieldAndUnbindStatement(bindingClass, result, binding);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addFieldAndUnbindStatement</span><span class="params">(TypeSpec.Builder result, MethodSpec.Builder unbindMethod,</span></span></div><div class="line">    ViewBinding bindings) &#123;</div><div class="line">  <span class="comment">// Only add fields to the binding if there are method bindings.</span></div><div class="line">  Map&lt;ListenerClass, Map&lt;ListenerMethod, Set&lt;MethodViewBinding&gt;&gt;&gt; classMethodBindings =</div><div class="line">      bindings.getMethodBindings();</div><div class="line">  <span class="keyword">if</span> (classMethodBindings.isEmpty()) &#123;</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  String fieldName = bindings.isBoundToRoot() ? <span class="string">"viewSource"</span> : <span class="string">"view"</span> + bindings.getId().value;</div><div class="line">  result.addField(VIEW, fieldName, PRIVATE);</div><div class="line"></div><div class="line">  <span class="comment">// We only need to emit the null check if there are zero required bindings.</span></div><div class="line">  <span class="keyword">boolean</span> needsNullChecked = bindings.getRequiredBindings().isEmpty();</div><div class="line">  <span class="keyword">if</span> (needsNullChecked) &#123;</div><div class="line">    unbindMethod.beginControlFlow(<span class="string">"if ($N != null)"</span>, fieldName);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">for</span> (ListenerClass listenerClass : classMethodBindings.keySet()) &#123;</div><div class="line">    <span class="comment">// We need to keep a reference to the listener</span></div><div class="line">    <span class="comment">// in case we need to unbind it via a remove method.</span></div><div class="line">    <span class="keyword">boolean</span> requiresRemoval = !<span class="string">""</span>.equals(listenerClass.remover());</div><div class="line">    String listenerField = <span class="string">"null"</span>;</div><div class="line">    <span class="keyword">if</span> (requiresRemoval) &#123;</div><div class="line">      TypeName listenerClassName = bestGuess(listenerClass.type());</div><div class="line">      listenerField = fieldName + ((ClassName) listenerClassName).simpleName();</div><div class="line">      result.addField(listenerClassName, listenerField, PRIVATE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!VIEW_TYPE.equals(listenerClass.targetType())) &#123;</div><div class="line">      unbindMethod.addStatement(<span class="string">"(($T) $N).$N($N)"</span>, bestGuess(listenerClass.targetType()),</div><div class="line">          fieldName, removerOrSetter(listenerClass, requiresRemoval), listenerField);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      unbindMethod.addStatement(<span class="string">"$N.$N($N)"</span>, fieldName,</div><div class="line">          removerOrSetter(listenerClass, requiresRemoval), listenerField);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (requiresRemoval) &#123;</div><div class="line">      unbindMethod.addStatement(<span class="string">"$N = null"</span>, listenerField);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  unbindMethod.addStatement(<span class="string">"$N = null"</span>, fieldName);</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (needsNullChecked) &#123;</div><div class="line">    unbindMethod.endControlFlow();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个方法用来生成中间类的filed,也就是view和事件的声明.之前在前面找了半天如何生成filed的方法一直没有找到,后来这这里才发现的.<br>声明的view名称是View+ID这种格式.</p>
<p>到这里大概的流程就讲完了,可能还是有些细节没有讲到,不过没有关系,只要明白了大概的运行方式就可以了.可以看到作者的思路非常的新颖就是通过中间类来完成一些初始化工作,这个给我们后续的android的编程中提供了一套可借鉴的思路.</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a href="http://jakewharton.github.io/butterknife/" title="butterKnife document" target="_blank" rel="external">butterKnife document</a></p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/01/19/2017/android asyncTask源码分析/" class="prev">上一篇</a><a href="/2017/01/15/2017/读书笔记/2017-01-15-出奇制胜-在快速变化的世界如何加速成功/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2017 <a href="http://pheobusyy.github.io">yanyi</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>