<!doctype html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="pheobusyy" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="android universal image loader 源码分析  UIL是在android中4大主流图片加载框架之一,它为图片加载提供了一套功能强大,灵活和高可定制性的解决方案,具有非常重要的学习意义,虽然该项目目前已经不维护了,但是很多程序依然在使用着,所以本期重点来学习UIL的内部实现,看看作者的实现思路和我们平时实现的图片加载有什么区别和共同点.
  说道图片加载我们常用的3级缓存,">
<meta property="og:type" content="article">
<meta property="og:title" content="android universal image loader源码分析">
<meta property="og:url" content="http://pheobusyy.github.io/2017/01/01/2017/android universal image loader源码分析/index.html">
<meta property="og:site_name" content="pheobusyy">
<meta property="og:description" content="android universal image loader 源码分析  UIL是在android中4大主流图片加载框架之一,它为图片加载提供了一套功能强大,灵活和高可定制性的解决方案,具有非常重要的学习意义,虽然该项目目前已经不维护了,但是很多程序依然在使用着,所以本期重点来学习UIL的内部实现,看看作者的实现思路和我们平时实现的图片加载有什么区别和共同点.
  说道图片加载我们常用的3级缓存,">
<meta property="og:image" content="http://pheobusyy.github.io/images/2017/01/UIL_Flow.png">
<meta property="og:updated_time" content="2017-02-25T01:12:01.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="android universal image loader源码分析">
<meta name="twitter:description" content="android universal image loader 源码分析  UIL是在android中4大主流图片加载框架之一,它为图片加载提供了一套功能强大,灵活和高可定制性的解决方案,具有非常重要的学习意义,虽然该项目目前已经不维护了,但是很多程序依然在使用着,所以本期重点来学习UIL的内部实现,看看作者的实现思路和我们平时实现的图片加载有什么区别和共同点.
  说道图片加载我们常用的3级缓存,">
<meta name="twitter:image" content="http://pheobusyy.github.io/images/2017/01/UIL_Flow.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://pheobusyy.github.io/2017/01/01/2017/android universal image loader源码分析/"/>





  <title> android universal image loader源码分析 | pheobusyy </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="">

  














  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">pheobusyy</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Startseite
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archiv
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://pheobusyy.github.io/2017/01/01/2017/android universal image loader源码分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yanyi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pheobusyy">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                android universal image loader源码分析
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-01T10:21:00+08:00">
                2017-01-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="android-universal-image-loader-源码分析"><a href="#android-universal-image-loader-源码分析" class="headerlink" title="android universal image loader 源码分析"></a>android universal image loader 源码分析</h2><p>  UIL是在android中4大主流图片加载框架之一,它为图片加载提供了一套功能强大,灵活和高可定制性的解决方案,具有非常重要的学习意义,虽然该项目目前已经不维护了,但是很多程序依然在使用着,所以本期重点来学习UIL的内部实现,看看作者的实现思路和我们平时实现的图片加载有什么区别和共同点.</p>
<p>  说道图片加载我们常用的3级缓存,先从内存中找对应url的图片,如果没有找到就从手机存储中找,如果还没找到就从网络上去下载.这里的内存,磁盘,网络称为图片加载3级缓存.我么以前的实现也就是这么个大概流程,唯一需要注意的是从本地磁盘加载和从服务器下载是需要在子线程中工作,否者在主线程中耗时太长会阻塞主线程,导致ANR等等问题.</p>
<p>  UIL的实现流程也是这样的,唯一不用的是对三层的定义通过接口来完成灵活的定制,同时内部通过线程池来统一调度任务,还有一些对图片的Bitmap对象的二次处理等等,这些东西我们在下面都会讲到,总之非常值得学习.</p>
<p>  下面这张图是作者画的UIL的流程图,从图中可以看出和我们上面分析的流程类似<br><img src="images/2017/01/UIL_Flow.png" alt="  UIL流程图"></p>
<h3 id="UIL源码分析"><a href="#UIL源码分析" class="headerlink" title="UIL源码分析"></a>UIL源码分析</h3><h4 id="ImageLoader"><a href="#ImageLoader" class="headerlink" title="ImageLoader"></a>ImageLoader</h4><p>首先因为全局只有一个ImageLoader对象来管理加载,so,肯定是个单例:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> ImageLoader instance;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ImageLoader <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">synchronized</span> (ImageLoader.class) &#123;</div><div class="line">				<span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</div><div class="line">					instance = <span class="keyword">new</span> ImageLoader();</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> instance;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>然后把各种配置作为一个对象也就是下面提到的 <em>ImageLoaderConfiguration</em> 传给ImageLoader对象来完成配置,这里调用了init方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ImageLoaderConfiguration configuration)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (configuration == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(ERROR_INIT_CONFIG_WITH_NULL);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.configuration == <span class="keyword">null</span>) &#123;</div><div class="line">			L.d(LOG_INIT_CONFIG);</div><div class="line">			engine = <span class="keyword">new</span> ImageLoaderEngine(configuration);</div><div class="line">			<span class="keyword">this</span>.configuration = configuration;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			L.w(WARNING_RE_INIT_CONFIG);</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>注意这里,通过代码发现如果你要修改配置,直接二次调用init方法是无效的,应该先ImageLoader的destroy方法,然后再重新初始化</p>
<blockquote>
<p>Try to initialize ImageLoader which had already been initialized before. “ + “To re-init ImageLoader with new configuration call &gt;ImageLoader.destroy() at first.”;</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (configuration != <span class="keyword">null</span>) L.d(LOG_DESTROY);</div><div class="line">		stop();</div><div class="line">		configuration.diskCache.close();</div><div class="line">		engine = <span class="keyword">null</span>;</div><div class="line">		configuration = <span class="keyword">null</span>;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>可以看到这里在destroy的时候把config对象置空了.</p>
<h5 id="核心displayImage方法"><a href="#核心displayImage方法" class="headerlink" title="核心displayImage方法"></a>核心displayImage方法</h5><p>上面的init方法初始化了一个 <em>ImageLoaderEngine</em> 对象,并把config对象传入了,这里暂时先不讲该对象的实现,先从外部是如何调用ImageLoader显示图片的方法来看起,用的最多的就是 <em>displayImage</em> 这个对象.我们常用到的方法是这个:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">displayImage</span><span class="params">(String uri, ImageView imageView, DisplayImageOptions options)</span> </span>&#123;</div><div class="line">		displayImage(uri, <span class="keyword">new</span> ImageViewAware(imageView), options, <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>等一系列的重载方法,最终,这些方法会进入下面的这个 <em>displayImage</em> 方法中.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">displayImage</span><span class="params">(String uri, ImageAware imageAware, DisplayImageOptions options,</span></span></div><div class="line">			ImageSize targetSize, ImageLoadingListener listener, ImageLoadingProgressListener progressListener) &#123;</div><div class="line">		checkConfiguration();</div><div class="line">		<span class="keyword">if</span> (imageAware == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(ERROR_WRONG_ARGUMENTS);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (listener == <span class="keyword">null</span>) &#123;</div><div class="line">			listener = defaultListener;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (options == <span class="keyword">null</span>) &#123;</div><div class="line">			options = configuration.defaultDisplayImageOptions;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (TextUtils.isEmpty(uri)) &#123;</div><div class="line">			engine.cancelDisplayTaskFor(imageAware);</div><div class="line">			listener.onLoadingStarted(uri, imageAware.getWrappedView());</div><div class="line">			<span class="keyword">if</span> (options.shouldShowImageForEmptyUri()) &#123;</div><div class="line">				imageAware.setImageDrawable(options.getImageForEmptyUri(configuration.resources));</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				imageAware.setImageDrawable(<span class="keyword">null</span>);</div><div class="line">			&#125;</div><div class="line">			listener.onLoadingComplete(uri, imageAware.getWrappedView(), <span class="keyword">null</span>);</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (targetSize == <span class="keyword">null</span>) &#123;</div><div class="line">			targetSize = ImageSizeUtils.defineTargetSizeForView(imageAware, configuration.getMaxImageSize());</div><div class="line">		&#125;</div><div class="line">		String memoryCacheKey = MemoryCacheUtils.generateKey(uri, targetSize);</div><div class="line">		engine.prepareDisplayTaskFor(imageAware, memoryCacheKey);</div><div class="line"></div><div class="line">		listener.onLoadingStarted(uri, imageAware.getWrappedView());</div><div class="line"></div><div class="line">		Bitmap bmp = configuration.memoryCache.get(memoryCacheKey);</div><div class="line">		<span class="keyword">if</span> (bmp != <span class="keyword">null</span> &amp;&amp; !bmp.isRecycled()) &#123;</div><div class="line">			L.d(LOG_LOAD_IMAGE_FROM_MEMORY_CACHE, memoryCacheKey);</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (options.shouldPostProcess()) &#123;</div><div class="line">				ImageLoadingInfo imageLoadingInfo = <span class="keyword">new</span> ImageLoadingInfo(uri, imageAware, targetSize, memoryCacheKey,</div><div class="line">						options, listener, progressListener, engine.getLockForUri(uri));</div><div class="line">				ProcessAndDisplayImageTask displayTask = <span class="keyword">new</span> ProcessAndDisplayImageTask(engine, bmp, imageLoadingInfo,</div><div class="line">						defineHandler(options));</div><div class="line">				<span class="keyword">if</span> (options.isSyncLoading()) &#123;</div><div class="line">					displayTask.run();</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					engine.submit(displayTask);</div><div class="line">				&#125;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				options.getDisplayer().display(bmp, imageAware, LoadedFrom.MEMORY_CACHE);</div><div class="line">				listener.onLoadingComplete(uri, imageAware.getWrappedView(), bmp);</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">if</span> (options.shouldShowImageOnLoading()) &#123;</div><div class="line">				imageAware.setImageDrawable(options.getImageOnLoading(configuration.resources));</div><div class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (options.isResetViewBeforeLoading()) &#123;</div><div class="line">				imageAware.setImageDrawable(<span class="keyword">null</span>);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			ImageLoadingInfo imageLoadingInfo = <span class="keyword">new</span> ImageLoadingInfo(uri, imageAware, targetSize, memoryCacheKey,</div><div class="line">					options, listener, progressListener, engine.getLockForUri(uri));</div><div class="line">			LoadAndDisplayImageTask displayTask = <span class="keyword">new</span> LoadAndDisplayImageTask(engine, imageLoadingInfo,</div><div class="line">					defineHandler(options));</div><div class="line">			<span class="keyword">if</span> (options.isSyncLoading()) &#123;</div><div class="line">				displayTask.run();</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				engine.submit(displayTask);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>这个方法是ImageLoader的核心方法,所有的显示图片的逻辑都是在这里完成,包括我们上面提到的3级缓存的调用,都是在这里完成初始化然后交给 <em>ImageLoaderEngine</em> 来控制完成的.<br>我们把这个方法分为3个部分:参数检查和加载前listener回调准备,从内存中获取到了想要的Bitmap对象和最后没有从内存中获取到Bitmap的逻辑.</p>
<p>先看第一部分,参数检查和加载前listener回调准备<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">  checkConfiguration();</div><div class="line"><span class="keyword">if</span> (imageAware == <span class="keyword">null</span>) &#123;</div><div class="line">	<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(ERROR_WRONG_ARGUMENTS);</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span> (listener == <span class="keyword">null</span>) &#123;</div><div class="line">	listener = defaultListener;</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span> (options == <span class="keyword">null</span>) &#123;</div><div class="line">	options = configuration.defaultDisplayImageOptions;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (TextUtils.isEmpty(uri)) &#123;</div><div class="line">	engine.cancelDisplayTaskFor(imageAware);</div><div class="line">	listener.onLoadingStarted(uri, imageAware.getWrappedView());</div><div class="line">	<span class="keyword">if</span> (options.shouldShowImageForEmptyUri()) &#123;</div><div class="line">		imageAware.setImageDrawable(options.getImageForEmptyUri(configuration.resources));</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		imageAware.setImageDrawable(<span class="keyword">null</span>);</div><div class="line">	&#125;</div><div class="line">	listener.onLoadingComplete(uri, imageAware.getWrappedView(), <span class="keyword">null</span>);</div><div class="line">	<span class="keyword">return</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (targetSize == <span class="keyword">null</span>) &#123;</div><div class="line">	targetSize = ImageSizeUtils.defineTargetSizeForView(imageAware, configuration.getMaxImageSize());</div><div class="line">&#125;</div><div class="line">String memoryCacheKey = MemoryCacheUtils.generateKey(uri, targetSize);</div><div class="line">engine.prepareDisplayTaskFor(imageAware, memoryCacheKey);</div><div class="line"></div><div class="line">listener.onLoadingStarted(uri, imageAware.getWrappedView());</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkConfiguration</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (configuration == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(ERROR_NOT_INIT);</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>检查配置对象是否加载成功,如果没有的throw一个异常出去.<br>这里的 <em>imageAware</em> 对象实际上是对加载图片的view的一个包装,下面来看ImageAware的实现</p>
<h5 id="ImageAware对象"><a href="#ImageAware对象" class="headerlink" title="ImageAware对象"></a>ImageAware对象</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ImageAware</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">int</span> <span class="title">getWidth</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">	<span class="function">ViewScaleType <span class="title">getScaleType</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">	<span class="function">View <span class="title">getWrappedView</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">isCollected</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">setImageDrawable</span><span class="params">(Drawable drawable)</span></span>;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">setImageBitmap</span><span class="params">(Bitmap bitmap)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过代码我们发现 <em>ImageAware</em> 居然是一个接口,为什么要这样做呢,是因为不仅仅是ImageView可以加载图片,其他的view也是可以的,所以这里做了一层封装,只要是实现了ImageAware接口的view或者对象都是可以完成加载图片的操作的.</p>
<p>通过ImageAware所在的目录我们找到了下面的 <em>ImageViewAware</em> 对象,这个对象就是我们最常用的ImageView的包装对象了,来看它的实现.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewAware</span> <span class="keyword">implements</span> <span class="title">ImageAware</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String WARN_CANT_SET_DRAWABLE = <span class="string">"Can't set a drawable into view. You should call ImageLoader on UI thread for it."</span>;</div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String WARN_CANT_SET_BITMAP = <span class="string">"Can't set a bitmap into view. You should call ImageLoader on UI thread for it."</span>;</div><div class="line"></div><div class="line">	<span class="keyword">protected</span> Reference&lt;View&gt; viewRef;</div><div class="line">	<span class="keyword">protected</span> <span class="keyword">boolean</span> checkActualViewSize;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ViewAware</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>(view, <span class="keyword">true</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ViewAware</span><span class="params">(View view, <span class="keyword">boolean</span> checkActualViewSize)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (view == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"view must not be null"</span>);</div><div class="line"></div><div class="line">		<span class="keyword">this</span>.viewRef = <span class="keyword">new</span> WeakReference&lt;View&gt;(view);</div><div class="line">		<span class="keyword">this</span>.checkActualViewSize = checkActualViewSize;</div><div class="line">	&#125;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getWidth</span><span class="params">()</span> </span>&#123;</div><div class="line">		View view = viewRef.get();</div><div class="line">		<span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">final</span> ViewGroup.LayoutParams params = view.getLayoutParams();</div><div class="line">			<span class="keyword">int</span> width = <span class="number">0</span>;</div><div class="line">			<span class="keyword">if</span> (checkActualViewSize &amp;&amp; params != <span class="keyword">null</span> &amp;&amp; params.width != ViewGroup.LayoutParams.WRAP_CONTENT) &#123;</div><div class="line">				width = view.getWidth(); <span class="comment">// Get actual image width</span></div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (width &lt;= <span class="number">0</span> &amp;&amp; params != <span class="keyword">null</span>) width = params.width; <span class="comment">// Get layout width parameter</span></div><div class="line">			<span class="keyword">return</span> width;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getHeight</span><span class="params">()</span> </span>&#123;</div><div class="line">		View view = viewRef.get();</div><div class="line">		<span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">final</span> ViewGroup.LayoutParams params = view.getLayoutParams();</div><div class="line">			<span class="keyword">int</span> height = <span class="number">0</span>;</div><div class="line">			<span class="keyword">if</span> (checkActualViewSize &amp;&amp; params != <span class="keyword">null</span> &amp;&amp; params.height != ViewGroup.LayoutParams.WRAP_CONTENT) &#123;</div><div class="line">				height = view.getHeight(); <span class="comment">// Get actual image height</span></div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (height &lt;= <span class="number">0</span> &amp;&amp; params != <span class="keyword">null</span>) height = params.height; <span class="comment">// Get layout height parameter</span></div><div class="line">			<span class="keyword">return</span> height;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> ViewScaleType <span class="title">getScaleType</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> ViewScaleType.CROP;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> View <span class="title">getWrappedView</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> viewRef.get();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isCollected</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> viewRef.get() == <span class="keyword">null</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;</div><div class="line">		View view = viewRef.get();</div><div class="line">		<span class="keyword">return</span> view == <span class="keyword">null</span> ? <span class="keyword">super</span>.hashCode() : view.hashCode();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">setImageDrawable</span><span class="params">(Drawable drawable)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (Looper.myLooper() == Looper.getMainLooper()) &#123;</div><div class="line">			View view = viewRef.get();</div><div class="line">			<span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</div><div class="line">				setImageDrawableInto(drawable, view);</div><div class="line">				<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			L.w(WARN_CANT_SET_DRAWABLE);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">setImageBitmap</span><span class="params">(Bitmap bitmap)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (Looper.myLooper() == Looper.getMainLooper()) &#123;</div><div class="line">			View view = viewRef.get();</div><div class="line">			<span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</div><div class="line">				setImageBitmapInto(bitmap, view);</div><div class="line">				<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			L.w(WARN_CANT_SET_BITMAP);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Should set drawable into incoming view. Incoming view is guaranteed not null.&lt;br /&gt;</div><div class="line">	 * This method is called on UI thread.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">setImageDrawableInto</span><span class="params">(Drawable drawable, View view)</span></span>;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Should set Bitmap into incoming view. Incoming view is guaranteed not null.&lt; br /&gt;</div><div class="line">	 * This method is called on UI thread.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">setImageBitmapInto</span><span class="params">(Bitmap bitmap, View view)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>为什么要对View做包装呢,这里有下面几个作用:</p>
<p>首先是要显示的图片View可能在加载的过程中被回收了或者移除了,这个时候再往下加载就没有意义了,所以这里我们看到通过弱引用来把view对象包装起来了.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ViewAware</span><span class="params">(View view, <span class="keyword">boolean</span> checkActualViewSize)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (view == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"view must not be null"</span>);</div><div class="line"></div><div class="line">		<span class="keyword">this</span>.viewRef = <span class="keyword">new</span> WeakReference&lt;View&gt;(view);</div><div class="line">		<span class="keyword">this</span>.checkActualViewSize = checkActualViewSize;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>还有一个作用就是给view对象附一个唯一的ID,为什么要这么做,这里也要两个原因:一个是为了防止一个view重复的去请求图片,如果一个view在重复的请求图片的时候,ImageLoader会取消掉旧的请求并重新开始新的加载逻辑;二是为了解决异步加载图片错位的问题,我们都知道在android中的listView或者gridView是推荐使用缓存机制的,也就是说只是生成当前屏幕那么多的view对象,然后再滚动的时候来重复利用已经有的对象来节约内存,这就导致一个问题,比如刚开始去异步加载的view在图片加载回来的时候可能已经不是刚开始的那个view了,如果这个时候把图片附上就会产生图片不对应的问题.而这个ID的作用就在这里,通过比较刚开始和后来图片回来的view的唯一ID,如果一致的话就加载图片,不一致就什么都不做,这样就可以解决图片错位的问题了.<br>下面是具体的ImageView的包装对象的实现:</p>
<p>另外一个作用是判断当前是否是在主线程中,如果在主线程中就可以顺利的加载图片,否者不予执行.防止在子线程中更新UI报错.</p>
<p>最后的一个作用就是可以提前获取到view的宽度和高度,这样可以在加载图片的时候根据view的宽高来对图片进行缩放来节约内存空间.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageViewAware</span> <span class="keyword">extends</span> <span class="title">ViewAware</span> </span>&#123;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ImageViewAware</span><span class="params">(ImageView imageView)</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>(imageView);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ImageViewAware</span><span class="params">(ImageView imageView, <span class="keyword">boolean</span> checkActualViewSize)</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>(imageView, checkActualViewSize);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getWidth</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> width = <span class="keyword">super</span>.getWidth();</div><div class="line">		<span class="keyword">if</span> (width &lt;= <span class="number">0</span>) &#123;</div><div class="line">			ImageView imageView = (ImageView) viewRef.get();</div><div class="line">			<span class="keyword">if</span> (imageView != <span class="keyword">null</span>) &#123;</div><div class="line">				width = getImageViewFieldValue(imageView, <span class="string">"mMaxWidth"</span>); <span class="comment">// Check maxWidth parameter</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> width;</div><div class="line">	&#125;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getHeight</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> height = <span class="keyword">super</span>.getHeight();</div><div class="line">		<span class="keyword">if</span> (height &lt;= <span class="number">0</span>) &#123;</div><div class="line">			ImageView imageView = (ImageView) viewRef.get();</div><div class="line">			<span class="keyword">if</span> (imageView != <span class="keyword">null</span>) &#123;</div><div class="line">				height = getImageViewFieldValue(imageView, <span class="string">"mMaxHeight"</span>); <span class="comment">// Check maxHeight parameter</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> height;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> ViewScaleType <span class="title">getScaleType</span><span class="params">()</span> </span>&#123;</div><div class="line">		ImageView imageView = (ImageView) viewRef.get();</div><div class="line">		<span class="keyword">if</span> (imageView != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">return</span> ViewScaleType.fromImageView(imageView);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">super</span>.getScaleType();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> ImageView <span class="title">getWrappedView</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> (ImageView) <span class="keyword">super</span>.getWrappedView();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setImageDrawableInto</span><span class="params">(Drawable drawable, View view)</span> </span>&#123;</div><div class="line">		((ImageView) view).setImageDrawable(drawable);</div><div class="line">		<span class="keyword">if</span> (drawable <span class="keyword">instanceof</span> AnimationDrawable) &#123;</div><div class="line">			((AnimationDrawable)drawable).start();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setImageBitmapInto</span><span class="params">(Bitmap bitmap, View view)</span> </span>&#123;</div><div class="line">		((ImageView) view).setImageBitmap(bitmap);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getImageViewFieldValue</span><span class="params">(Object object, String fieldName)</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> value = <span class="number">0</span>;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			Field field = ImageView.class.getDeclaredField(fieldName);</div><div class="line">			field.setAccessible(<span class="keyword">true</span>);</div><div class="line">			<span class="keyword">int</span> fieldValue = (Integer) field.get(object);</div><div class="line">			<span class="keyword">if</span> (fieldValue &gt; <span class="number">0</span> &amp;&amp; fieldValue &lt; Integer.MAX_VALUE) &#123;</div><div class="line">				value = fieldValue;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">			L.e(e);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> value;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ImageViewAware就是ImageView的包装对象了,它可以获取到imageView的宽高和缩放类型,然后调用原声api来完成图片的加载到ImageView的操作.</p>
<h5 id="ImageSize对象"><a href="#ImageSize对象" class="headerlink" title="ImageSize对象"></a>ImageSize对象</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageSize</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TO_STRING_MAX_LENGHT = <span class="number">9</span>; <span class="comment">// "9999x9999".length()</span></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SEPARATOR = <span class="string">"x"</span>;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> width;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> height;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ImageSize</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.width = width;</div><div class="line">		<span class="keyword">this</span>.height = height;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ImageSize</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height, <span class="keyword">int</span> rotation)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (rotation % <span class="number">180</span> == <span class="number">0</span>) &#123;</div><div class="line">			<span class="keyword">this</span>.width = width;</div><div class="line">			<span class="keyword">this</span>.height = height;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">this</span>.width = height;</div><div class="line">			<span class="keyword">this</span>.height = width;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getWidth</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> width;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getHeight</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> height;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** Scales down dimensions in &lt;b&gt;sampleSize&lt;/b&gt; times. Returns new object. */</span></div><div class="line">	<span class="function"><span class="keyword">public</span> ImageSize <span class="title">scaleDown</span><span class="params">(<span class="keyword">int</span> sampleSize)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ImageSize(width / sampleSize, height / sampleSize);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** Scales dimensions according to incoming scale. Returns new object. */</span></div><div class="line">	<span class="function"><span class="keyword">public</span> ImageSize <span class="title">scale</span><span class="params">(<span class="keyword">float</span> scale)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ImageSize((<span class="keyword">int</span>) (width * scale), (<span class="keyword">int</span>) (height * scale));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> StringBuilder(TO_STRING_MAX_LENGHT).append(width).append(SEPARATOR).append(height).toString();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里的 <em>ImageSize</em> 对象是存储图片的宽高旋转信息的载体对象,为了方便后期对图片做处理的时候使用.这里如果取不到具体的宽高的时候使用config对象中配置的默认宽高:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ImageSize <span class="title">defineTargetSizeForView</span><span class="params">(ImageAware imageAware, ImageSize maxImageSize)</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> width = imageAware.getWidth();</div><div class="line">		<span class="keyword">if</span> (width &lt;= <span class="number">0</span>) width = maxImageSize.getWidth();</div><div class="line"></div><div class="line">		<span class="keyword">int</span> height = imageAware.getHeight();</div><div class="line">		<span class="keyword">if</span> (height &lt;= <span class="number">0</span>) height = maxImageSize.getHeight();</div><div class="line"></div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ImageSize(width, height);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>对url图片为空的处理可能会造成默认图片的显示和正常图片的显示不一样,因为url为空的时候没有走图片处理的流程,比如都要圆角图片,但是没有url的时候是无法实现的,因为没有Bitmap对象可以给它处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (TextUtils.isEmpty(uri)) &#123;</div><div class="line">			engine.cancelDisplayTaskFor(imageAware);</div><div class="line">			listener.onLoadingStarted(uri, imageAware.getWrappedView());</div><div class="line">			<span class="keyword">if</span> (options.shouldShowImageForEmptyUri()) &#123;</div><div class="line">				imageAware.setImageDrawable(options.getImageForEmptyUri(configuration.resources));</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				imageAware.setImageDrawable(<span class="keyword">null</span>);</div><div class="line">			&#125;</div><div class="line">			listener.onLoadingComplete(uri, imageAware.getWrappedView(), <span class="keyword">null</span>);</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div></pre></td></tr></table></figure>
<p>最后关于内存缓存的key值得生成:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">String memoryCacheKey = MemoryCacheUtils.generateKey(uri, targetSize);</div><div class="line">engine.prepareDisplayTaskFor(imageAware, memoryCacheKey);</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">generateKey</span><span class="params">(String imageUri, ImageSize targetSize)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> StringBuilder(imageUri).append(URI_AND_SIZE_SEPARATOR).append(targetSize.getWidth()).append(WIDTH_AND_HEIGHT_SEPARATOR).append(targetSize.getHeight()).toString();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里采用的是URL+”_“ + size信息的方式来作为缓存key的.</p>
<p>到这里, <em>displayImage</em> 的第一部分就完成了.下面进入那个来看剩下的两部分,也就是从内存中找到和没找到图片对象的处理.<br>先看如果在内存中找到了想要的图片对象的处理:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">Bitmap bmp = configuration.memoryCache.get(memoryCacheKey);</div><div class="line"><span class="keyword">if</span> (bmp != <span class="keyword">null</span> &amp;&amp; !bmp.isRecycled()) &#123;</div><div class="line">			L.d(LOG_LOAD_IMAGE_FROM_MEMORY_CACHE, memoryCacheKey);</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (options.shouldPostProcess()) &#123;</div><div class="line">				ImageLoadingInfo imageLoadingInfo = <span class="keyword">new</span> ImageLoadingInfo(uri, imageAware, targetSize, memoryCacheKey,</div><div class="line">						options, listener, progressListener, engine.getLockForUri(uri));</div><div class="line">				ProcessAndDisplayImageTask displayTask = <span class="keyword">new</span> ProcessAndDisplayImageTask(engine, bmp, imageLoadingInfo,</div><div class="line">						defineHandler(options));</div><div class="line">				<span class="keyword">if</span> (options.isSyncLoading()) &#123;</div><div class="line">					displayTask.run();</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					engine.submit(displayTask);</div><div class="line">				&#125;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				options.getDisplayer().display(bmp, imageAware, LoadedFrom.MEMORY_CACHE);</div><div class="line">				listener.onLoadingComplete(uri, imageAware.getWrappedView(), bmp);</div><div class="line">			&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>首先生成一个 <em>ImageLoadingInfo对象</em> 来保存图片加载过程中需要的信息,看下面的代码基本上所有的对象都包含了:</p>
<h5 id="ImageLoadingInfo对象"><a href="#ImageLoadingInfo对象" class="headerlink" title="ImageLoadingInfo对象"></a>ImageLoadingInfo对象</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageLoadingInfo</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> String uri;</div><div class="line">	<span class="keyword">final</span> String memoryCacheKey;</div><div class="line">	<span class="keyword">final</span> ImageAware imageAware;</div><div class="line">	<span class="keyword">final</span> ImageSize targetSize;</div><div class="line">	<span class="keyword">final</span> DisplayImageOptions options;</div><div class="line">	<span class="keyword">final</span> ImageLoadingListener listener;</div><div class="line">	<span class="keyword">final</span> ImageLoadingProgressListener progressListener;</div><div class="line">	<span class="keyword">final</span> ReentrantLock loadFromUriLock;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ImageLoadingInfo</span><span class="params">(String uri, ImageAware imageAware, ImageSize targetSize, String memoryCacheKey,</span></span></div><div class="line">			DisplayImageOptions options, ImageLoadingListener listener,</div><div class="line">			ImageLoadingProgressListener progressListener, ReentrantLock loadFromUriLock) &#123;</div><div class="line">		<span class="keyword">this</span>.uri = uri;</div><div class="line">		<span class="keyword">this</span>.imageAware = imageAware;</div><div class="line">		<span class="keyword">this</span>.targetSize = targetSize;</div><div class="line">		<span class="keyword">this</span>.options = options;</div><div class="line">		<span class="keyword">this</span>.listener = listener;</div><div class="line">		<span class="keyword">this</span>.progressListener = progressListener;</div><div class="line">		<span class="keyword">this</span>.loadFromUriLock = loadFromUriLock;</div><div class="line">		<span class="keyword">this</span>.memoryCacheKey = memoryCacheKey;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到如果需要对图片对象做处理的时候就把创建的 <em>ProcessAndDisplayImageTask</em> 这个对象交给 <em>ImageLoaderEngine</em> 来完成,如果是 <em>isSyncLoading</em> 的话就直接运行 <em>ProcessAndDisplayImageTask</em> 对象(实际上就是一个线程).<br>如果不需要处理,就直接显示交给BitmapDisplayer来显示图片:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BitmapDisplayer</span> </span>&#123;</div><div class="line">  <span class="comment">//This method is called on UI thread so it's strongly recommended not to do any heavy work in it.</span></div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">display</span><span class="params">(Bitmap bitmap, ImageAware imageAware, LoadedFrom loadedFrom)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>默认使用的这个:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleBitmapDisplayer</span> <span class="keyword">implements</span> <span class="title">BitmapDisplayer</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">display</span><span class="params">(Bitmap bitmap, ImageAware imageAware, LoadedFrom loadedFrom)</span> </span>&#123;</div><div class="line">		imageAware.setImageBitmap(bitmap);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>到这里,成功从内存中加载图片的逻辑就完成了,下面在看如果从内存中没有找到对应的图片对象的处理:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">if</span> (options.shouldShowImageOnLoading()) &#123;</div><div class="line">				imageAware.setImageDrawable(options.getImageOnLoading(configuration.resources));</div><div class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (options.isResetViewBeforeLoading()) &#123;</div><div class="line">				imageAware.setImageDrawable(<span class="keyword">null</span>);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			ImageLoadingInfo imageLoadingInfo = <span class="keyword">new</span> ImageLoadingInfo(uri, imageAware, targetSize, memoryCacheKey,</div><div class="line">					options, listener, progressListener, engine.getLockForUri(uri));</div><div class="line">			LoadAndDisplayImageTask displayTask = <span class="keyword">new</span> LoadAndDisplayImageTask(engine, imageLoadingInfo,</div><div class="line">					defineHandler(options));</div><div class="line">			<span class="keyword">if</span> (options.isSyncLoading()) &#123;</div><div class="line">				displayTask.run();</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				engine.submit(displayTask);</div><div class="line">			&#125;</div><div class="line">		&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到这里也是很清晰的,直接创建一个 <em>LoadAndDisplayImageTask</em> 对象交给engin来处理.如果是 <em>isSyncLoading</em> 的话就直接运行 <em>LoadAndDisplayImageTask</em> ,这个对象实际上也是要给线程对象,这个后面我们会讲到.</p>
<p>到这里displayImage的实现就讲完了,可以看到非常的简单,下面开始 <em>ImageLoderEngine</em> 的任务调度处理逻辑.</p>
<h4 id="ImageLoaderEngine"><a href="#ImageLoaderEngine" class="headerlink" title="ImageLoaderEngine"></a>ImageLoaderEngine</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImageLoaderEngine</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> ImageLoaderConfiguration configuration;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> Executor taskExecutor;</div><div class="line">	<span class="keyword">private</span> Executor taskExecutorForCachedImages;</div><div class="line">	<span class="keyword">private</span> Executor taskDistributor;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Integer, String&gt; cacheKeysForImageAwares = Collections</div><div class="line">			.synchronizedMap(<span class="keyword">new</span> HashMap&lt;Integer, String&gt;());</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, ReentrantLock&gt; uriLocks = <span class="keyword">new</span> WeakHashMap&lt;String, ReentrantLock&gt;();</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> AtomicBoolean paused = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> AtomicBoolean networkDenied = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> AtomicBoolean slowNetwork = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Object pauseLock = <span class="keyword">new</span> Object();</div><div class="line"></div><div class="line">	ImageLoaderEngine(ImageLoaderConfiguration configuration) &#123;</div><div class="line">		<span class="keyword">this</span>.configuration = configuration;</div><div class="line"></div><div class="line">		taskExecutor = configuration.taskExecutor;</div><div class="line">		taskExecutorForCachedImages = configuration.taskExecutorForCachedImages;</div><div class="line"></div><div class="line">		taskDistributor = DefaultConfigurationFactory.createTaskDistributor();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** Submits task to execution pool */</span></div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">submit</span><span class="params">(<span class="keyword">final</span> LoadAndDisplayImageTask task)</span> </span>&#123;</div><div class="line">		taskDistributor.execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">				File image = configuration.diskCache.get(task.getLoadingUri());</div><div class="line">				<span class="keyword">boolean</span> isImageCachedOnDisk = image != <span class="keyword">null</span> &amp;&amp; image.exists();</div><div class="line">				initExecutorsIfNeed();</div><div class="line">				<span class="keyword">if</span> (isImageCachedOnDisk) &#123;</div><div class="line">					taskExecutorForCachedImages.execute(task);</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					taskExecutor.execute(task);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** Submits task to execution pool */</span></div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">submit</span><span class="params">(ProcessAndDisplayImageTask task)</span> </span>&#123;</div><div class="line">		initExecutorsIfNeed();</div><div class="line">		taskExecutorForCachedImages.execute(task);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initExecutorsIfNeed</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (!configuration.customExecutor &amp;&amp; ((ExecutorService) taskExecutor).isShutdown()) &#123;</div><div class="line">			taskExecutor = createTaskExecutor();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (!configuration.customExecutorForCachedImages &amp;&amp; ((ExecutorService) taskExecutorForCachedImages)</div><div class="line">				.isShutdown()) &#123;</div><div class="line">			taskExecutorForCachedImages = createTaskExecutor();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> Executor <span class="title">createTaskExecutor</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> DefaultConfigurationFactory</div><div class="line">				.createExecutor(configuration.threadPoolSize, configuration.threadPriority,</div><div class="line">				configuration.tasksProcessingType);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Returns URI of image which is loading at this moment into passed &#123;<span class="doctag">@link</span> com.nostra13.universalimageloader.core.imageaware.ImageAware&#125;</div><div class="line">	 */</div><div class="line">	<span class="function">String <span class="title">getLoadingUriForView</span><span class="params">(ImageAware imageAware)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> cacheKeysForImageAwares.get(imageAware.getId());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Associates &lt;b&gt;memoryCacheKey&lt;/b&gt; with &lt;b&gt;imageAware&lt;/b&gt;. Then it helps to define image URI is loaded into View at</div><div class="line">	 * exact moment.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">prepareDisplayTaskFor</span><span class="params">(ImageAware imageAware, String memoryCacheKey)</span> </span>&#123;</div><div class="line">		cacheKeysForImageAwares.put(imageAware.getId(), memoryCacheKey);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Cancels the task of loading and displaying image for incoming &lt;b&gt;imageAware&lt;/b&gt;.</div><div class="line">	 *</div><div class="line">	 * <span class="doctag">@param</span> imageAware &#123;<span class="doctag">@link</span> com.nostra13.universalimageloader.core.imageaware.ImageAware&#125; for which display task</div><div class="line">	 *                   will be cancelled</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">cancelDisplayTaskFor</span><span class="params">(ImageAware imageAware)</span> </span>&#123;</div><div class="line">		cacheKeysForImageAwares.remove(imageAware.getId());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Denies or allows engine to download images from the network.&lt;br /&gt; &lt;br /&gt; If downloads are denied and if image</div><div class="line">	 * isn't cached then &#123;<span class="doctag">@link</span> ImageLoadingListener#onLoadingFailed(String, View, FailReason)&#125; callback will be fired</div><div class="line">	 * with &#123;<span class="doctag">@link</span> FailReason.FailType#NETWORK_DENIED&#125;</div><div class="line">	 *</div><div class="line">	 * <span class="doctag">@param</span> denyNetworkDownloads pass &lt;b&gt;true&lt;/b&gt; - to deny engine to download images from the network; &lt;b&gt;false&lt;/b&gt; -</div><div class="line">	 *                             to allow engine to download images from network.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">denyNetworkDownloads</span><span class="params">(<span class="keyword">boolean</span> denyNetworkDownloads)</span> </span>&#123;</div><div class="line">		networkDenied.set(denyNetworkDownloads);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Sets option whether ImageLoader will use &#123;<span class="doctag">@link</span> FlushedInputStream&#125; for network downloads to handle &lt;a</div><div class="line">	 * href="http://code.google.com/p/android/issues/detail?id=6066"&gt;this known problem&lt;/a&gt; or not.</div><div class="line">	 *</div><div class="line">	 * <span class="doctag">@param</span> handleSlowNetwork pass &lt;b&gt;true&lt;/b&gt; - to use &#123;<span class="doctag">@link</span> FlushedInputStream&#125; for network downloads; &lt;b&gt;false&lt;/b&gt;</div><div class="line">	 *                          - otherwise.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">handleSlowNetwork</span><span class="params">(<span class="keyword">boolean</span> handleSlowNetwork)</span> </span>&#123;</div><div class="line">		slowNetwork.set(handleSlowNetwork);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Pauses engine. All new "load&amp;display" tasks won't be executed until ImageLoader is &#123;<span class="doctag">@link</span> #resume() resumed&#125;.&lt;br</div><div class="line">	 * /&gt; Already running tasks are not paused.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">pause</span><span class="params">()</span> </span>&#123;</div><div class="line">		paused.set(<span class="keyword">true</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** Resumes engine work. Paused "load&amp;display" tasks will continue its work. */</span></div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">resume</span><span class="params">()</span> </span>&#123;</div><div class="line">		paused.set(<span class="keyword">false</span>);</div><div class="line">		<span class="keyword">synchronized</span> (pauseLock) &#123;</div><div class="line">			pauseLock.notifyAll();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Stops engine, cancels all running and scheduled display image tasks. Clears internal data.</div><div class="line">	 * &lt;br /&gt;</div><div class="line">	 * &lt;b&gt;<span class="doctag">NOTE:</span>&lt;/b&gt; This method doesn't shutdown</div><div class="line">	 * &#123;<span class="doctag">@linkplain</span> com.nostra13.universalimageloader.core.ImageLoaderConfiguration.Builder#taskExecutor(java.util.concurrent.Executor)</div><div class="line">	 * custom task executors&#125; if you set them.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (!configuration.customExecutor) &#123;</div><div class="line">			((ExecutorService) taskExecutor).shutdownNow();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (!configuration.customExecutorForCachedImages) &#123;</div><div class="line">			((ExecutorService) taskExecutorForCachedImages).shutdownNow();</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		cacheKeysForImageAwares.clear();</div><div class="line">		uriLocks.clear();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">fireCallback</span><span class="params">(Runnable r)</span> </span>&#123;</div><div class="line">		taskDistributor.execute(r);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function">ReentrantLock <span class="title">getLockForUri</span><span class="params">(String uri)</span> </span>&#123;</div><div class="line">		ReentrantLock lock = uriLocks.get(uri);</div><div class="line">		<span class="keyword">if</span> (lock == <span class="keyword">null</span>) &#123;</div><div class="line">			lock = <span class="keyword">new</span> ReentrantLock();</div><div class="line">			uriLocks.put(uri, lock);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> lock;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function">AtomicBoolean <span class="title">getPause</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> paused;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function">Object <span class="title">getPauseLock</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> pauseLock;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">isNetworkDenied</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> networkDenied.get();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">isSlowNetwork</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> slowNetwork.get();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到在 <em>ImageLoaderEngine</em> 对象中主要有3个线程池来做任务调度,核心的方法就是两个 <em>submit</em> 方法.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> Executor taskExecutor;</div><div class="line"><span class="keyword">private</span> Executor taskExecutorForCachedImages;</div><div class="line"><span class="keyword">private</span> Executor taskDistributor;</div></pre></td></tr></table></figure></p>
<p><em>taskDistributor</em> 用来统一管理所有的任务,根据任务类型把任务放入不同的线程池中,如果是内存中或者本地存储中加载图片的话交给 <em>taskExecutorForCachedImages</em> 否者就交给 <em>taskExecutor</em> 来处理.</p>
<p>两个submit方法用来把对应类型的task放入不同的线程池中来执行任务,非常的清晰.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** Submits task to execution pool */</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">submit</span><span class="params">(<span class="keyword">final</span> LoadAndDisplayImageTask task)</span> </span>&#123;</div><div class="line">  taskDistributor.execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">      File image = configuration.diskCache.get(task.getLoadingUri());</div><div class="line">      <span class="keyword">boolean</span> isImageCachedOnDisk = image != <span class="keyword">null</span> &amp;&amp; image.exists();</div><div class="line">      initExecutorsIfNeed();</div><div class="line">      <span class="keyword">if</span> (isImageCachedOnDisk) &#123;</div><div class="line">        taskExecutorForCachedImages.execute(task);</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        taskExecutor.execute(task);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/** Submits task to execution pool */</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">submit</span><span class="params">(ProcessAndDisplayImageTask task)</span> </span>&#123;</div><div class="line">  initExecutorsIfNeed();</div><div class="line">  taskExecutorForCachedImages.execute(task);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>关于Engine对象还有要注意的地方就是UIL对每个url提供了一个ReentrantLock锁,来解决对重复URL加载的线程同步问题.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function">ReentrantLock <span class="title">getLockForUri</span><span class="params">(String uri)</span> </span>&#123;</div><div class="line">		ReentrantLock lock = uriLocks.get(uri);</div><div class="line">		<span class="keyword">if</span> (lock == <span class="keyword">null</span>) &#123;</div><div class="line">			lock = <span class="keyword">new</span> ReentrantLock();</div><div class="line">			uriLocks.put(uri, lock);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> lock;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>这个锁在后面要讲到的两个Task中会用到,稍后我们再讲他们的具体实现.<br>Engine对象同时还提供了暂停,停止,开始等操作,通过线程安全的AtomicBoolean对象来控制任务调度状态,这里就不具体讲了,都是线程同步的简单实现.<br>下面开始讲两个具体的Task线程对象:</p>
<h4 id="ProcessAndDisplayImageTask"><a href="#ProcessAndDisplayImageTask" class="headerlink" title="ProcessAndDisplayImageTask"></a>ProcessAndDisplayImageTask</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ProcessAndDisplayImageTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOG_POSTPROCESS_IMAGE = <span class="string">"PostProcess image before displaying [%s]"</span>;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ImageLoaderEngine engine;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Bitmap bitmap;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ImageLoadingInfo imageLoadingInfo;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Handler handler;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ProcessAndDisplayImageTask</span><span class="params">(ImageLoaderEngine engine, Bitmap bitmap, ImageLoadingInfo imageLoadingInfo,</span></span></div><div class="line">			Handler handler) &#123;</div><div class="line">		<span class="keyword">this</span>.engine = engine;</div><div class="line">		<span class="keyword">this</span>.bitmap = bitmap;</div><div class="line">		<span class="keyword">this</span>.imageLoadingInfo = imageLoadingInfo;</div><div class="line">		<span class="keyword">this</span>.handler = handler;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">		L.d(LOG_POSTPROCESS_IMAGE, imageLoadingInfo.memoryCacheKey);</div><div class="line"></div><div class="line">		BitmapProcessor processor = imageLoadingInfo.options.getPostProcessor();</div><div class="line">		Bitmap processedBitmap = processor.process(bitmap);</div><div class="line">		DisplayBitmapTask displayBitmapTask = <span class="keyword">new</span> DisplayBitmapTask(processedBitmap, imageLoadingInfo, engine,</div><div class="line">				LoadedFrom.MEMORY_CACHE);</div><div class="line">		LoadAndDisplayImageTask.runTask(displayBitmapTask, imageLoadingInfo.options.isSyncLoading(), handler, engine);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到 <em>ProcessAndDisplayImageTask</em> 很简单,如果需要对图片做处理的话就交给 <em>BitmapProcessor</em> 把图片处理一下,然后把处理完的Bitmap对象封装成一个 <em>DisplayBitmapTask</em> 交给 <em>LoadAndDisplayImageTask</em> 的 <em>runTask</em> 方法来处理.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runTask</span><span class="params">(Runnable r, <span class="keyword">boolean</span> sync, Handler handler, ImageLoaderEngine engine)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (sync) &#123;</div><div class="line">			r.run();</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (handler == <span class="keyword">null</span>) &#123;</div><div class="line">			engine.fireCallback(r);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			handler.post(r);</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到通过具体的情况来完成回调处理.如果是同步的话直接运行该线程,如果handler为空的话交给总调度线程池 <em>taskDistributor</em> 来调用,否者通过handler来执行该线程.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DisplayBitmapTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOG_DISPLAY_IMAGE_IN_IMAGEAWARE = <span class="string">"Display image in ImageAware (loaded from %1$s) [%2$s]"</span>;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOG_TASK_CANCELLED_IMAGEAWARE_REUSED = <span class="string">"ImageAware is reused for another image. Task is cancelled. [%s]"</span>;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOG_TASK_CANCELLED_IMAGEAWARE_COLLECTED = <span class="string">"ImageAware was collected by GC. Task is cancelled. [%s]"</span>;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Bitmap bitmap;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String imageUri;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ImageAware imageAware;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String memoryCacheKey;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> BitmapDisplayer displayer;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ImageLoadingListener listener;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ImageLoaderEngine engine;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> LoadedFrom loadedFrom;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">DisplayBitmapTask</span><span class="params">(Bitmap bitmap, ImageLoadingInfo imageLoadingInfo, ImageLoaderEngine engine,</span></span></div><div class="line">			LoadedFrom loadedFrom) &#123;</div><div class="line">		<span class="keyword">this</span>.bitmap = bitmap;</div><div class="line">		imageUri = imageLoadingInfo.uri;</div><div class="line">		imageAware = imageLoadingInfo.imageAware;</div><div class="line">		memoryCacheKey = imageLoadingInfo.memoryCacheKey;</div><div class="line">		displayer = imageLoadingInfo.options.getDisplayer();</div><div class="line">		listener = imageLoadingInfo.listener;</div><div class="line">		<span class="keyword">this</span>.engine = engine;</div><div class="line">		<span class="keyword">this</span>.loadedFrom = loadedFrom;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (imageAware.isCollected()) &#123;</div><div class="line">			L.d(LOG_TASK_CANCELLED_IMAGEAWARE_COLLECTED, memoryCacheKey);</div><div class="line">			listener.onLoadingCancelled(imageUri, imageAware.getWrappedView());</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (isViewWasReused()) &#123;</div><div class="line">			L.d(LOG_TASK_CANCELLED_IMAGEAWARE_REUSED, memoryCacheKey);</div><div class="line">			listener.onLoadingCancelled(imageUri, imageAware.getWrappedView());</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			L.d(LOG_DISPLAY_IMAGE_IN_IMAGEAWARE, loadedFrom, memoryCacheKey);</div><div class="line">			displayer.display(bitmap, imageAware, loadedFrom);</div><div class="line">			engine.cancelDisplayTaskFor(imageAware);</div><div class="line">			listener.onLoadingComplete(imageUri, imageAware.getWrappedView(), bitmap);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** Checks whether memory cache key (image URI) for current ImageAware is actual */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isViewWasReused</span><span class="params">()</span> </span>&#123;</div><div class="line">		String currentCacheKey = engine.getLoadingUriForView(imageAware);</div><div class="line">		<span class="keyword">return</span> !memoryCacheKey.equals(currentCacheKey);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到 <em>DisplayBitmapTask</em> 的run方法的钱两个判断,正好对应前面讲到的关于view的回收或删除和重复利用view错位的问题的判断,如果两种情况对应上就任务本次任务被取消.否则直接通知 <em>displayer</em> 显示图片.这里不用担心是在子线程中更新UI,因为 <em>displayer</em> 内部的display方法是调用的 <em>ImageAware</em> 接口的实现类中 的setImageBitmap方法,在这个方法的具体实现中已经判断了是否是在主线程中了.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"> ViewAware对象的setImageView方法</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">setImageBitmap</span><span class="params">(Bitmap bitmap)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (Looper.myLooper() == Looper.getMainLooper()) &#123;</div><div class="line">		View view = viewRef.get();</div><div class="line">		<span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</div><div class="line">			setImageBitmapInto(bitmap, view);</div><div class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		L.w(WARN_CANT_SET_BITMAP);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="LoadAndDisplayImageTask"><a href="#LoadAndDisplayImageTask" class="headerlink" title="LoadAndDisplayImageTask"></a>LoadAndDisplayImageTask</h4><p>下面进入比较复杂的任务对象 <em>LoadAndDisplayImageTask</em> 中,改对象之所以复杂,主要是因为要判断硬盘中是否有需要的图片的对象,如果没有就去下载,然后保存图片,最后才把图片对象返回,代码较多,我们一步步的来分析</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LoadAndDisplayImageTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span>, <span class="title">IoUtils</span>.<span class="title">CopyListener</span> </span>&#123;</div><div class="line"></div><div class="line">  ....</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ImageLoaderEngine engine;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ImageLoadingInfo imageLoadingInfo;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Handler handler;</div><div class="line"></div><div class="line">	<span class="comment">// Helper references</span></div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ImageLoaderConfiguration configuration;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ImageDownloader downloader;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ImageDownloader networkDeniedDownloader;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ImageDownloader slowNetworkDownloader;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ImageDecoder decoder;</div><div class="line">	<span class="keyword">final</span> String uri;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String memoryCacheKey;</div><div class="line">	<span class="keyword">final</span> ImageAware imageAware;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ImageSize targetSize;</div><div class="line">	<span class="keyword">final</span> DisplayImageOptions options;</div><div class="line">	<span class="keyword">final</span> ImageLoadingListener listener;</div><div class="line">	<span class="keyword">final</span> ImageLoadingProgressListener progressListener;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> syncLoading;</div><div class="line"></div><div class="line">	<span class="comment">// State vars</span></div><div class="line">	<span class="keyword">private</span> LoadedFrom loadedFrom = LoadedFrom.NETWORK;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">LoadAndDisplayImageTask</span><span class="params">(ImageLoaderEngine engine, ImageLoadingInfo imageLoadingInfo, Handler handler)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.engine = engine;</div><div class="line">		<span class="keyword">this</span>.imageLoadingInfo = imageLoadingInfo;</div><div class="line">		<span class="keyword">this</span>.handler = handler;</div><div class="line"></div><div class="line">		configuration = engine.configuration;</div><div class="line">		downloader = configuration.downloader;</div><div class="line">		networkDeniedDownloader = configuration.networkDeniedDownloader;</div><div class="line">		slowNetworkDownloader = configuration.slowNetworkDownloader;</div><div class="line">		decoder = configuration.decoder;</div><div class="line">		uri = imageLoadingInfo.uri;</div><div class="line">		memoryCacheKey = imageLoadingInfo.memoryCacheKey;</div><div class="line">		imageAware = imageLoadingInfo.imageAware;</div><div class="line">		targetSize = imageLoadingInfo.targetSize;</div><div class="line">		options = imageLoadingInfo.options;</div><div class="line">		listener = imageLoadingInfo.listener;</div><div class="line">		progressListener = imageLoadingInfo.progressListener;</div><div class="line">		syncLoading = options.isSyncLoading();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (waitIfPaused()) <span class="keyword">return</span>;</div><div class="line">		<span class="keyword">if</span> (delayIfNeed()) <span class="keyword">return</span>;</div><div class="line"></div><div class="line">		ReentrantLock loadFromUriLock = imageLoadingInfo.loadFromUriLock;</div><div class="line">		L.d(LOG_START_DISPLAY_IMAGE_TASK, memoryCacheKey);</div><div class="line">		<span class="keyword">if</span> (loadFromUriLock.isLocked()) &#123;</div><div class="line">			L.d(LOG_WAITING_FOR_IMAGE_LOADED, memoryCacheKey);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		loadFromUriLock.lock();</div><div class="line">		Bitmap bmp;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			checkTaskNotActual();</div><div class="line"></div><div class="line">			bmp = configuration.memoryCache.get(memoryCacheKey);</div><div class="line">			<span class="keyword">if</span> (bmp == <span class="keyword">null</span> || bmp.isRecycled()) &#123;</div><div class="line">				bmp = tryLoadBitmap();</div><div class="line">				<span class="keyword">if</span> (bmp == <span class="keyword">null</span>) <span class="keyword">return</span>; <span class="comment">// listener callback already was fired</span></div><div class="line"></div><div class="line">				checkTaskNotActual();</div><div class="line">				checkTaskInterrupted();</div><div class="line"></div><div class="line">				<span class="keyword">if</span> (options.shouldPreProcess()) &#123;</div><div class="line">					L.d(LOG_PREPROCESS_IMAGE, memoryCacheKey);</div><div class="line">					bmp = options.getPreProcessor().process(bmp);</div><div class="line">					<span class="keyword">if</span> (bmp == <span class="keyword">null</span>) &#123;</div><div class="line">						L.e(ERROR_PRE_PROCESSOR_NULL, memoryCacheKey);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				<span class="keyword">if</span> (bmp != <span class="keyword">null</span> &amp;&amp; options.isCacheInMemory()) &#123;</div><div class="line">					L.d(LOG_CACHE_IMAGE_IN_MEMORY, memoryCacheKey);</div><div class="line">					configuration.memoryCache.put(memoryCacheKey, bmp);</div><div class="line">				&#125;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				loadedFrom = LoadedFrom.MEMORY_CACHE;</div><div class="line">				L.d(LOG_GET_IMAGE_FROM_MEMORY_CACHE_AFTER_WAITING, memoryCacheKey);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (bmp != <span class="keyword">null</span> &amp;&amp; options.shouldPostProcess()) &#123;</div><div class="line">				L.d(LOG_POSTPROCESS_IMAGE, memoryCacheKey);</div><div class="line">				bmp = options.getPostProcessor().process(bmp);</div><div class="line">				<span class="keyword">if</span> (bmp == <span class="keyword">null</span>) &#123;</div><div class="line">					L.e(ERROR_POST_PROCESSOR_NULL, memoryCacheKey);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			checkTaskNotActual();</div><div class="line">			checkTaskInterrupted();</div><div class="line">		&#125; <span class="keyword">catch</span> (TaskCancelledException e) &#123;</div><div class="line">			fireCancelEvent();</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125; <span class="keyword">finally</span> &#123;</div><div class="line">			loadFromUriLock.unlock();</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		DisplayBitmapTask displayBitmapTask = <span class="keyword">new</span> DisplayBitmapTask(bmp, imageLoadingInfo, engine, loadedFrom);</div><div class="line">		runTask(displayBitmapTask, syncLoading, handler, engine);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** <span class="doctag">@return</span> &lt;b&gt;true&lt;/b&gt; - if task should be interrupted; &lt;b&gt;false&lt;/b&gt; - otherwise */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">waitIfPaused</span><span class="params">()</span> </span>&#123;</div><div class="line">		AtomicBoolean pause = engine.getPause();</div><div class="line">		<span class="keyword">if</span> (pause.get()) &#123;</div><div class="line">			<span class="keyword">synchronized</span> (engine.getPauseLock()) &#123;</div><div class="line">				<span class="keyword">if</span> (pause.get()) &#123;</div><div class="line">					L.d(LOG_WAITING_FOR_RESUME, memoryCacheKey);</div><div class="line">					<span class="keyword">try</span> &#123;</div><div class="line">						engine.getPauseLock().wait();</div><div class="line">					&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">						L.e(LOG_TASK_INTERRUPTED, memoryCacheKey);</div><div class="line">						<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">					&#125;</div><div class="line">					L.d(LOG_RESUME_AFTER_PAUSE, memoryCacheKey);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> isTaskNotActual();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** <span class="doctag">@return</span> &lt;b&gt;true&lt;/b&gt; - if task should be interrupted; &lt;b&gt;false&lt;/b&gt; - otherwise */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">delayIfNeed</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (options.shouldDelayBeforeLoading()) &#123;</div><div class="line">			L.d(LOG_DELAY_BEFORE_LOADING, options.getDelayBeforeLoading(), memoryCacheKey);</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				Thread.sleep(options.getDelayBeforeLoading());</div><div class="line">			&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">				L.e(LOG_TASK_INTERRUPTED, memoryCacheKey);</div><div class="line">				<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> isTaskNotActual();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> Bitmap <span class="title">tryLoadBitmap</span><span class="params">()</span> <span class="keyword">throws</span> TaskCancelledException </span>&#123;</div><div class="line">		Bitmap bitmap = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			File imageFile = configuration.diskCache.get(uri);</div><div class="line">			<span class="keyword">if</span> (imageFile != <span class="keyword">null</span> &amp;&amp; imageFile.exists() &amp;&amp; imageFile.length() &gt; <span class="number">0</span>) &#123;</div><div class="line">				L.d(LOG_LOAD_IMAGE_FROM_DISK_CACHE, memoryCacheKey);</div><div class="line">				loadedFrom = LoadedFrom.DISC_CACHE;</div><div class="line"></div><div class="line">				checkTaskNotActual();</div><div class="line">				bitmap = decodeImage(Scheme.FILE.wrap(imageFile.getAbsolutePath()));</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (bitmap == <span class="keyword">null</span> || bitmap.getWidth() &lt;= <span class="number">0</span> || bitmap.getHeight() &lt;= <span class="number">0</span>) &#123;</div><div class="line">				L.d(LOG_LOAD_IMAGE_FROM_NETWORK, memoryCacheKey);</div><div class="line">				loadedFrom = LoadedFrom.NETWORK;</div><div class="line"></div><div class="line">				String imageUriForDecoding = uri;</div><div class="line">				<span class="keyword">if</span> (options.isCacheOnDisk() &amp;&amp; tryCacheImageOnDisk()) &#123;</div><div class="line">					imageFile = configuration.diskCache.get(uri);</div><div class="line">					<span class="keyword">if</span> (imageFile != <span class="keyword">null</span>) &#123;</div><div class="line">						imageUriForDecoding = Scheme.FILE.wrap(imageFile.getAbsolutePath());</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				checkTaskNotActual();</div><div class="line">				bitmap = decodeImage(imageUriForDecoding);</div><div class="line"></div><div class="line">				<span class="keyword">if</span> (bitmap == <span class="keyword">null</span> || bitmap.getWidth() &lt;= <span class="number">0</span> || bitmap.getHeight() &lt;= <span class="number">0</span>) &#123;</div><div class="line">					fireFailEvent(FailType.DECODING_ERROR, <span class="keyword">null</span>);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">catch</span> (IllegalStateException e) &#123;</div><div class="line">			fireFailEvent(FailType.NETWORK_DENIED, <span class="keyword">null</span>);</div><div class="line">		&#125; <span class="keyword">catch</span> (TaskCancelledException e) &#123;</div><div class="line">			<span class="keyword">throw</span> e;</div><div class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">			L.e(e);</div><div class="line">			fireFailEvent(FailType.IO_ERROR, e);</div><div class="line">		&#125; <span class="keyword">catch</span> (OutOfMemoryError e) &#123;</div><div class="line">			L.e(e);</div><div class="line">			fireFailEvent(FailType.OUT_OF_MEMORY, e);</div><div class="line">		&#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">			L.e(e);</div><div class="line">			fireFailEvent(FailType.UNKNOWN, e);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> bitmap;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> Bitmap <span class="title">decodeImage</span><span class="params">(String imageUri)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">		ViewScaleType viewScaleType = imageAware.getScaleType();</div><div class="line">		ImageDecodingInfo decodingInfo = <span class="keyword">new</span> ImageDecodingInfo(memoryCacheKey, imageUri, uri, targetSize, viewScaleType,</div><div class="line">				getDownloader(), options);</div><div class="line">		<span class="keyword">return</span> decoder.decode(decodingInfo);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** <span class="doctag">@return</span> &lt;b&gt;true&lt;/b&gt; - if image was downloaded successfully; &lt;b&gt;false&lt;/b&gt; - otherwise */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">tryCacheImageOnDisk</span><span class="params">()</span> <span class="keyword">throws</span> TaskCancelledException </span>&#123;</div><div class="line">		L.d(LOG_CACHE_IMAGE_ON_DISK, memoryCacheKey);</div><div class="line"></div><div class="line">		<span class="keyword">boolean</span> loaded;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			loaded = downloadImage();</div><div class="line">			<span class="keyword">if</span> (loaded) &#123;</div><div class="line">				<span class="keyword">int</span> width = configuration.maxImageWidthForDiskCache;</div><div class="line">				<span class="keyword">int</span> height = configuration.maxImageHeightForDiskCache;</div><div class="line">				<span class="keyword">if</span> (width &gt; <span class="number">0</span> || height &gt; <span class="number">0</span>) &#123;</div><div class="line">					L.d(LOG_RESIZE_CACHED_IMAGE_FILE, memoryCacheKey);</div><div class="line">					resizeAndSaveImage(width, height); <span class="comment">// TODO : process boolean result</span></div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">			L.e(e);</div><div class="line">			loaded = <span class="keyword">false</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> loaded;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">downloadImage</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">		InputStream is = getDownloader().getStream(uri, options.getExtraForDownloader());</div><div class="line">		<span class="keyword">if</span> (is == <span class="keyword">null</span>) &#123;</div><div class="line">			L.e(ERROR_NO_IMAGE_STREAM, memoryCacheKey);</div><div class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				<span class="keyword">return</span> configuration.diskCache.save(uri, is, <span class="keyword">this</span>);</div><div class="line">			&#125; <span class="keyword">finally</span> &#123;</div><div class="line">				IoUtils.closeSilently(is);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** Decodes image file into Bitmap, resize it and save it back */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">resizeAndSaveImage</span><span class="params">(<span class="keyword">int</span> maxWidth, <span class="keyword">int</span> maxHeight)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">		<span class="comment">// Decode image file, compress and re-save it</span></div><div class="line">		<span class="keyword">boolean</span> saved = <span class="keyword">false</span>;</div><div class="line">		File targetFile = configuration.diskCache.get(uri);</div><div class="line">		<span class="keyword">if</span> (targetFile != <span class="keyword">null</span> &amp;&amp; targetFile.exists()) &#123;</div><div class="line">			ImageSize targetImageSize = <span class="keyword">new</span> ImageSize(maxWidth, maxHeight);</div><div class="line">			DisplayImageOptions specialOptions = <span class="keyword">new</span> DisplayImageOptions.Builder().cloneFrom(options)</div><div class="line">					.imageScaleType(ImageScaleType.IN_SAMPLE_INT).build();</div><div class="line">			ImageDecodingInfo decodingInfo = <span class="keyword">new</span> ImageDecodingInfo(memoryCacheKey,</div><div class="line">					Scheme.FILE.wrap(targetFile.getAbsolutePath()), uri, targetImageSize, ViewScaleType.FIT_INSIDE,</div><div class="line">					getDownloader(), specialOptions);</div><div class="line">			Bitmap bmp = decoder.decode(decodingInfo);</div><div class="line">			<span class="keyword">if</span> (bmp != <span class="keyword">null</span> &amp;&amp; configuration.processorForDiskCache != <span class="keyword">null</span>) &#123;</div><div class="line">				L.d(LOG_PROCESS_IMAGE_BEFORE_CACHE_ON_DISK, memoryCacheKey);</div><div class="line">				bmp = configuration.processorForDiskCache.process(bmp);</div><div class="line">				<span class="keyword">if</span> (bmp == <span class="keyword">null</span>) &#123;</div><div class="line">					L.e(ERROR_PROCESSOR_FOR_DISK_CACHE_NULL, memoryCacheKey);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (bmp != <span class="keyword">null</span>) &#123;</div><div class="line">				saved = configuration.diskCache.save(uri, bmp);</div><div class="line">				bmp.recycle();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> saved;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onBytesCopied</span><span class="params">(<span class="keyword">int</span> current, <span class="keyword">int</span> total)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> syncLoading || fireProgressEvent(current, total);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** <span class="doctag">@return</span> &lt;b&gt;true&lt;/b&gt; - if loading should be continued; &lt;b&gt;false&lt;/b&gt; - if loading should be interrupted */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">fireProgressEvent</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> current, <span class="keyword">final</span> <span class="keyword">int</span> total)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (isTaskInterrupted() || isTaskNotActual()) <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">		<span class="keyword">if</span> (progressListener != <span class="keyword">null</span>) &#123;</div><div class="line">			Runnable r = <span class="keyword">new</span> Runnable() &#123;</div><div class="line">				<span class="meta">@Override</span></div><div class="line">				<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">					progressListener.onProgressUpdate(uri, imageAware.getWrappedView(), current, total);</div><div class="line">				&#125;</div><div class="line">			&#125;;</div><div class="line">			runTask(r, <span class="keyword">false</span>, handler, engine);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fireFailEvent</span><span class="params">(<span class="keyword">final</span> FailType failType, <span class="keyword">final</span> Throwable failCause)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (syncLoading || isTaskInterrupted() || isTaskNotActual()) <span class="keyword">return</span>;</div><div class="line">		Runnable r = <span class="keyword">new</span> Runnable() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">				<span class="keyword">if</span> (options.shouldShowImageOnFail()) &#123;</div><div class="line">					imageAware.setImageDrawable(options.getImageOnFail(configuration.resources));</div><div class="line">				&#125;</div><div class="line">				listener.onLoadingFailed(uri, imageAware.getWrappedView(), <span class="keyword">new</span> FailReason(failType, failCause));</div><div class="line">			&#125;</div><div class="line">		&#125;;</div><div class="line">		runTask(r, <span class="keyword">false</span>, handler, engine);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fireCancelEvent</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (syncLoading || isTaskInterrupted()) <span class="keyword">return</span>;</div><div class="line">		Runnable r = <span class="keyword">new</span> Runnable() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">				listener.onLoadingCancelled(uri, imageAware.getWrappedView());</div><div class="line">			&#125;</div><div class="line">		&#125;;</div><div class="line">		runTask(r, <span class="keyword">false</span>, handler, engine);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> ImageDownloader <span class="title">getDownloader</span><span class="params">()</span> </span>&#123;</div><div class="line">		ImageDownloader d;</div><div class="line">		<span class="keyword">if</span> (engine.isNetworkDenied()) &#123;</div><div class="line">			d = networkDeniedDownloader;</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (engine.isSlowNetwork()) &#123;</div><div class="line">			d = slowNetworkDownloader;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			d = downloader;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> d;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * <span class="doctag">@throws</span> TaskCancelledException if task is not actual (target ImageAware is collected by GC or the image URI of</div><div class="line">	 *                                this task doesn't match to image URI which is actual for current ImageAware at</div><div class="line">	 *                                this moment)</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkTaskNotActual</span><span class="params">()</span> <span class="keyword">throws</span> TaskCancelledException </span>&#123;</div><div class="line">		checkViewCollected();</div><div class="line">		checkViewReused();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * <span class="doctag">@return</span> &lt;b&gt;true&lt;/b&gt; - if task is not actual (target ImageAware is collected by GC or the image URI of this task</div><div class="line">	 * doesn't match to image URI which is actual for current ImageAware at this moment)); &lt;b&gt;false&lt;/b&gt; - otherwise</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isTaskNotActual</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> isViewCollected() || isViewReused();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** <span class="doctag">@throws</span> TaskCancelledException if target ImageAware is collected */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkViewCollected</span><span class="params">()</span> <span class="keyword">throws</span> TaskCancelledException </span>&#123;</div><div class="line">		<span class="keyword">if</span> (isViewCollected()) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> TaskCancelledException();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** <span class="doctag">@return</span> &lt;b&gt;true&lt;/b&gt; - if target ImageAware is collected by GC; &lt;b&gt;false&lt;/b&gt; - otherwise */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isViewCollected</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (imageAware.isCollected()) &#123;</div><div class="line">			L.d(LOG_TASK_CANCELLED_IMAGEAWARE_COLLECTED, memoryCacheKey);</div><div class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** <span class="doctag">@throws</span> TaskCancelledException if target ImageAware is collected by GC */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkViewReused</span><span class="params">()</span> <span class="keyword">throws</span> TaskCancelledException </span>&#123;</div><div class="line">		<span class="keyword">if</span> (isViewReused()) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> TaskCancelledException();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** <span class="doctag">@return</span> &lt;b&gt;true&lt;/b&gt; - if current ImageAware is reused for displaying another image; &lt;b&gt;false&lt;/b&gt; - otherwise */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isViewReused</span><span class="params">()</span> </span>&#123;</div><div class="line">		String currentCacheKey = engine.getLoadingUriForView(imageAware);</div><div class="line">		<span class="comment">// Check whether memory cache key (image URI) for current ImageAware is actual.</span></div><div class="line">		<span class="comment">// If ImageAware is reused for another task then current task should be cancelled.</span></div><div class="line">		<span class="keyword">boolean</span> imageAwareWasReused = !memoryCacheKey.equals(currentCacheKey);</div><div class="line">		<span class="keyword">if</span> (imageAwareWasReused) &#123;</div><div class="line">			L.d(LOG_TASK_CANCELLED_IMAGEAWARE_REUSED, memoryCacheKey);</div><div class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** <span class="doctag">@throws</span> TaskCancelledException if current task was interrupted */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkTaskInterrupted</span><span class="params">()</span> <span class="keyword">throws</span> TaskCancelledException </span>&#123;</div><div class="line">		<span class="keyword">if</span> (isTaskInterrupted()) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> TaskCancelledException();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** <span class="doctag">@return</span> &lt;b&gt;true&lt;/b&gt; - if current task was interrupted; &lt;b&gt;false&lt;/b&gt; - otherwise */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isTaskInterrupted</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (Thread.interrupted()) &#123;</div><div class="line">			L.d(LOG_TASK_INTERRUPTED, memoryCacheKey);</div><div class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function">String <span class="title">getLoadingUri</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> uri;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runTask</span><span class="params">(Runnable r, <span class="keyword">boolean</span> sync, Handler handler, ImageLoaderEngine engine)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (sync) &#123;</div><div class="line">			r.run();</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (handler == <span class="keyword">null</span>) &#123;</div><div class="line">			engine.fireCallback(r);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			handler.post(r);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>核心代码就是在run方法中,先看开始的两个判断 <em>waitIfPaused</em> 和 <em>delayIfNeed</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">waitIfPaused</span><span class="params">()</span> </span>&#123;</div><div class="line">		AtomicBoolean pause = engine.getPause();</div><div class="line">		<span class="keyword">if</span> (pause.get()) &#123;</div><div class="line">			<span class="keyword">synchronized</span> (engine.getPauseLock()) &#123;</div><div class="line">				<span class="keyword">if</span> (pause.get()) &#123;</div><div class="line">					L.d(LOG_WAITING_FOR_RESUME, memoryCacheKey);</div><div class="line">					<span class="keyword">try</span> &#123;</div><div class="line">						engine.getPauseLock().wait();</div><div class="line">					&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">						L.e(LOG_TASK_INTERRUPTED, memoryCacheKey);</div><div class="line">						<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">					&#125;</div><div class="line">					L.d(LOG_RESUME_AFTER_PAUSE, memoryCacheKey);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> isTaskNotActual();</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>如果engine对象处于暂停状态的时候,会让阻塞当前运行的线程,等待engine再次调用 <em>resume</em> 方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** <span class="doctag">@return</span> &lt;b&gt;true&lt;/b&gt; - if task should be interrupted; &lt;b&gt;false&lt;/b&gt; - otherwise */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">delayIfNeed</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (options.shouldDelayBeforeLoading()) &#123;</div><div class="line">			L.d(LOG_DELAY_BEFORE_LOADING, options.getDelayBeforeLoading(), memoryCacheKey);</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				Thread.sleep(options.getDelayBeforeLoading());</div><div class="line">			&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">				L.e(LOG_TASK_INTERRUPTED, memoryCacheKey);</div><div class="line">				<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> isTaskNotActual();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>如果在配置中设定了延迟显示的属性的话,休眠设置的时间然后继续执行.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">ReentrantLock loadFromUriLock = imageLoadingInfo.loadFromUriLock;</div><div class="line">		L.d(LOG_START_DISPLAY_IMAGE_TASK, memoryCacheKey);</div><div class="line">		<span class="keyword">if</span> (loadFromUriLock.isLocked()) &#123;</div><div class="line">			L.d(LOG_WAITING_FOR_IMAGE_LOADED, memoryCacheKey);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		loadFromUriLock.lock();</div></pre></td></tr></table></figure>
<p>对应前面url锁,一个url对应一个锁对象,这样同一时间内相同的URL只有一个任务在运行.<br>下面的 <em>checkTaskNotActual</em> 在前面讲过了,无非就是判断view的状态是否可用,这里不重复了</p>
<p>然后再次从内存中获取,这是因为加锁的原因,可能前面的线程已经把相同的url加载完成了,这里就先从内存中获取一下,防止重复下载.<br>如何没有找到bitmap对象就进入核心方法 <em>tryLoadBitmap</em> 中,这个方法就完成了上面的本地存储查找,如果没有的就从网上下载的逻辑,最后和上面一样,交给displayer来显示.下面重点讲下 <em>tryLoadBitmap</em> 这个方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Bitmap <span class="title">tryLoadBitmap</span><span class="params">()</span> <span class="keyword">throws</span> TaskCancelledException </span>&#123;</div><div class="line">		Bitmap bitmap = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			File imageFile = configuration.diskCache.get(uri);</div><div class="line">			<span class="keyword">if</span> (imageFile != <span class="keyword">null</span> &amp;&amp; imageFile.exists() &amp;&amp; imageFile.length() &gt; <span class="number">0</span>) &#123;</div><div class="line">				L.d(LOG_LOAD_IMAGE_FROM_DISK_CACHE, memoryCacheKey);</div><div class="line">				loadedFrom = LoadedFrom.DISC_CACHE;</div><div class="line"></div><div class="line">				checkTaskNotActual();</div><div class="line">				bitmap = decodeImage(Scheme.FILE.wrap(imageFile.getAbsolutePath()));</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (bitmap == <span class="keyword">null</span> || bitmap.getWidth() &lt;= <span class="number">0</span> || bitmap.getHeight() &lt;= <span class="number">0</span>) &#123;</div><div class="line">				L.d(LOG_LOAD_IMAGE_FROM_NETWORK, memoryCacheKey);</div><div class="line">				loadedFrom = LoadedFrom.NETWORK;</div><div class="line"></div><div class="line">				String imageUriForDecoding = uri;</div><div class="line">				<span class="keyword">if</span> (options.isCacheOnDisk() &amp;&amp; tryCacheImageOnDisk()) &#123;</div><div class="line">					imageFile = configuration.diskCache.get(uri);</div><div class="line">					<span class="keyword">if</span> (imageFile != <span class="keyword">null</span>) &#123;</div><div class="line">						imageUriForDecoding = Scheme.FILE.wrap(imageFile.getAbsolutePath());</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				checkTaskNotActual();</div><div class="line">				bitmap = decodeImage(imageUriForDecoding);</div><div class="line"></div><div class="line">				<span class="keyword">if</span> (bitmap == <span class="keyword">null</span> || bitmap.getWidth() &lt;= <span class="number">0</span> || bitmap.getHeight() &lt;= <span class="number">0</span>) &#123;</div><div class="line">					fireFailEvent(FailType.DECODING_ERROR, <span class="keyword">null</span>);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">catch</span> (IllegalStateException e) &#123;</div><div class="line">			fireFailEvent(FailType.NETWORK_DENIED, <span class="keyword">null</span>);</div><div class="line">		&#125; <span class="keyword">catch</span> (TaskCancelledException e) &#123;</div><div class="line">			<span class="keyword">throw</span> e;</div><div class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">			L.e(e);</div><div class="line">			fireFailEvent(FailType.IO_ERROR, e);</div><div class="line">		&#125; <span class="keyword">catch</span> (OutOfMemoryError e) &#123;</div><div class="line">			L.e(e);</div><div class="line">			fireFailEvent(FailType.OUT_OF_MEMORY, e);</div><div class="line">		&#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">			L.e(e);</div><div class="line">			fireFailEvent(FailType.UNKNOWN, e);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> bitmap;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>首先是从diskCache中查找有没有对应的图片对象,如果有的话交给 <em>decodeImage</em> 方法处理完图片之后直接返回,如果没有的话就进入下面的判断中<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">.....</div><div class="line"><span class="keyword">if</span> (options.isCacheOnDisk() &amp;&amp; tryCacheImageOnDisk()) &#123;</div><div class="line">					imageFile = configuration.diskCache.get(uri);</div><div class="line">					<span class="keyword">if</span> (imageFile != <span class="keyword">null</span>) &#123;</div><div class="line">						imageUriForDecoding = Scheme.FILE.wrap(imageFile.getAbsolutePath());</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">.....</div></pre></td></tr></table></figure></p>
<p>是否需要缓存到本地,如果需要的话进入 <em>tryCacheImageOnDisk</em> 这个方法用来从网络上下载图片<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">tryCacheImageOnDisk</span><span class="params">()</span> <span class="keyword">throws</span> TaskCancelledException </span>&#123;</div><div class="line">		L.d(LOG_CACHE_IMAGE_ON_DISK, memoryCacheKey);</div><div class="line"></div><div class="line">		<span class="keyword">boolean</span> loaded;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			loaded = downloadImage();</div><div class="line">			<span class="keyword">if</span> (loaded) &#123;</div><div class="line">				<span class="keyword">int</span> width = configuration.maxImageWidthForDiskCache;</div><div class="line">				<span class="keyword">int</span> height = configuration.maxImageHeightForDiskCache;</div><div class="line">				<span class="keyword">if</span> (width &gt; <span class="number">0</span> || height &gt; <span class="number">0</span>) &#123;</div><div class="line">					L.d(LOG_RESIZE_CACHED_IMAGE_FILE, memoryCacheKey);</div><div class="line">					resizeAndSaveImage(width, height); <span class="comment">// TODO : process boolean result</span></div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">			L.e(e);</div><div class="line">			loaded = <span class="keyword">false</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> loaded;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>进入 <em>downloadImage</em> 方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">downloadImage</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">  InputStream is = getDownloader().getStream(uri, options.getExtraForDownloader());</div><div class="line">  <span class="keyword">if</span> (is == <span class="keyword">null</span>) &#123;</div><div class="line">    L.e(ERROR_NO_IMAGE_STREAM, memoryCacheKey);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="keyword">return</span> configuration.diskCache.save(uri, is, <span class="keyword">this</span>);</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">      IoUtils.closeSilently(is);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到如果下载成功后,先把对象放入diskCache中,和最上面那个流程一样,下载先保存,然后从缓存中取.<br>这里 <em>getDownloader</em> 的对象是一个 <em>ImageDownloader</em> 接口对象,之所以要这样式因为UIL不仅仅可以处理http和https类型的图片,它也可以处理 “file:///“,”content://“,”assert://“,”drawable://“ 这些类型的URI,所以要根据不同的URI类型来找到不通的 <em>ImageDownloader</em> 加载图片.<br>最后当从内存中找到了对应的图片对象之后也是交给 <em>decode</em> 方法来处理图片. <em>decode</em> 主要是用来处理图片缩放的:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Bitmap <span class="title">decodeImage</span><span class="params">(String imageUri)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">  ViewScaleType viewScaleType = imageAware.getScaleType();</div><div class="line">  ImageDecodingInfo decodingInfo = <span class="keyword">new</span> ImageDecodingInfo(memoryCacheKey, imageUri, uri, targetSize, viewScaleType,</div><div class="line">      getDownloader(), options);</div><div class="line">  <span class="keyword">return</span> decoder.decode(decodingInfo);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里ImageDecodingInfo也是一个中间对象,用来把需要的参数都封装成一个对象传给Decoder对象<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ImageDecoder</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Decodes image to &#123;<span class="doctag">@link</span> Bitmap&#125; according target size and other parameters.</div><div class="line">	 *</div><div class="line">	 * <span class="doctag">@param</span> imageDecodingInfo</div><div class="line">	 * <span class="doctag">@return</span></div><div class="line">	 * <span class="doctag">@throws</span> IOException</div><div class="line">	 */</div><div class="line">	<span class="function">Bitmap <span class="title">decode</span><span class="params">(ImageDecodingInfo imageDecodingInfo)</span> <span class="keyword">throws</span> IOException</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseImageDecoder</span> <span class="keyword">implements</span> <span class="title">ImageDecoder</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOG_SUBSAMPLE_IMAGE = <span class="string">"Subsample original image (%1$s) to %2$s (scale = %3$d) [%4$s]"</span>;</div><div class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOG_SCALE_IMAGE = <span class="string">"Scale subsampled image (%1$s) to %2$s (scale = %3$.5f) [%4$s]"</span>;</div><div class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOG_ROTATE_IMAGE = <span class="string">"Rotate image on %1$d\u00B0 [%2$s]"</span>;</div><div class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOG_FLIP_IMAGE = <span class="string">"Flip image horizontally [%s]"</span>;</div><div class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> String ERROR_NO_IMAGE_STREAM = <span class="string">"No stream for image [%s]"</span>;</div><div class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> String ERROR_CANT_DECODE_IMAGE = <span class="string">"Image can't be decoded [%s]"</span>;</div><div class="line"></div><div class="line">	<span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> loggingEnabled;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">BaseImageDecoder</span><span class="params">(<span class="keyword">boolean</span> loggingEnabled)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.loggingEnabled = loggingEnabled;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Decodes image from URI into &#123;<span class="doctag">@link</span> Bitmap&#125;. Image is scaled close to incoming &#123;<span class="doctag">@linkplain</span> ImageSize target size&#125;</div><div class="line">	 * during decoding (depend on incoming parameters).</div><div class="line">	 *</div><div class="line">	 * <span class="doctag">@param</span> decodingInfo Needed data for decoding image</div><div class="line">	 * <span class="doctag">@return</span> Decoded bitmap</div><div class="line">	 * <span class="doctag">@throws</span> IOException                   if some I/O exception occurs during image reading</div><div class="line">	 * <span class="doctag">@throws</span> UnsupportedOperationException if image URI has unsupported scheme(protocol)</div><div class="line">	 */</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> Bitmap <span class="title">decode</span><span class="params">(ImageDecodingInfo decodingInfo)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">		Bitmap decodedBitmap;</div><div class="line">		ImageFileInfo imageInfo;</div><div class="line"></div><div class="line">		InputStream imageStream = getImageStream(decodingInfo);</div><div class="line">		<span class="keyword">if</span> (imageStream == <span class="keyword">null</span>) &#123;</div><div class="line">			L.e(ERROR_NO_IMAGE_STREAM, decodingInfo.getImageKey());</div><div class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			imageInfo = defineImageSizeAndRotation(imageStream, decodingInfo);</div><div class="line">			imageStream = resetStream(imageStream, decodingInfo);</div><div class="line">			Options decodingOptions = prepareDecodingOptions(imageInfo.imageSize, decodingInfo);</div><div class="line">			decodedBitmap = BitmapFactory.decodeStream(imageStream, <span class="keyword">null</span>, decodingOptions);</div><div class="line">		&#125; <span class="keyword">finally</span> &#123;</div><div class="line">			IoUtils.closeSilently(imageStream);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (decodedBitmap == <span class="keyword">null</span>) &#123;</div><div class="line">			L.e(ERROR_CANT_DECODE_IMAGE, decodingInfo.getImageKey());</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			decodedBitmap = considerExactScaleAndOrientatiton(decodedBitmap, decodingInfo, imageInfo.exif.rotation,</div><div class="line">					imageInfo.exif.flipHorizontal);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> decodedBitmap;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">protected</span> InputStream <span class="title">getImageStream</span><span class="params">(ImageDecodingInfo decodingInfo)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">		<span class="keyword">return</span> decodingInfo.getDownloader().getStream(decodingInfo.getImageUri(), decodingInfo.getExtraForDownloader());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">protected</span> ImageFileInfo <span class="title">defineImageSizeAndRotation</span><span class="params">(InputStream imageStream, ImageDecodingInfo decodingInfo)</span></span></div><div class="line">			<span class="keyword">throws</span> IOException &#123;</div><div class="line">		Options options = <span class="keyword">new</span> Options();</div><div class="line">		options.inJustDecodeBounds = <span class="keyword">true</span>;</div><div class="line">		BitmapFactory.decodeStream(imageStream, <span class="keyword">null</span>, options);</div><div class="line"></div><div class="line">		ExifInfo exif;</div><div class="line">		String imageUri = decodingInfo.getImageUri();</div><div class="line">		<span class="keyword">if</span> (decodingInfo.shouldConsiderExifParams() &amp;&amp; canDefineExifParams(imageUri, options.outMimeType)) &#123;</div><div class="line">			exif = defineExifOrientation(imageUri);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			exif = <span class="keyword">new</span> ExifInfo();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ImageFileInfo(<span class="keyword">new</span> ImageSize(options.outWidth, options.outHeight, exif.rotation), exif);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">canDefineExifParams</span><span class="params">(String imageUri, String mimeType)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">"image/jpeg"</span>.equalsIgnoreCase(mimeType) &amp;&amp; (Scheme.ofUri(imageUri) == Scheme.FILE);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">protected</span> ExifInfo <span class="title">defineExifOrientation</span><span class="params">(String imageUri)</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> rotation = <span class="number">0</span>;</div><div class="line">		<span class="keyword">boolean</span> flip = <span class="keyword">false</span>;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			ExifInterface exif = <span class="keyword">new</span> ExifInterface(Scheme.FILE.crop(imageUri));</div><div class="line">			<span class="keyword">int</span> exifOrientation = exif.getAttributeInt(ExifInterface.TAG_ORIENTATION, ExifInterface.ORIENTATION_NORMAL);</div><div class="line">			<span class="keyword">switch</span> (exifOrientation) &#123;</div><div class="line">				<span class="keyword">case</span> ExifInterface.ORIENTATION_FLIP_HORIZONTAL:</div><div class="line">					flip = <span class="keyword">true</span>;</div><div class="line">				<span class="keyword">case</span> ExifInterface.ORIENTATION_NORMAL:</div><div class="line">					rotation = <span class="number">0</span>;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				<span class="keyword">case</span> ExifInterface.ORIENTATION_TRANSVERSE:</div><div class="line">					flip = <span class="keyword">true</span>;</div><div class="line">				<span class="keyword">case</span> ExifInterface.ORIENTATION_ROTATE_90:</div><div class="line">					rotation = <span class="number">90</span>;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				<span class="keyword">case</span> ExifInterface.ORIENTATION_FLIP_VERTICAL:</div><div class="line">					flip = <span class="keyword">true</span>;</div><div class="line">				<span class="keyword">case</span> ExifInterface.ORIENTATION_ROTATE_180:</div><div class="line">					rotation = <span class="number">180</span>;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				<span class="keyword">case</span> ExifInterface.ORIENTATION_TRANSPOSE:</div><div class="line">					flip = <span class="keyword">true</span>;</div><div class="line">				<span class="keyword">case</span> ExifInterface.ORIENTATION_ROTATE_270:</div><div class="line">					rotation = <span class="number">270</span>;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">			L.w(<span class="string">"Can't read EXIF tags from file [%s]"</span>, imageUri);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ExifInfo(rotation, flip);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">protected</span> Options <span class="title">prepareDecodingOptions</span><span class="params">(ImageSize imageSize, ImageDecodingInfo decodingInfo)</span> </span>&#123;</div><div class="line">		ImageScaleType scaleType = decodingInfo.getImageScaleType();</div><div class="line">		<span class="keyword">int</span> scale;</div><div class="line">		<span class="keyword">if</span> (scaleType == ImageScaleType.NONE) &#123;</div><div class="line">			scale = <span class="number">1</span>;</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (scaleType == ImageScaleType.NONE_SAFE) &#123;</div><div class="line">			scale = ImageSizeUtils.computeMinImageSampleSize(imageSize);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			ImageSize targetSize = decodingInfo.getTargetSize();</div><div class="line">			<span class="keyword">boolean</span> powerOf2 = scaleType == ImageScaleType.IN_SAMPLE_POWER_OF_2;</div><div class="line">			scale = ImageSizeUtils.computeImageSampleSize(imageSize, targetSize, decodingInfo.getViewScaleType(), powerOf2);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (scale &gt; <span class="number">1</span> &amp;&amp; loggingEnabled) &#123;</div><div class="line">			L.d(LOG_SUBSAMPLE_IMAGE, imageSize, imageSize.scaleDown(scale), scale, decodingInfo.getImageKey());</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		Options decodingOptions = decodingInfo.getDecodingOptions();</div><div class="line">		decodingOptions.inSampleSize = scale;</div><div class="line">		<span class="keyword">return</span> decodingOptions;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">protected</span> InputStream <span class="title">resetStream</span><span class="params">(InputStream imageStream, ImageDecodingInfo decodingInfo)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">		<span class="keyword">if</span> (imageStream.markSupported()) &#123;</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				imageStream.reset();</div><div class="line">				<span class="keyword">return</span> imageStream;</div><div class="line">			&#125; <span class="keyword">catch</span> (IOException ignored) &#123;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		IoUtils.closeSilently(imageStream);</div><div class="line">		<span class="keyword">return</span> getImageStream(decodingInfo);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">protected</span> Bitmap <span class="title">considerExactScaleAndOrientatiton</span><span class="params">(Bitmap subsampledBitmap, ImageDecodingInfo decodingInfo,</span></span></div><div class="line">			<span class="keyword">int</span> rotation, <span class="keyword">boolean</span> flipHorizontal) &#123;</div><div class="line">		Matrix m = <span class="keyword">new</span> Matrix();</div><div class="line">		<span class="comment">// Scale to exact size if need</span></div><div class="line">		ImageScaleType scaleType = decodingInfo.getImageScaleType();</div><div class="line">		<span class="keyword">if</span> (scaleType == ImageScaleType.EXACTLY || scaleType == ImageScaleType.EXACTLY_STRETCHED) &#123;</div><div class="line">			ImageSize srcSize = <span class="keyword">new</span> ImageSize(subsampledBitmap.getWidth(), subsampledBitmap.getHeight(), rotation);</div><div class="line">			<span class="keyword">float</span> scale = ImageSizeUtils.computeImageScale(srcSize, decodingInfo.getTargetSize(), decodingInfo</div><div class="line">					.getViewScaleType(), scaleType == ImageScaleType.EXACTLY_STRETCHED);</div><div class="line">			<span class="keyword">if</span> (Float.compare(scale, <span class="number">1f</span>) != <span class="number">0</span>) &#123;</div><div class="line">				m.setScale(scale, scale);</div><div class="line"></div><div class="line">				<span class="keyword">if</span> (loggingEnabled) &#123;</div><div class="line">					L.d(LOG_SCALE_IMAGE, srcSize, srcSize.scale(scale), scale, decodingInfo.getImageKey());</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// Flip bitmap if need</span></div><div class="line">		<span class="keyword">if</span> (flipHorizontal) &#123;</div><div class="line">			m.postScale(-<span class="number">1</span>, <span class="number">1</span>);</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (loggingEnabled) L.d(LOG_FLIP_IMAGE, decodingInfo.getImageKey());</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// Rotate bitmap if need</span></div><div class="line">		<span class="keyword">if</span> (rotation != <span class="number">0</span>) &#123;</div><div class="line">			m.postRotate(rotation);</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (loggingEnabled) L.d(LOG_ROTATE_IMAGE, rotation, decodingInfo.getImageKey());</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		Bitmap finalBitmap = Bitmap.createBitmap(subsampledBitmap, <span class="number">0</span>, <span class="number">0</span>, subsampledBitmap.getWidth(), subsampledBitmap</div><div class="line">				.getHeight(), m, <span class="keyword">true</span>);</div><div class="line">		<span class="keyword">if</span> (finalBitmap != subsampledBitmap) &#123;</div><div class="line">			subsampledBitmap.recycle();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> finalBitmap;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ExifInfo</span> </span>&#123;</div><div class="line"></div><div class="line">		<span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> rotation;</div><div class="line">		<span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> flipHorizontal;</div><div class="line"></div><div class="line">		<span class="function"><span class="keyword">protected</span> <span class="title">ExifInfo</span><span class="params">()</span> </span>&#123;</div><div class="line">			<span class="keyword">this</span>.rotation = <span class="number">0</span>;</div><div class="line">			<span class="keyword">this</span>.flipHorizontal = <span class="keyword">false</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="function"><span class="keyword">protected</span> <span class="title">ExifInfo</span><span class="params">(<span class="keyword">int</span> rotation, <span class="keyword">boolean</span> flipHorizontal)</span> </span>&#123;</div><div class="line">			<span class="keyword">this</span>.rotation = rotation;</div><div class="line">			<span class="keyword">this</span>.flipHorizontal = flipHorizontal;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageFileInfo</span> </span>&#123;</div><div class="line"></div><div class="line">		<span class="keyword">public</span> <span class="keyword">final</span> ImageSize imageSize;</div><div class="line">		<span class="keyword">public</span> <span class="keyword">final</span> ExifInfo exif;</div><div class="line"></div><div class="line">		<span class="function"><span class="keyword">protected</span> <span class="title">ImageFileInfo</span><span class="params">(ImageSize imageSize, ExifInfo exif)</span> </span>&#123;</div><div class="line">			<span class="keyword">this</span>.imageSize = imageSize;</div><div class="line">			<span class="keyword">this</span>.exif = exif;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到decoder类对Bitmap根据需要做了缩放和旋转处理,如果必要的话.这里涉及到Bitmap操作的api,这里就不展开了,后续有时间我们介绍一下Bitmap的常用操作方法.<br>回到 <em>LoadAndDisplayImageTask</em> 的run方法,可以看到,这里在等到获取到Bitmap对象之后,可以调用getPreProcessor来对对象做二次处理,然后放入内存缓存中,最后也可以再对Bitmap做一次处理,如果设置了getPostProcessor的话,最后就交给 <em>DisplayBitmapTask</em> 去显示图片了,和上面的 <em>ProcessAndDisplayImageTask</em> 一样.</p>
<p>核心加载流程就讲完了,是不是很容易理解,其实也没有上面特别拿点的地方,只要明白加载的流程就很容易跟到代码了.最后简单介绍一下config对象的相关属性:</p>
<h4 id="ImageLoaderConfiguration"><a href="#ImageLoaderConfiguration" class="headerlink" title="ImageLoaderConfiguration"></a>ImageLoaderConfiguration</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageLoaderConfiguration</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> Resources resources;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> maxImageWidthForMemoryCache;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> maxImageHeightForMemoryCache;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> maxImageWidthForDiskCache;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> maxImageHeightForDiskCache;</div><div class="line">	<span class="keyword">final</span> BitmapProcessor processorForDiskCache;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> Executor taskExecutor;</div><div class="line">	<span class="keyword">final</span> Executor taskExecutorForCachedImages;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> customExecutor;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> customExecutorForCachedImages;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> threadPoolSize;</div><div class="line">	<span class="keyword">final</span> <span class="keyword">int</span> threadPriority;</div><div class="line">	<span class="keyword">final</span> QueueProcessingType tasksProcessingType;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> MemoryCache memoryCache;</div><div class="line">	<span class="keyword">final</span> DiskCache diskCache;</div><div class="line">	<span class="keyword">final</span> ImageDownloader downloader;</div><div class="line">	<span class="keyword">final</span> ImageDecoder decoder;</div><div class="line">	<span class="keyword">final</span> DisplayImageOptions defaultDisplayImageOptions;</div><div class="line"></div><div class="line">	<span class="keyword">final</span> ImageDownloader networkDeniedDownloader;</div><div class="line">	<span class="keyword">final</span> ImageDownloader slowNetworkDownloader;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="title">ImageLoaderConfiguration</span><span class="params">(<span class="keyword">final</span> Builder builder)</span> </span>&#123;</div><div class="line">		resources = builder.context.getResources();</div><div class="line">		maxImageWidthForMemoryCache = builder.maxImageWidthForMemoryCache;</div><div class="line">		maxImageHeightForMemoryCache = builder.maxImageHeightForMemoryCache;</div><div class="line">		maxImageWidthForDiskCache = builder.maxImageWidthForDiskCache;</div><div class="line">		maxImageHeightForDiskCache = builder.maxImageHeightForDiskCache;</div><div class="line">		processorForDiskCache = builder.processorForDiskCache;</div><div class="line">		taskExecutor = builder.taskExecutor;</div><div class="line">		taskExecutorForCachedImages = builder.taskExecutorForCachedImages;</div><div class="line">		threadPoolSize = builder.threadPoolSize;</div><div class="line">		threadPriority = builder.threadPriority;</div><div class="line">		tasksProcessingType = builder.tasksProcessingType;</div><div class="line">		diskCache = builder.diskCache;</div><div class="line">		memoryCache = builder.memoryCache;</div><div class="line">		defaultDisplayImageOptions = builder.defaultDisplayImageOptions;</div><div class="line">		downloader = builder.downloader;</div><div class="line">		decoder = builder.decoder;</div><div class="line"></div><div class="line">		customExecutor = builder.customExecutor;</div><div class="line">		customExecutorForCachedImages = builder.customExecutorForCachedImages;</div><div class="line"></div><div class="line">		networkDeniedDownloader = <span class="keyword">new</span> NetworkDeniedImageDownloader(downloader);</div><div class="line">		slowNetworkDownloader = <span class="keyword">new</span> SlowNetworkImageDownloader(downloader);</div><div class="line"></div><div class="line">		L.writeDebugLogs(builder.writeLogs);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ImageLoaderConfiguration <span class="title">createDefault</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> Builder(context).build();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function">ImageSize <span class="title">getMaxImageSize</span><span class="params">()</span> </span>&#123;</div><div class="line">		DisplayMetrics displayMetrics = resources.getDisplayMetrics();</div><div class="line"></div><div class="line">		<span class="keyword">int</span> width = maxImageWidthForMemoryCache;</div><div class="line">		<span class="keyword">if</span> (width &lt;= <span class="number">0</span>) &#123;</div><div class="line">			width = displayMetrics.widthPixels;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">int</span> height = maxImageHeightForMemoryCache;</div><div class="line">		<span class="keyword">if</span> (height &lt;= <span class="number">0</span>) &#123;</div><div class="line">			height = displayMetrics.heightPixels;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ImageSize(width, height);</div><div class="line">	&#125;</div><div class="line">  ....</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>config对象的属性起名很清晰,基本和字面翻译一致,可以看到很多地方都可以配置,比如线程池,decoder等对象,非常的灵活.方便根据需求去扩展.</p>
<p>最后的最后,来看下两个接口,分别对应图片二次处理和图片显示的</p>
<h4 id="processor-和-displayer"><a href="#processor-和-displayer" class="headerlink" title="processor 和 displayer"></a>processor 和 displayer</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BitmapProcessor</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function">Bitmap <span class="title">process</span><span class="params">(Bitmap bitmap)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BitmapDisplayer</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">display</span><span class="params">(Bitmap bitmap, ImageAware imageAware, LoadedFrom loadedFrom)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里可以根据需求去实现自己的process和displayer,UIL已经给提供了几种displayer了,比如 <em>CircleBitmapDisplayer</em> , <em>FadeInBitmapDisplayer</em> 等,位于core包目录下的display包下面,感兴趣的话可以自己看下实现.</p>
<h3 id="DefaultConfigurationFactory"><a href="#DefaultConfigurationFactory" class="headerlink" title="DefaultConfigurationFactory"></a>DefaultConfigurationFactory</h3><p>这个类用来生成默认的config和option对象的,都是一些简单的初始化操作,这里就不讲了,具体的请看代码实现.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultConfigurationFactory</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">/** Creates default implementation of task executor */</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Executor <span class="title">createExecutor</span><span class="params">(<span class="keyword">int</span> threadPoolSize, <span class="keyword">int</span> threadPriority,</span></span></div><div class="line">			QueueProcessingType tasksProcessingType) &#123;</div><div class="line">		<span class="keyword">boolean</span> lifo = tasksProcessingType == QueueProcessingType.LIFO;</div><div class="line">		BlockingQueue&lt;Runnable&gt; taskQueue =</div><div class="line">				lifo ? <span class="keyword">new</span> LIFOLinkedBlockingDeque&lt;Runnable&gt;() : <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;();</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ThreadPoolExecutor(threadPoolSize, threadPoolSize, <span class="number">0L</span>, TimeUnit.MILLISECONDS, taskQueue,</div><div class="line">				createThreadFactory(threadPriority, <span class="string">"uil-pool-"</span>));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** Creates default implementation of task distributor */</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Executor <span class="title">createTaskDistributor</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> Executors.newCachedThreadPool(createThreadFactory(Thread.NORM_PRIORITY, <span class="string">"uil-pool-d-"</span>));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** Creates &#123;<span class="doctag">@linkplain</span> HashCodeFileNameGenerator default implementation&#125; of FileNameGenerator */</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> FileNameGenerator <span class="title">createFileNameGenerator</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> HashCodeFileNameGenerator();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Creates default implementation of &#123;<span class="doctag">@link</span> DiskCache&#125; depends on incoming parameters</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DiskCache <span class="title">createDiskCache</span><span class="params">(Context context, FileNameGenerator diskCacheFileNameGenerator,</span></span></div><div class="line">			<span class="keyword">long</span> diskCacheSize, <span class="keyword">int</span> diskCacheFileCount) &#123;</div><div class="line">		File reserveCacheDir = createReserveDiskCacheDir(context);</div><div class="line">		<span class="keyword">if</span> (diskCacheSize &gt; <span class="number">0</span> || diskCacheFileCount &gt; <span class="number">0</span>) &#123;</div><div class="line">			File individualCacheDir = StorageUtils.getIndividualCacheDirectory(context);</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				<span class="keyword">return</span> <span class="keyword">new</span> LruDiskCache(individualCacheDir, reserveCacheDir, diskCacheFileNameGenerator, diskCacheSize,</div><div class="line">						diskCacheFileCount);</div><div class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">				L.e(e);</div><div class="line">				<span class="comment">// continue and create unlimited cache</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		File cacheDir = StorageUtils.getCacheDirectory(context);</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> UnlimitedDiskCache(cacheDir, reserveCacheDir, diskCacheFileNameGenerator);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** Creates reserve disk cache folder which will be used if primary disk cache folder becomes unavailable */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> File <span class="title">createReserveDiskCacheDir</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">		File cacheDir = StorageUtils.getCacheDirectory(context, <span class="keyword">false</span>);</div><div class="line">		File individualDir = <span class="keyword">new</span> File(cacheDir, <span class="string">"uil-images"</span>);</div><div class="line">		<span class="keyword">if</span> (individualDir.exists() || individualDir.mkdir()) &#123;</div><div class="line">			cacheDir = individualDir;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> cacheDir;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Creates default implementation of &#123;<span class="doctag">@link</span> MemoryCache&#125; - &#123;<span class="doctag">@link</span> LruMemoryCache&#125;&lt;br /&gt;</div><div class="line">	 * Default cache size = 1/8 of available app memory.</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MemoryCache <span class="title">createMemoryCache</span><span class="params">(Context context, <span class="keyword">int</span> memoryCacheSize)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (memoryCacheSize == <span class="number">0</span>) &#123;</div><div class="line">			ActivityManager am = (ActivityManager) context.getSystemService(Context.ACTIVITY_SERVICE);</div><div class="line">			<span class="keyword">int</span> memoryClass = am.getMemoryClass();</div><div class="line">			<span class="keyword">if</span> (hasHoneycomb() &amp;&amp; isLargeHeap(context)) &#123;</div><div class="line">				memoryClass = getLargeMemoryClass(am);</div><div class="line">			&#125;</div><div class="line">			memoryCacheSize = <span class="number">1024</span> * <span class="number">1024</span> * memoryClass / <span class="number">8</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> LruMemoryCache(memoryCacheSize);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">hasHoneycomb</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.HONEYCOMB;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@TargetApi</span>(Build.VERSION_CODES.HONEYCOMB)</div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isLargeHeap</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> (context.getApplicationInfo().flags &amp; ApplicationInfo.FLAG_LARGE_HEAP) != <span class="number">0</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@TargetApi</span>(Build.VERSION_CODES.HONEYCOMB)</div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getLargeMemoryClass</span><span class="params">(ActivityManager am)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> am.getLargeMemoryClass();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** Creates default implementation of &#123;<span class="doctag">@link</span> ImageDownloader&#125; - &#123;<span class="doctag">@link</span> BaseImageDownloader&#125; */</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ImageDownloader <span class="title">createImageDownloader</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> BaseImageDownloader(context);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** Creates default implementation of &#123;<span class="doctag">@link</span> ImageDecoder&#125; - &#123;<span class="doctag">@link</span> BaseImageDecoder&#125; */</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ImageDecoder <span class="title">createImageDecoder</span><span class="params">(<span class="keyword">boolean</span> loggingEnabled)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> BaseImageDecoder(loggingEnabled);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** Creates default implementation of &#123;<span class="doctag">@link</span> BitmapDisplayer&#125; - &#123;<span class="doctag">@link</span> SimpleBitmapDisplayer&#125; */</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BitmapDisplayer <span class="title">createBitmapDisplayer</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> SimpleBitmapDisplayer();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/** Creates default implementation of &#123;<span class="doctag">@linkplain</span> ThreadFactory thread factory&#125; for task executor */</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ThreadFactory <span class="title">createThreadFactory</span><span class="params">(<span class="keyword">int</span> threadPriority, String threadNamePrefix)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> DefaultThreadFactory(threadPriority, threadNamePrefix);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultThreadFactory</span> <span class="keyword">implements</span> <span class="title">ThreadFactory</span> </span>&#123;</div><div class="line"></div><div class="line">		<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicInteger poolNumber = <span class="keyword">new</span> AtomicInteger(<span class="number">1</span>);</div><div class="line"></div><div class="line">		<span class="keyword">private</span> <span class="keyword">final</span> ThreadGroup group;</div><div class="line">		<span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger threadNumber = <span class="keyword">new</span> AtomicInteger(<span class="number">1</span>);</div><div class="line">		<span class="keyword">private</span> <span class="keyword">final</span> String namePrefix;</div><div class="line">		<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> threadPriority;</div><div class="line"></div><div class="line">		DefaultThreadFactory(<span class="keyword">int</span> threadPriority, String threadNamePrefix) &#123;</div><div class="line">			<span class="keyword">this</span>.threadPriority = threadPriority;</div><div class="line">			group = Thread.currentThread().getThreadGroup();</div><div class="line">			namePrefix = threadNamePrefix + poolNumber.getAndIncrement() + <span class="string">"-thread-"</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span> </span>&#123;</div><div class="line">			Thread t = <span class="keyword">new</span> Thread(group, r, namePrefix + threadNumber.getAndIncrement(), <span class="number">0</span>);</div><div class="line">			<span class="keyword">if</span> (t.isDaemon()) t.setDaemon(<span class="keyword">false</span>);</div><div class="line">			t.setPriority(threadPriority);</div><div class="line">			<span class="keyword">return</span> t;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>到这里,UIL的源码主流程就分析完成了,这是第二个研究的开源项目,第一个是EventBus,以前老是觉得UIL非常的复杂,现在回头看了其实很简单,内部的调用也很清晰,看来还是得勇敢迈出第一步,这样才能提高.</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/12/31/2016/计划与总结/2017年度计划/" rel="next" title="2017年度计划">
                <i class="fa fa-chevron-left"></i> 2017年度计划
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/01/03/2017/android Handler,Looper,MessageQueue源码分析/" rel="prev" title="android Handler,Looper,MessageQueue源码分析">
                android Handler,Looper,MessageQueue源码分析 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Inhaltsverzeichnis
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Übersicht
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="yanyi" />
          <p class="site-author-name" itemprop="name">yanyi</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">66</span>
                <span class="site-state-item-name">Artikel</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">Tags</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#android-universal-image-loader-源码分析"><span class="nav-number">1.</span> <span class="nav-text">android universal image loader 源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#UIL源码分析"><span class="nav-number">1.1.</span> <span class="nav-text">UIL源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ImageLoader"><span class="nav-number">1.1.1.</span> <span class="nav-text">ImageLoader</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#核心displayImage方法"><span class="nav-number">1.1.1.1.</span> <span class="nav-text">核心displayImage方法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ImageAware对象"><span class="nav-number">1.1.1.2.</span> <span class="nav-text">ImageAware对象</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ImageSize对象"><span class="nav-number">1.1.1.3.</span> <span class="nav-text">ImageSize对象</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ImageLoadingInfo对象"><span class="nav-number">1.1.1.4.</span> <span class="nav-text">ImageLoadingInfo对象</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ImageLoaderEngine"><span class="nav-number">1.1.2.</span> <span class="nav-text">ImageLoaderEngine</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ProcessAndDisplayImageTask"><span class="nav-number">1.1.3.</span> <span class="nav-text">ProcessAndDisplayImageTask</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#LoadAndDisplayImageTask"><span class="nav-number">1.1.4.</span> <span class="nav-text">LoadAndDisplayImageTask</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ImageLoaderConfiguration"><span class="nav-number">1.1.5.</span> <span class="nav-text">ImageLoaderConfiguration</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#processor-和-displayer"><span class="nav-number">1.1.6.</span> <span class="nav-text">processor 和 displayer</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DefaultConfigurationFactory"><span class="nav-number">1.2.</span> <span class="nav-text">DefaultConfigurationFactory</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#总结"><span class="nav-number">1.3.</span> <span class="nav-text">总结</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yanyi</span>
</div>


<div class="powered-by">
  Erstellt mit  <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    
    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  





  



  
  

  

  

  

  


  

</body>
</html>
